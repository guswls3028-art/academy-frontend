====================================================================================================
# FRONTEND FOLDER: features__scores
# ROOT PATH: C:\academyfront\src\features\scores
====================================================================================================


==========================================================================================
# FILE: types.ts
==========================================================================================
/**
 * PATH: src/features/scores/types.ts
 *
 * âœ… Scores Domain Types
 */

export type EditableScoreCell = {
  exam_id: number;
  enrollment_id: number;
  question_id: number;
  score: number | null;
  max_score: number;
  is_editable: boolean;
  is_locked: boolean;
};


==========================================================================================
# FILE: api/fetchEditableExamItems.ts
==========================================================================================
// PATH: src/features/scores/api/fetchEditableExamItems.ts
/**
 * results ë„ë©”ì¸ ë¬¸í•­ë³„ ì ìˆ˜ ì¡°íšŒ (READ ONLY)
 * - scores ì‘ì—…ëŒ€ì—ì„œ ì†Œë¹„
 * - ë‹¨ì¼ì§„ì‹¤: results
 */

import api from "@/shared/api/axios";
import type { EditableScoreCell } from "../types";

export async function fetchEditableExamItems(params: {
  examId: number;
  enrollmentId: number;
}) {
  const { examId, enrollmentId } = params;

  const res = await api.get(
    `/results/admin/exams/${examId}/enrollments/${enrollmentId}/`
  );

  return res.data.items as EditableScoreCell[];
}


==========================================================================================
# FILE: api/patchHomeworkQuick.ts
==========================================================================================
// PATH: src/features/scores/api/patchHomeworkQuick.ts
/**
 * Homework Quick Patch API
 *
 * âœ… LOCKED SPEC
 * - PATCH /homework/scores/quick/
 * - í”„ë¡ íŠ¸ëŠ” ê³„ì‚°/íŒì • ê¸ˆì§€ â†’ ì„œë²„ ê²°ê³¼ë§Œ ì‹ ë¢°
 *
 * âœ… í™•ì¥(ìµœì†Œ):
 * - meta_status: "NOT_SUBMITTED" | null (ë¯¸ì œì¶œ ì €ì¥/í•´ì œ)
 * - score: number | null (ë¯¸ì…ë ¥/ë¯¸ì œì¶œì„ ìœ„í•´ null í—ˆìš©)
 */

import api from "@/shared/api/axios";

export type HomeworkMetaStatus = "NOT_SUBMITTED";

export async function patchHomeworkQuick(params: {
  sessionId: number;
  enrollmentId: number;
  homeworkId: number;

  // âœ… í™•ì¥: null í—ˆìš©
  score: number | null;

  maxScore?: number | null;

  // âœ… í™•ì¥: ë¯¸ì œì¶œ ì €ì¥/í•´ì œ
  metaStatus?: HomeworkMetaStatus | null;
}) {
  const res = await api.patch("/homework/scores/quick/", {
    session_id: params.sessionId,
    enrollment_id: params.enrollmentId,
    homework_id: params.homeworkId,
    score: params.score,
    max_score: params.maxScore ?? null,
    meta_status: params.metaStatus ?? null,
  });

  return res.data;
}


==========================================================================================
# FILE: api/patchItemScore.ts
==========================================================================================
// PATH: src/features/scores/api/patchItemScore.ts
/**
 * Subjective item score patch (Results ë„ë©”ì¸ ë‹¨ì¼ ê³„ì•½)
 * - optimistic update ê¸ˆì§€
 */

import api from "@/shared/api/axios";

export async function patchExamItemScore(params: {
  examId: number;
  enrollmentId: number;
  questionId: number;
  score: number;
}) {
  const { examId, enrollmentId, questionId, score } = params;

  const res = await api.patch(
    `/results/admin/exams/${examId}/enrollments/${enrollmentId}/items/${questionId}/`,
    { score }
  );

  return res.data;
}


==========================================================================================
# FILE: api/pollingSubmission.ts
==========================================================================================
import api from "@/shared/api/axios";

export type SubmissionStatus =
  | "SUBMITTED"
  | "PROCESSING"
  | "ANSWERS_READY"
  | "NEEDS_IDENTIFICATION"
  | "GRADED"
  | "FAILED";

export type SubmissionDTO = {
  id: number;
  status: SubmissionStatus;
  enrollment_id: number | null;
  target_id: number;
  meta: any;
  error_message: string | null;
  updated_at: string;
};

export async function fetchSubmission(submissionId: number) {
  const res = await api.get(`/submissions/${submissionId}/`);
  return res.data as SubmissionDTO;
}


==========================================================================================
# FILE: api/sessionScores.ts
==========================================================================================
// PATH: src/features/scores/api/sessionScores.ts
/**
 * Session Scores API (ADMIN)
 * - ì„œë²„ê°€ ê³„ì‚°/íŒì •/í´ë¦¬ë‹‰ ë‹¨ì¼ ì§„ì‹¤
 * - í”„ë¡ íŠ¸ëŠ” í‘œì‹œ + ì…ë ¥ + invalidateë§Œ ìˆ˜í–‰
 *
 * âœ… DTO í•µì‹¬:
 * - rows[n].exams = ì‹œí—˜ 1:N ë°°ì—´
 * - rows[n].homeworks = ê³¼ì œ 1:N ë°°ì—´
 */

import api from "@/shared/api/axios";

export type ScoreBlock = {
  score: number | null;
  max_score: number | null;
  passed: boolean | null;
  clinic_required: boolean;

  is_locked?: boolean;
  lock_reason?: string | null;

  // âœ… í™•ì¥(ì˜µì…”ë„, ê³„ì•½ íŒŒê´´ ì—†ìŒ): ì„œë²„ê°€ ë‚´ë ¤ì£¼ëŠ” meta.status ì†Œë¹„
  meta?: {
    status?: string | null; // "NOT_SUBMITTED" | null
  } | null;
};

export type SessionScoreExamEntry = {
  exam_id: number;
  title: string;
  pass_score: number;
  block: ScoreBlock;
};

export type SessionScoreHomeworkEntry = {
  homework_id: number;
  title: string;
  block: ScoreBlock;
};

export type SessionScoreRow = {
  enrollment_id: number;
  student_name: string;

  // ì‹œí—˜ 1:N
  exams: SessionScoreExamEntry[];

  // ê³¼ì œ 1:N
  homeworks: SessionScoreHomeworkEntry[];

  updated_at: string;
};

export type SessionScoreMeta = {
  exams: {
    exam_id: number;
    title: string;
    pass_score: number;
  }[];

  homeworks: {
    homework_id: number;
    title: string;
    unit: string | null; // "%", "ì " ë“± (ì„œë²„ ë‹¨ì¼ ì§„ì‹¤)
  }[];
};

export type SessionScoresResponse = {
  meta: SessionScoreMeta;
  rows: SessionScoreRow[];
};

export async function fetchSessionScores(sessionId: number) {
  const res = await api.get(`/results/admin/sessions/${sessionId}/scores/`);
  return res.data as SessionScoresResponse;
}


==========================================================================================
# FILE: components/ExamStatusChip.tsx
==========================================================================================
// PATH: src/features/scores/components/ExamStatusChip.tsx
/**
 * ExamStatusChip
 * - ìš°ì¸¡ ì˜ìˆ˜ì¦ ìƒë‹¨ìš© ìƒíƒœ ìš”ì•½
 * - (ë³€ê²½) í´ë¦­ ê°€ëŠ¥ ì˜µì…˜ ì§€ì› (ì‹œí—˜/ê³¼ì œ ì¹© ì„ íƒ â†’ í…Œì´ë¸” ì»¬ëŸ¼ ì „í™˜)
 */

type Props = {
  label: string;
  passed: boolean | null;

  /** optional: í´ë¦­ ê°€ëŠ¥ */
  onClick?: () => void;

  /** optional: í˜„ì¬ ì„ íƒ ìƒíƒœ ê°•ì¡° */
  active?: boolean;
};

export default function ExamStatusChip({
  label,
  passed,
  onClick,
  active,
}: Props) {
  const clickable = typeof onClick === "function";

  const base = [
    "rounded px-2 py-1 text-xs",
    clickable ? "cursor-pointer select-none" : "",
    active ? "ring-2 ring-[var(--color-primary)] ring-offset-1" : "",
  ]
    .filter(Boolean)
    .join(" ");

  if (passed === null) {
    return (
      <div
        className={[
          base,
          "border border-gray-300 bg-white text-gray-500",
        ].join(" ")}
        onClick={onClick}
        role={clickable ? "button" : undefined}
        tabIndex={clickable ? 0 : undefined}
        onKeyDown={(e) => {
          if (!clickable) return;
          if (e.key === "Enter" || e.key === " ") {
            e.preventDefault();
            onClick?.();
          }
        }}
        title={clickable ? "í´ë¦­í•˜ì—¬ ì»¬ëŸ¼ ì „í™˜" : undefined}
      >
        {label}
      </div>
    );
  }

  return passed ? (
    <div
      className={[
        base,
        "bg-emerald-100 font-semibold text-emerald-700",
      ].join(" ")}
      onClick={onClick}
      role={clickable ? "button" : undefined}
      tabIndex={clickable ? 0 : undefined}
      onKeyDown={(e) => {
        if (!clickable) return;
        if (e.key === "Enter" || e.key === " ") {
          e.preventDefault();
          onClick?.();
        }
      }}
      title={clickable ? "í´ë¦­í•˜ì—¬ ì»¬ëŸ¼ ì „í™˜" : undefined}
    >
      {label}
    </div>
  ) : (
    <div
      className={[
        base,
        "bg-red-100 font-semibold text-red-700",
      ].join(" ")}
      onClick={onClick}
      role={clickable ? "button" : undefined}
      tabIndex={clickable ? 0 : undefined}
      onKeyDown={(e) => {
        if (!clickable) return;
        if (e.key === "Enter" || e.key === " ") {
          e.preventDefault();
          onClick?.();
        }
      }}
      title={clickable ? "í´ë¦­í•˜ì—¬ ì»¬ëŸ¼ ì „í™˜" : undefined}
    >
      {label}
    </div>
  );
}


==========================================================================================
# FILE: components/HomeworkQuickInput.tsx
==========================================================================================
// PATH: src/features/scores/components/HomeworkQuickInput.tsx
/**
 * HomeworkQuickInput
 * - QuickScoreInputê³¼ ë™ì¼ UX + ìµœì†Œ í™•ì¥
 * - `/ + Enter` â†’ meta.status = "NOT_SUBMITTED"
 * - (ì˜µì…˜) ë¹ˆ ê°’ + Enter â†’ meta.status í•´ì œ + score null (ë¯¸ì…ë ¥)
 *
 * âš ï¸ íŒì •/ê³„ì‚° ê¸ˆì§€: ì„œë²„ ì‘ë‹µë§Œ ì‹ ë¢°
 */

import React, { useMemo, useState } from "react";

type Props = {
  defaultValue: number | null;
  maxScore?: number | null;

  disabled?: boolean;
  disabledReason?: string;

  // âœ… score ì €ì¥
  onSubmitScore: (score: number) => Promise<void>;

  // âœ… ë¯¸ì œì¶œ ì €ì¥
  onMarkNotSubmitted: () => Promise<void>;

  // âœ… ë¯¸ì œì¶œ í•´ì œ/ë¯¸ì…ë ¥(ì„ íƒ)
  onClearStatus?: () => Promise<void>;

  onMoveUp?: () => void;
  onMoveDown?: () => void;
};

function parseScore(input: string, maxScore?: number | null): number | null {
  const v = input.trim();
  const hasMax =
    maxScore != null &&
    Number.isFinite(Number(maxScore)) &&
    Number(maxScore) > 0;

  if (v.endsWith("%") && hasMax) {
    const p = Number(v.slice(0, -1));
    if (Number.isFinite(p)) {
      return Math.round((p / 100) * Number(maxScore));
    }
  }

  if (v.includes("/") && hasMax) {
    const [aRaw, bRaw] = v.split("/");
    const a = Number(aRaw);
    const b = Number(bRaw);
    if (Number.isFinite(a) && Number.isFinite(b) && b > 0) {
      return Math.round((a / b) * Number(maxScore));
    }
  }

  const n = Number(v);
  if (Number.isFinite(n)) return n;

  return null;
}

const HomeworkQuickInput = React.forwardRef<HTMLInputElement, Props>(
  function HomeworkQuickInput(
    {
      defaultValue,
      maxScore,
      disabled,
      disabledReason,
      onSubmitScore,
      onMarkNotSubmitted,
      onClearStatus,
      onMoveUp,
      onMoveDown,
    },
    ref
  ) {
    const initial = useMemo(
      () => (defaultValue == null ? "" : String(defaultValue)),
      [defaultValue]
    );

    const [value, setValue] = useState(initial);
    const [saving, setSaving] = useState(false);

    React.useEffect(() => {
      setValue(initial);
    }, [initial]);

    const commitScore = async () => {
      const parsed = parseScore(value, maxScore);
      if (parsed == null) return;

      try {
        setSaving(true);
        await onSubmitScore(parsed);
      } finally {
        setSaving(false);
      }
    };

    const commitNotSubmitted = async () => {
      try {
        setSaving(true);
        await onMarkNotSubmitted();
      } finally {
        setSaving(false);
      }
    };

    const commitClear = async () => {
      if (!onClearStatus) return;
      try {
        setSaving(true);
        await onClearStatus();
      } finally {
        setSaving(false);
      }
    };

    return (
      <input
        ref={ref}
        className={[
          "w-20 rounded border px-1 py-0.5 text-xs",
          "border-[var(--border-default)]",
          disabled
            ? "bg-[var(--bg-surface-soft)] text-[var(--text-muted)]"
            : "bg-[var(--bg-surface)] text-[var(--text-primary)]",
        ].join(" ")}
        value={value}
        onChange={(e) => setValue(e.target.value)}
        onBlur={() => {
          if (disabled) return;
          void commitScore();
        }}
        onKeyDown={async (e) => {
          if (disabled) return;

          if (e.key === "Enter") {
            e.preventDefault();

            const trimmed = value.trim();

            // âœ… `/ + Enter` â†’ ë¯¸ì œì¶œ
            if (trimmed === "/") {
              await commitNotSubmitted();
              return;
            }

            // âœ… ë¹ˆ ê°’ + Enter â†’ ìƒíƒœ í•´ì œ(ì„ íƒ)
            if (trimmed === "") {
              await commitClear();
              return;
            }

            await commitScore();
            return;
          }

          if (e.key === "ArrowUp") {
            e.preventDefault();
            onMoveUp?.();
            return;
          }

          if (e.key === "ArrowDown") {
            e.preventDefault();
            onMoveDown?.();
            return;
          }
        }}
        disabled={disabled || saving}
        title={
          disabled
            ? disabledReason ?? "í¸ì§‘ ë¶ˆê°€"
            : "Enter/blur ì €ì¥ Â· 95% / 16/64 ì…ë ¥ ê°€ëŠ¥ Â· `/ + Enter` ë¯¸ì œì¶œ"
        }
      />
    );
  }
);

export default HomeworkQuickInput;


==========================================================================================
# FILE: components/HomeworkScoreInput.tsx
==========================================================================================
// PATH: src/features/scores/components/HomeworkScoreInput.tsx
// ì—­í• : ì¡°êµê°€ "ëŒ€ì¶©" ì…ë ¥í•˜ëŠ” UI (32ë¬¸í•­ / 80%)

type Props = {
  value: number | null;
  locked: boolean;
  onChange: (v: number | null) => void;
};

export default function HomeworkScoreInput({
  value,
  locked,
  onChange,
}: Props) {
  if (locked) {
    return <span className="text-gray-400">{value ?? "-"}</span>;
  }

  return (
    <input
      type="number"
      min={0}
      max={100}
      step={5}
      value={value ?? ""}
      onChange={(e) =>
        onChange(e.target.value === "" ? null : Number(e.target.value))
      }
      className="w-16 rounded border px-1 py-0.5 text-sm"
      placeholder="%"
    />
  );
}


==========================================================================================
# FILE: components/InlineExamItemsRow.tsx
==========================================================================================
// PATH: src/features/scores/components/InlineExamItemsRow.tsx
/**
 * ì‹œí—˜ ì„œìˆ í˜• ë¬¸í•­ ì¸ë¼ì¸ ë¹ ë¥¸ ì…ë ¥ Row
 * - í…Œì´ë¸” ë‚´ë¶€ í™•ì¥(ì„ íƒëœ í•™ìƒ ì•„ë˜)
 * - results API ì†Œë¹„ (READ/WRITE)
 * - í‚¤ë³´ë“œ ì—°ì† ì…ë ¥ ì „ìš©:
 *   - Enter ì €ì¥ í›„ ë‹¤ìŒ ì¹¸ ìë™ ì´ë™
 *   - â†/â†’ ì´ë™ ì§€ì›
 */

import { useMemo, useRef } from "react";
import { useQuery, useQueryClient } from "@tanstack/react-query";
import { fetchEditableExamItems } from "../api/fetchEditableExamItems";
import ScoreInputCell from "./ScoreInputCell";

type Props = {
  examId: number;
  enrollmentId: number;
  colSpan?: number;
  /** 'table' = tr/td (ê¸°ì¡´), 'block' = divë§Œ (ê·¸ë¦¬ë“œ í™•ì¥í–‰ìš©) */
  variant?: "table" | "block";
};

export default function InlineExamItemsRow({
  examId,
  enrollmentId,
  colSpan = 1,
  variant = "table",
}: Props) {
  const qc = useQueryClient();

  const { data: items } = useQuery({
    queryKey: ["exam-items", examId, enrollmentId],
    queryFn: () => fetchEditableExamItems({ examId, enrollmentId }),
    enabled: Number.isFinite(examId) && examId > 0 && Number.isFinite(enrollmentId) && enrollmentId > 0,
  });

  const list = useMemo(() => items ?? [], [items]);

  const inputRefs = useRef<Array<HTMLInputElement | null>>([]);

  const focusAt = (idx: number) => {
    const el = inputRefs.current[idx];
    if (el) el.focus();
  };

  if (!list || list.length === 0) return null;

  const inner = (
    <>
      <div className="flex flex-wrap gap-2">
        {list.map((it, i) => {
          const disabled = !it.is_editable || it.is_locked;

          return (
            <div
              key={it.question_id}
              className="flex items-center gap-2 rounded-lg border px-3 py-2 transition-all"
              style={{
                borderColor: disabled
                  ? "var(--color-border-divider)"
                  : "var(--color-border-divider-strong)",
                background: disabled
                  ? "var(--color-bg-surface-soft)"
                  : "var(--color-bg-surface)",
                opacity: disabled ? 0.6 : 1,
              }}
            >
              <span
                style={{
                  fontSize: "var(--text-xs)",
                  fontWeight: "var(--font-title)",
                  color: "var(--color-text-secondary)",
                }}
              >
                Q{it.question_id}
              </span>

              <ScoreInputCell
                examId={it.exam_id}
                enrollmentId={it.enrollment_id}
                questionId={it.question_id}
                value={it.score}
                maxScore={it.max_score}
                disabled={disabled}
                inputRef={(el) => {
                  inputRefs.current[i] = el;
                }}
                onMovePrev={() => focusAt(Math.max(0, i - 1))}
                onMoveNext={() => focusAt(Math.min(list.length - 1, i + 1))}
                onSaved={() => {
                  qc.invalidateQueries({
                    queryKey: ["exam-items", examId, enrollmentId],
                  });
                  qc.invalidateQueries({ queryKey: ["session-scores"] });
                }}
              />
              {disabled && (
                <span
                  style={{
                    fontSize: "10px",
                    color: "var(--color-text-muted)",
                    fontStyle: "italic",
                  }}
                >
                  {it.is_locked ? "ì ê¹€" : "í¸ì§‘ ë¶ˆê°€"}
                </span>
              )}
            </div>
          );
        })}
      </div>
      <div
        className="mt-2"
        style={{
          fontSize: "var(--text-xs)",
          color: "var(--color-text-muted)",
          fontWeight: "var(--font-meta)",
        }}
      >
        ğŸ’¡ Enter ì €ì¥ Â· â†/â†’ ì´ë™ Â· ê°ê´€ì‹/ì£¼ê´€ì‹ ëª¨ë‘ ìˆ˜ë™ ì±„ì  ê°€ëŠ¥
      </div>
    </>
  );

  if (variant === "block") {
    return <div>{inner}</div>;
  }

  return (
    <tr
      style={{
        background: "color-mix(in srgb, var(--color-primary) 4%, var(--color-bg-surface))",
      }}
    >
      <td colSpan={colSpan} style={{ padding: "var(--space-4)" }}>
        {inner}
      </td>
    </tr>
  );
}


==========================================================================================
# FILE: components/QuickScoreInput.tsx
==========================================================================================
// PATH: src/features/scores/components/QuickScoreInput.tsx
/**
 * ë¹ ë¥¸ ì ìˆ˜ ì…ë ¥ UI
 *
 * í™•ì¥:
 * - "/" + Enter â†’ ë¯¸ì œì¶œ (status=NOT_SUBMITTED)
 */

import React, { useMemo, useState } from "react";

type Props = {
  defaultValue: number | null;
  maxScore?: number | null;

  disabled?: boolean;
  disabledReason?: string;

  onSubmitScore: (score: number) => Promise<void>;
  onSubmitNotSubmitted: () => Promise<void>;

  onMoveUp?: () => void;
  onMoveDown?: () => void;
};

const QuickScoreInput = React.forwardRef<HTMLInputElement, Props>(
  function QuickScoreInput(
    {
      defaultValue,
      maxScore,
      disabled,
      disabledReason,
      onSubmitScore,
      onSubmitNotSubmitted,
      onMoveUp,
      onMoveDown,
    },
    ref
  ) {
    const initial = useMemo(
      () => (defaultValue == null ? "" : String(defaultValue)),
      [defaultValue]
    );

    const [value, setValue] = useState(initial);
    const [saving, setSaving] = useState(false);

    React.useEffect(() => {
      setValue(initial);
    }, [initial]);

    const commitScore = async () => {
      const n = Number(value);
      if (!Number.isFinite(n)) return;

      try {
        setSaving(true);
        await onSubmitScore(n);
      } finally {
        setSaving(false);
      }
    };

    const commitNotSubmitted = async () => {
      try {
        setSaving(true);
        await onSubmitNotSubmitted();
        setValue(""); // UX: ì…ë ¥ ì´ˆê¸°í™”
      } finally {
        setSaving(false);
      }
    };

    return (
      <input
        ref={ref}
        className={[
          "w-20 rounded border px-1 py-0.5 text-xs",
          disabled
            ? "bg-[var(--bg-surface-soft)] text-[var(--text-muted)]"
            : "bg-[var(--bg-surface)] text-[var(--text-primary)]",
        ].join(" ")}
        value={value}
        onChange={(e) => setValue(e.target.value)}
        onKeyDown={async (e) => {
          if (disabled) return;

          // âœ… "/" â†’ ë¯¸ì œì¶œ
          if (e.key === "/") {
            e.preventDefault();
            setValue("/");
            return;
          }

          if (e.key === "Enter") {
            e.preventDefault();

            if (value.trim() === "/") {
              await commitNotSubmitted();
              return;
            }

            await commitScore();
            return;
          }

          if (e.key === "ArrowUp") {
            e.preventDefault();
            onMoveUp?.();
          }

          if (e.key === "ArrowDown") {
            e.preventDefault();
            onMoveDown?.();
          }
        }}
        disabled={disabled || saving}
        title={
          disabled
            ? disabledReason ?? "í¸ì§‘ ë¶ˆê°€"
            : "ìˆ«ì+Enter: ì ìˆ˜ Â· '/' + Enter: ë¯¸ì œì¶œ"
        }
      />
    );
  }
);

export default QuickScoreInput;


==========================================================================================
# FILE: components/ScoreInputCell.tsx
==========================================================================================
// PATH: src/features/scores/components/ScoreInputCell.tsx
/**
 * âœ… ScoreInputCell
 * - ì¸ë¼ì¸ ì ìˆ˜ ì…ë ¥
 * - blur / Enter ì‹œ ì¦‰ì‹œ ì €ì¥
 * - (ì¶”ê°€) Enter ì €ì¥ í›„ ë‹¤ìŒ ì…€ë¡œ ì´ë™ ê°€ëŠ¥(onMoveNext)
 * - (ì¶”ê°€) ArrowLeft/Rightë¡œ ì´ì „/ë‹¤ìŒ ì´ë™ ê°€ëŠ¥(onMovePrev/onMoveNext)
 *
 * âš ï¸ ë‹¨ì¼ì§„ì‹¤: results PATCH ì‘ë‹µ
 * - optimistic update ê¸ˆì§€
 */

import { useEffect, useState } from "react";
import { patchExamItemScore } from "../api/patchItemScore";

type Props = {
  examId: number;
  enrollmentId: number;
  questionId: number;
  value: number | null;
  maxScore: number;
  disabled: boolean;
  onSaved: () => void;

  /** optional: ì™¸ë¶€ì—ì„œ focus ì œì–´ */
  inputRef?: (el: HTMLInputElement | null) => void;

  /** optional: í‚¤ë³´ë“œ ì—°ì† ì…ë ¥ìš© */
  onMovePrev?: () => void;
  onMoveNext?: () => void;
};

export default function ScoreInputCell({
  examId,
  enrollmentId,
  questionId,
  value,
  maxScore,
  disabled,
  onSaved,
  inputRef,
  onMovePrev,
  onMoveNext,
}: Props) {
  const [draft, setDraft] = useState<string>(value == null ? "" : String(value));
  const [saving, setSaving] = useState(false);

  useEffect(() => {
    setDraft(value == null ? "" : String(value));
  }, [value]);

  const commit = async () => {
    if (disabled) return false;

    const next = Number(draft);
    if (!Number.isFinite(next) || next < 0 || next > maxScore) {
      setDraft(value == null ? "" : String(value));
      return false;
    }

    try {
      setSaving(true);
      await patchExamItemScore({
        examId,
        enrollmentId,
        questionId,
        score: next,
      });
      onSaved();
      return true;
    } catch {
      setDraft(value == null ? "" : String(value));
      return false;
    } finally {
      setSaving(false);
    }
  };

  return (
    <input
      ref={inputRef}
      type="number"
      min={0}
      max={maxScore}
      value={draft}
      disabled={disabled || saving}
      onChange={(e) => setDraft(e.target.value)}
      onBlur={() => {
        void commit();
      }}
      onKeyDown={async (e) => {
        if (disabled) return;

        if (e.key === "Enter") {
          e.preventDefault();
          const ok = await commit();
          if (ok) onMoveNext?.();
          return;
        }

        if (e.key === "ArrowLeft") {
          e.preventDefault();
          onMovePrev?.();
          return;
        }

        if (e.key === "ArrowRight") {
          e.preventDefault();
          onMoveNext?.();
          return;
        }
      }}
      className="rounded-lg border px-2 py-1.5 text-sm text-right font-medium transition-all"
      style={{
        width: 72,
        borderColor: disabled
          ? "var(--color-border-divider)"
          : "var(--color-border-divider-strong)",
        background: disabled
          ? "var(--color-bg-surface-soft)"
          : "var(--color-bg-surface)",
        color: disabled
          ? "var(--color-text-muted)"
          : "var(--color-text-primary)",
        cursor: disabled ? "not-allowed" : "text",
      }}
      title={
        disabled
          ? "ì±„ì  ì¤‘ì´ê±°ë‚˜ í¸ì§‘ ë¶ˆê°€ ìƒíƒœ"
          : "Enter ì €ì¥ Â· â†/â†’ ì´ë™ Â· blur ì €ì¥ Â· ê°ê´€ì‹/ì£¼ê´€ì‹ ëª¨ë‘ ì§€ì›"
      }
    />
  );
}


==========================================================================================
# FILE: components/ScoresTable.tsx
==========================================================================================
// PATH: src/features/scores/components/ScoresTable.tsx
/**
 * ì„±ì  íƒ­ ë©”ì¸ í…Œì´ë¸” â€” ë™ì  ì»¬ëŸ¼ êµ¬ì¡°
 *
 * ì»¬ëŸ¼: ì²´í¬ë°•ìŠ¤ | ì´ë¦„ | ì¶œì„ | {ì‹œí—˜1} | {ì‹œí—˜2} | ... | {ê³¼ì œ1} | {ê³¼ì œ2} | ... | í´ë¦¬ë‹‰
 * - ì‹œí—˜/ê³¼ì œ: ì ìˆ˜ + í•©ë¶ˆ ë±ƒì§€ + ì§ì ‘ ì…ë ¥
 * - ì»¤íŠ¸ë¼ì¸ ì „ìˆ˜ ê¸°ë°˜ í•©ë¶ˆ, í•˜ë‚˜ë¼ë„ ë¶ˆí•© â†’ í´ë¦¬ë‹‰ ëŒ€ìƒì
 */

import { useMemo, useRef, Fragment, useEffect } from "react";
import { useQueryClient } from "@tanstack/react-query";

import type { SessionScoreRow, SessionScoreMeta } from "../api/sessionScores";
import InlineExamItemsRow from "./InlineExamItemsRow";
import { patchHomeworkQuick } from "../api/patchHomeworkQuick";
import HomeworkQuickInput from "./HomeworkQuickInput";
import { getHomeworkStatus } from "../utils/homeworkStatus";
import StudentNameWithLectureChip from "@/shared/ui/chips/StudentNameWithLectureChip";
import { TABLE_COL } from "@/shared/ui/domain";
import AttendanceStatusBadge, {
  type AttendanceStatus,
} from "@/shared/ui/badges/AttendanceStatusBadge";

const COL_SCORE = 110; // ì‹œí—˜/ê³¼ì œ ì ìˆ˜+ë±ƒì§€ ì»¬ëŸ¼ ë„ˆë¹„

/** í•©ë¶ˆ ë±ƒì§€ */
function PassFailBadge({
  passed,
}: {
  passed: boolean | null | undefined;
}) {
  if (passed == null) return null;
  const tone = passed ? "success" : "danger";
  return (
    <span className="ds-status-badge ds-status-badge--1ch" data-tone={tone}>
      {passed ? "í•©" : "ë¶ˆ"}
    </span>
  );
}

/** ì§„í–‰ì¤‘/ì™„ë£Œ ë±ƒì§€ (ì ìˆ˜ ì…ë ¥ ì—¬ë¶€ ê¸°ì¤€) */
function ProgressBadge({
  hasScore,
  isLocked,
}: {
  hasScore: boolean;
  isLocked?: boolean;
}) {
  if (isLocked) {
    return (
      <span className="ds-status-badge" data-tone="neutral">
        ì²˜ë¦¬ì¤‘
      </span>
    );
  }
  return hasScore ? (
    <span className="ds-status-badge" data-tone="success">
      ì™„ë£Œ
    </span>
  ) : (
    <span className="ds-status-badge" data-tone="danger">
      ì§„í–‰ì¤‘
    </span>
  );
}

/** í´ë¦¬ë‹‰ ëŒ€ìƒì ì—¬ë¶€: ì‹œí—˜/ê³¼ì œ ì¤‘ í•˜ë‚˜ë¼ë„ ë¶ˆí•© */
function isClinicTarget(row: SessionScoreRow): boolean {
  const examFail = row.exams?.some((e) => e.block.passed === false) ?? false;
  const hwFail =
    row.homeworks?.some((h) => {
      const st = getHomeworkStatus({
        score: h.block.score,
        metaStatus: h.block.meta?.status ?? null,
      });
      return st === "NOT_SUBMITTED" || h.block.passed === false;
    }) ?? false;
  return examFail || hwFail;
}

type Props = {
  rows: SessionScoreRow[];
  meta: SessionScoreMeta | null;
  sessionId: number;

  /** enrollment_id -> attendance status (PRESENT, ONLINE, INACTIVE ë“±) */
  attendanceMap?: Record<number, string>;

  selectedEnrollmentId: number | null;
  selectedExamId: number | null;
  selectedHomeworkId: number | null;
  onSelectCell: (row: SessionScoreRow, type: "exam" | "homework", id: number) => void;
  onSelectRow: (row: SessionScoreRow) => void;
};

export default function ScoresTable({
  rows,
  meta,
  sessionId,
  attendanceMap = {},
  selectedEnrollmentId,
  selectedExamId,
  selectedHomeworkId,
  onSelectCell,
  onSelectRow,
}: Props) {
  const qc = useQueryClient();
  const homeworkInputRefs = useRef<Record<string, HTMLInputElement | null>>({});

  const examOptions = meta?.exams ?? [];
  const homeworkOptions = meta?.homeworks ?? [];

  const dynamicCols = useMemo(() => {
    const examCols = examOptions.map((e) => ({ type: "exam" as const, id: e.exam_id, title: e.title }));
    const hwCols = homeworkOptions.map((h) => ({
      type: "homework" as const,
      id: h.homework_id,
      title: h.title,
    }));
    return [...examCols, ...hwCols];
  }, [examOptions, homeworkOptions]);

  const gridTemplateColumns = useMemo(() => {
    const fixed = `${TABLE_COL.checkbox}px ${TABLE_COL.name}px ${TABLE_COL.statusBadge}px`;
    const dynamic = dynamicCols.map(() => `${COL_SCORE}px`).join(" ");
    const clinic = `${TABLE_COL.statusBadge}px`;
    return `${fixed} ${dynamic} ${clinic}`;
  }, [dynamicCols]);

  const thBase =
    "px-2 py-3 text-xs font-semibold text-[var(--text-secondary)] tracking-tight truncate";
  const tdBase = "px-2 py-2 text-sm text-[var(--text-primary)]";

  const focusHomeworkInput = (enrollmentId: number, homeworkId: number) => {
    homeworkInputRefs.current[`${enrollmentId}-${homeworkId}`]?.focus();
  };

  return (
    <div
      className="ds-table-wrap overflow-x-auto"
      style={{
        borderRadius: "var(--radius-lg)",
        border: "1px solid var(--color-border-divider)",
        background: "var(--color-bg-surface)",
        overflow: "hidden",
      }}
      tabIndex={0}
    >
      <div
        style={{
          display: "grid",
          gridTemplateColumns,
          minWidth: "max-content",
        }}
      >
        {/* HEADER */}
        <div
          className={`${thBase} border-b border-[var(--color-border-divider)]`}
          style={{
            background: "color-mix(in srgb, var(--color-primary) 4%, transparent)",
          }}
        >
          {" "}
        </div>
        <div
          className={`${thBase} border-b border-[var(--color-border-divider)]`}
          style={{
            background: "color-mix(in srgb, var(--color-primary) 4%, transparent)",
          }}
        >
          ì´ë¦„
        </div>
        <div
          className={`${thBase} border-b border-[var(--color-border-divider)]`}
          style={{
            background: "color-mix(in srgb, var(--color-primary) 4%, transparent)",
          }}
        >
          ì¶œì„
        </div>
        {dynamicCols.map((col) => (
          <div
            key={`${col.type}-${col.id}`}
            className={`${thBase} border-b border-[var(--color-border-divider)]`}
            style={{
              background: "color-mix(in srgb, var(--color-primary) 4%, transparent)",
              writingMode: "horizontal-tb",
            }}
            title={col.title}
          >
            {col.title}
          </div>
        ))}
        <div
          className={`${thBase} border-b border-[var(--color-border-divider)]`}
          style={{
            background: "color-mix(in srgb, var(--color-primary) 4%, transparent)",
          }}
        >
          í´ë¦¬ë‹‰
        </div>
      </div>

      {/* BODY */}
      {rows.map((row) => {
        const selected = selectedEnrollmentId === row.enrollment_id;
        const clinicTarget = isClinicTarget(row);

        return (
          <Fragment key={row.enrollment_id}>
            <div
              className={[
                "border-b border-[var(--color-border-divider)] transition-colors",
                selected
                  ? "bg-[color-mix(in srgb, var(--color-primary) 8%, var(--color-bg-surface))]"
                  : "hover:bg-[var(--bg-surface-soft)]",
              ].join(" ")}
              style={{
                display: "grid",
                gridTemplateColumns,
                minWidth: "max-content",
              }}
            >
              {/* ì²´í¬ë°•ìŠ¤ (placeholder) */}
              <div
                className={`${tdBase} flex items-center`}
                onClick={() => onSelectRow(row)}
              >
                <span className="w-4" />
              </div>

              {/* ì´ë¦„ */}
              <div
                className={`${tdBase} font-semibold min-w-0 cursor-pointer`}
                onClick={() => onSelectRow(row)}
              >
                <StudentNameWithLectureChip
                  name={row.student_name ?? ""}
                  profilePhotoUrl={row.profile_photo_url ?? undefined}
                  avatarSize={24}
                  lectures={
                    row.lecture_title
                      ? [{ lectureName: row.lecture_title, color: row.lecture_color }]
                      : undefined
                  }
                  chipSize={14}
                />
              </div>

              {/* ì¶œì„ */}
              <div
                className={`${tdBase} flex items-center cursor-pointer`}
                onClick={() => onSelectRow(row)}
              >
                {(() => {
                  const status = attendanceMap[row.enrollment_id];
                  if (!status) return <span className="text-[var(--text-muted)]">-</span>;
                  return (
                    <AttendanceStatusBadge
                      status={status as AttendanceStatus}
                      variant="2ch"
                    />
                  );
                })()}
              </div>

              {/* ì‹œí—˜ ì»¬ëŸ¼ë“¤ */}
              {examOptions.map((ex) => {
                const entry = row.exams?.find((e) => e.exam_id === ex.exam_id) ?? null;
                const block = entry?.block;
                const isSelected =
                  selected &&
                  selectedExamId === ex.exam_id &&
                  selectedHomeworkId == null;
                const hasScore = block?.score != null && !block?.is_locked;
                const scoreText =
                  block?.score == null
                    ? "-"
                    : block?.max_score != null && block.max_score > 0
                      ? `${Math.round(block.score)}/${Math.round(block.max_score)}`
                      : `${Math.round(block!.score)}ì `;

                return (
                  <div
                    key={`exam-${ex.exam_id}`}
                    className={`${tdBase} flex flex-col gap-1 cursor-pointer min-w-0 ${
                      isSelected
                        ? "ring-1 ring-[var(--color-primary)] rounded"
                        : ""
                    }`}
                    style={{ padding: 6 }}
                    onClick={(e) => {
                      e.stopPropagation();
                      onSelectCell(row, "exam", ex.exam_id);
                    }}
                  >
                    <div className="flex items-center gap-1 flex-wrap">
                      <span className="font-medium">{scoreText}</span>
                      <PassFailBadge passed={block?.passed} />
                    </div>
                    <ProgressBadge
                      hasScore={!!hasScore}
                      isLocked={block?.is_locked}
                    />
                  </div>
                );
              })}

              {/* ê³¼ì œ ì»¬ëŸ¼ë“¤ */}
              {homeworkOptions.map((hw) => {
                const entry =
                  row.homeworks?.find((h) => h.homework_id === hw.homework_id) ??
                  null;
                const block = entry?.block;
                const isSelected =
                  selected && selectedHomeworkId === hw.homework_id;
                const hwStatus = getHomeworkStatus({
                  score: block?.score,
                  metaStatus: block?.meta?.status ?? null,
                });

                return (
                  <div
                    key={`hw-${hw.homework_id}`}
                    className={`${tdBase} flex flex-col gap-1 min-w-0 ${
                      isSelected
                        ? "ring-1 ring-[var(--color-primary)] rounded"
                        : ""
                    }`}
                    style={{ padding: 6 }}
                    onClick={(e) => {
                      e.stopPropagation();
                      onSelectCell(row, "homework", hw.homework_id);
                    }}
                  >
                    <div
                      className="flex items-center gap-2 flex-wrap"
                      onClick={(e) => e.stopPropagation()}
                    >
                      {entry ? (
                        <>
                          <HomeworkQuickInput
                            ref={(el) => {
                              homeworkInputRefs.current[
                                `${row.enrollment_id}-${hw.homework_id}`
                              ] = el;
                            }}
                            defaultValue={block?.score ?? null}
                            maxScore={block?.max_score ?? null}
                            onSubmitScore={async (score) => {
                              await patchHomeworkQuick({
                                sessionId,
                                enrollmentId: row.enrollment_id,
                                homeworkId: hw.homework_id,
                                score,
                              });
                              qc.invalidateQueries({
                                queryKey: ["session-scores", sessionId],
                              });
                            }}
                            onMarkNotSubmitted={async () => {
                              await patchHomeworkQuick({
                                sessionId,
                                enrollmentId: row.enrollment_id,
                                homeworkId: hw.homework_id,
                                score: null,
                                metaStatus: "NOT_SUBMITTED",
                              });
                              qc.invalidateQueries({
                                queryKey: ["session-scores", sessionId],
                              });
                            }}
                          />
                          <PassFailBadge passed={block?.passed} />
                        </>
                      ) : (
                        <span className="text-[var(--text-muted)]">-</span>
                      )}
                    </div>
                    {entry && (
                      <ProgressBadge
                        hasScore={hwStatus === "SCORED" || hwStatus === "ZERO"}
                        isLocked={block?.is_locked}
                      />
                    )}
                  </div>
                );
              })}

              {/* í´ë¦¬ë‹‰ */}
              <div
                className={`${tdBase} flex items-center cursor-pointer`}
                onClick={() => onSelectRow(row)}
              >
                {clinicTarget ? (
                  <span
                    className="ds-status-badge"
                    data-tone="danger"
                    title="í•˜ë‚˜ë¼ë„ ë¶ˆí•©ìœ¼ë¡œ í´ë¦¬ë‹‰ ëŒ€ìƒ"
                  >
                    ëŒ€ìƒ
                  </span>
                ) : (
                  <span className="text-[var(--text-muted)]">-</span>
                )}
              </div>
            </div>

            {/* ì‹œí—˜ ë¬¸í•­ë³„ ì£¼ê´€ì‹ ì…ë ¥ í™•ì¥í–‰ (í´ë¦­ ì‹œ í•´ë‹¹ ì‹œí—˜ì˜ ë¬¸í•­ë³„ ìˆ˜ê¸° ì…ë ¥) */}
            {selected &&
              selectedExamId != null &&
              row.enrollment_id === selectedEnrollmentId && (
                <div
                  className="border-b border-[var(--color-border-divider)]"
                  style={{
                    background: "color-mix(in srgb, var(--color-primary) 4%, var(--color-bg-surface))",
                    padding: "var(--space-4)",
                  }}
                >
                  <InlineExamItemsRow
                    examId={selectedExamId}
                    enrollmentId={row.enrollment_id}
                    variant="block"
                  />
                </div>
              )}
          </Fragment>
        );
      })}
    </div>
  );
}


==========================================================================================
# FILE: components/ScoresTableExtended.tsx
==========================================================================================
// PATH: src/features/scores/components/ScoresTableExtended.tsx
/**
 * ScoresTableExtended (LEGACY BRIDGE)
 * - ê¸°ì¡´ importê°€ ë‚¨ì•„ìˆì„ ìˆ˜ ìˆì–´ ë¸Œë¦¿ì§€ë¡œ ìœ ì§€
 * - í˜„ì¬ëŠ” ScoresTableì„ ê·¸ëŒ€ë¡œ ë Œë”ë§
 *
 * âš ï¸ ì¤‘ì²© <table> ë§Œë“¤ë˜ ì´ì „ êµ¬í˜„ì€ ì œê±°(ê¹¨ì§€ëŠ” êµ¬ì¡°ì˜€ìŒ)
 */

import ScoresTable from "./ScoresTable";
import type { SessionScoreRow, SessionScoreMeta } from "../api/sessionScores";

type Props = {
  rows: SessionScoreRow[];
  meta: SessionScoreMeta | null;
  sessionId: number;
  selectedEnrollmentId: number | null;
  onSelectRow: (row: SessionScoreRow) => void;
};

export default function ScoresTableExtended(props: Props) {
  return <ScoresTable {...props} />;
}


==========================================================================================
# FILE: components/SubmissionStatusBadge.tsx
==========================================================================================
/** ì‚¬ì´ì¦ˆÂ·ìƒ‰ìƒ SSOT: ds-status-badge + data-tone (success/danger/warning/primary/neutral) */
type Props = { status: string };

const TONE: Record<string, "success" | "danger" | "warning" | "primary" | "neutral"> = {
  PROCESSING: "primary",
  ANSWERS_READY: "warning",
  NEEDS_IDENTIFICATION: "danger",
  GRADED: "success",
  FAILED: "neutral",
};

const LABEL: Record<string, string> = {
  PROCESSING: "AI ì²˜ë¦¬ì¤‘",
  ANSWERS_READY: "ë‹µì•ˆ í™•ì¸",
  NEEDS_IDENTIFICATION: "ì‹ë³„ í•„ìš”",
  GRADED: "ì±„ì  ì™„ë£Œ",
  FAILED: "ì‹¤íŒ¨",
};

export default function SubmissionStatusBadge({ status }: Props) {
  const tone = TONE[status] ?? "neutral";
  return (
    <span className="ds-status-badge" data-tone={tone}>
      {LABEL[status] ?? status}
    </span>
  );
}


==========================================================================================
# FILE: pages/ExamOmrWorkspace.tsx
==========================================================================================
import { useState } from "react";
import SessionScoresPanel from "../panels/SessionScoresPanel";
import OmrSubmissionPanel from "../panels/OmrSubmissionPanel";

export default function ExamOmrWorkspace({
  sessionId,
}: {
  sessionId: number;
}) {
  const [submissionId, setSubmissionId] = useState<number | null>(null);

  return (
    <div className="space-y-4">
      {submissionId && (
        <OmrSubmissionPanel submissionId={submissionId} />
      )}

      <SessionScoresPanel sessionId={sessionId} />
    </div>
  );
}


==========================================================================================
# FILE: panels/OmrSubmissionPanel.tsx
==========================================================================================
import { useQuery } from "@tanstack/react-query";
import { fetchSubmission } from "../api/pollingSubmission";
import SubmissionStatusBadge from "../components/SubmissionStatusBadge";

export default function OmrSubmissionPanel({
  submissionId,
}: {
  submissionId: number;
}) {
  const { data } = useQuery({
    queryKey: ["submission", submissionId],
    queryFn: () => fetchSubmission(submissionId),
    refetchInterval: 2000, // âœ… polling only
  });

  if (!data) return null;

  return (
    <div className="card p-4 space-y-2">
      <div className="flex justify-between">
        <div className="font-semibold">
          OMR ì œì¶œ #{submissionId}
        </div>
        <SubmissionStatusBadge status={data.status} />
      </div>

      {data.status === "NEEDS_IDENTIFICATION" && (
        <div className="text-sm text-red-600">
          í•™ìƒ ì‹ë³„ì´ í•„ìš”í•©ë‹ˆë‹¤ (íœ´ëŒ€í° ë²ˆí˜¸ ê¸°ì¤€)
        </div>
      )}

      {data.error_message && (
        <div className="text-sm text-red-500">
          {data.error_message}
        </div>
      )}
    </div>
  );
}


==========================================================================================
# FILE: panels/ScoreSidePanel.tsx
==========================================================================================
// PATH: src/features/scores/panels/ScoreSidePanel.tsx

import type { SessionScoreRow, SessionScoreMeta } from "../api/sessionScores";
import ExamStatusChip from "../components/ExamStatusChip";
import { getHomeworkStatus } from "../utils/homeworkStatus";

type Props = {
  sessionId: number;
  examId: number;
  row: SessionScoreRow;
  meta: SessionScoreMeta;
  onClose: () => void;

  activeColumn?: "exam" | "homework";
  onSelectExam?: (examId: number) => void;

  // âœ… ê³¼ì œ ì„ íƒ
  homeworkId: number;
  onSelectHomework?: (homeworkId: number) => void;
};

function overallPassed(row: SessionScoreRow): boolean | null {
  const examResults = row.exams.map((e) => e.block.passed);
  const hwResults = row.homeworks.map((h) => h.block.passed);

  if ([...examResults, ...hwResults].some((v) => v == null)) return null;
  return [...examResults, ...hwResults].every((v) => v === true);
}

function failReasons(row: SessionScoreRow) {
  const failedExams = row.exams
    .filter((e) => e.block.passed === false)
    .map((e) => e.title);

  const failedHomework = row.homeworks
    .filter((h) => {
      const st = getHomeworkStatus({
        score: h.block.score,
        metaStatus: h.block.meta?.status ?? null,
      });
      return st === "NOT_SUBMITTED" || h.block.passed === false;
    })
    .map((h) => h.title);

  return [...failedExams, ...failedHomework];
}

function reasonType(row: SessionScoreRow) {
  const examFail = row.exams.some((e) => e.block.passed === false);
  const hwFail = row.homeworks.some((h) => {
    const st = getHomeworkStatus({
      score: h.block.score,
      metaStatus: h.block.meta?.status ?? null,
    });
    return st === "NOT_SUBMITTED" || h.block.passed === false;
  });

  if (examFail && hwFail) return "ì‹œí—˜ + ê³¼ì œ";
  if (examFail) return "ì‹œí—˜";
  if (hwFail) return "ê³¼ì œ";
  return "-";
}

export default function ScoreSidePanel({
  row,
  meta,
  examId,
  homeworkId,
  activeColumn = "exam",
  onSelectExam,
  onSelectHomework,
}: Props) {
  const exams = row.exams ?? [];
  const homeworks = row.homeworks ?? [];
  const passed = overallPassed(row);
  const reasons = failReasons(row);

  const currentExam = exams.find((e) => e.exam_id === examId);
  const currentHomework = homeworks.find((h) => h.homework_id === homeworkId);

  const activeEntry = activeColumn === "exam" ? currentExam : currentHomework;
  const activePassed =
    activeColumn === "exam" ? currentExam?.block?.passed : currentHomework?.block?.passed;
  const activeScore =
    activeColumn === "exam"
      ? currentExam?.block?.score
      : currentHomework?.block?.score;
  const activeMax =
    activeColumn === "exam"
      ? currentExam?.block?.max_score
      : currentHomework?.block?.max_score;
  const activeTitle =
    activeColumn === "exam" ? currentExam?.title : currentHomework?.title;

  return (
    <div className="card h-full p-4 overflow-y-auto">
      {/* Header */}
      <div className="mb-4 border-b pb-3">
        <div className="text-xs text-[var(--text-muted)]">enrollment #{row.enrollment_id}</div>
        <div className="text-lg font-semibold">{row.student_name}</div>
      </div>

      {/* í˜„ì¬ ì„ íƒ: ì ìˆ˜ì…ë ¥/í†µê³¼Â·ë¯¸í†µê³¼ */}
      {activeEntry && (
        <div className="mb-4 p-3 rounded-lg border border-[var(--color-border-divider)] bg-[var(--color-bg-surface-soft)]">
          <div className="text-sm font-semibold text-[var(--text-secondary)] mb-2">
            {activeTitle}
          </div>
          <div className="flex items-center gap-2 mb-2">
            <span className="text-sm text-[var(--text-muted)]">ì ìˆ˜</span>
            <span className="font-medium">
              {activeScore != null && activeMax != null && activeMax > 0
                ? `${Math.round(activeScore)}/${Math.round(activeMax)}`
                : activeScore != null
                  ? `${Math.round(activeScore)}ì `
                  : "ë¯¸ì…ë ¥"}
            </span>
          </div>
          <div className="flex items-center gap-2">
            <span className="text-sm text-[var(--text-muted)]">íŒì •</span>
            {activePassed != null ? (
              <span
                className="ds-status-badge"
                data-tone={activePassed ? "success" : "danger"}
              >
                {activePassed ? "í†µê³¼" : "ë¯¸í†µê³¼"}
              </span>
            ) : (
              <span className="text-sm text-[var(--text-muted)]">-</span>
            )}
          </div>
          <p className="mt-2 text-xs text-[var(--text-muted)]">
            {activeColumn === "exam"
              ? "ì‹œí—˜: ê°ê´€ì‹ì€ AI OMR ìë™ë°˜ì˜, ì£¼ê´€ì‹ì€ í…Œì´ë¸”ì—ì„œ í•´ë‹¹ ì…€ í´ë¦­ ì‹œ ë¬¸í•­ë³„ ì…ë ¥"
              : "ê³¼ì œ: í…Œì´ë¸” ì…€ì—ì„œ ì§ì ‘ ì ìˆ˜ ì…ë ¥"}
          </p>
        </div>
      )}

      {/* ì‹œí—˜ */}
      <div className="mb-4">
        <div className="mb-1 text-xs font-semibold text-[var(--text-muted)]">ì‹œí—˜</div>
        <div className="flex flex-wrap gap-1">
          {exams.map((e) => (
            <ExamStatusChip
              key={e.exam_id}
              label={e.title}
              passed={e.block.passed}
              onClick={() => onSelectExam?.(e.exam_id)}
              active={activeColumn === "exam" && e.exam_id === examId}
            />
          ))}
        </div>
      </div>

      {/* ê³¼ì œ (ë‹¤ê±´) */}
      <div className="mb-4">
        <div className="mb-1 text-xs font-semibold text-[var(--text-muted)]">ê³¼ì œ</div>
        <div className="flex flex-wrap gap-1">
          {homeworks.map((h) => {
            const st = getHomeworkStatus({
              score: h.block.score,
              metaStatus: h.block.meta?.status ?? null,
            });

            const chipPassed =
              st === "NOT_SUBMITTED" ? false : h.block.passed;

            const label = st === "NOT_SUBMITTED" ? `${h.title} (ë¯¸ì œì¶œ)` : h.title;

            return (
              <ExamStatusChip
                key={h.homework_id}
                label={label}
                passed={chipPassed}
                onClick={() => onSelectHomework?.(h.homework_id)}
                active={activeColumn === "homework" && h.homework_id === homeworkId}
              />
            );
          })}
        </div>
      </div>

      <div className="my-4 border-t" />

      {/* ì¢…í•© íŒì • */}
      <div className="mb-2 flex justify-between text-sm">
        <span className="text-[var(--text-muted)]">ì¢…í•© íŒì •</span>
        <span className="font-semibold">
          {passed == null ? "-" : passed ? "PASS" : "FAIL"}
        </span>
      </div>

      <div className="mb-2 flex justify-between text-sm">
        <span className="text-[var(--text-muted)]">ì‚¬ìœ </span>
        <span className="font-medium">{reasonType(row)}</span>
      </div>

      {/* ì‚¬ìœ ìƒì„¸ */}
      <div className="mt-3">
        <div className="mb-1 text-xs font-semibold text-[var(--text-muted)]">ì‚¬ìœ ìƒì„¸</div>

        {reasons.length === 0 ? (
          <div className="text-xs text-[var(--text-muted)]">-</div>
        ) : (
          <ul className="list-disc pl-4 text-sm">
            {reasons.map((r) => (
              <li key={r}>{r}</li>
            ))}
          </ul>
        )}
      </div>

      {/* í´ë¦¬ë‹‰ ëŒ€ìƒì ì•ˆë‚´ */}
      {(passed === false) && (
        <div className="mt-4 p-2 rounded text-sm bg-[color-mix(in srgb,var(--color-danger) 10%,transparent)] text-[var(--color-danger)]">
          í•˜ë‚˜ë¼ë„ ë¶ˆí•© â†’ í´ë¦¬ë‹‰ ëŒ€ìƒì
        </div>
      )}
    </div>
  );
}


==========================================================================================
# FILE: panels/ScoresAnalyticsPanel.tsx
==========================================================================================
// PATH: src/features/scores/panels/ScoresAnalyticsPanel.tsx
/**
 * ScoresAnalyticsPanel
 *
 * âœ… UI ONLY
 * - Card ê¸°ë°˜ ê³µìš© ë””ìì¸ ì ìš©
 * - í…Œë§ˆ(token.css) ì—°ë™
 * - ë¡œì§ / API / ë°ì´í„° êµ¬ì¡° ë³€ê²½ âŒ
 */

import { useQuery } from "@tanstack/react-query";
import { fetchSessionScoreSummary } from "@/features/sessions/api/sessionScoreSummary";
import { Section, Panel } from "@/shared/ui/ds";

export default function ScoresAnalyticsPanel({
  sessionId,
}: {
  sessionId: number;
}) {
  const { data, isLoading, isError } = useQuery({
    queryKey: ["session-score-summary", sessionId],
    queryFn: () => fetchSessionScoreSummary(sessionId),
  });

  return (
    <Section>
      <Panel>
        <div className="mb-4">
          <h3 className="text-base font-semibold">ì„±ì  ë¶„ì„</h3>
        </div>

        {/* Loading */}
        {isLoading && (
          <div className="text-sm text-muted">ë¶„ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
        )}

        {/* Error */}
        {isError && (
          <div className="text-sm text-red-500">
            ë¶„ì„ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.
          </div>
        )}

        {/* Content */}
        {!isLoading && !isError && data && (
          <div className="grid grid-cols-1 gap-4 md:grid-cols-3">
            <AnalyticsCard title="ì „ì²´" data={data.total} />
            <AnalyticsCard title="ì˜¤í”„ë¼ì¸" data={data.offline} />
            <AnalyticsCard title="ì˜¨ë¼ì¸" data={data.online} />
          </div>
        )}
      </Panel>
    </Section>
  );
}

/* ================================
   Card Block
================================ */

function AnalyticsCard({
  title,
  data,
}: {
  title: string;
  data: {
    count: number;
    avg: number;
  };
}) {
  return (
    <div className="card p-4">
      <div className="mb-3 text-sm font-semibold text-secondary">
        {title}
      </div>

      <div className="space-y-1 text-sm">
        <div className="flex justify-between">
          <span className="text-muted">ì‘ì‹œì</span>
          <span className="font-medium text-primary">{data.count}</span>
        </div>

        <div className="flex justify-between">
          <span className="text-muted">í‰ê· </span>
          <span className="font-medium text-primary">{data.avg}</span>
        </div>
      </div>
    </div>
  );
}


==========================================================================================
# FILE: panels/SessionScoresPanel.tsx
==========================================================================================
// PATH: src/features/scores/panels/SessionScoresPanel.tsx
// ì„±ì  í…Œì´ë¸” + ì‚¬ì´ë“œíŒ¨ë„ â€” students ë„ë©”ì¸ SSOT (Panel ì œê±°, í…Œì´ë¸” ìœ„ì£¼)

import { useEffect, useMemo, useState } from "react";
import { useQuery } from "@tanstack/react-query";

import {
  fetchSessionScores,
  type SessionScoreRow,
  type SessionScoreMeta,
} from "../api/sessionScores";
import { fetchAttendance } from "@/features/lectures/api/attendance";

import ScoresTable from "../components/ScoresTable";
import ScoreSidePanel from "./ScoreSidePanel";
import { EmptyState } from "@/shared/ui/ds";

type Props = {
  sessionId: number;
  search?: string;
};

export default function SessionScoresPanel({ sessionId, search = "" }: Props) {
  const { data, isLoading, isError } = useQuery({
    queryKey: ["session-scores", sessionId],
    queryFn: () => fetchSessionScores(sessionId),
    enabled: Number.isFinite(sessionId) && sessionId > 0,
  });

  const { data: attendanceList } = useQuery({
    queryKey: ["attendance", sessionId],
    queryFn: () => fetchAttendance(sessionId),
    enabled: Number.isFinite(sessionId) && sessionId > 0,
  });

  const allRows = useMemo<SessionScoreRow[]>(() => data?.rows ?? [], [data]);
  const meta: SessionScoreMeta | null = data?.meta ?? null;

  const attendanceMap = useMemo(() => {
    const raw = attendanceList;
    const list = Array.isArray(raw) ? raw : (raw as { results?: unknown[] })?.results ?? [];
    const map: Record<number, string> = {};
    for (const a of list) {
      const item = a as { enrollment_id?: number; enrollment?: number; status?: string };
      const eid = item?.enrollment_id ?? item?.enrollment;
      if (eid != null && item?.status) map[Number(eid)] = String(item.status);
    }
    return map;
  }, [attendanceList]);

  const rows = useMemo(() => {
    if (!search.trim()) return allRows;
    const q = search.trim().toLowerCase();
    return allRows.filter((r) => (r.student_name ?? "").toLowerCase().includes(q));
  }, [allRows, search]);

  const [selected, setSelected] = useState<SessionScoreRow | null>(null);
  const [currentExamId, setCurrentExamId] = useState<number | null>(null);
  const [currentHomeworkId, setCurrentHomeworkId] = useState<number | null>(null);
  const [activeColumn, setActiveColumn] = useState<"exam" | "homework">("exam");

  useEffect(() => {
    if (!rows.length) {
      setSelected(null);
      setCurrentExamId(null);
      setCurrentHomeworkId(null);
      return;
    }

    if (!selected) {
      const first = rows[0];
      setSelected(first);
      setCurrentExamId(first.exams?.[0]?.exam_id ?? null);
      setCurrentHomeworkId(first.homeworks?.[0]?.homework_id ?? null);
      return;
    }

    const next = rows.find((r) => r.enrollment_id === selected.enrollment_id);
    const resolved = next ?? rows[0];
    setSelected(resolved);

    if (
      currentExamId == null ||
      !resolved.exams.some((e) => e.exam_id === currentExamId)
    ) {
      setCurrentExamId(resolved.exams?.[0]?.exam_id ?? null);
    }

    if (
      currentHomeworkId == null ||
      !resolved.homeworks.some((h) => h.homework_id === currentHomeworkId)
    ) {
      setCurrentHomeworkId(resolved.homeworks?.[0]?.homework_id ?? null);
    }
  }, [rows, selected, currentExamId, currentHomeworkId]);

  if (isLoading) {
    return <EmptyState scope="panel" tone="loading" title="ì„±ì  ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦" />;
  }

  if (isError || !data) {
    return <EmptyState scope="panel" tone="error" title="ì„±ì  ë¡œë“œ ì‹¤íŒ¨" />;
  }

  if (rows.length === 0) {
    return (
      <EmptyState
        scope="panel"
        tone="empty"
        title={search.trim() ? "ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤" : "ë“±ë¡ëœ ìˆ˜ê°•ìƒì´ ì—†ìŠµë‹ˆë‹¤"}
        description={search.trim() ? "ë‹¤ë¥¸ ê²€ìƒ‰ì–´ë¡œ ì‹œë„í•´ ë³´ì„¸ìš”." : "ìˆ˜ê°•ìƒ ë“±ë¡ í›„ ì„±ì ì„ ì…ë ¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."}
      />
    );
  }

  return (
    <div className="flex gap-6">
      <div className="flex-1 min-w-0 overflow-x-auto">
        <ScoresTable
          rows={rows}
          meta={meta}
          sessionId={sessionId}
          attendanceMap={attendanceMap}
          selectedEnrollmentId={selected?.enrollment_id ?? null}
          selectedExamId={currentExamId}
          selectedHomeworkId={currentHomeworkId}
          onSelectCell={(row, type, id) => {
            setSelected(row);
            if (type === "exam") {
              setActiveColumn("exam");
              setCurrentExamId(id);
              if (currentHomeworkId == null && row.homeworks?.[0])
                setCurrentHomeworkId(row.homeworks[0].homework_id);
            } else {
              setActiveColumn("homework");
              setCurrentHomeworkId(id);
              if (currentExamId == null && row.exams?.[0])
                setCurrentExamId(row.exams[0].exam_id);
            }
          }}
          onSelectRow={setSelected}
        />
      </div>

      {selected && currentExamId != null && currentHomeworkId != null && meta && (
        <div className="w-[420px] shrink-0">
          <ScoreSidePanel
            sessionId={sessionId}
            examId={currentExamId}
            homeworkId={currentHomeworkId}
            row={selected}
            meta={meta}
            onClose={() => {}}
            activeColumn={activeColumn}
            onSelectExam={(id) => {
              setActiveColumn("exam");
              setCurrentExamId(id);
            }}
            onSelectHomework={(id) => {
              setActiveColumn("homework");
              setCurrentHomeworkId(id);
            }}
          />
        </div>
      )}
    </div>
  );
}


==========================================================================================
# FILE: utils/homeworkStatus.ts
==========================================================================================
// PATH: src/features/scores/utils/homeworkStatus.ts
/**
 * Homework Status SSOT (frontend)
 *
 * ìƒíƒœ íŒë³„ ê¸°ì¤€ (ë‹¨ì¼ í•¨ìˆ˜ ê³ ì •):
 * - score === null && meta.status == null â†’ ë¯¸ì…ë ¥
 * - meta.status === "NOT_SUBMITTED"       â†’ ë¯¸ì œì¶œ
 * - score === 0                           â†’ 0ì 
 * - score > 0                            â†’ ì •ìƒ ì ìˆ˜
 */

export type HomeworkMetaStatus = "NOT_SUBMITTED" | null | undefined;

export type HomeworkStatus =
  | "UNSET" // ë¯¸ì…ë ¥
  | "NOT_SUBMITTED" // ë¯¸ì œì¶œ
  | "ZERO" // 0ì 
  | "SCORED"; // ì •ìƒ ì ìˆ˜

export function getHomeworkStatus(params: {
  score: number | null | undefined;
  metaStatus: HomeworkMetaStatus;
}): HomeworkStatus {
  const score = params.score ?? null;
  const metaStatus = params.metaStatus ?? null;

  if (score === null && metaStatus == null) return "UNSET";
  if (metaStatus === "NOT_SUBMITTED") return "NOT_SUBMITTED";
  if (score === 0) return "ZERO";
  if (typeof score === "number" && Number.isFinite(score) && score > 0) return "SCORED";

  // defensive fallback (treat as UNSET)
  return "UNSET";
}

export function homeworkStatusLabel(status: HomeworkStatus): string {
  switch (status) {
    case "UNSET":
      return "ë¯¸ì…ë ¥";
    case "NOT_SUBMITTED":
      return "ë¯¸ì œì¶œ";
    case "ZERO":
      return "0ì ";
    case "SCORED":
      return "ì±„ì ";
    default:
      return "-";
  }
}
