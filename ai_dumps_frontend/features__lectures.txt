====================================================================================================
# FRONTEND FOLDER: features__lectures
# ROOT PATH: C:\academyfront\src\features\lectures
====================================================================================================


==========================================================================================
# FILE: LecturesRoutes.tsx
==========================================================================================



==========================================================================================
# FILE: api/attendance.ts
==========================================================================================
// PATH: src/features/lectures/api/attendance.ts
import api from "@/shared/api/axios";
import { pollJobUntilDone, downloadFromUrl } from "@/shared/api/jobExport";

/* =========================================================
 * 1️⃣ 세션 단위 출결 목록 조회 (SessionDetailPage)
 * GET /api/v1/lectures/attendance/?session={id}
 * ======================================================= */
export async function fetchAttendance(sessionId: number) {
  const res = await api.get("/lectures/attendance/", {
    params: { session: sessionId },
  });
  return Array.isArray(res.data) ? res.data : res.data.results;
}

/* =========================================================
 * 2️⃣ 출결 단건 수정 (상태 / 메모)
 * PATCH /api/v1/lectures/attendance/{id}/
 * ======================================================= */
export async function updateAttendance(
  id: number,
  payload: { status?: string; memo?: string }
) {
  const res = await api.patch(`/lectures/attendance/${id}/`, payload);
  return res.data;
}

/* =========================================================
 * 2-1 출결 단건 삭제 (차시에서 수강생 제외)
 * DELETE /api/v1/lectures/attendance/{id}/
 * ======================================================= */
export async function deleteAttendance(id: number) {
  await api.delete(`/lectures/attendance/${id}/`);
}

/* =========================================================
 * 3️⃣ 세션 기준 학생 등록
 * POST /api/v1/lectures/attendance/bulk_create/
 * ======================================================= */
export async function bulkCreateAttendance(
  sessionId: number,
  studentIds: number[]
) {
  if (!Array.isArray(studentIds) || studentIds.length === 0) {
    throw new Error("students 배열이 비어있습니다.");
  }

  const res = await api.post("/lectures/attendance/bulk_create/", {
    session: sessionId,
    students: studentIds,
  });
  return res.data;
}

/* =========================================================
 * 4️⃣ 강의 × 차시 출결 매트릭스
 * GET /api/v1/lectures/attendance/matrix/?lecture={id}
 * ======================================================= */

/** 강의 출결 매트릭스 응답 (세션에 등록된 수강생 + 차시별 출결) */
export type AttendanceMatrixSession = {
  id: number;
  order: number | null;
  date: string | null;
};

export type AttendanceMatrixStudent = {
  student_id: number;
  name: string;
  phone: string | null;
  parent_phone: string | null;
  /** session_id 문자열 키 → { attendance_id, status } */
  attendance: Record<string, { attendance_id: number; status: string }>;
};

export type AttendanceMatrixResponse = {
  lecture: { id: number; title: string; color?: string };
  sessions: AttendanceMatrixSession[];
  students: AttendanceMatrixStudent[];
};

export async function fetchAttendanceMatrix(
  lectureId: number
): Promise<AttendanceMatrixResponse> {
  const res = await api.get("/lectures/attendance/matrix/", {
    params: { lecture: lectureId },
  });
  return res.data;
}

/* =========================================================
 * 5️⃣ 출결 엑셀 내보내기 (비동기 job → 폴링 후 다운로드)
 * POST /lectures/attendance/excel/ → job_id → GET /jobs/<id>/ 폴링 → download_url
 * ======================================================= */
export async function downloadAttendanceExcel(lectureId: number): Promise<void> {
  const res = await api.post<{ job_id: string; status: string }>(
    "/lectures/attendance/excel/",
    { lecture_id: lectureId }
  );
  const jobId = res.data?.job_id;
  if (!jobId) throw new Error("Export job could not be started.");

  const data = await pollJobUntilDone(jobId);
  const url = data.result?.download_url;
  const filename = data.result?.filename;
  if (!url) throw new Error("Export completed but no download link.");
  downloadFromUrl(url, filename || "attendance.xlsx");
}


==========================================================================================
# FILE: api/board.ts
==========================================================================================
// PATH: src/features/lectures/api/board.ts
// 강의별 게시판 — community SSOT API 사용
// GET /api/v1/community/scope-nodes, block-types, posts

import {
  fetchScopeNodes,
  fetchBlockTypes,
  fetchPosts,
  createPost,
  type BlockType,
  type PostEntity,
} from "@/features/community/api/community.api";

/* =========================
 * TYPES (community 호환)
 * ========================= */
export type BoardCategory = BlockType;

export interface BoardAttachment {
  id: number;
  post: number;
  file: string;
}

export interface BoardPost {
  id: number;
  lecture: number;
  category: number;
  title: string;
  content: string;
  created_by: number | null;
  created_at: string;
  attachments: BoardAttachment[];
}

export interface BoardReadStatus {
  id: number;
  post: number;
  enrollment: number;
  checked_at: string;
  student_name?: string;
}

function postEntityToBoardPost(p: PostEntity): BoardPost {
  const firstNode = p.mappings?.[0]?.node_detail;
  return {
    id: p.id,
    lecture: firstNode?.lecture ?? 0,
    category: p.block_type,
    title: p.title,
    content: p.content,
    created_by: p.created_by ?? null,
    created_at: p.created_at,
    attachments: [],
  };
}

/* =========================
 * CATEGORY → block-types (읽기 전용)
 * ========================= */
export async function fetchBoardCategories(_lectureId: number): Promise<BoardCategory[]> {
  return fetchBlockTypes();
}

export async function createBoardCategory(_payload: {
  lecture: number;
  name: string;
}): Promise<BoardCategory> {
  throw new Error("블록 타입은 읽기 전용입니다.");
}

/* =========================
 * POSTS → scope-nodes + posts
 * ========================= */
export async function fetchBoardPosts(params: {
  lecture: number;
  category?: number;
}): Promise<BoardPost[]> {
  const nodes = await fetchScopeNodes();
  const courseNode = nodes.find(
    (n) => n.lecture === params.lecture && n.session == null
  );
  if (!courseNode) return [];
  const list = await fetchPosts({ nodeId: courseNode.id });
  const filtered =
    params.category != null
      ? list.filter((p) => p.block_type === params.category)
      : list;
  return filtered.map(postEntityToBoardPost);
}

export async function createBoardPost(data: {
  block_type: number;
  title: string;
  content: string;
  node_ids: number[];
}): Promise<BoardPost> {
  const post = await createPost({
    block_type: data.block_type,
    title: data.title,
    content: data.content,
    node_ids: data.node_ids,
  });
  return postEntityToBoardPost(post);
}

/** 강의 COURSE 노드 1개 id. 글 작성 시 node_ids에 사용 */
export async function getCourseNodeIdForLecture(lectureId: number): Promise<number | null> {
  const nodes = await fetchScopeNodes();
  const n = nodes.find((x) => x.lecture === lectureId && x.session == null);
  return n?.id ?? null;
}

/* =========================
 * READ STATUS (미제공 — 스텁)
 * ========================= */
export async function fetchBoardReadStatus(_postId: number): Promise<BoardReadStatus[]> {
  return [];
}


==========================================================================================
# FILE: api/ddays.ts
==========================================================================================
// PATH: src/features/lectures/api/ddays.ts
/**
 * ⚠️ D-DAY API
 * - 현재 backend 미구현
 * - 프론트 UI 유지용 stub
 */

export interface Dday {
  id: number;
  lecture: number;
  title: string;
  date: string;
  created_at: string;
}

export async function fetchDdays(_: number): Promise<Dday[]> {
  return [];
}

export async function createDday(_: {
  lecture: number;
  title: string;
  date: string;
}): Promise<Dday> {
  throw new Error("D-Day API not implemented");
}

export async function deleteDday(_: number): Promise<void> {
  throw new Error("D-Day API not implemented");
}


==========================================================================================
# FILE: api/enrollments.ts
==========================================================================================
// PATH: src/features/lectures/api/enrollments.ts
import api from "@/shared/api/axios";

export async function fetchLectureEnrollments(lectureId: number) {
  const res = await api.get("/enrollments/", {
    params: { lecture: lectureId },
  });
  const data = res.data;
  if (Array.isArray(data)) return data;
  if (data?.results && Array.isArray(data.results)) return data.results;
  if (data?.data && Array.isArray(data.data)) return data.data;
  return [];
}

export async function bulkCreateEnrollments(
  lectureId: number,
  studentIds: number[]
) {
  const res = await api.post("/enrollments/bulk_create/", {
    lecture: lectureId,
    students: studentIds,
  });
  return res.data;
}

/**
 * 강의/차시 엑셀 수강등록 — 워커 전담. 기존·신규 동일 로직.
 * API는 파일 수신 → R2 업로드 → SQS job 등록만 하며, 파싱·등록은 워커에서 수행.
 * sessionId 있으면 해당 차시에만 등록, 없으면 1차시 생성·등록.
 */
export async function lectureEnrollFromExcelUpload(
  lectureId: number,
  file: File,
  initialPassword: string,
  options?: { sessionId?: number }
) {
  const form = new FormData();
  form.append("file", file);
  form.append("lecture_id", String(lectureId));
  form.append("initial_password", initialPassword);
  if (options?.sessionId != null) {
    form.append("session_id", String(options.sessionId));
  }
  const res = await api.post("/enrollments/lecture_enroll_from_excel/", form, {
    headers: { "Content-Type": undefined } as Record<string, unknown>,
  });
  return res.data as { job_id: string; status: string };
}

/** 엑셀 수강등록 job 상태 (폴링용) */
export type ExcelEnrollJobStatus = {
  job_id: string;
  status: string;
  result?: {
    enrolled_count: number;
    created_students_count?: number;
    session_id?: number;
    processed_by?: string;
  };
  error_message?: string | null;
  progress?: { step?: string; percent?: number } | null;
};

export async function getExcelEnrollJobStatus(
  jobId: string
): Promise<ExcelEnrollJobStatus> {
  const res = await api.get(
    `/enrollments/excel_job_status/${encodeURIComponent(jobId)}/`
  );
  return res.data as ExcelEnrollJobStatus;
}

// ========== 차시(세션) 수강생 (SessionEnrollment) ==========

export type SessionEnrollmentRow = {
  id: number;
  session: number;
  enrollment: number;
  student_id?: number;
  student_name: string;
  created_at?: string;
};

/** 해당 차시에 등록된 수강생 목록 */
export async function fetchSessionEnrollments(
  sessionId: number
): Promise<SessionEnrollmentRow[]> {
  const res = await api.get("/enrollments/session-enrollments/", {
    params: { session: sessionId },
  });
  const list = Array.isArray(res.data) ? res.data : res.data?.results ?? [];
  return list;
}

/** 차시에 수강생(Enrollment) 일괄 등록 */
export async function bulkCreateSessionEnrollments(
  sessionId: number,
  enrollmentIds: number[]
) {
  const res = await api.post("/enrollments/session-enrollments/bulk_create/", {
    session: sessionId,
    enrollments: enrollmentIds,
  });
  return res.data;
}


==========================================================================================
# FILE: api/materials.ts
==========================================================================================
// PATH: src/features/lectures/api/materials.ts
// SSOT: 백엔드 api/v1 에 /interactions 경로가 없음. 추후 백엔드에 material-categories 추가 시 경로 일치시킬 것.
import api from "@/shared/api/axios";

const PREFIX = "/interactions";

/* =========================
 * TYPES
 * ========================= */
export interface MaterialCategory {
  id: number;
  lecture: number;
  name: string;
  order: number;
}

export interface Material {
  id: number;
  lecture: number;
  category: number | null;
  title: string;
  description: string;
  file: string | null;
  url: string | null;
  order: number;
  is_public: boolean;
  uploader_name?: string | null;
  created_at: string;
}

/* =========================
 * UTILS
 * ========================= */
function unwrap<T>(data: any): T[] {
  if (Array.isArray(data)) return data;
  if (Array.isArray(data?.results)) return data.results;
  return [];
}

/* =========================
 * CATEGORY
 * ========================= */
export async function fetchMaterialCategories(
  lectureId: number
): Promise<MaterialCategory[]> {
  const res = await api.get(`${PREFIX}/material-categories/`, {
    params: { lecture: lectureId },
  });
  return unwrap<MaterialCategory>(res.data);
}

export async function createMaterialCategory(payload: {
  lecture: number;
  name: string;
}): Promise<MaterialCategory> {
  const res = await api.post(`${PREFIX}/material-categories/`, payload);
  return res.data;
}

/* =========================
 * MATERIAL
 * ========================= */
export async function fetchMaterials(params: {
  lecture: number;
  category?: number;
}): Promise<Material[]> {
  const res = await api.get(`${PREFIX}/materials/`, { params });
  return unwrap<Material>(res.data);
}

export async function createMaterial(formData: FormData): Promise<Material> {
  const res = await api.post(`${PREFIX}/materials/`, formData, {
    headers: { "Content-Type": "multipart/form-data" },
  });
  return res.data;
}


==========================================================================================
# FILE: api/report.ts
==========================================================================================
// PATH: src/features/lectures/api/report.ts
import api from "@/shared/api/axios";

export interface LectureReportStudent {
  enrollment: number;
  student_id: number;
  student_name: string;
  avg_progress: number;
  completed_videos: number;
  total_videos: number;
  last_attendance_status: string | null;
}

export interface LectureReportSummary {
  total_students: number;
  total_sessions: number;
  total_videos: number;
  avg_video_progress: number;
  completed_students: number;
}

export interface LectureReportResponse {
  lecture: {
    id: number;
    title: string;
    name: string;
    subject: string;
  };
  summary: LectureReportSummary;
  attendance_by_status: Record<string, number>;
  students: LectureReportStudent[];
}

/**
 * ✅ FIX
 * ❌ /lectures/{id}/report/
 * ✅ /lectures/lectures/{id}/report/
 */
export async function fetchLectureReport(
  lectureId: number
): Promise<LectureReportResponse> {
  const res = await api.get(`/lectures/lectures/${lectureId}/report/`);
  return res.data;
}


==========================================================================================
# FILE: api/sessions.ts
==========================================================================================
// PATH: src/features/lectures/api/sessions.ts
import api from "@/shared/api/axios";

// ----------------------------------------
// TYPES
// ----------------------------------------
export interface Lecture {
  id: number;
  title: string;
  name: string;
  subject: string;
  description?: string;
  start_date?: string | null;
  end_date?: string | null;
  lecture_time?: string | null;
  color?: string | null;
  is_active: boolean;
  tenant: number;
  created_at: string;
  updated_at: string;
}

export interface Session {
  id: number;
  lecture: number;
  order: number;
  title: string;
  date?: string | null;
  created_at: string;
  updated_at: string;
}

// ----------------------------------------
// LECTURE 목록 가져오기
// ----------------------------------------
export async function fetchLectures(params?: {
  is_active?: boolean;
  subject?: string;
  search?: string;
}): Promise<Lecture[]> {
  const res = await api.get("/lectures/lectures/", { params });
  const data = res.data;
  return Array.isArray(data?.results) ? data.results : Array.isArray(data) ? data : [];
}

// ----------------------------------------
// 강의 담당자 선택지 (오너 + 강사)
// ----------------------------------------
export type LectureInstructorOption = { name: string; type: "owner" | "teacher" };

export async function fetchLectureInstructorOptions(): Promise<LectureInstructorOption[]> {
  const res = await api.get("/lectures/lectures/instructor-options/");
  return Array.isArray(res.data) ? res.data : [];
}

// ----------------------------------------
// LECTURE 상세 가져오기
// ----------------------------------------
export async function fetchLecture(lectureId: number): Promise<Lecture> {
  const res = await api.get(`/lectures/lectures/${lectureId}/`);
  return res.data;
}

// ----------------------------------------
// LECTURE 생성
// ----------------------------------------
export async function createLecture(payload: {
  title: string;
  name: string;
  subject: string;
  description?: string;
  start_date?: string | null;
  end_date?: string | null;
  lecture_time?: string | null;
  color?: string | null;
  is_active?: boolean;
}): Promise<Lecture> {
  const res = await api.post("/lectures/lectures/", payload);
  return res.data;
}

// ----------------------------------------
// LECTURE 수정
// ----------------------------------------
export async function updateLecture(
  lectureId: number,
  payload: Partial<Omit<Lecture, "id" | "tenant" | "created_at" | "updated_at">>
): Promise<Lecture> {
  const res = await api.patch(`/lectures/lectures/${lectureId}/`, payload);
  return res.data;
}

// ----------------------------------------
// LECTURE 삭제
// ----------------------------------------
export async function deleteLecture(lectureId: number): Promise<void> {
  await api.delete(`/lectures/lectures/${lectureId}/`);
}

// ----------------------------------------
// SESSION 상세 가져오기
// ----------------------------------------
export async function fetchSession(sessionId: number): Promise<Session> {
  const res = await api.get(`/lectures/sessions/${sessionId}/`);
  return res.data;
}

// ----------------------------------------
// SESSION 목록 정렬 — 블록/테이블 표시용 SSOT
// ----------------------------------------
/** 차시 블록 배치: 블록 내부 날짜 기준 내림차순(최신→과거). 정규·보강 섞어서. 날짜 없으면 맨 뒤 */
export function sortSessionsByDateDesc<T extends { date?: string | null }>(sessions: T[]): T[] {
  return [...sessions].sort((a, b) => {
    const da = a.date || "";
    const db = b.date || "";
    if (!da) return 1;
    if (!db) return -1;
    return db.localeCompare(da);
  });
}

// ----------------------------------------
// SESSION 목록 가져오기 (lecture 기준)
// ----------------------------------------
export async function fetchSessions(lectureId: number): Promise<Session[]> {
  const res = await api.get(`/lectures/sessions/?lecture=${lectureId}`);
  const data = res.data;
  return Array.isArray(data?.results) ? data.results : Array.isArray(data) ? data : [];
}

// ----------------------------------------
// SESSION 생성
// ----------------------------------------
export async function createSession(
  lectureId: number,
  title: string,
  date?: string | null,
  order?: number | null
): Promise<Session> {
  const payload: {
    lecture: number;
    title: string;
    date?: string | null;
    order?: number | null;
  } = {
    lecture: lectureId,
    title,
  };
  
  if (date !== undefined) payload.date = date;
  if (order !== undefined) payload.order = order;

  const res = await api.post(`/lectures/sessions/`, payload);
  return res.data;
}

// ----------------------------------------
// SESSION 수정
// ----------------------------------------
export async function updateSession(
  sessionId: number,
  payload: Partial<Pick<Session, "title" | "date" | "order">>
): Promise<Session> {
  const res = await api.patch(`/lectures/sessions/${sessionId}/`, payload);
  return res.data;
}

// ----------------------------------------
// SESSION 삭제
// ----------------------------------------
export async function deleteSession(sessionId: number): Promise<void> {
  await api.delete(`/lectures/sessions/${sessionId}/`);
}

/**
 * ⚠️ ATTENDANCE는 여기서 조회하지 않는다.
 * - 경로 혼재(attendance vs attendances)로 404 폭탄 방지
 * - 출결 조회/수정/일괄등록은 반드시 `api/attendance.ts`만 사용
 */
// export async function fetchAttendance(sessionId: number) { ... }  // ❌ 제거


==========================================================================================
# FILE: api/students.ts
==========================================================================================
// PATH: src/features/lectures/api/students.ts
import api from "@/shared/api/axios";

/**
 * 수강 학생 (Lecture → Enrollment → Student)
 * 백엔드 기준:
 * - Enrollment 도메인을 통해 Lecture-Student 관계가 형성됨
 * - GET /api/v1/enrollments/?lecture={lectureId}
 */

export type LectureStudent = {
  id: number; // Student ID
  name: string;
  grade: number | null;
  school: string | null;
  status: string; // enrollment.status (raw)
  status_label: string; // enrollment.status_display (serializer 기반)
};

export async function fetchLectureStudents(lectureId: number): Promise<LectureStudent[]> {
  const res = await api.get("/enrollments/", {
    params: {
      lecture: lectureId,
    },
  });

  const list = Array.isArray(res.data?.results)
    ? res.data.results
    : Array.isArray(res.data)
    ? res.data
    : [];

  return list.map((enrollment: any) => ({
    id: enrollment.student.id,
    name: enrollment.student.name,
    grade: enrollment.student.grade ?? null,
    school: enrollment.student.high_school ?? enrollment.student.middle_school ?? null,
    status: enrollment.status,
    status_label:
      enrollment.status_label ?? enrollment.status_display ?? enrollment.status,
  }));
}


==========================================================================================
# FILE: components/BoardCategoryModal.tsx
==========================================================================================
// src/features/lectures/components/BoardCategoryModal.tsx
import { useEffect, useMemo, useState } from "react";
import { useMutation, useQueryClient } from "@tanstack/react-query";
import { createBoardCategory } from "../api/board";
import { AdminModal, ModalBody, ModalFooter, ModalHeader } from "@/shared/ui/modal";
import { Button } from "@/shared/ui/ds";

interface Props {
  lectureId: number;
  isOpen: boolean;
  onClose: () => void;
}

export default function BoardCategoryModal({ lectureId, isOpen, onClose }: Props) {
  const qc = useQueryClient();
  const [name, setName] = useState("");
  const [busy, setBusy] = useState(false);

  const title = useMemo(() => "게시판 카테고리 추가", []);

  const { mutate } = useMutation({
    mutationFn: async () => {
      setBusy(true);
      try {
        return await createBoardCategory({ lecture: lectureId, name });
      } finally {
        setBusy(false);
      }
    },
    onSuccess: () => {
      qc.invalidateQueries({ queryKey: ["board-categories", lectureId] });
      onClose();
    },
  });

  useEffect(() => {
    if (!isOpen) return;
    function onKeyDown(e: KeyboardEvent) {
      if (e.key === "Escape") onClose();
      if ((e.ctrlKey || e.metaKey) && e.key === "Enter") {
        if (!busy && name.trim()) mutate();
      }
    }
    window.addEventListener("keydown", onKeyDown);
    return () => window.removeEventListener("keydown", onKeyDown);
  }, [isOpen, busy, name]);

  if (!isOpen) return null;

  return (
    <AdminModal open={true} onClose={onClose} type="action" width={560}>
      <ModalHeader type="action" title={title} description="⌘/Ctrl + Enter 저장" />
      <ModalBody>
        <input
          className="ds-input"
          value={name}
          onChange={(e) => setName(e.target.value)}
          disabled={busy}
          autoFocus
        />
      </ModalBody>
      <ModalFooter
        right={
          <>
            <Button intent="secondary" onClick={onClose}>취소</Button>
            <Button intent="primary" onClick={() => name.trim() && mutate()} disabled={!name.trim() || busy}>
              추가
            </Button>
          </>
        }
      />
    </AdminModal>
  );
}


==========================================================================================
# FILE: components/BoardPostDetail.tsx
==========================================================================================
// PATH: src/features/lectures/components/BoardPostDetail.tsx
import { useEffect, useMemo } from "react";
import { useQuery } from "@tanstack/react-query";
import { BoardPost, fetchBoardReadStatus } from "../api/board";
import { fetchLectureEnrollments } from "../api/enrollments";

import { AdminModal, ModalBody, ModalFooter, ModalHeader } from "@/shared/ui/modal";
import { Button, EmptyState } from "@/shared/ui/ds";

interface Props {
  lectureId: number;
  post: BoardPost;
  onClose: () => void;
}

export default function BoardPostDetail({ lectureId, post, onClose }: Props) {
  const { data: readStatus } = useQuery({
    queryKey: ["board-read-status", post.id],
    queryFn: () => fetchBoardReadStatus(post.id),
  });

  const { data: enrollments } = useQuery({
    queryKey: ["lecture-enrollments", lectureId],
    queryFn: () => fetchLectureEnrollments(lectureId),
  });

  useEffect(() => {
    function onKeyDown(e: KeyboardEvent) {
      if (e.key === "Escape") onClose();
    }
    window.addEventListener("keydown", onKeyDown);
    return () => window.removeEventListener("keydown", onKeyDown);
  }, [onClose]);

  const readMap = useMemo(() => {
    const m = new Map<number, string>();
    readStatus?.forEach((r) => m.set(r.enrollment, r.checked_at));
    return m;
  }, [readStatus]);

  const headerDesc = `작성일 ${post.created_at?.slice(0, 10) ?? "-"}`;

  return (
    <AdminModal open={true} onClose={onClose} type="inspect" width={1180}>
      <ModalHeader type="inspect" title={post.title} description={headerDesc} />

      <ModalBody>
        <div style={{ display: "grid", gridTemplateColumns: "1fr 280px", gap: 16 }}>
          {/* LEFT */}
          <div
            style={{
              borderRadius: "var(--radius-xl)",
              border: "1px solid var(--color-border-divider)",
              background: "var(--color-bg-surface)",
              padding: 16,
              minHeight: 360,
            }}
          >
            <div
              style={{
                whiteSpace: "pre-wrap",
                fontSize: 13,
                fontWeight: 850,
                color: "var(--color-text-primary)",
                lineHeight: 1.65,
              }}
            >
              {post.content}
            </div>

            {post.attachments?.length > 0 && (
              <div style={{ marginTop: 18 }}>
                <div
                  style={{
                    fontSize: 12,
                    fontWeight: 900,
                    color: "var(--color-text-secondary)",
                    marginBottom: 8,
                  }}
                >
                  첨부 파일
                </div>

                <div
                  style={{
                    borderRadius: 14,
                    border: "1px solid var(--color-border-divider)",
                    background: "var(--color-bg-surface-soft)",
                    padding: 12,
                    display: "grid",
                    gap: 6,
                  }}
                >
                  {post.attachments.map((a) => {
                    const name = a.file?.split("/").slice(-1)[0] ?? "파일";
                    return (
                      <a
                        key={a.id}
                        href={a.file}
                        target="_blank"
                        rel="noreferrer"
                        style={{
                          color: "var(--color-primary)",
                          fontWeight: 900,
                          fontSize: 12,
                        }}
                      >
                        {name}
                      </a>
                    );
                  })}
                </div>
              </div>
            )}
          </div>

          {/* RIGHT */}
          <div
            style={{
              borderRadius: "var(--radius-xl)",
              border: "1px solid var(--color-border-divider)",
              background: "var(--color-bg-surface)",
              padding: 14,
              overflow: "hidden",
            }}
          >
            <div style={{ display: "flex", alignItems: "baseline", justifyContent: "space-between" }}>
              <div style={{ fontSize: 12, fontWeight: 900, color: "var(--color-text-secondary)" }}>
                확인 현황
              </div>
              <div style={{ fontSize: 11, fontWeight: 850, color: "var(--color-text-muted)" }}>
                {readStatus?.length ?? 0}명 확인
              </div>
            </div>

            <div style={{ marginTop: 10, maxHeight: 420, overflow: "auto" }}>
              {!enrollments?.length ? (
                <EmptyState mode="embedded" scope="panel" title="수강생이 없습니다." />
              ) : (
                <div style={{ display: "grid", gap: 6 }}>
                  {enrollments.map((en: any) => {
                    const name = en.student_name || en.student?.name || "이름 없음";
                    const checkedAt = readMap.get(en.id);
                    const checked = !!checkedAt;

                    return (
                      <div
                        key={en.id}
                        style={{
                          display: "flex",
                          alignItems: "center",
                          justifyContent: "space-between",
                          gap: 10,
                          padding: "8px 10px",
                          borderRadius: 12,
                          border: "1px solid var(--color-border-divider)",
                          background: "var(--color-bg-surface-soft)",
                        }}
                      >
                        <div
                          style={{
                            minWidth: 0,
                            fontSize: 12,
                            fontWeight: 900,
                            color: "var(--color-text-primary)",
                            whiteSpace: "nowrap",
                            overflow: "hidden",
                            textOverflow: "ellipsis",
                          }}
                        >
                          {name}
                        </div>

                        <div
                          style={{
                            flex: "0 0 auto",
                            padding: "4px 8px",
                            borderRadius: 999,
                            fontSize: 11,
                            fontWeight: 900,
                            border: "1px solid var(--color-border-divider)",
                            background: checked
                              ? "color-mix(in srgb, var(--color-primary) 10%, var(--color-bg-surface))"
                              : "var(--color-bg-surface)",
                            color: checked ? "var(--color-primary)" : "var(--color-text-muted)",
                          }}
                        >
                          {checked ? checkedAt!.slice(5, 16) : "미확인"}
                        </div>
                      </div>
                    );
                  })}
                </div>
              )}
            </div>
          </div>
        </div>
      </ModalBody>

      <ModalFooter
        left={
          <span style={{ fontSize: 12, fontWeight: 850, color: "var(--color-text-muted)" }}>
            ESC 로 닫기
          </span>
        }
        right={
          <Button intent="secondary" onClick={onClose}>
            닫기
          </Button>
        }
      />
    </AdminModal>
  );
}


==========================================================================================
# FILE: components/BoardPostModal.tsx
==========================================================================================
// PATH: src/features/lectures/components/BoardPostModal.tsx
import { useEffect, useMemo, useState } from "react";
import { useMutation, useQueryClient } from "@tanstack/react-query";
import { BoardCategory, createBoardPost, getCourseNodeIdForLecture } from "../api/board";
import { createPostTemplate, type PostTemplate } from "@/features/community/api/community.api";

import { AdminModal, ModalBody, ModalFooter, ModalHeader } from "@/shared/ui/modal";
import { Button } from "@/shared/ui/ds";

interface Props {
  lectureId: number;
  category: BoardCategory;
  templates?: PostTemplate[];
  onClose: () => void;
}

export default function BoardPostModal({ lectureId, category, templates = [], onClose }: Props) {
  const qc = useQueryClient();

  const [titleInput, setTitleInput] = useState("");
  const [content, setContent] = useState("");
  const [busy, setBusy] = useState(false);
  const [showSaveAsTemplate, setShowSaveAsTemplate] = useState(false);
  const [templateName, setTemplateName] = useState("");

  const loadTemplate = (t: PostTemplate) => {
    setTitleInput(t.title ?? "");
    setContent(t.content ?? "");
  };

  const saveAsTemplateMut = useMutation({
    mutationFn: () =>
      createPostTemplate({
        name: templateName.trim(),
        block_type: category.id,
        title: titleInput.trim() || undefined,
        content: content.trim() || undefined,
      }),
    onSuccess: () => {
      qc.invalidateQueries({ queryKey: ["community-post-templates"] });
      setShowSaveAsTemplate(false);
      setTemplateName("");
    },
  });

  const title = useMemo(
    () => `${"label" in category ? category.label : (category as { name?: string }).name ?? "글"} - 글 작성`,
    [category]
  );

  const { mutate } = useMutation({
    mutationFn: async () => {
      setBusy(true);
      try {
        const nodeId = await getCourseNodeIdForLecture(lectureId);
        if (nodeId == null) throw new Error("이 강의에 대한 노드를 찾을 수 없습니다.");
        return await createBoardPost({
          block_type: category.id,
          title: titleInput.trim(),
          content: content.trim(),
          node_ids: [nodeId],
        });
      } finally {
        setBusy(false);
      }
    },
    onSuccess: () => {
      qc.invalidateQueries({ queryKey: ["board-posts", lectureId, category.id] });
      onClose();
    },
  });

  useEffect(() => {
    function onKeyDown(e: KeyboardEvent) {
      if (e.key === "Escape") onClose();
      if ((e.ctrlKey || e.metaKey) && e.key === "Enter") {
        if (!busy && titleInput.trim()) mutate();
      }
    }
    window.addEventListener("keydown", onKeyDown);
    return () => window.removeEventListener("keydown", onKeyDown);
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [busy, titleInput, content]);

  return (
    <AdminModal open={true} onClose={onClose} type="action" width={980}>
      <ModalHeader type="action" title={title} description="⌘/Ctrl + Enter 로 등록" />

      <ModalBody>
        <div style={{ display: "grid", gap: 12 }}>
          {templates.length > 0 && (
            <div style={{ display: "grid", gap: 8 }}>
              <div style={{ fontSize: 12, fontWeight: 900, color: "var(--color-text-secondary)" }}>
                양식에서 불러오기
              </div>
              <select
                className="ds-input"
                value=""
                onChange={(e) => {
                  const id = e.target.value ? Number(e.target.value) : 0;
                  const t = templates.find((x) => x.id === id);
                  if (t) loadTemplate(t);
                  e.target.value = "";
                }}
              >
                <option value="">선택하세요</option>
                {templates.map((t) => (
                  <option key={t.id} value={t.id}>
                    {t.name}
                    {t.block_type_label ? ` (${t.block_type_label})` : ""}
                  </option>
                ))}
              </select>
            </div>
          )}
          <div style={{ display: "grid", gap: 8 }}>
            <div style={{ fontSize: 12, fontWeight: 900, color: "var(--color-text-secondary)" }}>
              제목
            </div>
            <input
              className="ds-input"
              value={titleInput}
              onChange={(e) => setTitleInput(e.target.value)}
              disabled={busy}
              data-invalid={!titleInput.trim() ? "true" : "false"}
              autoFocus
            />
          </div>

          <div style={{ display: "grid", gap: 8 }}>
            <div style={{ fontSize: 12, fontWeight: 900, color: "var(--color-text-secondary)" }}>
              내용
            </div>
            <textarea
              className="ds-textarea"
              rows={14}
              style={{ resize: "none" }}
              value={content}
              onChange={(e) => setContent(e.target.value)}
              disabled={busy}
            />
          </div>

          {/* 첨부파일은 community API 미지원 — 추후 확장 시 추가 */}
        </div>
      </ModalBody>

      <ModalFooter
        left={
          <div className="flex items-center gap-2">
            {(titleInput.trim() || content.trim()) && (
              <Button
                intent="ghost"
                size="sm"
                onClick={() => setShowSaveAsTemplate(true)}
              >
                현재 내용을 양식으로 저장
              </Button>
            )}
            <span style={{ fontSize: 12, fontWeight: 850, color: "var(--color-text-muted)" }}>
              ESC 로 닫기 · ⌘/Ctrl + Enter 등록
            </span>
          </div>
        }
        right={
          <>
            <Button intent="secondary" onClick={onClose} disabled={busy}>
              취소
            </Button>
            <Button
              intent="primary"
              onClick={() => {
                if (!titleInput.trim()) return;
                mutate();
              }}
              disabled={busy || !titleInput.trim()}
            >
              {busy ? "저장 중…" : "등록"}
            </Button>
          </>
        }
      />

      {showSaveAsTemplate && (
        <div
          role="dialog"
          aria-modal="true"
          style={{
            position: "fixed",
            inset: 0,
            background: "rgba(0,0,0,0.35)",
            display: "flex",
            alignItems: "center",
            justifyContent: "center",
            zIndex: 1001,
          }}
          onClick={() => !saveAsTemplateMut.isPending && setShowSaveAsTemplate(false)}
        >
          <div
            style={{
              background: "var(--color-bg-surface)",
              borderRadius: "var(--radius-lg)",
              padding: "var(--space-5)",
              minWidth: 320,
              boxShadow: "var(--elevation-3)",
            }}
            onClick={(e) => e.stopPropagation()}
          >
            <h4 style={{ marginBottom: 12, fontSize: 16, fontWeight: 700 }}>양식으로 저장</h4>
            <input
              className="ds-input"
              value={templateName}
              onChange={(e) => setTemplateName(e.target.value)}
              placeholder="양식 이름 (예: 중간고사 공지)"
              style={{ width: "100%", marginBottom: 16 }}
              disabled={saveAsTemplateMut.isPending}
            />
            <div className="flex gap-2 justify-end">
              <Button
                intent="secondary"
                size="sm"
                onClick={() => setShowSaveAsTemplate(false)}
                disabled={saveAsTemplateMut.isPending}
              >
                취소
              </Button>
              <Button
                intent="primary"
                size="sm"
                onClick={() => templateName.trim() && saveAsTemplateMut.mutate()}
                disabled={!templateName.trim() || saveAsTemplateMut.isPending}
              >
                {saveAsTemplateMut.isPending ? "저장 중…" : "저장"}
              </Button>
            </div>
          </div>
        </div>
      )}
    </AdminModal>
  );
}


==========================================================================================
# FILE: components/DdayModal.tsx
==========================================================================================
// PATH: src/features/lectures/components/DdayModal.tsx
import { useEffect, useMemo, useState } from "react";
import { useMutation, useQueryClient } from "@tanstack/react-query";
import { createDday } from "../api/ddays";

import { AdminModal, ModalBody, ModalFooter, ModalHeader } from "@/shared/ui/modal";
import { Button } from "@/shared/ui/ds";
import { DatePicker } from "@/shared/ui/date";

interface Props {
  lectureId: number;
  onClose: () => void;
}

export default function DdayModal({ lectureId, onClose }: Props) {
  const qc = useQueryClient();

  const [titleInput, setTitleInput] = useState("");
  const [date, setDate] = useState<string>("");
  const [time, setTime] = useState<string>("12:00");
  const [busy, setBusy] = useState(false);

  const title = useMemo(() => "D-Day 추가", []);

  const { mutate } = useMutation({
    mutationFn: async () => {
      setBusy(true);
      try {
        const iso = date && time ? `${date}T${time}:00` : `${date}T00:00:00`;
        return await createDday({ lecture: lectureId, title: titleInput, date: iso });
      } finally {
        setBusy(false);
      }
    },
    onSuccess: () => {
      qc.invalidateQueries({ queryKey: ["ddays", lectureId] });
      onClose();
    },
  });

  useEffect(() => {
    function onKeyDown(e: KeyboardEvent) {
      if (e.key === "Escape") onClose();
      if ((e.ctrlKey || e.metaKey) && e.key === "Enter") {
        if (!busy && titleInput.trim() && date) mutate();
      }
    }
    window.addEventListener("keydown", onKeyDown);
    return () => window.removeEventListener("keydown", onKeyDown);
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [busy, titleInput, date, time]);

  return (
    <AdminModal open={true} onClose={onClose} type="action" width={720}>
      <ModalHeader type="action" title={title} description="⌘/Ctrl + Enter 로 저장" />

      <ModalBody>
        <div style={{ display: "grid", gap: 12 }}>
          <input
            className="ds-input"
            placeholder="제목"
            value={titleInput}
            onChange={(e) => setTitleInput(e.target.value)}
            disabled={busy}
            data-invalid={!titleInput.trim() ? "true" : "false"}
            autoFocus
          />

          <div style={{ display: "grid", gridTemplateColumns: "1fr 180px", gap: 10 }}>
            <DatePicker
              value={date}
              onChange={setDate}
              placeholder="날짜 선택"
              disabled={busy}
            />
            <input
              type="time"
              className="ds-input"
              value={time}
              onChange={(e) => setTime(e.target.value)}
              disabled={busy}
            />
          </div>

          <div style={{ fontSize: 11, fontWeight: 850, color: "var(--color-text-muted)" }}>
            날짜는 필수입니다.
          </div>
        </div>
      </ModalBody>

      <ModalFooter
        left={
          <span style={{ fontSize: 12, fontWeight: 850, color: "var(--color-text-muted)" }}>
            ESC 로 닫기 · ⌘/Ctrl + Enter 저장
          </span>
        }
        right={
          <>
            <Button intent="secondary" onClick={onClose} disabled={busy}>
              취소
            </Button>
            <Button
              intent="primary"
              onClick={() => {
                if (!titleInput.trim() || !date) return;
                mutate();
              }}
              disabled={busy || !titleInput.trim() || !date}
            >
              {busy ? "저장 중…" : "추가"}
            </Button>
          </>
        }
      />
    </AdminModal>
  );
}


==========================================================================================
# FILE: components/EnrollStudentModal.tsx
==========================================================================================
// PATH: src/features/lectures/components/EnrollStudentModal.tsx
import { useEffect, useMemo, useState } from "react";
import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";

import { bulkCreateAttendance } from "../api/attendance";
import { fetchStudents } from "@/features/students/api/students";

import { AdminModal, ModalBody, ModalFooter, ModalHeader } from "@/shared/ui/modal";
import { Button, EmptyState } from "@/shared/ui/ds";
import { formatPhone } from "@/shared/utils/formatPhone";

interface Props {
  sessionId: number;
  isOpen: boolean;
  onClose: () => void;
  onSuccess?: () => void;
}

type Student = {
  id: number;
  name: string;
  phone?: string | null;
};

export default function EnrollStudentModal({ sessionId, isOpen, onClose, onSuccess }: Props) {
  const qc = useQueryClient();

  const [keyword, setKeyword] = useState("");
  const [search, setSearch] = useState("");
  const [selectedIds, setSelectedIds] = useState<number[]>([]);

  useEffect(() => {
    const t = setTimeout(() => setSearch(keyword.trim()), 300);
    return () => clearTimeout(t);
  }, [keyword]);

  const mutation = useMutation({
    mutationFn: (ids: number[]) => bulkCreateAttendance(sessionId, ids),
    onSuccess: () => {
      qc.invalidateQueries({ queryKey: ["attendance", sessionId] });
      onSuccess?.();
      onClose();
      setSelectedIds([]);
    },
  });

  useEffect(() => {
    function onKeyDown(e: KeyboardEvent) {
      if (!isOpen) return;
      if (e.key === "Escape") onClose();
      if ((e.ctrlKey || e.metaKey) && e.key === "Enter") {
        if (selectedIds.length > 0 && !mutation.isPending) {
          mutation.mutate(selectedIds);
        }
      }
    }
    window.addEventListener("keydown", onKeyDown);
    return () => window.removeEventListener("keydown", onKeyDown);
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [isOpen, selectedIds]);

  const { data: students = [], isLoading } = useQuery({
    queryKey: ["enroll-modal-students", search],
    queryFn: async (): Promise<Student[]> => {
      const { data } = await fetchStudents(search, { page_size: 100 }, "", 1);
      return data.map((s) => ({
        id: s.id,
        name: s.name,
        phone: s.studentPhone,
      }));
    },
    enabled: isOpen,
  });

  const title = useMemo(() => "학생 추가 (세션 기준)", []);

  if (!isOpen) return null;

  const toggleSelect = (id: number) => {
    setSelectedIds((prev) => (prev.includes(id) ? prev.filter((x) => x !== id) : [...prev, id]));
  };

  return (
    <AdminModal open={true} onClose={onClose} type="action" width={720}>
      <ModalHeader
        type="action"
        title={title}
        description="검색 후 체크하여 세션 출결 대상 학생을 추가합니다. (⌘/Ctrl + Enter 추가)"
      />

      <ModalBody>
        <div style={{ display: "grid", gap: 12 }}>
          <input
            value={keyword}
            onChange={(e) => setKeyword(e.target.value)}
            placeholder="학생 이름 검색"
            className="ds-input"
            autoFocus
          />

          <div
            style={{
              borderRadius: 14,
              border: "1px solid var(--color-border-divider)",
              background: "var(--color-bg-surface)",
              overflow: "hidden",
            }}
          >
            <div style={{ maxHeight: 320, overflow: "auto" }}>
              {isLoading ? (
                <EmptyState mode="embedded" scope="panel" tone="loading" title="불러오는 중…" />
              ) : students.length === 0 ? (
                <EmptyState
                  mode="embedded"
                  scope="panel"
                  title="학생이 없습니다."
                  description="검색어를 변경해 보세요."
                />
              ) : (
                <div style={{ display: "grid" }}>
                  {students.map((st) => {
                    const checked = selectedIds.includes(st.id);
                    return (
                      <Button
                        key={st.id}
                        type="button"
                        intent="ghost"
                        size="md"
                        onClick={() => toggleSelect(st.id)}
                        className="!block !w-full !grid !grid-cols-[28px_1fr] !gap-2.5 !py-2.5 !px-3 !text-left !justify-start border-t border-[var(--color-border-divider)]"
                        style={{
                          background: checked ? "var(--color-bg-surface-soft)" : "transparent",
                        }}
                      >
                        <input type="checkbox" checked={checked} readOnly className="mt-0.5" />
                        <div style={{ minWidth: 0 }}>
                          <div
                            style={{
                              fontSize: 13,
                              fontWeight: 900,
                              color: "var(--color-text-primary)",
                              whiteSpace: "nowrap",
                              overflow: "hidden",
                              textOverflow: "ellipsis",
                            }}
                          >
                            {st.name}
                          </div>
                          <div style={{ fontSize: 11, fontWeight: 850, color: "var(--color-text-muted)" }}>
                            {formatPhone(st.phone)}
                          </div>
                        </div>
                      </Button>
                    );
                  })}
                </div>
              )}
            </div>
          </div>

          <div style={{ fontSize: 11, fontWeight: 850, color: "var(--color-text-muted)" }}>
            선택: {selectedIds.length}명
          </div>
        </div>
      </ModalBody>

      <ModalFooter
        left={
          <span style={{ fontSize: 12, fontWeight: 850, color: "var(--color-text-muted)" }}>
            ESC 로 닫기 · ⌘/Ctrl + Enter 추가
          </span>
        }
        right={
          <>
            <Button intent="secondary" onClick={onClose}>
              취소
            </Button>
            <Button
              intent="primary"
              onClick={() => mutation.mutate(selectedIds)}
              disabled={mutation.isPending || selectedIds.length === 0}
            >
              {mutation.isPending ? "추가 중…" : "추가"}
            </Button>
          </>
        }
      />
    </AdminModal>
  );
}


==========================================================================================
# FILE: components/LectureCreateModal.tsx
==========================================================================================
import { useEffect, useMemo, useState } from "react";
import { useMutation, useQuery, useQueryClient } from "@tanstack/react-query";
import api from "@/shared/api/axios";

import { AdminModal, ModalBody, ModalFooter, ModalHeader } from "@/shared/ui/modal";
import { Button } from "@/shared/ui/ds";
import { DatePicker } from "@/shared/ui/date";
import { TimeRangeInput } from "@/shared/ui/time";
import { ColorPickerField, getDefaultColorForPicker } from "@/shared/ui/domain";
import LectureChip from "@/shared/ui/chips/LectureChip";
import { fetchLectureInstructorOptions } from "@/features/lectures/api/sessions";

interface Props {
  isOpen: boolean;
  onClose: () => void;
  /** 이미 사용 중인 강의 색상 — 기본값이 이들과 최대한 차이나도록 선택됨 */
  usedColors?: string[];
}

interface CreateLecturePayload {
  title: string;
  name: string;
  subject: string;
  description: string;
  start_date: string;
  end_date: string;
  lecture_time: string;
  color: string;
  chip_label: string;
  is_active: boolean;
}

export default function LectureCreateModal({ isOpen, onClose, usedColors = [] }: Props) {
  const qc = useQueryClient();

  const [title, setTitle] = useState("");
  const [name, setName] = useState("");
  const [subject, setSubject] = useState("");
  const [description, setDescription] = useState("");
  const [startDate, setStartDate] = useState("");
  const [endDate, setEndDate] = useState("");
  const [lectureTime, setLectureTime] = useState("");
  const [color, setColor] = useState(() => getDefaultColorForPicker(usedColors));
  const [chipLabel, setChipLabel] = useState("");

  const modalTitle = useMemo(() => "강의 추가", []);

  const { data: instructorOptions = [] } = useQuery({
    queryKey: ["lecture-instructor-options"],
    queryFn: fetchLectureInstructorOptions,
    enabled: isOpen,
  });

  const { mutate, isPending, isError } = useMutation({
    mutationFn: async (payload: CreateLecturePayload) => {
      await api.post("/lectures/lectures/", payload);
    },
    onSuccess: () => {
      qc.invalidateQueries({ queryKey: ["lectures"] });
      onClose();
    },
  });

  useEffect(() => {
    if (!isOpen) return;
    setTitle("");
    setName("");
    setSubject("");
    setDescription("");
    setStartDate("");
    setEndDate("");
    setLectureTime("");
    setColor(getDefaultColorForPicker(usedColors));
    setChipLabel("");
  }, [isOpen, usedColors]);

  useEffect(() => {
    if (isOpen && instructorOptions.length > 0 && !name) {
      setName(instructorOptions[0].name);
    }
  }, [isOpen, instructorOptions, name]);

  useEffect(() => {
    if (!isOpen) return;

    function onKeyDown(e: KeyboardEvent) {
      if (e.key === "Escape") onClose();
      if ((e.ctrlKey || e.metaKey) && e.key === "Enter") {
        if (!isPending && title.trim()) submit();
      }
    }

    window.addEventListener("keydown", onKeyDown);
    return () => window.removeEventListener("keydown", onKeyDown);
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [isOpen, title, name, subject, description, startDate, endDate, lectureTime, color, chipLabel, isPending]);

  if (!isOpen) return null;

  function submit() {
    if (!title.trim()) return;
    mutate({
      title,
      name,
      subject,
      description,
      start_date: startDate,
      end_date: endDate,
      lecture_time: lectureTime.trim(),
      color,
      chip_label: chipLabel.trim().slice(0, 2),
      is_active: true,
    });
  }

  return (
    <AdminModal open={true} onClose={onClose} type="action" width={480}>
      <ModalHeader type="action" title={modalTitle} description="⌘/Ctrl + Enter 로 등록" />

      <ModalBody>
        {isError && (
          <div style={{ marginBottom: 8, fontSize: 12, fontWeight: 900, color: "var(--color-error)" }}>
            등록 중 오류가 발생했습니다.
          </div>
        )}

        <div style={{ display: "grid", gap: 10, maxWidth: 400 }}>
          {/* 딱지 영역: 좌측=미리보기+아이콘, 우측=팔레트 (방향 고정) */}
          <div
            style={{
              display: "grid",
              gridTemplateColumns: "auto 1fr",
              gridTemplateRows: "auto auto",
              gap: "10px 14px",
              alignItems: "center",
              direction: "ltr",
            }}
          >
            <div style={{ gridColumn: 1, gridRow: 1, display: "flex", alignItems: "center", justifyContent: "center" }}>
              <LectureChip
                lectureName=""
                color={color}
                chipLabel={chipLabel || undefined}
                size={36}
              />
            </div>
            <div style={{ gridColumn: 2, gridRow: "1 / -1", minWidth: 0 }}>
              <ColorPickerField
                label=""
                value={color}
                onChange={setColor}
                disabled={isPending}
              />
            </div>
            <div style={{ gridColumn: 1, gridRow: 2 }}>
              <input
                className="ds-input"
                placeholder="아이콘"
                value={chipLabel}
                onChange={(e) => setChipLabel(e.target.value.slice(0, 2))}
                maxLength={2}
                disabled={isPending}
                style={{ width: 56, textAlign: "center", padding: "6px 4px" }}
                aria-label="아이콘(딱지 2글자)"
              />
            </div>
          </div>

          <input
            className="ds-input"
            placeholder="강의 이름"
            value={title}
            onChange={(e) => setTitle(e.target.value)}
            data-invalid={!title.trim() ? "true" : "false"}
            disabled={isPending}
            autoFocus
          />

          <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 8 }}>
            <div style={{ display: "flex", flexDirection: "column", gap: 4 }}>
              <label className="modal-section-label" style={{ fontSize: 12, fontWeight: 800, color: "var(--color-text-muted)" }}>
                담당 강사
              </label>
              <select
                className="ds-input"
                value={name}
                onChange={(e) => setName(e.target.value)}
                disabled={isPending}
                aria-label="담당 강사 선택"
              >
                <option value="">선택</option>
                {instructorOptions.map((opt) => (
                  <option key={`${opt.type}-${opt.name}`} value={opt.name}>
                    {opt.type === "owner" ? `오너 · ${opt.name}` : opt.name}
                  </option>
                ))}
              </select>
            </div>
            <input
              className="ds-input"
              placeholder="과목"
              value={subject}
              onChange={(e) => setSubject(e.target.value)}
              disabled={isPending}
            />
          </div>

          <textarea
            className="ds-textarea"
            rows={3}
            placeholder="설명"
            value={description}
            onChange={(e) => setDescription(e.target.value)}
            disabled={isPending}
            style={{ resize: "none" }}
          />

          <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 8 }}>
            <DatePicker
              value={startDate}
              onChange={setStartDate}
              placeholder="시작일"
              disabled={isPending}
            />
            <DatePicker
              value={endDate}
              onChange={setEndDate}
              placeholder="종료일"
              disabled={isPending}
            />
          </div>

          <div style={{ minWidth: 320 }}>
            <div className="modal-section-label" style={{ marginBottom: 6 }}>강의 시간</div>
            <TimeRangeInput
              value={lectureTime}
              onChange={setLectureTime}
              disabled={isPending}
              startPlaceholder="시작"
              endPlaceholder="종료"
              startLabel="시작"
              endLabel="종료"
            />
          </div>
        </div>
      </ModalBody>

      <ModalFooter
        left={
          <span style={{ fontSize: 12, fontWeight: 850, color: "var(--color-text-muted)" }}>
            ESC 로 닫기 · ⌘/Ctrl + Enter 등록
          </span>
        }
        right={
          <>
            <Button intent="secondary" onClick={onClose} disabled={isPending}>
              취소
            </Button>
            <Button intent="primary" onClick={submit} disabled={isPending || !title.trim()}>
              {isPending ? "등록 중…" : "등록"}
            </Button>
          </>
        }
      />
    </AdminModal>
  );
}


==========================================================================================
# FILE: components/LectureEnrollExcelModal.tsx
==========================================================================================
// PATH: src/features/lectures/components/LectureEnrollExcelModal.tsx
// 엑셀 업로드 SSOT: docs/DESIGN_SSOT.md §8 — studentExcel + ExcelUploadZone
// 원테이크: 학생 없으면 생성 + 수강등록 + 1차시 생성 + 차시 등록·출결. 강의명 확인 후 진행.

import { useEffect, useState } from "react";
import { AdminModal, ModalBody, ModalFooter, ModalHeader } from "@/shared/ui/modal";
import { Button } from "@/shared/ui/ds";
import ExcelUploadZone from "@/shared/ui/excel/ExcelUploadZone";
import {
  parseStudentExcel,
  downloadStudentExcelTemplate,
  type ParseStudentExcelResult,
} from "@/features/students/excel/studentExcel";
import { lectureEnrollFromExcelUpload } from "../api/enrollments";
import { feedback } from "@/shared/ui/feedback/feedback";
import { asyncStatusStore } from "@/shared/ui/asyncStatus";

interface Props {
  lectureId: number;
  /** 현재 선택한 강의명 (엑셀 강의명과 비교 확인용) */
  lectureTitle: string;
  open: boolean;
  onClose: () => void;
  onSuccess?: () => void;
}

export default function LectureEnrollExcelModal({
  lectureId,
  lectureTitle,
  open,
  onClose,
  onSuccess,
}: Props) {
  const [busy, setBusy] = useState(false);
  const [parsed, setParsed] = useState<ParseStudentExcelResult | null>(null);
  const [selectedFile, setSelectedFile] = useState<File | null>(null);
  const [initialPassword, setInitialPassword] = useState("");

  useEffect(() => {
    if (open) {
      setParsed(null);
      setSelectedFile(null);
      setInitialPassword("");
    }
  }, [open]);

  const handleExcelFileSelect = async (file: File) => {
    if (busy) return;
    setBusy(true);
    try {
      const result = await parseStudentExcel(file);
      if (!result.rows.length) {
        feedback.error("등록할 학생 데이터가 없습니다.");
        return;
      }
      setSelectedFile(file);
      setParsed(result);
    } catch (e: unknown) {
      const msg = e instanceof Error ? e.message : "엑셀 파일을 읽는 중 오류가 발생했습니다.";
      feedback.error(msg);
    } finally {
      setBusy(false);
    }
  };

  const handleConfirmAndRegister = async () => {
    if (busy || !selectedFile || !parsed?.rows.length) return;
    const pwd = initialPassword.trim();
    if (pwd.length < 4) {
      feedback.error("초기 비밀번호는 4자 이상이어야 합니다. (신규 생성 학생 로그인용)");
      return;
    }
    setBusy(true);
    try {
      const { job_id } = await lectureEnrollFromExcelUpload(lectureId, selectedFile, pwd);
      if (!job_id) {
        feedback.error("작업 ID를 받지 못했습니다. 다시 시도해 주세요.");
        return;
      }
      asyncStatusStore.addWorkerJob("엑셀 수강등록", job_id, "excel_parsing");
      feedback.success("작업이 백그라운드에서 진행됩니다. 우하단에서 진행 상황을 확인할 수 있습니다.");
      onSuccess?.();
      onClose();
      setParsed(null);
      setSelectedFile(null);
    } catch (e: unknown) {
      feedback.error(e instanceof Error ? e.message : "등록 요청 중 오류가 발생했습니다.");
    } finally {
      setBusy(false);
    }
  };

  if (!open) return null;

  const isConfirmStep = parsed != null && parsed.rows.length > 0;

  return (
    <AdminModal open onClose={onClose} type="action" width={520}>
      <ModalHeader
        type="action"
        title="수강생 엑셀 업로드"
        description={
          isConfirmStep
            ? "강의가 맞는지 확인한 뒤 등록해 주세요."
            : "엑셀 파일로 수강생을 일괄 등록합니다. (학생 없으면 자동 생성 + 1차시 등록)"
        }
      />

      <ModalBody>
        <div
          className="modal-scroll-body modal-scroll-body--compact"
          style={{ display: "flex", flexDirection: "column", gap: 16 }}
        >
          {!isConfirmStep ? (
            <>
              <div className="modal-form-row modal-form-row--1-auto" style={{ alignItems: "end" }}>
                <div />
                <Button intent="secondary" onClick={downloadStudentExcelTemplate} disabled={busy}>
                  엑셀 양식 다운로드
                </Button>
              </div>
              <ExcelUploadZone onFileSelect={handleExcelFileSelect} disabled={busy} />
            </>
          ) : (
            <>
              <div className="modal-form-group" style={{ marginBottom: 0 }}>
                <div className="modal-section-label" style={{ marginBottom: 6 }}>
                  강의 일치 확인
                </div>
                <div
                  className="rounded-md p-3 text-sm"
                  style={{
                    background: "var(--color-surface-subtle)",
                    border: "1px solid var(--color-border-divider)",
                  }}
                >
                  <div className="flex flex-col gap-2">
                    <div>
                      <span className="text-[var(--color-text-muted)]">엑셀에 적힌 강의명: </span>
                      <strong>{parsed.lectureNameFromExcel?.trim() || "— 없음 —"}</strong>
                    </div>
                    <div>
                      <span className="text-[var(--color-text-muted)]">현재 강의(선택한 강의): </span>
                      <strong>{lectureTitle || "—"}</strong>
                    </div>
                  </div>
                  <p className="mt-2 text-[13px]" style={{ color: "var(--color-text-muted)" }}>
                    다른 강의 엑셀을 올리지 않았는지 확인한 뒤, 맞으면 아래에서 초기 비밀번호를 입력하고 등록해 주세요.
                  </p>
                </div>
              </div>

              <div className="modal-form-group" style={{ marginBottom: 0 }}>
                <label className="modal-section-label" style={{ marginBottom: 6 }}>
                  초기 비밀번호 <span style={{ color: "var(--color-error)" }}>*</span>
                </label>
                <input
                  type="password"
                  className="ds-input"
                  value={initialPassword}
                  onChange={(e) => setInitialPassword(e.target.value)}
                  placeholder="신규 생성 학생 로그인용 (4자 이상)"
                  disabled={busy}
                  autoComplete="new-password"
                  style={{ maxWidth: 280 }}
                />
              </div>

              <div className="flex items-center justify-between">
                <span className="modal-section-label" style={{ marginBottom: 0 }}>
                  {parsed.rows.length}명 등록 예정
                </span>
                <Button
                  intent="ghost"
                  size="sm"
                  onClick={() => setParsed(null)}
                  disabled={busy}
                >
                  엑셀 다시 선택
                </Button>
              </div>
            </>
          )}
        </div>
      </ModalBody>

      <ModalFooter
        left={
          <span className="modal-hint" style={{ marginBottom: 0 }}>
            {isConfirmStep
              ? "맞으면 등록하기를 누르세요. 업로드 후 창을 닫아도 백그라운드에서 작업이 진행됩니다. 우하단에서 진행률을 확인할 수 있습니다."
              : "엑셀 파일 선택 후 강의명 확인 단계로 이동합니다."}
          </span>
        }
        right={
          <>
            <Button intent="secondary" onClick={onClose} disabled={busy}>
              취소
            </Button>
            {isConfirmStep ? (
              <Button
                intent="primary"
                onClick={handleConfirmAndRegister}
                disabled={busy || initialPassword.trim().length < 4}
              >
                {busy ? "업로드 중…" : "맞아요, 등록하기"}
              </Button>
            ) : null}
          </>
        }
      />
    </AdminModal>
  );
}


==========================================================================================
# FILE: components/LectureEnrollStudentModal.tsx
==========================================================================================
// PATH: src/features/lectures/components/LectureEnrollStudentModal.tsx
// Design: docs/DESIGN_SSOT.md (차시 추가 모달 초기 화면 패턴)

import {
  AdminModal,
  ModalBody,
  ModalFooter,
  ModalHeader,
} from "@/shared/ui/modal";
import { Button } from "@/shared/ui/ds";
import { SessionBlockView } from "@/shared/ui/session-block";

interface Props {
  lectureId: number;
  open: boolean;
  onClose: () => void;
  onSuccess?: () => void;
  /** 차시 생성 후 업로드 선택 시: 이 모달 닫고 차시 추가 모달 열기 */
  onChooseSessionCreate?: () => void;
  /** 엑셀 업로드 선택 시: 이 모달 닫고 엑셀 업로드 모달 열기 */
  onChooseExcelUpload?: () => void;
}

export default function LectureEnrollStudentModal({
  open,
  onClose,
  onChooseSessionCreate,
  onChooseExcelUpload,
}: Props) {
  const handleSessionCreate = () => {
    onClose();
    onChooseSessionCreate?.();
  };

  const handleExcelUpload = () => {
    onClose();
    onChooseExcelUpload?.();
  };

  if (!open) return null;

  return (
    <AdminModal open onClose={onClose} type="action" width={620}>
      <ModalHeader
        type="action"
        title="수강생 등록"
        description="등록 방식을 선택하세요."
      />

      <ModalBody>
        <div className="modal-scroll-body grid gap-6 w-full max-w-full box-border">
          <div>
            <div className="modal-section-label mb-3">등록 방식</div>
            <div className="grid grid-cols-2 gap-5">
              <SessionBlockView
                variant="n1"
                compact={false}
                selected={false}
                showCheck={false}
                title="차시 생성 후 업로드"
                desc="차시를 먼저 만든 뒤 수강생을 일괄 반영"
                onClick={handleSessionCreate}
                ariaPressed={false}
              />
              <SessionBlockView
                variant="supplement"
                compact={false}
                selected={false}
                showCheck={false}
                title="엑셀 업로드"
                desc="엑셀 파일로 수강생 목록 업로드"
                onClick={handleExcelUpload}
                ariaPressed={false}
              />
            </div>
          </div>
        </div>
      </ModalBody>

      <ModalFooter
        left={
          <span className="text-[12px] font-semibold text-[var(--color-text-muted)]">
            ESC 로 닫기
          </span>
        }
        right={
          <Button intent="secondary" onClick={onClose}>
            취소
          </Button>
        }
      />
    </AdminModal>
  );
}


==========================================================================================
# FILE: components/LectureTabs.tsx
==========================================================================================
// PATH: src/features/lectures/components/LectureTabs.tsx
import { useLocation, useNavigate, useParams } from "react-router-dom";

export default function LectureTabs() {
  const navigate = useNavigate();
  const location = useLocation();
  const { lectureId } = useParams<{ lectureId: string }>();
  if (!lectureId) return null;

  const base = `/admin/lectures/${lectureId}`;

  const activeKey = location.pathname.includes("/materials")
    ? "materials"
    : location.pathname.includes("/board")
    ? "board"
    : location.pathname.includes("/ddays")
    ? "ddays"
    : location.pathname.includes("/attendance")
    ? "attendance"
    : location.pathname.includes("/report")
    ? "report"
    : "students";

  const tabs = [
    { key: "students", label: "수강생", to: base },
    { key: "materials", label: "자료실", to: `${base}/materials` },
    { key: "board", label: "게시판", to: `${base}/board` },
    { key: "ddays", label: "디데이", to: `${base}/ddays` },
    { key: "attendance", label: "출결", to: `${base}/attendance` },
    { key: "report", label: "리포트", to: `${base}/report` },
  ];

  return (
    <div className="ds-tabs ds-tabs--flat" role="tablist">
      {tabs.map((t) => (
        <button
          key={t.key}
          type="button"
          role="tab"
          aria-selected={activeKey === t.key}
          className={`ds-tab ${activeKey === t.key ? "is-active" : ""}`}
          onClick={() => navigate(t.to)}
        >
          {t.label}
        </button>
      ))}
    </div>
  );
}


==========================================================================================
# FILE: components/MaterialCategoryModal.tsx
==========================================================================================
// PATH: src/features/lectures/components/MaterialCategoryModal.tsx
import { useEffect, useMemo, useState } from "react";
import { useMutation, useQueryClient } from "@tanstack/react-query";
import { createMaterialCategory } from "../api/materials";

import { AdminModal, ModalBody, ModalFooter, ModalHeader } from "@/shared/ui/modal";
import { Button } from "@/shared/ui/ds";

interface Props {
  lectureId: number;
  onClose: () => void;
}

export default function MaterialCategoryModal({ lectureId, onClose }: Props) {
  const qc = useQueryClient();
  const [name, setName] = useState("");
  const [busy, setBusy] = useState(false);

  const title = useMemo(() => "자료실 카테고리 추가", []);

  const { mutate } = useMutation({
    mutationFn: async () => {
      setBusy(true);
      try {
        return await createMaterialCategory({ lecture: lectureId, name });
      } finally {
        setBusy(false);
      }
    },
    onSuccess: () => {
      qc.invalidateQueries({ queryKey: ["material-categories", lectureId] });
      onClose();
    },
  });

  useEffect(() => {
    function onKeyDown(e: KeyboardEvent) {
      if (e.key === "Escape") onClose();
      if ((e.ctrlKey || e.metaKey) && e.key === "Enter") {
        if (!busy && name.trim()) mutate();
      }
    }
    window.addEventListener("keydown", onKeyDown);
    return () => window.removeEventListener("keydown", onKeyDown);
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [busy, name]);

  return (
    <AdminModal open={true} onClose={onClose} type="action" width={560}>
      <ModalHeader type="action" title={title} description="⌘/Ctrl + Enter 로 저장" />

      <ModalBody>
        <div style={{ display: "grid", gap: 10 }}>
          <input
            className="ds-input"
            placeholder="예: 숙제, 시험, 복습 과제..."
            value={name}
            onChange={(e) => setName(e.target.value)}
            disabled={busy}
            autoFocus
          />
          <div style={{ fontSize: 11, fontWeight: 850, color: "var(--color-text-muted)" }}>
            빈 값은 저장할 수 없습니다.
          </div>
        </div>
      </ModalBody>

      <ModalFooter
        left={
          <span style={{ fontSize: 12, fontWeight: 850, color: "var(--color-text-muted)" }}>
            ESC 로 닫기 · ⌘/Ctrl + Enter 저장
          </span>
        }
        right={
          <>
            <Button intent="secondary" onClick={onClose} disabled={busy}>
              취소
            </Button>
            <Button
              intent="primary"
              onClick={() => {
                if (!name.trim()) return;
                mutate();
              }}
              disabled={busy || !name.trim()}
            >
              {busy ? "저장 중…" : "추가"}
            </Button>
          </>
        }
      />
    </AdminModal>
  );
}


==========================================================================================
# FILE: components/MaterialUploadModal.tsx
==========================================================================================
// PATH: src/features/lectures/components/MaterialUploadModal.tsx
import { useEffect, useMemo, useState } from "react";
import { useMutation, useQueryClient } from "@tanstack/react-query";
import { createMaterial } from "../api/materials";

import { AdminModal, ModalBody, ModalFooter, ModalHeader } from "@/shared/ui/modal";
import { Button } from "@/shared/ui/ds";

interface Props {
  lectureId: number;
  categoryId: number | null;
  onClose: () => void;
}

export default function MaterialUploadModal({ lectureId, categoryId, onClose }: Props) {
  const qc = useQueryClient();

  const [titleInput, setTitleInput] = useState("");
  const [description, setDescription] = useState("");
  const [file, setFile] = useState<File | null>(null);
  const [url, setUrl] = useState("");
  const [busy, setBusy] = useState(false);

  const title = useMemo(() => "자료 추가하기", []);

  const { mutate } = useMutation({
    mutationFn: async () => {
      setBusy(true);
      try {
        const fd = new FormData();
        fd.append("lecture", String(lectureId));
        if (categoryId) fd.append("category", String(categoryId));
        fd.append("title", titleInput || (file ? file.name : "자료"));
        fd.append("description", description);
        if (file) fd.append("file", file);
        if (url) fd.append("url", url);
        fd.append("is_public", "true");
        return await createMaterial(fd);
      } finally {
        setBusy(false);
      }
    },
    onSuccess: () => {
      qc.invalidateQueries({ queryKey: ["materials", lectureId, categoryId ?? "all"] });
      onClose();
    },
  });

  useEffect(() => {
    function onKeyDown(e: KeyboardEvent) {
      if (e.key === "Escape") onClose();
      if ((e.ctrlKey || e.metaKey) && e.key === "Enter") {
        if (!busy && (file || url.trim())) mutate();
      }
    }
    window.addEventListener("keydown", onKeyDown);
    return () => window.removeEventListener("keydown", onKeyDown);
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [busy, file, url, titleInput, description]);

  return (
    <AdminModal open={true} onClose={onClose} type="action" width={920}>
      <ModalHeader type="action" title={title} description="⌘/Ctrl + Enter 로 추가" />

      <ModalBody>
        <div style={{ display: "grid", gap: 12 }}>
          <div style={{ display: "grid", gap: 8 }}>
            <div style={{ fontSize: 12, fontWeight: 900, color: "var(--color-text-secondary)" }}>
              제목
            </div>
            <input
              className="ds-input"
              value={titleInput}
              onChange={(e) => setTitleInput(e.target.value)}
              disabled={busy}
              placeholder="미입력 시 파일명/기본값 사용"
            />
          </div>

          <div style={{ display: "grid", gap: 8 }}>
            <div style={{ fontSize: 12, fontWeight: 900, color: "var(--color-text-secondary)" }}>
              설명
            </div>
            <textarea
              className="ds-textarea"
              rows={4}
              style={{ resize: "none" }}
              value={description}
              onChange={(e) => setDescription(e.target.value)}
              disabled={busy}
            />
          </div>

          <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 10 }}>
            <div style={{ display: "grid", gap: 8 }}>
              <div style={{ fontSize: 12, fontWeight: 900, color: "var(--color-text-secondary)" }}>
                파일 업로드
              </div>
              <input type="file" onChange={(e) => setFile(e.target.files?.[0] ?? null)} disabled={busy} />
              <div style={{ fontSize: 11, fontWeight: 850, color: "var(--color-text-muted)" }}>
                파일 또는 URL 중 하나 이상 필요합니다.
              </div>
            </div>

            <div style={{ display: "grid", gap: 8 }}>
              <div style={{ fontSize: 12, fontWeight: 900, color: "var(--color-text-secondary)" }}>
                외부 URL
              </div>
              <input
                className="ds-input"
                value={url}
                onChange={(e) => setUrl(e.target.value)}
                disabled={busy}
                placeholder="https://"
              />
            </div>
          </div>
        </div>
      </ModalBody>

      <ModalFooter
        left={
          <span style={{ fontSize: 12, fontWeight: 850, color: "var(--color-text-muted)" }}>
            ESC 로 닫기 · ⌘/Ctrl + Enter 추가
          </span>
        }
        right={
          <>
            <Button intent="secondary" onClick={onClose} disabled={busy}>
              취소
            </Button>
            <Button
              intent="primary"
              onClick={() => {
                if (!file && !url.trim()) return;
                mutate();
              }}
              disabled={busy || (!file && !url.trim())}
            >
              {busy ? "저장 중…" : "추가"}
            </Button>
          </>
        }
      />
    </AdminModal>
  );
}


==========================================================================================
# FILE: components/SessionBar.tsx
==========================================================================================
// PATH: src/features/lectures/components/SessionBar.tsx
import { useLocation } from "react-router-dom";
import { useState } from "react";
import { useQuery } from "@tanstack/react-query";
import { Plus } from "lucide-react";
import api from "@/shared/api/axios";
import SessionCreateModal from "./SessionCreateModal";
import { useLectureParams } from "../hooks/useLectureParams";
import { sortSessionsByDateDesc } from "../api/sessions";
import { SessionBlockView, isSupplement } from "@/shared/ui/session-block";

export default function SessionBar() {
  const { lectureId } = useLectureParams();
  const location = useLocation();

  if (!Number.isFinite(lectureId)) return null;

  const [showModal, setShowModal] = useState(false);

  const { data: rawSessions = [] } = useQuery({
    queryKey: ["lecture-sessions", lectureId],
    queryFn: async () => {
      const res = await api.get(`/lectures/sessions/?lecture=${lectureId}`);
      return res.data.results ?? res.data;
    },
  });
  const sessions = sortSessionsByDateDesc(Array.isArray(rawSessions) ? rawSessions : []);

  return (
    <div style={{ marginBottom: 14 }}>
      <div
        style={{
          display: "flex",
          gap: 10,
          overflowX: "auto",
          paddingBottom: 6,
        }}
      >
        {sessions.map((s: { id: number; order?: number; date?: string | null; title?: string | null }) => {
          const active = location.pathname.includes(`/sessions/${s.id}`);
          const supplement = isSupplement(s.title);

          return (
            <SessionBlockView
              key={s.id}
              variant={supplement ? "supplement" : "n1"}
              compact
              to={`sessions/${s.id}`}
              selected={active}
              title={`${s.order ?? "?"}차시`}
              desc={s.date || "-"}
            />
          );
        })}

        <SessionBlockView
          variant="add"
          compact
          onClick={() => setShowModal(true)}
          ariaLabel="차시 추가"
        >
          <Plus size={22} strokeWidth={2.5} />
        </SessionBlockView>
      </div>

      {showModal && (
        <SessionCreateModal
          lectureId={lectureId}
          onClose={() => setShowModal(false)}
        />
      )}
    </div>
  );
}


==========================================================================================
# FILE: components/SessionCreateModal.tsx
==========================================================================================
// PATH: src/features/lectures/components/SessionCreateModal.tsx
// 차시 추가: 2차시/보강 선택 + 날짜·시간 (전역 모달 SSOT: ModalDateSection, ModalTimeSection 사용)

import { useEffect, useMemo, useState } from "react";
import { useQuery } from "@tanstack/react-query";
import api from "@/shared/api/axios";
import {
  AdminModal,
  ModalBody,
  ModalFooter,
  ModalHeader,
  ModalDateSection,
  ModalTimeSection,
} from "@/shared/ui/modal";
import { Button } from "@/shared/ui/ds";
import { createSession } from "../api/sessions";
import { SessionBlockView } from "@/shared/ui/session-block";

type SessionType = "n+1" | "supplement";
type DateMode = "default" | "custom";
type TimeMode = "default" | "custom";

interface Props {
  lectureId: number;
  onClose: () => void;
}

/** lecture_time에서 시간 부분만 추출 (예: "매주 토요일 12:30~14:30" → "12:30~14:30") */
function extractTimeFromLectureTime(lectureTime: string | null | undefined): string {
  if (!lectureTime?.trim()) return "";
  const s = lectureTime.trim();
  const match = s.match(/\d{1,2}:\d{2}\s*~?\s*-?\s*\d{1,2}:\d{2}/);
  return match ? match[0].replace(/\s/g, "") : s;
}

/** 마지막 차시 날짜 + 7일 (다음 주 같은 요일) */
function nextWeekDate(lastDateStr: string | null | undefined): string {
  if (!lastDateStr) return "";
  const d = new Date(lastDateStr + "T12:00:00");
  if (Number.isNaN(d.getTime())) return "";
  d.setDate(d.getDate() + 7);
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2, "0");
  const day = String(d.getDate()).padStart(2, "0");
  return `${y}-${m}-${day}`;
}

export default function SessionCreateModal({ lectureId, onClose }: Props) {
  const [busy, setBusy] = useState(false);
  const [sessionType, setSessionType] = useState<SessionType | null>(null);
  const [dateMode, setDateMode] = useState<DateMode>("default");
  const [date, setDate] = useState("");
  const [timeMode, setTimeMode] = useState<TimeMode>("default");
  const [timeInput, setTimeInput] = useState("");

  const { data: lecture } = useQuery({
    queryKey: ["lecture", lectureId],
    queryFn: async () => (await api.get(`/lectures/lectures/${lectureId}/`)).data,
    enabled: Number.isFinite(lectureId),
  });

  const { data: sessionsData } = useQuery({
    queryKey: ["sessions", lectureId],
    queryFn: async () => (await api.get(`/lectures/sessions/?lecture=${lectureId}`)).data,
    enabled: Number.isFinite(lectureId),
  });

  const sessionsList = useMemo(() => {
    const raw = sessionsData;
    if (Array.isArray(raw)) return raw;
    if (raw && Array.isArray((raw as { results?: unknown[] }).results)) return (raw as { results: unknown[] }).results;
    return [];
  }, [sessionsData]);

  const sortedSessions = useMemo(
    () => (sessionsList as { order?: number; date?: string | null }[]).slice().sort((a, b) => (a.order ?? 0) - (b.order ?? 0)),
    [sessionsList]
  );
  const nextOrder = sortedSessions.length + 1;
  // 정규 차시 기본 날짜: 강의 생성 모달 start_date 연결
  // — 기존 정규 차시 없음 → 강의 시작일(lecture.start_date) / 있음 → 마지막 정규 차시 날짜 + 7일
  const lastRegularSessionWithDate = useMemo(() => {
    const regular = (sortedSessions as { title?: string; date?: string | null }[]).filter(
      (s) => s.date && !s.title?.includes?.("보강")
    );
    return regular.slice(-1)[0];
  }, [sortedSessions]);
  const defaultDateFromLecture = useMemo(() => {
    const lectureStart = (lecture as { start_date?: string | null })?.start_date ?? null;
    if (lastRegularSessionWithDate?.date) return nextWeekDate(lastRegularSessionWithDate.date);
    return lectureStart?.trim() ? lectureStart : nextWeekDate(lectureStart);
  }, [lastRegularSessionWithDate?.date, lecture]);

  const lectureTimeRaw = lecture?.lecture_time?.trim() || "";
  // 정규 차시 기본 시간: 강의 생성 모달 lecture_time(시작~종료) 연결
  const lectureTimeExtract = useMemo(() => extractTimeFromLectureTime(lecture?.lecture_time), [lecture?.lecture_time]);

  const defaultTitle =
    sessionType === "n+1" ? `${nextOrder}차시` : sessionType === "supplement" ? "보강" : "";

  // 보강 선택 시 날짜·시간 모두 직접선택만 가능
  useEffect(() => {
    if (sessionType === "supplement") {
      setDateMode("custom");
      setTimeMode("custom");
    } else if (sessionType === "n+1") {
      // N차시 선택 시 항상 기본 선택값으로 초기화 (보강→2차시 전환 시 복원)
      setDateMode("default");
      setTimeMode("default");
    }
  }, [sessionType]);

  // 직접선택으로 전환 시 시간이 비어 있으면 강의 기본 시간을 초기값으로 설정 (버튼 활성화용)
  useEffect(() => {
    if ((timeMode === "custom" || sessionType === "supplement") && !timeInput.trim() && lectureTimeExtract) {
      setTimeInput(lectureTimeExtract);
    }
  }, [timeMode, sessionType, lectureTimeExtract]); // timeInput 제외하여 무한 루프 방지

  // N+1 + 날짜 기본값 사용 시 날짜 자동 채우기 (다음 주 같은 요일)
  useEffect(() => {
    if (sessionType === "n+1" && dateMode === "default" && defaultDateFromLecture) {
      setDate(defaultDateFromLecture);
    }
  }, [sessionType, dateMode, defaultDateFromLecture]);

  useEffect(() => {
    function onKeyDown(e: KeyboardEvent) {
      if (e.key === "Escape") onClose();
      if ((e.ctrlKey || e.metaKey) && e.key === "Enter") handleSubmit();
    }
    window.addEventListener("keydown", onKeyDown);
    return () => window.removeEventListener("keydown", onKeyDown);
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [sessionType, date, timeMode, timeInput, busy]);

  const effectiveDate = dateMode === "default" ? (defaultDateFromLecture || date) : date;

  function validate(): string | null {
    if (!sessionType) return "차시 유형을 선택하세요.";
    if (!effectiveDate?.trim()) return "날짜를 선택하세요.";
    if (sessionType === "supplement" || timeMode === "custom") {
      if (!timeInput.trim()) return "시간을 입력하세요.";
    }
    return null;
  }

  async function handleSubmit() {
    if (busy) return;
    const err = validate();
    if (err) return alert(err);

    let title = defaultTitle;
    const timeStr =
      sessionType === "supplement" || timeMode === "custom"
        ? timeInput.trim()
        : lectureTimeExtract || lectureTimeRaw;
    if (timeStr) title = `${title} (${timeStr})`;

    setBusy(true);
    try {
      await createSession(lectureId, title, effectiveDate || undefined, nextOrder);
      onClose();
    } finally {
      setBusy(false);
    }
  }

  const isSupplement = sessionType === "supplement";
  const showDefaultDateOption = sessionType === "n+1";
  const showDefaultTimeOption = sessionType === "n+1";

  return (
    <AdminModal open={true} onClose={onClose} type="action" width={620}>
      <ModalHeader
        type="action"
        title="차시 추가"
        description="⌘/Ctrl + Enter 로 저장"
      />

      <ModalBody>
        <div className="modal-scroll-body grid gap-6 w-full max-w-full box-border">
          {/* 차시 유형: 2차시 / 보강 (전역 SessionBlockView SSOT) */}
          <div>
            <div className="modal-section-label mb-3">차시 유형</div>
            <div className="grid grid-cols-2 gap-5">
              <SessionBlockView
                variant="n1"
                compact={false}
                selected={sessionType === "n+1"}
                showCheck
                title={`${nextOrder}차시`}
                desc="정규 차시 추가 · 기본 날짜/시간 사용"
                onClick={() => setSessionType("n+1")}
                ariaPressed={sessionType === "n+1"}
              />
              <SessionBlockView
                variant="supplement"
                compact={false}
                selected={sessionType === "supplement"}
                showCheck
                title="보강"
                desc="보강 차시 · 날짜·시간 직접 선택"
                onClick={() => setSessionType("supplement")}
                ariaPressed={sessionType === "supplement"}
              />
            </div>
          </div>

          {sessionType && (
            <>
              <ModalDateSection
                name="dateMode"
                useDefault={dateMode === "default"}
                onUseDefaultChange={(use) => setDateMode(use ? "default" : "custom")}
                customDate={date}
                onCustomDateChange={setDate}
                showDefaultOption={showDefaultDateOption}
                disableDefaultOption={isSupplement}
                defaultLabel={
                  defaultDateFromLecture
                    ? lastRegularSessionWithDate?.date
                      ? `다음 주 같은 요일 (${defaultDateFromLecture})`
                      : `강의 시작일 (${defaultDateFromLecture})`
                    : "미설정"
                }
                placeholder="날짜 선택"
                disabled={busy}
              />
              <ModalTimeSection
                name="timeMode"
                useDefault={timeMode === "default"}
                onUseDefaultChange={(use) => setTimeMode(use ? "default" : "custom")}
                customTime={timeInput}
                onCustomTimeChange={setTimeInput}
                showDefaultOption={showDefaultTimeOption}
                disableDefaultOption={isSupplement}
                defaultLabel={lectureTimeRaw || "미설정"}
                disabled={busy}
              />
            </>
          )}
        </div>
      </ModalBody>

      <ModalFooter
        left={
          <span className="text-[12px] font-semibold text-[var(--color-text-muted)]">
            ESC 로 닫기
          </span>
        }
        right={
          <>
            <Button intent="secondary" onClick={onClose} disabled={busy}>
              취소
            </Button>
            <Button intent="primary" onClick={handleSubmit} disabled={busy}>
              {busy ? "저장 중…" : "저장"}
            </Button>
          </>
        }
      />
    </AdminModal>
  );
}


==========================================================================================
# FILE: components/SessionEnrollModal.tsx
==========================================================================================
// PATH: src/features/lectures/components/SessionEnrollModal.tsx
// 차시(세션) 수강생 등록 — 기존 학생 추가(전체 명단 테이블) | 신규 학생 추가(학생추가모달)

import { useEffect, useLayoutEffect, useMemo, useRef, useState } from "react";
import { createPortal } from "react-dom";
import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { fetchSessionEnrollments, lectureEnrollFromExcelUpload } from "../api/enrollments";
import type { SessionEnrollmentRow } from "../api/enrollments";
import { fetchSessions } from "../api/sessions";
import { bulkCreateAttendance, updateAttendance } from "../api/attendance";
import { fetchStudents } from "@/features/students/api/students";
import type { ClientStudent } from "@/features/students/api/students";
import StudentCreateModal from "@/features/students/components/StudentCreateModal";
import StudentsDetailOverlay from "@/features/students/overlays/StudentsDetailOverlay";
import StudentNameWithLectureChip from "@/shared/ui/chips/StudentNameWithLectureChip";
import ExcelUploadZone from "@/shared/ui/excel/ExcelUploadZone";
import { AdminModal, ModalBody, ModalFooter, ModalHeader } from "@/shared/ui/modal";
import { Button, EmptyState, Tabs } from "@/shared/ui/ds";
import { TABLE_COL } from "@/shared/ui/domain";
import { formatPhone } from "@/shared/utils/formatPhone";
import { feedback } from "@/shared/ui/feedback/feedback";
import { asyncStatusStore } from "@/shared/ui/asyncStatus";

const PAGE_SIZE = 10;
/** 탭 디자인 유지. '신규 학생 추가' 클릭 시 탭 전환 없이 학생추가 모달만 연다 */
const ENROLL_TABS = [
  { key: "existing", label: "기존 학생 추가" },
  { key: "new", label: "신규 학생 추가" },
];

function TrashIcon({ className }: { className?: string }) {
  return (
    <svg
      xmlns="http://www.w3.org/2000/svg"
      fill="none"
      viewBox="0 0 24 24"
      strokeWidth={1.8}
      stroke="currentColor"
      className={className}
      aria-hidden
    >
      <path
        strokeLinecap="round"
        strokeLinejoin="round"
        d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0"
      />
    </svg>
  );
}

const PAGINATION_ICON_SIZE = 22;
function FirstPageIcon({ className }: { className?: string }) {
  return (
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" className={className} aria-hidden width={PAGINATION_ICON_SIZE} height={PAGINATION_ICON_SIZE}>
      <path d="M18.41 16.59L13.82 12l4.59-4.59L17 6l-6 6 6 6zM6 6h2v12H6z" />
    </svg>
  );
}
function PrevPageIcon({ className }: { className?: string }) {
  return (
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" className={className} aria-hidden width={PAGINATION_ICON_SIZE} height={PAGINATION_ICON_SIZE}>
      <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z" />
    </svg>
  );
}
function NextPageIcon({ className }: { className?: string }) {
  return (
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" className={className} aria-hidden width={PAGINATION_ICON_SIZE} height={PAGINATION_ICON_SIZE}>
      <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z" />
    </svg>
  );
}
function LastPageIcon({ className }: { className?: string }) {
  return (
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" className={className} aria-hidden width={PAGINATION_ICON_SIZE} height={PAGINATION_ICON_SIZE}>
      <path d="M5.59 7.41L10.18 12l-4.59 4.59L7 18l6-6-6-6zM18 6v12h-2V6z" />
    </svg>
  );
}

interface Props {
  lectureId: number;
  sessionId: number;
  isOpen: boolean;
  onClose: () => void;
  onSuccess?: () => void;
}

type LectureChipInfo = { lectureName: string; color?: string | null; chipLabel?: string | null };
type SelectedItem = {
  id: number;
  name: string;
  profilePhotoUrl?: string | null;
  enrollments?: LectureChipInfo[];
};

export default function SessionEnrollModal({
  lectureId,
  sessionId,
  isOpen,
  onClose,
  onSuccess,
}: Props) {
  const qc = useQueryClient();
  const [overlayStudentId, setOverlayStudentId] = useState<number | null>(null);
  const [activeTab, setActiveTab] = useState("existing");
  const [keyword, setKeyword] = useState("");
  const [search, setSearch] = useState("");
  const [page, setPage] = useState(1);
  const [selectedItems, setSelectedItems] = useState<SelectedItem[]>([]);
  const [studentCreateOpen, setStudentCreateOpen] = useState(false);
  const [sort, setSort] = useState("name");
  const [filters, setFilters] = useState<{ school_type?: string; grade?: number }>({});
  const [popover, setPopover] = useState<"school" | "grade" | null>(null);
  const [popoverAnchor, setPopoverAnchor] = useState<{ left: number; top: number } | null>(null);
  const [selectingAll, setSelectingAll] = useState(false);
  const [excelUploading, setExcelUploading] = useState(false);
  /** 엑셀에서 파싱한 출결 값 (학생 ID → API status). 등록 후 PATCH에 사용 */
  const [excelStatusByStudentId, setExcelStatusByStudentId] = useState<Record<number, string>>({});
  /** 차시 엑셀 일괄등록: 선택된 파일 + 초기 비밀번호 (동일 워커 로직) */
  const [excelPendingFile, setExcelPendingFile] = useState<File | null>(null);
  const [excelInitialPassword, setExcelInitialPassword] = useState("");
  const popoverRef = useRef<HTMLDivElement>(null);
  const schoolTriggerRef = useRef<HTMLTableCellElement>(null);
  const gradeTriggerRef = useRef<HTMLTableCellElement>(null);

  useEffect(() => {
    const t = setTimeout(() => setSearch(keyword.trim()), 300);
    return () => clearTimeout(t);
  }, [keyword]);

  useLayoutEffect(() => {
    if (popover === null) {
      setPopoverAnchor(null);
      return;
    }
    const el = popover === "school" ? schoolTriggerRef.current : gradeTriggerRef.current;
    if (!el) return;
    const rect = el.getBoundingClientRect();
    setPopoverAnchor({ left: rect.left, top: rect.top });
  }, [popover]);

  useEffect(() => {
    if (popover === null) return;
    const close = (e: MouseEvent) => {
      const target = e.target as Node;
      if (schoolTriggerRef.current?.contains(target) || gradeTriggerRef.current?.contains(target)) return;
      if (popoverRef.current?.contains(target)) return;
      setPopover(null);
    };
    document.addEventListener("mousedown", close);
    return () => document.removeEventListener("mousedown", close);
  }, [popover]);

  const { data: sessionEnrollments = [] } = useQuery({
    queryKey: ["session-enrollments", sessionId],
    queryFn: () => fetchSessionEnrollments(sessionId),
    enabled: isOpen && Number.isFinite(sessionId),
  });

  const { data: sessions = [] } = useQuery({
    queryKey: ["lecture-sessions", lectureId],
    queryFn: () => fetchSessions(lectureId),
    enabled: isOpen && Number.isFinite(lectureId),
  });

  const sortedSessions = useMemo(
    () => [...sessions].sort((a, b) => (a.order ?? 0) - (b.order ?? 0)),
    [sessions]
  );
  const prevSession = useMemo(() => {
    const idx = sortedSessions.findIndex((s) => s.id === sessionId);
    if (idx <= 0) return null;
    return sortedSessions[idx - 1];
  }, [sortedSessions, sessionId]);

  const alreadyEnrolledIds = useMemo(
    () => new Set(sessionEnrollments.map((se) => se.enrollment)),
    [sessionEnrollments]
  );

  /** 이미 해당 차시에 등록된 학생 ID — 목록에서 제외·선택 목록 중복 방지용 */
  const alreadyEnrolledStudentIds = useMemo(
    () =>
      new Set(
        sessionEnrollments
          .map((se) => se.student_id)
          .filter((id): id is number => id != null && Number.isFinite(id))
      ),
    [sessionEnrollments]
  );

  const apiFilters = useMemo(() => {
    const base: Record<string, unknown> = { page_size: PAGE_SIZE };
    if (filters.school_type != null && String(filters.school_type).trim() !== "") {
      base.school_type = filters.school_type;
    }
    if (filters.grade != null && Number.isInteger(filters.grade)) {
      base.grade = filters.grade;
    }
    return base;
  }, [filters]);

  const { data: studentsData, isLoading: loadingStudents } = useQuery({
    queryKey: ["session-enroll-modal-students", search, apiFilters, sort, page],
    queryFn: () => fetchStudents(search, apiFilters, sort, page),
    enabled: isOpen && activeTab === "existing",
    refetchOnMount: "always",
    staleTime: 0,
  });

  const students = studentsData?.data ?? [];
  const totalCount = studentsData?.count ?? 0;
  const totalPages = Math.max(1, Math.ceil(totalCount / PAGE_SIZE));

  /** 테이블에 표시할 학생만 (이미 해당 차시 등록된 학생 제외) */
  const studentsToShow = useMemo(
    () => students.filter((s) => !alreadyEnrolledStudentIds.has(s.id)),
    [students, alreadyEnrolledStudentIds]
  );

  /** 실제로 추가할 학생 ID만 (이미 등록된 학생 제외) */
  const idsToAdd = useMemo(
    () => selectedItems.map((s) => s.id).filter((id) => !alreadyEnrolledStudentIds.has(id)),
    [selectedItems, alreadyEnrolledStudentIds]
  );

  const handleSort = (colKey: string) => {
    setSort((prev) => {
      if (prev === colKey) return `-${colKey}`;
      if (prev === `-${colKey}`) return "";
      return colKey;
    });
    setPage(1);
  };

  const sortIcon = (colKey: string) => {
    const isAsc = sort === colKey;
    const isDesc = sort === `-${colKey}`;
    const opacity = isAsc || isDesc ? 1 : 0.4;
    return (
      <span className="ml-0.5 text-[10px] text-[var(--color-text-muted)]" style={{ opacity }} aria-hidden>
        {isAsc ? "▲" : isDesc ? "▼" : "⇅"}
      </span>
    );
  };

  const addByStudentMutation = useMutation({
    mutationFn: async (payload: {
      studentIds: number[];
      statusByStudentId?: Record<number, string>;
    }) => {
      const created = await bulkCreateAttendance(sessionId, payload.studentIds);
      return { created: Array.isArray(created) ? created : created?.results ?? [], payload };
    },
    onSuccess: async (result) => {
      const { created, payload } = result;
      const { studentIds, statusByStudentId } = payload;
      qc.invalidateQueries({ queryKey: ["session-enrollments", sessionId] });
      qc.invalidateQueries({ queryKey: ["attendance", sessionId] });
      qc.invalidateQueries({ queryKey: ["attendance-matrix", lectureId] });
      qc.invalidateQueries({ queryKey: ["lecture-enrollments", lectureId] });
      if (statusByStudentId && created.length) {
        for (let i = 0; i < created.length; i++) {
          const studentId = studentIds[i];
          const status = statusByStudentId[studentId];
          if (status && created[i]?.id) {
            try {
              await updateAttendance(created[i].id, { status });
            } catch {
              // 개별 PATCH 실패 시 무시(목록은 이미 반영됨)
            }
          }
        }
      }
      setExcelStatusByStudentId({});
      setSelectedItems([]);
      onSuccess?.();
      onClose();
    },
  });

  const [copyFromPrevLoading, setCopyFromPrevLoading] = useState(false);

  const handleCopyFromPrevToSelection = async () => {
    if (!prevSession) return;
    setCopyFromPrevLoading(true);
    try {
      const prevList = await fetchSessionEnrollments(prevSession.id);
      const toAddRows = prevList.filter((se) => !alreadyEnrolledIds.has(se.enrollment));
      const itemsToAdd: SelectedItem[] = toAddRows
        .filter((se): se is SessionEnrollmentRow & { student_id: number } => se.student_id != null)
        .map((se) => ({ id: se.student_id, name: se.student_name ?? "-" })); /* 직전 차시는 id/name만 있음 */
      if (itemsToAdd.length === 0) {
        feedback.info("가져올 새 수강생이 없습니다. (이미 모두 등록됨)");
        return;
      }
      setSelectedItems((prev) => {
        const byId = new Map(prev.map((s) => [s.id, s]));
        itemsToAdd.forEach((item) => byId.set(item.id, item));
        return Array.from(byId.values());
      });
      feedback.success(`직전 차시에서 ${itemsToAdd.length}명을 선택 목록에 추가했습니다. 아래에서 확인 후 'N명 추가'로 등록하세요.`);
    } catch (e) {
      feedback.error(e instanceof Error ? e.message : "가져오기 실패");
    } finally {
      setCopyFromPrevLoading(false);
    }
  };

  useEffect(() => {
    function onKeyDown(e: KeyboardEvent) {
      if (!isOpen) return;
      if (e.key === "Escape") onClose();
        if ((e.ctrlKey || e.metaKey) && e.key === "Enter") {
          if (idsToAdd.length > 0 && !addByStudentMutation.isPending) {
            addByStudentMutation.mutate({
            studentIds: idsToAdd,
            statusByStudentId: excelStatusByStudentId,
          });
        }
      }
    }
    window.addEventListener("keydown", onKeyDown);
    return () => window.removeEventListener("keydown", onKeyDown);
  }, [isOpen, idsToAdd, excelStatusByStudentId, addByStudentMutation]);

  if (!isOpen) return null;

  const selectedIds = useMemo(() => new Set(selectedItems.map((s) => s.id)), [selectedItems]);

  const toggleSelect = (student: ClientStudent) => {
    const id = student.id;
    const name = student.name ?? "-";
    const profilePhotoUrl = student.profilePhotoUrl ?? undefined;
    const enrollments: LectureChipInfo[] = Array.isArray(student.enrollments)
      ? student.enrollments.map((en) => ({
          lectureName: en.lectureName ?? "??",
          color: en.lectureColor ?? undefined,
          chipLabel: (en as { lectureChipLabel?: string | null }).lectureChipLabel ?? undefined,
        }))
      : [];
    setSelectedItems((prev) => {
      if (prev.some((s) => s.id === id)) return prev.filter((s) => s.id !== id);
      return [...prev, { id, name, profilePhotoUrl, enrollments }];
    });
  };

  const isAllSelected = totalCount > 0 && selectedItems.length === totalCount;

  /** 전체 선택 시 DB 요청 최소화: 백엔드 max_page_size(100)로 페이지당 100명씩만 요청 */
  const SELECT_ALL_PAGE_SIZE = 100;

  const toggleSelectAllFull = async () => {
    if (isAllSelected) {
      setSelectedItems([]);
      return;
    }
    setSelectingAll(true);
    try {
      const all: ClientStudent[] = [];
      const selectAllFilters = { ...apiFilters, page_size: SELECT_ALL_PAGE_SIZE };
      let p = 1;
      while (true) {
        const { data } = await fetchStudents(search, selectAllFilters, sort, p);
        if (!data?.length) break;
        all.push(...data);
        if (data.length < SELECT_ALL_PAGE_SIZE) break;
        p += 1;
      }
      setSelectedItems(
        all
          .filter((s) => !alreadyEnrolledStudentIds.has(s.id))
          .map((s) => ({
            id: s.id,
            name: s.name ?? "-",
            profilePhotoUrl: s.profilePhotoUrl ?? undefined,
            enrollments: Array.isArray(s.enrollments)
              ? s.enrollments.map((en) => ({
                  lectureName: en.lectureName ?? "??",
                  color: en.lectureColor ?? undefined,
                  chipLabel: (en as { lectureChipLabel?: string | null }).lectureChipLabel ?? undefined,
                }))
              : [],
          }))
      );
      if (all.length > 0) feedback.success(`전체 ${all.length}명 선택됨`);
    } catch (e) {
      feedback.error("전체 선택 중 오류가 났습니다.");
    } finally {
      setSelectingAll(false);
    }
  };

  const removeSelected = (id: number) => {
    setSelectedItems((prev) => prev.filter((s) => s.id !== id));
  };

  /** 엑셀 파일 선택 시 선택 목록에 넣지 않고, 동일 워커 로직(업로드→job)으로 보낼 파일만 저장 */
  const handleExcelFileSelect = (file: File) => {
    if (excelUploading) return;
    setExcelPendingFile(file);
    setExcelInitialPassword("");
  };

  /** 차시 엑셀 일괄등록 — 강의 엑셀 수강등록과 동일 API·워커 로직 (session_id만 추가) */
  const handleExcelEnrollSubmit = async () => {
    if (!excelPendingFile || excelUploading) return;
    const pwd = excelInitialPassword.trim();
    if (pwd.length < 4) {
      feedback.error("초기 비밀번호는 4자 이상이어야 합니다. (신규 생성 학생 로그인용)");
      return;
    }
    setExcelUploading(true);
    try {
      const { job_id } = await lectureEnrollFromExcelUpload(lectureId, excelPendingFile, pwd, {
        sessionId,
      });
      if (!job_id) {
        feedback.error("작업 ID를 받지 못했습니다. 다시 시도해 주세요.");
        return;
      }
      asyncStatusStore.addWorkerJob("엑셀 수강등록", job_id, "excel_parsing");
      feedback.success(
        "작업이 백그라운드에서 진행됩니다. 우하단에서 진행 상황을 확인할 수 있습니다."
      );
      onSuccess?.();
      onClose();
      setExcelPendingFile(null);
      setExcelInitialPassword("");
    } catch (e) {
      feedback.error(e instanceof Error ? e.message : "등록 요청 중 오류가 발생했습니다.");
    } finally {
      setExcelUploading(false);
    }
  };

  return (
    <>
      <AdminModal open={true} onClose={onClose} type="action" width={840}>
        <ModalHeader
          type="action"
          title="차시 수강생 등록"
          description="기존 학생을 선택해 추가하거나, 신규 학생을 등록한 뒤 차시에 포함할 수 있습니다."
        />

        <ModalBody>
          <div
            className="grid gap-4 min-h-0 overflow-hidden"
            style={{
              gridTemplateColumns: "1fr 220px",
              maxHeight: "min(78vh, 600px)",
              minHeight: activeTab === "existing" ? 480 : undefined,
            }}
          >
            {/* 좌측: 탭(신규 탭은 클릭 시 모달만 열림) + 테이블 */}
            <div className="flex flex-col gap-2 min-h-0 overflow-hidden">
              <div className="modal-tabs-elevated">
                <Tabs
                  value={activeTab}
                  items={ENROLL_TABS}
                  onChange={(key) => {
                    if (key === "new") setStudentCreateOpen(true);
                    else setActiveTab(key);
                  }}
                />
              </div>

              {activeTab === "existing" && (
                <>
                  <div className="flex items-center justify-between gap-2">
                    <span className="text-[13px] font-semibold text-[var(--color-text-primary)]">
                      전체 학생 명단
                    </span>
                    {selectedItems.length > 0 && (
                      <span className="text-[13px] font-semibold text-[var(--color-brand-primary)]">
                        {selectedItems.length}명 선택됨
                      </span>
                    )}
                  </div>
                  <input
                    value={keyword}
                    onChange={(e) => setKeyword(e.target.value)}
                    placeholder="검색어 입력 (이름·전화번호)"
                    className="ds-input w-full text-sm"
                    autoFocus
                    aria-label="이름 또는 전화번호로 검색"
                  />
                  <div
                    className="rounded-xl border overflow-hidden flex flex-col"
                    style={{
                      borderColor: "var(--color-border-divider)",
                      background: "var(--color-bg-surface)",
                    }}
                  >
                    <div className="shrink-0 modal-inner-table">
                      {loadingStudents ? (
                        <EmptyState
                          mode="embedded"
                          scope="panel"
                          tone="loading"
                          title="불러오는 중…"
                        />
                      ) : (
                        <table
                          className="w-full border-collapse"
                          style={{ tableLayout: "fixed" }}
                          role="grid"
                          aria-label="전체 학생 명단"
                        >
                          <colgroup>
                            <col style={{ width: TABLE_COL.checkbox }} />
                            <col style={{ width: TABLE_COL.nameCompactModal }} />
                            <col style={{ width: TABLE_COL.phoneCompact }} />
                            <col style={{ width: TABLE_COL.phoneCompact }} />
                            <col style={{ width: TABLE_COL.mediumModal }} />
                            <col style={{ width: TABLE_COL.shortModal }} />
                          </colgroup>
                          <thead>
                            <tr
                              className="sticky top-0 z-10"
                              style={{ background: "var(--color-bg-surface)" }}
                            >
                              <th
                                className="modal-inner-table__checkbox-cell border-b py-1.5 pl-2 pr-1 text-left text-[var(--color-text-muted)]"
                                style={{ borderColor: "var(--color-border-divider)" }}
                              >
                                <input
                                  type="checkbox"
                                  checked={isAllSelected}
                                  disabled={selectingAll || loadingStudents}
                                  onChange={() => toggleSelectAllFull()}
                                  aria-label="전체 선택 (검색·필터 결과 전체)"
                                  title={isAllSelected ? "선택택 해제" : "검색·필터 결과 전체 선택"}
                                />
                              </th>
                              <th
                                className="modal-inner-table__name-th border-b py-1.5 px-3 text-left text-[var(--color-text-muted)] cursor-pointer select-none hover:text-[var(--color-text-primary)]"
                                style={{ borderColor: "var(--color-border-divider)" }}
                                onClick={() => handleSort("name")}
                                aria-sort={sort === "name" ? "ascending" : sort === "-name" ? "descending" : "none"}
                              >
                                이름 {sortIcon("name")}
                              </th>
                              <th
                                className="border-b py-1.5 px-3 text-left text-[var(--color-text-muted)] cursor-pointer select-none hover:text-[var(--color-text-primary)]"
                                style={{ borderColor: "var(--color-border-divider)" }}
                                onClick={() => handleSort("parentPhone")}
                                aria-sort={sort === "parentPhone" ? "ascending" : sort === "-parentPhone" ? "descending" : "none"}
                              >
                                부모님 전화 {sortIcon("parentPhone")}
                              </th>
                              <th
                                className="border-b py-1.5 px-3 text-left text-[var(--color-text-muted)] cursor-pointer select-none hover:text-[var(--color-text-primary)]"
                                style={{ borderColor: "var(--color-border-divider)" }}
                                onClick={() => handleSort("studentPhone")}
                                aria-sort={sort === "studentPhone" ? "ascending" : sort === "-studentPhone" ? "descending" : "none"}
                              >
                                학생 전화 {sortIcon("studentPhone")}
                              </th>
                              <th
                                ref={schoolTriggerRef}
                                className="border-b py-1.5 px-3 text-left text-[var(--color-text-muted)] cursor-pointer select-none hover:text-[var(--color-text-primary)] relative"
                                style={{ borderColor: "var(--color-border-divider)" }}
                                onClick={(e) => { e.stopPropagation(); setPopover((p) => (p === "school" ? null : "school")); }}
                                aria-haspopup="true"
                                aria-expanded={popover === "school"}
                                title="클릭 시 고등/중등 필터"
                              >
                                {filters.school_type === "HIGH" ? "고등학교" : filters.school_type === "MIDDLE" ? "중학교" : "학교 이름"}
                              </th>
                              <th
                                ref={gradeTriggerRef}
                                className="border-b py-1.5 px-3 text-left text-[var(--color-text-muted)] cursor-pointer select-none hover:text-[var(--color-text-primary)] relative"
                                style={{ borderColor: "var(--color-border-divider)" }}
                                onClick={(e) => { e.stopPropagation(); setPopover((p) => (p === "grade" ? null : "grade")); }}
                                aria-haspopup="true"
                                aria-expanded={popover === "grade"}
                              >
                                {filters.grade != null ? `${filters.grade}학년` : "학년"}
                              </th>
                            </tr>
                          </thead>
                          <tbody>
                            {studentsToShow.length === 0 ? (
                              <tr>
                                <td
                                  colSpan={6}
                                  className="py-5 px-3 text-center text-[var(--color-text-muted)]"
                                >
                                  검색 결과 없음. 검색어·필터를 바꿔 보세요.
                                </td>
                              </tr>
                            ) : (
                              studentsToShow.map((row) => {
                                const checked = selectedIds.has(row.id);
                                const openStudentDetail = () => setOverlayStudentId(row.id);
                                return (
                                  <tr
                                    key={row.id}
                                    className={`border-b ${checked ? "bg-[var(--color-bg-surface-soft)]" : ""}`}
                                    style={{ borderColor: "var(--color-border-divider)" }}
                                  >
                                    <td
                                      className="modal-inner-table__checkbox-cell py-1.5 pl-2 pr-1"
                                      onClick={(e) => e.stopPropagation()}
                                    >
                                      <input
                                        type="checkbox"
                                        checked={checked}
                                        onChange={() => toggleSelect(row)}
                                        aria-label={`${row.name} 선택`}
                                      />
                                    </td>
                                    <td
                                      className="modal-inner-table__name py-1.5 px-3 text-[var(--color-text-primary)] truncate cursor-pointer hover:bg-[var(--color-bg-surface-soft)]"
                                      onClick={openStudentDetail}
                                      role="button"
                                      tabIndex={0}
                                      onKeyDown={(e) => { if (e.key === "Enter" || e.key === " ") { e.preventDefault(); openStudentDetail(); } }}
                                    >
                                      <StudentNameWithLectureChip
                                        name={row.name ?? "-"}
                                        profilePhotoUrl={row.profilePhotoUrl ?? undefined}
                                        avatarSize={20}
                                        lectures={
                                          Array.isArray(row.enrollments) && row.enrollments.length > 0
                                            ? row.enrollments.map((en: { id: number; lectureName: string | null; lectureColor?: string | null; lectureChipLabel?: string | null }) => ({
                                                lectureName: en.lectureName ?? "??",
                                                color: en.lectureColor ?? undefined,
                                                chipLabel: en.lectureChipLabel ?? undefined,
                                              }))
                                            : undefined
                                        }
                                        chipSize={14}
                                      />
                                    </td>
                                    <td
                                      className="py-1.5 px-3 text-[var(--color-text-secondary)] truncate cursor-pointer hover:bg-[var(--color-bg-surface-soft)] leading-6"
                                      onClick={openStudentDetail}
                                      role="button"
                                      tabIndex={0}
                                      onKeyDown={(e) => { if (e.key === "Enter" || e.key === " ") { e.preventDefault(); openStudentDetail(); } }}
                                    >
                                      {formatPhone(row.parentPhone ?? "") || "미입력"}
                                    </td>
                                    <td
                                      className="py-1.5 px-3 text-[var(--color-text-secondary)] truncate cursor-pointer hover:bg-[var(--color-bg-surface-soft)] leading-6"
                                      onClick={openStudentDetail}
                                      role="button"
                                      tabIndex={0}
                                      onKeyDown={(e) => { if (e.key === "Enter" || e.key === " ") { e.preventDefault(); openStudentDetail(); } }}
                                    >
                                      {formatPhone(row.studentPhone ?? "") || "미입력"}
                                    </td>
                                    <td
                                      className="py-1.5 px-3 text-[var(--color-text-secondary)] truncate cursor-pointer hover:bg-[var(--color-bg-surface-soft)] leading-6"
                                      title="학교 이름"
                                      onClick={openStudentDetail}
                                      role="button"
                                      tabIndex={0}
                                      onKeyDown={(e) => { if (e.key === "Enter" || e.key === " ") { e.preventDefault(); openStudentDetail(); } }}
                                    >
                                      {row.school || "-"}
                                    </td>
                                    <td
                                      className="py-1.5 px-3 text-[var(--color-text-secondary)] cursor-pointer hover:bg-[var(--color-bg-surface-soft)] leading-6"
                                      onClick={openStudentDetail}
                                      role="button"
                                      tabIndex={0}
                                      onKeyDown={(e) => { if (e.key === "Enter" || e.key === " ") { e.preventDefault(); openStudentDetail(); } }}
                                    >
                                      {row.grade != null ? `${row.grade}학년` : "-"}
                                    </td>
                                  </tr>
                                );
                              })
                            )}
                          </tbody>
                        </table>
                      )}
                    </div>
                    {overlayStudentId != null &&
                      createPortal(
                        <StudentsDetailOverlay
                          studentId={overlayStudentId}
                          onClose={() => setOverlayStudentId(null)}
                        />,
                        document.body
                      )}
                    {popover !== null && popoverAnchor && createPortal(
                      <div
                        ref={popoverRef}
                        className="fixed flex items-center gap-2 rounded-lg border p-2 shadow-lg"
                        style={{
                          left: popoverAnchor.left,
                          top: popoverAnchor.top,
                          transform: "translateY(-100%)",
                          marginTop: -4,
                          zIndex: 9999,
                          background: "var(--color-bg-surface)",
                          borderColor: "var(--color-border-divider)",
                        }}
                        onClick={(e) => e.stopPropagation()}
                      >
                        {popover === "school" &&
                          [
                            { value: "", label: "전체" },
                            { value: "HIGH", label: "고등학교" },
                            { value: "MIDDLE", label: "중학교" },
                          ].map((opt) => {
                            const selected = opt.value ? filters.school_type === opt.value : !filters.school_type;
                            return (
                              <Button
                                key={opt.value || "all"}
                                type="button"
                                intent={selected ? "primary" : "secondary"}
                                size="sm"
                                className="!min-w-[72px]"
                                onClick={() => {
                                  setFilters((f) => (opt.value ? { ...f, school_type: opt.value } : { ...f, school_type: undefined }));
                                  setPage(1);
                                  setPopover(null);
                                }}
                              >
                                {opt.label}
                              </Button>
                            );
                          })}
                        {popover === "grade" &&
                          [
                            { value: undefined, label: "전체" },
                            { value: 1, label: "1학년" },
                            { value: 2, label: "2학년" },
                            { value: 3, label: "3학년" },
                          ].map((opt) => {
                            const selected = opt.value != null ? filters.grade === opt.value : filters.grade == null;
                            return (
                              <Button
                                key={opt.value ?? "all"}
                                type="button"
                                intent={selected ? "primary" : "secondary"}
                                size="sm"
                                className="!min-w-[64px]"
                                onClick={() => {
                                  setFilters((f) => (opt.value != null ? { ...f, grade: opt.value } : { ...f, grade: undefined }));
                                  setPage(1);
                                  setPopover(null);
                                }}
                              >
                                {opt.label}
                              </Button>
                            );
                          })}
                      </div>,
                      document.body
                    )}
                    {/* 페이지네이션: 큼지막한 아이콘, 항상 표시 (학생 데이터 있을 때) */}
                    {(studentsToShow.length > 0 || totalCount > 0) && (
                      <div
                        className="flex items-center justify-between gap-3 py-2.5 px-3 border-t shrink-0 bg-[var(--color-bg-surface)]"
                        style={{ borderColor: "var(--color-border-divider)" }}
                      >
                        <span className="text-[13px] font-semibold text-[var(--color-text-primary)]">
                          총 {totalCount > 0 ? totalCount.toLocaleString() : studentsToShow.length}명
                        </span>
                        <div className="flex items-center gap-1">
                          <Button
                            type="button"
                            intent="ghost"
                            size="sm"
                            disabled={page <= 1}
                            onClick={() => setPage(1)}
                            aria-label="첫 페이지"
                            className="!min-w-10 !h-10 !p-0 flex items-center justify-center rounded-lg text-[var(--color-text-secondary)] hover:text-[var(--color-text-primary)] hover:bg-[var(--color-bg-surface-hover)] disabled:opacity-40"
                          >
                            <FirstPageIcon />
                          </Button>
                          <Button
                            type="button"
                            intent="ghost"
                            size="sm"
                            disabled={page <= 1}
                            onClick={() => setPage((p) => Math.max(1, p - 1))}
                            aria-label="이전 페이지"
                            className="!min-w-10 !h-10 !p-0 flex items-center justify-center rounded-lg text-[var(--color-text-secondary)] hover:text-[var(--color-text-primary)] hover:bg-[var(--color-bg-surface-hover)] disabled:opacity-40"
                          >
                            <PrevPageIcon />
                          </Button>
                          <span className="text-[13px] font-semibold text-[var(--color-text-primary)] px-3 min-w-[4.5rem] text-center">
                            {page} / {totalPages}
                          </span>
                          <Button
                            type="button"
                            intent="ghost"
                            size="sm"
                            disabled={page >= totalPages}
                            onClick={() => setPage((p) => Math.min(totalPages, p + 1))}
                            aria-label="다음 페이지"
                            className="!min-w-10 !h-10 !p-0 flex items-center justify-center rounded-lg text-[var(--color-text-secondary)] hover:text-[var(--color-text-primary)] hover:bg-[var(--color-bg-surface-hover)] disabled:opacity-40"
                          >
                            <NextPageIcon />
                          </Button>
                          <Button
                            type="button"
                            intent="ghost"
                            size="sm"
                            disabled={page >= totalPages}
                            onClick={() => setPage(totalPages)}
                            aria-label="마지막 페이지"
                            className="!min-w-10 !h-10 !p-0 flex items-center justify-center rounded-lg text-[var(--color-text-secondary)] hover:text-[var(--color-text-primary)] hover:bg-[var(--color-bg-surface-hover)] disabled:opacity-40"
                          >
                            <LastPageIcon />
                          </Button>
                        </div>
                      </div>
                    )}
                  </div>
                </>
              )}
            </div>

            {/* 우측: 불러오기 + 선택 목록 (고정 높이, 모달 크기 불변) */}
            <div
              className="flex flex-col gap-4 rounded-xl border p-4 w-[220px] shrink-0 self-stretch min-h-0 overflow-hidden"
              style={{
                borderColor: "var(--color-border-divider)",
                background: "var(--color-bg-surface)",
              }}
            >
              <section className="shrink-0 space-y-5">
                <div className="py-0.5">
                  <Button
                    type="button"
                    intent="secondary"
                    size="sm"
                    className="w-full"
                  disabled={!prevSession || copyFromPrevLoading}
                  onClick={() => prevSession && handleCopyFromPrevToSelection()}
                  title={prevSession ? `직전 차시(${prevSession.order ?? "?"}차시) 수강생을 선택 목록에만 넣습니다.` : undefined}
                  aria-label={prevSession ? `직전 차시 ${prevSession.order ?? "?"}차시 수강생 선택 목록에 추가` : "직전 차시에서 (1차시는 해당 없음)"}
                >
                  {copyFromPrevLoading
                    ? "가져오는 중…"
                    : prevSession
                      ? `직전 차시(${prevSession.order ?? "?"}차시)에서 불러오기`
                      : "직전 차시에서 불러오기"}
                  </Button>
                </div>
                {excelPendingFile ? (
                  <div className="excel-upload-zone excel-upload-zone--filled flex flex-col items-stretch justify-center gap-3 py-4 px-3">
                    <p className="text-[13px] font-medium text-[var(--color-text-primary)] truncate text-center" title={excelPendingFile.name}>
                      {excelPendingFile.name}
                    </p>
                    <label className="text-[12px] font-medium text-[var(--color-text-secondary)]">초기 비밀번호</label>
                    <input
                      type="password"
                      value={excelInitialPassword}
                      onChange={(e) => setExcelInitialPassword(e.target.value)}
                      placeholder="4자 이상"
                      className="ds-input w-full text-[13px]"
                      minLength={4}
                      aria-label="초기 비밀번호"
                    />
                    <div className="flex gap-2">
                      <Button
                        type="button"
                        intent="primary"
                        size="sm"
                        onClick={handleExcelEnrollSubmit}
                        disabled={excelUploading || excelInitialPassword.trim().length < 4}
                      >
                        {excelUploading ? "등록 중…" : "엑셀로 일괄 등록"}
                      </Button>
                      <Button
                        type="button"
                        intent="secondary"
                        size="sm"
                        onClick={() => { setExcelPendingFile(null); setExcelInitialPassword(""); }}
                        disabled={excelUploading}
                      >
                        취소
                      </Button>
                    </div>
                  </div>
                ) : (
                  <ExcelUploadZone onFileSelect={handleExcelFileSelect} disabled={excelUploading} />
                )}
              </section>

              {/* N명 선택됨 · 선택 해제만 표시 */}
              <section className="flex flex-col min-h-0 flex-1 overflow-hidden">
                <div className="flex flex-wrap items-center gap-2 mb-2 shrink-0 pl-0.5">
                  <span
                    className="text-[13px] font-semibold"
                    style={{
                      color: selectedItems.length > 0 ? "var(--color-primary)" : "var(--color-text-muted)",
                    }}
                  >
                    {selectedItems.length}명 선택됨
                  </span>
                  <span className="text-[var(--color-border-divider)]" aria-hidden>|</span>
                  <Button
                    intent="secondary"
                    size="sm"
                    onClick={() => setSelectedItems([])}
                    disabled={selectedItems.length === 0}
                    className="!text-[13px]"
                  >
                    전체 해제
                  </Button>
                </div>
                <div
                  className="min-h-0 flex-1 overflow-y-auto overflow-x-hidden rounded-lg border p-2 max-h-[310px]"
                  style={{
                    borderColor: "var(--color-border-divider)",
                    background: "var(--color-bg-surface-soft)",
                    WebkitOverflowScrolling: "touch",
                  }}
                >
                  {selectedItems.length === 0 ? (
                    <p className="text-[13px] text-[var(--color-text-muted)] py-4 text-center">
                      선택한 학생이 없어요.
                      <span className="block mt-1.5 text-[11px] text-[var(--color-text-muted)]">
                        왼쪽 테이블에서 체크 후 추가하세요.
                      </span>
                    </p>
                  ) : (
                    <ul className="space-y-0">
                      {selectedItems.map((s) => (
                        <li
                          key={s.id}
                          className="flex items-center justify-between gap-2 py-1.5 px-2 rounded hover:bg-[var(--color-bg-surface)] group min-h-[32px]"
                        >
                          <span className="flex items-center gap-2 min-w-0 flex-1 truncate">
                            {Array.isArray(s.enrollments) && s.enrollments.length > 0 ? (
                              <StudentNameWithLectureChip
                                name={s.name}
                                profilePhotoUrl={s.profilePhotoUrl}
                                avatarSize={20}
                                chipSize={14}
                                lectures={s.enrollments.map((e) => ({
                                  lectureName: e.lectureName,
                                  color: e.color ?? undefined,
                                  chipLabel: e.chipLabel ?? undefined,
                                }))}
                                className="text-[13px] font-semibold leading-6 text-[var(--color-text-primary)]"
                              />
                            ) : (
                              <StudentNameWithLectureChip
                                name={s.name}
                                profilePhotoUrl={s.profilePhotoUrl}
                                avatarSize={20}
                                chipSize={14}
                                className="text-[13px] font-semibold leading-6 text-[var(--color-text-primary)]"
                              />
                            )}
                          </span>
                          <button
                            type="button"
                            onClick={() => removeSelected(s.id)}
                            className="shrink-0 p-1.5 rounded text-[var(--color-text-muted)] hover:text-[var(--color-error)] hover:bg-[color-mix(in_srgb,var(--color-error)_10%,transparent)] transition-colors"
                            aria-label={`${s.name} 선택 해제`}
                            title="선택 해제"
                          >
                            <TrashIcon className="w-4 h-4" />
                          </button>
                        </li>
                      ))}
                    </ul>
                  )}
                </div>
              </section>
            </div>
          </div>
        </ModalBody>

        <ModalFooter
          left={
            <span className="text-[12px] font-semibold text-[var(--color-text-muted)]">
              ESC 닫기 · ⌘/Ctrl + Enter 추가
            </span>
          }
          right={
            <>
              <Button intent="secondary" onClick={onClose} className="text-[13px]">
                취소
              </Button>
              <Button
                intent="primary"
                className="text-[13px]"
                onClick={() =>
                  addByStudentMutation.mutate({
                    studentIds: idsToAdd,
                    statusByStudentId: excelStatusByStudentId,
                  })
                }
                disabled={addByStudentMutation.isPending || idsToAdd.length === 0}
                title={idsToAdd.length === 0 ? "왼쪽 테이블에서 학생을 선택하세요" : undefined}
              >
                {addByStudentMutation.isPending
                  ? "등록 중…"
                  : `${idsToAdd.length}명 추가`}
              </Button>
            </>
          }
        />
      </AdminModal>

      <StudentCreateModal
        open={studentCreateOpen}
        onClose={() => setStudentCreateOpen(false)}
        onSuccess={() => {
          // 학생 추가 후 목록 새로고침: 검색어 초기화 + 첫 페이지로 이동하여 새 학생이 목록에 나타나도록 함
          setKeyword("");
          setSearch("");
          setPage(1);
          setFilters({});
          qc.invalidateQueries({ queryKey: ["session-enroll-modal-students"] });
          setStudentCreateOpen(false);
        }}
      />

    </>
  );
}


==========================================================================================
# FILE: components/SessionVideosTab.tsx
==========================================================================================
// PATH: src/features/lectures/components/SessionVideosTab.tsx
import { useMemo, useState } from "react";
import { Link } from "react-router-dom";
import { useMutation, useQueryClient } from "@tanstack/react-query";

import api from "@/shared/api/axios";
import VideoUploadModal from "@/features/videos/components/features/video-detail/modals/VideoUploadModal";
import VideoThumbnail from "@/features/videos/ui/VideoThumbnail";
import VideoStatusBadge from "@/features/videos/ui/VideoStatusBadge";
import { asyncStatusStore } from "@/shared/ui/asyncStatus";

import { useSessionVideos } from "../hooks/useSessionVideos";
import { Button, EmptyState } from "@/shared/ui/ds";
import { DomainListToolbar } from "@/shared/ui/domain";

/**
 * media 도메인 기준 Video 타입 (관리자 목록용)
 * ⚠️ status 필드 반드시 포함
 */
export interface MediaVideo {
  id: number;
  title: string;
  file: string | null;
  file_key?: string | null;

  source_type: "s3" | "file" | "youtube" | "external" | "unknown";

  youtube_id?: string | null;
  external_url?: string | null;

  duration?: number | null;
  file_size?: number | null;
  thumbnail_url?: string | null;

  allow_skip: boolean;
  max_speed: number;
  show_watermark: boolean;

  status?: "PENDING" | "UPLOADED" | "PROCESSING" | "READY" | "FAILED";

  created_at: string;
}

interface SessionVideosTabProps {
  sessionId: number;
}

export default function SessionVideosTab({ sessionId }: SessionVideosTabProps) {
  const qc = useQueryClient();
  const [showModal, setShowModal] = useState(false);

  const { data: videos = [], isLoading } = useSessionVideos(sessionId);

  const deleteMutation = useMutation({
    mutationFn: async (id: number) => {
      await api.delete(`/media/videos/${id}/`);
    },
    onSuccess: () => {
      qc.invalidateQueries({ queryKey: ["session-videos", sessionId] });
    },
  });

  /** 영상 제목 패턴(예: "수학의 정석 1", "수학의 정석 2")에서 묶음 base 추출. DB 변경 없이 표시용 그룹핑만. */
  const groupedVideos = useMemo(() => {
    const groups = new Map<string, MediaVideo[]>();
    const ungrouped: MediaVideo[] = [];
    const pattern = /^(.+)\s+(\d+)$/;

    for (const v of videos) {
      const m = v.title?.trim().match(pattern);
      if (m) {
        const base = m[1].trim();
        const list = groups.get(base) ?? [];
        list.push(v);
        list.sort((a, b) => {
          const na = parseInt(a.title?.match(/\s+(\d+)$/)?.[1] ?? "0", 10);
          const nb = parseInt(b.title?.match(/\s+(\d+)$/)?.[1] ?? "0", 10);
          return na - nb;
        });
        groups.set(base, list);
      } else {
        ungrouped.push(v);
      }
    }
    return { groups, ungrouped };
  }, [videos]);

  const retryMutation = useMutation({
    mutationFn: async (id: number) => {
      await api.post(`/media/videos/${id}/retry/`);
    },
    onSuccess: (_data, videoId) => {
      qc.invalidateQueries({ queryKey: ["session-videos", sessionId] });
      const video = videos.find((v: MediaVideo) => v.id === videoId);
      const label = video?.title ? `${video.title} 재처리` : `영상 ${videoId} 재처리`;
      asyncStatusStore.addWorkerJob(label, String(videoId), "video_processing");
    },
  });

  const renderVideoCard = (video: MediaVideo) => {
    const fileSize =
      video.file_size && video.file_size > 0 ? `${(video.file_size / 1024 / 1024).toFixed(2)}MB` : "-";
    const uploadDate = video.created_at
      ? new Date(video.created_at).toLocaleString("ko-KR", {
          year: "2-digit",
          month: "2-digit",
          day: "2-digit",
          hour: "2-digit",
          minute: "2-digit",
          hour12: false,
        })
      : "-";

    return (
      <div
        key={video.id}
        style={{
          borderRadius: 14,
          border: "1px solid var(--color-border-divider)",
          background: "var(--color-bg-app)",
          padding: 12,
          transition: "background 120ms ease",
        }}
      >
        <Link to={`${video.id}`} style={{ textDecoration: "none" }}>
          <VideoThumbnail
            title={video.title}
            status={video.status ?? "PENDING"}
            thumbnail_url={video.thumbnail_url}
          />
        </Link>

        <div style={{ marginTop: 10, display: "flex", alignItems: "flex-start", justifyContent: "space-between", gap: 10 }}>
          <div style={{ minWidth: 0 }}>
            <div
              style={{
                fontSize: 14,
                fontWeight: 950,
                color: "var(--color-text-primary)",
                whiteSpace: "nowrap",
                overflow: "hidden",
                textOverflow: "ellipsis",
              }}
            >
              {video.title}
            </div>

            {fileSize !== "-" && (
              <div style={{ marginTop: 2, fontSize: 11, fontWeight: 850, color: "var(--color-text-muted)" }}>
                {fileSize} · {uploadDate}
              </div>
            )}
          </div>

          <div style={{ flex: "0 0 auto" }}>
            <VideoStatusBadge status={video.status} />
          </div>
        </div>

        <div
          style={{
            marginTop: 8,
            display: "flex",
            flexWrap: "wrap",
            alignItems: "center",
            gap: 8,
            fontSize: 11,
            fontWeight: 850,
            color: "var(--color-text-secondary)",
          }}
        >
          <span>
            워터마크:{" "}
            <span style={{ fontWeight: 950, color: video.show_watermark ? "var(--color-primary)" : "var(--color-text-muted)" }}>
              {video.show_watermark ? "표시" : "숨김"}
            </span>
          </span>
          <span style={{ color: "var(--color-text-muted)" }}>·</span>
          <span>
            건너뛰기:{" "}
            <span style={{ fontWeight: 950, color: video.allow_skip ? "var(--color-text-muted)" : "var(--color-primary)" }}>
              {video.allow_skip ? "허용" : "금지"}
            </span>
          </span>
          <span style={{ color: "var(--color-text-muted)" }}>·</span>
          <span>
            배속:{" "}
            <span style={{ fontWeight: 950, color: video.max_speed > 1.0 ? "var(--color-text-muted)" : "var(--color-primary)" }}>
              {video.max_speed.toFixed(2)}x
            </span>
          </span>
        </div>

        <div style={{ marginTop: 10, display: "flex", justifyContent: "flex-end", gap: 8 }}>
          {(video.status === "FAILED" || video.status === "PROCESSING" || video.status === "UPLOADED") && (
            <Button
              intent="primary"
              size="sm"
              disabled={retryMutation.isPending}
              onClick={(e) => {
                e.preventDefault();
                e.stopPropagation();
                const msg =
                  video.status === "PROCESSING"
                    ? "인코딩이 멈춘 것 같습니다. 다시 시도할까요?"
                    : video.status === "UPLOADED"
                      ? "업로드 완료 상태입니다. 인코딩을 큐에 넣을까요?"
                      : "영상 처리를 다시 시도할까요?";
                if (window.confirm(msg)) {
                  retryMutation.mutate(video.id);
                }
              }}
            >
              {video.status === "PROCESSING" ? "다시 시도" : video.status === "UPLOADED" ? "인코딩 요청" : "재처리"}
            </Button>
          )}
          <Button
            intent="ghost"
            size="sm"
            disabled={deleteMutation.isPending}
            onClick={(e) => {
              e.preventDefault();
              e.stopPropagation();
              if (window.confirm("정말 삭제하시겠습니까?")) {
                deleteMutation.mutate(video.id);
              }
            }}
          >
            삭제
          </Button>
        </div>
      </div>
    );
  };

  return (
    <div className="flex flex-col gap-4">
      <DomainListToolbar
        totalLabel={isLoading ? "…" : `총 ${videos.length}개`}
        searchSlot={null}
        primaryAction={
          <Button intent="primary" onClick={() => setShowModal(true)}>
            영상 추가
          </Button>
        }
      />

      <div
        className="ds-panel"
        style={{
          borderRadius: "var(--radius-xl)",
          border: "1px solid var(--color-border-divider)",
          background: "var(--color-bg-surface)",
          padding: "var(--space-4)",
        }}
      >
        {isLoading ? (
          <EmptyState mode="embedded" scope="panel" tone="loading" title="불러오는 중…" />
        ) : videos.length === 0 ? (
          <EmptyState mode="embedded" scope="panel" title="등록된 영상이 없습니다." />
        ) : (
          <div className="session-videos-tab__list" style={{ display: "flex", flexDirection: "column", gap: "var(--space-6)" }}>
            {/* 묶음 단위 (제목 1, 제목 2, ... 패턴) — 폴더처럼 표시 */}
            {Array.from(groupedVideos.groups.entries()).map(([baseTitle, groupVideos]) => (
              <div key={baseTitle} className="session-videos-tab__group">
                <div
                  className="session-videos-tab__group-header"
                  style={{
                    display: "flex",
                    alignItems: "center",
                    gap: "var(--space-2)",
                    marginBottom: "var(--space-3)",
                    paddingLeft: "var(--space-2)",
                    borderLeft: "3px solid var(--color-brand-primary)",
                  }}
                >
                  <span style={{ fontWeight: 700, fontSize: 15, color: "var(--color-text-primary)" }}>{baseTitle}</span>
                  <span style={{ fontSize: 12, color: "var(--color-text-muted)", fontWeight: 600 }}>
                    {groupVideos.length}개
                  </span>
                </div>
                <div
                  style={{
                    display: "grid",
                    gridTemplateColumns: "repeat(auto-fill, minmax(280px, 1fr))",
                    gap: "var(--space-4)",
                  }}
                >
                  {groupVideos.map((video: MediaVideo) => renderVideoCard(video))}
                </div>
              </div>
            ))}
            {/* 묶음 아닌 단일 영상 */}
            {groupedVideos.ungrouped.length > 0 && (
              <div
                style={{
                  display: "grid",
                  gridTemplateColumns: "repeat(auto-fill, minmax(280px, 1fr))",
                  gap: "var(--space-4)",
                }}
              >
                {groupedVideos.ungrouped.map((video: MediaVideo) => renderVideoCard(video))}
              </div>
            )}
          </div>
        )}
      </div>

      <VideoUploadModal sessionId={sessionId} isOpen={showModal} onClose={() => setShowModal(false)} />
    </div>
  );
}


==========================================================================================
# FILE: hooks/useLectureEnrollments.ts
==========================================================================================
// PATH: src/features/lectures/hooks/useLectureEnrollments.ts
import { useQuery } from "@tanstack/react-query";
import { fetchLectureEnrollments } from "../api/enrollments";

export function useLectureEnrollments(lectureId: number) {
  return useQuery({
    queryKey: ["lecture-enrollments", lectureId],
    queryFn: () => fetchLectureEnrollments(lectureId),
    enabled: !!lectureId,
  });
}


==========================================================================================
# FILE: hooks/useLectureParams.ts
==========================================================================================
// PATH: src/features/lectures/hooks/useLectureParams.ts
import { useParams } from "react-router-dom";

export function useLectureParams() {
  const { lectureId, sessionId } = useParams<{
    lectureId?: string;
    sessionId?: string;
  }>();

  const parsedLectureId = Number(lectureId);
  const parsedSessionId = sessionId ? Number(sessionId) : undefined;

  return {
    lectureId: parsedLectureId,
    sessionId: parsedSessionId,
  };
}


==========================================================================================
# FILE: hooks/useSessionVideos.ts
==========================================================================================
// PATH: src/features/lectures/hooks/useSessionVideos.ts
import { useQuery } from "@tanstack/react-query";
import api from "@/shared/api/axios";

/**
 * Session 기준 media/videos 조회 + 상태 polling
 *
 * - READY / FAILED 아닌 영상이 있으면 2초 polling
 * - 전부 READY/FAILED면 polling 중단
 */
export function useSessionVideos(sessionId: number) {
  return useQuery({
    queryKey: ["session-videos", sessionId],
    enabled: !!sessionId,

    queryFn: async () => {
      const res = await api.get("/media/videos/", {
        params: { session: sessionId }, // backend filterset_fields expects "session" not "session_id"
      });
      return res.data.results ?? res.data;
    },

    refetchInterval: (query) => {
      const videos = query.state.data as any[] | undefined;
      if (!videos || videos.length === 0) return false;

      const hasProcessing = videos.some(
        (v) => v.status === "PENDING" || v.status === "UPLOADED" || v.status === "PROCESSING"
      );

      return hasProcessing ? 2000 : false;
    },
  });
}


==========================================================================================
# FILE: layout/LectureLayout.tsx
==========================================================================================
// PATH: src/features/lectures/layout/LectureLayout.tsx
import { Outlet, useParams } from "react-router-dom";
import { useQuery } from "@tanstack/react-query";
import { useMemo } from "react";
import api from "@/shared/api/axios";
import { DomainLayout } from "@/shared/ui/layout";
import SessionBlock from "@/features/sessions/components/SessionBlock";

function safeStr(v: any) {
  return typeof v === "string" ? v : v == null ? "" : String(v);
}

export default function LectureLayout() {
  const { lectureId } = useParams<{ lectureId: string }>();
  const lectureIdNum = Number(lectureId);

  if (!Number.isFinite(lectureIdNum)) {
    return (
      <DomainLayout title="강의" description="잘못된 강의 ID">
        <div className="p-4 text-sm" style={{ color: "var(--color-error)" }}>
          잘못된 강의 ID
        </div>
      </DomainLayout>
    );
  }

  const { data: lecture, isLoading } = useQuery({
    queryKey: ["lecture", lectureIdNum],
    queryFn: async () => (await api.get(`/lectures/lectures/${lectureIdNum}/`)).data,
    enabled: Number.isFinite(lectureIdNum),
  });

  const title = isLoading ? "강의 불러오는 중…" : safeStr(lecture?.title) || "강의";
  const desc = isLoading
    ? "데이터를 불러오는 중입니다."
    : [
        safeStr(lecture?.subject),
        safeStr(lecture?.name),
        lecture?.start_date && lecture?.end_date
          ? `${lecture.start_date} ~ ${lecture.end_date}`
          : "",
      ]
        .filter(Boolean)
        .join(" · ") || "수강생 · 자료 · 출결 · 리포트";

  const base = `/admin/lectures/${lectureId}`;
  const tabs = useMemo(
    () => [
      { key: "students", label: "수강생", path: base, exact: true },
      { key: "materials", label: "자료실", path: `/admin/community/materials?scope=lecture&lectureId=${lectureId}` },
      { key: "board", label: "게시판", path: `/admin/community/admin?tab=notice&scope=lecture&lectureId=${lectureId}` },
      { key: "ddays", label: "디데이", path: `${base}/ddays` },
      { key: "attendance", label: "출결", path: `${base}/attendance` },
      { key: "report", label: "리포트", path: `${base}/report` },
    ],
    [base, lectureId]
  );

  const breadcrumbs = useMemo(
    () => [
      { label: "강의", to: "/admin/lectures" },
      { label: title },
    ],
    [title]
  );

  return (
    <DomainLayout title={title} description={desc} breadcrumbs={breadcrumbs} tabs={tabs}>
      <SessionBlock lectureId={lectureIdNum} />
      <Outlet />
    </DomainLayout>
  );
}


==========================================================================================
# FILE: layout/LecturesLayout.tsx
==========================================================================================
// PATH: src/features/lectures/layout/LecturesLayout.tsx
import { Outlet } from "react-router-dom";
import { DomainLayout } from "@/shared/ui/layout";

const LECTURES_TABS = [
  { key: "list", label: "강의목록", path: "/admin/lectures", exact: true },
  { key: "past", label: "지난강의", path: "/admin/lectures/past" },
];

export default function LecturesLayout() {
  return (
    <DomainLayout
      title="강의 관리"
      description="강의 목록 · 지난 강의 · 수강생 · 출결 · 리포트"
      tabs={LECTURES_TABS}
    >
      <Outlet />
    </DomainLayout>
  );
}


==========================================================================================
# FILE: pages/assignments/SessionAssignmentsEntryPage.tsx
==========================================================================================
// PATH: src/features/lectures/pages/assignments/SessionAssignmentsEntryPage.tsx
// 차시(세션) 과제 탭 — SessionAssessmentWorkspace(homework) 래퍼

import SessionAssessmentWorkspace from "@/features/sessions/components/SessionAssessmentWorkspace";

type Props = {
  lectureId: number;
  sessionId: number;
};

export default function SessionAssignmentsEntryPage(_props: Props) {
  return <SessionAssessmentWorkspace mode="homework" />;
}


==========================================================================================
# FILE: pages/attendance/LectureAttendanceMatrixPage.tsx
==========================================================================================
// PATH: src/features/lectures/pages/attendance/LectureAttendanceMatrixPage.tsx
// Design: docs/DESIGN_SSOT.md
// 컬럼: 체크박스, 이름, 학부모 전화, 학생 전화, 출결블록(N차 → 1차 역순, 1글자)
import { useParams } from "react-router-dom";
import { useQuery } from "@tanstack/react-query";
import {
  fetchAttendanceMatrix,
  downloadAttendanceExcel,
  type AttendanceMatrixResponse,
} from "@/features/lectures/api/attendance";
import { sortSessionsByDateDesc } from "@/features/lectures/api/sessions";
import AttendanceStatusBadge from "@/shared/ui/badges/AttendanceStatusBadge";
import StudentNameWithLectureChip from "@/shared/ui/chips/StudentNameWithLectureChip";
import { EmptyState, Button } from "@/shared/ui/ds";
import { DomainListToolbar, DomainTable, STUDENTS_TABLE_COL } from "@/shared/ui/domain";
import { formatPhone } from "@/shared/utils/formatPhone";

export default function LectureAttendanceMatrixPage() {
  const { lectureId } = useParams<{ lectureId: string }>();
  const lectureIdNum = Number(lectureId);

  const { data, isLoading } = useQuery<AttendanceMatrixResponse>({
    queryKey: ["attendance-matrix", lectureIdNum],
    queryFn: () => fetchAttendanceMatrix(lectureIdNum),
    enabled: Number.isFinite(lectureIdNum),
  });

  if (isLoading) return <EmptyState scope="panel" tone="loading" title="불러오는 중…" />;
  if (!data?.students?.length)
    return (
      <EmptyState
        scope="panel"
        tone="empty"
        title="출결 데이터가 없습니다."
        description="차시에 수강생을 등록한 뒤 출결을 기록하면 표시됩니다."
      />
    );

  const { lecture: lectureInfo, sessions, students } = data;
  // 차시 블록: sortSessionsByDateDesc (날짜 내림차순)
  const sessionsByDateDesc = sortSessionsByDateDesc(sessions);

  const col = STUDENTS_TABLE_COL;
  const sessionColsTotal = sessionsByDateDesc.length * col.sessionCol;
  const tableMinWidth = col.checkbox + col.name + col.parentPhone + col.studentPhone + sessionColsTotal;

  const primaryAction = (
    <Button
      type="button"
      intent="secondary"
      size="sm"
      onClick={() => downloadAttendanceExcel(lectureIdNum)}
    >
      엑셀 다운로드
    </Button>
  );

  return (
    <div className="flex flex-col gap-3">
      <DomainListToolbar
        totalLabel={`총 ${students.length}명`}
        searchSlot={<span className="flex-1" />}
        primaryAction={primaryAction}
      />
      <div className="overflow-x-auto w-full">
        <div style={{ width: "fit-content" }}>
          <DomainTable
            tableClassName="ds-table--flat ds-table--attendance"
            tableStyle={{ width: tableMinWidth, minWidth: tableMinWidth, tableLayout: "fixed" }}
          >
            <colgroup>
              <col style={{ width: col.checkbox }} />
              <col style={{ width: col.name }} />
              <col style={{ width: col.parentPhone }} />
              <col style={{ width: col.studentPhone }} />
              {sessionsByDateDesc.map((s) => (
                <col key={s.id} style={{ width: col.sessionCol }} />
              ))}
            </colgroup>
            <thead>
              <tr>
                <th scope="col" className="ds-checkbox-cell" style={{ width: col.checkbox }}>
                  <span className="sr-only">선택</span>
                </th>
                <th scope="col" style={{ width: col.name }}>
                  이름
                </th>
                <th scope="col" style={{ width: col.parentPhone }}>
                  학부모 전화번호
                </th>
                <th scope="col" style={{ width: col.studentPhone }}>
                  학생 전화번호
                </th>
                {sessionsByDateDesc.map((s) => (
                  <th
                    key={s.id}
                    scope="col"
                    className="text-center"
                    style={{ width: col.sessionCol }}
                    title={`${s.order ?? "-"}차시${s.date ? ` (${s.date})` : ""}`}
                  >
                    {s.order ?? "-"}차
                  </th>
                ))}
              </tr>
            </thead>
            <tbody>
              {students.map((row) => (
                <tr key={row.student_id} className="hover:bg-[var(--color-bg-surface-hover)]">
                  <td className="ds-checkbox-cell align-middle" style={{ width: col.checkbox }}>
                    <span className="sr-only">{row.name} 선택</span>
                  </td>
                    <td
                    className="text-[15px] font-bold leading-6 text-[var(--color-text-primary)] truncate align-middle"
                    style={{ width: col.name }}
                  >
                    <StudentNameWithLectureChip
                      name={row.name ?? ""}
                      profilePhotoUrl={row.profile_photo_url ?? undefined}
                      avatarSize={24}
                      lectures={
                        lectureInfo
                          ? [{ lectureName: lectureInfo.title, color: lectureInfo.color }]
                          : undefined
                      }
                      chipSize={16}
                    />
                  </td>
                  <td
                    className="text-[14px] leading-6 text-[var(--color-text-secondary)] truncate align-middle"
                    style={{ width: col.parentPhone }}
                  >
                    {formatPhone(row.parent_phone)}
                  </td>
                  <td
                    className="text-[14px] leading-6 text-[var(--color-text-secondary)] truncate align-middle"
                    style={{ width: col.studentPhone }}
                  >
                    {formatPhone(row.phone)}
                  </td>
                  {sessionsByDateDesc.map((s) => {
                    const cell = row.attendance[String(s.id)];
                    return (
                      <td
                        key={s.id}
                        className="text-center align-middle px-0"
                        style={{ width: col.sessionCol }}
                      >
                        {cell?.status ? (
                          <AttendanceStatusBadge
                            status={cell.status as any}
                            variant="1ch"
                          />
                        ) : (
                          <span className="text-[var(--color-text-muted)] text-[10px]">－</span>
                        )}
                      </td>
                    );
                  })}
                </tr>
              ))}
            </tbody>
          </DomainTable>
        </div>
      </div>
    </div>
  );
}


==========================================================================================
# FILE: pages/attendance/SessionAttendancePage.tsx
==========================================================================================
// PATH: src/features/lectures/pages/attendance/SessionAttendancePage.tsx
// Design: students 도메인과 동일 — 검색·필터·컬럼정렬·툴바(수강생 등록만)
import React, { useState, useMemo, useEffect, useLayoutEffect, useRef } from "react";
import { createPortal } from "react-dom";
import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import {
  fetchAttendance,
  updateAttendance,
  deleteAttendance,
  downloadAttendanceExcel,
} from "@/features/lectures/api/attendance";
import api from "@/shared/api/axios";
import { EmptyState, Button } from "@/shared/ui/ds";
import { DomainListToolbar, DomainTable, STUDENTS_TABLE_COL } from "@/shared/ui/domain";
import StudentNameWithLectureChip from "@/shared/ui/chips/StudentNameWithLectureChip";
import AttendanceStatusBadge, {
  ORDERED_ATTENDANCE_STATUS,
  type AttendanceStatus,
} from "@/shared/ui/badges/AttendanceStatusBadge";
import { formatPhone } from "@/shared/utils/formatPhone";
import { feedback } from "@/shared/ui/feedback/feedback";
import { useSendMessageModal } from "@/features/messages/context/SendMessageModalContext";

const STATUS_LIST = ORDERED_ATTENDANCE_STATUS;

type SessionAttendancePageProps = {
  sessionId: number;
  lectureId?: number;
  onOpenEnrollModal?: () => void;
};

function matchSearch(att: any, q: string): boolean {
  if (!q.trim()) return true;
  const k = q.trim().toLowerCase();
  const digits = q.trim().replace(/\D/g, "");
  const name = (att.name ?? "").toLowerCase();
  const phone = (formatPhone(att.phone ?? att.student_phone ?? "") ?? "").replace(/\D/g, "");
  const parentPhone = (formatPhone(att.parent_phone ?? "") ?? "").replace(/\D/g, "");
  return name.includes(k) || (digits.length >= 2 && (phone.includes(digits) || parentPhone.includes(digits)));
}

export default function SessionAttendancePage({
  sessionId,
  lectureId,
  onOpenEnrollModal,
}: SessionAttendancePageProps) {
  const qc = useQueryClient();
  const { openSendMessageModal } = useSendMessageModal();
  const [selectedIds, setSelectedIds] = useState<number[]>([]);
  const [deleting, setDeleting] = useState(false);
  const [searchInput, setSearchInput] = useState("");
  const [search, setSearch] = useState("");
  const [statusFilter, setStatusFilter] = useState("");
  const [sort, setSort] = useState("-name");
  const [statusPopoverOpen, setStatusPopoverOpen] = useState(false);
  const statusTriggerRef = useRef<HTMLButtonElement>(null);
  const statusPopoverRef = useRef<HTMLDivElement>(null);
  const [statusPopoverAnchor, setStatusPopoverAnchor] = useState<{ left: number; top: number } | null>(null);

  useLayoutEffect(() => {
    if (!statusPopoverOpen) {
      setStatusPopoverAnchor(null);
      return;
    }
    const el = statusTriggerRef.current;
    if (!el) return;
    const rect = el.getBoundingClientRect();
    setStatusPopoverAnchor({ left: rect.left, top: rect.top });
  }, [statusPopoverOpen]);

  useEffect(() => {
    const t = setTimeout(() => setSearch(searchInput), 250);
    return () => clearTimeout(t);
  }, [searchInput]);

  useEffect(() => {
    if (!statusPopoverOpen) return;
    const close = (e: MouseEvent) => {
      const target = e.target as Node;
      if (statusTriggerRef.current?.contains(target) || statusPopoverRef.current?.contains(target)) return;
      setStatusPopoverOpen(false);
    };
    document.addEventListener("mousedown", close);
    return () => document.removeEventListener("mousedown", close);
  }, [statusPopoverOpen]);

  const { data: attendance, isLoading } = useQuery({
    queryKey: ["attendance", sessionId],
    queryFn: () => fetchAttendance(sessionId),
    enabled: Number.isFinite(sessionId),
  });

  const { data: lecture } = useQuery({
    queryKey: ["lecture", lectureId],
    queryFn: async () => (await api.get(`/lectures/lectures/${lectureId}/`)).data,
    enabled: Number.isFinite(lectureId ?? 0),
  });

  const updateStatus = useMutation({
    mutationFn: ({ id, status }: { id: number; status: AttendanceStatus }) =>
      updateAttendance(id, { status }),
    onSuccess: () => qc.invalidateQueries({ queryKey: ["attendance", sessionId] }),
  });

  const updateMemo = useMutation({
    mutationFn: ({ id, memo }: { id: number; memo: string }) =>
      updateAttendance(id, { memo }),
    onSuccess: () => qc.invalidateQueries({ queryKey: ["attendance", sessionId] }),
  });

  const filtered = useMemo(() => {
    if (!attendance) return [];
    let list = attendance.filter((att: any) => matchSearch(att, search));
    if (statusFilter) list = list.filter((att: any) => att.status === statusFilter);
    return list;
  }, [attendance, search, statusFilter]);

  const sorted = useMemo(() => {
    const list = [...filtered];
    const key = sort.startsWith("-") ? sort.slice(1) : sort;
    const asc = !sort.startsWith("-");
    list.sort((a: any, b: any) => {
      if (key === "name") {
        const va = (a.name ?? "").localeCompare(b.name ?? "", "ko");
        return asc ? va : -va;
      }
      if (key === "status") {
        const order = ORDERED_ATTENDANCE_STATUS.indexOf(a.status) - ORDERED_ATTENDANCE_STATUS.indexOf(b.status);
        return asc ? order : -order;
      }
      if (key === "phone") {
        const va = (formatPhone(a.phone ?? a.student_phone) ?? "").localeCompare(
          formatPhone(b.phone ?? b.student_phone) ?? ""
        );
        return asc ? va : -va;
      }
      if (key === "parent_phone") {
        const va = (formatPhone(a.parent_phone) ?? "").localeCompare(formatPhone(b.parent_phone) ?? "");
        return asc ? va : -va;
      }
      return 0;
    });
    return list;
  }, [filtered, sort]);

  const selectedSet = useMemo(() => new Set(selectedIds), [selectedIds]);

  if (isLoading) return <EmptyState scope="panel" tone="loading" title="불러오는 중…" />;
  if (!attendance) return <EmptyState scope="panel" tone="error" title="출결 데이터를 불러올 수 없습니다." />;

  const allIds = sorted.map((att: any) => att.id);
  const allSelected = sorted.length > 0 && allIds.every((id: number) => selectedSet.has(id));

  function toggleSelect(id: number) {
    if (selectedSet.has(id)) setSelectedIds(selectedIds.filter((x) => x !== id));
    else setSelectedIds([...selectedIds, id]);
  }
  function toggleSelectAll() {
    if (allSelected) setSelectedIds([]);
    else setSelectedIds([...allIds]);
  }

  const handleMessageSend = () => {
    if (selectedIds.length === 0) return;
    const selectedRows = sorted.filter((att: any) => selectedSet.has(att.id));
    const studentIds = selectedRows
      .map((att: any) => att.student_id)
      .filter((id: unknown) => id != null && Number.isFinite(id));
    openSendMessageModal({
      studentIds,
      recipientLabel: `선택한 출결 ${selectedIds.length}명`,
    });
  };

  const handleExcelDownload = () => {
    if (lectureId != null && Number.isFinite(lectureId)) {
      downloadAttendanceExcel(lectureId);
    } else {
      feedback.info("엑셀 다운로드는 강의 단위로 제공됩니다.");
    }
  };

  const handleBulkDelete = async () => {
    if (selectedIds.length === 0) return;
    if (
      !window.confirm(
        `선택한 ${selectedIds.length}명을 이 차시 출결에서 제외하시겠습니까?\n(수강생 등록은 유지되며, 출결 기록만 제거됩니다.)`
      )
    )
      return;
    const count = selectedIds.length;
    setDeleting(true);
    try {
      await Promise.all(selectedIds.map((id) => deleteAttendance(id)));
      setSelectedIds([]);
      qc.invalidateQueries({ queryKey: ["attendance", sessionId] });
      qc.invalidateQueries({ queryKey: ["session-enrollments", sessionId] });
      feedback.success(`${count}명 출결에서 제외되었습니다.`);
    } catch (e) {
      feedback.error(e instanceof Error ? e.message : "삭제 중 오류가 발생했습니다.");
    } finally {
      setDeleting(false);
    }
  };

  const selectionBar = (
    <div className="flex flex-wrap items-center gap-2 pl-1">
      <span
        className="text-[13px] font-semibold"
        style={{
          color: selectedIds.length > 0 ? "var(--color-primary)" : "var(--color-text-muted)",
        }}
      >
        {selectedIds.length}명 선택됨
      </span>
      <span className="text-[var(--color-border-divider)]">|</span>
      <Button intent="secondary" size="sm" onClick={() => setSelectedIds([])} disabled={selectedIds.length === 0}>
        선택 해제
      </Button>
      <span className="text-[var(--color-border-divider)]">|</span>
      <Button intent="secondary" size="sm" onClick={handleMessageSend} disabled={selectedIds.length === 0}>
        메시지 발송
      </Button>
      <Button intent="secondary" size="sm" onClick={handleExcelDownload}>
        엑셀 다운로드
      </Button>
      <Button
        intent="danger"
        size="sm"
        disabled={selectedIds.length === 0 || deleting}
        onClick={handleBulkDelete}
      >
        {deleting ? "삭제 중…" : "삭제"}
      </Button>
    </div>
  );

  const col = STUDENTS_TABLE_COL;
  const tableMinWidth = col.checkbox + col.name + col.statusBadge + col.parentPhone + col.studentPhone + col.attendanceChange + col.memo;

  const primaryAction =
    onOpenEnrollModal ? (
      <Button type="button" intent="primary" size="sm" onClick={onOpenEnrollModal}>
        수강생 등록
      </Button>
    ) : null;

  const filterSlot = (
    <>
      <span ref={statusTriggerRef}>
        <Button
          type="button"
          intent="secondary"
          size="sm"
          onClick={(e) => { e.stopPropagation(); setStatusPopoverOpen((v) => !v); }}
          aria-haspopup="true"
          aria-expanded={statusPopoverOpen}
          aria-label="출결 상태 필터"
        >
          {statusFilter ? (
            <span className="inline-flex items-center gap-1.5">
              <AttendanceStatusBadge status={statusFilter as AttendanceStatus} variant="2ch" />
            </span>
          ) : (
            "상태"
          )}
        </Button>
      </span>
      {statusPopoverOpen && statusPopoverAnchor &&
        createPortal(
          <div
            ref={statusPopoverRef}
            className="fixed flex flex-wrap items-center gap-2 rounded-lg border p-2 shadow-lg"
            style={{
              left: statusPopoverAnchor.left,
              top: statusPopoverAnchor.top,
              transform: "translateY(-100%)",
              marginTop: -4,
              zIndex: 9999,
              background: "var(--color-bg-surface)",
              borderColor: "var(--color-border-divider)",
            }}
            onClick={(e) => e.stopPropagation()}
          >
            <Button
              type="button"
              intent={!statusFilter ? "primary" : "secondary"}
              size="sm"
              onClick={() => { setStatusFilter(""); setStatusPopoverOpen(false); }}
            >
              전체
            </Button>
            {STATUS_LIST.map((code) => {
              const selected = statusFilter === code;
              return (
                <button
                  key={code}
                  type="button"
                  onClick={() => { setStatusFilter(code); setStatusPopoverOpen(false); }}
                  className="cursor-pointer rounded border-0 p-0.5 transition-opacity hover:opacity-100 focus:outline-none focus-visible:ring-2 focus-visible:ring-[var(--color-border-focus)]/40"
                  style={{
                    opacity: selected ? 1 : 0.85,
                    boxShadow: selected ? "0 0 0 2px var(--color-primary)" : undefined,
                  }}
                >
                  <AttendanceStatusBadge status={code} variant="2ch" />
                </button>
              );
            })}
          </div>,
          document.body
        )}
    </>
  );

  function sortHeader(colKey: string, label: string) {
    const isAsc = sort === colKey;
    const isDesc = sort === `-${colKey}`;
    const next = isAsc ? `-${colKey}` : isDesc ? "" : colKey;
    return (
      <th
        scope="col"
        onClick={() => setSort(next || "name")}
        className="cursor-pointer select-none"
        aria-sort={isAsc ? "ascending" : isDesc ? "descending" : "none"}
      >
        <span className="inline-flex items-center gap-2">
          {label}
          <span
            aria-hidden
            style={{ fontSize: 11, opacity: isAsc || isDesc ? 1 : 0.35, color: "var(--color-primary)" }}
          >
            {isAsc ? "▲" : isDesc ? "▼" : "⇅"}
          </span>
        </span>
      </th>
    );
  }

  return (
    <div className="flex flex-col gap-4">
      <DomainListToolbar
        totalLabel={`총 ${sorted.length}명`}
        searchSlot={
          <input
            className="ds-input"
            placeholder="이름 / 전화번호 검색"
            value={searchInput}
            onChange={(e) => setSearchInput(e.target.value)}
            style={{ maxWidth: 280 }}
          />
        }
        filterSlot={filterSlot}
        primaryAction={primaryAction}
        belowSlot={selectionBar}
      />
      <div className="overflow-x-auto w-full">
        {sorted.length === 0 ? (
          <EmptyState
            scope="panel"
            tone="empty"
            title={
              attendance.length === 0 && !search && !statusFilter
                ? "이 차시에 수강생이 없습니다."
                : "검색 결과가 없습니다."
            }
            description={
              attendance.length === 0 && !search && !statusFilter
                ? "위 '수강생 등록' 버튼으로 추가해 주세요."
                : "검색어나 필터를 변경해 보세요."
            }
            actions={
              attendance.length === 0 && !search && !statusFilter && onOpenEnrollModal ? (
                <Button type="button" intent="primary" onClick={onOpenEnrollModal}>
                  수강생 등록
                </Button>
              ) : undefined
            }
          />
        ) : (
          <div style={{ width: "fit-content" }}>
            <DomainTable tableClassName="ds-table--flat ds-table--attendance" tableStyle={{ minWidth: tableMinWidth, width: "100%", tableLayout: "fixed" }}>
              <colgroup>
                <col style={{ width: col.checkbox }} />
                <col style={{ width: col.name }} />
                <col style={{ width: col.statusBadge }} />
                <col style={{ width: col.parentPhone }} />
                <col style={{ width: col.studentPhone }} />
                <col style={{ width: col.attendanceChange }} />
                <col style={{ width: col.memo }} />
              </colgroup>
              <thead>
                <tr>
                  <th scope="col" className="ds-checkbox-cell" style={{ width: col.checkbox }} onClick={(e) => e.stopPropagation()}>
                    <input
                      type="checkbox"
                      checked={allSelected}
                      onChange={toggleSelectAll}
                      aria-label="전체 선택"
                      className="cursor-pointer"
                    />
                  </th>
                  {sortHeader("name", "이름")}
                  {sortHeader("status", "상태")}
                  {sortHeader("parent_phone", "학부모 전화번호")}
                  {sortHeader("phone", "학생 전화번호")}
                  <th scope="col">출결 변경</th>
                  <th scope="col">메모</th>
                </tr>
              </thead>
              <tbody>
                {sorted.map((att: any) => (
                  <tr key={att.id} className={selectedSet.has(att.id) ? "ds-row-selected" : ""}>
                    <td className="ds-checkbox-cell" style={{ width: col.checkbox }} onClick={(e) => e.stopPropagation()}>
                      <input
                        type="checkbox"
                        checked={selectedSet.has(att.id)}
                        onChange={() => toggleSelect(att.id)}
                        onClick={(e) => e.stopPropagation()}
                        aria-label={`${att.name} 선택`}
                        className="cursor-pointer"
                      />
                    </td>
                    <td className="text-[15px] font-bold leading-6 text-[var(--color-text-primary)] truncate align-middle">
                      <StudentNameWithLectureChip
                        name={att.name ?? ""}
                        profilePhotoUrl={att.profile_photo_url ?? undefined}
                        avatarSize={24}
                        lectures={
                          att.lecture_title
                            ? [{ lectureName: att.lecture_title, color: att.lecture_color }]
                            : lecture
                              ? [{ lectureName: lecture.title, color: lecture.color }]
                              : undefined
                        }
                        chipSize={16}
                      />
                    </td>
                    <td className="text-center align-middle">
                      <AttendanceStatusBadge status={att.status} variant="2ch" />
                    </td>
                    <td className="text-[14px] leading-6 text-[var(--color-text-secondary)] truncate align-middle">
                      {formatPhone(att.parent_phone)}
                    </td>
                    <td className="text-[14px] leading-6 text-[var(--color-text-secondary)] truncate align-middle">
                      {formatPhone(att.phone ?? att.student_phone)}
                    </td>
                    <td className="align-middle">
                      <div className="flex flex-nowrap gap-1" style={{ width: "fit-content" }}>
                        {STATUS_LIST.map((code) => {
                          const active = att.status === code;
                          return (
                            <button
                              key={code}
                              type="button"
                              aria-pressed={active}
                              onClick={() => {
                                if (active) return;
                                updateStatus.mutate({ id: att.id, status: code });
                              }}
                              className="cursor-pointer rounded border-0 p-0.5 transition-opacity hover:opacity-100 focus:outline-none focus-visible:ring-2 focus-visible:ring-[var(--color-border-focus)]/40 disabled:cursor-default"
                              style={{ opacity: active ? 1 : 0.4, filter: active ? "none" : "grayscale(1)" }}
                            >
                              <AttendanceStatusBadge status={code} variant="2ch" />
                            </button>
                          );
                        })}
                      </div>
                    </td>
                    <td className="align-middle">
                      <input
                        defaultValue={att.memo || ""}
                        placeholder="메모 입력"
                        className="ds-input w-full min-w-0 text-[14px] leading-6 py-1.5 text-[var(--color-text-secondary)]"
                        onBlur={(e) => updateMemo.mutate({ id: att.id, memo: e.target.value })}
                      />
                    </td>
                  </tr>
                ))}
              </tbody>
            </DomainTable>
          </div>
        )}
      </div>
    </div>
  );
}


==========================================================================================
# FILE: pages/attendance/attendanceMatrix.css
==========================================================================================
/* PATH: src/features/lectures/pages/attendance/attendanceMatrix.css */
/**
 * ⚠️ Legacy CSS (유지)
 * - 기능 로직 영향 없음
 * - 하드코딩 색상 제거 → 전역 디자인 토큰 기반으로 정합성 통일
 */

/* ===== 테이블 기본 ===== */
.attendance-table {
  min-width: 100%;
  border-collapse: collapse;
  font-size: 0.875rem;
}

.attendance-table th,
.attendance-table td {
  border: 1px solid var(--color-border-divider);
  padding: 0.5rem 0.75rem;
  text-align: center;
  color: var(--color-text-secondary);
}

.attendance-table th {
  background: var(--color-bg-surface-hover);
  color: var(--color-text-secondary);
  font-weight: 900;
}

/* ===== Sticky ===== */
.attendance-sticky-header {
  position: sticky;
  top: 0;
  background: var(--color-bg-surface-hover);
  z-index: 10;
}

.attendance-sticky-student {
  position: sticky;
  left: 0;
  background: var(--color-bg-surface);
  z-index: 20;
  font-weight: 900;
  color: var(--color-text-primary);
}

/* ===== Hover ===== */
.attendance-row:hover {
  background: var(--color-bg-surface-soft);
}

/* ===== Status Tokens (시각만 담당, 의미/코드 변경 없음) ===== */
/* NOTE:
 * 실제 상태 컬러는 "status pills / buttons"에서 이미 정의될 수 있음.
 * 여기 CSS는 매트릭스/레거시 테이블용 기본 톤만 제공.
 */
.status-present {
  background: color-mix(in srgb, var(--color-primary) 12%, var(--color-bg-surface));
  color: var(--color-primary);
  font-weight: 900;
}

.status-late {
  background: var(--color-bg-surface-soft);
  color: var(--color-text-secondary);
  font-weight: 900;
}

.status-online {
  background: var(--color-bg-surface-soft);
  color: var(--color-text-secondary);
  font-weight: 900;
}

.status-supplement {
  background: var(--color-bg-surface-soft);
  color: var(--color-text-secondary);
  font-weight: 900;
}

.status-early-leave {
  background: var(--color-bg-surface-soft);
  color: var(--color-text-secondary);
  font-weight: 900;
}

.status-absent {
  background: color-mix(in srgb, var(--color-error) 10%, var(--color-bg-surface));
  color: var(--color-error);
  font-weight: 900;
}

.status-runaway {
  background: color-mix(in srgb, var(--color-error) 12%, var(--color-bg-surface));
  color: var(--color-error);
  font-weight: 900;
}

.status-material {
  background: var(--color-bg-surface-soft);
  color: var(--color-text-secondary);
  font-weight: 900;
}

.status-inactive {
  background: var(--color-bg-surface-soft);
  color: var(--color-text-muted);
  font-weight: 900;
}

.status-secession {
  background: var(--color-bg-surface-soft);
  color: var(--color-text-muted);
  font-weight: 900;
  text-decoration: line-through;
}

/* ===== Interaction ===== */
.attendance-cell {
  cursor: pointer;
  user-select: none;
}

.attendance-cell.disabled {
  cursor: not-allowed;
}

.attendance-cell.updating {
  opacity: 0.5;
  cursor: wait;
}


==========================================================================================
# FILE: pages/boards/LectureBoardPage.tsx
==========================================================================================
// PATH: src/features/lectures/pages/boards/LectureBoardPage.tsx
import { useMemo, useState } from "react";
import { useParams } from "react-router-dom";
import { useQuery } from "@tanstack/react-query";

import { BoardCategory, BoardPost, fetchBoardCategories, fetchBoardPosts } from "../../api/board";
import { fetchPostTemplates, type PostTemplate } from "@/features/community/api/community.api";
import BoardPostModal from "../../components/BoardPostModal";
import BoardPostDetail from "../../components/BoardPostDetail";
import { EmptyState, Button } from "@/shared/ui/ds";

const TH_STYLE = {
  background: "color-mix(in srgb, var(--color-primary) 12%, var(--bg-surface))",
  color: "var(--color-text-muted)",
};

export default function LectureBoardPage() {
  const { lectureId } = useParams<{ lectureId: string }>();
  const lectureIdNum = Number(lectureId);

  const [selectedCategory, setSelectedCategory] = useState<BoardCategory | null>(null);
  const [showPostModal, setShowPostModal] = useState(false);
  const [openedPost, setOpenedPost] = useState<BoardPost | null>(null);

  const { data: categories = [], isLoading: loadingCats } = useQuery<BoardCategory[]>({
    queryKey: ["board-categories", lectureIdNum],
    queryFn: () => fetchBoardCategories(lectureIdNum),
    enabled: Number.isFinite(lectureIdNum),
    onSuccess: (data) => {
      if (!selectedCategory && data.length > 0) setSelectedCategory(data[0]);
    },
  });

  const { data: posts = [], isLoading: loadingPosts } = useQuery<BoardPost[]>({
    queryKey: ["board-posts", lectureIdNum, selectedCategory?.id ?? "none"],
    queryFn: () =>
      fetchBoardPosts({
        lecture: lectureIdNum,
        category: selectedCategory?.id,
      }),
    enabled: Number.isFinite(lectureIdNum) && !!selectedCategory,
  });

  const { data: templates = [] } = useQuery<PostTemplate[]>({
    queryKey: ["community-post-templates"],
    queryFn: () => fetchPostTemplates(),
    enabled: showPostModal,
  });

  const categoryTitle = useMemo(() => selectedCategory?.label ?? "카테고리", [selectedCategory]);

  return (
    <>
      {/* 액션바 — 블록 타입은 읽기 전용 */}
      <div className="flex items-center gap-2 mb-3">
        <Button intent="primary" onClick={() => setShowPostModal(true)} disabled={!selectedCategory}>
          글 작성
        </Button>

        <span className="ml-auto text-sm font-semibold text-[var(--color-text-muted)]">
          {loadingPosts ? "불러오는 중…" : `${posts.length}개`}
        </span>
      </div>

      <div style={{ display: "grid", gridTemplateColumns: "240px 1fr", gap: 16 }}>
        {/* LEFT */}
        <div
          style={{
            borderRadius: 18,
            border: "1px solid var(--color-border-divider)",
            background: "var(--color-bg-surface)",
            padding: 12,
          }}
        >
          <div className="flex items-center justify-between mb-2">
            <span style={{ fontSize: 12, fontWeight: 900, color: "var(--color-text-muted)" }}>
              게시판 목록
            </span>
          </div>

          {loadingCats ? (
            <EmptyState mode="embedded" scope="panel" tone="loading" title="불러오는 중…" />
          ) : categories.length === 0 ? (
            <EmptyState
              mode="embedded"
              scope="panel"
              tone="empty"
              title="카테고리가 없습니다."
              description="카테고리를 먼저 추가해 주세요."
            />
          ) : (
            <div style={{ display: "grid", gap: 6 }}>
              {categories.map((cat) => {
                const active = selectedCategory?.id === cat.id;
                return (
                  <Button
                    key={cat.id}
                    intent={active ? "secondary" : "ghost"}
                    size="md"
                    onClick={() => setSelectedCategory(cat)}
                    aria-pressed={active}
                    style={{ justifyContent: "flex-start" }}
                  >
                    {cat.label}
                  </Button>
                );
              })}
            </div>
          )}
        </div>

        {/* RIGHT */}
        <div
          style={{
            borderRadius: 18,
            border: "1px solid var(--color-border-divider)",
            background: "var(--color-bg-surface)",
            padding: 12,
            overflow: "hidden",
          }}
        >
          <div className="flex items-baseline justify-between mb-2">
            <div style={{ fontSize: 12, fontWeight: 900, color: "var(--color-text-secondary)" }}>
              {selectedCategory ? `${categoryTitle}` : "게시글"}
            </div>
            <div style={{ fontSize: 11, fontWeight: 850, color: "var(--color-text-muted)" }}>
              {loadingPosts ? "불러오는 중…" : `${posts.length}개`}
            </div>
          </div>

          {loadingPosts ? (
            <EmptyState scope="panel" tone="loading" title="불러오는 중…" />
          ) : !selectedCategory || posts.length === 0 ? (
            <EmptyState scope="panel" tone="empty" title="등록된 글이 없습니다." description="게시글을 작성하면 여기에 표시됩니다." />
          ) : (
            <div style={{ overflow: "hidden", borderRadius: 14, border: "1px solid var(--color-border-divider)" }}>
              <table className="w-full" style={{ tableLayout: "fixed" }}>
                <thead>
                  <tr>
                    <th
                      className="px-4 py-3 text-sm font-semibold border-b border-[var(--color-border-divider)]"
                      style={{ textAlign: "left", whiteSpace: "nowrap", ...TH_STYLE }}
                    >
                      제목
                    </th>
                    <th
                      className="px-4 py-3 text-sm font-semibold border-b border-[var(--color-border-divider)]"
                      style={{ textAlign: "center", whiteSpace: "nowrap", width: 140, ...TH_STYLE }}
                    >
                      작성일
                    </th>
                  </tr>
                </thead>
                <tbody className="divide-y divide-[var(--color-border-divider)]">
                  {posts.map((p) => (
                    <tr
                      key={p.id}
                      onClick={() => setOpenedPost(p)}
                      tabIndex={0}
                      role="button"
                      className="cursor-pointer hover:bg-[var(--color-bg-surface-soft)] focus:outline-none focus-visible:ring-2 focus-visible:ring-[var(--color-border-focus)]/40"
                    >
                      <td className="px-4 py-3 text-left text-[15px] font-bold text-[var(--color-text-primary)] truncate">
                        {p.title}
                      </td>
                      <td className="px-4 py-3 text-center text-[13px] font-semibold text-[var(--color-text-muted)] truncate">
                        {p.created_at.slice(0, 10)}
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          )}
        </div>
      </div>

      {showPostModal && selectedCategory && (
        <BoardPostModal
          lectureId={lectureIdNum}
          category={selectedCategory}
          templates={templates}
          onClose={() => setShowPostModal(false)}
        />
      )}
      {openedPost && <BoardPostDetail lectureId={lectureIdNum} post={openedPost} onClose={() => setOpenedPost(null)} />}
    </>
  );
}


==========================================================================================
# FILE: pages/ddays/LectureDdayPage.tsx
==========================================================================================
// PATH: src/features/lectures/pages/ddays/LectureDdayPage.tsx
import { useState } from "react";
import { useParams } from "react-router-dom";
import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";

import { fetchDdays, deleteDday, type Dday } from "@/features/lectures/api/ddays";
import DdayModal from "@/features/lectures/components/DdayModal";
import { EmptyState, Button } from "@/shared/ui/ds";

const TH_STYLE = {
  background: "color-mix(in srgb, var(--color-primary) 12%, var(--bg-surface))",
  color: "var(--color-text-muted)",
};

export default function LectureDdayPage() {
  const { lectureId } = useParams<{ lectureId: string }>();
  const lectureIdNum = Number(lectureId);
  const qc = useQueryClient();

  const [showModal, setShowModal] = useState(false);

  const { data: ddays = [], isLoading } = useQuery<Dday[]>({
    queryKey: ["ddays", lectureIdNum],
    queryFn: () => fetchDdays(lectureIdNum),
    enabled: Number.isFinite(lectureIdNum),
  });

  const deleteMutation = useMutation({
    mutationFn: (id: number) => deleteDday(id),
    onSuccess: () => qc.invalidateQueries({ queryKey: ["ddays", lectureIdNum] }),
  });

  return (
    <>
      <div className="flex items-center gap-2 mb-3">
        <Button intent="primary" onClick={() => setShowModal(true)}>
          D-Day 추가
        </Button>
        <span className="ml-auto text-sm font-semibold text-[var(--color-text-muted)]">
          {isLoading ? "불러오는 중…" : `${ddays.length}개`}
        </span>
      </div>

      {isLoading ? (
        <EmptyState scope="panel" tone="loading" title="불러오는 중…" />
      ) : ddays.length === 0 ? (
        <EmptyState scope="panel" title="등록된 D-Day가 없습니다." />
      ) : (
        <div style={{ overflow: "hidden", borderRadius: 14, border: "1px solid var(--color-border-divider)" }}>
          <table className="w-full" style={{ tableLayout: "fixed" }}>
            <thead>
              <tr>
                <th
                  className="px-4 py-3 text-sm font-semibold border-b border-[var(--color-border-divider)]"
                  style={{ textAlign: "left", whiteSpace: "nowrap", ...TH_STYLE }}
                >
                  제목
                </th>
                <th
                  className="px-4 py-3 text-sm font-semibold border-b border-[var(--color-border-divider)]"
                  style={{ textAlign: "center", whiteSpace: "nowrap", width: 220, ...TH_STYLE }}
                >
                  날짜
                </th>
                <th
                  className="px-4 py-3 text-sm font-semibold border-b border-[var(--color-border-divider)]"
                  style={{ textAlign: "center", whiteSpace: "nowrap", width: 120, ...TH_STYLE }}
                >
                  관리
                </th>
              </tr>
            </thead>

            <tbody className="divide-y divide-[var(--color-border-divider)]">
              {ddays.map((d) => (
                <tr key={d.id} className="hover:bg-[var(--color-bg-surface-soft)]">
                  <td className="px-4 py-3 text-left text-[15px] font-bold text-[var(--color-text-primary)] truncate">
                    {d.title}
                  </td>
                  <td className="px-4 py-3 text-center text-[14px] text-[var(--color-text-secondary)] truncate">
                    {new Date(d.date).toLocaleString("ko-KR")}
                  </td>
                  <td className="px-4 py-3 text-center">
                    <Button
                      intent="danger"
                      size="sm"
                      disabled={deleteMutation.isPending}
                      onClick={() => {
                        if (window.confirm("삭제하시겠습니까?")) deleteMutation.mutate(d.id);
                      }}
                    >
                      삭제
                    </Button>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      )}

      {showModal && <DdayModal lectureId={lectureIdNum} onClose={() => setShowModal(false)} />}
    </>
  );
}


==========================================================================================
# FILE: pages/exams/SessionExamsPage.tsx
==========================================================================================
// PATH: src/features/lectures/pages/exams/SessionExamsPage.tsx
// 차시(세션) 시험 탭 — 해당 차시에 연결된 시험 목록 및 요약

import { useQuery } from "@tanstack/react-query";
import { fetchAdminSessionExams } from "@/features/results/api/adminSessionExams";
import SessionExamSummaryPanel from "@/features/results/panels/SessionExamSummaryPanel";
import { EmptyState } from "@/shared/ui/ds";

type Props = {
  sessionId: number;
};

export default function SessionExamsPage({ sessionId }: Props) {
  const { data: exams = [], isLoading } = useQuery({
    queryKey: ["admin-session-exams", sessionId],
    queryFn: () => fetchAdminSessionExams(sessionId),
    enabled: Number.isFinite(sessionId),
  });

  if (isLoading) {
    return <EmptyState scope="panel" tone="loading" title="불러오는 중…" />;
  }

  if (!exams.length) {
    return (
      <EmptyState
        scope="panel"
        tone="empty"
        title="이 차시에 연결된 시험이 없습니다."
        description="좌측 평가 패널에서 시험을 추가할 수 있습니다."
      />
    );
  }

  return (
    <div className="flex flex-col gap-6">
      <SessionExamSummaryPanel sessionId={sessionId} />
      <div className="text-sm text-[var(--color-text-muted)]">
        시험 {exams.length}건 연결됨 · 채점/상세는 성적 탭에서 이용하세요.
      </div>
    </div>
  );
}


==========================================================================================
# FILE: pages/exams/SessionExamsRoute.tsx
==========================================================================================
// PATH: src/features/lectures/pages/exams/SessionExamsRoute.tsx
import { useParams } from "react-router-dom";
import SessionExamsPage from "./SessionExamsPage";

export default function SessionExamsRoute() {
  const { sessionId } = useParams<{ sessionId: string }>();
  const sid = Number(sessionId);

  if (!Number.isFinite(sid)) {
    return <div className="p-4 text-sm" style={{ color: "var(--color-error)" }}>잘못된 sessionId</div>;
  }

  return <SessionExamsPage sessionId={sid} />;
}


==========================================================================================
# FILE: pages/lectures/LectureReportPage.tsx
==========================================================================================
// PATH: src/features/lectures/pages/lectures/LectureReportPage.tsx
import { useParams } from "react-router-dom";
import { useQuery } from "@tanstack/react-query";
import { EmptyState } from "@/shared/ui/ds";
import { fetchLectureReport, type LectureReportResponse } from "@/features/lectures/api/report";

const TH_STYLE = {
  background: "color-mix(in srgb, var(--color-primary) 12%, var(--bg-surface))",
  color: "var(--color-text-muted)",
};

export default function LectureReportPage() {
  const { lectureId } = useParams<{ lectureId: string }>();
  const lectureIdNum = Number(lectureId);

  const { data, isLoading } = useQuery<LectureReportResponse>({
    queryKey: ["lecture-report", lectureIdNum],
    queryFn: () => fetchLectureReport(lectureIdNum),
    enabled: Number.isFinite(lectureIdNum),
  });

  if (isLoading) return <EmptyState scope="panel" tone="loading" title="불러오는 중…" />;
  if (!data)
    return (
      <EmptyState
        scope="panel"
        title="리포트 데이터가 없습니다."
        description="강의 데이터가 충분하지 않습니다."
      />
    );

  const students = data.students ?? [];

  return (
    <div style={{ display: "grid", gap: 16 }}>
      {/* 요약 (카드 톤 통일) */}
      <div style={{ display: "grid", gridTemplateColumns: "repeat(3, 1fr)", gap: 12 }}>
        {[
          { label: "전체 수강생", value: data.summary?.total_students ?? "-" },
          { label: "전체 차시", value: data.summary?.total_sessions ?? "-" },
          { label: "평균 진도", value: `${data.summary?.avg_video_progress ?? 0}%` },
        ].map((m) => (
          <div
            key={m.label}
            style={{
              borderRadius: 14,
              border: "1px solid var(--color-border-divider)",
              background: "var(--color-bg-surface)",
              padding: 14,
            }}
          >
            <div style={{ fontSize: 11, fontWeight: 900, color: "var(--color-text-muted)" }}>{m.label}</div>
            <div style={{ marginTop: 4, fontSize: 20, fontWeight: 950, color: "var(--color-text-primary)" }}>
              {m.value}
            </div>
          </div>
        ))}
      </div>

      {/* 학생별 */}
      {!students.length ? (
        <EmptyState mode="embedded" scope="panel" title="학생 데이터가 없습니다." />
      ) : (
        <div style={{ overflow: "hidden", borderRadius: 14, border: "1px solid var(--color-border-divider)" }}>
          <table className="w-full" style={{ tableLayout: "fixed" }}>
            <thead>
              <tr>
                <th
                  className="px-4 py-3 text-sm font-semibold border-b border-[var(--color-border-divider)]"
                  style={{ textAlign: "left", ...TH_STYLE }}
                >
                  이름
                </th>
                <th
                  className="px-4 py-3 text-sm font-semibold border-b border-[var(--color-border-divider)]"
                  style={{ textAlign: "center", width: 160, ...TH_STYLE }}
                >
                  평균 진도
                </th>
                <th
                  className="px-4 py-3 text-sm font-semibold border-b border-[var(--color-border-divider)]"
                  style={{ textAlign: "center", width: 160, ...TH_STYLE }}
                >
                  최근 출결
                </th>
              </tr>
            </thead>

            <tbody className="divide-y divide-[var(--color-border-divider)]">
              {students.map((s) => (
                <tr key={s.student_id} className="hover:bg-[var(--color-bg-surface-soft)]">
                  <td className="px-4 py-3 text-left text-[15px] font-bold text-[var(--color-text-primary)] truncate">
                    {s.student_name}
                  </td>
                  <td className="px-4 py-3 text-center text-[14px] text-[var(--color-text-secondary)]">
                    {s.avg_progress ?? 0}%
                  </td>
                  <td className="px-4 py-3 text-center text-[13px] font-semibold text-[var(--color-text-muted)]">
                    {s.last_attendance_status ?? "-"}
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      )}
    </div>
  );
}


==========================================================================================
# FILE: pages/lectures/LectureStudentsPage.tsx
==========================================================================================
// PATH: src/features/lectures/pages/lectures/LectureStudentsPage.tsx
// 학생 테이블 = 세션 출결 테이블 UI/UX 카피: 강의 뱃지 + 체크박스, 이름, 학부모/학생 전화, N차…1차(역순) 1글자

import { useEffect, useMemo, useState } from "react";
import { useNavigate, useParams } from "react-router-dom";
import { useQuery, useQueryClient } from "@tanstack/react-query";
import api from "@/shared/api/axios";

import { fetchAttendanceMatrix, downloadAttendanceExcel } from "@/features/lectures/api/attendance";
import { sortSessionsByDateDesc } from "@/features/lectures/api/sessions";
import LectureEnrollStudentModal from "@/features/lectures/components/LectureEnrollStudentModal";
import LectureEnrollExcelModal from "@/features/lectures/components/LectureEnrollExcelModal";
import SessionCreateModal from "@/features/lectures/components/SessionCreateModal";

import AttendanceStatusBadge from "@/shared/ui/badges/AttendanceStatusBadge";
import StudentNameWithLectureChip from "@/shared/ui/chips/StudentNameWithLectureChip";
import { Button, EmptyState } from "@/shared/ui/ds";
import { DomainListToolbar, DomainTable, STUDENTS_TABLE_COL } from "@/shared/ui/domain";
import { formatPhone } from "@/shared/utils/formatPhone";
import { feedback } from "@/shared/ui/feedback/feedback";
import { useSendMessageModal } from "@/features/messages/context/SendMessageModalContext";

export default function LectureStudentsPage() {
  const navigate = useNavigate();
  const qc = useQueryClient();
  const { openSendMessageModal } = useSendMessageModal();
  const { lectureId } = useParams<{ lectureId: string }>();
  const lectureIdNum = Number(lectureId);

  const [searchInput, setSearchInput] = useState("");
  const [search, setSearch] = useState("");
  const [showLectureEnroll, setShowLectureEnroll] = useState(false);
  const [showSessionCreateModal, setShowSessionCreateModal] = useState(false);
  const [showEnrollExcelModal, setShowEnrollExcelModal] = useState(false);
  const [selectedIds, setSelectedIds] = useState<number[]>([]);

  useEffect(() => {
    const t = setTimeout(() => setSearch(searchInput), 250);
    return () => clearTimeout(t);
  }, [searchInput]);

  const { data: matrix, isLoading } = useQuery({
    queryKey: ["attendance-matrix", lectureIdNum],
    queryFn: () => fetchAttendanceMatrix(lectureIdNum),
    enabled: Number.isFinite(lectureIdNum),
  });

  const { data: lecture } = useQuery({
    queryKey: ["lecture", lectureIdNum],
    queryFn: async () => (await api.get(`/lectures/lectures/${lectureIdNum}/`)).data,
    enabled: Number.isFinite(lectureIdNum),
  });

  const students = matrix?.students ?? [];
  const sessions = matrix?.sessions ?? [];
  const sessionsByDateDesc = useMemo(() => sortSessionsByDateDesc(sessions), [sessions]);

  const filtered = useMemo(() => {
    if (!search.trim()) return students;
    const k = search.trim().toLowerCase();
    const digits = search.trim().replace(/\D/g, "");
    return students.filter(
      (s) =>
        (s.name || "").toLowerCase().includes(k) ||
        (s.phone ?? "").replace(/\D/g, "").includes(digits) ||
        (s.parent_phone ?? "").replace(/\D/g, "").includes(digits)
    );
  }, [students, search]);

  const col = STUDENTS_TABLE_COL;
  const tableMinWidth =
    col.checkbox + col.name + col.parentPhone + col.studentPhone + sessionsByDateDesc.length * col.sessionCol;

  const selectedSet = useMemo(() => new Set(selectedIds), [selectedIds]);
  const allIds = useMemo(() => filtered.map((s) => s.student_id), [filtered]);
  const allSelected = filtered.length > 0 && allIds.every((id) => selectedSet.has(id));

  function toggleSelect(id: number) {
    if (selectedSet.has(id)) setSelectedIds(selectedIds.filter((x) => x !== id));
    else setSelectedIds([...selectedIds, id]);
  }
  function toggleSelectAll() {
    if (allSelected) setSelectedIds([]);
    else setSelectedIds([...allIds]);
  }

  const selectionBar = (
    <div className="flex flex-col gap-2">
      <div className="flex flex-wrap items-center gap-2 pl-1">
        <span
          className="text-[13px] font-semibold"
          style={{
            color: selectedIds.length > 0 ? "var(--color-primary)" : "var(--color-text-muted)",
          }}
        >
          {selectedIds.length}명 선택됨
        </span>
        <span className="text-[var(--color-border-divider)]">|</span>
        <Button intent="secondary" size="sm" onClick={() => setSelectedIds([])} disabled={selectedIds.length === 0}>
          선택 해제
        </Button>
        <span className="text-[var(--color-border-divider)]">|</span>
        <Button
          intent="secondary"
          size="sm"
          disabled={selectedIds.length === 0}
          onClick={() =>
            openSendMessageModal({
              studentIds: selectedIds,
              recipientLabel: `선택한 수강생 ${selectedIds.length}명`,
            })
          }
        >
          메시지 발송
        </Button>
      <Button intent="secondary" size="sm" onClick={() => downloadAttendanceExcel(lectureIdNum)}>
        엑셀 다운로드
      </Button>
      <Button intent="secondary" size="sm" onClick={() => feedback.info("태그 추가 기능 준비 중입니다.")}>
        태그 추가
      </Button>
      <Button intent="secondary" size="sm" onClick={() => feedback.info("비밀번호 변경 기능 준비 중입니다.")}>
        비밀번호 변경
      </Button>
      <Button intent="danger" size="sm" onClick={() => feedback.info("일괄 삭제 기능 준비 중입니다.")}>
        삭제
      </Button>
      </div>
    </div>
  );

  if (!Number.isFinite(lectureIdNum)) {
    return (
      <div className="p-2 text-sm" style={{ color: "var(--color-error)" }}>
        잘못된 lectureId
      </div>
    );
  }

  return (
    <>
      <div className="flex flex-col gap-4">
        <DomainListToolbar
          totalLabel={isLoading ? "…" : `총 ${filtered.length}명`}
          searchSlot={
            <input
              className="ds-input"
              placeholder="이름 / 전화번호 검색"
              value={searchInput}
              onChange={(e) => setSearchInput(e.target.value)}
              style={{ maxWidth: 360 }}
            />
          }
          primaryAction={
            <Button intent="primary" onClick={() => setShowLectureEnroll(true)}>
              수강생 등록
            </Button>
          }
          belowSlot={selectionBar}
        />

        <div>
          {isLoading ? (
            <EmptyState scope="panel" tone="loading" title="불러오는 중…" />
          ) : !filtered.length ? (
            <EmptyState
              scope="panel"
              tone="empty"
              title="수강 중인 학생이 없습니다."
              description="강의 수강생을 등록한 뒤, 각 차시(1차시, 2차시…) 안으로 들어가서 해당 차시 수강생 등록을 해 주세요."
              actions={
                <Button intent="primary" onClick={() => setShowLectureEnroll(true)}>
                  수강생 등록
                </Button>
              }
            />
          ) : (
            <div className="overflow-x-auto w-full">
              <div style={{ width: "fit-content" }}>
                <DomainTable
                  tableClassName="ds-table--flat ds-table--attendance"
                  tableStyle={{ width: tableMinWidth, minWidth: tableMinWidth, tableLayout: "fixed" }}
                >
                  <colgroup>
                    <col style={{ width: col.checkbox }} />
                    <col style={{ width: col.name }} />
                    <col style={{ width: col.parentPhone }} />
                    <col style={{ width: col.studentPhone }} />
                    {sessionsByDateDesc.map((s) => (
                      <col key={s.id} style={{ width: col.sessionCol }} />
                    ))}
                  </colgroup>
                  <thead>
                    <tr>
                      <th scope="col" className="ds-checkbox-cell" style={{ width: col.checkbox }} onClick={(e) => e.stopPropagation()}>
                        <input
                          type="checkbox"
                          checked={allSelected}
                          onChange={toggleSelectAll}
                          aria-label="전체 선택"
                          className="cursor-pointer"
                        />
                      </th>
                      <th scope="col" style={{ width: col.name }}>이름</th>
                      <th scope="col" style={{ width: col.parentPhone }}>학부모 전화번호</th>
                      <th scope="col" style={{ width: col.studentPhone }}>학생 전화번호</th>
                      {sessionsByDateDesc.map((s) => (
                        <th
                          key={s.id}
                          scope="col"
                          className="text-center"
                          style={{ width: col.sessionCol }}
                          title={`${s.order ?? "-"}차시${s.date ? ` (${s.date})` : ""}`}
                        >
                          {s.order ?? "-"}차
                        </th>
                      ))}
                    </tr>
                  </thead>
                  <tbody>
                    {filtered.map((row) => (
                      <tr
                        key={row.student_id}
                        onClick={() => navigate(`/admin/students/${row.student_id}`)}
                        tabIndex={0}
                        role="button"
                        className={`cursor-pointer focus:outline-none focus-visible:ring-2 focus-visible:ring-[var(--color-border-focus)]/40 ${selectedSet.has(row.student_id) ? "ds-row-selected" : ""}`}
                      >
                        <td className="ds-checkbox-cell align-middle" style={{ width: col.checkbox }} onClick={(e) => e.stopPropagation()}>
                          <input
                            type="checkbox"
                            checked={selectedSet.has(row.student_id)}
                            onChange={() => toggleSelect(row.student_id)}
                            onClick={(e) => e.stopPropagation()}
                            aria-label={`${row.name} 선택`}
                            className="cursor-pointer"
                          />
                        </td>
                        <td className="text-[15px] font-bold leading-6 text-[var(--color-text-primary)] truncate align-middle" style={{ width: col.name }}>
                          <StudentNameWithLectureChip
                            name={row.name ?? ""}
                            profilePhotoUrl={row.profile_photo_url ?? undefined}
                            avatarSize={24}
                            lectures={
                              lecture?.title
                                ? [{ lectureName: lecture.title, color: lecture.color }]
                                : undefined
                            }
                            chipSize={16}
                          />
                        </td>
                        <td className="text-[14px] leading-6 text-[var(--color-text-secondary)] truncate align-middle" style={{ width: col.parentPhone }}>
                          {formatPhone(row.parent_phone)}
                        </td>
                        <td className="text-[14px] leading-6 text-[var(--color-text-secondary)] truncate align-middle" style={{ width: col.studentPhone }}>
                          {formatPhone(row.phone)}
                        </td>
                        {sessionsByDateDesc.map((s) => {
                          const cell = row.attendance[String(s.id)];
                          return (
                            <td
                              key={s.id}
                              className="text-center align-middle px-0"
                              style={{ width: col.sessionCol }}
                              onClick={(e) => e.stopPropagation()}
                            >
                              {cell?.status ? (
                                <AttendanceStatusBadge status={cell.status as any} variant="1ch" />
                              ) : (
                                <span className="text-[var(--color-text-muted)] text-[10px]">－</span>
                              )}
                            </td>
                          );
                        })}
                      </tr>
                    ))}
                  </tbody>
                </DomainTable>
              </div>
            </div>
          )}
        </div>
      </div>

      <LectureEnrollStudentModal
        lectureId={lectureIdNum}
        open={showLectureEnroll}
        onClose={() => setShowLectureEnroll(false)}
        onSuccess={() => {
          qc.invalidateQueries({ queryKey: ["attendance-matrix", lectureIdNum] });
          setShowLectureEnroll(false);
        }}
        onChooseSessionCreate={() => setShowSessionCreateModal(true)}
        onChooseExcelUpload={() => setShowEnrollExcelModal(true)}
      />

      {showSessionCreateModal && (
        <SessionCreateModal
          lectureId={lectureIdNum}
          onClose={() => setShowSessionCreateModal(false)}
        />
      )}

      <LectureEnrollExcelModal
        lectureId={lectureIdNum}
        lectureTitle={lecture?.title ?? lecture?.name ?? ""}
        open={showEnrollExcelModal}
        onClose={() => setShowEnrollExcelModal(false)}
        onSuccess={() => {
          qc.invalidateQueries({ queryKey: ["attendance-matrix", lectureIdNum] });
          setShowEnrollExcelModal(false);
        }}
      />
    </>
  );
}


==========================================================================================
# FILE: pages/lectures/LecturesPage.tsx
==========================================================================================
// PATH: src/features/lectures/pages/lectures/LecturesPage.tsx
// Design: docs/DESIGN_SSOT.md (강의 관리만 체크박스 없음 — 유일 예외)

import { useMemo, useState } from "react";
import { useQuery } from "@tanstack/react-query";
import { useNavigate } from "react-router-dom";

import api from "@/shared/api/axios";
import { EmptyState, Button } from "@/shared/ui/ds";
import { DomainListToolbar, DomainTable, DEFAULT_PRESET_COLOR, TABLE_COL } from "@/shared/ui/domain";
import LectureCreateModal from "../../components/LectureCreateModal";

type LecturesPageProps = {
  tab?: "active" | "past";
};

type LectureItem = {
  id: number;
  title: string;
  subject?: string | null;
  name?: string | null;
  start_date?: string | null;
  end_date?: string | null;
  lecture_time?: string | null;
  color?: string | null;
  is_active?: boolean;
};

type TabKey = "active" | "past";

function isPastLecture(lec: LectureItem) {
  const activeFlag =
    typeof lec.is_active === "boolean" ? lec.is_active : undefined;
  if (activeFlag === false) return true;
  if (!lec.end_date) return false;

  const end = new Date(lec.end_date);
  if (Number.isNaN(end.getTime())) return false;

  const today = new Date();
  today.setHours(0, 0, 0, 0);
  end.setHours(0, 0, 0, 0);

  return end.getTime() < today.getTime();
}

export default function LecturesPage({ tab = "active" }: LecturesPageProps = {}) {
  const navigate = useNavigate();
  const [showModal, setShowModal] = useState(false);
  const [q, setQ] = useState("");

  const { data = [], isLoading, error, isFetching } = useQuery({
    queryKey: ["lectures"],
    queryFn: async (): Promise<LectureItem[]> => {
      const res = await api.get("/lectures/lectures/");
      const list = (res.data?.results ?? res.data) as LectureItem[] | any;
      return Array.isArray(list) ? list : [];
    },
  });

  const { activeLectures, pastLectures } = useMemo(() => {
    const active: LectureItem[] = [];
    const past: LectureItem[] = [];

    for (const lec of data) {
      if (isPastLecture(lec)) past.push(lec);
      else active.push(lec);
    }

    const toTime = (v?: string | null) => {
      if (!v) return 0;
      const t = new Date(v).getTime();
      return Number.isFinite(t) ? t : 0;
    };

    active.sort((a, b) => toTime(b.start_date) - toTime(a.start_date));
    past.sort((a, b) => toTime(b.end_date) - toTime(a.end_date));

    return { activeLectures: active, pastLectures: past };
  }, [data]);

  function isLightColor(hex: string): boolean {
  const c = String(hex || "").toLowerCase();
  return ["#eab308", "#06b6d4"].includes(c);
}

  const list = useMemo(() => {
    const base = tab === "active" ? activeLectures : pastLectures;
    const keyword = q.trim().toLowerCase();
    if (!keyword) return base;

    return base.filter((lec) =>
      [
        lec.title,
        lec.subject ?? "",
        lec.name ?? "",
        lec.lecture_time ?? "",
        lec.start_date ?? "",
        lec.end_date ?? "",
      ]
        .join(" ")
        .toLowerCase()
        .includes(keyword)
    );
  }, [tab, activeLectures, pastLectures, q]);

  return (
    <>
      <div className="flex flex-col gap-4">
        <DomainListToolbar
          totalLabel={
            isLoading ? "…" : isFetching ? "동기화 중…" : `총 ${list.length}개`
          }
          searchSlot={
            <input
              className="ds-input"
              placeholder="강의 검색 (강의명/과목/강사/기간)"
              value={q}
              onChange={(e) => setQ(e.target.value)}
              style={{ maxWidth: 360 }}
            />
          }
          primaryAction={
            <Button intent="primary" onClick={() => setShowModal(true)}>
              강의 추가
            </Button>
          }
        />

        <div>
          {isLoading ? (
            <EmptyState scope="panel" tone="loading" title="불러오는 중…" />
          ) : error ? (
            <EmptyState scope="panel" tone="error" title="에러가 발생했습니다." />
          ) : list.length === 0 ? (
            <EmptyState scope="panel" tone="empty" title="표시할 강의가 없습니다." />
          ) : (
            <div style={{ width: "fit-content" }}>
              <DomainTable
                tableClassName="ds-table--flat"
                tableStyle={{
                  tableLayout: "fixed",
                  width: TABLE_COL.title + TABLE_COL.subject + TABLE_COL.medium + TABLE_COL.timeRange + TABLE_COL.dateRange + TABLE_COL.subject,
                }}
              >
                <colgroup>
                  <col style={{ width: TABLE_COL.title }} />
                  <col style={{ width: TABLE_COL.subject }} />
                  <col style={{ width: TABLE_COL.medium }} />
                  <col style={{ width: TABLE_COL.timeRange }} />
                  <col style={{ width: TABLE_COL.dateRange }} />
                  <col style={{ width: TABLE_COL.subject }} />
                </colgroup>
                <thead>
                  <tr>
                    <th scope="col">강의 이름</th>
                    <th scope="col">과목</th>
                    <th scope="col">강사</th>
                    <th scope="col">강의 시간</th>
                    <th scope="col">기간</th>
                    <th scope="col">바로가기</th>
                  </tr>
                </thead>
                <tbody>
                  {list.map((lec) => (
                    <tr
                      key={lec.id}
                      onClick={() => navigate(`/admin/lectures/${lec.id}`)}
                      tabIndex={0}
                      role="button"
                      className="cursor-pointer"
                    >
                      <td style={{ fontWeight: 600 }}>
                        <span
                          style={{
                            display: "inline-flex",
                            alignItems: "center",
                            gap: 10,
                          }}
                        >
                          <span
                            style={{
                              width: 32,
                              height: 32,
                              borderRadius: 8,
                              flexShrink: 0,
                              display: "grid",
                              placeItems: "center",
                              fontSize: 12,
                              fontWeight: 800,
                              letterSpacing: "-0.02em",
                              color: isLightColor(lec.color || "") ? "#1a1a1a" : "#fff",
                              background: lec.color || DEFAULT_PRESET_COLOR,
                              border: "none",
                              boxShadow: "0 1px 2px rgba(0,0,0,0.15)",
                              textShadow: "0 0 1px rgba(0,0,0,0.2)",
                            }}
                          >
                            {(lec.title || "??").slice(0, 2)}
                          </span>
                          {lec.title}
                        </span>
                      </td>
                      <td>{lec.subject || "-"}</td>
                      <td>{lec.name || "-"}</td>
                      <td>{lec.lecture_time || "-"}</td>
                      <td style={{ fontWeight: 600 }}>
                        {lec.start_date && lec.end_date
                          ? `${lec.start_date} ~ ${lec.end_date}`
                          : "-"}
                      </td>
                      <td onClick={(e) => e.stopPropagation()} style={{ verticalAlign: "middle" }}>
                        <div className="flex flex-wrap gap-1">
                          <button
                            type="button"
                            className="text-xs px-2 py-1 rounded border border-[var(--color-border-divider)] bg-[var(--color-bg-surface)] hover:bg-[var(--color-bg-elevated)]"
                            onClick={() =>
                              navigate(
                                `/admin/community/admin?tab=notice&scope=lecture&lectureId=${lec.id}`
                              )
                            }
                          >
                            공지
                          </button>
                          <button
                            type="button"
                            className="text-xs px-2 py-1 rounded border border-[var(--color-border-divider)] bg-[var(--color-bg-surface)] hover:bg-[var(--color-bg-elevated)]"
                            onClick={() => navigate("/admin/exams")}
                          >
                            시험
                          </button>
                          <button
                            type="button"
                            className="text-xs px-2 py-1 rounded border border-[var(--color-border-divider)] bg-[var(--color-bg-surface)] hover:bg-[var(--color-bg-elevated)]"
                            onClick={() =>
                              navigate(
                                `/admin/community/admin?tab=notice&scope=lecture&lectureId=${lec.id}`
                              )
                            }
                          >
                            게시판
                          </button>
                        </div>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </DomainTable>
            </div>
          )}
        </div>
      </div>

      {showModal && (
        <LectureCreateModal
          isOpen
          onClose={() => setShowModal(false)}
          usedColors={data?.map((l) => l.color).filter(Boolean) ?? []}
        />
      )}
    </>
  );
}


==========================================================================================
# FILE: pages/lectures/LecturesPastPage.tsx
==========================================================================================
// PATH: src/features/lectures/pages/lectures/LecturesPastPage.tsx
import { EmptyState } from "@/shared/ui/ds";

export default function LecturesPastPage() {
  return (
    <>
      {/* CARD HEADER */}
      <div className="px-5 py-4 border-b border-[var(--border-divider)]">
        <div className="text-base font-semibold">지난 강의</div>
      </div>

      {/* CARD BODY */}
      <div className="p-4">
        <EmptyState
          scope="panel"
          title="지난 강의가 없습니다."
          description="종료된 강의가 이곳에 표시됩니다."
        />
      </div>
    </>
  );
}


==========================================================================================
# FILE: pages/materials/MaterialsPage.tsx
==========================================================================================
// PATH: src/features/lectures/pages/materials/MaterialsPage.tsx
import { useMemo, useState } from "react";
import { useParams } from "react-router-dom";
import { useQuery } from "@tanstack/react-query";

import {
  fetchMaterialCategories,
  fetchMaterials,
  MaterialCategory,
  Material,
} from "../../api/materials";

import MaterialCategoryModal from "../../components/MaterialCategoryModal";
import MaterialUploadModal from "../../components/MaterialUploadModal";

import { EmptyState, Button } from "@/shared/ui/ds";

const TH_STYLE = {
  background: "color-mix(in srgb, var(--color-primary) 12%, var(--bg-surface))",
  color: "var(--color-text-muted)",
};

export default function MaterialsPage() {
  const { lectureId } = useParams<{ lectureId: string }>();
  const lectureIdNum = Number(lectureId);

  const [selectedCategory, setSelectedCategory] = useState<number | null>(null);
  const [showCategoryModal, setShowCategoryModal] = useState(false);
  const [showUploadModal, setShowUploadModal] = useState(false);

  const { data: categories = [], isLoading: loadingCats } = useQuery<MaterialCategory[]>({
    queryKey: ["material-categories", lectureIdNum],
    queryFn: () => fetchMaterialCategories(lectureIdNum),
    enabled: Number.isFinite(lectureIdNum),
  });

  const { data: materials = [], isLoading: loadingMaterials } = useQuery<Material[]>({
    queryKey: ["materials", lectureIdNum, selectedCategory ?? "all"],
    queryFn: () =>
      fetchMaterials({
        lecture: lectureIdNum,
        category: selectedCategory ?? undefined,
      }),
    enabled: Number.isFinite(lectureIdNum),
  });

  const currentCategoryName = useMemo(() => {
    return selectedCategory === null
      ? "전체 자료"
      : categories.find((c) => c.id === selectedCategory)?.name ?? "전체 자료";
  }, [selectedCategory, categories]);

  return (
    <>
      {/* 상단 액션바 (중첩 카드 없이 단일 블록) */}
      <div className="flex items-center gap-2 mb-3">
        <Button intent="secondary" onClick={() => setShowCategoryModal(true)}>
          카테고리 추가
        </Button>
        <Button intent="primary" onClick={() => setShowUploadModal(true)}>
          자료 추가
        </Button>

        <span className="ml-auto text-sm font-semibold text-[var(--color-text-muted)]">
          {loadingMaterials ? "불러오는 중…" : `${materials.length}개`}
        </span>
      </div>

      <div style={{ display: "grid", gridTemplateColumns: "240px 1fr", gap: 16 }}>
        {/* LEFT */}
        <div
          style={{
            borderRadius: 18,
            padding: 12,
            background: "var(--color-bg-surface)",
            border: "1px solid var(--color-border-divider)",
          }}
        >
          <div className="flex items-center justify-between mb-2">
            <span style={{ fontSize: 12, fontWeight: 900, color: "var(--color-text-muted)" }}>
              자료 분류
            </span>
            <Button intent="ghost" size="sm" onClick={() => setShowCategoryModal(true)}>
              + 추가
            </Button>
          </div>

          {loadingCats ? (
            <EmptyState mode="embedded" scope="panel" tone="loading" title="불러오는 중…" />
          ) : (
            <div style={{ display: "grid", gap: 6 }}>
              <Button
                intent={selectedCategory === null ? "secondary" : "ghost"}
                size="md"
                aria-pressed={selectedCategory === null}
                onClick={() => setSelectedCategory(null)}
                style={{ justifyContent: "flex-start" }}
              >
                전체 자료
              </Button>

              {categories.map((cat) => {
                const active = selectedCategory === cat.id;
                return (
                  <Button
                    key={cat.id}
                    intent={active ? "secondary" : "ghost"}
                    size="md"
                    aria-pressed={active}
                    onClick={() => setSelectedCategory(cat.id)}
                    style={{ justifyContent: "flex-start" }}
                  >
                    {cat.name}
                  </Button>
                );
              })}
            </div>
          )}
        </div>

        {/* RIGHT */}
        <div
          style={{
            borderRadius: 18,
            padding: 12,
            background: "var(--color-bg-surface)",
            border: "1px solid var(--color-border-divider)",
            overflow: "hidden",
          }}
        >
          <div className="flex items-baseline justify-between mb-2">
            <div style={{ fontSize: 12, fontWeight: 900, color: "var(--color-text-secondary)" }}>
              {currentCategoryName}
            </div>
            <div style={{ fontSize: 11, fontWeight: 850, color: "var(--color-text-muted)" }}>
              {loadingMaterials ? "불러오는 중…" : `${materials.length}개`}
            </div>
          </div>

          {loadingMaterials ? (
            <EmptyState scope="panel" tone="loading" title="불러오는 중…" />
          ) : materials.length === 0 ? (
            <EmptyState
              title="등록된 자료가 없습니다."
              description="자료를 업로드하면 여기에 표시됩니다."
              scope="panel"
            />
          ) : (
            <div style={{ overflow: "hidden", borderRadius: 14, border: "1px solid var(--color-border-divider)" }}>
              <table className="w-full" style={{ tableLayout: "fixed" }}>
                <thead>
                  <tr>
                    <th
                      className="px-4 py-3 text-sm font-semibold border-b border-[var(--color-border-divider)]"
                      style={{ textAlign: "left", whiteSpace: "nowrap", ...TH_STYLE }}
                    >
                      제목
                    </th>
                    <th
                      className="px-4 py-3 text-sm font-semibold border-b border-[var(--color-border-divider)]"
                      style={{ textAlign: "center", whiteSpace: "nowrap", width: 160, ...TH_STYLE }}
                    >
                      등록자
                    </th>
                    <th
                      className="px-4 py-3 text-sm font-semibold border-b border-[var(--color-border-divider)]"
                      style={{ textAlign: "center", whiteSpace: "nowrap", width: 140, ...TH_STYLE }}
                    >
                      등록일
                    </th>
                  </tr>
                </thead>

                <tbody className="divide-y divide-[var(--color-border-divider)]">
                  {materials.map((m) => (
                    <tr key={m.id} className="hover:bg-[var(--color-bg-surface-soft)]">
                      <td className="px-4 py-3 text-left text-[15px] font-bold truncate">
                        <a
                          href={m.file || m.url || "#"}
                          target="_blank"
                          rel="noreferrer"
                          style={{ color: "var(--color-primary)", fontWeight: 900 }}
                        >
                          {m.title}
                        </a>
                      </td>
                      <td className="px-4 py-3 text-center text-[14px] text-[var(--color-text-secondary)] truncate">
                        {m.uploader_name || "-"}
                      </td>
                      <td className="px-4 py-3 text-center text-[13px] font-semibold text-[var(--color-text-muted)] truncate">
                        {m.created_at?.slice(0, 10)}
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          )}
        </div>
      </div>

      {showCategoryModal && (
        <MaterialCategoryModal lectureId={lectureIdNum} onClose={() => setShowCategoryModal(false)} />
      )}

      {showUploadModal && (
        <MaterialUploadModal
          lectureId={lectureIdNum}
          categoryId={selectedCategory}
          onClose={() => setShowUploadModal(false)}
        />
      )}
    </>
  );
}


==========================================================================================
# FILE: pages/scores/SessionScoresEntryPage.tsx
==========================================================================================
// PATH: src/features/lectures/pages/scores/SessionScoresEntryPage.tsx
/**
 * SessionScoresEntryPage — 성적 탭 (students 도메인 SSOT)
 *
 * - DomainListToolbar + 테이블 위주 구성
 * - 차시블럭·레거시 요약 제거 (출결탭에만 차시블럭)
 */

import { useState } from "react";
import { useParams } from "react-router-dom";
import { useQuery } from "@tanstack/react-query";
import api from "@/shared/api/axios";

import SessionScoresPanel from "@/features/scores/panels/SessionScoresPanel";
import { Button, EmptyState } from "@/shared/ui/ds";
import { DomainListToolbar } from "@/shared/ui/domain";

type Props = {
  onOpenEnrollModal?: () => void;
  onOpenStudentModal?: () => void;
};

async function fetchSessionScores(sessionId: number) {
  const res = await api.get(`/results/admin/sessions/${sessionId}/scores/`);
  return res.data as { meta: unknown; rows: { enrollment_id: number; student_name: string }[] };
}

export default function SessionScoresEntryPage({
  onOpenEnrollModal,
  onOpenStudentModal,
}: Props) {
  const { sessionId } = useParams<{ sessionId: string }>();
  const numericSessionId = Number(sessionId);
  const [searchInput, setSearchInput] = useState("");

  const { data, isLoading, isError } = useQuery({
    queryKey: ["session-scores", numericSessionId],
    queryFn: () => fetchSessionScores(numericSessionId),
    enabled: Number.isFinite(numericSessionId),
  });

  const totalCount = data?.rows?.length ?? 0;

  if (!Number.isFinite(numericSessionId)) {
    return (
      <div className="p-6 text-sm" style={{ color: "var(--color-error)" }}>
        유효하지 않은 sessionId 입니다.
      </div>
    );
  }

  const primaryAction = (
    <div className="flex items-center gap-2">
      {onOpenEnrollModal && (
        <Button type="button" intent="primary" size="sm" onClick={onOpenEnrollModal}>
          수강생 등록
        </Button>
      )}
      {onOpenStudentModal && (
        <Button type="button" intent="secondary" size="sm" onClick={onOpenStudentModal}>
          학생 추가
        </Button>
      )}
    </div>
  );

  return (
    <div className="flex flex-col gap-4">
      <DomainListToolbar
        totalLabel={isLoading ? "…" : `총 ${totalCount}명`}
        searchSlot={
          <input
            type="search"
            className="ds-input"
            placeholder="이름 검색 (초성 검색 가능)"
            value={searchInput}
            onChange={(e) => setSearchInput(e.target.value)}
            style={{ maxWidth: 280 }}
            aria-label="학생 이름 검색"
          />
        }
        filterSlot={null}
        primaryAction={primaryAction}
      />

      {isLoading && (
        <EmptyState scope="panel" tone="loading" title="성적 불러오는 중…" />
      )}

      {!isLoading && isError && (
        <EmptyState scope="panel" tone="error" title="성적 로드 실패" />
      )}

      {!isLoading && !isError && (
        <SessionScoresPanel
          sessionId={numericSessionId}
          search={searchInput}
        />
      )}
    </div>
  );
}


==========================================================================================
# FILE: pages/sessions/LectureSessionsPage.tsx
==========================================================================================
// PATH: src/features/lectures/pages/sessions/LectureSessionsPage.tsx
import { useState, useMemo, useCallback } from "react";
import { useParams, useNavigate, Link } from "react-router-dom";
import { useQuery, useQueryClient } from "@tanstack/react-query";

import { fetchSessions, sortSessionsByDateDesc, type Session } from "../../api/sessions";
import SessionCreateModal from "../../components/SessionCreateModal";
import { EmptyState, Button } from "@/shared/ui/ds";
import { DomainListToolbar, DomainTable, TABLE_COL } from "@/shared/ui/domain";

export default function LectureSessionsPage() {
  const navigate = useNavigate();
  const qc = useQueryClient();
  const { lectureId } = useParams<{ lectureId: string }>();
  const lecId = Number(lectureId);

  const [open, setOpen] = useState(false);
  const [selectedIds, setSelectedIds] = useState<number[]>([]);

  const { data: rawSessions = [], isLoading, isError } = useQuery<Session[]>({
    queryKey: ["lecture-sessions", lecId],
    queryFn: () => fetchSessions(lecId),
    enabled: Number.isFinite(lecId),
  });
  const sessions = useMemo(() => sortSessionsByDateDesc(rawSessions), [rawSessions]);

  const selectedSet = useMemo(() => new Set(selectedIds), [selectedIds]);
  const allIds = useMemo(() => sessions.map((s) => s.id), [sessions]);
  const allSelected = useMemo(
    () => sessions.length > 0 && allIds.length > 0 && allIds.every((id) => selectedIds.includes(id)),
    [sessions.length, allIds, selectedIds]
  );

  const toggleSelect = useCallback(
    (id: number) => {
      setSelectedIds((prev) => {
        if (prev.includes(id)) {
          return prev.filter((x) => x !== id);
        } else {
          return [...prev, id];
        }
      });
    },
    []
  );

  const toggleSelectAll = useCallback(() => {
    setSelectedIds((prev) => {
      if (allSelected) {
        return [];
      } else {
        return [...allIds];
      }
    });
  }, [allSelected, allIds]);

  const handleClearSelection = useCallback(() => {
    setSelectedIds([]);
  }, []);

  const selectionBar = useMemo(
    () => (
      <div className="flex flex-wrap items-center gap-2 pl-1">
        <span
          className="text-[13px] font-semibold"
          style={{
            color: selectedIds.length > 0 ? "var(--color-primary)" : "var(--color-text-muted)",
          }}
        >
          {selectedIds.length}개 선택됨
        </span>
        <span className="text-[var(--color-border-divider)]">|</span>
        <Button intent="secondary" size="sm" onClick={handleClearSelection} disabled={selectedIds.length === 0}>
          선택 해제
        </Button>
      </div>
    ),
    [selectedIds.length, handleClearSelection]
  );

  const handleClose = useCallback(() => {
    setOpen(false);
    qc.invalidateQueries({ queryKey: ["lecture-sessions", lecId] });
  }, [qc, lecId]);

  if (!Number.isFinite(lecId)) {
    return <div className="p-2 text-sm" style={{ color: "var(--color-error)" }}>잘못된 강의 ID</div>;
  }

  return (
    <>
      <div className="flex flex-col gap-4">
        {isLoading ? (
          <EmptyState scope="panel" tone="loading" title="불러오는 중…" />
        ) : isError ? (
          <EmptyState scope="panel" tone="error" title="차시 데이터를 불러올 수 없습니다." />
        ) : sessions.length === 0 ? (
          <EmptyState
            scope="panel"
            tone="empty"
            title="등록된 차시가 없습니다."
            description="차시를 추가하면 여기에 표시됩니다."
            actions={
              <Button intent="primary" onClick={() => setOpen(true)}>
                + 차시 추가
              </Button>
            }
          />
        ) : (
          <>
            <DomainListToolbar
              totalLabel={`총 ${sessions.length}개`}
              searchSlot={null}
              primaryAction={
                <Button intent="primary" onClick={() => setOpen(true)}>
                  + 차시 추가
                </Button>
              }
              belowSlot={selectionBar}
            />
            <DomainTable
              tableClassName="ds-table--flat"
              tableStyle={{
                tableLayout: "fixed",
                width:
                  TABLE_COL.checkbox + TABLE_COL.mediumAlt + TABLE_COL.title + TABLE_COL.timeRange + TABLE_COL.tag,
              }}
            >
              <colgroup>
                <col style={{ width: TABLE_COL.checkbox }} />
                <col style={{ width: TABLE_COL.mediumAlt }} />
                <col style={{ width: TABLE_COL.title }} />
                <col style={{ width: TABLE_COL.timeRange }} />
                <col style={{ width: TABLE_COL.tag }} />
              </colgroup>
              <thead>
                <tr>
                  <th scope="col" className="ds-checkbox-cell" style={{ width: TABLE_COL.checkbox }} onClick={(e) => e.stopPropagation()}>
                    <input
                      type="checkbox"
                      checked={allSelected}
                      onChange={toggleSelectAll}
                      aria-label="전체 선택"
                      className="cursor-pointer"
                    />
                  </th>
                  <th scope="col">차시</th>
                  <th scope="col">제목</th>
                  <th scope="col">날짜</th>
                  <th scope="col">ID</th>
                </tr>
              </thead>
              <tbody>
                {sessions.map((s) => (
                  <tr
                    key={s.id}
                    className={`cursor-pointer hover:bg-[var(--color-bg-surface-hover)] ${selectedSet.has(s.id) ? "ds-row-selected" : ""}`}
                    onClick={() => navigate(`/admin/lectures/${lectureId}/sessions/${s.id}`)}
                  >
                    <td className="ds-checkbox-cell" style={{ width: TABLE_COL.checkbox }} onClick={(e) => e.stopPropagation()}>
                      <input
                        type="checkbox"
                        checked={selectedSet.has(s.id)}
                        onChange={() => toggleSelect(s.id)}
                        onClick={(e) => e.stopPropagation()}
                        aria-label={`${s.title} 선택`}
                        className="cursor-pointer"
                      />
                    </td>
                    <td className="text-[15px] font-bold text-[var(--color-text-primary)] truncate">
                      <Link
                        to={`/admin/lectures/${lectureId}/sessions/${s.id}`}
                        style={{ color: "inherit", textDecoration: "none" }}
                        onClick={(e) => e.stopPropagation()}
                      >
                        {s.order ?? "-"}차시
                      </Link>
                    </td>
                    <td className="text-[14px] text-[var(--color-text-secondary)] truncate">
                      {s.title || "-"}
                    </td>
                    <td className="text-[14px] text-[var(--color-text-secondary)] truncate text-center">
                      {s.date || "-"}
                    </td>
                    <td className="text-[13px] font-semibold text-[var(--color-text-muted)] truncate text-center">
                      {s.id}
                    </td>
                  </tr>
                ))}
              </tbody>
            </DomainTable>
          </>
        )}
      </div>

      {open && <SessionCreateModal lectureId={lecId} onClose={handleClose} />}
    </>
  );
}
