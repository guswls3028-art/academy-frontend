====================================================================================================
# FRONTEND FOLDER: features__clinic
# ROOT PATH: C:\academyfront\src\features\clinic
====================================================================================================


==========================================================================================
# FILE: ClinicLayout.tsx
==========================================================================================
// PATH: src/features/clinic/ClinicLayout.tsx
// í´ë¦¬ë‹‰ ë„ë©”ì¸ â€” Domain Header + ds-tabs + panel (í”„ë¦¬ë¯¸ì—„ SaaS í†¤)

import "./clinic.css";
import { Outlet } from "react-router-dom";
import { DomainLayout } from "@/shared/ui/layout";

const CLINIC_TABS = [
  { key: "home", label: "í™ˆ", path: "/admin/clinic/home" },
  { key: "operations", label: "ìš´ì˜", path: "/admin/clinic/operations" },
  { key: "bookings", label: "ì˜ˆì•½ëŒ€ìƒì", path: "/admin/clinic/bookings" },
  { key: "reports", label: "ë¦¬í¬íŠ¸", path: "/admin/clinic/reports" },
  { key: "settings", label: "ì„¤ì •", path: "/admin/clinic/settings" },
];

export default function ClinicLayout() {
  return (
    <DomainLayout
      title="í´ë¦¬ë‹‰"
      description="ëŒ€ìƒìÂ·ì˜ˆì•½Â·ìš´ì˜ì„ í•œ í™”ë©´ì—ì„œ. ëŒ€í˜• ê°•ì‚¬ìš© í†µì œì‹¤."
      tabs={CLINIC_TABS}
    >
      <Outlet />
    </DomainLayout>
  );
}


==========================================================================================
# FILE: ClinicRoutes.tsx
==========================================================================================
import { Routes, Route, Navigate } from "react-router-dom";
import ClinicLayout from "./ClinicLayout";

import ClinicHomePage from "./pages/HomePage/ClinicHomePage";
import ClinicOperationsPage from "./pages/OperationsPage/ClinicOperationsPage";
import ClinicReportsPage from "./pages/ReportsPage/ClinicReportsPage";
import ClinicSettingsPage from "./pages/SettingsPage/ClinicSettingsPage";
import ClinicBookingsPage from "./pages/BookingsPage/ClinicBookingsPage";

export default function ClinicRoutes() {
  return (
    <Routes>
      <Route element={<ClinicLayout />}>
        <Route index element={<Navigate to="home" replace />} />
        <Route path="home" element={<ClinicHomePage />} />
        <Route path="operations" element={<ClinicOperationsPage />} />
        <Route path="bookings" element={<ClinicBookingsPage />} />
        <Route path="reports" element={<ClinicReportsPage />} />
        <Route path="settings" element={<ClinicSettingsPage />} />
      </Route>
    </Routes>
  );
}


==========================================================================================
# FILE: clinic.css
==========================================================================================
/* PATH: src/features/clinic/clinic.css
   í´ë¦¬ë‹‰ ë„ë©”ì¸ â€” í”„ë¦¬ë¯¸ì—„ SaaS ì˜ì—­ êµ¬ë¶„ (í† í° ê¸°ë°˜) */

/* ì¹´ë“œ ì˜ì—­: ì„ Â·ê¹Šì´ë¡œ êµ¬ë¶„ (12í…Œë§ˆ ê³µí†µ) */
.clinic-card {
  border-radius: var(--radius-xl);
  border: 1px solid var(--color-border-divider-strong);
  background: var(--color-bg-surface);
  box-shadow: var(--elevation-2);
  overflow: hidden;
}

.clinic-card__header {
  padding: var(--space-5) var(--space-6);
  border-bottom: 1px solid var(--color-border-divider);
  background: color-mix(in srgb, var(--color-primary) 8%, var(--color-bg-surface-soft));
}

.clinic-card__body {
  padding: var(--space-6);
}

/* ì£¼ê°„ ì¼ì • ìš”ì¼ ì…€ */
.clinic-day-cell {
  border-radius: var(--radius-lg);
  border: 1px solid var(--color-border-divider);
  background: var(--color-bg-surface-soft);
  padding: var(--space-4);
  transition: background-color var(--motion-base) var(--ease-out);
}

.clinic-day-cell:hover {
  background: var(--color-bg-surface-hover);
}

/* KPI/ìˆ«ì ê°•ì¡° ë¸”ë¡ */
.clinic-kpi-block {
  border-radius: var(--radius-lg);
  border: 1px solid var(--color-border-divider);
  background: var(--color-bg-surface-soft);
  padding: var(--space-4);
}


==========================================================================================
# FILE: api/clinicMe.api.ts
==========================================================================================
import api from "@/shared/api/axios";

/**
 * ê¶Œí•œ ë‹¨ì¼ì§„ì‹¤
 * - ìŠ¤íƒœí”„/ê´€ë¦¬ì UX ë¶„ê¸°
 * - (staff ë„ë©”ì¸ê³¼ ë™ì¼ ìŠ¤í™ì„ clinicì—ì„œ ë…ë¦½ ì‚¬ìš©)
 */
export type ClinicMe = {
  is_authenticated: boolean;
  is_superuser: boolean;
  is_staff: boolean;
  is_payroll_manager: boolean;
};

export async function fetchClinicMe() {
  const res = await api.get("/staffs/me/");
  return res.data as ClinicMe;
}


==========================================================================================
# FILE: api/clinicParticipants.api.ts
==========================================================================================
// PATH: src/features/clinic/api/clinicParticipants.api.ts
import api from "@/shared/api/axios";

export type ClinicParticipantStatus =
  | "pending"
  | "booked"
  | "attended"
  | "no_show"
  | "cancelled"
  | "rejected";

export type ClinicParticipant = {
  id: number;

  // âœ… ë°±ì—”ë“œ ë‹¨ì¼ì§„ì‹¤: session FK
  session: number;

  student_name: string;
  enrollment_id?: number;
  clinic_reason?: "exam" | "homework" | "both";

  session_date: string;
  session_start_time: string;
  session_end_time?: string;
  session_location: string;

  status: ClinicParticipantStatus;
  memo?: string;
};

export async function fetchClinicParticipants(params: {
  session?: number; // ParticipantFilter.session (session_id)
  session_date_from?: string;
  session_date_to?: string;
  status?: ClinicParticipantStatus;
}) {
  const res = await api.get("/clinic/participants/", { params });

  // âœ… pagination ëŒ€ì‘
  if (Array.isArray(res.data)) return res.data as ClinicParticipant[];
  if (Array.isArray(res.data?.results)) return res.data.results as ClinicParticipant[];
  return [];
}

export async function patchClinicParticipantStatus(
  id: number,
  payload: { status: ClinicParticipantStatus; memo?: string }
) {
  const res = await api.patch(`/clinic/participants/${id}/set_status/`, payload);
  return res.data as ClinicParticipant;
}


==========================================================================================
# FILE: api/clinicSessions.api.ts
==========================================================================================
// PATH: src/features/clinic/api/clinicSessions.api.ts
import api from "@/shared/api/axios";

export type ClinicSessionTreeNode = {
  id: number;
  date: string; // YYYY-MM-DD
  start_time: string; // "HH:MM:SS" or "HH:MM"
  location: string;

  participant_count: number;
  booked_count: number;
  no_show_count: number;
};

/**
 * ìš´ì˜ ì¢Œì¸¡ íŠ¸ë¦¬ ì „ìš©
 * GET /clinic/sessions/tree/?year=YYYY&month=MM
 */
export async function fetchClinicSessionTree(params: {
  year: number;
  month: number; // 1~12
}) {
  const res = await api.get("/clinic/sessions/tree/", { params });

  if (Array.isArray(res.data)) return res.data as ClinicSessionTreeNode[];
  if (Array.isArray(res.data?.results)) return res.data.results as ClinicSessionTreeNode[];
  return [];
}


==========================================================================================
# FILE: api/clinicSettings.api.ts
==========================================================================================
// PATH: src/features/clinic/api/clinicSettings.api.ts
import api from "@/shared/api/axios";

export type ClinicSettings = {
  colors: [string, string, string];
};

export async function fetchClinicSettings(): Promise<ClinicSettings> {
  const res = await api.get("/clinic/settings/");
  const colors = res.data?.colors || ["#ef4444", "#3b82f6", "#22c55e"];
  return {
    colors: [colors[0] || "#ef4444", colors[1] || "#3b82f6", colors[2] || "#22c55e"],
  };
}

export async function updateClinicSettings(colors: [string, string, string]): Promise<ClinicSettings> {
  const res = await api.patch("/clinic/settings/", { colors });
  const updatedColors = res.data?.colors || colors;
  return {
    colors: [updatedColors[0] || colors[0], updatedColors[1] || colors[1], updatedColors[2] || colors[2]],
  };
}


==========================================================================================
# FILE: api/clinicStudents.api.ts
==========================================================================================
// PATH: src/features/clinic/api/clinicStudents.api.ts
import api from "@/shared/api/axios";

export type ClinicStudent = {
  id: number;
  name: string;
};

function normalize(resData: any): ClinicStudent[] {
  const arr = Array.isArray(resData)
    ? resData
    : Array.isArray(resData?.results)
    ? resData.results
    : [];
  return arr.map((s: any) => ({ id: s.id, name: s.name })) as ClinicStudent[];
}

// âœ… í•™ìƒ ê²€ìƒ‰ (2ê¸€ì ì´ìƒì¼ ë•Œ ì‚¬ìš©)
export async function searchClinicStudents(params: { q: string }) {
  const res = await api.get("/students/", {
    params: { search: params.q },
  });
  return normalize(res.data);
}

// âœ… ì „ì²´ í•™ìƒ "ì´ˆê¸° ëª©ë¡" (ì²« í˜ì´ì§€)
export async function fetchClinicStudentsDefault() {
  const res = await api.get("/students/");
  return normalize(res.data);
}


==========================================================================================
# FILE: api/clinicTargets.ts
==========================================================================================
import api from "@/shared/api/axios";

/**
 * ğŸ”¹ ClinicReason
 * - backend(results)ê°€ ë‚´ë ¤ì£¼ëŠ” íŒì • ê²°ê³¼
 * - exam / homework / both
 */
export type ClinicReason = "exam" | "homework" | "both";

/**
 * âœ… ClinicTarget
 * - ì‹œí—˜ / ê³¼ì œ ê¸°ì¤€ìœ¼ë¡œ ìë™ ì„ ì •ëœ í´ë¦¬ë‹‰ ëŒ€ìƒì
 * - backendì—ì„œ ClinicLink(is_auto=True) ë‹¨ì¼ ê¸°ì¤€ìœ¼ë¡œ ìƒì„±
 *
 * âš ï¸ ì„¤ê³„ ê³„ì•½
 * - ëŒ€ìƒì ì„ ì •/íŒì • ë‹¨ì¼ ì§„ì‹¤ì€ backend(results)ì´ë‹¤.
 * - í”„ë¡ íŠ¸ëŠ” ê³„ì‚°/í•„í„°ë§/ì¶”ë¡ ì„ í•˜ì§€ ì•Šê³  "í‘œì‹œ"ë§Œ í•œë‹¤.
 * - enrollment_id ê¸°ì¤€ìœ¼ë¡œë§Œ ì‹ë³„í•œë‹¤.
 */
export type ClinicTarget = {
  enrollment_id: number;
  student_name: string;
  session_title: string;

  clinic_reason?: ClinicReason;

  reason?: "score" | "confidence"; // legacy (ì‹œí—˜-only)
  exam_score?: number;
  cutline_score?: number;

  homework_score?: number;
  homework_cutline?: number;

  created_at: string;
};

/**
 * GET /results/admin/clinic-targets/
 */
export async function fetchClinicTargets() {
  const res = await api.get("/results/admin/clinic-targets/");
  return res.data as ClinicTarget[];
}


==========================================================================================
# FILE: components/ClinicCreatePanel.tsx
==========================================================================================
// PATH: src/features/clinic/components/ClinicCreatePanel.tsx

import { useEffect, useMemo, useState } from "react";
import {
  Input,
  Button,
  Checkbox,
  Segmented,
  Select,
  message,
  Divider,
} from "antd";
import dayjs from "dayjs";

import { DatePicker } from "@/shared/ui/date";
import { useMutation, useQuery, useQueryClient } from "@tanstack/react-query";

import { useClinicTargets } from "../hooks/useClinicTargets";
import { useClinicStudentSearch } from "../hooks/useClinicStudentSearch";
import { fetchClinicStudentsDefault } from "../api/clinicStudents.api";

import api from "@/shared/api/axios";

type TargetRow = {
  enrollment_id: number;
  student_name: string;
};

type StudentRow = {
  id: number;
  name: string;
};

const TIME_OPTIONS = Array.from({ length: 26 }, (_, i) => {
  const h = Math.floor(i / 2) + 9;
  const m = i % 2 === 0 ? "00" : "30";
  return `${String(h).padStart(2, "0")}:${m}`;
});

function todayISO() {
  return new Date().toISOString().slice(0, 10);
}

function addMinutes(base: string | undefined, minutes: number) {
  if (!base) return undefined;
  const [h, m] = base.split(":").map(Number);
  const d = new Date();
  d.setHours(h, m, 0, 0);
  d.setMinutes(d.getMinutes() + minutes);
  return `${String(d.getHours()).padStart(2, "0")}:${String(
    d.getMinutes()
  ).padStart(2, "0")}`;
}

type Props = {
  date?: string;
  defaultMode?: "targets" | "students";
  hideDatePicker?: boolean;
  selectedTargetEnrollmentIds?: number[];
  onChangeSelectedTargetEnrollmentIds?: (ids: number[]) => void;
  onCreated?: () => void;
};

export default function ClinicCreatePanel({
  date,
  defaultMode = "targets",
  hideDatePicker = false,
  selectedTargetEnrollmentIds,
  onChangeSelectedTargetEnrollmentIds,
  onCreated,
}: Props) {
  const qc = useQueryClient();

  const initialDate = date ?? todayISO();
  const [selectedDate, setSelectedDate] = useState(dayjs(initialDate));

  useEffect(() => {
    if (date) setSelectedDate(dayjs(date));
  }, [date]);

  const [mode, setMode] = useState<"targets" | "students">(defaultMode);
  const [keyword, setKeyword] = useState("");

  const [internalSelected, setInternalSelected] = useState<number[]>([]);
  const selected =
    mode === "targets" && Array.isArray(selectedTargetEnrollmentIds)
      ? selectedTargetEnrollmentIds
      : internalSelected;

  const setSelected = (next: number[] | ((prev: number[]) => number[])) => {
    const resolved =
      typeof next === "function" ? (next as any)(selected) : next;
    if (mode === "targets" && onChangeSelectedTargetEnrollmentIds) {
      onChangeSelectedTargetEnrollmentIds(resolved);
      return;
    }
    setInternalSelected(resolved);
  };

  const [startTime, setStartTime] = useState<string>();
  const [endTime, setEndTime] = useState<string>();

  /**
   * âœ… UX ìˆ˜ì • í¬ì¸íŠ¸
   * - +30 / +1ì‹œê°„ ë²„íŠ¼ì€ "ëˆ„ì "
   * - endTimeì´ ìˆìœ¼ë©´ endTime ê¸°ì¤€ìœ¼ë¡œ ì¶”ê°€
   * - ì—†ìœ¼ë©´ startTime ê¸°ì¤€ìœ¼ë¡œ ìµœì´ˆ ê³„ì‚°
   */
  const quickAdd = (m: number) => {
    if (!startTime) {
      message.warning("ì‹œì‘ ì‹œê°„ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.");
      return;
    }

    // ê¸°ì¤€ì : endTimeì´ ìˆìœ¼ë©´ ê·¸ ë’¤ì— ëˆ„ì , ì—†ìœ¼ë©´ startTime ê¸°ì¤€
    const base = endTime ?? startTime;
    setEndTime(addMinutes(base, m));
  };

  const [room, setRoom] = useState("");
  const [memo, setMemo] = useState("");

  const targetsQ = useClinicTargets();
  const studentsSearchQ = useClinicStudentSearch(keyword);

  const studentsDefaultQ = useQuery({
    queryKey: ["clinic-students-default"],
    queryFn: fetchClinicStudentsDefault,
    enabled: mode === "students" && keyword.trim().length < 2,
    staleTime: 10_000,
    retry: 0,
  });

  const rows = useMemo(() => {
    if (mode === "targets") {
      const arr = (targetsQ.data ?? []) as TargetRow[];
      if (!keyword.trim()) return arr;
      return arr.filter((t) =>
        (t.student_name || "").includes(keyword.trim())
      );
    }
    if (keyword.trim().length >= 2)
      return (studentsSearchQ.data ?? []) as StudentRow[];
    return (studentsDefaultQ.data ?? []) as StudentRow[];
  }, [
    mode,
    targetsQ.data,
    keyword,
    studentsSearchQ.data,
    studentsDefaultQ.data,
  ]);

  const allChecked = rows.length > 0 && selected.length === rows.length;

  const toggleAll = () => {
    if (allChecked) {
      setSelected([]);
      return;
    }
    if (mode === "targets") {
      setSelected((rows as TargetRow[]).map((r) => r.enrollment_id));
    } else {
      setSelected((rows as StudentRow[]).map((r) => r.id));
    }
  };

  const createSessionM = useMutation({
    mutationFn: async (payload: {
      date: string;
      start_time: string;
      duration_minutes: number;
      location: string;
      max_participants: number;
    }) => {
      const res = await api.post("/clinic/sessions/", payload);
      return res.data as { id: number };
    },
  });

  const submit = async () => {
    if (!startTime || !endTime)
      return message.warning("ì‹œì‘/ì¢…ë£Œ ì‹œê°„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
    if (selected.length === 0)
      return message.warning("í•™ìƒì„ 1ëª… ì´ìƒ ì„ íƒí•´ì£¼ì„¸ìš”.");
    if (!room.trim()) return message.warning("ì¥ì†Œ/ë£¸ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");

    const [sh, sm] = startTime.split(":").map(Number);
    const [eh, em] = endTime.split(":").map(Number);
    const duration = eh * 60 + em - (sh * 60 + sm);

    if (duration <= 0)
      return message.error("ì¢…ë£Œ ì‹œê°„ì€ ì‹œì‘ ì‹œê°„ ì´í›„ì—¬ì•¼ í•©ë‹ˆë‹¤.");

    try {
      await createSessionM.mutateAsync({
        date: selectedDate.format("YYYY-MM-DD"),
        start_time: startTime,
        duration_minutes: duration,
        location: room.trim(),
        max_participants: selected.length,
      });

      message.success("í´ë¦¬ë‹‰ ìƒì„± ì™„ë£Œ");
      setSelected([]);
      setMemo("");
      setEndTime(undefined);
      qc.invalidateQueries({ queryKey: ["clinic-participants"] });
      qc.invalidateQueries({ queryKey: ["clinic-sessions-tree"] });
      onCreated?.();
    } catch (e: any) {
      message.error(e?.response?.data?.detail || "ìƒì„± ì‹¤íŒ¨");
    }
  };

  return (
    <div className="rounded-2xl border bg-[var(--bg-surface)] overflow-hidden">
      <div className="px-5 py-4 border-b bg-[var(--bg-surface-soft)] flex items-center justify-between">
        <div>
          <div className="text-sm font-semibold">í´ë¦¬ë‹‰ ìƒì„±</div>
          <div className="text-[11px] text-[var(--text-muted)] mt-0.5">
            ì‹œì‘Â·ì¢…ë£Œ ì‹œê°„ ì„¤ì •
          </div>
        </div>
        <div className="text-xs text-[var(--text-muted)]">
          ì„ íƒ {selected.length}ëª…
        </div>
      </div>

      <div className="p-5 space-y-4">
        {!hideDatePicker && (
          <DatePicker
            value={selectedDate.format("YYYY-MM-DD")}
            onChange={(s) => setSelectedDate(dayjs(s))}
            placeholder="ë‚ ì§œ ì„ íƒ"
          />
        )}

        <div className="flex gap-2">
          <Select
            placeholder="ì‹œì‘ ì‹œê°„"
            options={TIME_OPTIONS.map((t) => ({ label: t, value: t }))}
            value={startTime}
            onChange={(v) => {
              setStartTime(v);
              setEndTime(undefined); // ì‹œì‘ ì‹œê°„ ë°”ë€Œë©´ ì¢…ë£Œ ë¦¬ì…‹
            }}
            className="flex-1 bg-[var(--bg-surface)]"
          />
          <Select
            placeholder="ì¢…ë£Œ ì‹œê°„"
            options={TIME_OPTIONS.map((t) => ({ label: t, value: t }))}
            value={endTime}
            onChange={setEndTime}
            className="flex-1 bg-[var(--bg-surface)]"
          />
        </div>

        <div className="flex gap-2">
          <Button onClick={() => quickAdd(30)}>+30ë¶„</Button>
          <Button onClick={() => quickAdd(60)}>+1ì‹œê°„</Button>
        </div>

        <Input
          placeholder="ì¥ì†Œ / ë£¸"
          value={room}
          onChange={(e) => setRoom(e.target.value)}
          className="bg-[var(--bg-surface)]"
        />

        <Input.TextArea
          rows={2}
          placeholder="ë©”ëª¨ (ì„ íƒ)"
          value={memo}
          onChange={(e) => setMemo(e.target.value)}
          className="bg-[var(--bg-surface)]"
        />

        <Divider className="my-2" />

        <div className="space-y-2">
          <Segmented
            options={[
              { label: "ì˜ˆì•½ ëŒ€ìƒì", value: "targets" },
              { label: "ì „ì²´ í•™ìƒ", value: "students" },
            ]}
            value={mode}
            onChange={(v) => {
              setMode(v as any);
              setKeyword("");
              setSelected([]);
            }}
          />

          <Input
            placeholder={
              mode === "students"
                ? "í•™ìƒ ê²€ìƒ‰ (2ê¸€ì ì´ìƒ)"
                : "ëŒ€ìƒì ë‚´ ê²€ìƒ‰"
            }
            value={keyword}
            onChange={(e) => setKeyword(e.target.value)}
            allowClear
            className="bg-[var(--bg-surface)]"
          />

          <div className="flex items-center justify-between text-xs">
            <Checkbox checked={allChecked} onChange={toggleAll}>
              ì „ì²´ ì„ íƒ
            </Checkbox>
          </div>

          <div className="max-h-[360px] overflow-auto border rounded-lg p-2 space-y-1">
            {rows.map((r: any) => {
              const key =
                mode === "targets" ? r.enrollment_id : r.id;
              const label =
                mode === "targets" ? r.student_name : r.name;
              return (
                <label
                  key={key}
                  className="flex items-center gap-2 text-sm px-2 py-1 rounded hover:bg-[var(--bg-surface-soft)]"
                >
                  <input
                    type="checkbox"
                    checked={selected.includes(key)}
                    onChange={(e) => {
                      setSelected((prev) =>
                        e.target.checked
                          ? [...prev, key]
                          : prev.filter((id) => id !== key)
                      );
                    }}
                  />
                  <span className="flex-1">{label}</span>
                </label>
              );
            })}
          </div>

          <Button
            type="primary"
            block
            loading={createSessionM.isPending}
            onClick={submit}
          >
            ì„ íƒ {selected.length}ëª… í´ë¦¬ë‹‰ ìƒì„±
          </Button>
        </div>
      </div>
    </div>
  );
}


==========================================================================================
# FILE: components/ClinicDaySchedulePanel.tsx
==========================================================================================
// PATH: src/features/clinic/components/ClinicDaySchedulePanel.tsx
import { ClinicParticipant } from "../api/clinicParticipants.api";

export default function ClinicDaySchedulePanel({
  date,
  rows,
}: {
  date: string;
  rows: ClinicParticipant[];
}) {
  if (!rows.length) {
    return (
      <div className="rounded-2xl border bg-[var(--bg-surface)] p-5">
        <div className="text-sm font-semibold">í´ë¦¬ë‹‰ ì¼ì •</div>
        <div className="mt-2 text-xs text-[var(--text-muted)]">
          {date}ì— ì¡íŒ í´ë¦¬ë‹‰ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.
        </div>
      </div>
    );
  }

  const byTime = rows.reduce<Record<string, ClinicParticipant[]>>((acc, r) => {
    const t = (r.session_start_time || "").slice(0, 5) || "-";
    acc[t] ??= [];
    acc[t].push(r);
    return acc;
  }, {});

  const times = Object.keys(byTime).sort((a, b) => (a > b ? 1 : -1));

  return (
    <div className="rounded-2xl border bg-[var(--bg-surface)] overflow-hidden">
      <div className="px-5 py-4 border-b bg-[var(--bg-surface-soft)]">
        <div className="text-sm font-semibold">í´ë¦¬ë‹‰ ì¼ì •</div>
      </div>

      <div className="p-5 space-y-4">
        {times.map((time) => {
          const items = byTime[time] ?? [];
          return (
            <div key={time}>
              <div className="text-xs font-semibold mb-1">{time}</div>
              <ul className="space-y-1">
                {items.map((r) => (
                  <li
                    key={r.id}
                    className="rounded-lg border bg-[var(--bg-surface-soft)] px-3 py-2"
                  >
                    <div className="text-sm font-semibold">{r.student_name}</div>
                    <div className="text-[11px] text-[var(--text-muted)]">
                      {r.session_location}
                    </div>
                  </li>
                ))}
              </ul>
            </div>
          );
        })}
      </div>
    </div>
  );
}


==========================================================================================
# FILE: components/ClinicRemoteControl.tsx
==========================================================================================
// PATH: src/features/clinic/components/ClinicRemoteControl.tsx
// í´ë¦¬ë‹‰ ë¦¬ëª¨ì»¨ - ì„ ìƒë‹˜ì´ ì‹¤ì‹œê°„ìœ¼ë¡œ í•™ìƒ íŒ¨ìŠ¤ì¹´ë“œ ë°°ê²½ìƒ‰ ë³€ê²½

import { useState, useCallback } from "react";
import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { fetchClinicSettings, updateClinicSettings } from "../api/clinicSettings.api";
import { Button } from "@/shared/ui/ds";
import { feedback } from "@/shared/ui/feedback/feedback";
import AdminModal from "@/shared/ui/modal/AdminModal";
import { MODAL_WIDTH } from "@/shared/ui/modal";
import ModalHeader from "@/shared/ui/modal/ModalHeader";
import ModalBody from "@/shared/ui/modal/ModalBody";
import ModalFooter from "@/shared/ui/modal/ModalFooter";

// ë¯¸ë¦¬ ì •ì˜ëœ ìƒ‰ìƒ íŒ”ë ˆíŠ¸
const COLOR_PALETTE = [
  // ë¹¨ê°• ê³„ì—´
  "#ef4444", "#dc2626", "#b91c1c", "#991b1b",
  // íŒŒë‘ ê³„ì—´
  "#3b82f6", "#2563eb", "#1d4ed8", "#1e40af",
  // ì´ˆë¡ ê³„ì—´
  "#22c55e", "#16a34a", "#15803d", "#166534",
  // ë…¸ë‘ ê³„ì—´
  "#eab308", "#ca8a04", "#a16207", "#854d0e",
  // ë³´ë¼ ê³„ì—´
  "#a855f7", "#9333ea", "#7e22ce", "#6b21a8",
  // í•‘í¬ ê³„ì—´
  "#ec4899", "#db2777", "#be185d", "#9f1239",
  // ì˜¤ë Œì§€ ê³„ì—´
  "#f97316", "#ea580c", "#c2410c", "#9a3412",
  // ì²­ë¡ ê³„ì—´
  "#14b8a6", "#0d9488", "#0f766e", "#115e59",
];

type ColorSelectModalProps = {
  open: boolean;
  onClose: () => void;
  onSelect: (color: string) => void;
  currentColor: string;
};

function ColorSelectModal({ open, onClose, onSelect, currentColor }: ColorSelectModalProps) {
  const [customColor, setCustomColor] = useState(currentColor || "#ef4444");

  const handleSelect = useCallback(() => {
    onSelect(customColor);
    onClose();
  }, [customColor, onSelect, onClose]);

  return (
    <AdminModal open={open} onClose={onClose} width={MODAL_WIDTH.mediumModal}>
      <ModalHeader title="ìƒ‰ìƒ ì„ íƒ" onClose={onClose} />
      <ModalBody>
        <div className="space-y-4">
          {/* ë¯¸ë¦¬ ì •ì˜ëœ íŒ”ë ˆíŠ¸ */}
          <div>
            <div className="text-sm font-semibold mb-2">ì¶”ì²œ ìƒ‰ìƒ</div>
            <div className="grid grid-cols-8 gap-2">
              {COLOR_PALETTE.map((color) => (
                <button
                  key={color}
                  type="button"
                  onClick={() => setCustomColor(color)}
                  className={`w-10 h-10 rounded-md border-2 transition-all ${
                    customColor === color
                      ? "border-[var(--color-brand-primary)] scale-110"
                      : "border-[var(--color-border-divider)] hover:border-[var(--color-brand-primary)]"
                  }`}
                  style={{ backgroundColor: color }}
                  title={color}
                />
              ))}
            </div>
          </div>

          {/* ì»¤ìŠ¤í…€ ìƒ‰ìƒ ì„ íƒ */}
          <div>
            <div className="text-sm font-semibold mb-2">ì»¤ìŠ¤í…€ ìƒ‰ìƒ</div>
            <div className="flex gap-2 items-center">
              <input
                type="color"
                value={customColor}
                onChange={(e) => setCustomColor(e.target.value)}
                className="w-16 h-10 rounded border border-[var(--color-border-divider)] cursor-pointer"
              />
              <input
                type="text"
                value={customColor}
                onChange={(e) => setCustomColor(e.target.value)}
                className="flex-1 px-3 py-2 border border-[var(--color-border-divider)] rounded text-sm font-mono"
                placeholder="#ef4444"
              />
            </div>
          </div>

          {/* ë¯¸ë¦¬ë³´ê¸° */}
          <div>
            <div className="text-sm font-semibold mb-2">ë¯¸ë¦¬ë³´ê¸°</div>
            <div
              className="w-full h-20 rounded-lg border border-[var(--color-border-divider)]"
              style={{ backgroundColor: customColor }}
            />
          </div>
        </div>
      </ModalBody>
      <ModalFooter>
        <Button intent="secondary" onClick={onClose}>
          ì·¨ì†Œ
        </Button>
        <Button intent="primary" onClick={handleSelect}>
          ì ìš©
        </Button>
      </ModalFooter>
    </AdminModal>
  );
}

export default function ClinicRemoteControl() {
  const qc = useQueryClient();
  const { data: settings, isLoading } = useQuery({
    queryKey: ["clinic-settings"],
    queryFn: fetchClinicSettings,
    refetchInterval: 2000, // 2ì´ˆë§ˆë‹¤ ìë™ ê°±ì‹  (ë‹¤ë¥¸ ì„ ìƒë‹˜ì´ ë³€ê²½í–ˆì„ ê²½ìš° ëŒ€ë¹„)
  });

  const [colorModalOpen, setColorModalOpen] = useState(false);
  const [selectedColorIndex, setSelectedColorIndex] = useState<number | null>(null);

  const updateMutation = useMutation({
    mutationFn: (colors: [string, string, string]) => updateClinicSettings(colors),
    onSuccess: () => {
      qc.invalidateQueries({ queryKey: ["clinic-settings"] });
      qc.invalidateQueries({ queryKey: ["clinic-idcard"] }); // í•™ìƒ ì•±ë„ ê°±ì‹ ë˜ë„ë¡
      feedback.success("ìƒ‰ìƒì´ ì¦‰ì‹œ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤!");
    },
    onError: (e: any) => {
      feedback.error(e?.response?.data?.detail || "ìƒ‰ìƒ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
    },
  });

  const handleColorSelect = useCallback(
    (index: number) => {
      setSelectedColorIndex(index);
      setColorModalOpen(true);
    },
    []
  );

  const handleColorConfirm = useCallback(
    (color: string) => {
      if (selectedColorIndex === null || !settings) return;
      const newColors: [string, string, string] = [...settings.colors];
      newColors[selectedColorIndex] = color;
      updateMutation.mutate(newColors);
    },
    [selectedColorIndex, settings, updateMutation]
  );

  if (isLoading) {
    return (
      <div className="rounded-2xl border border-[var(--border-divider)] bg-[var(--bg-surface)] p-4">
        <div className="text-sm text-[var(--text-muted)]">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
      </div>
    );
  }

  const colors = settings?.colors || ["#ef4444", "#3b82f6", "#22c55e"];

  return (
    <>
      <div className="rounded-2xl border border-[var(--border-divider)] bg-[var(--bg-surface)] overflow-hidden">
        <div className="px-5 py-4 border-b border-[var(--border-divider)] bg-[var(--bg-surface-soft)]">
          <div className="flex items-center justify-between">
            <div>
              <div className="text-sm font-semibold">í´ë¦¬ë‹‰ ë¦¬ëª¨ì»¨</div>
              <div className="text-[11px] text-[var(--text-muted)] mt-0.5">
                ìƒ‰ìƒì„ ì„ íƒí•˜ë©´ í•™ìƒ í™”ë©´ì´ ì¦‰ì‹œ ë³€ê²½ë©ë‹ˆë‹¤
              </div>
            </div>
            <div className="px-2 py-1 bg-[var(--color-brand-primary)] text-white text-xs font-semibold rounded">
              LIVE
            </div>
          </div>
        </div>

        <div className="p-5">
          <div className="space-y-3">
            {/* í˜„ì¬ ìƒ‰ìƒ ë¯¸ë¦¬ë³´ê¸° */}
            <div>
              <div className="text-xs text-[var(--text-muted)] mb-2">í˜„ì¬ ë°°ê²½</div>
              <div
                className="w-full h-16 rounded-lg border border-[var(--border-divider)]"
                style={{
                  background: `linear-gradient(135deg, ${colors[0]} 0%, ${colors[1]} 50%, ${colors[2]} 100%)`,
                  backgroundSize: "200% 200%",
                }}
              />
            </div>

            {/* ìƒ‰ìƒ ì„ íƒ ë²„íŠ¼ */}
            <div className="grid grid-cols-3 gap-3">
              {[0, 1, 2].map((index) => (
                <button
                  key={index}
                  type="button"
                  onClick={() => handleColorSelect(index)}
                  className="relative group"
                >
                  <div
                    className="w-full h-20 rounded-lg border-2 border-[var(--border-divider)] transition-all hover:border-[var(--color-brand-primary)] hover:scale-105"
                    style={{ backgroundColor: colors[index] }}
                  />
                  <div className="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity bg-black/20 rounded-lg">
                    <div className="text-xs font-semibold text-white">í´ë¦­í•˜ì—¬ ë³€ê²½</div>
                  </div>
                  <div className="mt-2 text-center">
                    <div className="text-xs font-semibold text-[var(--text-primary)]">ìƒ‰ìƒ {index + 1}</div>
                    <div className="text-[10px] font-mono text-[var(--text-muted)]">{colors[index]}</div>
                  </div>
                </button>
              ))}
            </div>
          </div>
        </div>
      </div>

      <ColorSelectModal
        open={colorModalOpen}
        onClose={() => {
          setColorModalOpen(false);
          setSelectedColorIndex(null);
        }}
        onSelect={handleColorConfirm}
        currentColor={selectedColorIndex !== null ? colors[selectedColorIndex] : "#ef4444"}
      />
    </>
  );
}


==========================================================================================
# FILE: components/OperationsSessionTree.tsx
==========================================================================================
// PATH: src/features/clinic/components/OperationsSessionTree.tsx
import dayjs from "dayjs";
import type { ClinicSessionTreeNode } from "../api/clinicSessions.api";

function cx(...xs: Array<string | false | null | undefined>) {
  return xs.filter(Boolean).join(" ");
}

function buildMonthDays(year: number, month: number) {
  const first = dayjs(`${year}-${String(month).padStart(2, "0")}-01`);
  const daysInMonth = first.daysInMonth();
  return Array.from({ length: daysInMonth }, (_, i) =>
    first.add(i, "day").format("YYYY-MM-DD")
  );
}

// ì›”ìš”ì¼ ì‹œì‘ ì£¼ì°¨ ë¬¶ê¸°
function groupDaysByWeek(days: string[]) {
  const map = new Map<string, string[]>();
  days.forEach((d) => {
    const monday = dayjs(d).startOf("week").add(1, "day");
    const key = monday.format("YYYY-MM-DD");
    const arr = map.get(key) ?? [];
    arr.push(d);
    map.set(key, arr);
  });
  return Array.from(map.entries()).sort((a, b) => (a[0] > b[0] ? 1 : -1));
}

export default function OperationsSessionTree({
  sessions,
  selectedDay,
  onSelectDay,
  onClear,
  year,
  month,
}: {
  sessions: ClinicSessionTreeNode[];
  selectedDay: string;
  onSelectDay: (date: string) => void;
  onClear: () => void;
  year: number;
  month: number;
}) {
  const byDate = sessions.reduce<Record<string, number>>((acc, s) => {
    acc[s.date] = (acc[s.date] ?? 0) + (s.participant_count ?? 0);
    return acc;
  }, {});

  const days = buildMonthDays(year, month);
  const weeks = groupDaysByWeek(days);
  const monthLabel = `${year}-${String(month).padStart(2, "0")}`;

  return (
    <div className="w-[320px] shrink-0 rounded-2xl border bg-[var(--bg-surface)] overflow-hidden">
      <div className="px-4 py-3 border-b bg-[var(--bg-surface-soft)] flex items-center justify-between">
        <div className="text-sm font-semibold">ë‚ ì§œ ì„ íƒ</div>
        <button
          type="button"
          className="text-xs px-2 py-1 rounded border"
          onClick={onClear}
        >
          ì´ˆê¸°í™”
        </button>
      </div>

      <div className="p-3 space-y-2 max-h-[680px] overflow-auto">
        <details open>
          <summary className="cursor-pointer font-semibold">
            {monthLabel}
          </summary>

          <div className="mt-2 pl-2 space-y-2">
            {weeks.map(([weekKey, weekDays], idx) => (
              <details key={weekKey}>
                <summary className="cursor-pointer text-sm font-semibold">
                  {idx + 1}ì£¼ì°¨
                </summary>

                <div className="mt-1 pl-2 space-y-1">
                  {weekDays.map((d) => {
                    const count = byDate[d] ?? 0;
                    const active = d === selectedDay;

                    return (
                      <button
                        key={d}
                        type="button"
                        onClick={() => onSelectDay(d)}
                        className={cx(
                          "w-full rounded-lg border px-3 py-2 text-left text-sm",
                          active
                            ? "border-[var(--color-primary)] bg-[var(--bg-surface-soft)]"
                            : count > 0
                            ? "border-[color-mix(in_srgb,var(--color-primary)_30%,var(--border-divider))]"
                            : "border-[var(--border-divider)]"
                        )}
                      >
                        <div className="flex items-center justify-between">
                          <span>{d}</span>
                          {count > 0 && (
                            <span className="text-xs font-semibold text-[var(--color-primary)]">
                              {count}
                            </span>
                          )}
                        </div>
                      </button>
                    );
                  })}
                </div>
              </details>
            ))}
          </div>
        </details>
      </div>
    </div>
  );
}


==========================================================================================
# FILE: components/TodayScheduleGrid.tsx
==========================================================================================
import { ClinicParticipant } from "../api/clinicParticipants.api";
import { buildTimeSlots } from "../utils/timeSlots";

export default function TodayScheduleGrid({
  rows,
}: {
  rows: ClinicParticipant[];
}) {
  const slots = buildTimeSlots();

  return (
    <div className="grid grid-cols-4 gap-3">
      {slots.map((t) => {
        const items = rows.filter(
          (r) => (r.session_start_time || "").slice(0, 5) === t
        );

        return (
          <div
            key={t}
            className="rounded-xl border border-[var(--border-divider)] bg-[var(--bg-surface)] p-3"
          >
            <div className="text-xs font-semibold mb-2">{t}</div>

            {items.length === 0 && (
              <div className="text-[11px] text-[var(--text-muted)]">
                ì˜ˆì•½ ì—†ìŒ
              </div>
            )}

            <div className="space-y-1">
              {items.map((r) => (
                <div
                  key={r.id}
                  className="rounded-lg border border-[var(--border-divider)] bg-[var(--bg-surface-soft)] px-2 py-1"
                >
                  <div className="text-xs font-semibold">{r.student_name}</div>
                  <div className="text-[11px] text-[var(--text-muted)]">
                    {r.session_location}
                  </div>
                </div>
              ))}
            </div>
          </div>
        );
      })}
    </div>
  );
}


==========================================================================================
# FILE: components/bookings/ClinicTargetTable.tsx
==========================================================================================
import { Checkbox, Input, Tag } from "antd";
import { useMemo, useState } from "react";
import { useClinicTargets } from "../../hooks/useClinicTargets";

export default function ClinicTargetTable({
  selected,
  onChangeSelected,
}: {
  selected: number[];
  onChangeSelected: (v: number[]) => void;
}) {
  const { data = [], isLoading } = useClinicTargets();
  const [q, setQ] = useState("");

  const rows = useMemo(() => {
    if (!q.trim()) return data;
    return data.filter(
      (r) =>
        r.student_name.includes(q) ||
        String(r.enrollment_id).includes(q)
    );
  }, [data, q]);

  const allChecked =
    rows.length > 0 &&
    rows.every((r) => selected.includes(r.enrollment_id));

  return (
    <div className="rounded-2xl border bg-[var(--bg-surface)] overflow-hidden">
      <div className="px-5 py-4 border-b bg-[var(--bg-surface-soft)]">
        <div className="text-sm font-semibold">ì˜ˆì•½ ëŒ€ìƒì</div>
        <Input
          placeholder="í•™ìƒëª… / enrollment_id ê²€ìƒ‰"
          value={q}
          onChange={(e) => setQ(e.target.value)}
          className="mt-2 bg-[var(--bg-surface)]"
        />
      </div>

      <div className="px-5 py-3 flex items-center justify-between text-xs">
        <Checkbox
          checked={allChecked}
          onChange={() =>
            onChangeSelected(
              allChecked ? [] : rows.map((r) => r.enrollment_id)
            )
          }
        >
          ì „ì²´ ì„ íƒ
        </Checkbox>
        <span>ì„ íƒ {selected.length}ëª…</span>
      </div>

      <div className="max-h-[560px] overflow-auto">
        {rows.map((r) => (
          <label
            key={r.enrollment_id}
            className="flex items-center gap-3 px-5 py-3 border-t text-sm hover:bg-[var(--bg-surface-soft)]"
          >
            <Checkbox
              checked={selected.includes(r.enrollment_id)}
              onChange={(e) =>
                onChangeSelected(
                  e.target.checked
                    ? [...selected, r.enrollment_id]
                    : selected.filter((id) => id !== r.enrollment_id)
                )
              }
            />

            <div className="flex-1">
              <div className="font-semibold">{r.student_name}</div>
              <div className="text-xs text-[var(--text-muted)]">
                enrollment_id: {r.enrollment_id}
              </div>
            </div>

            {r.clinic_reason && (
              <Tag color={r.clinic_reason === "both" ? "red" : "orange"}>
                {r.clinic_reason}
              </Tag>
            )}
          </label>
        ))}

        {!isLoading && rows.length === 0 && (
          <div className="py-10 text-center text-xs text-[var(--text-muted)]">
            ëŒ€ìƒìê°€ ì—†ìŠµë‹ˆë‹¤
          </div>
        )}
      </div>
    </div>
  );
}


==========================================================================================
# FILE: components/bookings/WeeklyClinicBoard.tsx
==========================================================================================
import dayjs from "dayjs";
import { Tag, message } from "antd";
import { useMemo } from "react";
import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import api from "@/shared/api/axios";

type ClinicSession = {
  id: number;
  date: string;
  start_time: string;
  location: string;
  participant_count: number;
};

function buildMixedWeek(todayISO: string) {
  const today = dayjs(todayISO);
  const raw = today.day();
  const todayDow = raw === 0 ? 7 : raw;

  return Array.from({ length: 7 }, (_, i) => {
    const dow = i + 1;
    let diff = dow - todayDow;
    if (diff < 0) diff += 7;
    const date = today.add(diff, "day");
    return {
      date: date.format("YYYY-MM-DD"),
      isNextWeek: diff > 0 && dow < todayDow,
    };
  });
}

export default function WeeklyClinicBoard({
  baseDate,
  selectedEnrollmentIds,
}: {
  baseDate: string;
  selectedEnrollmentIds: number[];
}) {
  const qc = useQueryClient();
  const days = useMemo(() => buildMixedWeek(baseDate), [baseDate]);

  const dateFrom = days[0].date;
  const dateTo = days[6].date;

  const sessionsQ = useQuery({
    queryKey: ["clinic-sessions-week-mixed", dateFrom, dateTo],
    queryFn: async () => {
      const res = await api.get("/clinic/sessions/", {
        params: { date_from: dateFrom, date_to: dateTo },
      });
      return Array.isArray(res.data?.results)
        ? res.data.results
        : res.data;
    },
  });

  const addParticipantM = useMutation({
    mutationFn: async (payload: {
      session: number;
      enrollment_id: number;
    }) =>
      api.post("/clinic/participants/", {
        session: payload.session,
        enrollment_id: payload.enrollment_id,
        source: "manual",
        status: "booked",
      }),
    onSuccess: () => {
      qc.invalidateQueries({ queryKey: ["clinic-participants"] });
      qc.invalidateQueries({ queryKey: ["clinic-sessions-week-mixed"] });
    },
  });

  async function addToSession(sessionId: number) {
    if (selectedEnrollmentIds.length === 0) {
      message.warning("ì¢Œì¸¡ì—ì„œ ëŒ€ìƒìë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.");
      return;
    }
    try {
      for (const eid of selectedEnrollmentIds) {
        await addParticipantM.mutateAsync({
          session: sessionId,
          enrollment_id: eid,
        });
      }
      message.success("ê¸°ì¡´ í´ë¦¬ë‹‰ì— ì¶”ê°€í–ˆìŠµë‹ˆë‹¤.");
    } catch {
      message.error("ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    }
  }

  const sessions: ClinicSession[] = sessionsQ.data ?? [];

  return (
    <div className="rounded-2xl border bg-[var(--bg-surface)] overflow-hidden">
      <div className="px-5 py-4 border-b bg-[var(--bg-surface-soft)]">
        <div className="text-sm font-semibold">ì´ë²ˆ ì£¼ í´ë¦¬ë‹‰</div>
        <div className="text-xs text-[var(--text-muted)]">
          ì˜¤ëŠ˜ ê¸°ì¤€ Â· ì´ì „ ìš”ì¼ì€ ë‹¤ìŒì£¼ë¡œ í‘œì‹œ
        </div>
      </div>

      <div className="grid grid-cols-7 gap-px bg-[var(--border-divider)]">
        {days.map(({ date, isNextWeek }) => {
          const daySessions = sessions.filter((s) => s.date === date);

          return (
            <div
              key={date}
              className={[
                "min-h-[180px] p-2",
                isNextWeek
                  ? "bg-[var(--bg-surface-soft)]"
                  : "bg-[var(--bg-surface)]",
              ].join(" ")}
            >
              <div className="mb-2 flex items-center justify-between">
                <div>
                  <div className="text-xs font-semibold">
                    {dayjs(date).format("dd")}
                  </div>
                  <div className="text-[11px] text-[var(--text-muted)]">
                    {date.slice(5)}
                  </div>
                </div>

                {isNextWeek && (
                  <Tag color="blue" className="text-[10px]">
                    ë‹¤ìŒì£¼
                  </Tag>
                )}
              </div>

              {daySessions.length === 0 && (
                <div className="text-[11px] text-[var(--text-muted)]">
                  ì¼ì • ì—†ìŒ
                </div>
              )}

              <div className="space-y-1">
                {daySessions.map((s) => (
                  <button
                    key={s.id}
                    onClick={() => addToSession(s.id)}
                    className="
                      w-full rounded-lg border border-[var(--border-divider)]
                      px-2 py-1 text-left text-xs
                      hover:bg-[var(--bg-surface-soft)]
                    "
                  >
                    <div className="font-semibold">
                      {s.start_time.slice(0, 5)}
                    </div>
                    <div className="text-[11px] text-[var(--text-muted)]">
                      {s.location} Â· {s.participant_count}ëª…
                    </div>
                  </button>
                ))}
              </div>
            </div>
          );
        })}
      </div>

      <div className="px-5 py-3 text-[11px] text-[var(--text-muted)]">
        * ì—°í•œ ë°°ê²½ì€ ë‹¤ìŒ ì£¼ ì¼ì •ì…ë‹ˆë‹¤.
      </div>
    </div>
  );
}


==========================================================================================
# FILE: components/home/ClinicTodaySummary.tsx
==========================================================================================
// PATH: src/features/clinic/components/home/ClinicTodaySummary.tsx
import { KPI, Button } from "@/shared/ui/ds";
import { ClinicParticipant } from "../../api/clinicParticipants.api";

function groupBySession(rows: ClinicParticipant[]) {
  const map = new Map<number, ClinicParticipant[]>();
  rows.forEach((r) => {
    if (!r.session) return;
    map.set(r.session, [...(map.get(r.session) ?? []), r]);
  });

  const items = Array.from(map.entries()).map(([sessionId, rs]) => {
    const first = rs[0];
    const time = (first?.session_start_time || "").slice(0, 5) || "-";
    const end = first?.session_end_time ? first.session_end_time.slice(0, 5) : "";
    const location = first?.session_location || "";
    const booked = rs.filter((x) => x.status === "booked").length;
    const noShow = rs.filter((x) => x.status === "no_show").length;

    return {
      sessionId,
      time,
      end,
      location,
      total: rs.length,
      booked,
      noShow,
    };
  });

  items.sort((a, b) => (a.time > b.time ? 1 : a.time < b.time ? -1 : 0));
  return items;
}

export default function ClinicTodaySummary({
  date,
  rows,
  loading,
  onGoOperations,
  onGoBookings,
}: {
  date: string;
  rows: ClinicParticipant[];
  loading: boolean;
  onGoOperations: () => void;
  onGoBookings: () => void;
}) {
  const sessions = groupBySession(rows);

  const booked = rows.filter((r) => r.status === "booked").length;
  const noShow = rows.filter((r) => r.status === "no_show").length;

  return (
    <div className="ds-panel" data-panel-variant="primary">
      <div className="clinic-card__header flex items-center justify-between">
        <div>
          <div
            style={{
              fontSize: "var(--text-md)",
              fontWeight: "var(--font-title)",
              color: "var(--color-text-primary)",
            }}
          >
            ì˜¤ëŠ˜ í´ë¦¬ë‹‰
          </div>
          <div
            style={{
              fontSize: "var(--text-xs)",
              color: "var(--color-text-muted)",
              marginTop: "var(--space-1)",
            }}
          >
            {date}
          </div>
        </div>
        <div className="flex gap-2">
          <Button size="sm" intent="secondary" onClick={onGoBookings}>
            ì˜ˆì•½ ì¶”ê°€
          </Button>
          <Button size="sm" intent="primary" onClick={onGoOperations}>
            ìš´ì˜ ì²˜ë¦¬
          </Button>
        </div>
      </div>

      <div
        className="clinic-card__body"
        style={{ display: "flex", flexDirection: "column", gap: "var(--space-4)" }}
      >
        <div className="grid grid-cols-3 gap-3">
          <KPI label="ì´ ì¸ì›" value={rows.length} />
          <KPI label="ì˜ˆì•½" value={booked} />
          <KPI
            label="ë¶ˆì°¸"
            value={noShow}
            hint={noShow > 0 ? "í™•ì¸ í•„ìš”" : undefined}
          />
        </div>
        {noShow > 0 && (
          <div
            style={{
              fontSize: "var(--text-sm)",
              color: "var(--color-error)",
              fontWeight: "var(--font-meta)",
            }}
          >
            ë¶ˆì°¸ {noShow}ëª…
          </div>
        )}

        {loading && (
          <div
            style={{
              fontSize: "var(--text-xs)",
              color: "var(--color-text-muted)",
            }}
          >
            ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
          </div>
        )}

        {!loading && sessions.length === 0 && (
          <div
            style={{
              fontSize: "var(--text-xs)",
              color: "var(--color-text-muted)",
            }}
          >
            ì˜¤ëŠ˜ ì˜ˆì •ëœ í´ë¦¬ë‹‰ì´ ì—†ìŠµë‹ˆë‹¤.
          </div>
        )}

        {!loading && sessions.length > 0 && (
          <div style={{ display: "flex", flexDirection: "column", gap: "var(--space-2)" }}>
            {sessions.map((s) => (
              <div
                key={s.sessionId}
                className="clinic-kpi-block"
                style={{
                  padding: "var(--space-3) var(--space-4)",
                  display: "flex",
                  alignItems: "flex-start",
                  justifyContent: "space-between",
                  gap: "var(--space-3)",
                }}
              >
                <div>
                  <div
                    style={{
                      fontSize: "var(--text-xs)",
                      fontWeight: "var(--font-title)",
                      color: "var(--color-text-primary)",
                    }}
                  >
                    {s.time}
                    {s.end ? ` ~ ${s.end}` : ""} Â· {s.total}ëª…
                  </div>
                  <div
                    style={{
                      fontSize: "11px",
                      color: "var(--color-text-muted)",
                      marginTop: "2px",
                    }}
                  >
                    {s.location}
                  </div>
                </div>
                <div style={{ textAlign: "right" }}>
                  <div
                    style={{
                      fontSize: "11px",
                      color: "var(--color-text-muted)",
                      fontWeight: "var(--font-meta)",
                    }}
                  >
                    ì˜ˆì•½ {s.booked}
                  </div>
                  <div
                    style={{
                      fontSize: "11px",
                      color: s.noShow > 0 ? "var(--color-error)" : "var(--color-text-muted)",
                      fontWeight: "var(--font-meta)",
                    }}
                  >
                    ë¶ˆì°¸ {s.noShow}
                  </div>
                </div>
              </div>
            ))}
          </div>
        )}
      </div>
    </div>
  );
}


==========================================================================================
# FILE: components/home/ClinicWeeklySummary.tsx
==========================================================================================
// PATH: src/features/clinic/components/home/ClinicWeeklySummary.tsx
import dayjs from "dayjs";
import { ClinicParticipant } from "../../api/clinicParticipants.api";

type SessionBlock = {
  sessionId: number;
  start: string;
  end?: string;
  count: number;
};

function buildWeek(from: string) {
  return Array.from({ length: 7 }, (_, i) =>
    dayjs(from).add(i, "day").format("YYYY-MM-DD")
  );
}

function buildSessionBlocks(rows: ClinicParticipant[]): SessionBlock[] {
  const bySession = new Map<number, ClinicParticipant[]>();

  rows.forEach((r) => {
    if (!r.session) return;
    bySession.set(r.session, [...(bySession.get(r.session) ?? []), r]);
  });

  const blocks: SessionBlock[] = [];

  for (const [sessionId, items] of bySession.entries()) {
    const first = items[0];
    const start = (first.session_start_time || "").slice(0, 5);
    const end = first.session_end_time
      ? first.session_end_time.slice(0, 5)
      : undefined;

    blocks.push({
      sessionId,
      start,
      end,
      count: items.length,
    });
  }

  blocks.sort((a, b) => (a.start > b.start ? 1 : -1));
  return blocks;
}

export default function ClinicWeeklySummary({
  from,
  to,
  rows,
  loading,
  onSelectDay,
}: {
  from: string;
  to: string;
  rows: ClinicParticipant[];
  loading: boolean;
  onSelectDay: (date: string) => void;
}) {
  const days = buildWeek(from);

  const rowsByDay: Record<string, ClinicParticipant[]> = Object.fromEntries(
    days.map((d) => [d, []])
  );

  rows.forEach((r) => {
    if (rowsByDay[r.session_date]) {
      rowsByDay[r.session_date].push(r);
    }
  });

  return (
    <div className="rounded-2xl border bg-[var(--bg-surface)] overflow-hidden">
      <div className="px-5 py-4 border-b bg-[var(--bg-surface-soft)]">
        <div className="text-sm font-semibold">ì£¼ê°„ ìš”ì•½</div>
        <div className="text-xs text-[var(--text-muted)]">
          {from} ~ {to}
        </div>
      </div>

      <div className="p-5">
        {loading && (
          <div className="text-xs text-[var(--text-muted)]">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
        )}

        {!loading && (
          <div className="grid grid-cols-7 gap-2">
            {days.map((d) => {
              const dayRows = rowsByDay[d];
              const blocks = buildSessionBlocks(dayRows);
              const sessionCount = blocks.length;
              const participantCount = dayRows.length;
              const dow = dayjs(d).format("dd");

              return (
                <button
                  key={d}
                  type="button"
                  onClick={() => onSelectDay(d)}
                  className="rounded-xl border border-[var(--border-divider)] bg-[var(--bg-surface-soft)] p-3 text-left hover:bg-[var(--bg-surface)]"
                >
                  {/* ìš”ì¼ í—¤ë” */}
                  <div className="flex items-center justify-between">
                    <div className="text-sm font-semibold">{dow}</div>
                    <div className="text-[11px] text-[var(--text-muted)]">
                      {sessionCount}íšŒ | {participantCount}ëª…
                    </div>
                  </div>

                  {/* ì„¸ì…˜ íƒ€ì„ ë¸”ë¡ */}
                  <div className="mt-2 space-y-1">
                    {blocks.map((b) => (
                      <div
                        key={b.sessionId}
                        className="text-[11px] rounded-lg border border-[var(--border-divider)] bg-[var(--bg-surface)] px-2 py-1 font-medium"
                      >
                        [{b.start}
                        {b.end ? ` ~ ${b.end}` : ""} | {b.count}ëª…]
                      </div>
                    ))}

                    {blocks.length === 0 && (
                      <div className="text-[11px] text-[var(--text-muted)]">
                        ì¼ì • ì—†ìŒ
                      </div>
                    )}
                  </div>
                </button>
              );
            })}
          </div>
        )}
      </div>

      <div className="px-5 pb-4">
        <div className="text-[11px] text-[var(--text-muted)]">
          * ë‚ ì§œ í´ë¦­ ì‹œ í•´ë‹¹ ì¼ìì˜ ìš´ì˜ í™”ë©´ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.
        </div>
      </div>
    </div>
  );
}


==========================================================================================
# FILE: hooks/index.ts
==========================================================================================
// PATH: src/features/clinic/hooks/index.ts
export * from "./useClinicTargets";
export * from "./useClinicParticipants";
export * from "./useClinicStudentSearch";


==========================================================================================
# FILE: hooks/useClinicParticipants.ts
==========================================================================================
// PATH: src/features/clinic/hooks/useClinicParticipants.ts
import { useMutation, useQuery, useQueryClient } from "@tanstack/react-query";
import {
  fetchClinicParticipants,
  patchClinicParticipantStatus,
  ClinicParticipantStatus,
} from "../api/clinicParticipants.api";

export function useClinicParticipants(params: {
  session?: number;
  session_date_from?: string;
  session_date_to?: string;
  status?: ClinicParticipantStatus;
}) {
  const qc = useQueryClient();

  // âœ… Home / Reports ì—ì„œ ë‚ ì§œ ê¸°ë°˜ ì¡°íšŒ í—ˆìš©
  const enabled =
    !!params.session ||
    (!!params.session_date_from && !!params.session_date_to);

  const listQ = useQuery({
    queryKey: ["clinic-participants", params],
    queryFn: () => fetchClinicParticipants(params),
    enabled,
  });

  const patchM = useMutation({
    mutationFn: ({ id, payload }: { id: number; payload: any }) =>
      patchClinicParticipantStatus(id, payload),
    onSuccess: () => {
      qc.invalidateQueries({ queryKey: ["clinic-participants"] });
      qc.invalidateQueries({ queryKey: ["admin", "notification-counts"] });
    },
  });

  return { listQ, patchM };
}


==========================================================================================
# FILE: hooks/useClinicStudentSearch.ts
==========================================================================================
// PATH: src/features/clinic/hooks/useClinicStudentSearch.ts
import { useEffect, useMemo, useState } from "react";
import { useQuery } from "@tanstack/react-query";
import { searchClinicStudents } from "../api/clinicStudents.api";

/**
 * ëŒ€ê¸°ì—… ì‹¤ë¬´ ê¸°ì¤€:
 * - ì…ë ¥ ì¦‰ì‹œ ì¿¼ë¦¬ X (ë””ë°”ìš´ìŠ¤)
 * - ìµœì†Œ 2ê¸€ìë¶€í„°
 * - ë„¤íŠ¸ì›Œí¬ í”ë“¤ë ¤ë„ UX ì•ˆì •
 */
export function useClinicStudentSearch(raw: string) {
  const [q, setQ] = useState(raw);

  useEffect(() => {
    const t = setTimeout(() => setQ(raw.trim()), 250);
    return () => clearTimeout(t);
  }, [raw]);

  const enabled = useMemo(() => q.length >= 2, [q]);

  return useQuery({
    queryKey: ["clinic-student-search", q],
    queryFn: () => searchClinicStudents({ q }),
    enabled,
    staleTime: 10_000,
    retry: 0,
  });
}


==========================================================================================
# FILE: hooks/useClinicTargets.ts
==========================================================================================
import { useQuery } from "@tanstack/react-query";
import { fetchClinicTargets } from "../api/clinicTargets";

export function useClinicTargets() {
  return useQuery({
    queryKey: ["clinic-targets"],
    queryFn: fetchClinicTargets,
    staleTime: 10_000,
  });
}


==========================================================================================
# FILE: pages/BookingsPage/ClinicBookingsPage.tsx
==========================================================================================
// PATH: src/features/clinic/pages/BookingsPage/ClinicBookingsPage.tsx
import { useMemo, useState } from "react";
import { useLocation } from "react-router-dom";
import dayjs from "dayjs";

import ClinicTargetTable from "../../components/bookings/ClinicTargetTable";
import WeeklyClinicBoard from "../../components/bookings/WeeklyClinicBoard";
import ClinicCreatePanel from "../../components/ClinicCreatePanel";
import { useClinicTargets } from "../../hooks/useClinicTargets";
import { useClinicParticipants } from "../../hooks/useClinicParticipants";

function useQueryParam(name: string) {
  const loc = useLocation();
  return useMemo(() => new URLSearchParams(loc.search).get(name), [loc.search, name]);
}

export default function ClinicBookingsPage() {
  const focus = useQueryParam("focus"); // "required" | null
  const today = dayjs().format("YYYY-MM-DD");

  const [selected, setSelected] = useState<number[]>([]);

  // ì´ë²ˆ ì£¼(rollingì´ ì•„ë‹ˆë¼ ì›”~ì¼) ê¸°ì¤€ìœ¼ë¡œ "ì´ë¯¸ ì˜ˆì•½ëœ enrollment" ì²´í¬
  // - ì˜ˆì•½ í•„ìˆ˜ëŠ” clinic ìƒíƒœ(ì·¨ì†Œ ì œì™¸) ê¸°ì¤€ìœ¼ë¡œ ë¯¸ì˜ˆì•½ì„ ê°•ì¡°
  const wk = useMemo(() => {
    const d = dayjs(today);
    const start = d.startOf("week").add(1, "day");
    const end = start.add(6, "day");
    return { from: start.format("YYYY-MM-DD"), to: end.format("YYYY-MM-DD") };
  }, [today]);

  const targetsQ = useClinicTargets();
  const weekP = useClinicParticipants({
    session_date_from: wk.from,
    session_date_to: wk.to,
  });

  const bookedEnrollmentIds = useMemo(() => {
    const set = new Set<number>();
    (weekP.listQ.data ?? []).forEach((p) => {
      if (!p.enrollment_id) return;
      if (p.status === "cancelled") return;
      set.add(p.enrollment_id);
    });
    return set;
  }, [weekP.listQ.data]);

  const requiredEnrollmentIds = useMemo(() => {
    const targets = targetsQ.data ?? [];
    return targets
      .filter((t) => !bookedEnrollmentIds.has(t.enrollment_id))
      .map((t) => t.enrollment_id);
  }, [targetsQ.data, bookedEnrollmentIds]);

  // focus=required ë¡œ ë“¤ì–´ì˜¤ë©´ "í•„ìˆ˜ ëŒ€ìƒì"ë¥¼ ìë™ ì„ íƒ (ì´ˆê¸° 1íšŒ)
  const autoSelected = useMemo(() => {
    if (focus !== "required") return null;
    return requiredEnrollmentIds;
  }, [focus, requiredEnrollmentIds]);

  // ì´ˆê¸° ìë™ ì„ íƒ: ê¸°ì¡´ selectedê°€ ë¹„ì–´ìˆì„ ë•Œë§Œ ë®ì–´ì”€
  if (autoSelected && selected.length === 0 && autoSelected.length > 0) {
    // setStateëŠ” ë Œë” ì¤‘ í˜¸ì¶œì´ì§€ë§Œ, ì´ ì»´í¬ë„ŒíŠ¸ëŠ” ë¼ìš°íŠ¸ ì§„ì… ì‹œ 1íšŒë§Œ ëª©ì ì„
    // ì‹¤ì œ ëŸ°íƒ€ì„ì—ì„œ ê²½ê³ ê°€ ì‹«ìœ¼ë©´ useEffectë¡œ ì˜®ê¸°ë©´ ë¨ (ì—¬ê¸°ì„  êµ­ì†Œ ë³€ê²½ ìœ ì§€)
    setSelected(autoSelected);
  }

  return (
    <div className="flex gap-4">
      {/* ì¢Œì¸¡: ì˜ˆì•½ ëŒ€ìƒì */}
      <div className="w-[360px] shrink-0">
        <ClinicTargetTable selected={selected} onChangeSelected={setSelected} />
      </div>

      {/* ì¤‘ì•™: ê¸°ì¡´ í´ë¦¬ë‹‰ ì£¼ê°„ ë³´ë“œ */}
      <div className="flex-1">
        <WeeklyClinicBoard baseDate={today} selectedEnrollmentIds={selected} />
      </div>

      {/* ìš°ì¸¡: ìƒì„± íŒ¨ë„ (ê¸°ì¡´ ìœ ì§€) */}
      <div className="w-[420px] shrink-0">
        <ClinicCreatePanel
          defaultMode="targets"
          selectedTargetEnrollmentIds={selected}
          onChangeSelectedTargetEnrollmentIds={setSelected}
          onCreated={() => setSelected([])}
        />
      </div>
    </div>
  );
}


==========================================================================================
# FILE: pages/HomePage/ClinicHomePage.tsx
==========================================================================================
import { useMemo, useState } from "react";
import { useNavigate } from "react-router-dom";
import dayjs from "dayjs";

import { DatePicker } from "@/shared/ui/date";

import { Button, KPI } from "@/shared/ui/ds";
import { useClinicParticipants } from "../../hooks/useClinicParticipants";
import { useClinicTargets } from "../../hooks/useClinicTargets";
import ClinicTodaySummary from "../../components/home/ClinicTodaySummary";

function todayISO() {
  return new Date().toISOString().slice(0, 10);
}

function weekRangeISO(base: string) {
  const d = dayjs(base);
  const start = d.startOf("week").add(1, "day");
  const end = start.add(6, "day");
  return { from: start.format("YYYY-MM-DD"), to: end.format("YYYY-MM-DD") };
}

export default function ClinicHomePage() {
  const nav = useNavigate();
  const [date, setDate] = useState(todayISO());

  const wk = useMemo(() => weekRangeISO(date), [date]);

  const todayQ = useClinicParticipants({
    session_date_from: date,
    session_date_to: date,
  });

  const weekQ = useClinicParticipants({
    session_date_from: wk.from,
    session_date_to: wk.to,
  });

  const targetsQ = useClinicTargets();

  const bookedEnrollmentIds = useMemo(() => {
    const set = new Set<number>();
    (weekQ.listQ.data ?? []).forEach((p) => {
      if (!p.enrollment_id) return;
      if (p.status === "cancelled") return;
      set.add(p.enrollment_id);
    });
    return set;
  }, [weekQ.listQ.data]);

  const requiredCount = useMemo(() => {
    const targets = targetsQ.data ?? [];
    return targets.filter((t) => !bookedEnrollmentIds.has(t.enrollment_id))
      .length;
  }, [targetsQ.data, bookedEnrollmentIds]);

  const weekDays = useMemo(() => {
    return Array.from({ length: 7 }, (_, i) => {
      const d = dayjs(wk.from).add(i, "day");
      return { date: d.format("YYYY-MM-DD"), dow: d.format("dd") };
    });
  }, [wk.from]);

  const rowsByDay = useMemo(() => {
    const map: Record<string, { total: number; byTime: Record<string, number> }> =
      {};
    weekDays.forEach((d) => {
      map[d.date] = { total: 0, byTime: {} };
    });

    (weekQ.listQ.data ?? []).forEach((r) => {
      const key = r.session_date;
      if (!map[key]) return;
      const t = (r.session_start_time || "").slice(0, 5);
      map[key].byTime[t] = (map[key].byTime[t] ?? 0) + 1;
      map[key].total += 1;
    });

    return map;
  }, [weekQ.listQ.data, weekDays]);

  return (
    <div className="flex flex-col gap-[var(--space-6)]">
        {/* íˆ´ë°”: ë‚ ì§œ ì„ íƒ (ë„ë©”ì¸ íƒ€ì´í‹€ì€ Layoutì—ì„œ) */}
        <div className="flex items-center justify-end">
          <DatePicker
            value={date}
            onChange={setDate}
            placeholder="ë‚ ì§œ ì„ íƒ"
          />
        </div>

        {/* ìƒë‹¨ 3ì—´: ì˜¤ëŠ˜ í´ë¦¬ë‹‰ Â· ì˜ˆì•½ í•„ìˆ˜ Â· ì˜ˆì•½ ì‹ ì²­ */}
        <div className="grid grid-cols-1 gap-[var(--space-6)] lg:grid-cols-3">
          <ClinicTodaySummary
            date={date}
            rows={todayQ.listQ.data ?? []}
            loading={todayQ.listQ.isLoading}
            onGoOperations={() => nav("/admin/clinic/operations")}
            onGoBookings={() => nav("/admin/clinic/bookings")}
          />

          <div className="ds-panel" data-panel-variant="default">
            <div className="clinic-card__header">
              <div
                style={{
                  fontSize: "var(--text-md)",
                  color: "var(--color-text-primary)",
                  fontWeight: "var(--font-title)",
                }}
              >
                ì˜ˆì•½ í•„ìˆ˜ ëŒ€ìƒì
              </div>
              <div
                className="mt-1"
                style={{
                  fontSize: "var(--text-sm)",
                  color: "var(--color-text-muted)",
                  fontWeight: "var(--font-meta)",
                }}
              >
                ì´ë²ˆ ì£¼ ë¯¸ì˜ˆì•½
              </div>
            </div>
            <div className="clinic-card__body flex items-end justify-between">
              <KPI
                label=""
                value={requiredCount}
                hint={requiredCount > 0 ? "í™•ì¸ í•„ìš”" : undefined}
              />
              <Button
                type="button"
                intent="primary"
                size="sm"
                onClick={() => nav("/admin/clinic/bookings?focus=required")}
              >
                ê´€ë¦¬ ì´ë™
              </Button>
            </div>
          </div>

          <div className="ds-panel" data-panel-variant="subtle">
            <div className="clinic-card__header">
              <div
                style={{
                  fontSize: "var(--text-md)",
                  color: "var(--color-text-primary)",
                  fontWeight: "var(--font-title)",
                }}
              >
                ì˜ˆì•½ ì‹ ì²­ì
              </div>
            </div>
            <div className="clinic-card__body">
              <div
                style={{
                  fontSize: "var(--text-md)",
                  color: "var(--color-text-muted)",
                  fontWeight: "var(--font-meta)",
                }}
              >
                í˜„ì¬ ì—†ìŒ
              </div>
            </div>
          </div>
        </div>

        {/* ì£¼ê°„ ì¼ì • */}
        <div className="ds-panel" data-panel-variant="default">
          <div className="clinic-card__header">
            <div
              style={{
                fontSize: "var(--text-lg)",
                fontWeight: "var(--font-title)",
                color: "var(--color-text-primary)",
              }}
            >
              ì£¼ê°„ ì¼ì •
            </div>
            <div
              className="mt-1"
              style={{
                fontSize: "var(--text-sm)",
                color: "var(--color-text-muted)",
                fontWeight: "var(--font-meta)",
              }}
            >
              {wk.from} ~ {wk.to}
            </div>
          </div>
          <div
            className="grid grid-cols-1 gap-[var(--space-4)] md:grid-cols-7"
            style={{ padding: "var(--space-6)" }}
          >
            {weekDays.map((d) => {
              const info = rowsByDay[d.date];
              const times = Object.keys(info.byTime).sort();
              const isToday = d.date === date;

              return (
                <button
                  key={d.date}
                  type="button"
                  onClick={() => {
                    setDate(d.date);
                    nav(`/admin/clinic/operations?date=${d.date}`);
                  }}
                  className="clinic-day-cell !block !w-full !text-left !justify-start"
                  style={{
                    borderColor: isToday ? "var(--color-primary)" : undefined,
                    borderWidth: isToday ? 2 : 1,
                    background: isToday
                      ? "color-mix(in srgb, var(--color-primary) 8%, var(--color-bg-surface))"
                      : undefined,
                  }}
                >
                  <div
                    className="flex items-center justify-between"
                    style={{ marginBottom: "var(--space-3)" }}
                  >
                    <div
                      style={{
                        fontSize: "var(--text-lg)",
                        fontWeight: "var(--font-title)",
                        color: isToday
                          ? "var(--color-primary)"
                          : "var(--color-text-primary)",
                      }}
                    >
                      {d.dow}
                    </div>
                    <div
                      style={{
                        fontSize: "var(--text-sm)",
                        color: "var(--color-text-muted)",
                        fontWeight: "var(--font-meta)",
                      }}
                    >
                      {times.length}íšŒ Â· {info.total}ëª…
                    </div>
                  </div>
                  <div
                    className="flex flex-col"
                    style={{ gap: "var(--space-2)" }}
                  >
                    {times.map((t) => (
                      <div
                        key={t}
                        className="clinic-kpi-block text-sm font-medium"
                        style={{
                          color: "var(--color-text-primary)",
                          fontWeight: "var(--font-meta)",
                        }}
                      >
                        {t} ì‹œì‘ Â· {info.byTime[t]}ëª…
                      </div>
                    ))}
                    {times.length === 0 && (
                      <div
                        style={{
                          fontSize: "var(--text-sm)",
                          color: "var(--color-text-muted)",
                        }}
                      >
                        ì¼ì • ì—†ìŒ
                      </div>
                    )}
                  </div>
                </button>
              );
            })}
          </div>
        </div>
    </div>
  );
}


==========================================================================================
# FILE: pages/OperationsPage/ClinicOperationsPage.tsx
==========================================================================================
// PATH: src/features/clinic/pages/OperationsPage/ClinicOperationsPage.tsx
import { useMemo, useState } from "react";
import { useSearchParams } from "react-router-dom";
import dayjs from "dayjs";
import { useQuery } from "@tanstack/react-query";

import { useClinicParticipants } from "../../hooks/useClinicParticipants";
import type { ClinicParticipantStatus } from "../../api/clinicParticipants.api";

import {
  fetchClinicSessionTree,
  type ClinicSessionTreeNode,
} from "../../api/clinicSessions.api";

import OperationsSessionTree from "../../components/OperationsSessionTree";
import ClinicDaySchedulePanel from "../../components/ClinicDaySchedulePanel";
import ClinicCreatePanel from "../../components/ClinicCreatePanel";
import ClinicRemoteControl from "../../components/ClinicRemoteControl";

function todayISO() {
  return new Date().toISOString().slice(0, 10);
}

function normalizeClinicStatusParam(
  v: string | null
): ClinicParticipantStatus | undefined {
  if (!v) return undefined;
  if (v === "NO_SHOW") return "no_show";
  if (v === "DONE") return "attended";
  if (v === "CANCELED") return "cancelled";
  if (v === "BOOKED") return "booked";
  if (
    v === "no_show" ||
    v === "attended" ||
    v === "cancelled" ||
    v === "booked"
  ) {
    return v;
  }
  return undefined;
}

function rangeFromMode(baseISO: string, mode: "day" | "week" | "month") {
  const d = dayjs(baseISO);
  if (mode === "day")
    return { from: d.format("YYYY-MM-DD"), to: d.format("YYYY-MM-DD") };
  if (mode === "week") {
    const start = d.startOf("week").add(1, "day");
    return {
      from: start.format("YYYY-MM-DD"),
      to: start.add(6, "day").format("YYYY-MM-DD"),
    };
  }
  return {
    from: d.startOf("month").format("YYYY-MM-DD"),
    to: d.endOf("month").format("YYYY-MM-DD"),
  };
}

export default function ClinicOperationsPage() {
  const [sp] = useSearchParams();
  const clinicStatus = normalizeClinicStatusParam(sp.get("status"));

  const [baseDate, setBaseDate] = useState(() => todayISO());
  const [mode, setMode] = useState<"day" | "week" | "month">("day");
  const [selectedSessionId, setSelectedSessionId] = useState<number | null>(null);

  const range = useMemo(() => rangeFromMode(baseDate, mode), [baseDate, mode]);

  const participants = useClinicParticipants({
    session: selectedSessionId ?? undefined,
    session_date_from: range.from,
    session_date_to: range.to,
    status: clinicStatus,
  });

  const ym = useMemo(() => {
    const d = dayjs(baseDate);
    return { year: d.year(), month: d.month() + 1 };
  }, [baseDate]);

  const treeQ = useQuery({
    queryKey: ["clinic-sessions-tree", ym.year, ym.month],
    queryFn: () => fetchClinicSessionTree({ year: ym.year, month: ym.month }),
    retry: 0,
  });

  return (
    <div className="flex gap-4">
      {/* ì¢Œì¸¡: ë‚ ì§œ íŠ¸ë¦¬ */}
      <div className="hidden lg:block">
        <OperationsSessionTree
          sessions={treeQ.data ?? []}
          selectedDay={baseDate}
          year={ym.year}
          month={ym.month}
          onSelectDay={(date) => {
            setBaseDate(date);
            setMode("day");
            setSelectedSessionId(null);
          }}
          onClear={() => setSelectedSessionId(null)}
        />
      </div>

      {/* ì¤‘ê°„: ì¼ì •(ì°¸ê°€ì ê¸°ì¤€) */}
      <div className="w-[360px] shrink-0">
        <ClinicDaySchedulePanel date={baseDate} rows={participants.listQ.data ?? []} />
      </div>

      {/* ìš°ì¸¡: ìƒì„± íŒ¨ë„ + ë¦¬ëª¨ì»¨ */}
      <div className="flex-1 space-y-4">
        <ClinicRemoteControl />
        <ClinicCreatePanel date={baseDate} />
      </div>
    </div>
  );
}


==========================================================================================
# FILE: pages/ReportsPage/ClinicReportsPage.tsx
==========================================================================================
// PATH: src/features/clinic/pages/ReportsPage/ClinicReportsPage.tsx

import { useMemo, useState } from "react";
import dayjs from "dayjs";
import { useQuery } from "@tanstack/react-query";
import api from "@/shared/api/axios";

function cx(...xs: Array<string | false | null | undefined>) {
  return xs.filter(Boolean).join(" ");
}

type ClinicSession = {
  id: number;
  date: string; // YYYY-MM-DD
  start_time: string; // HH:MM or HH:MM:SS
  duration_minutes?: number;
  location?: string;
  participant_count?: number;
};

type DayCell = {
  date: string; // YYYY-MM-DD
  isCurrentMonth: boolean;
};

function normalizeList(resData: any): any[] {
  if (Array.isArray(resData)) return resData;
  if (Array.isArray(resData?.results)) return resData.results;
  return [];
}

function startTimeHHMM(v: string) {
  if (!v) return "";
  return v.slice(0, 5);
}

function buildMonthCalendar(year: number, month: number): DayCell[] {
  const first = dayjs(`${year}-${String(month).padStart(2, "0")}-01`);
  const startDow = first.day(); // 0=Sun
  const start = first.subtract(startDow, "day");

  return Array.from({ length: 42 }, (_, i) => {
    const d = start.add(i, "day");
    return {
      date: d.format("YYYY-MM-DD"),
      isCurrentMonth: d.month() + 1 === month,
    };
  });
}

function monthRangeISO(year: number, month: number) {
  const first = dayjs(`${year}-${String(month).padStart(2, "0")}-01`);
  return {
    from: first.startOf("month").format("YYYY-MM-DD"),
    to: first.endOf("month").format("YYYY-MM-DD"),
  };
}

export default function ClinicReportsPage() {
  const today = dayjs();
  const [ym, setYm] = useState(() => ({
    year: today.year(),
    month: today.month() + 1,
  }));
  const [mode, setMode] = useState<"detail" | "compact">("detail");

  // compact ëª¨ë“œ: "í´ë” ì ‘ê¸°"ì²˜ëŸ¼ ë‚ ì§œ ë‹¨ìœ„ ì ‘ê¸°/í¼ì¹˜ê¸°
  const [collapsedDays, setCollapsedDays] = useState<Record<string, boolean>>(
    {}
  );

  function moveMonth(diff: number) {
    const d = dayjs(`${ym.year}-${String(ym.month).padStart(2, "0")}-01`).add(
      diff,
      "month"
    );
    setYm({ year: d.year(), month: d.month() + 1 });
    setCollapsedDays({}); // ë‹¬ ë°”ë€Œë©´ ì ‘ê¸° ìƒíƒœ ì´ˆê¸°í™”
  }

  const range = useMemo(() => monthRangeISO(ym.year, ym.month), [ym.year, ym.month]);

  const sessionsQ = useQuery({
    queryKey: ["clinic-sessions-month", range.from, range.to],
    queryFn: async () => {
      const res = await api.get("/clinic/sessions/", {
        params: { date_from: range.from, date_to: range.to, ordering: "date,start_time" },
      });
      const rows = normalizeList(res.data) as any[];
      // ìµœì†Œ í•„ë“œë§Œ ì•ˆì „í•˜ê²Œ ì •ê·œí™”
      return rows.map((r: any) => ({
        id: Number(r.id),
        date: String(r.date),
        start_time: String(r.start_time ?? ""),
        duration_minutes:
          r.duration_minutes == null ? undefined : Number(r.duration_minutes),
        location: r.location == null ? undefined : String(r.location),
        participant_count:
          r.participant_count == null ? undefined : Number(r.participant_count),
      })) as ClinicSession[];
    },
    staleTime: 10_000,
    retry: 0,
  });

  const sessions = sessionsQ.data ?? [];

  const sessionsByDate = useMemo(() => {
    const map: Record<string, ClinicSession[]> = {};
    sessions.forEach((s) => {
      map[s.date] ??= [];
      map[s.date].push(s);
    });
    // ì‹œê°„ìˆœ ì •ë ¬
    Object.keys(map).forEach((k) => {
      map[k].sort((a, b) => (startTimeHHMM(a.start_time) > startTimeHHMM(b.start_time) ? 1 : -1));
    });
    return map;
  }, [sessions]);

  const cells = useMemo(() => buildMonthCalendar(ym.year, ym.month), [ym.year, ym.month]);

  const monthLabel = useMemo(() => {
    // "2026 Jan" í˜•íƒœ
    const d = dayjs(`${ym.year}-${String(ym.month).padStart(2, "0")}-01`);
    return `${d.format("YYYY")} ${d.format("MMM")}`;
  }, [ym.year, ym.month]);

  const compactDays = useMemo(() => {
    // ì¼ì • ìˆëŠ” ë‚ ì§œë§Œ: ë¹ˆ ìº˜ë¦°ë” ì˜ì—­ ìì²´ë¥¼ ì—†ì• ë²„ë¦¼
    const keys = Object.keys(sessionsByDate).sort((a, b) => (a > b ? 1 : -1));
    return keys.map((date) => ({
      date,
      dow: dayjs(date).format("dd"),
      items: sessionsByDate[date] ?? [],
    }));
  }, [sessionsByDate]);

  const hasAny = sessions.length > 0;

  const toggleDay = (date: string) => {
    setCollapsedDays((prev) => ({ ...prev, [date]: !prev[date] }));
  };

  const expandAll = () => {
    const next: Record<string, boolean> = {};
    compactDays.forEach((d) => (next[d.date] = false));
    setCollapsedDays(next);
  };

  const collapseAll = () => {
    const next: Record<string, boolean> = {};
    compactDays.forEach((d) => (next[d.date] = true));
    setCollapsedDays(next);
  };

  return (
    <div className="space-y-4">
      {/* Header */}
      <div className="space-y-1">
        <div className="text-xl font-semibold">ë¦¬í¬íŠ¸</div>
        <div className="text-xs text-[var(--text-muted)]">
          ì›” ë‹¨ìœ„ í´ë¦¬ë‹‰ í˜„í™© (ê³¼ê±° ê¸°ë¡ í¬í•¨) Â· ì„œë²„ ë‹¨ì¼ì§„ì‹¤ ê¸°ë°˜
        </div>
      </div>

      {/* Control Bar (LEFT ALIGNED â€” ì ˆëŒ€ ìš°ì¸¡ì •ë ¬ ê¸ˆì§€) */}
      <div className="flex flex-wrap items-center gap-2">
        <button
          className="h-[34px] px-3 rounded-lg border border-[var(--border-divider)] bg-[var(--bg-surface)] text-sm hover:bg-[var(--bg-surface-soft)]"
          onClick={() => moveMonth(-1)}
        >
          â† ì´ì „ë‹¬
        </button>

        <button
          className="h-[34px] px-3 rounded-lg border border-[var(--border-divider)] bg-[var(--bg-surface)] text-sm hover:bg-[var(--bg-surface-soft)]"
          onClick={() => moveMonth(1)}
        >
          ë‹¤ìŒë‹¬ â†’
        </button>

        <div className="ml-2 px-2 py-1 rounded-lg border border-[var(--border-divider)] bg-[var(--bg-surface-soft)]">
          <div className="text-base font-semibold leading-none">{monthLabel}</div>
        </div>

        <div className="ml-2 flex gap-1">
          <button
            onClick={() => setMode("detail")}
            className={cx(
              "h-[32px] px-3 rounded-lg text-sm border border-[var(--border-divider)]",
              mode === "detail" &&
                "bg-[var(--color-primary)] text-[var(--color-on-primary)] border-[var(--color-primary)]"
            )}
          >
            ìì„¸íˆ
          </button>
          <button
            onClick={() => setMode("compact")}
            className={cx(
              "h-[32px] px-3 rounded-lg text-sm border border-[var(--border-divider)]",
              mode === "compact" &&
                "bg-[var(--color-primary)] text-[var(--color-on-primary)] border-[var(--color-primary)]"
            )}
          >
            ê°„ëµíˆ
          </button>
        </div>

        {mode === "compact" && (
          <div className="flex items-center gap-2">
            <button
              className="h-[32px] px-3 rounded-lg border border-[var(--border-divider)] bg-[var(--bg-surface)] text-sm hover:bg-[var(--bg-surface-soft)]"
              onClick={expandAll}
              disabled={!hasAny}
            >
              ëª¨ë‘ í¼ì¹˜ê¸°
            </button>
            <button
              className="h-[32px] px-3 rounded-lg border border-[var(--border-divider)] bg-[var(--bg-surface)] text-sm hover:bg-[var(--bg-surface-soft)]"
              onClick={collapseAll}
              disabled={!hasAny}
            >
              ëª¨ë‘ ì ‘ê¸°
            </button>
          </div>
        )}

        {sessionsQ.isLoading && (
          <div className="text-xs text-[var(--text-muted)] ml-2">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
        )}
      </div>

      {/* Content */}
      {mode === "detail" ? (
        // âœ… ìì„¸íˆ: ë‹¬ë ¥ + ì—¬ë°± + ì‹œê° ê°•ì¡°
        <div className="rounded-2xl border border-[var(--border-divider)] bg-[var(--bg-surface)] overflow-hidden">
          <div className="grid grid-cols-7 border-b border-[var(--border-divider)] bg-[var(--bg-surface-soft)] text-xs font-semibold">
            {["Su", "Mo", "Tu", "We", "Th", "Fr", "Sa"].map((d) => (
              <div key={d} className="px-3 py-2">
                {d}
              </div>
            ))}
          </div>

          <div className="grid grid-cols-7 auto-rows-[132px]">
            {cells.map((c) => {
              const items = sessionsByDate[c.date] ?? [];
              const has = items.length > 0;

              return (
                <div
                  key={c.date}
                  className={cx(
                    "border-t border-r border-[var(--border-divider)] p-2",
                    !c.isCurrentMonth && "bg-[var(--bg-surface-soft)] opacity-60",
                    has && c.isCurrentMonth && "bg-[color-mix(in_srgb,var(--color-primary)_6%,var(--bg-surface))]"
                  )}
                >
                  <div className="flex items-center justify-between">
                    <div className={cx("text-xs font-semibold", has && "text-[var(--text-primary)]")}>
                      {c.date.slice(8)}
                    </div>

                    {has && (
                      <span
                        className="inline-block w-2.5 h-2.5 rounded-full"
                        style={{ background: "var(--color-primary)" }}
                        title={`${items.length}ê°œ ì¼ì •`}
                      />
                    )}
                  </div>

                  {has && (
                    <div className="mt-2 space-y-1">
                      {items.slice(0, 3).map((s) => (
                        <div
                          key={s.id}
                          className={cx(
                            "text-[11px] rounded-md px-2 py-1 font-semibold",
                            "border border-[color-mix(in_srgb,var(--color-primary)_20%,var(--border-divider))]",
                            "bg-[var(--bg-surface)]"
                          )}
                        >
                          {startTimeHHMM(s.start_time)} Â· í´ë¦¬ë‹‰
                          {s.location ? (
                            <span className="ml-1 text-[var(--text-muted)] font-medium">
                              Â· {s.location}
                            </span>
                          ) : null}
                        </div>
                      ))}

                      {items.length > 3 && (
                        <div className="text-[11px] text-[var(--text-muted)]">
                          + {items.length - 3}ê°œ ë” ìˆìŒ
                        </div>
                      )}
                    </div>
                  )}
                </div>
              );
            })}
          </div>

          <div className="px-5 py-3 text-[11px] text-[var(--text-muted)] border-t border-[var(--border-divider)]">
            * ë°ì´í„°: /clinic/sessions/?date_from={range.from}&date_to={range.to}
          </div>
        </div>
      ) : (
        // âœ… ê°„ëµíˆ: â€œë‹¬ë ¥ ì˜ì—­ ìì²´ ì œê±°â€ + ì¼ì • ìˆëŠ” ë‚ ë§Œ í´ë”ì‹ ë¦¬ìŠ¤íŠ¸
        <div className="rounded-2xl border border-[var(--border-divider)] bg-[var(--bg-surface)] overflow-hidden">
          <div className="px-5 py-4 border-b border-[var(--border-divider)] bg-[var(--bg-surface-soft)]">
            <div className="text-sm font-semibold">ì›”ê°„ ì¼ì • (ê°„ëµ)</div>
            <div className="text-xs text-[var(--text-muted)] mt-1">
              ì¼ì • ìˆëŠ” ë‚ ì§œë§Œ í‘œì‹œ Â· ë¹ˆ ë‚ ì§œ ì˜ì—­ì€ ì ‘í˜€ì„œ ì‚¬ë¼ì§‘ë‹ˆë‹¤.
            </div>
          </div>

          <div className="p-4">
            {!sessionsQ.isLoading && !hasAny && (
              <div className="rounded-xl border border-[var(--border-divider)] bg-[var(--bg-surface-soft)] px-4 py-4 text-sm text-[var(--text-muted)]">
                ì´ë²ˆ ë‹¬ì— ì¡íŒ í´ë¦¬ë‹‰ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.
              </div>
            )}

            <div className="space-y-2">
              {compactDays.map((d) => {
                const collapsed = !!collapsedDays[d.date];
                const count = d.items.length;

                return (
                  <div
                    key={d.date}
                    className="rounded-2xl border border-[var(--border-divider)] bg-[var(--bg-surface)] overflow-hidden"
                  >
                    {/* í´ë” í—¤ë” */}
                    <button
                      type="button"
                      onClick={() => toggleDay(d.date)}
                      className={cx(
                        "w-full px-4 py-3 flex items-center justify-between text-left",
                        "bg-[var(--bg-surface-soft)] hover:bg-[var(--bg-surface)]"
                      )}
                    >
                      <div className="flex items-center gap-2">
                        <span
                          className="inline-block w-2.5 h-2.5 rounded-full"
                          style={{ background: "var(--color-primary)" }}
                        />
                        <div className="text-sm font-semibold">
                          {d.date} <span className="text-[var(--text-muted)] font-medium">({d.dow})</span>
                        </div>
                        <div className="text-xs text-[var(--text-muted)] ml-2">
                          {count}ê°œ
                        </div>
                      </div>

                      <div className="text-sm text-[var(--text-muted)]">
                        {collapsed ? "â–¶" : "â–¼"}
                      </div>
                    </button>

                    {/* í´ë” ë‚´ìš© */}
                    {!collapsed && (
                      <div className="px-4 py-3 space-y-2">
                        {d.items.map((s) => (
                          <div
                            key={s.id}
                            className={cx(
                              "rounded-xl border border-[var(--border-divider)] bg-[var(--bg-surface-soft)] px-4 py-3",
                              "flex items-center justify-between gap-3"
                            )}
                          >
                            <div className="min-w-0">
                              <div className="text-sm font-semibold">
                                {startTimeHHMM(s.start_time)} Â· í´ë¦¬ë‹‰
                              </div>
                              <div className="text-xs text-[var(--text-muted)] mt-0.5 truncate">
                                {s.location ? s.location : "ì¥ì†Œ ë¯¸ì§€ì •"}
                              </div>
                            </div>

                            <div className="shrink-0 text-xs font-semibold">
                              {typeof s.participant_count === "number" ? `${s.participant_count}ëª…` : ""}
                            </div>
                          </div>
                        ))}
                      </div>
                    )}
                  </div>
                );
              })}
            </div>

            <div className="text-[11px] text-[var(--text-muted)] mt-3">
              * ë°ì´í„°: /clinic/sessions/?date_from={range.from}&date_to={range.to}
            </div>
          </div>
        </div>
      )}
    </div>
  );
}


==========================================================================================
# FILE: pages/SettingsPage/ClinicSettingsPage.tsx
==========================================================================================
import { useState, useEffect } from "react";
import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { fetchClinicMe } from "../../api/clinicMe.api";
import { fetchClinicSettings, updateClinicSettings } from "../../api/clinicSettings.api";
import { Button } from "@/shared/ui/ds";
import { feedback } from "@/shared/ui/feedback/feedback";
import AdminModal from "@/shared/ui/modal/AdminModal";
import { MODAL_WIDTH } from "@/shared/ui/modal";
import ModalHeader from "@/shared/ui/modal/ModalHeader";
import ModalBody from "@/shared/ui/modal/ModalBody";
import ModalFooter from "@/shared/ui/modal/ModalFooter";

export default function ClinicSettingsPage() {
  const qc = useQueryClient();
  const meQ = useQuery({
    queryKey: ["clinic-me"],
    queryFn: fetchClinicMe,
  });

  const canManage = !!meQ.data?.is_payroll_manager || !!meQ.data?.is_superuser;

  if (meQ.isLoading) {
    return <div className="text-sm text-[var(--text-muted)]">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>;
  }

  if (!canManage) {
    return (
      <div className="rounded-2xl border border-[var(--border-divider)] bg-[var(--bg-surface)] px-5 py-5">
        <div className="text-sm font-semibold">ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.</div>
        <div className="text-xs text-[var(--text-muted)] mt-1">
          ì„¤ì •ì€ ê´€ë¦¬ìë§Œ ì ‘ê·¼ ê°€ëŠ¥í•©ë‹ˆë‹¤.
        </div>
      </div>
    );
  }

  return (
    <div className="space-y-4">
      <div className="space-y-1">
        <div className="text-lg font-semibold">ì„¤ì •</div>
        <div className="text-xs text-[var(--text-muted)]">
          * ì •ì±…/ê¸°ì¤€/ìë™í™” ì„¤ì •ì€ ì„œë²„ ë‹¨ì¼ì§„ì‹¤ë¡œ ê´€ë¦¬ë©ë‹ˆë‹¤.
        </div>
      </div>

      {/* íŒ¨ìŠ¤ì¹´ë“œ ë°°ê²½ ìƒ‰ìƒ ì„¤ì • */}
      <ClinicIdcardColorSettings />

      <div className="rounded-2xl border border-[var(--border-divider)] bg-[var(--bg-surface)] overflow-hidden">
        <div className="px-5 py-4 border-b border-[var(--border-divider)] bg-[var(--bg-surface-soft)]">
          <div className="text-sm font-semibold">í´ë¦¬ë‹‰ ì •ì±…</div>
          <div className="text-[11px] text-[var(--text-muted)] mt-0.5">
            * ì´ ì˜ì—­ì€ ë°±ì—”ë“œ ì •ì±… APIê°€ ì¤€ë¹„ë˜ë©´ ê·¸ëŒ€ë¡œ ì—°ê²°í•©ë‹ˆë‹¤.
          </div>
        </div>

        <div className="p-5 space-y-3">
          <div className="rounded-2xl border border-[var(--border-divider)] bg-[var(--bg-surface)] px-5 py-5">
            <div className="text-sm font-semibold">ì˜ˆì‹œ</div>
            <div className="text-xs text-[var(--text-muted)] mt-1 leading-relaxed">
              - ProgressPolicy (ì»·ë¼ì¸/íŒì • ê¸°ì¤€)
              <br />
              - ìë™ ëŒ€ìƒì ìƒì„± on/off
              <br />
              - ì˜ˆì•½ ìŠ¬ë¡¯(ì‹œê°„/ì •ì›) ê·œì¹™
              <br />
              * í”„ë¡ íŠ¸ëŠ” â€œì„¤ì • UIâ€ë§Œ ì œê³µí•˜ê³  ì €ì¥/ê²€ì¦ì€ ì„œë²„ê°€ ë‹´ë‹¹
            </div>
          </div>
        </div>

        <div className="px-5 pb-4">
          <div className="text-[11px] text-[var(--text-muted)]">
            * ì„¤ì •ì€ ìš´ì˜ ì•ˆì •ì„±ì„ ìœ„í•´ â€œì„œë²„ ê²€ì¦â€ì´ ë°˜ë“œì‹œ í•„ìš”í•©ë‹ˆë‹¤.
          </div>
        </div>
      </div>
    </div>
  );
}

/** íŒ¨ìŠ¤ì¹´ë“œ ë°°ê²½ ìƒ‰ìƒ ì„¤ì • ì»´í¬ë„ŒíŠ¸ */
function ClinicIdcardColorSettings() {
  const qc = useQueryClient();
  const { data: settings, isLoading } = useQuery({
    queryKey: ["clinic-settings"],
    queryFn: fetchClinicSettings,
  });

  const [localColors, setLocalColors] = useState<[string, string, string]>(
    settings?.colors || ["#ef4444", "#3b82f6", "#22c55e"]
  );

  const updateMutation = useMutation({
    mutationFn: (colors: [string, string, string]) => updateClinicSettings(colors),
    onSuccess: () => {
      qc.invalidateQueries({ queryKey: ["clinic-settings"] });
      feedback.success("íŒ¨ìŠ¤ì¹´ë“œ ë°°ê²½ ìƒ‰ìƒì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.");
    },
    onError: (e: any) => {
      feedback.error(e?.response?.data?.detail || "ìƒ‰ìƒ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
    },
  });

  // ì„¤ì • ë¡œë“œ ì‹œ ë¡œì»¬ ìƒíƒœ ë™ê¸°í™”
  useEffect(() => {
    if (settings?.colors) {
      setLocalColors(settings.colors);
    }
  }, [settings?.colors]);

  const presetPalettes: Array<{ name: string; colors: [string, string, string] }> = [
    { name: "ë¹¨ê°•-íŒŒë‘-ì´ˆë¡", colors: ["#ef4444", "#3b82f6", "#22c55e"] },
    { name: "ì£¼í™©-ë³´ë¼-í•‘í¬", colors: ["#f97316", "#a855f7", "#ec4899"] },
    { name: "ì²­ë¡-ë…¸ë‘-ì£¼í™©", colors: ["#06b6d4", "#eab308", "#f97316"] },
    { name: "ë³´ë¼-í•‘í¬-ë¹¨ê°•", colors: ["#9333ea", "#ec4899", "#ef4444"] },
    { name: "ì´ˆë¡-ì²­ë¡-íŒŒë‘", colors: ["#22c55e", "#06b6d4", "#3b82f6"] },
    { name: "ë…¸ë‘-ì£¼í™©-ë¹¨ê°•", colors: ["#eab308", "#f97316", "#ef4444"] },
  ];

  const [colorSelectModalOpen, setColorSelectModalOpen] = useState(false);
  const [selectingColorIndex, setSelectingColorIndex] = useState<number | null>(null);

  const handleColorChange = (index: number, color: string) => {
    const newColors: [string, string, string] = [...localColors] as [string, string, string];
    newColors[index] = color;
    setLocalColors(newColors);
  };

  const handlePresetSelect = (colors: [string, string, string]) => {
    setLocalColors(colors);
  };

  const handleOpenColorModal = (index: number) => {
    setSelectingColorIndex(index);
    setColorSelectModalOpen(true);
  };

  const handleColorSelect = (color: string) => {
    if (selectingColorIndex !== null) {
      handleColorChange(selectingColorIndex, color);
    }
    setColorSelectModalOpen(false);
    setSelectingColorIndex(null);
  };

  const handleSave = () => {
    updateMutation.mutate(localColors);
  };

  return (
    <>
      <style>{`
        @keyframes idcard-background-flow {
          0% { background-position: 0% 50%; }
          50% { background-position: 100% 50%; }
          100% { background-position: 0% 50%; }
        }
      `}</style>
      <div className="rounded-2xl border border-[var(--border-divider)] bg-[var(--bg-surface)] overflow-hidden">
        <div className="px-5 py-4 border-b border-[var(--border-divider)] bg-[var(--bg-surface-soft)]">
          <div className="text-sm font-semibold">íŒ¨ìŠ¤ì¹´ë“œ ë°°ê²½ ìƒ‰ìƒ (ìœ„ì¡° ë°©ì§€)</div>
          <div className="text-[11px] text-[var(--text-muted)] mt-0.5">
            ìˆ˜ì—… ì¢…ë£Œ í›„ "ì˜¤ëŠ˜ì€ ë¹¨ íŒŒ ì´ˆë¡œ í•´"ë¼ê³  í•˜ë©´ ë°°ê²½ì´ í•´ë‹¹ ìƒ‰ìƒìœ¼ë¡œ ë³€ê²½ë©ë‹ˆë‹¤.
          </div>
        </div>

        <div className="p-5 space-y-4">
          {/* í˜„ì¬ ì„ íƒëœ ìƒ‰ìƒ ë¯¸ë¦¬ë³´ê¸° */}
          <div className="space-y-2">
            <div className="text-xs font-semibold text-[var(--text-muted)]">í˜„ì¬ ìƒ‰ìƒ ë¯¸ë¦¬ë³´ê¸°</div>
            <div
              className="h-24 rounded-lg border-2 border-[var(--border-divider)]"
              style={{
                background: `linear-gradient(135deg, ${localColors[0]} 0%, ${localColors[1]} 50%, ${localColors[2]} 100%)`,
                backgroundSize: "200% 200%",
                animation: "idcard-background-flow 8s ease infinite",
              }}
            />
          </div>

          {/* ìƒ‰ìƒ 3ê°œ ì„ íƒ ë²„íŠ¼ */}
          <div className="space-y-3">
            <div className="text-xs font-semibold text-[var(--text-muted)]">ìƒ‰ìƒ ì„ íƒ (3ê°œ)</div>
            <div className="grid grid-cols-3 gap-3">
              {[0, 1, 2].map((index) => (
                <button
                  key={index}
                  type="button"
                  onClick={() => handleOpenColorModal(index)}
                  className="group relative h-20 rounded-lg border-2 border-[var(--border-divider)] overflow-hidden hover:border-[var(--color-primary)] transition-colors flex flex-col items-center justify-center gap-1"
                  style={{
                    background: localColors[index],
                  }}
                >
                  <div className="text-xs font-semibold text-white drop-shadow-[0_1px_2px_rgba(0,0,0,0.8)]">
                    ìƒ‰ìƒ {index + 1}
                  </div>
                  <div className="text-[10px] font-mono text-white/80 drop-shadow-[0_1px_2px_rgba(0,0,0,0.8)]">
                    {localColors[index]}
                  </div>
                  <div className="absolute inset-0 bg-black/0 group-hover:bg-black/10 transition-colors" />
                </button>
              ))}
            </div>
          </div>

          {/* í”„ë¦¬ì…‹ íŒ”ë ˆíŠ¸ */}
          <div className="space-y-2">
            <div className="text-xs font-semibold text-[var(--text-muted)]">ë¹ ë¥¸ ì„ íƒ</div>
            <div className="grid grid-cols-3 gap-2">
              {presetPalettes.map((preset, idx) => (
                <button
                  key={idx}
                  type="button"
                  onClick={() => handlePresetSelect(preset.colors)}
                  className="group relative h-16 rounded-lg border-2 border-[var(--border-divider)] overflow-hidden hover:border-[var(--color-primary)] transition-colors"
                  style={{
                    background: `linear-gradient(135deg, ${preset.colors[0]} 0%, ${preset.colors[1]} 50%, ${preset.colors[2]} 100%)`,
                  }}
                  title={preset.name}
                >
                  <div className="absolute inset-0 bg-black/0 group-hover:bg-black/10 transition-colors" />
                  <div className="absolute bottom-1 left-1 right-1 text-[10px] font-semibold text-white drop-shadow-[0_1px_2px_rgba(0,0,0,0.8)]">
                    {preset.name}
                  </div>
                </button>
              ))}
            </div>
          </div>

          {/* ì €ì¥ ë²„íŠ¼ */}
          <div className="pt-2">
            <Button
              intent="primary"
              onClick={handleSave}
              disabled={updateMutation.isPending || isLoading}
              className="w-full"
            >
              {updateMutation.isPending ? "ì €ì¥ ì¤‘â€¦" : "ìƒ‰ìƒ ì €ì¥"}
            </Button>
          </div>
        </div>
      </div>

      {/* ìƒ‰ìƒ ì„ íƒ ëª¨ë‹¬ */}
      <ColorSelectModal
        open={colorSelectModalOpen}
        onClose={() => {
          setColorSelectModalOpen(false);
          setSelectingColorIndex(null);
        }}
        onSelect={handleColorSelect}
        currentColor={selectingColorIndex !== null ? localColors[selectingColorIndex] : null}
      />
    </>
  );
}

/** ìƒ‰ìƒ ì„ íƒ ëª¨ë‹¬ ì»´í¬ë„ŒíŠ¸ */
function ColorSelectModal({
  open,
  onClose,
  onSelect,
  currentColor,
}: {
  open: boolean;
  onClose: () => void;
  onSelect: (color: string) => void;
  currentColor: string | null;
}) {
  // ê¸°ë³¸ ìƒ‰ìƒ íŒ”ë ˆíŠ¸
  const colorPalette: Array<{ name: string; color: string }> = [
    { name: "ë¹¨ê°•", color: "#ef4444" },
    { name: "íŒŒë‘", color: "#3b82f6" },
    { name: "ì´ˆë¡", color: "#22c55e" },
    { name: "ì£¼í™©", color: "#f97316" },
    { name: "ë³´ë¼", color: "#a855f7" },
    { name: "í•‘í¬", color: "#ec4899" },
    { name: "ë…¸ë‘", color: "#eab308" },
    { name: "ì²­ë¡", color: "#06b6d4" },
    { name: "ê²€ì •", color: "#000000" },
    { name: "í°ìƒ‰", color: "#ffffff" },
    { name: "íšŒìƒ‰", color: "#6b7280" },
    { name: "ê°ˆìƒ‰", color: "#92400e" },
  ];

  const [customColor, setCustomColor] = useState(currentColor || "#ef4444");

  useEffect(() => {
    if (currentColor) {
      setCustomColor(currentColor);
    }
  }, [currentColor]);

  return (
    <AdminModal open={open} onClose={onClose} width={MODAL_WIDTH.mediumModal}>
      <ModalHeader title="ìƒ‰ìƒ ì„ íƒ" onClose={onClose} />
      <ModalBody>
        <div className="p-5 space-y-4">
          {/* ê¸°ë³¸ ìƒ‰ìƒ íŒ”ë ˆíŠ¸ */}
          <div className="space-y-2">
            <div className="text-sm font-semibold">ê¸°ë³¸ ìƒ‰ìƒ</div>
            <div className="grid grid-cols-6 gap-2">
              {colorPalette.map((item) => (
                <button
                  key={item.color}
                  type="button"
                  onClick={() => onSelect(item.color)}
                  className={`h-12 rounded-lg border-2 transition-all hover:scale-105 ${
                    currentColor === item.color
                      ? "border-[var(--color-primary)] ring-2 ring-[var(--color-primary)] ring-offset-2"
                      : "border-[var(--border-divider)] hover:border-[var(--color-primary)]"
                  }`}
                  style={{ background: item.color }}
                  title={item.name}
                >
                  <span className="sr-only">{item.name}</span>
                </button>
              ))}
            </div>
          </div>

          {/* ì»¤ìŠ¤í…€ ìƒ‰ìƒ ì„ íƒ */}
          <div className="space-y-2">
            <div className="text-sm font-semibold">ì»¤ìŠ¤í…€ ìƒ‰ìƒ</div>
            <div className="flex items-center gap-3">
              <input
                type="color"
                value={customColor}
                onChange={(e) => setCustomColor(e.target.value)}
                className="h-12 w-12 rounded-lg border-2 border-[var(--border-divider)] cursor-pointer"
              />
              <input
                type="text"
                value={customColor}
                onChange={(e) => {
                  if (/^#[0-9A-Fa-f]{6}$/.test(e.target.value)) {
                    setCustomColor(e.target.value);
                  }
                }}
                className="flex-1 h-12 px-3 rounded-lg border border-[var(--border-divider)] bg-[var(--bg-surface)] font-mono text-sm"
                placeholder="#RRGGBB"
              />
              <Button
                intent="primary"
                onClick={() => onSelect(customColor)}
                className="h-12 px-4"
              >
                ì„ íƒ
              </Button>
            </div>
          </div>
        </div>
      </ModalBody>
      <ModalFooter>
        <Button intent="secondary" onClick={onClose}>
          ì·¨ì†Œ
        </Button>
      </ModalFooter>
    </AdminModal>
  );
}


==========================================================================================
# FILE: utils/buildRollingWeek.ts
==========================================================================================
// PATH: src/features/clinic/utils/buildRollingWeek.ts
import dayjs from "dayjs";

/**
 * ì˜¤ëŠ˜ ê¸°ì¤€ ì›”~ì¼ 7ì¹¸ ìƒì„±
 * - ì˜¤ëŠ˜ ì´ì „ ìš”ì¼ì€ "ë‹¤ìŒì£¼"ë¡œ ì´ë™
 * - dayjs().day()ë§Œ ì‚¬ìš© (plugin ê¸ˆì§€)
 */
export function buildRollingWeek(baseISO: string) {
  const base = dayjs(baseISO);

  // day(): 0=ì¼, 1=ì›” ... 6=í† 
  const raw = base.day();
  const todayDow = raw === 0 ? 7 : raw; // ì›”=1 ~ ì¼=7

  return Array.from({ length: 7 }, (_, i) => {
    const dow = i + 1; // ì›”=1
    let diff = dow - todayDow;

    if (diff < 0) diff += 7;

    const date = base.add(diff, "day");

    return {
      dow,
      dateISO: date.format("YYYY-MM-DD"),
      label: date.format("MM-DD"),
      isToday: diff === 0,
      isNextWeek: diff > 0 && dow < todayDow,
    };
  });
}


==========================================================================================
# FILE: utils/timeSlots.ts
==========================================================================================
export function buildTimeSlots(
  start = 9,
  end = 22,
  stepMinutes = 60
) {
  const slots: string[] = [];
  for (let h = start; h < end; h++) {
    const hh = String(h).padStart(2, "0");
    slots.push(`${hh}:00`);
  }
  return slots;
}
