====================================================================================================
# FRONTEND FOLDER: features__students
# ROOT PATH: C:\academyfront\src\features\students
====================================================================================================


==========================================================================================
# FILE: StudentsLayout.tsx
==========================================================================================
// PATH: src/features/students/StudentsLayout.tsx
import { Outlet } from "react-router-dom";
import { DomainLayout } from "@/shared/ui/layout";

const STUDENTS_TABS = [
  { key: "home", label: "í™ˆ", path: "/admin/students/home" },
  { key: "deleted", label: "ì‚­ì œëœ í•™ìƒ", path: "/admin/students/deleted" },
];

export default function StudentsLayout() {
  return (
    <DomainLayout
      title="í•™ìƒ ê´€ë¦¬"
      description="í•™ìƒ ì¶”ê°€ Â· í•™êµ ì„±ì  Â· ìƒë‹´"
      tabs={STUDENTS_TABS}
    >
      <Outlet />
    </DomainLayout>
  );
}


==========================================================================================
# FILE: StudentsRoutes.tsx
==========================================================================================
// PATH: src/features/students/StudentsRoutes.tsx
import { Routes, Route, Navigate } from "react-router-dom";

import StudentsLayout from "./StudentsLayout";

import StudentsHomePage from "./pages/StudentsHomePage";
import StudentsHistoryPage from "./pages/StudentsHistoryPage";
import StudentsScoresPage from "./pages/StudentsScoresPage";
import StudentDetailOverlay from "./overlays/StudentDetailOverlay";

export default function StudentsRoutes() {
  return (
    <Routes>
      <Route element={<StudentsLayout />}>
        <Route index element={<Navigate to="home" replace />} />
        <Route path="home" element={<StudentsHomePage />} />
        <Route path="history" element={<StudentsHistoryPage />} />
        <Route path="scores" element={<StudentsScoresPage />} />
      </Route>

      {/* í•™ìƒ ìƒì„¸ëŠ” Overlay (ì§ì›ê³¼ ë™ì¼ íŒ¨í„´) */}
      <Route path=":studentId/*" element={<StudentDetailOverlay />} />
    </Routes>
  );
}


==========================================================================================
# FILE: api/students.ts
==========================================================================================
// PATH: src/features/students/api/students.ts
import api from "@/shared/api/axios";

/* ===============================
 * Types
 * =============================== */

export interface ClientStudentTag {
  id: number;
  name: string;
  color: string;
}

export interface ClientEnrollmentLite {
  id: number;
  lectureName: string | null;
  lectureColor: string | null;
}

export interface ClientStudent {
  id: number;
  name: string;
  /** í•™ìƒì•±ì—ì„œ ì—…ë¡œë“œí•œ í”„ë¡œí•„ ì‚¬ì§„ URL (ì—†ìœ¼ë©´ null) */
  profilePhotoUrl?: string | null;

  psNumber: string;
  omrCode: string;

  studentPhone: string | null;
  parentPhone: string | null;
  /** Trueë©´ ì‹ë³„ìë¡œ ê°€ì…, í‘œì‹œ ì‹œ "ì‹ë³„ì XXXX-XXXX" */
  usesIdentifier?: boolean;

  school: string | null;
  schoolClass: string | null;
  major: string | null;

  grade: number | null;
  gender: string | null;

  registeredAt: string | null;
  active: boolean;
  memo?: string | null;

  schoolType: "MIDDLE" | "HIGH" | null;

  tags: ClientStudentTag[];
  enrollments: ClientEnrollmentLite[];
  deletedAt?: string | null;
}

export interface StudentTag {
  id: number;
  name: string;
  color: string;
}

/* ===============================
 * Mapper
 * =============================== */

function safeStr(v: any): string {
  return typeof v === "string" ? v : v == null ? "" : String(v);
}

function mapStudent(item: any): ClientStudent {
  const phone = item?.phone ?? null;
  const omrCode = item?.omr_code ?? "";

  // ğŸ”§ ë³€ê²½: UIì—ëŠ” í•­ìƒ phoneë§Œ ì „ë‹¬
  const displayPhone = phone ?? null;

  const schoolType: "MIDDLE" | "HIGH" | null =
    item?.school_type ??
    (item?.middle_school ? "MIDDLE" : item?.high_school ? "HIGH" : null);

  return {
    id: Number(item?.id),
    name: safeStr(item?.name),
    profilePhotoUrl: item?.profile_photo_url ?? null,

    psNumber: safeStr(item?.ps_number),
    omrCode: safeStr(omrCode),

    studentPhone: displayPhone ?? null,
    parentPhone: item?.parent_phone ?? null,
    usesIdentifier: !!item?.uses_identifier,

    school: item?.high_school ?? item?.middle_school ?? null,
    schoolClass: item?.high_school_class ?? null,
    major: item?.major ?? null,

    grade: item?.grade ?? null,
    gender: item?.gender ?? null,

    registeredAt: item?.created_at ?? null,
    active: item?.is_managed ?? false,
    memo: item?.memo ?? null,

    schoolType,

    tags: Array.isArray(item?.tags)
      ? item.tags.map((t: any) => ({
          id: Number(t?.id),
          name: safeStr(t?.name),
          color: safeStr(t?.color),
        }))
      : [],

    enrollments: Array.isArray(item?.enrollments)
      ? item.enrollments.map((en: any) => ({
          id: Number(en?.id),
          lectureName: en?.lecture_name ?? null,
          lectureColor: en?.lecture_color ?? "#3b82f6",
          lectureChipLabel: en?.lecture_chip_label ?? null,
        }))
      : [],
    deletedAt: item?.deleted_at ?? null,
  };
}

/* ===============================
 * Ordering (server-side friendly)
 * =============================== */

const ORDERING_MAP: Record<string, string> = {
  name: "name",
  registeredAt: "created_at",
  deletedAt: "deleted_at",
  active: "is_managed",
  psNumber: "ps_number",
  studentPhone: "phone",
  parentPhone: "parent_phone",
  school: "high_school",
  schoolClass: "high_school_class",
  grade: "grade",
  gender: "gender",
};

function buildOrdering(sort: string): string | undefined {
  if (!sort) return undefined;

  const isDesc = sort.startsWith("-");
  const key = isDesc ? sort.slice(1) : sort;

  const mapped = ORDERING_MAP[key];
  if (!mapped) return undefined;

  return isDesc ? `-${mapped}` : mapped;
}

/* ===============================
 * List / Detail
 * =============================== */

export async function fetchStudents(
  search: string,
  filters: any = {},
  sort: string = "",
  page: number = 1,
  deleted: boolean = false
): Promise<{ data: ReturnType<typeof mapStudent>[]; count: number }> {
  const ordering = buildOrdering(sort);

  const params: Record<string, unknown> = {
    search: search || undefined,
    ...filters,
    ordering: ordering || undefined,
    page,
    deleted: deleted ? "true" : undefined,
  };
  // ëª©ë¡ í•„í„°: ë°±ì—”ë“œì— ë°˜ë“œì‹œ ì „ë‹¬ (school_type, grade)
  if (filters.school_type != null && String(filters.school_type).trim() !== "") {
    params.school_type = filters.school_type;
  }
  if (filters.grade != null && Number.isInteger(Number(filters.grade))) {
    params.grade = Number(filters.grade);
  }

  const res = await api.get("/students/", { params: params as any });

  const items = Array.isArray(res.data?.results)
    ? res.data.results
    : Array.isArray(res.data)
    ? res.data
    : [];
  const count = typeof res.data?.count === "number" ? res.data.count : items.length;
  const pageSize = typeof res.data?.page_size === "number" ? res.data.page_size : 50;

  return {
    data: items.map(mapStudent),
    count,
    pageSize,
  };
}

export async function getStudentDetail(id: number) {
  const res = await api.get(`/students/${id}/`);
  return mapStudent(res.data);
}

/* ===============================
 * CREATE
 * =============================== */

export async function createStudent(form: any) {
  const name = safeStr(form?.name).trim();
  const initialPassword = safeStr(form?.initialPassword).trim();

  const studentPhoneInput = safeStr(form?.studentPhone).trim();
  const parentPhoneInput = safeStr(form?.parentPhone).trim();
  const noPhone = !studentPhoneInput;

  const phone = noPhone
    ? `010${parentPhoneInput.replace(/\D/g, "").slice(-8)}`
    : studentPhoneInput;

  const payload: Record<string, unknown> = {
    name,
    phone,
    omr_code: safeStr(phone).slice(-8),
    initial_password: initialPassword,

    parent_phone: parentPhoneInput,

    school_type: form?.schoolType,
    high_school: form?.schoolType === "HIGH" ? form?.school || null : null,
    middle_school: form?.schoolType === "MIDDLE" ? form?.school || null : null,

    high_school_class: form?.schoolType === "HIGH" ? form?.schoolClass || null : null,

    major: form?.schoolType === "HIGH" ? form?.major || null : null,

    grade: form?.grade ? Number(form.grade) : null,
    gender: form?.gender || null,
    memo: form?.memo || null,

    is_managed: !!form?.active,

    send_welcome_message: !!form?.sendWelcomeMessage,
    no_phone: noPhone,
  };
  // ps_number ë¯¸ì…ë ¥ ì‹œ ë°±ì—”ë“œì—ì„œ 6ìë¦¬ ìë™ ë¶€ì—¬
  const psNumber = safeStr(form?.psNumber).trim();
  if (psNumber) payload.ps_number = psNumber;

  const res = await api.post("/students/", payload);
  return mapStudent(res.data);
}

/** ì—‘ì…€ ì¼ê´„ ë“±ë¡ (600ëª…+ ëŒ€ëŸ‰ ì—…ë¡œë“œ) */
export async function bulkCreateStudents(
  initialPassword: string,
  students: Array<{
    name: string;
    phone: string;
    parentPhone: string;
    usesIdentifier?: boolean;
    gender?: string | null;
    schoolType?: "HIGH" | "MIDDLE";
    school?: string | null;
    grade?: number | null;
    schoolClass?: string | null;
    major?: string | null;
    memo?: string | null;
  }>,
  sendWelcomeMessage = false
) {
  const payload = {
    initial_password: initialPassword,
    send_welcome_message: sendWelcomeMessage,
    students: students.map((s) => ({
      name: s.name.trim(),
      phone: String(s.phone || "").replace(/\D/g, ""),
      parent_phone: String(s.parentPhone || "").replace(/\D/g, ""),
      uses_identifier: !!s.usesIdentifier,
      gender: s.gender || "",
      school_type: s.schoolType || "HIGH",
      school: s.school || "",
      high_school_class: s.schoolClass || "",
      major: s.major || "",
      grade: s.grade ?? null,
      memo: s.memo || "",
      is_managed: true,
    })),
  };
  const res = await api.post("/students/bulk_create/", payload, { timeout: 120_000 });
  return res.data as { created: number; failed: Array<{ row: number; name: string; error: string }>; total: number };
}

/* ===============================
 * UPDATE
 * =============================== */

export async function updateStudent(id: number, form: any) {
  const payload: any = {
    grade: form?.grade ? Number(form.grade) : null,
    gender: form?.gender ?? null,
    memo: form?.memo ?? null,
    is_managed: !!form?.active,
  };

  if (form?.parentPhone !== undefined) {
    payload.parent_phone = safeStr(form?.parentPhone).trim();
  }

  const phone =
    form?.noPhone === true
      ? `010${safeStr(form?.omrCode).trim()}`
      : form?.studentPhone
      ? safeStr(form?.studentPhone).trim()
      : undefined;

  if (phone) {
    payload.phone = phone;
    payload.omr_code = safeStr(phone).slice(-8);
  }

  if (form?.psNumber !== undefined) {
    payload.ps_number = safeStr(form?.psNumber).trim();
  }

  if (form?.schoolType) {
    payload.school_type = form.schoolType;
    payload.high_school = form.schoolType === "HIGH" ? form?.school || null : null;
    payload.middle_school = form.schoolType === "MIDDLE" ? form?.school || null : null;
    payload.high_school_class =
      form.schoolType === "HIGH" ? form?.schoolClass || null : null;
    payload.major = form.schoolType === "HIGH" ? form?.major || null : null;
  }

  const res = await api.patch(`/students/${id}/`, payload);
  return mapStudent(res.data);
}

/* ===============================
 * TOGGLE ACTIVE
 * =============================== */

export async function toggleStudentActive(id: number, nextActive: boolean) {
  const res = await api.patch(`/students/${id}/`, {
    is_managed: nextActive,
  });
  return mapStudent(res.data);
}

/* ===============================
 * DELETE
 * =============================== */

export async function deleteStudent(id: number) {
  await api.delete(`/students/${id}/`);
  return true;
}

/** ì„ íƒ í•™ìƒ ì¼ê´„ ì†Œí”„íŠ¸ ì‚­ì œ (30ì¼ ë³´ê´€) */
export async function bulkDeleteStudents(ids: number[]) {
  const res = await api.post("/students/bulk_delete/", { ids });
  return res.data as { deleted: number };
}

/** ì‚­ì œëœ í•™ìƒ ì¼ê´„ ë³µì› */
export async function bulkRestoreStudents(ids: number[]) {
  const res = await api.post("/students/bulk_restore/", { ids });
  return res.data as { restored: number };
}

/** ì‚­ì œëœ í•™ìƒ ì¦‰ì‹œ ì˜êµ¬ ì‚­ì œ */
export async function bulkPermanentDeleteStudents(ids: number[]) {
  const res = await api.post("/students/bulk_permanent_delete/", { ids });
  return res.data as { deleted: number };
}

/** ì‚­ì œëœ í•™ìƒ ì¤‘ (ì´ë¦„+í•™ë¶€ëª¨ì „í™”) ì¤‘ë³µ ê²€ì‚¬ â€” ê³ ê° ì…€í”„ ë³µêµ¬ìš© */
export async function checkDeletedStudentDuplicates() {
  const res = await api.get("/students/deleted_duplicates_check/");
  return res.data as { duplicate_groups: number; records_to_remove: number };
}

/** ì‚­ì œëœ í•™ìƒ ì¤‘ë³µ ì •ë¦¬ â€” ê·¸ë£¹ë‹¹ 1ëª…ë§Œ ìœ ì§€, ë‚˜ë¨¸ì§€ ì˜êµ¬ ì‚­ì œ */
export async function fixDeletedStudentDuplicates() {
  const res = await api.post("/students/deleted_duplicates_fix/");
  return res.data as { removed: number };
}

/** ì¶©ëŒ í•´ê²° í›„ ì¬ë“±ë¡ (ì‚­ì œëœ í•™ìƒê³¼ ë²ˆí˜¸ ì¶©ëŒ ì‹œ ë³µì› ë˜ëŠ” ì˜êµ¬ ì‚­ì œ í›„ ì¬ë“±ë¡) */
export async function bulkResolveConflicts(
  password: string,
  resolutions: Array<{
    row: number;
    student_id: number;
    action: "restore" | "delete";
    student_data: Record<string, unknown>;
  }>,
  sendWelcomeMessage = false
) {
  const res = await api.post("/students/bulk_resolve_conflicts/", {
    initial_password: password,
    send_welcome_message: sendWelcomeMessage,
    resolutions: resolutions.map((r) => ({
      row: r.row,
      student_id: r.student_id,
      action: r.action,
      student_data: r.student_data,
    })),
  });
  return res.data as { created: number; restored: number; failed: Array<{ row: number; name: string; error: string }> };
}

/* ===============================
 * TAG
 * =============================== */

export async function getTags(): Promise<StudentTag[]> {
  const res = await api.get(`/students/tags/`);
  const items = Array.isArray(res.data?.results)
    ? res.data.results
    : Array.isArray(res.data)
    ? res.data
    : [];
  return items.map((t: any) => ({
    id: Number(t?.id),
    name: safeStr(t?.name),
    color: safeStr(t?.color),
  }));
}

export async function createTag(name: string, color: string): Promise<StudentTag> {
  const res = await api.post(`/students/tags/`, { name: name.trim(), color });
  const t = res.data;
  return {
    id: Number(t?.id),
    name: safeStr(t?.name),
    color: safeStr(t?.color),
  };
}

export async function attachStudentTag(studentId: number, tagId: number) {
  await api.post(`/students/${studentId}/add_tag/`, { tag_id: tagId });
}

export async function detachStudentTag(studentId: number, tagId: number) {
  await api.post(`/students/${studentId}/remove_tag/`, { tag_id: tagId });
}

/* ===============================
 * MEMO
 * =============================== */

export async function createMemo(studentId: number, content: string) {
  await api.patch(`/students/${studentId}/`, { memo: String(content ?? "") });
}


==========================================================================================
# FILE: components/DeleteConfirmModal.tsx
==========================================================================================
// PATH: src/features/students/components/DeleteConfirmModal.tsx
import { useEffect, useMemo, useState } from "react";
import { AdminModal, ModalBody, ModalFooter, ModalHeader, MODAL_DEFAULT_WIDTH } from "@/shared/ui/modal";
import { Button } from "@/shared/ui/ds";
import { deleteStudent } from "../api/students";

export default function DeleteConfirmModal({
  open,
  id,
  onClose,
  onSuccess,
}: {
  open: boolean;
  id: number;
  onClose: () => void;
  onSuccess: () => void;
}) {
  const [busy, setBusy] = useState(false);

  const title = useMemo(() => "í•™ìƒ ì‚­ì œ", []);

  useEffect(() => {
    function onKeyDown(e: KeyboardEvent) {
      if (e.key === "Escape") onClose();
    }
    if (open) window.addEventListener("keydown", onKeyDown);
    return () => window.removeEventListener("keydown", onKeyDown);
  }, [open, onClose]);

  async function handleDelete() {
    if (busy) return;
    setBusy(true);
    try {
      await deleteStudent(id);
      onSuccess();
      onClose();
    } finally {
      setBusy(false);
    }
  }

  return (
    <AdminModal open={open} onClose={onClose} type="confirm" width={MODAL_DEFAULT_WIDTH}>
      <ModalHeader
        type="confirm"
        title={title}
        description="ì‚­ì œëœ ë°ì´í„°ëŠ” ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
      />

      <ModalBody>
        <div
          style={{
            fontSize: 13,
            fontWeight: 850,
            color: "var(--color-text-secondary)",
            lineHeight: 1.6,
          }}
        >
          í•´ë‹¹ í•™ìƒì„ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?
        </div>

        <div
          style={{
            marginTop: 12,
            padding: "10px 12px",
            borderRadius: 12,
            border:
              "1px solid color-mix(in srgb, var(--color-error) 22%, var(--color-border-divider))",
            background:
              "color-mix(in srgb, var(--color-error) 6%, var(--color-bg-surface))",
            color: "var(--color-text-secondary)",
            fontSize: 12,
            fontWeight: 850,
            letterSpacing: "-0.12px",
          }}
        >
          ì‚­ì œ í›„ì—ëŠ” í•™ìƒ ì •ë³´/íƒœê·¸/ë©”ëª¨/ì—°ê²°ëœ ì´ë ¥ì´ ë³µêµ¬ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
        </div>
      </ModalBody>

      <ModalFooter
        left={
          <span
            style={{
              fontSize: 12,
              fontWeight: 850,
              color: "var(--color-text-muted)",
            }}
          >
            ESC ë¡œ ë‹«ê¸°
          </span>
        }
        right={
          <>
            <Button intent="secondary" onClick={onClose} disabled={busy}>
              ì·¨ì†Œ
            </Button>
            <Button intent="danger" onClick={handleDelete} disabled={busy}>
              {busy ? "ì‚­ì œ ì¤‘â€¦" : "ì‚­ì œ"}
            </Button>
          </>
        }
      />
    </AdminModal>
  );
}


==========================================================================================
# FILE: components/EditStudentModal.tsx
==========================================================================================
// PATH: src/features/students/components/EditStudentModal.tsx
import { useEffect, useMemo, useState } from "react";
import { AdminModal, ModalBody, ModalFooter, ModalHeader, MODAL_WIDTH } from "@/shared/ui/modal";
import { Button } from "@/shared/ui/ds";
import {
  formatPhoneForInput,
  formatIdentifierForInput,
  parsePhoneInput,
  parseIdentifierInput,
} from "@/shared/utils/phoneInput";
import { updateStudent } from "../api/students";

interface Props {
  open: boolean;
  initialValue: any;
  onClose: () => void;
  onSuccess: () => void;
}

function is8Digits(v: any) {
  return /^\d{8}$/.test(String(v ?? ""));
}

export default function EditStudentModal({
  open,
  initialValue,
  onClose,
  onSuccess,
}: Props) {
  const initialNoPhone = useMemo(() => {
    if (initialValue.usesIdentifier != null) return initialValue.usesIdentifier;
    return initialValue.studentPhone && is8Digits(initialValue.studentPhone);
  }, [initialValue.studentPhone, initialValue.usesIdentifier]);

  const [noPhone, setNoPhone] = useState(initialNoPhone);
  const [busy, setBusy] = useState(false);
  /** 400 ì‘ë‹µ ì‹œ ë°±ì—”ë“œ í•„ë“œë³„ ì—ëŸ¬ (backend key -> message). setFields ê°œë…ìœ¼ë¡œ ë§¤í•‘ */
  const [fieldErrors, setFieldErrors] = useState<Record<string, string>>({});

  const [form, setForm] = useState({
    name: initialValue.name || "",
    gender: initialValue.gender || "",
    psNumber: initialValue.psNumber || "",
    studentPhone: initialNoPhone ? "" : initialValue.studentPhone || "",
    omrCode: initialNoPhone ? initialValue.studentPhone || "" : "",
    parentPhone: initialValue.parentPhone || "",
    schoolType: initialValue.schoolType || "HIGH",
    school: initialValue.school || "",
    grade: initialValue.grade ? String(initialValue.grade) : "",
    schoolClass: initialValue.schoolClass || "",
    major: initialValue.major || "",
    memo: initialValue.memo || "",
    active: !!initialValue.active,
  });

  useEffect(() => {
    if (!open) return;

    function onKeyDown(e: KeyboardEvent) {
      if (e.key === "Escape") onClose();
      if ((e.ctrlKey || e.metaKey) && e.key === "Enter") handleSubmit();
    }
    window.addEventListener("keydown", onKeyDown);
    return () => window.removeEventListener("keydown", onKeyDown);
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [open, onClose, form, noPhone, busy]);

  useEffect(() => {
    if (!open) return;
    setNoPhone(initialNoPhone);
    setBusy(false);
    setFieldErrors({});
    setForm({
      name: initialValue.name || "",
      gender: initialValue.gender || "",
      psNumber: initialValue.psNumber || "",
      studentPhone: initialNoPhone ? "" : initialValue.studentPhone || "",
      omrCode: initialNoPhone
        ? (() => {
            const p = String(initialValue.studentPhone || "").replace(/\D/g, "");
            return p.length === 11 && p.startsWith("010") ? p.slice(-8) : p.slice(0, 8);
          })()
        : "",
      parentPhone: initialValue.parentPhone || "",
      schoolType: initialValue.schoolType || "HIGH",
      school: initialValue.school || "",
      grade: initialValue.grade ? String(initialValue.grade) : "",
      schoolClass: initialValue.schoolClass || "",
      major: initialValue.major || "",
      memo: initialValue.memo || "",
      active: !!initialValue.active,
    });
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [open, initialValue?.id]);

  /** ë°±ì—”ë“œ í•„ë“œëª… -> í”„ë¡ íŠ¸ í•„ë“œëª… (setFields ë§¤í•‘) */
  const backendToFrontendField: Record<string, string> = {
    ps_number: "psNumber",
    omr_code: noPhone ? "omrCode" : "studentPhone",
    phone: "studentPhone",
    parent_phone: "parentPhone",
    name: "name",
  };

  function handleChange(e: any) {
    const { name } = e.target;
    setForm((p) => ({ ...p, [name]: e.target.value }));
    if (fieldErrors[name]) setFieldErrors((prev) => ({ ...prev, [name]: "" }));
  }

  function handlePhoneChange(name: "studentPhone" | "parentPhone", value: string) {
    const raw = parsePhoneInput(value);
    setForm((p) => ({ ...p, [name]: raw }));
    if (fieldErrors[name]) setFieldErrors((prev) => ({ ...prev, [name]: "" }));
  }

  function handleIdentifierChange(value: string) {
    const raw = parseIdentifierInput(value);
    setForm((p) => ({ ...p, omrCode: raw }));
    if (fieldErrors.omrCode) setFieldErrors((prev) => ({ ...prev, omrCode: "" }));
  }

  /** StudentUpdateSerializer / ëª¨ë¸ ê¸°ì¤€ í•„ìˆ˜: name, ps_number, phone, parent_phone (Createì™€ ë™ì¼) */
  function validate(): string | null {
    if (!String(form.name || "").trim()) return "í•„ìˆ˜ ì…ë ¥ì…ë‹ˆë‹¤.";
    if (!String(form.psNumber || "").trim()) return "í•„ìˆ˜ ì…ë ¥ì…ë‹ˆë‹¤.";

    if (noPhone) {
      const code = String(form.omrCode || "").trim();
      if (!code) return "í•„ìˆ˜ ì…ë ¥ì…ë‹ˆë‹¤.";
      if (!/^\d{8}$/.test(code)) return "ì‹ë³„ìëŠ” 8ìë¦¬ ìˆ«ì(XXXXXXXX)ì—¬ì•¼ í•©ë‹ˆë‹¤.";
    } else {
      const phone = String(form.studentPhone || "").trim();
      if (!phone) return "í•„ìˆ˜ ì…ë ¥ì…ë‹ˆë‹¤.";
      if (!/^010\d{8}$/.test(phone)) return "í•™ìƒ ì „í™”ë²ˆí˜¸ëŠ” 010XXXXXXXX í˜•ì‹ì´ì–´ì•¼ í•©ë‹ˆë‹¤.";
    }

    const parent = String(form.parentPhone || "").trim();
    if (!parent) return "í•„ìˆ˜ ì…ë ¥ì…ë‹ˆë‹¤.";
    if (!/^010\d{8}$/.test(parent)) return "í•™ë¶€ëª¨ ì „í™”ë²ˆí˜¸ëŠ” 010XXXXXXXX í˜•ì‹ì´ì–´ì•¼ í•©ë‹ˆë‹¤.";

    return null;
  }

  async function handleSubmit() {
    if (busy) return;

    const err = validate();
    if (err) return alert(err);

    setBusy(true);
    setFieldErrors({});
    try {
      await updateStudent(initialValue.id, { ...form, noPhone });
      onSuccess();
      onClose();
    } catch (raw: any) {
      const data = raw?.response?.data;
      if (raw?.response?.status === 400 && data && typeof data === "object") {
        const next: Record<string, string> = {};
        for (const [backendKey, val] of Object.entries(data)) {
          const msg = Array.isArray(val) ? val[0] : typeof val === "string" ? val : "";
          if (!msg) continue;
          const frontKey = backendToFrontendField[backendKey] ?? backendKey;
          next[frontKey] = msg;
        }
        setFieldErrors(next);
        const messages = Object.entries(next)
          .map(([k, v]) => (k === "name" ? "ì´ë¦„" : k === "psNumber" ? "ì•„ì´ë””" : k === "studentPhone" ? "í•™ìƒ ì „í™”/ì‹ë³„ì" : k === "omrCode" ? "ì‹ë³„ì" : k === "parentPhone" ? "í•™ë¶€ëª¨ ì „í™”" : k) + ": " + v)
          .join("\n");
        alert(messages);
      } else {
        alert(raw?.message || "ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
      }
    } finally {
      setBusy(false);
    }
  }

  return (
    <AdminModal open={open} onClose={onClose} type="action" width={MODAL_WIDTH.md}>
      <ModalHeader
        type="action"
        title="í•™ìƒ ìˆ˜ì •"
        description="âŒ˜/Ctrl + Enter ë¡œ ì €ì¥"
      />

      <ModalBody>
        <div className="modal-scroll-body modal-scroll-body--compact">
          <div className="modal-form-row modal-form-row--1-auto">
            <input
              name="name"
              placeholder="ì´ë¦„"
              value={form.name}
              onChange={handleChange}
              className="ds-input"
              data-required="true"
              data-invalid={!String(form.name || "").trim() ? "true" : "false"}
              disabled={busy}
              autoFocus
            />
            <div className="modal-option-row" style={{ display: "flex", gap: "var(--space-2)", flexWrap: "wrap" }}>
              {[{ key: "M", label: "ë‚¨ì" }, { key: "F", label: "ì—¬ì" }].map((g) => (
                <Button
                  key={g.key}
                  intent={form.gender === g.key ? "secondary" : "ghost"}
                  aria-pressed={form.gender === g.key}
                  onClick={() => setForm((p) => ({ ...p, gender: g.key }))}
                  disabled={busy}
                >
                  {g.label}
                </Button>
              ))}
            </div>
          </div>

          <div className="modal-form-row modal-form-row--2">
            <input
              name="psNumber"
              placeholder="ì•„ì´ë””(PS ë²ˆí˜¸)"
              value={form.psNumber}
              onChange={handleChange}
              className="ds-input"
              data-required="true"
              data-invalid={!String(form.psNumber || "").trim() ? "true" : "false"}
              disabled={busy}
            />
            <div className="modal-form-group modal-form-group--row">
              <span className="modal-section-label" style={{ marginBottom: 0 }}>ìƒíƒœ</span>
              <button
                type="button"
                className="ds-status-badge"
                data-status={form.active ? "active" : "inactive"}
                aria-pressed={form.active}
                onClick={() => setForm((p) => ({ ...p, active: !p.active }))}
                disabled={busy}
              >
                {form.active ? "í™œì„±" : "ë¹„í™œì„±"}
              </button>
            </div>
          </div>

          <div className="modal-form-row modal-form-row--1-auto">
            {noPhone ? (
              <input
                placeholder="ì‹ë³„ì (XXXX-XXXX)"
                value={formatIdentifierForInput(form.omrCode)}
                onChange={(e) => handleIdentifierChange(e.target.value)}
                className="ds-input"
                data-required="true"
                disabled={busy}
                maxLength={9}
                inputMode="numeric"
                pattern="[0-9\-]*"
              />
            ) : (
              <input
                placeholder="í•™ìƒ ì „í™” (010-XXXX-XXXX)"
                value={formatPhoneForInput(form.studentPhone)}
                onChange={(e) => handlePhoneChange("studentPhone", e.target.value)}
                className="ds-input"
                data-required="true"
                disabled={busy}
                maxLength={13}
                inputMode="numeric"
                pattern="[0-9\-]*"
              />
            )}
            <Button
              intent={noPhone ? "secondary" : "ghost"}
              onClick={() => {
                setNoPhone((v) => !v);
                setForm((p) => ({ ...p, studentPhone: "", omrCode: "" }));
              }}
              disabled={busy}
            >
              {noPhone ? "ì „í™” ì…ë ¥" : "ì‹ë³„ì ì‚¬ìš©"}
            </Button>
          </div>

          <input
            placeholder="í•™ë¶€ëª¨ ì „í™” (010-XXXX-XXXX)"
            value={formatPhoneForInput(form.parentPhone)}
            onChange={(e) => handlePhoneChange("parentPhone", e.target.value)}
            className="ds-input"
            data-required="true"
            disabled={busy}
            maxLength={13}
            inputMode="numeric"
            pattern="[0-9\-]*"
          />

          <div className="modal-option-row" style={{ display: "flex", gap: "var(--space-2)", flexWrap: "wrap" }}>
            {[{ key: "HIGH", label: "ê³ ë“±" }, { key: "MIDDLE", label: "ì¤‘ë“±" }].map((t) => (
              <Button
                key={t.key}
                intent={form.schoolType === t.key ? "secondary" : "ghost"}
                aria-pressed={form.schoolType === t.key}
                onClick={() =>
                  setForm((p) => ({
                    ...p,
                    schoolType: t.key,
                    school: "",
                    schoolClass: "",
                    major: "",
                  }))
                }
                disabled={busy}
              >
                {t.label}
              </Button>
            ))}
          </div>

          <div className="modal-form-row modal-form-row--1-auto">
            <input
              name="school"
              placeholder="í•™êµëª…"
              value={form.school}
              onChange={handleChange}
              className="ds-input"
              disabled={busy}
            />
            <div className="modal-actions-inline">
              {["1", "2", "3"].map((g) => (
                <Button
                  key={g}
                  intent={form.grade === g ? "secondary" : "ghost"}
                  aria-pressed={form.grade === g}
                  onClick={() => setForm((p) => ({ ...p, grade: g }))}
                  disabled={busy}
                >
                  {g}í•™ë…„
                </Button>
              ))}
            </div>
          </div>

          <div className="modal-form-row modal-form-row--2">
            <input
              name="schoolClass"
              placeholder="ë°˜"
              value={form.schoolClass}
              onChange={handleChange}
              className="ds-input"
              disabled={busy}
            />
            <input
              name="major"
              placeholder="ê³„ì—´(ê³ ë“±ë§Œ)"
              value={form.major}
              onChange={handleChange}
              className="ds-input"
              disabled={busy}
            />
          </div>

          <textarea
            name="memo"
            rows={3}
            placeholder="ë©”ëª¨"
            value={form.memo}
            onChange={handleChange}
            className="ds-textarea"
            disabled={busy}
          />
        </div>
      </ModalBody>

      <ModalFooter
        left={
          <span className="modal-hint" style={{ marginBottom: 0 }}>âŒ˜/Ctrl + Enter ì €ì¥</span>
        }
        right={
          <>
            <Button intent="secondary" onClick={onClose} disabled={busy}>
              ì·¨ì†Œ
            </Button>
            <Button intent="primary" onClick={handleSubmit} disabled={busy}>
              {busy ? "ì €ì¥ ì¤‘â€¦" : "ì €ì¥"}
            </Button>
          </>
        }
      />
    </AdminModal>
  );
}


==========================================================================================
# FILE: components/StudentCreateModal.tsx
==========================================================================================
// PATH: src/features/students/components/StudentCreateModal.tsx
import { useEffect, useState } from "react";
import { AdminModal, ModalBody, ModalFooter, ModalHeader, MODAL_WIDTH } from "@/shared/ui/modal";
import { Button, Tabs } from "@/shared/ui/ds";
import {
  formatPhoneForInput,
  formatIdentifierForInput,
  parsePhoneInput,
} from "@/shared/utils/phoneInput";
import ExcelUploadZone from "@/shared/ui/excel/ExcelUploadZone";
import { createStudent, bulkCreateStudents, bulkResolveConflicts } from "../api/students";
import {
  downloadStudentExcelTemplate,
  parseStudentExcel,
  type ParsedStudentRow,
} from "../excel/studentExcel";

interface Props {
  open: boolean;
  onClose: () => void;
  onSuccess: () => void;
  onBulkProgress?: (progress: { current: number; total: number } | null) => void;
}

const TAB_ITEMS = [
  { key: "single", label: "1ëª…ë§Œ ë“±ë¡" },
  { key: "excel", label: "ì—‘ì…€ë¡œ ì—…ë¡œë“œ" },
];

interface BulkFailedItem {
  row: number;
  name: string;
  error: string;
  conflict_student_id?: number | null;
  student: {
    name: string;
    phone: string;
    parentPhone: string;
    gender?: string | null;
    schoolType?: "HIGH" | "MIDDLE";
    school?: string | null;
    grade?: number | null;
    schoolClass?: string | null;
    major?: string | null;
    memo?: string | null;
  };
}

interface BulkResult {
  created: number;
  failed: BulkFailedItem[];
  total: number;
  password: string;
}

export default function StudentCreateModal({ open, onClose, onSuccess, onBulkProgress }: Props) {
  const [activeTab, setActiveTab] = useState("single");
  const [busy, setBusy] = useState(false);
  const [progress, setProgress] = useState<{ current: number; total: number } | null>(null);
  const [excelBulkPassword, setExcelBulkPassword] = useState("");
  const [bulkResult, setBulkResult] = useState<BulkResult | null>(null);
  const [excelParsedRows, setExcelParsedRows] = useState<ParsedStudentRow[] | null>(null);
  const [conflictResolutions, setConflictResolutions] = useState<Record<number, "restore" | "delete">>({});
  const [batchConflictAction, setBatchConflictAction] = useState<"restore" | "delete" | null>(null);

  const [sendWelcomeMessage, setSendWelcomeMessage] = useState(false);
  const [form, setForm] = useState({
    name: "",
    gender: "",
    initialPassword: "",
    studentPhone: "",
    omrCode: "",
    parentPhone: "",
    schoolType: "HIGH",
    school: "",
    grade: "",
    schoolClass: "",
    major: "",
    memo: "",
    active: true,
  });

  useEffect(() => {
    if (!open) return;

    function onKeyDown(e: KeyboardEvent) {
      if (e.key === "Escape") onClose();
      if ((e.ctrlKey || e.metaKey) && e.key === "Enter" && activeTab === "single") handleSubmit();
    }
    window.addEventListener("keydown", onKeyDown);
    return () => window.removeEventListener("keydown", onKeyDown);
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [open, onClose, form, busy, activeTab]);

  useEffect(() => {
    if (!open) return;
    setActiveTab("single");
    setBusy(false);
    setProgress(null);
    onBulkProgress?.(null);
    setExcelBulkPassword("");
    setBulkResult(null);
    setExcelParsedRows(null);
    setSendWelcomeMessage(false);
    setForm({
      name: "",
      gender: "",
      initialPassword: "",
      studentPhone: "",
      omrCode: "",
      parentPhone: "",
      schoolType: "HIGH",
      school: "",
      grade: "",
      schoolClass: "",
      major: "",
      memo: "",
      active: true,
    });
  }, [open, onBulkProgress]);

  function handleChange(e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement>) {
    const { name, value } = e.target;
    setForm((p) => {
      const next = { ...p, [name]: value };
      if (name === "school") {
        const t = String(value ?? "").trim();
        if (t.endsWith("ê³ ")) next.schoolType = "HIGH";
        else if (t.endsWith("ì¤‘")) next.schoolType = "MIDDLE";
      }
      return next;
    });
  }

  function handlePhoneChange(name: "studentPhone" | "parentPhone", value: string) {
    const raw = parsePhoneInput(value);
    setForm((p) => ({ ...p, [name]: raw }));
  }

  function validate(): string | null {
    // í•„ìˆ˜: ì´ë¦„, ì´ˆê¸°ë¹„ë°€ë²ˆí˜¸, í•™ë¶€ëª¨ ì „í™”ë²ˆí˜¸ (í•™ìƒ ì „í™”ëŠ” ì„ íƒ, ì—†ìœ¼ë©´ ë¶€ëª¨ ì „í™” 8ìë¦¬ë¡œ OMR)
    if (!String(form.name || "").trim()) return "ì´ë¦„ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.";
    if (!String(form.initialPassword || "").trim()) return "ì´ˆê¸° ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.";

    const parent = String(form.parentPhone || "").trim();
    if (!parent) return "í•™ë¶€ëª¨ ì „í™”ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.";
    if (!/^010\d{8}$/.test(parent)) return "í•™ë¶€ëª¨ ì „í™”ë²ˆí˜¸ëŠ” 010XXXXXXXX í˜•ì‹ì´ì–´ì•¼ í•©ë‹ˆë‹¤.";

    const phone = String(form.studentPhone || "").trim();
    if (phone && !/^010\d{8}$/.test(phone)) return "í•™ìƒ ì „í™”ë²ˆí˜¸ëŠ” 010XXXXXXXX í˜•ì‹ì´ì–´ì•¼ í•©ë‹ˆë‹¤.";

    return null;
  }

  async function handleSubmit() {
    if (busy) return;

    const err = validate();
    if (err) return alert(err);

    setBusy(true);
    try {
      await createStudent({ ...form, noPhone: !String(form.studentPhone || "").trim(), sendWelcomeMessage });
      onSuccess();
      onClose();
    } finally {
      setBusy(false);
    }
  }

  async function handleExcelFileSelect(file: File) {
    if (busy) return;
    setBusy(true);
    try {
      const rows = await parseStudentExcel(file);
      if (!rows.length) {
        alert("ë“±ë¡í•  í•™ìƒ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }
      setExcelParsedRows(rows);
    } catch (e: unknown) {
      const msg = e instanceof Error ? e.message : "ì—‘ì…€ íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
      alert(msg);
    } finally {
      setBusy(false);
    }
  }

  async function handleExcelRegister() {
    if (busy || !excelParsedRows?.length) return;
    const pwd = String(excelBulkPassword || "").trim();
    if (!pwd || pwd.length < 4) {
      alert("ì´ˆê¸° ë¹„ë°€ë²ˆí˜¸ë¥¼ 4ì ì´ìƒ ì…ë ¥í•´ ì£¼ì„¸ìš”.");
      return;
    }
    const students = excelParsedRows.map((r) => ({
      name: r.name.trim(),
      phone: r.studentPhone,
      parentPhone: r.parentPhone,
      usesIdentifier: !!r.usesIdentifier,
      gender: r.gender || null,
      schoolType: r.schoolType,
      school: r.school || null,
      grade: r.grade ? Number(r.grade) || null : null,
      schoolClass: r.schoolClass || null,
      major: r.schoolType === "HIGH" ? (r.major || null) : null,
      memo: r.memo || null,
    }));
    setBusy(true);
    const initProg = { current: 0, total: students.length };
    setProgress(initProg);
    onBulkProgress?.(initProg);

    const CHUNK_SIZE = 20; // í•œ ë²ˆì— 20ëª…ì”© ì²˜ë¦¬
    let totalCreated = 0;
    const allFailed: BulkFailedItem[] = [];
    
    try {
      // ì²­í¬ ë‹¨ìœ„ë¡œ ë‚˜ëˆ ì„œ ìš”ì²­
      for (let i = 0; i < students.length; i += CHUNK_SIZE) {
        const chunk = students.slice(i, i + CHUNK_SIZE);
        const prog = { current: i, total: students.length };
        setProgress(prog);
        onBulkProgress?.(prog);
        
        try {
          const result = await bulkCreateStudents(pwd, chunk, sendWelcomeMessage);
          totalCreated += result.created ?? 0;
          
          // ì‹¤íŒ¨ í•­ëª©ì˜ row ë²ˆí˜¸ë¥¼ ì „ì²´ ì¸ë±ìŠ¤ë¡œ ì¡°ì •
          const failedWithStudent: BulkFailedItem[] = (result.failed ?? []).map((f: { row: number; name: string; error: string; conflict_student_id?: number }) => ({
            ...f,
            row: i + f.row, // ì „ì²´ ì¸ë±ìŠ¤ë¡œ ì¡°ì •
            conflict_student_id: f.conflict_student_id ?? null,
            student: chunk[f.row - 1] ?? { name: f.name, phone: "", parentPhone: "" },
          }));
          allFailed.push(...failedWithStudent);
        } catch (chunkError: unknown) {
          // ì²­í¬ ë‹¨ìœ„ ì—ëŸ¬(400 ë“±) ì‹œ ë°±ì—”ë“œ ë©”ì‹œì§€ ì¶”ì¶œ
          let errMsg = "ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
          if (chunkError && typeof chunkError === "object" && "response" in chunkError) {
            const res = (chunkError as { response?: { data?: unknown; status?: number } }).response;
            const data = res?.data;
            if (data && typeof data === "object") {
              const d = data as Record<string, unknown>;
              if (typeof d.detail === "string") errMsg = d.detail;
              else if (d.detail && typeof d.detail === "object") {
                const parts = Object.entries(d.detail as Record<string, unknown>).flatMap(([k, v]) =>
                  Array.isArray(v) ? v.map((x) => `${k}: ${x}`) : [`${k}: ${v}`]
                );
                if (parts.length) errMsg = parts.join(" Â· ");
              } else if (d.students && Array.isArray(d.students)) {
                const first = (d.students as unknown[])[0];
                if (first && typeof first === "object") {
                  const msgs = Object.entries(first as Record<string, unknown>).flatMap(([k, v]) =>
                    Array.isArray(v) ? v.map((x) => `${k}: ${x}`) : []
                  );
                  if (msgs.length) errMsg = msgs.join(" Â· ");
                }
              }
            }
          } else if (chunkError instanceof Error) {
            errMsg = chunkError.message;
          }
          chunk.forEach((s, idx) => {
            allFailed.push({
              row: i + idx + 1,
              name: s.name,
              error: errMsg,
              conflict_student_id: null,
              student: s,
            });
          });
        }
      }
      
      const doneProg = { current: students.length, total: students.length };
      setProgress(doneProg);
      onBulkProgress?.(doneProg);
      setBulkResult({
        created: totalCreated,
        failed: allFailed,
        total: students.length,
        password: pwd,
      });
      setConflictResolutions({});
      setBatchConflictAction(null);
      setExcelParsedRows(null);
      if (totalCreated > 0) onSuccess();
      // ì‹¤íŒ¨ í•­ëª©ì´ ì—†ìœ¼ë©´ ëª¨ë‹¬ ìë™ ë‹«ê¸°
      if (allFailed.length === 0) {
        setTimeout(() => {
          setProgress(null);
          onBulkProgress?.(null);
          onClose();
        }, 500);
      } else {
        setProgress(null);
        onBulkProgress?.(null);
      }
    } catch (e: unknown) {
      let msg = "ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
      if (e && typeof e === "object" && "response" in e) {
        const data = (e as { response?: { data?: unknown } }).response?.data;
        if (data && typeof data === "object") {
          const d = data as Record<string, unknown>;
          if (typeof d.detail === "string") msg = d.detail;
          else if (d.detail && typeof d.detail === "object") {
            const parts = Object.entries(d.detail as Record<string, unknown>).map(
              ([k, v]) => `${k}: ${Array.isArray(v) ? v.join(", ") : v}`
            );
            if (parts.length) msg = parts.join("\n");
          }
        }
      } else if (e instanceof Error) msg = e.message;
      alert(msg);
      setProgress(null);
      onBulkProgress?.(null);
    } finally {
      setBusy(false);
    }
  }

  function updateFailedItem(index: number, field: "phone", value: string) {
    if (!bulkResult) return;
    const next = [...bulkResult.failed];
    next[index] = { ...next[index], student: { ...next[index].student, [field]: value } };
    setBulkResult({ ...bulkResult, failed: next });
  }

  function setConflictResolution(row: number, action: "restore" | "delete") {
    setConflictResolutions((p) => ({ ...p, [row]: action }));
  }

  function applyBatchConflictResolution() {
    if (!batchConflictAction || !bulkResult) return;
    const next: Record<number, "restore" | "delete"> = {};
    for (const item of bulkResult.failed) {
      if (item.conflict_student_id) next[item.row] = batchConflictAction;
    }
    setConflictResolutions(next);
  }

  const conflictedItems = (bulkResult?.failed ?? []).filter((f) => f.conflict_student_id);
  const hasUnresolvedConflicts = conflictedItems.some((f) => !conflictResolutions[f.row]);

  async function handleResolveConflicts() {
    if (!bulkResult || !conflictedItems.length || busy || hasUnresolvedConflicts) return;
    const resolutions = conflictedItems
      .filter((f) => conflictResolutions[f.row])
      .map((f) => ({
        row: f.row,
        student_id: f.conflict_student_id!,
        action: conflictResolutions[f.row] as "restore" | "delete",
        student_data: {
          name: f.student.name,
          phone: String(f.student.phone || "").replace(/\D/g, ""),
          parent_phone: String(f.student.parentPhone || "").replace(/\D/g, ""),
          uses_identifier: false,
          gender: f.student.gender || "",
          school_type: f.student.schoolType || "HIGH",
          school: f.student.school || "",
          high_school_class: f.student.schoolClass || "",
          major: f.student.major || "",
          grade: f.student.grade ?? null,
          memo: f.student.memo || "",
        },
      }));
    if (!resolutions.length) return;
    setBusy(true);
    try {
      const result = await bulkResolveConflicts(bulkResult.password, resolutions, sendWelcomeMessage);
      const stillFailed = (result.failed ?? []).map((f) => {
        const orig = bulkResult.failed.find((x) => x.row === f.row);
        return {
          ...f,
          conflict_student_id: orig?.conflict_student_id,
          student: orig?.student ?? { name: f.name, phone: "", parentPhone: "" },
        };
      });
      const newCreated = (bulkResult.created ?? 0) + (result.created ?? 0) + (result.restored ?? 0);
      setBulkResult({
        created: newCreated,
        failed: stillFailed,
        total: bulkResult.total,
        password: bulkResult.password,
      });
      setConflictResolutions({});
      setBatchConflictAction(null);
      if (result.created > 0 || result.restored) onSuccess();
      if (stillFailed.length === 0) onClose();
    } catch (e: unknown) {
      alert(e instanceof Error ? e.message : "ì¶©ëŒ í•´ê²° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    } finally {
      setBusy(false);
    }
  }

  async function handleRetryFailed() {
    if (!bulkResult || !bulkResult.failed.length || busy) return;
    setBusy(true);
    try {
      const toSend = bulkResult.failed.map((f) => {
        let phone = f.student.phone.replace(/\D/g, "");
        if (phone.length === 8 && /^\d{8}$/.test(phone)) phone = `010${phone}`;
        return {
          name: f.student.name,
          phone,
          parentPhone: f.student.parentPhone.replace(/\D/g, ""),
          gender: f.student.gender,
          schoolType: f.student.schoolType,
          school: f.student.school,
          grade: f.student.grade,
          schoolClass: f.student.schoolClass,
          major: f.student.major,
          memo: f.student.memo,
        };
      });
      const result = await bulkCreateStudents(bulkResult.password, toSend, sendWelcomeMessage);
      const stillFailed: BulkFailedItem[] = (result.failed ?? []).map((f) => {
        const idx = f.row - 1;
        const orig = bulkResult.failed[idx];
        return {
          row: f.row,
          name: f.name,
          error: f.error,
          student: orig?.student ?? { name: f.name, phone: "", parentPhone: "" },
        };
      });
      setBulkResult({
        created: bulkResult.created + result.created,
        failed: stillFailed,
        total: bulkResult.total,
        password: bulkResult.password,
      });
      if (result.created > 0) onSuccess();
      if (stillFailed.length === 0) onClose();
    } finally {
      setBusy(false);
    }
  }

  return (
    <AdminModal open={open} onClose={onClose} type="action" width={MODAL_WIDTH.md}>
      <ModalHeader
        type="action"
        title="í•™ìƒ ë“±ë¡"
        description={activeTab === "single" ? "âŒ˜/Ctrl + Enter ë¡œ ë“±ë¡" : "ì—‘ì…€ íŒŒì¼ë¡œ í•™ìƒì„ ì¼ê´„ ë“±ë¡í•©ë‹ˆë‹¤"}
      />

      <div className="modal-tabs-area">
        <Tabs value={activeTab} items={TAB_ITEMS} onChange={setActiveTab} />
        {progress && activeTab === "excel" && (
          <div className="modal-form-group" style={{ marginTop: "var(--space-3)", padding: "var(--space-3) var(--space-4)" }}>
            <span style={{ fontSize: 13, fontWeight: 600, color: "var(--color-brand-primary)" }}>ì°½ì„ ë‹«ì•„ë„ ì§„í–‰ë©ë‹ˆë‹¤</span>
          </div>
        )}
        <label className="modal-section-label" style={{ display: "flex", alignItems: "center", gap: "var(--space-2)", marginTop: "var(--space-3)", marginBottom: 0, cursor: "pointer" }}>
          <input
            type="checkbox"
            checked={Boolean(sendWelcomeMessage)}
            onChange={(e) => setSendWelcomeMessage(e.target.checked)}
            disabled={busy}
          />
          ë“±ë¡ì™„ë£Œ í›„ í•™ë¶€ëª¨, í•™ìƒì—ê²Œ ê°€ì…ì„±ê³µ ë©”ì„¸ì§€ ì¼ê´„ë°œì†¡
        </label>
      </div>

      <ModalBody key={activeTab}>
        {activeTab === "single" ? (
        <div className="modal-scroll-body modal-scroll-body--compact">
          {/* í•„ìˆ˜ ì…ë ¥ â€” ì„¸ì…˜ ëª¨ë‹¬ê³¼ ë™ì¼ êµ¬ì¡°Â·ì…ì²´ê° */}
          <div className="modal-form-group">
            <span className="modal-section-label">í•„ìˆ˜ ì…ë ¥</span>
            <input
              name="name"
              placeholder="ì´ë¦„"
              value={form.name ?? ""}
              onChange={handleChange}
              className="ds-input"
              data-required="true"
              data-invalid={!String(form.name || "").trim() ? "true" : "false"}
              disabled={busy}
              autoFocus
            />
            <input
              name="initialPassword"
              type="password"
              placeholder="ì´ˆê¸° ë¹„ë°€ë²ˆí˜¸"
              value={form.initialPassword ?? ""}
              onChange={handleChange}
              className="ds-input"
              data-required="true"
              data-invalid={!String(form.initialPassword || "").trim() ? "true" : "false"}
              disabled={busy}
            />
            <input
              placeholder="í•™ë¶€ëª¨ ì „í™” (010-XXXX-XXXX)"
              value={formatPhoneForInput(form.parentPhone ?? "")}
              onChange={(e) => handlePhoneChange("parentPhone", e.target.value)}
              className="ds-input"
              data-required="true"
              data-invalid={!String(form.parentPhone || "").trim() ? "true" : "false"}
              disabled={busy}
              maxLength={13}
              inputMode="numeric"
              pattern="[0-9\-]*"
            />
          </div>

          {/* ì„ íƒ ì…ë ¥ â€” ê°•ì¡°ìƒ‰ ì—†ìŒ, ì…ì²´ê°ë§Œ ìœ ì§€ */}
          <div className="modal-form-group modal-form-group--neutral">
            <span className="modal-section-label">ì„ íƒ ì…ë ¥</span>
            <div className="modal-form-row modal-form-row--1-auto">
              <input
                placeholder="í•™ìƒ ì „í™” (ì—†ìœ¼ë©´ ë¶€ëª¨ ì „í™”ë¡œ OMR)"
                value={formatPhoneForInput(form.studentPhone ?? "")}
                onChange={(e) => handlePhoneChange("studentPhone", e.target.value)}
                className="ds-input"
                disabled={busy}
                maxLength={13}
                inputMode="numeric"
                pattern="[0-9\-]*"
              />
              <div className="modal-actions-inline" style={{ height: 36 }}>
                {[{ key: "M", label: "ë‚¨ì" }, { key: "F", label: "ì—¬ì" }].map((g) => (
                  <button
                    key={g.key}
                    type="button"
                    className={`student-gender-btn student-gender-btn--${g.key === "M" ? "m" : "f"}${form.gender === g.key ? " is-selected" : ""}`}
                    aria-pressed={form.gender === g.key}
                    onClick={() => setForm((p) => ({ ...p, gender: g.key }))}
                    disabled={busy}
                  >
                    {g.label}
                  </button>
                ))}
              </div>
            </div>
            <div className="modal-form-row modal-form-row--1-auto-auto">
              <input
                name="school"
                placeholder="í•™êµëª… (XXê³ Â·XXì¤‘ ì…ë ¥ ì‹œ ìë™ ì„ íƒ)"
                value={form.school ?? ""}
                onChange={handleChange}
                className="ds-input"
                disabled={busy}
              />
              <div className="modal-actions-inline" style={{ height: 36 }}>
                <button
                  type="button"
                  className={`ds-choice-btn ds-choice-btn--primary${form.schoolType === "HIGH" ? " is-selected" : ""}`}
                  aria-pressed={form.schoolType === "HIGH"}
                  onClick={() => setForm((p) => ({ ...p, schoolType: "HIGH" }))}
                  disabled={busy}
                >
                  ê³ ë“±
                </button>
                <button
                  type="button"
                  className={`ds-choice-btn ds-choice-btn--primary${form.schoolType === "MIDDLE" ? " is-selected" : ""}`}
                  aria-pressed={form.schoolType === "MIDDLE"}
                  onClick={() => setForm((p) => ({ ...p, schoolType: "MIDDLE" }))}
                  disabled={busy}
                >
                  ì¤‘ë“±
                </button>
              </div>
              <div className="modal-actions-inline" style={{ height: 36 }}>
                {["1", "2", "3"].map((g) => (
                  <button
                    key={g}
                    type="button"
                    className={`ds-choice-btn ds-choice-btn--primary${form.grade === g ? " is-selected" : ""}`}
                    aria-pressed={form.grade === g}
                    onClick={() => setForm((p) => ({ ...p, grade: g }))}
                    disabled={busy}
                  >
                    {g}í•™ë…„
                  </button>
                ))}
              </div>
            </div>
            <div className="modal-form-row modal-form-row--2">
              <input
                name="schoolClass"
                placeholder="ë°˜"
                value={form.schoolClass ?? ""}
                onChange={handleChange}
                className="ds-input"
                disabled={busy}
              />
              <input
                name="major"
                placeholder="ê³„ì—´(ê³ ë“±ë§Œ)"
                value={form.major ?? ""}
                onChange={handleChange}
                className="ds-input"
                disabled={busy}
              />
            </div>
            <textarea
              name="memo"
              rows={3}
              placeholder="ë©”ëª¨"
              value={form.memo ?? ""}
              onChange={handleChange}
              className="ds-textarea"
              disabled={busy}
            />
          </div>

          <div className="modal-form-row modal-form-row--1-auto">
            <span className="modal-hint modal-hint--block" style={{ marginBottom: 0 }}>
              ë“±ë¡ í›„ ìƒì„¸ì—ì„œ íƒœê·¸/ë©”ëª¨/ìƒíƒœë¥¼ ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            </span>
            <button
              type="button"
              className="ds-status-badge"
              data-status={form.active ? "active" : "inactive"}
              aria-pressed={form.active}
              onClick={() => setForm((p) => ({ ...p, active: !p.active }))}
              disabled={busy}
            >
              {form.active ? "í™œì„±" : "ë¹„í™œì„±"}
            </button>
          </div>
        </div>
        ) : bulkResult ? (
        <div className="modal-scroll-body modal-scroll-body--compact" style={{ display: "flex", flexDirection: "column" }}>
          <div className="modal-section-label" style={{ fontSize: 15, fontWeight: 600, color: "var(--color-text-primary)", marginBottom: "var(--space-2)" }}>
            {bulkResult.created}ëª… ë“±ë¡ ì™„ë£Œ
            {bulkResult.failed.length > 0 && ` Â· ì‹¤íŒ¨ ${bulkResult.failed.length}ê±´`}
          </div>

          {bulkResult.failed.length > 0 && (
            <>
              <div className="modal-form-group modal-form-group--row" style={{ flexDirection: "column", alignItems: "stretch" }}>
                <span className="modal-hint" style={{ lineHeight: 1.5 }}>
                  í•„ìˆ˜: ì´ë¦„, í•™ë¶€ëª¨ ì „í™”. í•™ìƒ ì „í™”ëŠ” ì„ íƒ(ì—†ìœ¼ë©´ í•™ë¶€ëª¨ ì „í™” 8ìë¦¬ë¡œ OMR). ì•„ì´ë”” 6ìë¦¬ ìë™ ë¶€ì—¬.
                  {conflictedItems.length > 0 && (
                    <span className="modal-hint--block">
                      <strong>ì‚­ì œëœ í•™ìƒê³¼ ë²ˆí˜¸ ì¶©ëŒ</strong> ì‹œ ë³µì› ë˜ëŠ” ì‚­ì œ í›„ ì¬ë“±ë¡ì„ ì„ íƒí•˜ì„¸ìš”.
                    </span>
                  )}
                </span>
              </div>

              {conflictedItems.length > 0 && (
                <div className="modal-actions-inline" style={{ gap: "var(--space-3)" }}>
                  <span className="modal-section-label" style={{ marginBottom: 0 }}>ì¼ê´„ ì ìš©:</span>
                  <Button
                    intent={batchConflictAction === "restore" ? "secondary" : "ghost"}
                    size="sm"
                    onClick={() => setBatchConflictAction("restore")}
                  >
                    ëª¨ë‘ ë³µì›
                  </Button>
                  <Button
                    intent={batchConflictAction === "delete" ? "secondary" : "ghost"}
                    size="sm"
                    onClick={() => setBatchConflictAction("delete")}
                  >
                    ëª¨ë‘ ì‚­ì œ í›„ ì¬ë“±ë¡
                  </Button>
                  <Button intent="secondary" size="sm" onClick={applyBatchConflictResolution}>
                    ì ìš©
                  </Button>
                </div>
              )}

              <div style={{ maxHeight: 240, overflowY: "auto", display: "flex", flexDirection: "column", gap: "var(--space-2)" }}>
                {bulkResult.failed.map((item, idx) => (
                  <div key={idx} className="modal-form-group modal-form-group--compact">
                    <div className="modal-section-label" style={{ marginBottom: "var(--space-1)", fontSize: 12 }}>
                      {item.row}í–‰ {item.name} Â· <span style={{ color: "var(--color-status-error)" }}>{item.error}</span>
                    </div>
                    {item.conflict_student_id && (
                      <div className="modal-actions-inline" style={{ marginBottom: "var(--space-2)" }}>
                        <label className="modal-section-label" style={{ display: "flex", alignItems: "center", gap: "var(--space-1)", marginBottom: 0, cursor: "pointer", fontSize: 13 }}>
                          <input
                            type="radio"
                            name={`conflict-${item.row}`}
                            checked={conflictResolutions[item.row] === "restore"}
                            onChange={() => setConflictResolution(item.row, "restore")}
                          />
                          ë³µì›
                        </label>
                        <label className="modal-section-label" style={{ display: "flex", alignItems: "center", gap: "var(--space-1)", marginBottom: 0, cursor: "pointer", fontSize: 13 }}>
                          <input
                            type="radio"
                            name={`conflict-${item.row}`}
                            checked={conflictResolutions[item.row] === "delete"}
                            onChange={() => setConflictResolution(item.row, "delete")}
                          />
                          ì‚­ì œ í›„ ì¬ë“±ë¡
                        </label>
                      </div>
                    )}
                    <div className="modal-form-row modal-form-row--1-auto">
                      <input
                        placeholder="í•™ìƒ ì „í™”(ì„ íƒ) Â· ì—†ìœ¼ë©´ í•™ë¶€ëª¨ ì „í™”ë¡œ OMR"
                        value={
                          (() => {
                            const raw = String(item.student?.phone ?? "").replace(/\D/g, "");
                            if (raw.length === 8) return formatIdentifierForInput(raw);
                            if (raw.length === 11) return formatPhoneForInput(raw);
                            return item.student?.phone ?? "";
                          })()
                        }
                        onChange={(e) => {
                          const raw = e.target.value.replace(/\D/g, "").slice(0, 11);
                          const phone = raw.length === 8 ? `010${raw}` : raw;
                          updateFailedItem(idx, "phone", phone);
                        }}
                        className="ds-input"
                        maxLength={13}
                        inputMode="numeric"
                      />
                    </div>
                  </div>
                ))}
              </div>

              <div className="modal-actions-inline">
                {conflictedItems.length > 0 && (
                  <Button
                    intent="primary"
                    onClick={handleResolveConflicts}
                    disabled={busy || hasUnresolvedConflicts}
                  >
                    {busy ? "ì²˜ë¦¬ ì¤‘â€¦" : "ì¶©ëŒ í•´ê²° í›„ ë“±ë¡"}
                  </Button>
                )}
                <Button intent="primary" onClick={handleRetryFailed} disabled={busy}>
                  {busy ? "ë‹¤ì‹œ ë“±ë¡ ì¤‘â€¦" : "ì‹¤íŒ¨ í•­ëª© ë‹¤ì‹œ ë“±ë¡"}
                </Button>
              </div>
            </>
          )}

          <Button intent="secondary" onClick={() => { setBulkResult(null); onClose(); }}>
            ì™„ë£Œ
          </Button>
        </div>
        ) : (
        <div className="modal-scroll-body modal-scroll-body--compact" style={{ display: "flex", flexDirection: "column" }}>
          <div className="modal-form-row modal-form-row--1-auto" style={{ alignItems: "end" }}>
            <div>
              <label className="modal-section-label">ì´ˆê¸° ë¹„ë°€ë²ˆí˜¸ (ì¼ê´„)</label>
              <input
                type="password"
                placeholder="ëª¨ë“  í•™ìƒì— ì ìš©í•  ì´ˆê¸° ë¹„ë°€ë²ˆí˜¸ (4ì ì´ìƒ)"
                value={excelBulkPassword ?? ""}
                onChange={(e) => setExcelBulkPassword(e.target.value)}
                className="ds-input"
                disabled={busy}
                style={{ width: "100%" }}
              />
            </div>
            <Button intent="secondary" onClick={downloadStudentExcelTemplate} disabled={busy}>
              ì—‘ì…€ ì–‘ì‹ ë‹¤ìš´ë¡œë“œ
            </Button>
          </div>

          <ExcelUploadZone onFileSelect={handleExcelFileSelect} disabled={busy} />

          {excelParsedRows && excelParsedRows.length > 0 && (
            <div className="modal-form-group modal-form-group--row" style={{ justifyContent: "space-between" }}>
              <span className="modal-section-label" style={{ marginBottom: 0 }}>
                {excelParsedRows.length}ëª… ë“±ë¡ ì˜ˆì •
              </span>
              <Button
                intent="ghost"
                size="sm"
                onClick={() => setExcelParsedRows(null)}
                disabled={busy}
              >
                ì·¨ì†Œ
              </Button>
            </div>
          )}
        </div>
        )}
      </ModalBody>

      <ModalFooter
        left={
          <div style={{ display: "flex", flexDirection: "column", gap: 4 }}>
            {progress && (
              <div style={{ display: "flex", alignItems: "center", gap: 12 }}>
                <div style={{ width: 200, height: 6, background: "var(--color-bg-surface-soft)", borderRadius: 3, overflow: "hidden" }}>
                  <div
                    style={{
                      width: `${(progress.current / progress.total) * 100}%`,
                      height: "100%",
                      background: "var(--color-primary)",
                      transition: "width 0.3s ease",
                    }}
                  />
                </div>
                <span style={{ fontSize: 12, fontWeight: 700, color: "var(--color-primary)", minWidth: 60 }}>
                  {Math.round((progress.current / progress.total) * 100)}%
                </span>
                <span style={{ fontSize: 12, fontWeight: 600, color: "var(--color-text-muted)" }}>
                  ({progress.current}/{progress.total}ëª…)
                </span>
              </div>
            )}
            <span className="modal-hint" style={{ marginBottom: 0 }}>
              {activeTab === "single"
                ? "âŒ˜/Ctrl + Enter ë“±ë¡"
                : bulkResult
                ? "ì‹¤íŒ¨ í•­ëª© ìˆ˜ì • í›„ 'ë‹¤ì‹œ ë“±ë¡'"
                : excelParsedRows?.length
                ? "ì´ˆê¸° ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ í›„ ë“±ë¡"
                : "ì—‘ì…€ íŒŒì¼ ì„ íƒ í›„ ë“±ë¡"}
            </span>
          </div>
        }
        right={
          <>
            {progress && activeTab === "excel" ? (
              <Button intent="secondary" onClick={onClose}>
                ë‹«ê¸°
              </Button>
            ) : (
              <Button intent="secondary" onClick={onClose} disabled={busy}>
                ì·¨ì†Œ
              </Button>
            )}
            {activeTab === "single" && (
              <Button intent="primary" onClick={handleSubmit} disabled={busy}>
                {busy ? "ë“±ë¡ ì¤‘â€¦" : "ë“±ë¡"}
              </Button>
            )}
            {activeTab === "excel" && !bulkResult && excelParsedRows && excelParsedRows.length > 0 && (
              <Button intent="primary" onClick={handleExcelRegister} disabled={busy}>
                {busy ? (progress ? `ë“±ë¡ ì¤‘â€¦ ${Math.round((progress.current / progress.total) * 100)}%` : "ë“±ë¡ ì¤‘â€¦") : "ë“±ë¡"}
              </Button>
            )}
          </>
        }
      />
    </AdminModal>
  );
}


==========================================================================================
# FILE: components/StudentFilterModal.tsx
==========================================================================================
// PATH: src/features/students/components/StudentFilterModal.tsx
import { useEffect, useMemo, useState } from "react";
import { AdminModal, ModalBody, ModalFooter, ModalHeader, MODAL_WIDTH } from "@/shared/ui/modal";
import { Button } from "@/shared/ui/ds";

interface Props {
  open: boolean;
  onClose: () => void;
  filters: any;
  onApply: (next: any) => void;
}

function normalize(next: any) {
  Object.keys(next).forEach((k) => {
    const v = next[k];
    if (v === "" || v == null) delete next[k];
  });

  if (typeof next.is_managed === "string") {
    if (next.is_managed === "true") next.is_managed = true;
    else if (next.is_managed === "false") next.is_managed = false;
    else delete next.is_managed;
  }

  if (typeof next.grade === "string" && next.grade.trim()) {
    const n = Number(next.grade);
    if (Number.isFinite(n)) next.grade = n;
    else delete next.grade;
  }

  if (typeof next.school_type === "string" && !next.school_type.trim()) {
    delete next.school_type;
  }

  return next;
}

export default function StudentFilterModal({
  open,
  onClose,
  filters,
  onApply,
}: Props) {
  const [local, setLocal] = useState<any>(filters || {});
  const title = useMemo(() => "ê³ ê¸‰ í•„í„°", []);

  useEffect(() => {
    if (!open) return;
    setLocal(filters || {});
  }, [open, filters]);

  useEffect(() => {
    function onKeyDown(e: KeyboardEvent) {
      if (e.key === "Escape") onClose();
    }
    if (open) window.addEventListener("keydown", onKeyDown);
    return () => window.removeEventListener("keydown", onKeyDown);
  }, [open, onClose]);

  function update(key: string, value: any) {
    setLocal((prev: any) => ({ ...prev, [key]: value }));
  }

  function apply() {
    const next = normalize({ ...local });
    onApply(next);
  }

  function reset() {
    setLocal({});
  }

  return (
    <AdminModal open={open} onClose={onClose} type="action" width={MODAL_WIDTH.md}>
      <ModalHeader
        type="action"
        title={title}
        description="ì¡°ê±´ì— ë§ëŠ” í•™ìƒë§Œ ì¡°íšŒí•©ë‹ˆë‹¤."
      />

      <ModalBody>
        <div className="modal-scroll-body modal-scroll-body--compact">
          <div className="modal-form-row modal-form-row--3">
            <select
              className="ds-select"
              value={local.school_type ?? ""}
              onChange={(e) => update("school_type", e.target.value)}
            >
              <option value="">í•™êµê¸‰ ì „ì²´</option>
              <option value="HIGH">ê³ ë“±</option>
              <option value="MIDDLE">ì¤‘ë“±</option>
            </select>
            <select
              className="ds-select"
              value={local.is_managed ?? ""}
              onChange={(e) => update("is_managed", e.target.value)}
            >
              <option value="">ìƒíƒœ ì „ì²´</option>
              <option value="true">í™œì„±</option>
              <option value="false">ë¹„í™œì„±</option>
            </select>
            <select
              className="ds-select"
              value={local.gender || ""}
              onChange={(e) => update("gender", e.target.value)}
            >
              <option value="">ì„±ë³„ ì „ì²´</option>
              <option value="M">ë‚¨</option>
              <option value="F">ì—¬</option>
            </select>
          </div>
          <div className="modal-form-row modal-form-row--3">
            <input
              className="ds-input"
              placeholder="ì•„ì´ë””"
              value={local.ps_number || ""}
              onChange={(e) => update("ps_number", e.target.value)}
            />
            <input
              className="ds-input"
              placeholder="OMR ì‹ë³„ì (8ìë¦¬)"
              value={local.omr_code || ""}
              onChange={(e) => update("omr_code", e.target.value)}
            />
            <input
              className="ds-input"
              placeholder="ì´ë¦„"
              value={local.name || ""}
              onChange={(e) => update("name", e.target.value)}
            />
          </div>
          <div className="modal-form-row modal-form-row--3">
            <input
              className="ds-input"
              placeholder="ê³„ì—´(major)"
              value={local.major || ""}
              onChange={(e) => update("major", e.target.value)}
            />
            <input
              className="ds-input"
              placeholder="ê³ ë“±í•™êµ"
              value={local.high_school || ""}
              onChange={(e) => update("high_school", e.target.value)}
            />
            <input
              className="ds-input"
              placeholder="ì¤‘í•™êµ"
              value={local.middle_school || ""}
              onChange={(e) => update("middle_school", e.target.value)}
            />
          </div>
          <div className="modal-form-row modal-form-row--1-auto">
            <select
              className="ds-select"
              value={local.grade ?? ""}
              onChange={(e) => update("grade", e.target.value)}
              style={{ maxWidth: "12rem" }}
            >
              <option value="">í•™ë…„ ì „ì²´</option>
              <option value="1">1í•™ë…„</option>
              <option value="2">2í•™ë…„</option>
              <option value="3">3í•™ë…„</option>
            </select>
            <span className="modal-hint" style={{ marginBottom: 0 }}>
              í•„í„°ëŠ” ì„œë²„ ì¡°íšŒì— ë°˜ì˜ë˜ë©°, ë¹ˆ ê°’ì€ ìë™ ì œê±°ë©ë‹ˆë‹¤.
            </span>
          </div>
        </div>
      </ModalBody>

      <ModalFooter
        left={
          <Button intent="ghost" onClick={reset}>
            ì´ˆê¸°í™”
          </Button>
        }
        right={
          <>
            <Button intent="secondary" onClick={onClose}>
              ì·¨ì†Œ
            </Button>
            <Button intent="primary" onClick={apply}>
              ì ìš©
            </Button>
          </>
        }
      />
    </AdminModal>
  );
}


==========================================================================================
# FILE: components/StudentsTable.tsx
==========================================================================================
// PATH: src/features/students/components/StudentsTable.tsx
import { useMemo } from "react";
import { EmptyState } from "@/shared/ui/ds";
import { DomainTable, TABLE_COL } from "@/shared/ui/domain";
import StudentNameWithLectureChip from "@/shared/ui/chips/StudentNameWithLectureChip";
import { formatPhone, formatStudentPhoneDisplay } from "@/shared/utils/formatPhone";

function escapeRegExp(s: string) {
  return s.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
}

function highlight(text: string, keyword: string) {
  if (!keyword) return text;
  const k = keyword.trim();
  if (!k) return text;

  const parts = String(text).split(new RegExp(`(${escapeRegExp(k)})`, "gi"));
  return parts.map((p, i) =>
    p.toLowerCase() === k.toLowerCase() ? (
      <mark
        key={`hl-${i}-${String(p).slice(0, 8)}`}
        className="px-0.5 rounded"
        style={{
          backgroundColor: "var(--state-selected-bg)",
          color: "inherit",
        }}
      >
        {p}
      </mark>
    ) : (
      p
    )
  );
}

export default function StudentsTable({
  data = [],
  search,
  sort,
  onSortChange,
  onRowClick,
  selectedIds = [],
  onSelectionChange,
  isDeletedTab = false,
  onToggleActive,
  togglingId = null,
}: {
  data: any[];
  search: string;
  sort: string;
  onSortChange: (v: string) => void;
  onRowClick: (id: number) => void;
  selectedIds?: number[];
  onSelectionChange?: (ids: number[]) => void;
  isDeletedTab?: boolean;
  /** í•™ìƒ ë„ë©”ì¸ ì˜ˆì™¸: í…Œì´ë¸”ì—ì„œ í™œì„±/ë¹„í™œì„± í´ë¦­ í† ê¸€ */
  onToggleActive?: (id: number, nextActive: boolean) => void;
  togglingId?: number | null;
}) {
  const selectedSet = useMemo(() => new Set(selectedIds), [selectedIds]);
  const allIds = useMemo(() => data.map((s) => s.id), [data]);
  const allSelected = data.length > 0 && allIds.every((id) => selectedSet.has(id));

  function toggleSelect(id: number) {
    if (!onSelectionChange) return;
    if (selectedSet.has(id)) {
      onSelectionChange(selectedIds.filter((x) => x !== id));
    } else {
      onSelectionChange([...selectedIds, id]);
    }
  }

  /** í˜„ì¬ í˜ì´ì§€ ì „ì²´ ì„ íƒ/í•´ì œ â€” ê¸°ì¡´ ì„ íƒ ìœ ì§€, í˜ì´ì§€ ì „í™˜ ì‹œì—ë„ ì„ íƒ ìœ ì§€ */
  function toggleSelectAll() {
    if (!onSelectionChange) return;
    if (allSelected) {
      onSelectionChange(selectedIds.filter((id) => !allIds.includes(id)));
    } else {
      const merged = new Set([...selectedIds, ...allIds]);
      onSelectionChange([...merged]);
    }
  }

  // TABLE_COL SSOT: tableColumnSpec
  const columns = useMemo(
    () => [
      { key: "_checkbox", label: "", w: TABLE_COL.checkbox },
      { key: "name", label: "ì´ë¦„", w: TABLE_COL.name },
      { key: "parentPhone", label: "í•™ë¶€ëª¨ ì „í™”", w: TABLE_COL.phone },
      { key: "studentPhone", label: "í•™ìƒ ì „í™”", w: TABLE_COL.phone },
      { key: "school", label: "í•™êµ", w: TABLE_COL.medium },
      { key: "schoolClass", label: "ë°˜", w: TABLE_COL.short },
      { key: isDeletedTab ? "deletedAt" : "registeredAt", label: isDeletedTab ? "ì‚­ì œì¼" : "ë“±ë¡ì¼", w: TABLE_COL.medium },
      { key: "tags", label: "íƒœê·¸", w: TABLE_COL.tag },
      ...(isDeletedTab ? [] : [{ key: "active", label: "ìƒíƒœ", w: TABLE_COL.status }]),
    ],
    [isDeletedTab]
  );
  const tableWidth = useMemo(
    () => columns.reduce((sum, c) => sum + c.w, 0),
    [columns]
  );

  if (!data.length) {
    return (
      <EmptyState
        scope="panel"
        tone="empty"
        title="í•™ìƒ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤."
        description="ê²€ìƒ‰/í•„í„° ì¡°ê±´ì„ í™•ì¸í•˜ê±°ë‚˜, ìƒˆ í•™ìƒì„ ë“±ë¡í•´ ì£¼ì„¸ìš”."
      />
    );
  }

  function sortHeader(colKey: string, label: string) {
    const isAsc = sort === colKey;
    const isDesc = sort === `-${colKey}`;
    const next = isAsc ? `-${colKey}` : isDesc ? "" : colKey;

    return (
      <th
        key={colKey}
        onClick={() => onSortChange(next)}
        className="cursor-pointer select-none"
        aria-sort={isAsc ? "ascending" : isDesc ? "descending" : "none"}
        scope="col"
      >
        <span className="inline-flex items-center justify-center gap-2">
          {label}
          <span
            aria-hidden
            style={{
              fontSize: 11,
              opacity: isAsc || isDesc ? 1 : 0.35,
              color: "var(--color-primary)",
            }}
          >
            {isAsc ? "â–²" : isDesc ? "â–¼" : "â‡…"}
          </span>
        </span>
      </th>
    );
  }

  return (
    <div style={{ width: "fit-content" }}>
    <DomainTable tableClassName="ds-table--flat ds-table--center" tableStyle={{ tableLayout: "fixed", width: tableWidth }}>
      <colgroup>
        {columns.map((c) => (
          <col key={c.key} style={{ width: c.w }} />
        ))}
      </colgroup>

      <thead>
        <tr>
          {columns.map((c) =>
            c.key === "_checkbox" ? (
              <th key="_checkbox" scope="col" style={{ width: TABLE_COL.checkbox }} className="ds-checkbox-cell" onClick={(e) => e.stopPropagation()}>
                {onSelectionChange ? (
                  <input
                    type="checkbox"
                    checked={allSelected}
                    onChange={toggleSelectAll}
                    aria-label="ì „ì²´ ì„ íƒ"
                    className="cursor-pointer"
                  />
                ) : null}
              </th>
            ) : c.key === "tags" ? (
              <th key="tags" scope="col">
                íƒœê·¸
              </th>
            ) : (
              sortHeader(c.key, c.label)
            )
          )}
        </tr>
      </thead>

      <tbody>
        {data.map((s) => (
            <tr
              key={s.id}
              onClick={() => onRowClick(s.id)}
              tabIndex={0}
              role="button"
              className={`group cursor-pointer focus:outline-none focus-visible:ring-2 focus-visible:ring-[var(--color-border-focus)]/40 ${selectedSet.has(s.id) ? "ds-row-selected" : ""}`}
            >
              {/* ì²´í¬ë°•ìŠ¤ â€” íƒ€ì´íŠ¸, ì¹¸ê³¼ ìœ„ì¹˜ ì¼ì¹˜ */}
              <td onClick={(e) => e.stopPropagation()} style={{ width: TABLE_COL.checkbox }} className="ds-checkbox-cell">
                {onSelectionChange ? (
                  <input
                    type="checkbox"
                    checked={selectedSet.has(s.id)}
                    onChange={() => toggleSelect(s.id)}
                    onClick={(e) => e.stopPropagation()}
                    aria-label={`${s.name} ì„ íƒ`}
                    className="cursor-pointer"
                  />
                ) : null}
              </td>
              {/* ì´ë¦„ â€” ê°•ì˜ë”±ì§€Â·ì•„ë°”íƒ€Â·ì´ë¦„ */}
              <td className="text-[15px] font-bold leading-6 text-[var(--color-text-primary)] truncate">
                <StudentNameWithLectureChip
                  name={s.name ?? "-"}
                  profilePhotoUrl={s.profilePhotoUrl}
                  avatarSize={24}
                    lectures={
                      Array.isArray(s.enrollments) && s.enrollments.length > 0
                        ? s.enrollments.map((en: { id: number; lectureName: string | null; lectureColor?: string | null; lectureChipLabel?: string | null }) => ({
                            lectureName: en.lectureName ?? "??",
                            color: en.lectureColor ?? undefined,
                            chipLabel: en.lectureChipLabel ?? undefined,
                          }))
                        : undefined
                    }
                  chipSize={16}
                  highlight={(text) => highlight(text, search)}
                />
              </td>

              {/* í•™ë¶€ëª¨ ì „í™” */}
              <td className="text-[14px] leading-6 text-[var(--color-text-secondary)] truncate">
                {highlight(formatPhone(s.parentPhone), search)}
              </td>

              {/* í•™ìƒ ì „í™” */}
              <td className="text-[14px] leading-6 text-[var(--color-text-secondary)] truncate">
                {highlight(formatStudentPhoneDisplay(s.studentPhone), search)}
              </td>

              {/* í•™êµ */}
              <td className="text-[14px] leading-6 text-[var(--color-text-secondary)] truncate">
                {s.school || "-"}
              </td>

              {/* ë°˜ */}
              <td className="text-[14px] leading-6 text-[var(--color-text-secondary)] truncate">
                {s.schoolClass || "-"}
              </td>

              {/* ë“±ë¡ì¼ / ì‚­ì œì¼ */}
              <td className="text-[13px] leading-6 font-semibold text-[var(--color-text-muted)] truncate">
                {(isDeletedTab ? s.deletedAt : s.registeredAt)?.slice(0, 10) || "-"}
              </td>

              {/* íƒœê·¸ */}
              <td className="text-[12px] leading-5">
                {Array.isArray(s.tags) && s.tags.length > 0 ? (
                  <span className="flex flex-wrap gap-1 justify-center">
                    {s.tags.slice(0, 3).map((t: { id: number; name: string; color: string }) => (
                      <span
                        key={t.id}
                        className="inline-flex items-center px-1.5 py-0.5 rounded text-[11px] font-semibold truncate max-w-[70px]"
                        style={{
                          backgroundColor: t.color ? `${t.color}22` : "var(--color-bg-surface-soft)",
                          color: t.color || "var(--color-text-secondary)",
                          border: t.color ? `1px solid ${t.color}44` : undefined,
                        }}
                        title={t.name}
                      >
                        {t.name}
                      </span>
                    ))}
                    {s.tags.length > 3 && (
                      <span className="text-[11px] text-[var(--color-text-muted)]">
                        +{s.tags.length - 3}
                      </span>
                    )}
                  </span>
                ) : (
                  <span className="text-[var(--color-text-muted)]">-</span>
                )}
              </td>

              {/* ìƒíƒœ â€” í•™ìƒ ë„ë©”ì¸ ì˜ˆì™¸: í´ë¦­ ì‹œ í† ê¸€(ë²„íŠ¼í˜• ì—°í•œ í†¤ ë±ƒì§€) */}
              {!isDeletedTab && (
                <td onClick={(e) => e.stopPropagation()}>
                  {onToggleActive ? (
                    <button
                      type="button"
                      className="ds-status-badge ds-status-badge--action"
                      data-status={s.active ? "active" : "inactive"}
                      disabled={togglingId === s.id}
                      onClick={() => onToggleActive(s.id, !s.active)}
                      aria-label={s.active ? "ë¹„í™œì„±ìœ¼ë¡œ ë³€ê²½" : "í™œì„±ìœ¼ë¡œ ë³€ê²½"}
                    >
                      {togglingId === s.id ? "â€¦" : s.active ? "í™œì„±" : "ë¹„í™œì„±"}
                    </button>
                  ) : (
                    <span
                      className="ds-status-badge"
                      data-status={s.active ? "active" : "inactive"}
                    >
                      {s.active ? "í™œì„±" : "ë¹„í™œì„±"}
                    </span>
                  )}
                </td>
              )}
            </tr>
          ))}
      </tbody>
    </DomainTable>
    </div>
  );
}


==========================================================================================
# FILE: components/TagCreateModal.tsx
==========================================================================================
// PATH: src/features/students/components/TagCreateModal.tsx
// íƒœê·¸ ìƒì„± ëª¨ë‹¬ â€” ì´ë¦„ + ìƒ‰ìƒ

import { useState, useEffect } from "react";
import { AdminModal, ModalHeader, ModalBody, ModalFooter, MODAL_WIDTH } from "@/shared/ui/modal";
import { Button } from "@/shared/ui/ds";
import { ColorPickerField, getDefaultColorForPicker } from "@/shared/ui/domain";
import { createTag } from "../api/students";

type Props = {
  open: boolean;
  onClose: () => void;
  onSuccess: (tag: { id: number; name: string; color: string }) => void;
  /** ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ìƒ‰ìƒ â€” ê¸°ë³¸ê°’ì´ ì´ë“¤ê³¼ ìµœëŒ€í•œ ì°¨ì´ë‚˜ë„ë¡ ì„ íƒë¨ */
  usedColors?: string[];
};

export default function TagCreateModal({
  open,
  onClose,
  onSuccess,
  usedColors = [],
}: Props) {
  const [name, setName] = useState("");
  const [color, setColor] = useState(() => getDefaultColorForPicker(usedColors));
  const [busy, setBusy] = useState(false);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    if (!open) return;
    setName("");
    setColor(getDefaultColorForPicker(usedColors));
    setBusy(false);
    setError(null);
  }, [open, usedColors]);

  useEffect(() => {
    if (!open) return;
    function onKeyDown(e: KeyboardEvent) {
      if (e.key === "Escape") onClose();
    }
    window.addEventListener("keydown", onKeyDown);
    return () => window.removeEventListener("keydown", onKeyDown);
  }, [open, onClose]);

  async function handleSubmit() {
    const trimmed = name.trim();
    if (!trimmed) {
      setError("íƒœê·¸ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.");
      return;
    }
    setError(null);
    setBusy(true);
    try {
      const tag = await createTag(trimmed, color);
      onSuccess(tag);
      onClose();
    } catch (err: any) {
      const msg =
        err?.response?.data?.name?.[0] ||
        err?.response?.data?.detail ||
        "íƒœê·¸ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.";
      setError(typeof msg === "string" ? msg : "íƒœê·¸ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
    } finally {
      setBusy(false);
    }
  }

  return (
    <AdminModal open={open} onClose={onClose} type="action" width={MODAL_WIDTH.sm}>
      <ModalHeader
        title="íƒœê·¸ ìƒì„±"
        description="ì´ë¦„ê³¼ ìƒ‰ìƒì„ ì •í•˜ë©´ ê¼¬ë¦¬í‘œì²˜ëŸ¼ í•™ìƒì— ë¶™ìŠµë‹ˆë‹¤."
      />
      <ModalBody>
        <div className="modal-scroll-body modal-scroll-body--compact" style={{ display: "flex", flexDirection: "column" }}>
          <div className="modal-form-group modal-form-group--compact">
            <label className="modal-section-label">íƒœê·¸ ì´ë¦„</label>
            <input
              type="text"
              className="ds-input w-full"
              placeholder="ì˜ˆ: VIP, ì¬ìˆ˜ìƒ, ìˆ˜í•™ë°˜"
              value={name}
              onChange={(e) => {
                setName(e.target.value);
                setError(null);
              }}
              maxLength={50}
              style={{ fontSize: 14 }}
              autoFocus
            />
            {error && (
              <div className="modal-hint" style={{ marginTop: "var(--space-2)", color: "var(--color-error)" }}>
                {error}
              </div>
            )}
          </div>
          <ColorPickerField label="ìƒ‰ìƒ" value={color} onChange={setColor} disabled={busy} />
        </div>
      </ModalBody>
      <ModalFooter
        right={
          <>
            <Button intent="ghost" size="sm" onClick={onClose}>
              ì·¨ì†Œ
            </Button>
            <Button
              intent="primary"
              size="sm"
              onClick={handleSubmit}
              disabled={busy || !name.trim()}
            >
              {busy ? "ìƒì„± ì¤‘â€¦" : "ìƒì„± í›„ ë¶™ì´ê¸°"}
            </Button>
          </>
        }
      />
    </AdminModal>
  );
}


==========================================================================================
# FILE: excel/studentExcel.ts
==========================================================================================
// PATH: src/features/students/excel/studentExcel.ts
// ì—‘ì…€ íŒŒì‹±Â·ì–‘ì‹ ë‹¨ì¼ì§„ì‹¤ (SSOT) â€” í•™ìƒ ì¼ê´„ ë“±ë¡ + ê°•ì˜ ìˆ˜ê°•ìƒ ì—‘ì…€ ì—…ë¡œë“œ. @see docs/DESIGN_SSOT.md Â§8

import * as XLSX from "xlsx";

/** ì—‘ì…€ ì–‘ì‹ ì»¬ëŸ¼ â€” êµ¬ë¶„(ì˜ˆì‹œì—¬ë¶€), í•„ìˆ˜ ìš°ì„ , ì„ íƒì˜µì…˜ ë’¤ë¡œ */
export const EXCEL_HEADERS = [
  { key: "remark", label: "êµ¬ë¶„", required: false },
  { key: "name", label: "ì´ë¦„", required: true },
  { key: "parentPhone", label: "í•™ë¶€ëª¨ì „í™”ë²ˆí˜¸", required: true },
  { key: "studentPhone", label: "í•™ìƒì „í™”ë²ˆí˜¸", required: false },
  { key: "gender", label: "ì„±ë³„", required: false },
  { key: "schoolType", label: "í•™êµìœ í˜•", required: false },
  { key: "school", label: "í•™êµ", required: false },
  { key: "grade", label: "í•™ë…„", required: false },
  { key: "schoolClass", label: "ë°˜", required: false },
  { key: "major", label: "ê³„ì—´", required: false },
  { key: "memo", label: "ë©”ëª¨", required: false },
] as const;

export type ExcelRowKey = Exclude<(typeof EXCEL_HEADERS)[number]["key"], "remark">;

export interface ParsedStudentRow {
  name: string;
  gender: string;
  studentPhone: string;
  parentPhone: string;
  /** í•™ìƒ ì „í™”ê°€ ì—†ì–´ ì‹ë³„ì(010+8ìë¦¬)ë¡œ ëŒ€ì²´í•œ ê²½ìš° true */
  usesIdentifier?: boolean;
  schoolType: "HIGH" | "MIDDLE";
  school: string;
  grade: string;
  schoolClass: string;
  major: string;
  memo: string;
}

/** ì „í™”ë²ˆí˜¸ì—ì„œ ìˆ«ìë§Œ ì¶”ì¶œ (01012345678) */
function toRawPhone(v: unknown): string {
  const s = String(v ?? "").replace(/\D/g, "");
  return s;
}

/**
 * í•™ì›ë³„ ì–‘ì‹ ëŒ€ì‘ â€” í—¤ë” ë³„ì¹­ ë§¤í•‘
 * ê° í•„ë“œì— ë§¤ì¹­ ê°€ëŠ¥í•œ ëŒ€ì²´ ë¼ë²¨ ëª©ë¡
 */
const HEADER_ALIASES: Record<string, readonly string[]> = {
  remark: ["êµ¬ë¶„", "ì²´í¬"],
  name: ["ì´ë¦„", "ì„±ëª…", "í•™ìƒëª…"],
  studentPhone: ["í•™ìƒì „í™”ë²ˆí˜¸", "í•™ìƒí•¸ë“œí°", "í•™ìƒ ì „í™”ë²ˆí˜¸", "í•™ìƒ ì „í™”", "í•™ìƒì—°ë½ì²˜"],
  parentPhone: ["í•™ë¶€ëª¨ì „í™”ë²ˆí˜¸", "ë¶€ëª¨í•¸ë“œí°", "ë¶€ëª¨ ì „í™”", "í•™ë¶€ëª¨ ì „í™”", "ë³´í˜¸ì ì „í™”", "ë³´í˜¸ìì „í™”"],
  gender: ["ì„±ë³„"],
  schoolType: ["í•™êµìœ í˜•"],
  school: ["í•™êµ", "í•™êµ(í•™ë…„)", "í•™êµëª…"], // í•™êµ(í•™ë…„) = í•™êµ+í•™ë…„ í•©ì³ì§„ ì»¬ëŸ¼
  grade: ["í•™ë…„"],
  schoolClass: ["ë°˜"],
  major: ["ê³„ì—´"],
  memo: ["ë©”ëª¨"],
  /** ì—‘ì…€ ë‚´ ê°•ì˜ëª… â€” ê°•ì˜ ì¼ì¹˜ í™•ì¸ìš©(ì„ íƒ) */
  lectureName: ["ê°•ì˜ëª…", "ê°•ì˜", "ê³¼ëª©", "ìˆ˜ì—…ëª…"],
};

function normalizeHeader(s: string): string {
  return String(s ?? "").trim().replace(/\s/g, "");
}

/** í—¤ë” ë¼ë²¨ì´ íŠ¹ì • í•„ë“œì— ë§¤ì¹­ë˜ëŠ”ì§€ í™•ì¸ */
function headerMatches(label: string, key: string): boolean {
  const normalized = normalizeHeader(label);
  const aliases = HEADER_ALIASES[key];
  if (!aliases) return false;
  const labels = EXCEL_HEADERS.filter((h) => h.key === key).map((h) => h.label);
  const allLabels = [...new Set([...aliases, ...labels])];
  return allLabels.some((a) => normalizeHeader(a) === normalized);
}

/** í—¤ë” ì¸ë±ìŠ¤ ë§¤í•‘ (ì²« í–‰ ê¸°ì¤€) â€” ë³„ì¹­ í¬í•¨ */
function buildHeaderMap(headers: string[]): Record<string, number> {
  const map: Record<string, number> = {};
  headers.forEach((h, i) => {
    const label = String(h ?? "").trim();
    if (!label) return;
    for (const key of Object.keys(HEADER_ALIASES) as (keyof typeof HEADER_ALIASES)[]) {
      if (headerMatches(label, key) && map[key] === undefined) {
        map[key] = i;
        break;
      }
    }
  });
  return map;
}

/** ì…€ ê°’ â†’ ë¬¸ìì—´ */
function cellStr(map: Record<string, number>, row: unknown[], key: ExcelRowKey): string {
  const i = map[key];
  if (i == null) return "";
  const v = row[i];
  return String(v ?? "").trim();
}

/** í—¤ë”ì—ë§Œ ìˆëŠ” í‚¤(ì˜ˆ: lectureName)ìš© ì…€ ê°’ */
function cellStrOptional(map: Record<string, number>, row: unknown[], key: string): string {
  const i = map[key];
  if (i == null) return "";
  const v = (row as unknown[])[i];
  return String(v ?? "").trim();
}

/**
 * "í•™êµ(í•™ë…„)" í˜•ì‹ íŒŒì‹± â€” ì˜ˆ: ìˆ™ëª…ì—¬ê³ (ï¼), íœ˜ë¬¸ì¤‘(3)
 * ì „ê° ìˆ«ì ï¼â†’0 ë³€í™˜, í•™êµëª…ê³¼ í•™ë…„ ë¶„ë¦¬
 */
function parseSchoolGrade(value: string): { school: string; grade: string } {
  const s = String(value ?? "").trim();
  if (!s) return { school: "", grade: "" };
  const m = s.match(/^(.+?)\(([ï¼-ï¼™0-9]+)\)\s*$/);
  if (!m) return { school: s, grade: "" };
  const school = m[1].trim();
  const gradeFullwidth = m[2].replace(/[ï¼-ï¼™]/g, (c) => String.fromCharCode(c.charCodeAt(0) - 0xfee0));
  const grade = gradeFullwidth.replace(/\D/g, "") || "";
  return { school, grade };
}

/** í•™êµëª…ì—ì„œ í•™êµìœ í˜• ì¶”ë¡  (ì—¬ê³ /ë¶€ê³ /ê³ â†’HIGH, ì¤‘â†’MIDDLE) */
function inferSchoolType(school: string): "HIGH" | "MIDDLE" {
  const s = school.trim();
  if (/(ì¤‘í•™êµ|ì¤‘ë“±|ì¤‘\b)/.test(s)) return "MIDDLE";
  if (/(ì—¬ê³ |ë¶€ê³ |ê³ ë“±|ê³ ë“±í•™êµ)/.test(s)) return "HIGH";
  return "HIGH";
}

/**
 * ì—‘ì…€ ì–‘ì‹ ë‹¤ìš´ë¡œë“œ â€” ìƒë‹¨ ì•ˆë‚´ë¬¸, í—¤ë”, ì˜ˆì‹œ í–‰ (xlsx íŒ¨í‚¤ì§€ë¡œ ë™ì‘ ë³´ì¥)
 */
export function downloadStudentExcelTemplate() {
  const wb = XLSX.utils.book_new();
  const headers = EXCEL_HEADERS.map((h) => h.label);
  const exampleRow1 = [
    "ì˜ˆì‹œ(ë“±ë¡ì•ˆë¨)",
    "í™ê¸¸ë™",
    "01087654321",
    "01012345678",
    "M",
    "HIGH",
    "OOê³ ë“±í•™êµ",
    "1",
    "1",
    "ì¸ë¬¸ê³„",
    "",
  ];
  const exampleRow2 = [
    "ì˜ˆì‹œ(ë“±ë¡ì•ˆë¨)",
    "ê¹€ì˜í¬",
    "01011112222",
    "01098765432",
    "F",
    "MIDDLE",
    "OOì¤‘í•™êµ",
    "2",
    "3",
    "",
    "",
  ];

  const instructionRow1 = [
    "â—† í•„ìˆ˜ ì…ë ¥: ì´ë¦„, í•™ë¶€ëª¨ì „í™”ë²ˆí˜¸. í•™ìƒì „í™”ë²ˆí˜¸ëŠ” ì„ íƒ(ë¹„ì›Œë‘ë©´ í•™ë¶€ëª¨ ì „í™” ë’¤ 8ìë¦¬ë¡œ OMR ì‹ë³„). ì•„ì´ë””ëŠ” 6ìë¦¬ ìˆ«ìë¡œ ìë™ ë¶€ì—¬ë©ë‹ˆë‹¤.",
  ];
  const instructionRow2 = [
    "â—† ì–‘ì‹ ê·œì¹™: í•™ë¶€ëª¨ì „í™”ë²ˆí˜¸Â·í•™ìƒì „í™”ë²ˆí˜¸ 010XXXXXXXX 11ìë¦¬, ì„±ë³„(M ë˜ëŠ” F), í•™êµìœ í˜•(HIGH ë˜ëŠ” MIDDLE). í•™êµ ë¹„ìš°ë©´ ë¹„ì›€, XXì¤‘/XXê³  ì ìœ¼ë©´ ìë™ ë°˜ì˜.",
  ];
  const instructionRow3 = [
    "â—† 7~8í–‰ì€ ì˜ˆì‹œì…ë‹ˆë‹¤. 9í–‰ë¶€í„° í•™ìƒ ì •ë³´ë¥¼ ì‘ì„±í•˜ì„¸ìš”.",
  ];
  const emptyRow: string[] = [];

  const data = [
    instructionRow1,
    instructionRow2,
    instructionRow3,
    emptyRow,
    headers,
    exampleRow1,
    exampleRow2,
  ];
  const sheet = XLSX.utils.aoa_to_sheet(data);
  sheet["!cols"] = headers.map((_, i) => ({ wch: i === 0 ? 22 : i === 1 ? 12 : 14 }));
  XLSX.utils.book_append_sheet(wb, sheet, "í•™ìƒëª©ë¡");
  XLSX.writeFile(wb, "í•™ìƒ_ì¼ê´„ë“±ë¡_ì–‘ì‹.xlsx");
}

/** parseStudentExcel ë°˜í™˜ íƒ€ì… â€” ê°•ì˜ëª…ì€ ì—‘ì…€ ë‚´ ì»¬ëŸ¼/ì²« í–‰ì—ì„œ ì¶”ì¶œ(ì„ íƒ) */
export interface ParseStudentExcelResult {
  rows: ParsedStudentRow[];
  /** ì—‘ì…€ì— ì íŒ ê°•ì˜ëª…(ê°•ì˜ ì¼ì¹˜ í™•ì¸ìš©). ì—†ìœ¼ë©´ undefined */
  lectureNameFromExcel?: string;
}

/**
 * ì—‘ì…€ íŒŒì¼ íŒŒì‹± â†’ í•™ìƒ í–‰ + ì—‘ì…€ ê°•ì˜ëª…(ìˆì„ ê²½ìš°)
 */
export function parseStudentExcel(file: File): Promise<ParseStudentExcelResult> {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const data = e.target?.result;
        if (!data) {
          reject(new Error("íŒŒì¼ì„ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."));
          return;
        }
        const wb = XLSX.read(data, { type: "binary" });
        const firstSheet = wb.Sheets[wb.SheetNames[0]];
        if (!firstSheet) {
          reject(new Error("ì‹œíŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤."));
          return;
        }
        const rows = XLSX.utils.sheet_to_json<unknown[]>(firstSheet, { header: 1 });
        if (!rows.length) {
          reject(new Error("ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤."));
          return;
        }
        // í—¤ë” í–‰ ì°¾ê¸° â€” ì´ë¦„ + (í•™ìƒì „í™” ë˜ëŠ” í•™ë¶€ëª¨ì „í™”) í¬í•¨ëœ ì²« í–‰
        const hasName = (r: unknown[]) =>
          (r || []).some((c) => headerMatches(String(c ?? ""), "name"));
        const hasPhone = (r: unknown[]) =>
          (r || []).some(
            (c) => headerMatches(String(c ?? ""), "studentPhone") || headerMatches(String(c ?? ""), "parentPhone")
          );
        let headerRowIndex = -1;
        for (let i = 0; i < rows.length; i++) {
          const row = rows[i] as unknown[];
          if (hasName(row) && hasPhone(row)) {
            headerRowIndex = i;
            break;
          }
        }
        if (headerRowIndex < 0) {
          reject(new Error("ì–‘ì‹ì´ ë§ì§€ ì•ŠìŠµë‹ˆë‹¤. ì´ë¦„Â·ì „í™”ë²ˆí˜¸ ì»¬ëŸ¼ì´ ìˆëŠ” í–‰ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."));
          return;
        }
        const headerRow = rows[headerRowIndex] as string[];
        const map = buildHeaderMap(headerRow);

        // ì—‘ì…€ ê°•ì˜ëª…: (1) í—¤ë” ìœ„ í–‰ì—ì„œ "ê°•ì˜ëª…"/"ê°•ì˜" ë¼ë²¨ ì˜† ì…€ (2) ê°•ì˜ëª… ì»¬ëŸ¼ì˜ ì²« ê°’
        let lectureNameFromExcel: string | undefined;
        for (let r = 0; r < headerRowIndex; r++) {
          const row = rows[r] as unknown[];
          const arr = row ?? [];
          for (let c = 0; c < arr.length - 1; c++) {
            const label = String(arr[c] ?? "").trim();
            const next = String(arr[c + 1] ?? "").trim();
            if (
              (normalizeHeader(label) === "ê°•ì˜ëª…" || normalizeHeader(label) === "ê°•ì˜") &&
              next
            ) {
              lectureNameFromExcel = next;
              break;
            }
          }
          if (lectureNameFromExcel) break;
        }

        const result: ParsedStudentRow[] = [];
        const remarkVal = (m: Record<string, number>, row: unknown[]) => {
          const i = m["remark"];
          if (i == null || typeof i !== "number") return "";
          return String((row as unknown[])[i] ?? "").trim();
        };
        for (let r = headerRowIndex + 1; r < rows.length; r++) {
          const row = rows[r] as unknown[];
          if (/ì˜ˆì‹œ/.test(remarkVal(map, row))) continue; // ì˜ˆì‹œ í–‰ ìŠ¤í‚µ
          if (!lectureNameFromExcel && map["lectureName"] != null) {
            const v = cellStrOptional(map, row, "lectureName");
            if (v) lectureNameFromExcel = v;
          }
          const name = cellStr(map, row, "name");
          const rawStudent = toRawPhone(cellStr(map, row, "studentPhone"));
          let studentPhone = rawStudent;
          let parentPhone = toRawPhone(cellStr(map, row, "parentPhone"));
          let usesIdentifier = false;

          // 8ìë¦¬ ìˆ«ìë§Œ ìˆìœ¼ë©´ ì‹ë³„ì(010+8ìë¦¬)ë¡œ í•´ì„
          if (rawStudent.length === 8 && /^\d{8}$/.test(rawStudent)) {
            studentPhone = `010${rawStudent}`;
            usesIdentifier = true;
          }
          // í•™ìƒ ì „í™” ì—†ì„ ë•Œ: í•™ë¶€ëª¨ ì „í™” 8ìë¦¬ë¡œ OMR ì‹ë³„ (ë°±ì—”ë“œì—ì„œ ì²˜ë¦¬)
          else if (!studentPhone || studentPhone.length !== 11 || !studentPhone.startsWith("010")) {
            if (!parentPhone || parentPhone.length !== 11 || !parentPhone.startsWith("010")) continue; // í•™ë¶€ëª¨ë„ ì—†ìœ¼ë©´ ìŠ¤í‚µ
            studentPhone = "";
            usesIdentifier = true;
          }
          if (!parentPhone || parentPhone.length !== 11 || !parentPhone.startsWith("010")) parentPhone = studentPhone;
          if (!name && !studentPhone) continue; // ë¹ˆ í–‰ ìŠ¤í‚µ

          const schoolCell = cellStr(map, row, "school");
          const gradeCell = cellStr(map, row, "grade");
          const { school: parsedSchool, grade: parsedGrade } = parseSchoolGrade(schoolCell);
          const school = parsedSchool || schoolCell; // í•™êµ(í•™ë…„) íŒŒì‹± ê²°ê³¼ ë˜ëŠ” ì›ë³¸
          const grade = parsedGrade || gradeCell;
          const schoolTypeRaw = cellStr(map, row, "schoolType").toUpperCase();
          const schoolType =
            schoolTypeRaw === "MIDDLE" ? "MIDDLE" : school ? inferSchoolType(school) : "HIGH";

          result.push({
            name,
            gender: cellStr(map, row, "gender").toUpperCase().slice(0, 1) || "",
            studentPhone,
            parentPhone,
            usesIdentifier,
            schoolType,
            school,
            grade,
            schoolClass: cellStr(map, row, "schoolClass"),
            major: cellStr(map, row, "major"),
            memo: cellStr(map, row, "memo"),
          });
        }
        resolve({ rows: result, lectureNameFromExcel: lectureNameFromExcel || undefined });
      } catch (err) {
        reject(err instanceof Error ? err : new Error("íŒŒì¼ íŒŒì‹± ì‹¤íŒ¨"));
      }
    };
    reader.onerror = () => reject(new Error("íŒŒì¼ ì½ê¸° ì‹¤íŒ¨"));
    reader.readAsBinaryString(file);
  });
}

// ========== ì°¨ì‹œ ìˆ˜ê°•ìƒ ì—‘ì…€ (ì´ë¦„Â·ì „í™” ë§¤ì¹­ + Nì°¨ì‹œ ì¶œê²° ì»¬ëŸ¼) ==========

/** ì°¨ì‹œ ìˆ˜ê°•ìƒ ì—‘ì…€ í•œ í–‰ â€” ì´ë¦„Â·í•™ë¶€ëª¨ì „í™”ë¡œ ë§¤ì¹­, ì„ íƒ ì°¨ì‹œ ì¶œê²° ê°’ */
export interface SessionEnrollParsedRow {
  name: string;
  parentPhone: string;
  /** ì°¨ì‹œ order â†’ ì…€ ê°’ (ì¶œ, ì˜ìƒ, ê²° ë“±) */
  sessionAttendance: Record<number, string>;
}

/** í—¤ë”ì—ì„œ "Nì°¨ì‹œ" ì»¬ëŸ¼ ì¸ë±ìŠ¤ â†’ order ë§¤í•‘ (1ì°¨ì‹œâ†’1, 2ì°¨ì‹œâ†’2, â€¦) */
function buildSessionColumnMap(headerRow: string[]): Record<number, number> {
  const map: Record<number, number> = {};
  headerRow.forEach((label, i) => {
    const s = String(label ?? "").trim();
    const m = s.match(/^ì œ?\s*(\d+)\s*ì°¨ì‹œ$/) || s.match(/^(\d+)\s*ì°¨ì‹œ$/);
    if (m) {
      const order = parseInt(m[1], 10);
      if (Number.isFinite(order)) map[order] = i;
    }
  });
  return map;
}

/** ì¶œê²° ì…€ ê°’ â†’ API status (ì¶œ/ì¶œì„/í˜„ì¥â†’PRESENT, ì˜ìƒ/ì˜¨ë¼ì¸â†’ONLINE ë“±) */
export function mapAttendanceCellToStatus(cell: string): string | null {
  const s = String(cell ?? "").trim();
  if (!s) return null;
  const n = s.replace(/\s/g, "");
  if (/^(ì¶œ|ì¶œì„|í˜„ì¥|O|â—‹|ã…‡)$/i.test(n)) return "PRESENT";
  if (/^(ì˜ìƒ|ì˜¨ë¼ì¸|VOD|V)$/i.test(n)) return "ONLINE";
  if (/^(ê²°|ê²°ì„|X|Ã—|ã„´)$/i.test(n)) return "ABSENT";
  if (/^(ì§€ê°|L)$/i.test(n)) return "LATE";
  if (/^(ë³´ê°•|B)$/i.test(n)) return "SUPPLEMENT";
  if (/^(ì¡°í‡´|E)$/i.test(n)) return "EARLY_LEAVE";
  if (/^(ì¶œíŠ€|R)$/i.test(n)) return "RUNAWAY";
  if (/^(ìë£Œ|M)$/i.test(n)) return "MATERIAL";
  if (/^(ë¶€ì¬|I)$/i.test(n)) return "INACTIVE";
  if (/^(íƒˆí‡´|S)$/i.test(n)) return "SECESSION";
  return null;
}

/**
 * ì°¨ì‹œ ìˆ˜ê°•ìƒ ì—‘ì…€ íŒŒì‹± â€” í•™ìƒ ë„ë©”ì¸ ì—‘ì…€ê³¼ ë™ì¼í•˜ê²Œ ì´ë¦„Â·í•™ë¶€ëª¨ì „í™” ì»¬ëŸ¼ ì°¾ê³ ,
 * ì¶”ê°€ë¡œ "Nì°¨ì‹œ" ì»¬ëŸ¼ì—ì„œ ì¶œê²° ê°’ ìˆ˜ì§‘. ì–‘ì‹ì´ ë‹¬ë¼ë„ ì´ë¦„+ì „í™” ìˆìœ¼ë©´ ì²˜ë¦¬.
 */
export function parseSessionEnrollExcel(file: File): Promise<SessionEnrollParsedRow[]> {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const data = e.target?.result;
        if (!data) {
          reject(new Error("íŒŒì¼ì„ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."));
          return;
        }
        const wb = XLSX.read(data, { type: "binary" });
        const firstSheet = wb.Sheets[wb.SheetNames[0]];
        if (!firstSheet) {
          reject(new Error("ì‹œíŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤."));
          return;
        }
        const rows = XLSX.utils.sheet_to_json<unknown[]>(firstSheet, { header: 1 });
        if (!rows.length) {
          reject(new Error("ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤."));
          return;
        }
        const hasName = (r: unknown[]) =>
          (r || []).some((c) => headerMatches(String(c ?? ""), "name"));
        const hasPhone = (r: unknown[]) =>
          (r || []).some(
            (c) =>
              headerMatches(String(c ?? ""), "studentPhone") ||
              headerMatches(String(c ?? ""), "parentPhone")
          );
        let headerRowIndex = -1;
        for (let i = 0; i < rows.length; i++) {
          const row = rows[i] as unknown[];
          if (hasName(row) && hasPhone(row)) {
            headerRowIndex = i;
            break;
          }
        }
        if (headerRowIndex < 0) {
          reject(new Error("ì–‘ì‹ì´ ë§ì§€ ì•ŠìŠµë‹ˆë‹¤. ì´ë¦„Â·ì „í™”ë²ˆí˜¸ ì»¬ëŸ¼ì´ ìˆëŠ” í–‰ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."));
          return;
        }
        const headerRow = rows[headerRowIndex] as string[];
        const map = buildHeaderMap(headerRow);
        const sessionColMap = buildSessionColumnMap(headerRow);
        const result: SessionEnrollParsedRow[] = [];
        const remarkVal = (m: Record<string, number>, row: unknown[]) => {
          const i = m["remark"];
          if (i == null || typeof i !== "number") return "";
          return String((row as unknown[])[i] ?? "").trim();
        };
        for (let r = headerRowIndex + 1; r < rows.length; r++) {
          const row = rows[r] as unknown[];
          if (/ì˜ˆì‹œ/.test(remarkVal(map, row))) continue;
          const name = cellStr(map, row, "name");
          const parentPhone = toRawPhone(cellStr(map, row, "parentPhone"));
          if (!parentPhone || parentPhone.length !== 11 || !parentPhone.startsWith("010")) {
            if (!name) continue;
          }
          if (!name && !parentPhone) continue;
          const sessionAttendance: Record<number, string> = {};
          for (const [orderStr, colIndex] of Object.entries(sessionColMap)) {
            const order = parseInt(orderStr, 10);
            const v = row[colIndex];
            const cell = String(v ?? "").trim();
            if (cell) sessionAttendance[order] = cell;
          }
          result.push({
            name: name.trim(),
            parentPhone: parentPhone || "",
            sessionAttendance,
          });
        }
        resolve(result);
      } catch (err) {
        reject(err instanceof Error ? err : new Error("íŒŒì¼ íŒŒì‹± ì‹¤íŒ¨"));
      }
    };
    reader.onerror = () => reject(new Error("íŒŒì¼ ì½ê¸° ì‹¤íŒ¨"));
    reader.readAsBinaryString(file);
  });
}


==========================================================================================
# FILE: hooks/useStudentsQuery.ts
==========================================================================================
// PATH: src/features/students/hooks/useStudentsQuery.ts
import { useQuery } from "@tanstack/react-query";
import { fetchStudents } from "../api/students";

function compare(a: any, b: any, key: string) {
  const av = a[key];
  const bv = b[key];

  if (av == null && bv == null) return 0;
  if (av == null) return -1;
  if (bv == null) return 1;

  if (key === "registeredAt") {
    const at = new Date(av || "").getTime();
    const bt = new Date(bv || "").getTime();
    return at - bt;
  }

  if (typeof av === "boolean" && typeof bv === "boolean") {
    return Number(av) - Number(bv);
  }

  if (typeof av === "number" && typeof bv === "number") {
    return av - bv;
  }

  return String(av).localeCompare(String(bv), "ko");
}

const PAGE_SIZE = 50;

export function useStudentsQuery(
  search: string,
  filters: any,
  sort: string,
  page: number = 1,
  deleted: boolean = false
) {
  return useQuery({
    queryKey: ["students", search, filters, sort, page, deleted],
    queryFn: async () => {
      const { data, count, pageSize } = await fetchStudents(search, filters, sort, page, deleted);

      if (!sort) return { data, count, pageSize: pageSize ?? PAGE_SIZE };

      const isDesc = sort.startsWith("-");
      const key = isDesc ? sort.slice(1) : sort;

      const sorted = [...data].sort((a, b) => compare(a, b, key));
      const sortedData = isDesc ? sorted.reverse() : sorted;
      return { data: sortedData, count, pageSize: pageSize ?? PAGE_SIZE };
    },
    staleTime: 1000 * 5,
  });
}


==========================================================================================
# FILE: inventory/r2InventoryPath.ts
==========================================================================================
/**
 * R2 ì¸ë²¤í† ë¦¬ ì €ì¥ ê²½ë¡œÂ·íŒŒì¼ëª… SSOT
 * tenants / {tenant_id} / {student_ps} / inventory / {í´ë”íŠ¸ë¦¬} / {íŒŒì¼ëª…}
 *
 * - DB ë©”íƒ€ë°ì´í„°ëŠ” R2 ì—…ë¡œë“œ ì„±ê³µ í›„ì—ë§Œ ìƒì„±. R2 ì‹¤íŒ¨ ì‹œ ë¡¤ë°±/ì—ëŸ¬ ë°˜í™˜.
 * - íŒŒì¼ëª… ì¶©ëŒ ë°©ì§€: ì›ë³¸ëª… ë’¤ì— íƒ€ì„ìŠ¤íƒ¬í”„(ë˜ëŠ” ì§§ì€ í•´ì‹œ) ë¶€ì—¬.
 * - í´ë” ì‚­ì œ: ë¹„ì–´ìˆì§€ ì•Šì€ í´ë”ëŠ” ì‚­ì œ ë¶ˆê°€(ì•ˆì „ì¥ì¹˜). ë¨¼ì € í•˜ìœ„ë¥¼ ë¹„ìš´ ë’¤ ì‚­ì œ.
 */

/**
 * R2 ê°ì²´ í‚¤ ìƒì„±.
 * @param tenantId - íƒœë„ŒíŠ¸ ID
 * @param studentPs - í•™ìƒ PS ë²ˆí˜¸
 * @param folderPath - ì¸ë²¤í† ë¦¬ ë‚´ í´ë” ê²½ë¡œ (ë¹ˆ ë¬¸ìì—´ = ë£¨íŠ¸). ì˜ˆ: "1í•™ê¸°/ì¤‘ê°„"
 * @param originalFileName - ì›ë³¸ íŒŒì¼ëª… (ì˜ˆ: ì„±ì í‘œ.jpg)
 * @returns R2 key. ì˜ˆ: tenants/t1/12345/inventory/1í•™ê¸°/ì¤‘ê°„/ì„±ì í‘œ_240214_abc.jpg
 */
export function getInventoryR2Key(
  tenantId: string,
  studentPs: string,
  folderPath: string,
  originalFileName: string
): string {
  const safeName = safeInventoryFileName(originalFileName);
  const prefix = `tenants/${tenantId}/${studentPs}/inventory`;
  const path = folderPath ? `${prefix}/${folderPath}/${safeName}` : `${prefix}/${safeName}`;
  return path;
}

/**
 * ê°™ì€ í´ë” ë‚´ ì´ë¦„ ì¶©ëŒ ë°©ì§€ë¥¼ ìœ„í•´ ì›ë³¸ íŒŒì¼ëª…ì— íƒ€ì„ìŠ¤íƒ¬í”„(ë° ì§§ì€ í•´ì‹œ) ë¶€ì—¬.
 * ì˜ˆ: ì„±ì í‘œ.jpg â†’ ì„±ì í‘œ_240214_a1b2.jpg
 */
export function safeInventoryFileName(originalFileName: string): string {
  const lastDot = originalFileName.lastIndexOf(".");
  const base = lastDot >= 0 ? originalFileName.slice(0, lastDot) : originalFileName;
  const ext = lastDot >= 0 ? originalFileName.slice(lastDot) : "";
  const stamp = new Date().toISOString().slice(0, 10).replace(/-/g, "");
  const hash = Math.random().toString(36).slice(2, 6);
  const safe = `${base}_${stamp}_${hash}${ext}`;
  return safe;
}

/**
 * í´ë” ë°°ì—´ì„ R2 ê²½ë¡œ ë¬¸ìì—´ë¡œ ë³€í™˜.
 * [{ name: "1í•™ê¸°" }, { name: "ì¤‘ê°„" }] â†’ "1í•™ê¸°/ì¤‘ê°„"
 */
export function folderPathFromIds(
  folders: { id: string; name: string; parentId: string | null }[],
  folderId: string | null
): string {
  if (!folderId) return "";
  const path: string[] = [];
  let currentId: string | null = folderId;
  while (currentId) {
    const folder = folders.find((f) => f.id === currentId);
    if (!folder) break;
    path.unshift(folder.name);
    currentId = folder.parentId;
  }
  return path.join("/");
}


==========================================================================================
# FILE: overlays/StudentsDetailOverlay.tsx
==========================================================================================
// PATH: src/features/students/overlays/StudentsDetailOverlay.tsx
// í•™ìƒ ìƒì„¸ ì˜¤ë²„ë ˆì´ â€” ê³ ê¸‰ SaaS ìŠ¤íƒ€ì¼, ê¸°ëŠ¥Â·êµ¬ì„± ë™ì¼

import { useParams, useNavigate } from "react-router-dom";
import { useState, useRef } from "react";
import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { createPortal } from "react-dom";

import {
  getStudentDetail,
  getTags,
  attachStudentTag,
  detachStudentTag,
  createMemo,
  deleteStudent,
  toggleStudentActive,
} from "../api/students";

import StudentFormModal from "../components/EditStudentModal";
import TagCreateModal from "../components/TagCreateModal";
import StudentNameWithLectureChip from "@/shared/ui/chips/StudentNameWithLectureChip";
import { EmptyState, Button, CloseButton } from "@/shared/ui/ds";
import { formatPhone, formatStudentPhoneDisplay, formatOmrCode } from "@/shared/utils/formatPhone";

const TABS = [
  { key: "enroll", label: "ìˆ˜ê°• ì´ë ¥" },
  { key: "clinic", label: "í´ë¦¬ë‹‰/ìƒë‹´ ì´ë ¥" },
  { key: "question", label: "ì§ˆë¬¸ ì´ë ¥" },
  { key: "score", label: "ì„±ì  ì´ë ¥" },
  { key: "schoolScore", label: "í•™êµ ì„±ì " },
];

/** ì¸ë²¤í† ë¦¬ ì•„ì´ì½˜ í”„ë¦¬ì…‹ â€” ì‹œí—˜/ìë£Œ ì¢…ë¥˜ë³„ ì‹œê° êµ¬ë¶„ */
const INVENTORY_ICON_PRESETS = [
  { id: "mid1", label: "1í•™ê¸° ì¤‘ê°„", emoji: "ğŸ“„", color: "#c62828" },
  { id: "final1", label: "1í•™ê¸° ê¸°ë§", emoji: "ğŸ“„", color: "#ad1457" },
  { id: "mid2", label: "2í•™ê¸° ì¤‘ê°„", emoji: "ğŸ“„", color: "#6a1b9a" },
  { id: "final2", label: "2í•™ê¸° ê¸°ë§", emoji: "ğŸ“„", color: "#1565c0" },
  { id: "mock3", label: "ëª¨ì˜ê³ ì‚¬ 3ì›”", emoji: "ğŸ“‹", color: "#00838f" },
  { id: "mock6", label: "ëª¨ì˜ê³ ì‚¬ 6ì›”", emoji: "ğŸ“‹", color: "#2e7d32" },
  { id: "mock9", label: "ëª¨ì˜ê³ ì‚¬ 9ì›”", emoji: "ğŸ“‹", color: "#ef6c00" },
  { id: "custom", label: "í•™ì› ì‚¬ì„¤", emoji: "ğŸ“Œ", color: "#37474f" },
  { id: "misc", label: "ê¸°íƒ€", emoji: "ğŸ“", color: "#757575" },
] as const;

type StudentsDetailOverlayProps = {
  /** ë¼ìš°íŠ¸ê°€ ì•„ë‹Œ ê³³(ì˜ˆ: ëª¨ë‹¬)ì—ì„œ ë„ìš¸ ë•Œ ì „ë‹¬. ìˆìœ¼ë©´ onCloseë¡œë§Œ ë‹«ê³  ë¼ìš°íŠ¸ ë³€ê²½ ì—†ìŒ */
  studentId?: number;
  onClose?: () => void;
};

export default function StudentsDetailOverlay(props?: StudentsDetailOverlayProps) {
  const routeParams = useParams();
  const navigate = useNavigate();
  const id = props?.studentId ?? Number(routeParams.studentId);
  const onClose = props?.onClose ?? (() => navigate(-1));
  const qc = useQueryClient();

  const [tab, setTab] = useState("enroll");
  const [editOpen, setEditOpen] = useState(false);
  const [tagCreateOpen, setTagCreateOpen] = useState(false);
  const [inventoryOpen, setInventoryOpen] = useState(false);
  const [inventoryTab, setInventoryTab] = useState<"score" | "misc" | "video" | "image">("score");
  const [viewerItem, setViewerItem] = useState<{ type: "pdf" | "image" | "video"; url: string; name: string } | null>(null);
  const fileInputRef = useRef<HTMLInputElement>(null);

  type InventoryFolder = { id: string; name: string; parentId: string | null };
  type UploadedInventoryItem = {
    id: string;
    title: string;
    description: string;
    fileName: string;
    fileUrl: string;
    fileType: "pdf" | "image";
    iconPreset?: string;
    folderId?: string | null;
  };
  const [scoreFolders, setScoreFolders] = useState<InventoryFolder[]>([]);
  const [miscFolders, setMiscFolders] = useState<InventoryFolder[]>([]);
  const [scoreCurrentFolderId, setScoreCurrentFolderId] = useState<string | null>(null);
  const [miscCurrentFolderId, setMiscCurrentFolderId] = useState<string | null>(null);
  const [uploadedScoreItems, setUploadedScoreItems] = useState<UploadedInventoryItem[]>([]);
  const [uploadedMiscItems, setUploadedMiscItems] = useState<UploadedInventoryItem[]>([]);
  const [addChoiceModal, setAddChoiceModal] = useState<"score" | "misc" | null>(null);
  const [newFolderModal, setNewFolderModal] = useState<{ tab: "score" | "misc"; name: string } | null>(null);
  const [addFileModal, setAddFileModal] = useState<{
    tab: "score" | "misc";
    file: File | null;
    title: string;
    description: string;
    iconPreset: string;
  } | null>(null);
  const [editItem, setEditItem] = useState<{ item: UploadedInventoryItem; tab: "score" | "misc" } | null>(null);
  const [inventoryMultiSelect, setInventoryMultiSelect] = useState(false);
  const [inventorySelectedId, setInventorySelectedId] = useState<string | null>(null);
  const [inventorySelectedIds, setInventorySelectedIds] = useState<Set<string>>(new Set());
  const [inventorySelectedFolderIds, setInventorySelectedFolderIds] = useState<Set<string>>(new Set());

  const currentFolders = inventoryTab === "score" ? scoreFolders : miscFolders;
  const setCurrentFolders = inventoryTab === "score" ? setScoreFolders : setMiscFolders;
  const currentFolderId = inventoryTab === "score" ? scoreCurrentFolderId : miscCurrentFolderId;
  const setCurrentFolderId = inventoryTab === "score" ? setScoreCurrentFolderId : setMiscCurrentFolderId;

  const handleInventoryFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (!file) return;
    setAddFileModal((m) => (m ? { ...m, file, title: m.title || file.name.replace(/\.[^.]+$/, "") || file.name } : null));
    e.target.value = "";
  };

  const openAddChoice = (tab: "score" | "misc") => setAddChoiceModal(tab);
  const openUploadModal = () => {
    if (!addChoiceModal) return;
    setAddFileModal({
      tab: addChoiceModal,
      file: null,
      title: "",
      description: "",
      iconPreset: INVENTORY_ICON_PRESETS[0].id,
    });
    setAddChoiceModal(null);
  };
  const openNewFolderModal = () => {
    if (!addChoiceModal) return;
    setNewFolderModal({ tab: addChoiceModal, name: "" });
    setAddChoiceModal(null);
  };

  const confirmNewFolder = () => {
    if (!newFolderModal || !newFolderModal.name.trim()) return;
    const folder: InventoryFolder = {
      id: crypto.randomUUID(),
      name: newFolderModal.name.trim(),
      parentId: currentFolderId,
    };
    setCurrentFolders((prev) => [...prev, folder]);
    setNewFolderModal(null);
  };

  const confirmAddFile = () => {
    if (!addFileModal || !addFileModal.file) return;
    const { tab, file, title, description, iconPreset } = addFileModal;
    const fileUrl = URL.createObjectURL(file);
    const fileType = file.type.startsWith("image/") ? "image" as const : "pdf" as const;
    const item: UploadedInventoryItem = {
      id: crypto.randomUUID(),
      title: title.trim() || file.name,
      description,
      fileName: file.name,
      fileUrl,
      fileType,
      iconPreset,
      folderId: currentFolderId,
    };
    if (tab === "score") setUploadedScoreItems((prev) => [...prev, item]);
    else setUploadedMiscItems((prev) => [...prev, item]);
    setAddFileModal(null);
  };

  const currentList = inventoryTab === "score" ? uploadedScoreItems : uploadedMiscItems;
  const setCurrentList = inventoryTab === "score" ? setUploadedScoreItems : setUploadedMiscItems;
  const subFolders = currentFolders.filter((f) => f.parentId === currentFolderId);
  const currentListFiltered = currentList.filter((i) => (i.folderId ?? null) === currentFolderId);

  const folderHasChildren = (folderId: string) => {
    const hasSub = currentFolders.some((f) => f.parentId === folderId);
    const hasFiles = currentList.some((i) => (i.folderId ?? null) === folderId);
    return hasSub || hasFiles;
  };

  const selectedIds = inventoryMultiSelect ? inventorySelectedIds : (inventorySelectedId ? new Set([inventorySelectedId]) : new Set());
  const hasSelection = selectedIds.size > 0 || inventorySelectedFolderIds.size > 0;

  const toggleInventorySelection = (id: string) => {
    setInventorySelectedFolderIds(new Set());
    if (inventoryMultiSelect) {
      setInventorySelectedIds((prev) => {
        const next = new Set(prev);
        if (next.has(id)) next.delete(id);
        else next.add(id);
        return next;
      });
    } else {
      setInventorySelectedId((prev) => (prev === id ? null : id));
    }
  };

  const toggleFolderSelection = (folderId: string) => {
    setInventorySelectedId(null);
    setInventorySelectedIds(new Set());
    if (inventoryMultiSelect) {
      setInventorySelectedFolderIds((prev) => {
        const next = new Set(prev);
        if (next.has(folderId)) next.delete(folderId);
        else next.add(folderId);
        return next;
      });
    } else {
      setInventorySelectedFolderIds((prev) => (prev.has(folderId) ? new Set() : new Set([folderId])));
    }
  };

  const openEditModal = () => {
    if (!inventoryMultiSelect && selectedIds.size !== 1) return;
    const singleId = Array.from(selectedIds)[0];
    if (!singleId) return;
    const item = [...uploadedScoreItems, ...uploadedMiscItems].find((i) => i.id === singleId);
    if (item)
      setEditItem({
        item: { ...item, iconPreset: item.iconPreset ?? "misc" },
        tab: uploadedScoreItems.some((i) => i.id === singleId) ? "score" : "misc",
      });
  };

  const confirmEditItem = () => {
    if (!editItem) return;
    const { item, tab } = editItem;
    const updater = (prev: UploadedInventoryItem[]) =>
      prev.map((i) => (i.id === item.id ? { ...i, title: item.title, description: item.description, iconPreset: item.iconPreset } : i));
    if (tab === "score") setUploadedScoreItems(updater);
    else setUploadedMiscItems(updater);
    setEditItem(null);
  };

  const deleteSelectedInventory = () => {
    const toDeleteFolderIds = Array.from(inventorySelectedFolderIds);
    for (const fid of toDeleteFolderIds) {
      if (folderHasChildren(fid)) {
        alert("ë¹„ì–´ìˆì§€ ì•Šì€ í´ë”ëŠ” ì§€ìš¸ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € í•˜ìœ„ íŒŒì¼Â·í´ë”ë¥¼ ë¹„ìš°ê±°ë‚˜ ì‚­ì œí•˜ì„¸ìš”.");
        return;
      }
    }
    toDeleteFolderIds.forEach((fid) => setCurrentFolders((prev) => prev.filter((f) => f.id !== fid)));
    if (currentFolderId && toDeleteFolderIds.includes(currentFolderId)) setCurrentFolderId(null);
    setInventorySelectedFolderIds(new Set());

    const toDelete = Array.from(selectedIds);
    toDelete.forEach((id) => {
      const item = [...uploadedScoreItems, ...uploadedMiscItems].find((i) => i.id === id);
      if (item?.fileUrl.startsWith("blob:")) URL.revokeObjectURL(item.fileUrl);
    });
    setCurrentList((prev) => prev.filter((i) => !toDelete.includes(i.id)));
    setInventorySelectedId(null);
    setInventorySelectedIds(new Set());
  };

  const { data: student, isLoading } = useQuery({
    queryKey: ["student", id],
    queryFn: () => getStudentDetail(id),
    enabled: !!id,
  });

  const { data: tags } = useQuery({
    queryKey: ["tags"],
    queryFn: getTags,
  });

  const addTag = useMutation({
    mutationFn: (tagId: number) => attachStudentTag(id, tagId),
    onSuccess: () => {
      qc.invalidateQueries({ queryKey: ["student", id] });
      qc.invalidateQueries({ queryKey: ["tags"] });
    },
  });

  const removeTag = useMutation({
    mutationFn: (tagId: number) => detachStudentTag(id, tagId),
    onSuccess: () => qc.invalidateQueries({ queryKey: ["student", id] }),
  });

  const updateMemo = useMutation({
    mutationFn: (memo: string) => createMemo(id, memo),
    onSuccess: () => qc.invalidateQueries({ queryKey: ["student", id] }),
  });

  const toggleActive = useMutation({
    mutationFn: (nextActive: boolean) => toggleStudentActive(id, nextActive),
    onSuccess: () => {
      qc.invalidateQueries({ queryKey: ["student", id] });
      qc.invalidateQueries({ queryKey: ["students"] });
    },
  });

  async function handleDelete() {
    if (!confirm("ì´ í•™ìƒì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
    await deleteStudent(id);
    qc.invalidateQueries({ queryKey: ["students"] });
    onClose();
  }

  if (isLoading || !student) return null;

  return (
    <>
      <div className="ds-overlay-backdrop" onClick={onClose} aria-hidden />

      <div className="ds-overlay-wrap">
        <div className="ds-overlay-panel ds-overlay-panel--student-detail" onClick={(e) => e.stopPropagation()}>
          <CloseButton
            className="ds-overlay-panel__close"
            onClick={onClose}
          />
          <header className="ds-overlay-header">
            <div className="ds-overlay-header__inner">
              <div className="ds-overlay-header__left">
                <div className="ds-overlay-header__avatar-wrap" aria-hidden>
                  <span className="ds-overlay-header__avatar">
                    {student.profilePhotoUrl ? (
                      <img src={student.profilePhotoUrl} alt="" className="w-full h-full object-cover" />
                    ) : (
                      (student.name || "?")[0]
                    )}
                  </span>
                </div>
                <div className="ds-overlay-header__title-block">
                  <h1 className="ds-overlay-header__title">
                    <StudentNameWithLectureChip
                      name={student.name ?? ""}
                      avatarSize={0}
                      chipSize={36}
                      lectures={
                        Array.isArray(student.enrollments) && student.enrollments.length > 0
                          ? student.enrollments.map((en: { lectureName?: string | null; lectureColor?: string | null; lectureChipLabel?: string | null }) => ({
                              lectureName: en.lectureName ?? "â€”",
                              color: en.lectureColor ?? undefined,
                              chipLabel: en.lectureChipLabel ?? undefined,
                            }))
                          : undefined
                      }
                    />
                  </h1>
                  <div className="ds-overlay-header__pills">
                    <span className="ds-badge ds-overlay-header__badge-id" title="ì•„ì´ë””">
                      {student.psNumber ?? "â€”"}
                    </span>
                    <span className="ds-badge ds-overlay-header__badge-code" title="ì‹œí—˜ ì‹ë³„ì½”ë“œ">
                      {formatOmrCode(student.omrCode)}
                    </span>
                  </div>
                </div>
              </div>
              <div className="ds-overlay-header__right">
                <div className="ds-overlay-header__actions">
                  <button
                    type="button"
                    onClick={() => toggleActive.mutate(!student.active)}
                    disabled={toggleActive.isPending}
                    className="ds-status-badge"
                    data-status={student.active ? "active" : "inactive"}
                  >
                    {toggleActive.isPending ? "â€¦" : student.active ? "í™œì„±" : "ë¹„í™œì„±"}
                  </button>
                  <Button type="button" intent="primary" size="sm" onClick={() => setEditOpen(true)}>
                    ìˆ˜ì •
                  </Button>
                  <Button type="button" intent="danger" size="sm" onClick={handleDelete}>
                    ì‚­ì œ
                  </Button>
                </div>
              </div>
            </div>
          </header>

          <div className="ds-overlay-body">
            <div className="ds-overlay-body__grid">
              {/* Left panel â€” ì •ë³´Â·íƒœê·¸Â·ë©”ëª¨ */}
              <div
                style={{
                  borderRadius: 12,
                  padding: 16,
                  background: "var(--bg-surface-soft)",
                  border: "1px solid var(--color-border-divider)",
                }}
              >
                <div className="ds-overlay-info-rows">
                  <InfoRow
                    label="ì‹ë³„ì½”ë“œ"
                    value={formatOmrCode(student.omrCode)}
                    accent
                  />
                  <InfoRow label="í•™ë¶€ëª¨ ì „í™”" value={formatPhone(student.parentPhone)} />
                  <InfoRow
                    label="í•™ìƒ ì „í™”"
                    value={formatStudentPhoneDisplay(student.studentPhone)}
                  />
                  <InfoRow label="ì„±ë³„" value={student.gender} />
                  <InfoRow label="í•™êµ" value={student.school} />
                  <InfoRow
                    label="í•™ë…„"
                    value={student.grade ? `${student.grade}í•™ë…„` : "-"}
                  />
                  <InfoRow label="ë°˜" value={student.schoolClass} />
                  <InfoRow label="ê³„ì—´" value={student.major} />
                </div>

                <div style={{ marginTop: 20 }}>
                  <div
                    style={{
                      fontSize: 11,
                      fontWeight: 800,
                      marginBottom: 8,
                      color: "var(--color-text-muted)",
                      letterSpacing: "0.04em",
                      textTransform: "uppercase",
                    }}
                  >
                    íƒœê·¸
                  </div>
                  <div className="flex flex-wrap gap-2 mb-3">
                    {student.tags?.length ? (
                      student.tags.map((t: any) => {
                        const c = String(t.color || "").toLowerCase();
                        const lightColors = ["#eab308", "#06b6d4"];
                        const isLight = lightColors.some((x) => c === x);
                        return (
                        <span
                          key={t.id}
                          className="inline-flex items-center gap-1 group cursor-default"
                          style={{
                            padding: "6px 10px 6px 12px",
                            borderRadius: "6px 6px 6px 2px",
                            fontSize: 12,
                            fontWeight: 700,
                            background: t.color,
                            color: isLight ? "#1a1a1a" : "#fff",
                            border: "none",
                            boxShadow: "0 1px 3px rgba(0,0,0,0.15)",
                            textShadow: isLight ? "none" : "0 0 1px rgba(0,0,0,0.2)",
                          }}
                        >
                          {t.name}
                          <button
                            type="button"
                            onClick={(e) => {
                              e.stopPropagation();
                              removeTag.mutate(t.id);
                            }}
                            disabled={removeTag.isPending}
                            aria-label={`${t.name} íƒœê·¸ ì œê±°`}
                            style={{
                              marginLeft: 4,
                              padding: 0,
                              width: 16,
                              height: 16,
                              borderRadius: 999,
                              border: "none",
                              background: "rgba(0,0,0,0.2)",
                              color: "#fff",
                              fontSize: 12,
                              cursor: removeTag.isPending ? "wait" : "pointer",
                              display: "grid",
                              placeItems: "center",
                              lineHeight: 1,
                            }}
                          >
                            Ã—
                          </button>
                        </span>
                        );
                      })
                    ) : (
                      <span
                        style={{
                          fontSize: 12,
                          color: "var(--color-text-muted)",
                          fontWeight: 600,
                        }}
                      >
                        íƒœê·¸ ì—†ìŒ
                      </span>
                    )}
                  </div>
                  <div className="flex flex-wrap gap-2">
                    <Button
                      type="button"
                      intent="primary"
                      size="sm"
                      onClick={() => setTagCreateOpen(true)}
                    >
                      + íƒœê·¸ ì¶”ê°€
                    </Button>
                    {tags?.filter((t: any) => !student.tags?.some((st: any) => st.id === t.id)).length > 0 && (
                      <select
                        className="ds-input"
                        style={{ fontSize: 13, minWidth: 140 }}
                        onChange={(e) => {
                          const tagId = Number(e.target.value);
                          if (tagId) addTag.mutate(tagId);
                          e.currentTarget.value = "";
                        }}
                      >
                        <option value="">ê¸°ì¡´ íƒœê·¸ ì„ íƒâ€¦</option>
                        {tags
                          ?.filter((t: any) => !student.tags?.some((st: any) => st.id === t.id))
                          .map((tag: any) => (
                            <option key={tag.id} value={tag.id}>
                              {tag.name}
                            </option>
                          ))}
                      </select>
                    )}
                  </div>
                </div>

                <div style={{ marginTop: 20 }}>
                  <div
                    style={{
                      fontSize: 11,
                      fontWeight: 800,
                      marginBottom: 8,
                      color: "var(--color-text-muted)",
                      letterSpacing: "0.04em",
                      textTransform: "uppercase",
                    }}
                  >
                    ë©”ëª¨
                  </div>
                  <textarea
                    className="ds-textarea w-full"
                    rows={4}
                    defaultValue={student.memo}
                    placeholder="ë©”ëª¨..."
                    onBlur={(e) => updateMemo.mutate(e.target.value)}
                    style={{
                      fontSize: 13,
                      borderRadius: 12,
                      border: "1px solid var(--color-border-divider)",
                    }}
                  />
                </div>
              </div>

              {/* Right panel â€” íƒ­ + ì½˜í…ì¸  (í˜ì´ì§€í˜• í”Œë«íƒ­) */}
              <div
                style={{
                  borderRadius: 12,
                  padding: 16,
                  background: "color-mix(in srgb, var(--color-brand-primary) 4%, var(--bg-surface-soft))",
                  border: "1px solid var(--color-border-divider)",
                }}
              >
                <div className="ds-overlay-tabs">
                  <div className="ds-tabs ds-tabs--flat">
                    {TABS.map((t) => (
                      <button
                        key={t.key}
                        type="button"
                        className={`ds-tab ${tab === t.key ? "is-active" : ""}`}
                        onClick={() => setTab(t.key)}
                      >
                        {t.label}
                      </button>
                    ))}
                  </div>
                </div>

                <div style={{ minHeight: 260, marginTop: 16 }}>
                  {tab === "enroll" ? (
                    <EnrollmentsTab enrollments={student.enrollments} />
                  ) : (
                    <EmptyState scope="panel" tone="empty" title="ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤." />
                  )}
                </div>
              </div>
            </div>
          </div>

          {/* ìš°í•˜ë‹¨ ì¸ë²¤í† ë¦¬ íŠ¸ë¦¬ê±° â€” ì•„ì´ì½˜ë§Œ í¼ì§€ë§‰í•˜ê²Œ, í´ë¦­ ì‹œ ì¢Œì¸¡ íŒ¨ë„ */}
          <div className="ds-overlay-inventory-wrap">
            <button
              type="button"
              className="ds-inventory-trigger-btn"
              onClick={() => setInventoryOpen(true)}
              title="ì¸ë²¤í† ë¦¬"
              aria-label="ì¸ë²¤í† ë¦¬ ì—´ê¸°"
            >
              ğŸ“
            </button>
          </div>
        </div>
      </div>

      {inventoryOpen &&
        createPortal(
          <>
            <div className="ds-overlay-backdrop" onClick={() => setInventoryOpen(false)} aria-hidden />
            <div
              className="ds-inventory-panel"
              role="dialog"
              aria-label="í•™ìƒ ì¸ë²¤í† ë¦¬"
              onClick={(e) => e.stopPropagation()}
            >
              <div className="ds-inventory-panel__header">
                <span className="ds-inventory-panel__title">ì¸ë²¤í† ë¦¬ â€” {student.name}</span>
                <div className="ds-inventory-panel__header-actions">
                  <CloseButton onClick={() => setInventoryOpen(false)} />
                </div>
              </div>
              <input
                ref={fileInputRef}
                type="file"
                accept=".pdf,.jpg,.jpeg,.png,.gif,.webp"
                className="ds-sr-only"
                aria-hidden
                onChange={handleInventoryFileChange}
              />
              <div className="ds-inventory-panel__tabs-wrap">
                <div className="ds-inventory-panel__multi-check">
                  <input
                    id="inv-multi"
                    type="checkbox"
                    checked={inventoryMultiSelect}
                    onChange={(e) => {
                      setInventoryMultiSelect(e.target.checked);
                      if (!e.target.checked) setInventorySelectedIds(new Set());
                    }}
                    aria-label="ë‹¤ì¤‘ ì„ íƒ"
                  />
                  <label htmlFor="inv-multi">ë‹¤ì¤‘</label>
                </div>
                <div className="ds-inventory-panel__tabs">
                  {(["score", "misc", "video", "image"] as const).map((key) => (
                    <button
                      key={key}
                      type="button"
                      className={`ds-inventory-panel__tab ${inventoryTab === key ? "is-active" : ""}`}
                      onClick={() => setInventoryTab(key)}
                    >
                      {key === "score" && "ì„±ì í‘œ"}
                      {key === "misc" && "ê¸°íƒ€"}
                      {key === "video" && "ì œì¶œì˜ìƒ"}
                      {key === "image" && "ì œì¶œì´ë¯¸ì§€"}
                    </button>
                  ))}
                </div>
              </div>
              <div className="ds-inventory-panel__main">
                {(inventoryTab === "score" || inventoryTab === "misc") && (
                  <div className="ds-inventory-panel__tree">
                    <div
                      className={`ds-inventory-panel__tree-root ${currentFolderId === null ? "is-current" : ""}`}
                      onClick={() => setCurrentFolderId(null)}
                    >
                      ë£¨íŠ¸
                    </div>
                    {currentFolders
                      .filter((f) => !f.parentId)
                      .map((folder) => (
                        <InventoryTreeFolder
                          key={folder.id}
                          folder={folder}
                          allFolders={currentFolders}
                          currentFolderId={currentFolderId}
                          onSelect={setCurrentFolderId}
                        />
                      ))}
                  </div>
                )}
              <div className="ds-inventory-panel__body">
                <div className="ds-inventory-panel__grid">
                  {inventoryTab === "score" && (
                    <>
                      <div
                        className="ds-inventory-panel__item ds-inventory-panel__item--add"
                        role="button"
                        tabIndex={0}
                        onClick={() => openAddChoice("score")}
                        onKeyDown={(e) => e.key === "Enter" && openAddChoice("score")}
                        title="í´ë” ì¶”ê°€ ë˜ëŠ” ì—…ë¡œë“œ"
                      >
                        +
                      </div>
                      {subFolders.map((folder) => {
                        const isSelected = inventorySelectedFolderIds.has(folder.id);
                        return (
                          <div
                            key={folder.id}
                            className={`ds-inventory-panel__item ds-inventory-panel__item--folder ${isSelected ? "is-selected" : ""}`}
                            title={folder.name}
                            onClick={() => toggleFolderSelection(folder.id)}
                            onDoubleClick={(e) => {
                              e.stopPropagation();
                              setCurrentFolderId(folder.id);
                            }}
                          >
                            <span className="ds-inventory-panel__item-icon">ğŸ“</span>
                            <span className="ds-inventory-panel__item-title">{folder.name}</span>
                          </div>
                        );
                      })}
                      {currentListFiltered.map((item) => {
                        const preset = INVENTORY_ICON_PRESETS.find((p) => p.id === (item.iconPreset ?? "misc")) ?? INVENTORY_ICON_PRESETS[0];
                        const isSelected = selectedIds.has(item.id);
                        return (
                          <div
                            key={item.id}
                            className={`ds-inventory-panel__item ds-inventory-panel__item--uploaded ${isSelected ? "is-selected" : ""}`}
                            title={item.description || item.title}
                            onClick={() => toggleInventorySelection(item.id)}
                            onDoubleClick={(e) => {
                              e.stopPropagation();
                              setViewerItem({ type: item.fileType, url: item.fileUrl, name: item.title });
                            }}
                          >
                            <span
                              className="ds-inventory-panel__item-icon-badge"
                              style={{ backgroundColor: preset.color + "22", color: preset.color }}
                            >
                              {preset.emoji}
                            </span>
                            <span className="ds-inventory-panel__item-title">{item.title}</span>
                            {item.description && <span className="ds-inventory-panel__item-desc">{item.description}</span>}
                            <span className="ds-inventory-panel__item-filename">{item.fileName}</span>
                          </div>
                        );
                      })}
                    </>
                  )}
                  {inventoryTab === "misc" && (
                    <>
                      <div
                        className="ds-inventory-panel__item ds-inventory-panel__item--add"
                        role="button"
                        tabIndex={0}
                        onClick={() => openAddChoice("misc")}
                        onKeyDown={(e) => e.key === "Enter" && openAddChoice("misc")}
                        title="í´ë” ì¶”ê°€ ë˜ëŠ” ì—…ë¡œë“œ"
                      >
                        +
                      </div>
                      {subFolders.map((folder) => {
                        const isSelected = inventorySelectedFolderIds.has(folder.id);
                        return (
                          <div
                            key={folder.id}
                            className={`ds-inventory-panel__item ds-inventory-panel__item--folder ${isSelected ? "is-selected" : ""}`}
                            title={folder.name}
                            onClick={() => toggleFolderSelection(folder.id)}
                            onDoubleClick={(e) => {
                              e.stopPropagation();
                              setCurrentFolderId(folder.id);
                            }}
                          >
                            <span className="ds-inventory-panel__item-icon">ğŸ“</span>
                            <span className="ds-inventory-panel__item-title">{folder.name}</span>
                          </div>
                        );
                      })}
                      {currentListFiltered.map((item) => {
                        const preset = INVENTORY_ICON_PRESETS.find((p) => p.id === (item.iconPreset ?? "misc")) ?? INVENTORY_ICON_PRESETS[0];
                        const isSelected = selectedIds.has(item.id);
                        return (
                          <div
                            key={item.id}
                            className={`ds-inventory-panel__item ds-inventory-panel__item--uploaded ${isSelected ? "is-selected" : ""}`}
                            title={item.description || item.title}
                            onClick={() => toggleInventorySelection(item.id)}
                            onDoubleClick={(e) => {
                              e.stopPropagation();
                              setViewerItem({ type: item.fileType, url: item.fileUrl, name: item.title });
                            }}
                          >
                            <span
                              className="ds-inventory-panel__item-icon-badge"
                              style={{ backgroundColor: preset.color + "22", color: preset.color }}
                            >
                              {preset.emoji}
                            </span>
                            <span className="ds-inventory-panel__item-title">{item.title}</span>
                            {item.description && <span className="ds-inventory-panel__item-desc">{item.description}</span>}
                            <span className="ds-inventory-panel__item-filename">{item.fileName}</span>
                          </div>
                        );
                      })}
                    </>
                  )}
                  {inventoryTab === "video" && (
                    <>
                      <div
                        className="ds-inventory-panel__item"
                        title="í•™ìƒ ì•± ì œì¶œë¶„ (ë”ë¸”í´ë¦­)"
                        onDoubleClick={() => setViewerItem({ type: "video", url: "#", name: "ì œì¶œ ì˜ìƒ 1" })}
                      >
                        <span className="ds-inventory-panel__item-icon">ğŸ¬</span>
                        <span>ì œì¶œ ì˜ìƒ 1</span>
                      </div>
                    </>
                  )}
                  {inventoryTab === "image" && (
                    <>
                      <div
                        className="ds-inventory-panel__item"
                        title="í•™ìƒ ì•± ì œì¶œë¶„ (ë”ë¸”í´ë¦­)"
                        onDoubleClick={() => setViewerItem({ type: "image", url: "#", name: "ì œì¶œ ì´ë¯¸ì§€ 1" })}
                      >
                        <span className="ds-inventory-panel__item-icon">ğŸ–¼ï¸</span>
                        <span>ì œì¶œ ì´ë¯¸ì§€ 1</span>
                      </div>
                    </>
                  )}
                </div>
              </div>
              </div>
              {(inventoryTab === "score" || inventoryTab === "misc") && (
                <div className="ds-inventory-panel__footer">
                  {hasSelection && (
                    <>
                      {!inventoryMultiSelect && selectedIds.size === 1 && inventorySelectedFolderIds.size === 0 && (
                        <Button type="button" intent="secondary" size="sm" onClick={openEditModal}>
                          ìˆ˜ì •
                        </Button>
                      )}
                      <Button type="button" intent="danger" size="sm" onClick={deleteSelectedInventory}>
                        ì‚­ì œ
                      </Button>
                    </>
                  )}
                </div>
              )}
            </div>
          </>,
          document.body
        )}

      {addChoiceModal && (
        createPortal(
          <>
            <div className="ds-overlay-backdrop" onClick={() => setAddChoiceModal(null)} aria-hidden />
            <div className="ds-inventory-choice-modal" role="dialog" aria-label="ì¶”ê°€" onClick={(e) => e.stopPropagation()}>
              <div className="ds-inventory-choice-modal__title">ì¶”ê°€</div>
              <div className="ds-inventory-choice-modal__actions">
                <Button type="button" intent="secondary" size="sm" onClick={openNewFolderModal}>
                  í´ë”ìƒì„±
                </Button>
                <Button type="button" intent="primary" size="sm" onClick={openUploadModal}>
                  ì—…ë¡œë“œ
                </Button>
              </div>
            </div>
          </>,
          document.body
        )
      )}

      {newFolderModal &&
        createPortal(
          <>
            <div className="ds-overlay-backdrop" onClick={() => setNewFolderModal(null)} aria-hidden />
            <div className="ds-inventory-add-modal" role="dialog" aria-label="í´ë” ìƒì„±" onClick={(e) => e.stopPropagation()}>
              <div className="ds-inventory-add-modal__title">í´ë” ìƒì„±</div>
              <div className="ds-inventory-add-modal__field">
                <label htmlFor="inv-folder-name">í´ë” ì œëª©</label>
                <input
                  id="inv-folder-name"
                  type="text"
                  value={newFolderModal.name}
                  onChange={(e) => setNewFolderModal((m) => (m ? { ...m, name: e.target.value } : null))}
                  placeholder="í´ë” ì œëª©"
                />
              </div>
              <div className="ds-inventory-add-modal__actions">
                <Button type="button" intent="secondary" size="sm" onClick={() => setNewFolderModal(null)}>
                  ì·¨ì†Œ
                </Button>
                <Button type="button" intent="primary" size="sm" onClick={confirmNewFolder}>
                  ìƒì„±
                </Button>
              </div>
            </div>
          </>,
          document.body
        )}

      {addFileModal &&
        createPortal(
          <>
            <div className="ds-overlay-backdrop" onClick={() => setAddFileModal(null)} aria-hidden />
            <div className="ds-inventory-add-modal" role="dialog" aria-label="íŒŒì¼ ì—…ë¡œë“œ" onClick={(e) => e.stopPropagation()}>
              <div className="ds-inventory-add-modal__title">{addFileModal.tab === "score" ? "ì„±ì í‘œ ì—…ë¡œë“œ" : "ê¸°íƒ€ ìë£Œ ì—…ë¡œë“œ"}</div>
              <div className="ds-inventory-add-modal__field">
                <label htmlFor="inv-add-title">ì œëª©</label>
                <input
                  id="inv-add-title"
                  type="text"
                  value={addFileModal.title}
                  onChange={(e) => setAddFileModal((m) => (m ? { ...m, title: e.target.value } : null))}
                  placeholder="ì œëª©"
                />
              </div>
              <div className="ds-inventory-add-modal__field">
                <label htmlFor="inv-add-desc">ì„¤ëª…</label>
                <textarea
                  id="inv-add-desc"
                  value={addFileModal.description}
                  onChange={(e) => setAddFileModal((m) => (m ? { ...m, description: e.target.value } : null))}
                  placeholder="ì„¤ëª… (í˜¸ë²„ ì‹œ í‘œì‹œ)"
                />
              </div>
              <div className="ds-inventory-add-modal__field">
                <span className="ds-inventory-add-modal__icon-label">ì•„ì´ì½˜ (ì¢…ë¥˜Â·ìƒ‰ìƒ)</span>
                <div className="ds-inventory-add-modal__icon-grid">
                  {INVENTORY_ICON_PRESETS.map((p) => (
                    <button
                      key={p.id}
                      type="button"
                      className={`ds-inventory-add-modal__icon-opt ${addFileModal.iconPreset === p.id ? "is-selected" : ""}`}
                      onClick={() => setAddFileModal((m) => (m ? { ...m, iconPreset: p.id } : null))}
                      title={p.label}
                    >
                      <span className="ds-inventory-add-modal__icon-opt-emoji">{p.emoji}</span>
                      <span className="ds-inventory-add-modal__icon-opt-swatch" style={{ backgroundColor: p.color }} />
                      <span>{p.label}</span>
                    </button>
                  ))}
                </div>
              </div>
              <div className="ds-inventory-add-modal__field">
                <label>íŒŒì¼</label>
                <div className="ds-inventory-add-modal__file-btn">
                  <Button
                    type="button"
                    intent="secondary"
                    size="sm"
                    onClick={() => fileInputRef.current?.click()}
                  >
                    {addFileModal.file ? addFileModal.file.name : "íŒŒì¼ ì„ íƒ"}
                  </Button>
                </div>
              </div>
              <div className="ds-inventory-add-modal__actions">
                <Button type="button" intent="secondary" size="sm" onClick={() => setAddFileModal(null)}>
                  ì·¨ì†Œ
                </Button>
                <Button type="button" intent="primary" size="sm" onClick={confirmAddFile} disabled={!addFileModal.file}>
                  ì—…ë¡œë“œ
                </Button>
              </div>
            </div>
          </>,
          document.body
        )}

      {editItem &&
        createPortal(
          <>
            <div className="ds-overlay-backdrop" onClick={() => setEditItem(null)} aria-hidden />
            <div className="ds-inventory-add-modal" role="dialog" aria-label="ìë£Œ ìˆ˜ì •" onClick={(e) => e.stopPropagation()}>
              <div className="ds-inventory-add-modal__title">ìë£Œ ìˆ˜ì •</div>
              <div className="ds-inventory-add-modal__field">
                <label htmlFor="inv-edit-title">ì œëª©</label>
                <input
                  id="inv-edit-title"
                  type="text"
                  value={editItem.item.title}
                  onChange={(e) => setEditItem((prev) => prev && { ...prev, item: { ...prev.item, title: e.target.value } })}
                  placeholder="ì œëª©"
                />
              </div>
              <div className="ds-inventory-add-modal__field">
                <label htmlFor="inv-edit-desc">ì„¤ëª…</label>
                <textarea
                  id="inv-edit-desc"
                  value={editItem.item.description}
                  onChange={(e) => setEditItem((prev) => prev && { ...prev, item: { ...prev.item, description: e.target.value } })}
                  placeholder="ì„¤ëª… (í˜¸ë²„ ì‹œ í‘œì‹œ)"
                />
              </div>
              <div className="ds-inventory-add-modal__field">
                <span className="ds-inventory-add-modal__icon-label">ì•„ì´ì½˜ (ì¢…ë¥˜Â·ìƒ‰ìƒ)</span>
                <div className="ds-inventory-add-modal__icon-grid">
                  {INVENTORY_ICON_PRESETS.map((p) => (
                    <button
                      key={p.id}
                      type="button"
                      className={`ds-inventory-add-modal__icon-opt ${editItem.item.iconPreset === p.id ? "is-selected" : ""}`}
                      onClick={() => setEditItem((prev) => prev && { ...prev, item: { ...prev.item, iconPreset: p.id } })}
                      title={p.label}
                    >
                      <span className="ds-inventory-add-modal__icon-opt-emoji">{p.emoji}</span>
                      <span className="ds-inventory-add-modal__icon-opt-swatch" style={{ backgroundColor: p.color }} />
                      <span>{p.label}</span>
                    </button>
                  ))}
                </div>
              </div>
              <div className="ds-inventory-add-modal__actions">
                <Button type="button" intent="secondary" size="sm" onClick={() => setEditItem(null)}>
                  ì·¨ì†Œ
                </Button>
                <Button type="button" intent="primary" size="sm" onClick={confirmEditItem}>
                  ì €ì¥
                </Button>
              </div>
            </div>
          </>,
          document.body
        )}

      {viewerItem &&
        createPortal(
          <>
            <div className="ds-overlay-backdrop" onClick={() => setViewerItem(null)} aria-hidden />
            <div className="ds-inventory-viewer" role="dialog" aria-label="ë³´ê¸°" onClick={(e) => e.stopPropagation()}>
              <div className="ds-inventory-viewer__header">
                <span className="ds-inventory-viewer__title">{viewerItem.name}</span>
                <CloseButton onClick={() => setViewerItem(null)} />
              </div>
              <div className="ds-inventory-viewer__body">
                {viewerItem.type === "pdf" && (
                  viewerItem.url.startsWith("blob:") ? (
                    <iframe src={viewerItem.url} title={viewerItem.name} className="ds-inventory-viewer__iframe" />
                  ) : (
                    <div className="ds-inventory-viewer__placeholder">PDF ë·°ì–´ (URL ì—°ë™ ì‹œ iframe í‘œì‹œ)</div>
                  )
                )}
                {viewerItem.type === "image" && (
                  viewerItem.url.startsWith("blob:") ? (
                    <img src={viewerItem.url} alt={viewerItem.name} className="ds-inventory-viewer__img" />
                  ) : (
                    <div className="ds-inventory-viewer__placeholder">ì´ë¯¸ì§€ ë·°ì–´ (URL ì—°ë™ ì‹œ img í‘œì‹œ)</div>
                  )
                )}
                {viewerItem.type === "video" && (
                  viewerItem.url.startsWith("blob:") ? (
                    <video src={viewerItem.url} controls className="ds-inventory-viewer__video" />
                  ) : (
                    <div className="ds-inventory-viewer__placeholder">ì˜ìƒ ë·°ì–´ (URL ì—°ë™ ì‹œ video í‘œì‹œ)</div>
                  )
                )}
              </div>
            </div>
          </>,
          document.body
        )}

      {editOpen &&
        createPortal(
          <StudentFormModal
            open={true}
            initialValue={student}
            onClose={() => setEditOpen(false)}
            onSuccess={() => {
              setEditOpen(false);
              qc.invalidateQueries({ queryKey: ["student", id] });
            }}
          />,
          document.body
        )}

      {tagCreateOpen &&
        createPortal(
          <TagCreateModal
            open={true}
            onClose={() => setTagCreateOpen(false)}
            onSuccess={(tag) => {
              addTag.mutate(tag.id);
              setTagCreateOpen(false);
            }}
            usedColors={tags?.map((t: any) => t.color).filter(Boolean) ?? []}
          />,
          document.body
        )}
    </>
  );
}

function InfoRow({
  label,
  value,
  accent,
}: {
  label: string;
  value: any;
  accent?: boolean;
}) {
  return (
    <div
      className="ds-overlay-info-row"
      style={{
        display: "grid",
        gridTemplateColumns: "1fr auto",
        alignItems: "center",
        padding: "6px 10px",
        borderRadius: 8,
        background: accent
          ? "color-mix(in srgb, var(--color-brand-primary) 10%, var(--color-bg-surface))"
          : "var(--color-bg-surface)",
        border: "1px solid var(--color-border-divider)",
        fontSize: 13,
      }}
    >
      <span
        style={{
          fontWeight: 600,
          color: "var(--color-text-muted)",
          fontSize: 12,
        }}
      >
        {label}
      </span>
      <span
        style={{
          fontWeight: 700,
          color: "var(--color-text-primary)",
          textAlign: "right",
        }}
      >
        {value || "-"}
      </span>
    </div>
  );
}

function InventoryTreeFolder({
  folder,
  allFolders,
  currentFolderId,
  onSelect,
}: {
  folder: { id: string; name: string; parentId: string | null };
  allFolders: { id: string; name: string; parentId: string | null }[];
  currentFolderId: string | null;
  onSelect: (id: string | null) => void;
}) {
  const children = allFolders.filter((f) => f.parentId === folder.id);
  const isCurrent = currentFolderId === folder.id;
  return (
    <div>
      <div
        className={`ds-inventory-panel__tree-item ${isCurrent ? "is-current" : ""}`}
        onClick={() => onSelect(folder.id)}
      >
        {folder.name}
      </div>
      {children.map((child) => (
        <InventoryTreeFolder
          key={child.id}
          folder={child}
          allFolders={allFolders}
          currentFolderId={currentFolderId}
          onSelect={onSelect}
        />
      ))}
    </div>
  );
}

function EnrollmentsTab({ enrollments }: { enrollments: any[] }) {
  if (!enrollments?.length) return <EmptyState scope="panel" tone="empty" title="ìˆ˜ê°• ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤." />;

  return (
    <div style={{ display: "grid", gap: 10 }}>
      {enrollments.map((en: any) => (
        <div
          key={en.id}
          style={{
            padding: "14px 16px",
            borderRadius: 12,
            background: "var(--color-bg-surface)",
            border: "1px solid var(--color-border-divider)",
            fontSize: 13,
            fontWeight: 700,
            transition: "border-color 0.15s, box-shadow 0.15s",
          }}
          className="hover:border-[var(--color-primary)]/30 hover:shadow-sm"
        >
          {en.lectureName || "-"}
        </div>
      ))}
    </div>
  );
}


==========================================================================================
# FILE: pages/StudentsHomePage.tsx
==========================================================================================
// PATH: src/features/students/pages/StudentsHomePage.tsx
import { useEffect, useMemo, useRef, useState } from "react";
import { useNavigate, useLocation } from "react-router-dom";
import { useMutation, useQueryClient } from "@tanstack/react-query";

const STORAGE_KEY = "students-selected-ids";

import { useStudentsQuery } from "../hooks/useStudentsQuery";
import {
  bulkDeleteStudents,
  bulkRestoreStudents,
  bulkPermanentDeleteStudents,
  checkDeletedStudentDuplicates,
  fixDeletedStudentDuplicates,
  toggleStudentActive,
} from "../api/students";
import StudentsTable from "../components/StudentsTable";
import StudentCreateModal from "../components/StudentCreateModal";
import StudentFilterModal from "../components/StudentFilterModal";

import { Button, EmptyState } from "@/shared/ui/ds";
import { DomainListToolbar } from "@/shared/ui/domain";
import { feedback } from "@/shared/ui/feedback/feedback";

export default function StudentsHomePage() {
  const navigate = useNavigate();
  const location = useLocation();
  const qc = useQueryClient();

  const isDeletedTab = location.pathname.includes("/deleted");

  const [searchInput, setSearchInput] = useState("");
  const [search, setSearch] = useState("");
  const [filters, setFilters] = useState<any>({});
  const [showCreate, setShowCreate] = useState(false);
  const [showFilter, setShowFilter] = useState(false);
  const [sort, setSort] = useState("-registeredAt");
  const [page, setPage] = useState(1);
  const [selectedIds, setSelectedIds] = useState<number[]>(() => {
    try {
      const k = `${STORAGE_KEY}-${isDeletedTab ? "deleted" : "home"}`;
      const v = sessionStorage.getItem(k);
      if (v) {
        const arr = JSON.parse(v);
        return Array.isArray(arr) ? arr.filter((x) => typeof x === "number") : [];
      }
    } catch {}
    return [];
  });
  const [deleting, setDeleting] = useState(false);
  const [duplicateFixing, setDuplicateFixing] = useState(false);
  const [bulkUploadProgress, setBulkUploadProgress] = useState<{ current: number; total: number } | null>(null);

  useEffect(() => {
    setSort(isDeletedTab ? "-deletedAt" : "-registeredAt");
  }, [isDeletedTab]);

  const prevTabRef = useRef(isDeletedTab);
  useEffect(() => {
    if (prevTabRef.current !== isDeletedTab) {
      prevTabRef.current = isDeletedTab;
      setSelectedIds([]);
    }
  }, [isDeletedTab]);

  useEffect(() => {
    const k = `${STORAGE_KEY}-${isDeletedTab ? "deleted" : "home"}`;
    sessionStorage.setItem(k, JSON.stringify(selectedIds));
  }, [selectedIds, isDeletedTab]);

  useEffect(() => {
    const t = setTimeout(() => setSearch(searchInput), 250);
    return () => clearTimeout(t);
  }, [searchInput]);

  useEffect(() => {
    setPage(1);
  }, [search, filters, isDeletedTab]);

  const { data: queryResult, isLoading } = useStudentsQuery(
    search,
    filters,
    sort,
    page,
    isDeletedTab
  );
  const data = queryResult?.data ?? [];
  const totalCount = queryResult?.count ?? 0;
  const pageSize = queryResult?.pageSize ?? 50;
  const totalPages = Math.max(1, Math.ceil(totalCount / pageSize));

  const activeFilterCount = useMemo(
    () => Object.keys(filters || {}).length,
    [filters]
  );

  const toggleActiveMutation = useMutation({
    mutationFn: ({ id, nextActive }: { id: number; nextActive: boolean }) =>
      toggleStudentActive(id, nextActive),
    onSuccess: () => {
      qc.invalidateQueries({ queryKey: ["students"] });
      qc.invalidateQueries({ queryKey: ["student"] });
    },
  });
  const togglingId =
    toggleActiveMutation.isPending && toggleActiveMutation.variables
      ? toggleActiveMutation.variables.id
      : null;

  const selectionBar = (
    <div className="flex flex-col gap-2">
    <div className="flex flex-wrap items-center gap-2 pl-1">
      <span
        className="text-[13px] font-semibold"
        style={{
          color: selectedIds.length > 0 ? "var(--color-primary)" : "var(--color-text-muted)",
        }}
      >
        {selectedIds.length}ëª… ì„ íƒë¨
      </span>
      <span className="text-[var(--color-border-divider)]">|</span>
      <Button intent="secondary" size="sm" onClick={() => setSelectedIds([])} disabled={selectedIds.length === 0}>
        ì„ íƒ í•´ì œ
      </Button>
      <span className="text-[var(--color-border-divider)]">|</span>
      {!isDeletedTab && (
        <>
          <Button intent="secondary" size="sm" onClick={() => feedback.info("ë©”ì‹œì§€ ë°œì†¡ ê¸°ëŠ¥ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.")}>
            ë©”ì‹œì§€ ë°œì†¡
          </Button>
          <Button intent="secondary" size="sm" onClick={() => feedback.info("ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ê¸°ëŠ¥ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.")}>
            ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
          </Button>
          <Button intent="secondary" size="sm" onClick={() => feedback.info("ì‹œê¸‰ íƒœê·¸ ì¶”ê°€ ê¸°ëŠ¥ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.")}>
            ì‹œê¸‰ íƒœê·¸ ì¶”ê°€
          </Button>
          <Button intent="secondary" size="sm" onClick={() => feedback.info("ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ê¸°ëŠ¥ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.")}>
            ë¹„ë°€ë²ˆí˜¸ ë³€ê²½
          </Button>
          <Button
            intent="danger"
            size="sm"
            disabled={selectedIds.length === 0 || deleting}
            onClick={async () => {
              if (selectedIds.length === 0) return;
              const selected = (data ?? []).filter((s) => selectedIds.includes(s.id));
              const parts = selected.map(
                (s) => `${s.name}(${Array.isArray(s.enrollments) ? s.enrollments.length : 0}ê°œ ê°•ì˜ ìˆ˜ê°• ì¤‘)`
              );
              const msg =
                parts.length > 0
                  ? `${parts.join(", ")}\n\nìœ„ ${selectedIds.length}ëª…ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? 30ì¼ê°„ ë³´ê´€ í›„ ìë™ ì‚­ì œë©ë‹ˆë‹¤.`
                  : `ì„ íƒí•œ ${selectedIds.length}ëª…ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? 30ì¼ê°„ ë³´ê´€ í›„ ìë™ ì‚­ì œë©ë‹ˆë‹¤.`;
              if (!window.confirm(msg)) return;
              setDeleting(true);
              try {
                const { deleted } = await bulkDeleteStudents(selectedIds);
                setSelectedIds([]);
                qc.invalidateQueries({ queryKey: ["students"] });
                feedback.success(`${deleted}ëª… ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);
              } catch (e: unknown) {
                feedback.error(e instanceof Error ? e.message : "ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
              } finally {
                setDeleting(false);
              }
            }}
          >
            {deleting ? "ì‚­ì œ ì¤‘â€¦" : "ì‚­ì œ"}
          </Button>
        </>
      )}
      {isDeletedTab && (
        <>
          <Button
            intent="primary"
            size="sm"
            disabled={selectedIds.length === 0 || deleting}
            onClick={async () => {
              if (selectedIds.length === 0) return;
              if (!window.confirm(`ì„ íƒí•œ ${selectedIds.length}ëª…ì„ ë³µì›í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
              setDeleting(true);
              try {
                const { restored } = await bulkRestoreStudents(selectedIds);
                setSelectedIds([]);
                qc.invalidateQueries({ queryKey: ["students"] });
                feedback.success(`${restored}ëª… ë³µì›ë˜ì—ˆìŠµë‹ˆë‹¤.`);
              } catch (e: unknown) {
                feedback.error(e instanceof Error ? e.message : "ë³µì› ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
              } finally {
                setDeleting(false);
              }
            }}
          >
            {deleting ? "ë³µì› ì¤‘â€¦" : "ë³µì›"}
          </Button>
          <Button
            intent="danger"
            size="sm"
            disabled={selectedIds.length === 0 || deleting}
            onClick={async () => {
              if (selectedIds.length === 0) return;
              if (!window.confirm(`ì„ íƒí•œ ${selectedIds.length}ëª…ì„ ì¦‰ì‹œ ì˜êµ¬ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) return;
              setDeleting(true);
              try {
                const { deleted } = await bulkPermanentDeleteStudents(selectedIds);
                setSelectedIds([]);
                qc.invalidateQueries({ queryKey: ["students"] });
                feedback.success(`${deleted}ëª… ì˜êµ¬ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);
              } catch (e: unknown) {
                feedback.error(e instanceof Error ? e.message : "ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
              } finally {
                setDeleting(false);
              }
            }}
          >
            {deleting ? "ì‚­ì œ ì¤‘â€¦" : "ì¦‰ì‹œ ì‚­ì œ"}
          </Button>
        </>
      )}
    </div>

    {totalPages > 1 && (
      <div className="flex flex-wrap items-center gap-1 pl-1">
        {Array.from({ length: totalPages }, (_, i) => i + 1).map((p) => (
          <button
            key={p}
            type="button"
            onClick={() => setPage(p)}
            style={{
              minWidth: 32,
              height: 32,
              padding: "0 8px",
              fontSize: 13,
              fontWeight: page === p ? 700 : 500,
              borderRadius: 6,
              border: page === p ? "2px solid var(--color-primary)" : "1px solid var(--color-border-divider)",
              background: page === p ? "var(--state-selected-bg)" : "var(--color-bg-surface)",
              color: page === p ? "var(--color-primary)" : "var(--color-text-secondary)",
              cursor: "pointer",
            }}
          >
            {p}
          </button>
        ))}
      </div>
    )}
    </div>
  );

  return (
    <>
      <div className="flex flex-col gap-4">
        <DomainListToolbar
          totalLabel={
            isLoading ? (
              "â€¦"
            ) : isDeletedTab ? (
              // SSOT ë””ìì¸ ì˜ˆì™¸: ì‚­ì œëœ í•™ìƒ íƒ­ì—ì„œë§Œ ì´ê³„ ì¢Œì¸¡ì— ì¤‘ë³µ ì •ë¦¬(ìƒˆë¡œê³ ì¹¨) ì•„ì´ì½˜ ë…¸ì¶œ
              <span style={{ display: "inline-flex", alignItems: "center", gap: 8 }}>
                <button
                  type="button"
                  title="ì¤‘ë³µ ì •ë¦¬"
                  aria-label="ì¤‘ë³µ ì •ë¦¬"
                  disabled={deleting || duplicateFixing}
                  onClick={async () => {
                    try {
                      const r = await checkDeletedStudentDuplicates();
                      if (r.records_to_remove === 0) return;
                      setDuplicateFixing(true);
                      await fixDeletedStudentDuplicates();
                      qc.invalidateQueries({ queryKey: ["students"] });
                    } catch {
                      // ì¡°ìš©íˆ ì‹¤íŒ¨ â€” ì‚¬ìš©ìì—ê²Œ ë²„ê·¸ ì¡´ì¬ë¥¼ ë…¸ì¶œí•˜ì§€ ì•ŠìŒ
                    } finally {
                      setDuplicateFixing(false);
                    }
                  }}
                  style={{
                    display: "inline-flex",
                    alignItems: "center",
                    justifyContent: "center",
                    width: 28,
                    height: 28,
                    padding: 0,
                    border: "1px solid var(--color-border-divider)",
                    borderRadius: 6,
                    background: "var(--color-bg-surface)",
                    color: "var(--color-text-secondary)",
                    cursor: deleting || duplicateFixing ? "not-allowed" : "pointer",
                    opacity: deleting || duplicateFixing ? 0.6 : 1,
                  }}
                >
                  {duplicateFixing ? (
                    <span style={{ fontSize: 12 }}>â€¦</span>
                  ) : (
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" aria-hidden>
                      <path d="M23 4v6h-6M1 20v-6h6" />
                      <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15" />
                    </svg>
                  )}
                </button>
                <span>ì´ {totalCount}ëª… (30ì¼ í›„ ìë™ ì‚­ì œ)</span>
              </span>
            ) : (
              `ì´ ${totalCount}ëª…`
            )
          }
          searchSlot={
            <input
              className="ds-input"
              placeholder="ì´ë¦„ / ì•„ì´ë”” / ì „í™”ë²ˆí˜¸ / í•™êµ ê²€ìƒ‰"
              value={searchInput}
              onChange={(e) => setSearchInput(e.target.value)}
              style={{ maxWidth: 360 }}
            />
          }
          filterSlot={
            <Button intent="secondary" onClick={() => setShowFilter(true)}>
              ê³ ê¸‰ í•„í„°{activeFilterCount ? ` (${activeFilterCount})` : ""}
            </Button>
          }
          primaryAction={
            !isDeletedTab ? (
              <Button intent="primary" onClick={() => setShowCreate(true)}>
                í•™ìƒ ì¶”ê°€
              </Button>
            ) : null
          }
          belowSlot={selectionBar}
        />

        {/* ì—‘ì…€ ì—…ë¡œë“œ ì§„í–‰ë°” (ëª¨ë‹¬ ë‹«ê³  ì§„í–‰ ì¤‘ì¼ ë•Œ) */}
        {bulkUploadProgress && !showCreate && (
          <div
            style={{
              marginBottom: 12,
              padding: "12px 16px",
              background: "color-mix(in srgb, var(--color-primary) 8%, var(--color-bg-surface))",
              border: "1px solid color-mix(in srgb, var(--color-primary) 25%, var(--color-border-divider))",
              borderRadius: 12,
              display: "flex",
              alignItems: "center",
              gap: 16,
            }}
          >
            <div style={{ flex: 1, minWidth: 0 }}>
              <div
                style={{
                  height: 8,
                  background: "var(--color-bg-surface-soft)",
                  borderRadius: 4,
                  overflow: "hidden",
                  marginBottom: 4,
                }}
              >
                <div
                  style={{
                    width: `${(bulkUploadProgress.current / bulkUploadProgress.total) * 100}%`,
                    height: "100%",
                    background: "var(--color-primary)",
                    transition: "width 0.3s ease",
                  }}
                />
              </div>
              <span style={{ fontSize: 13, fontWeight: 700, color: "var(--color-primary)" }}>
                í•™ìƒ ë“±ë¡ ì¤‘â€¦ {Math.round((bulkUploadProgress.current / bulkUploadProgress.total) * 100)}%
                ({bulkUploadProgress.current}/{bulkUploadProgress.total}ëª…)
              </span>
            </div>
          </div>
        )}

        {/* í…Œì´ë¸” */}
        <div>
          {isLoading ? (
            <EmptyState scope="panel" tone="loading" title="ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦" />
          ) : data?.length ? (
            <StudentsTable
              data={data}
              search={search}
              sort={sort}
              onSortChange={setSort}
              onRowClick={(id) => !isDeletedTab && navigate(`/admin/students/${id}`)}
              selectedIds={selectedIds}
              onSelectionChange={setSelectedIds}
              isDeletedTab={isDeletedTab}
              onToggleActive={
                !isDeletedTab
                  ? (id, nextActive) => toggleActiveMutation.mutate({ id, nextActive })
                  : undefined
              }
              togglingId={togglingId ?? undefined}
            />
          ) : (
            <EmptyState
              scope="panel"
              tone="empty"
              title={isDeletedTab ? "ì‚­ì œëœ í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤" : "í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤"}
              description={
                isDeletedTab
                  ? "ì‚­ì œí•œ í•™ìƒì€ 30ì¼ê°„ ì—¬ê¸°ì— ë³´ê´€ë©ë‹ˆë‹¤."
                  : "í•™ìƒì„ ë“±ë¡í•˜ë©´ ëª©ë¡/ê²€ìƒ‰/ì´ë ¥ ê´€ë¦¬ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤."
              }
              actions={
                !isDeletedTab ? (
                  <Button intent="primary" onClick={() => setShowCreate(true)}>
                    í•™ìƒ ì¶”ê°€
                  </Button>
                ) : undefined
              }
            />
          )}
        </div>
      </div>

      {/* MODALS */}
      <StudentCreateModal
        open={showCreate}
        onClose={() => setShowCreate(false)}
        onSuccess={() => {
          setShowCreate(false);
          setBulkUploadProgress(null);
          qc.invalidateQueries({ queryKey: ["students"] });
        }}
        onBulkProgress={setBulkUploadProgress}
      />

      <StudentFilterModal
        open={showFilter}
        filters={filters}
        onClose={() => setShowFilter(false)}
        onApply={(next) => {
          setFilters(next);
          setShowFilter(false);
        }}
      />
    </>
  );
}
