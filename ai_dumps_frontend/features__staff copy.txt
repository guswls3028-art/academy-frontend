====================================================================================================
# FRONTEND FOLDER: features__staff copy
# ROOT PATH: C:\academyfront\src\features\staff copy
====================================================================================================


==========================================================================================
# FILE: index.ts
==========================================================================================
// PATH: src/features/staff/index.ts
export { default as StaffPage } from "./pages/StaffPage";
export { default as StaffDetailPage } from "./pages/StaffDetailPage";


==========================================================================================
# FILE: api/payrollSnapshot.api.ts
==========================================================================================
// PATH: src/features/staff/api/payrollSnapshot.api.ts
import api from "@/shared/api/axios";

/* =========================
 * Types
 * ========================= */

export type PayrollSnapshot = {
  id: number;
  staff: number;
  staff_name?: string;
  year: number;
  month: number;

  work_hours: number;
  work_amount: number;
  approved_expense_amount: number;
  total_amount: number;

  generated_by?: number;
  generated_by_name?: string;
  created_at: string;
};

/* =========================
 * APIs (READ ONLY)
 * ========================= */

// ì›”ë³„/ì—°ë„ë³„ ìŠ¤ëƒ…ìƒ· ì¡°íšŒ
export async function fetchPayrollSnapshots(params: {
  year?: number;
  month?: number;
  staff?: number;
}) {
  const cleanParams: any = {};
  if (params.staff != null) cleanParams.staff = params.staff;
  if (params.year != null) cleanParams.year = params.year;
  if (params.month != null) cleanParams.month = params.month;

  const res = await api.get("/payroll-snapshots/", { params: cleanParams });
  return res.data as PayrollSnapshot[];
}

// ì›”ë³„ ìŠ¤ëƒ…ìƒ· ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
export async function exportPayrollSnapshotExcel(params: {
  year: number;
  month: number;
}) {
  const res = await api.get("/payroll-snapshots/export-excel/", {
    params,
    responseType: "blob",
  });

  const blob = new Blob([res.data], {
    type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
  });

  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `payroll_${params.year}_${String(params.month).padStart(2, "0")}.xlsx`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}


==========================================================================================
# FILE: api/payrollSnapshotPdf.api.ts
==========================================================================================
// PATH: src/features/staff/api/payrollSnapshotPdf.api.ts
import api from "@/shared/api/axios";

/**
 * PayrollSnapshot ê¸°ë°˜ PDF ê¸‰ì—¬ëª…ì„¸ì„œ ë‹¤ìš´ë¡œë“œ
 * Backend Single Source of Truth
 */
export async function exportPayrollSnapshotPdf(params: {
  staff: number;
  year: number;
  month: number;
}) {
  const res = await api.get("/payroll-snapshots/export-pdf/", {
    params,
    responseType: "blob",
  });

  const blob = new Blob([res.data], { type: "application/pdf" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = `payroll_${params.staff}_${params.year}_${String(
    params.month
  ).padStart(2, "0")}.pdf`;
  document.body.appendChild(a);
  a.click();
  a.remove();

  URL.revokeObjectURL(url);
}


==========================================================================================
# FILE: api/staff.api.ts
==========================================================================================
// PATH: src/features/staff/api/staff.api.ts
import api from "@/shared/api/axios";

/* =========================
 * Types
 * ========================= */

export type Staff = {
  id: number;
  name: string;
  phone: string;
  is_active: boolean;
  is_manager: boolean;
  pay_type: "HOURLY" | "MONTHLY";
};

export type StaffSummary = {
  staff_id: number;
  work_hours: number;
  work_amount: number;
  expense_amount: number;
  total_amount: number;
};

/* =========================
 * APIs
 * ========================= */

// ì§ì› ëª©ë¡
export const fetchStaffs = async (params?: {
  search?: string;
  is_active?: boolean;
  is_manager?: boolean;
  pay_type?: string;
}) => {
  const res = await api.get("/staffs/", { params });
  return res.data as Staff[];
};

// ì§ì› ìš”ì•½ (ê¸°ê°„ ê¸°ì¤€)
export const fetchStaffSummary = async (
  staffId: number,
  params: { date_from: string; date_to: string }
) => {
  const res = await api.get(`/staffs/${staffId}/summary/`, { params });
  return res.data as StaffSummary;
};


==========================================================================================
# FILE: api/staff.detail.api.ts
==========================================================================================
// PATH: src/features/staff/api/staff.detail.api.ts
import api from "@/shared/api/axios";
import { Staff, StaffSummary } from "./staff.api";

export type StaffDetail = Staff & {
  user: number | null;

  // ğŸ”¥ ì¶”ê°€ (read-only)
  user_username?: string | null;
  user_is_staff?: boolean;

  created_at?: string;
  updated_at?: string;
};

export const fetchStaffDetail = async (id: number) => {
  const res = await api.get(`/staffs/${id}/`);
  return res.data as StaffDetail;
};

export const patchStaffDetail = async (
  id: number,
  payload: Partial<StaffDetail>
) => {
  const res = await api.patch(`/staffs/${id}/`, payload);
  return res.data as StaffDetail;
};

export const fetchStaffSummaryByRange = async (
  staffId: number,
  date_from: string,
  date_to: string
) => {
  const res = await api.get(`/staffs/${staffId}/summary/`, {
    params: { date_from, date_to },
  });
  return res.data as StaffSummary;
};


==========================================================================================
# FILE: api/staffExpense.api.ts
==========================================================================================
// PATH: src/features/staff/api/staffExpense.api.ts
import api from "@/shared/api/axios";

export type ExpenseStatus = "PENDING" | "APPROVED" | "REJECTED";

export type ExpenseRecord = {
  id: number;
  staff: number;
  staff_name?: string;
  date: string; // YYYY-MM-DD
  title: string;
  amount: number;
  memo: string;
  status: ExpenseStatus;

  approved_at?: string | null;
  approved_by?: number | null;
  approved_by_name?: string | null;

  created_at?: string;
  updated_at?: string;
};

export const fetchExpenses = async (params: {
  staff: number;
  date_from: string;
  date_to: string;
  status?: ExpenseStatus;
}) => {
  const res = await api.get("/expense-records/", { params });
  return res.data as ExpenseRecord[];
};

export const createExpense = async (payload: {
  staff: number;
  date: string;
  title: string;
  amount: number;
  memo?: string;
  status?: ExpenseStatus; // ê´€ë¦¬ì UXìš© (ê¸°ë³¸ì€ PENDING)
}) => {
  const res = await api.post("/expense-records/", payload);
  return res.data as ExpenseRecord;
};

export const patchExpense = async (
  id: number,
  payload: Partial<{
    date: string;
    title: string;
    amount: number;
    memo: string;
    status: ExpenseStatus;
  }>
) => {
  try {
    const res = await api.patch(`/expense-records/${id}/`, payload);
    return res.data as ExpenseRecord;
  } catch (e: any) {
    const msg =
      e?.response?.data?.message ||
      e?.response?.data?.detail ||
      "ë¹„ìš©ì„ ìˆ˜ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
    alert(msg);
    throw e;
  }
};

export const deleteExpense = async (id: number) => {
  try {
    await api.delete(`/expense-records/${id}/`);
    return true;
  } catch (e: any) {
    const msg =
      e?.response?.data?.message ||
      e?.response?.data?.detail ||
      "ë¹„ìš©ì„ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
    alert(msg);
    throw e;
  }
};


==========================================================================================
# FILE: api/staffMe.api.ts
==========================================================================================
// PATH: src/features/staff/api/staffMe.api.ts
import api from "@/shared/api/axios";

export type StaffMe = {
  is_authenticated: boolean;
  is_superuser: boolean;
  is_staff: boolean;
  is_payroll_manager: boolean;
};

export async function fetchStaffMe() {
  const res = await api.get("/staffs/me/");
  return res.data as StaffMe;
}


==========================================================================================
# FILE: api/staffReport.api.ts
==========================================================================================
// PATH: src/features/staff/api/staffReport.api.ts
import { fetchStaffDetail } from "./staff.detail.api";
import { fetchStaffSummaryByRange } from "./staff.detail.api";
import { fetchWorkRecords } from "./staffWorkRecord.api";
import { fetchExpenses } from "./staffExpense.api";

function toSafeNumber(v: any) {
  const n = Number(v);
  return Number.isFinite(n) ? n : 0;
}

function downloadBlob(filename: string, blob: Blob) {
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

// âœ… SheetJS(xlsx) ê¸°ë°˜. í”„ë¡œì íŠ¸ì— xlsx ì—†ìœ¼ë©´ ì•ˆë‚´ alert
export async function exportStaffReportXlsx(params: {
  staffId: number;
  date_from: string;
  date_to: string;
}) {
  let XLSX: any;
  try {
    XLSX = await import("xlsx");
  } catch {
    alert('ì—‘ì…€ ë‹¤ìš´ë¡œë“œë¥¼ ìœ„í•´ "xlsx" íŒ¨í‚¤ì§€ê°€ í•„ìš”í•©ë‹ˆë‹¤.\n\nnpm i xlsx');
    return;
  }

  const { staffId, date_from, date_to } = params;

  const [staff, summary, workRecords, expenses] = await Promise.all([
    fetchStaffDetail(staffId),
    fetchStaffSummaryByRange(staffId, date_from, date_to),
    fetchWorkRecords({ staff: staffId, date_from, date_to }),
    fetchExpenses({ staff: staffId, date_from, date_to }),
  ]);

  const wb = XLSX.utils.book_new();

  // Sheet 1: Summary
  const summaryRows = [
    ["Staff ID", staff.id],
    ["Name", staff.name],
    ["Phone", staff.phone || ""],
    ["Pay Type", staff.pay_type],
    ["Range", `${date_from} ~ ${date_to}`],
    [],
    ["Work Hours", toSafeNumber(summary.work_hours)],
    ["Work Amount", toSafeNumber(summary.work_amount)],
    ["Expense Amount", toSafeNumber(summary.expense_amount)],
    ["Total Amount", toSafeNumber(summary.total_amount)],
  ];
  const wsSummary = XLSX.utils.aoa_to_sheet(summaryRows);
  XLSX.utils.book_append_sheet(wb, wsSummary, "Summary");

  // Sheet 2: WorkRecords
  const wrRows = (workRecords ?? []).map((r) => ({
    id: r.id,
    date: r.date,
    work_type: r.work_type_name ?? r.work_type,
    start_time: (r.start_time || "").slice(0, 5),
    end_time: (r.end_time || "").slice(0, 5),
    break_minutes: toSafeNumber(r.break_minutes),
    work_hours: r.work_hours ?? "",
    amount: toSafeNumber(r.amount),
    memo: r.memo ?? "",
  }));
  const wsWR = XLSX.utils.json_to_sheet(wrRows);
  XLSX.utils.book_append_sheet(wb, wsWR, "WorkRecords");

  // Sheet 3: Expenses
  const exRows = (expenses ?? []).map((e) => ({
    id: e.id,
    date: e.date,
    title: e.title,
    amount: toSafeNumber(e.amount),
    status: e.status,
    memo: e.memo ?? "",
  }));
  const wsEX = XLSX.utils.json_to_sheet(exRows);
  XLSX.utils.book_append_sheet(wb, wsEX, "Expenses");

  const filename = `staff_report_${staff.id}_${date_from}_${date_to}.xlsx`;
  const out = XLSX.write(wb, { bookType: "xlsx", type: "array" });
  downloadBlob(
    filename,
    new Blob([out], {
      type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
    })
  );
}


==========================================================================================
# FILE: api/staffWorkMonthLock.api.ts
==========================================================================================
// PATH: src/features/staff/api/staffWorkMonthLock.api.ts
import api from "@/shared/api/axios";

export type WorkMonthLock = {
  id: number;
  staff: number;
  staff_name?: string;
  year: number;
  month: number;
  is_locked: boolean;
  locked_by?: number;
  locked_by_name?: string;
  created_at?: string;
};

/**
 * íŠ¹ì • ì§ì›ì˜ ì›” ë§ˆê° ì¡°íšŒ (ë˜ëŠ” ê´€ë¦¬ì: staff ì—†ì´ ì¡°íšŒ)
 */
export async function fetchWorkMonthLocks(params: {
  staff?: number;
  year: number;
  month: number;
}) {
  const res = await api.get("/staffs/work-month-locks/", { params })
;
  return res.data as WorkMonthLock[];
}

/**
 * ì›” ë§ˆê° ì‹¤í–‰ (ê´€ë¦¬ì)
 */
export async function lockWorkMonth(payload: {
  staff: number;
  year: number;
  month: number;
}) {
  const res = await api.post("/work-month-locks/", payload);
  return res.data as WorkMonthLock;
}

/**
 * ë°±ì—”ë“œ ê¸°ì¤€ ë§ˆê° ì—¬ë¶€
 */
export function isLockedFromLocks(
  locks: WorkMonthLock[] | undefined
): boolean {
  if (!locks || locks.length === 0) return false;
  return locks.some((l) => !!l.is_locked);
}


==========================================================================================
# FILE: api/staffWorkRecord.api.ts
==========================================================================================
// PATH: src/features/staff/api/staffWorkRecord.api.ts
import api from "@/shared/api/axios";

export type WorkRecord = {
  id: number;
  staff: number;
  staff_name?: string;
  work_type: number;
  work_type_name?: string;
  date: string; // YYYY-MM-DD
  start_time: string; // HH:MM:SS (or HH:MM)
  end_time: string;
  break_minutes: number;
  work_hours: string | number | null; // decimal
  amount: number | null;
  memo: string;
  created_at?: string;
  updated_at?: string;
};

export const fetchWorkRecords = async (params: {
  staff: number;
  date_from: string;
  date_to: string;
}) => {
  const res = await api.get("/work-records/", { params });
  return res.data as WorkRecord[];
};

export const createWorkRecord = async (payload: {
  staff: number;
  work_type: number;
  date: string;
  start_time: string;
  end_time: string;
  break_minutes?: number;
  memo?: string;
}) => {
  const res = await api.post("/work-records/", payload);
  return res.data as WorkRecord;
};

export const patchWorkRecord = async (
  id: number,
  payload: Partial<{
    work_type: number;
    date: string;
    start_time: string;
    end_time: string;
    break_minutes: number;
    memo: string;
  }>
) => {
  const res = await api.patch(`/work-records/${id}/`, payload);
  return res.data as WorkRecord;
};

export const deleteWorkRecord = async (id: number) => {
  await api.delete(`/work-records/${id}/`);
  return true;
};


==========================================================================================
# FILE: api/staffWorkType.api.ts
==========================================================================================
// PATH: src/features/staff/api/staffWorkType.api.ts
import api from "@/shared/api/axios";

export type WorkType = {
  id: number;
  name: string;
  base_hourly_wage: number;
  color: string;
  is_active?: boolean;
};

export type StaffWorkType = {
  id: number;
  staff: number;
  work_type: WorkType;
  hourly_wage: number | null;
  effective_hourly_wage: number;
  created_at?: string;
  updated_at?: string;
};

export const fetchWorkTypes = async (params?: { is_active?: boolean }) => {
  const res = await api.get("/staffs/work-types/", { params });
  return res.data as WorkType[];
};

export const fetchStaffWorkTypes = async (staffId: number) => {
  const res = await api.get(`/staffs/${staffId}/work-types/`);
  return res.data as StaffWorkType[];
};

export const createStaffWorkType = async (
  staffId: number,
  payload: { work_type_id: number; hourly_wage?: number | null }
) => {
  const res = await api.post(`/staffs/${staffId}/work-types/`, payload);
  // backendëŠ” ìƒì„± í›„ í•´ë‹¹ staffì˜ ì „ì²´ ëª©ë¡ì„ ë°˜í™˜
  return res.data as StaffWorkType[];
};

export const patchStaffWorkType = async (
  id: number,
  payload: { hourly_wage?: number | null }
) => {
  const res = await api.patch(`/staff-work-types/${id}/`, payload);
  return res.data as StaffWorkType;
};

export const deleteStaffWorkType = async (id: number) => {
  await api.delete(`/staff-work-types/${id}/`);
  return true;
};


==========================================================================================
# FILE: components/ExpenseEditModal.tsx
==========================================================================================
// PATH: src/features/staff/components/ExpenseEditModal.tsx
import { useEffect, useMemo, useState } from "react";
import { ExpenseRecord, ExpenseStatus } from "../api/staffExpense.api";

function todayISO() {
  return new Date().toISOString().slice(0, 10);
}

const STATUS_LABEL: Record<ExpenseStatus, string> = {
  PENDING: "ëŒ€ê¸°",
  APPROVED: "ìŠ¹ì¸",
  REJECTED: "ë°˜ë ¤",
};

export default function ExpenseEditModal({
  open,
  title,
  staffId,
  initialValue,
  isManager,
  onClose,
  onSubmit,
  onDelete,
}: {
  open: boolean;
  title: string;
  staffId: number;
  initialValue?: ExpenseRecord;
  isManager: boolean;
  onClose: () => void;
  onSubmit: (payload: {
    staff: number;
    date: string;
    title: string;
    amount: number;
    memo: string;
    status: ExpenseStatus;
  }) => Promise<void>;
  onDelete?: () => Promise<void>;
}) {
  const isEdit = !!initialValue;
  const locked =
    initialValue?.status === "APPROVED" || initialValue?.status === "REJECTED";

  const [form, setForm] = useState({
    date: "",
    title: "",
    amount: 0,
    memo: "",
    status: "PENDING" as ExpenseStatus,
  });

  const computedTitle = useMemo(() => {
    if (locked) return "ì²˜ë¦¬ ì™„ë£Œëœ ë¹„ìš©";
    return isEdit ? title : title || "ë¹„ìš© ë“±ë¡";
  }, [locked, isEdit, title]);

  useEffect(() => {
    if (!open) return;

    if (initialValue) {
      setForm({
        date: initialValue.date,
        title: initialValue.title ?? "",
        amount: Number(initialValue.amount ?? 0),
        memo: initialValue.memo ?? "",
        status: initialValue.status ?? "PENDING",
      });
    } else {
      setForm({
        date: todayISO(),
        title: "",
        amount: 0,
        memo: "",
        status: "PENDING",
      });
    }
  }, [open, initialValue]);

  if (!open) return null;

  const statusDisabledReason = locked
    ? "ìŠ¹ì¸/ë°˜ë ¤ëœ ë¹„ìš©ì€ ìƒíƒœ ë³€ê²½ì´ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤."
    : !isManager
    ? "ìŠ¹ì¸/ë°˜ë ¤ëŠ” ê´€ë¦¬ìë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤."
    : "";

  const submit = async () => {
    if (locked) {
      alert("ìŠ¹ì¸ ë˜ëŠ” ë°˜ë ¤ëœ ë¹„ìš©ì€ ìˆ˜ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
      return;
    }

    if (!form.date) return alert("ë‚ ì§œëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.");
    if (!form.title.trim()) return alert("í•­ëª©ëª…ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.");
    const amt = Number(form.amount);
    if (Number.isNaN(amt) || amt < 0)
      return alert("ê¸ˆì•¡ì€ 0 ì´ìƒ ìˆ«ìì—¬ì•¼ í•©ë‹ˆë‹¤.");

    await onSubmit({
      staff: staffId,
      date: form.date,
      title: form.title.trim(),
      amount: amt,
      memo: form.memo ?? "",
      status: isManager ? form.status : "PENDING",
    });

    onClose();
  };

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/40 p-4">
      <div className="w-full max-w-[560px] rounded-2xl bg-[var(--bg-surface)] shadow-2xl overflow-hidden">
        <div className="border-b border-[var(--border-divider)] px-5 py-3">
          <div className="text-sm font-semibold text-[var(--text-primary)]">
            {computedTitle}
          </div>
          {initialValue?.approved_at && (
            <div className="mt-1 text-xs text-[var(--text-muted)]">
              ìŠ¹ì¸ì: <b>{initialValue.approved_by_name || "-"}</b> Â· ìŠ¹ì¸ì‹œê°:{" "}
              <b>{new Date(initialValue.approved_at).toLocaleString()}</b>
            </div>
          )}
        </div>

        <div className="px-5 py-4 space-y-3">
          {locked && (
            <div className="rounded-lg border border-red-300 bg-red-50 px-4 py-3 text-sm text-red-700 font-semibold">
              ìŠ¹ì¸ ë˜ëŠ” ë°˜ë ¤ëœ ë¹„ìš©ì€ ìˆ˜ì •Â·ì‚­ì œê°€ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.
            </div>
          )}

          {!isManager && !locked && (
            <div className="rounded-lg border border-blue-200 bg-blue-50 px-4 py-3 text-sm text-blue-700 font-semibold">
              * ì¼ë°˜ ì‚¬ìš©ìëŠ” ë¹„ìš©ì„ ë“±ë¡í•  ìˆ˜ ìˆì§€ë§Œ, ìŠ¹ì¸/ë°˜ë ¤ëŠ” ê´€ë¦¬ìë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.
            </div>
          )}

          <div className="grid grid-cols-2 gap-3">
            <input
              type="date"
              disabled={locked}
              value={form.date}
              onChange={(e) =>
                setForm((p) => ({ ...p, date: e.target.value }))
              }
              className="input"
            />

            <select
              disabled={!!statusDisabledReason}
              title={statusDisabledReason}
              value={form.status}
              onChange={(e) =>
                setForm((p) => ({
                  ...p,
                  status: e.target.value as ExpenseStatus,
                }))
              }
              className="input"
            >
              <option value="PENDING">{STATUS_LABEL.PENDING}</option>
              <option value="APPROVED">{STATUS_LABEL.APPROVED}</option>
              <option value="REJECTED">{STATUS_LABEL.REJECTED}</option>
            </select>
          </div>

          <input
            disabled={locked}
            value={form.title}
            onChange={(e) =>
              setForm((p) => ({ ...p, title: e.target.value }))
            }
            className="input"
            placeholder="í•­ëª©ëª…"
          />

          <input
            type="number"
            min={0}
            disabled={locked}
            value={form.amount}
            onChange={(e) =>
              setForm((p) => ({ ...p, amount: Number(e.target.value) }))
            }
            className="input"
            placeholder="ê¸ˆì•¡"
          />

          <textarea
            disabled={locked}
            rows={3}
            value={form.memo}
            onChange={(e) =>
              setForm((p) => ({ ...p, memo: e.target.value }))
            }
            className="input resize-none"
            placeholder="ë©”ëª¨ (ì˜µì…˜)"
          />
        </div>

        <div className="flex justify-between items-center gap-2 px-5 py-3 border-t border-[var(--border-divider)]">
          <div>
            {isEdit && onDelete && !locked && (
              <button
                onClick={async () => {
                  if (!confirm("ì‚­ì œí• ê¹Œìš”?")) return;
                  await onDelete();
                  onClose();
                }}
                className="px-3 py-1.5 text-sm rounded-md border border-[var(--color-danger)] text-[var(--color-danger)] hover:bg-[var(--color-danger)]/10"
              >
                ì‚­ì œ
              </button>
            )}
          </div>

          <div className="flex gap-2">
            <button onClick={onClose} className="btn-secondary">
              ë‹«ê¸°
            </button>

            {!locked && (
              <button onClick={submit} className="btn-primary">
                {isEdit ? "ì €ì¥" : "ë“±ë¡"}
              </button>
            )}
          </div>
        </div>
      </div>
    </div>
  );
}


==========================================================================================
# FILE: components/StaffCreateModal.tsx
==========================================================================================
// PATH: src/features/staff/components/StaffCreateModal.tsx
import { useState } from "react";
import api from "@/shared/api/axios";

type Role = "TEACHER" | "ASSISTANT";

export default function StaffCreateModal({
  open,
  onClose,
  onSuccess,
}: {
  open: boolean;
  onClose: () => void;
  onSuccess: () => void;
}) {
  if (!open) return null;

  const [form, setForm] = useState({
    name: "",
    phone: "",
    username: "",
    password: "",
    role: "ASSISTANT" as Role,
  });

  const submit = async () => {
    if (!form.name.trim()) return alert("ì´ë¦„ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.");
    if (!form.username.trim()) return alert("ì•„ì´ë””ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.");
    if (!form.password.trim()) return alert("ë¹„ë°€ë²ˆí˜¸ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.");

    await api.post("/staffs/", {
      name: form.name.trim(),
      phone: form.phone.trim(),
      username: form.username.trim(),
      password: form.password,
      role: form.role,
    });

    onSuccess();
    onClose();
  };

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/40 p-4">
      <div className="w-full max-w-[480px] rounded-2xl bg-[var(--bg-surface)] shadow-2xl overflow-hidden">
        <div className="border-b border-[var(--border-divider)] px-5 py-3">
          <div className="text-sm font-semibold text-[var(--text-primary)]">
            ì§ì› ë“±ë¡
          </div>
          <div className="mt-1 text-xs text-[var(--text-muted)]">
            * ì§ì› ë“±ë¡ ì‹œ ê³„ì •(User)ë„ í•¨ê»˜ ìƒì„±ë©ë‹ˆë‹¤.
          </div>
        </div>

        <div className="px-5 py-4 space-y-3">
          <input
            placeholder="ì´ë¦„"
            value={form.name}
            onChange={(e) => setForm((p) => ({ ...p, name: e.target.value }))}
            className="h-[40px] w-full rounded-lg border border-[var(--border-divider)] bg-[var(--bg-app)] px-3 text-sm outline-none"
          />

          <input
            placeholder="ì „í™”ë²ˆí˜¸"
            value={form.phone}
            onChange={(e) => setForm((p) => ({ ...p, phone: e.target.value }))}
            className="h-[40px] w-full rounded-lg border border-[var(--border-divider)] bg-[var(--bg-app)] px-3 text-sm outline-none"
          />

          <input
            placeholder="ì•„ì´ë”” (ë¡œê·¸ì¸ ID)"
            value={form.username}
            onChange={(e) =>
              setForm((p) => ({ ...p, username: e.target.value }))
            }
            className="h-[40px] w-full rounded-lg border border-[var(--border-divider)] bg-[var(--bg-app)] px-3 text-sm outline-none"
          />

          <input
            type="password"
            placeholder="ë¹„ë°€ë²ˆí˜¸"
            value={form.password}
            onChange={(e) =>
              setForm((p) => ({ ...p, password: e.target.value }))
            }
            className="h-[40px] w-full rounded-lg border border-[var(--border-divider)] bg-[var(--bg-app)] px-3 text-sm outline-none"
          />

          <div>
            <div className="text-xs font-medium text-[var(--text-muted)] mb-1">
              ì—­í• 
            </div>
            <select
              value={form.role}
              onChange={(e) =>
                setForm((p) => ({ ...p, role: e.target.value as Role }))
              }
              className="h-[40px] w-full rounded-lg border border-[var(--border-divider)] bg-[var(--bg-app)] px-3 text-sm outline-none"
            >
              <option value="ASSISTANT">ì¡°êµ</option>
              <option value="TEACHER">ê°•ì‚¬</option>
            </select>
            <div className="mt-1 text-[11px] text-[var(--text-muted)]">
              * ê°•ì‚¬ëŠ” ì›”ê¸‰(MONTHLY)ë¡œ, ì¡°êµëŠ” ì‹œê¸‰(HOURLY)ìœ¼ë¡œ ìë™ ì„¤ì •ë©ë‹ˆë‹¤.
            </div>
          </div>
        </div>

        <div className="flex justify-end gap-2 px-5 py-3 border-t border-[var(--border-divider)]">
          <button
            onClick={onClose}
            className="px-3 py-1.5 text-sm rounded-md border border-[var(--border-divider)] text-[var(--text-secondary)]"
          >
            ì·¨ì†Œ
          </button>
          <button
            onClick={submit}
            className="px-3 py-1.5 text-sm rounded-md bg-[var(--color-primary)] text-white"
          >
            ë“±ë¡
          </button>
        </div>
      </div>
    </div>
  );
}


==========================================================================================
# FILE: components/StaffDeleteButton.tsx
==========================================================================================
// PATH: src/features/staff/components/StaffDeleteButton.tsx
import api from "@/shared/api/axios";

type Props = {
  staffId: number;
  staffName: string;
  payType: "HOURLY" | "MONTHLY"; // MONTHLY = ê°•ì‚¬
  onDeleted: () => void;
};

export default function StaffDeleteButton({
  staffId,
  staffName,
  payType,
  onDeleted,
}: Props) {
  const onDelete = async () => {
    const isTeacher = payType === "MONTHLY";

    const message = isTeacher
      ? [
          `âš ï¸ ê°•ì‚¬ ì‚­ì œ ê²½ê³ `,
          ``,
          `ê°•ì‚¬ "${staffName}"ë¥¼ ì‚­ì œí•˜ë©´`,
          `- ì—°ê²°ëœ ê°•ì‚¬(Teacher) ì •ë³´`,
          `- ì—°ê²°ëœ ê³„ì •(User)`,
          `ëª¨ë‘ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤.`,
          ``,
          `ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`,
        ].join("\n")
      : `ì¡°êµ "${staffName}"ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;

    const ok = window.confirm(message);
    if (!ok) return;

    await api.delete(`/staffs/${staffId}/`);
    onDeleted();
  };

  return (
    <button
      onClick={onDelete}
      className="px-3 py-1.5 text-sm rounded-md bg-red-600 text-white hover:opacity-90"
    >
      ì‚­ì œ
    </button>
  );
}


==========================================================================================
# FILE: components/StaffHeader.tsx
==========================================================================================
// PATH: src/features/staff/components/StaffHeader.tsx
import { PageToolbar } from "@/shared/ui/ds";
import { StaffFilters } from "../hooks/useStaffDomain";

export default function StaffHeader({
  rangeLabel,
  filters,
  setFilters,
  onRefresh,
  onCreate,
}: {
  rangeLabel: string;
  filters: StaffFilters;
  setFilters: (next: StaffFilters) => void;
  onRefresh: () => void;
  onCreate: () => void;
}) {
  return (
    <PageToolbar>
      <div className="flex flex-wrap items-end justify-between gap-4">
        {/* Left: filters */}
        <div className="flex flex-wrap items-end gap-3">
          <div className="space-y-1">
            <div className="text-xs font-medium text-[var(--text-muted)]">ê²€ìƒ‰</div>
            <input
              value={filters.search}
              onChange={(e) => setFilters({ ...filters, search: e.target.value })}
              className="h-[38px] w-[220px] rounded-lg border border-[var(--border-divider)] bg-[var(--bg-surface)] px-3 text-sm outline-none focus:border-[var(--color-primary)]"
              placeholder="ì´ë¦„/ì „í™”ë²ˆí˜¸"
            />
          </div>

          <div className="space-y-1">
            <div className="text-xs font-medium text-[var(--text-muted)]">ìƒíƒœ</div>
            <select
              value={filters.is_active}
              onChange={(e) =>
                setFilters({ ...filters, is_active: e.target.value as any })
              }
              className="h-[38px] w-[130px] rounded-lg border border-[var(--border-divider)] bg-[var(--bg-surface)] px-3 text-sm outline-none focus:border-[var(--color-primary)]"
            >
              <option value="ALL">ì „ì²´</option>
              <option value="ACTIVE">í™œì„±</option>
              <option value="INACTIVE">ë¹„í™œì„±</option>
            </select>
          </div>

          <div className="space-y-1">
            <div className="text-xs font-medium text-[var(--text-muted)]">ì—­í• </div>
            <select
              value={filters.is_manager}
              onChange={(e) =>
                setFilters({ ...filters, is_manager: e.target.value as any })
              }
              className="h-[38px] w-[130px] rounded-lg border border-[var(--border-divider)] bg-[var(--bg-surface)] px-3 text-sm outline-none focus:border-[var(--color-primary)]"
            >
              <option value="ALL">ì „ì²´</option>
              <option value="MANAGER">ê´€ë¦¬ì</option>
              <option value="STAFF">ì§ì›</option>
            </select>
          </div>

          <div className="space-y-1">
            <div className="text-xs font-medium text-[var(--text-muted)]">ê¸‰ì—¬</div>
            <select
              value={filters.pay_type}
              onChange={(e) =>
                setFilters({ ...filters, pay_type: e.target.value as any })
              }
              className="h-[38px] w-[130px] rounded-lg border border-[var(--border-divider)] bg-[var(--bg-surface)] px-3 text-sm outline-none focus:border-[var(--color-primary)]"
            >
              <option value="ALL">ì „ì²´</option>
              <option value="HOURLY">ì‹œê¸‰</option>
              <option value="MONTHLY">ì›”ê¸‰</option>
            </select>
          </div>

          <div className="pb-[2px] text-xs text-[var(--text-muted)]">
            {rangeLabel}
          </div>
        </div>

        {/* Right: actions */}
        <div className="flex items-center gap-2">
          <button
            onClick={onRefresh}
            className="h-[38px] px-4 rounded-lg border border-[var(--border-divider)] bg-[var(--bg-surface)] text-sm font-semibold hover:bg-[var(--bg-surface-soft)]"
          >
            ìƒˆë¡œê³ ì¹¨
          </button>

          <button onClick={onCreate} className="btn-primary">
            + ì§ì› ë“±ë¡
          </button>
        </div>
      </div>
    </PageToolbar>
  );
}


==========================================================================================
# FILE: components/StaffInfoPanel.tsx
==========================================================================================
// PATH: src/features/staff/components/StaffInfoPanel.tsx
import { StaffDetail } from "../api/staff.detail.api";

export default function StaffInfoPanel({ staff }: { staff: StaffDetail }) {
  return (
    <div className="space-y-2 text-sm">
      <Item label="ì´ë¦„" value={staff.name} />
      <Item label="ì „í™”ë²ˆí˜¸" value={staff.phone || "-"} />
      <Item label="ì—­í• " value={staff.pay_type === "MONTHLY" ? "ê°•ì‚¬" : "ì¡°êµ"} />
      <Item label="ìƒíƒœ" value={staff.is_active ? "í™œì„±" : "ë¹„í™œì„±"} />
      <Item
        label="ê¸‰ì—¬ íƒ€ì…"
        value={staff.pay_type === "HOURLY" ? "ì‹œê¸‰ì œ" : "ì›”ê¸‰ì œ"}
      />

      {/* ========================= */}
      {/* ğŸ”¥ ê³„ì • ì •ë³´ (READ ONLY) */}
      {/* ========================= */}
      <div className="pt-2 mt-2 border-t border-[var(--border-divider)] space-y-2">
        <div className="text-xs font-semibold text-[var(--text-muted)]">
          ê³„ì • ì •ë³´
        </div>

        {staff.user ? (
          <>
            <Item label="ì•„ì´ë””" value={staff.user_username || "-"} />

            <div className="flex justify-between gap-3">
              <span className="text-[var(--text-muted)]">ê¶Œí•œ</span>
              <span
                className={`px-2 py-0.5 rounded-full text-xs font-semibold ${
                  staff.user_is_staff
                    ? "bg-blue-100 text-blue-700"
                    : "bg-gray-200 text-gray-600"
                }`}
              >
                {staff.user_is_staff ? "STAFF ê¶Œí•œ" : "ì¼ë°˜ ì‚¬ìš©ì"}
              </span>
            </div>
          </>
        ) : (
          <div className="text-xs text-[var(--text-muted)] italic">
            ì—°ê²°ëœ ê³„ì • ì—†ìŒ
          </div>
        )}
      </div>
    </div>
  );
}

function Item({ label, value }: { label: string; value: string }) {
  return (
    <div className="flex justify-between gap-3">
      <span className="text-[var(--text-muted)]">{label}</span>
      <span className="font-semibold text-[var(--text-primary)]">
        {value}
      </span>
    </div>
  );
}


==========================================================================================
# FILE: components/StaffKpiCard.tsx
==========================================================================================
// PATH: src/features/staff/components/StaffKpiCard.tsx
import { Panel } from "@/shared/ui/ds";


export default function StaffKpiCard({
  staffCount,
  workHours,
  totalPay,
  totalExpense,
}: {
  staffCount: number;
  workHours: number;
  totalPay: number;
  totalExpense: number;
}) {
  return (
    <Card>
      <CardBody className="grid grid-cols-1 gap-3 sm:grid-cols-4">
        <Item label="ì§ì› ìˆ˜" value={`${staffCount.toLocaleString()} ëª…`} />
        <Item label="ì´ ê·¼ë¬´ì‹œê°„" value={`${workHours} h`} />
        <Item label="ì´ ê¸‰ì—¬" value={`${totalPay.toLocaleString()} ì›`} tone="primary" />
        <Item label="ì´ ë¹„ìš©" value={`${totalExpense.toLocaleString()} ì›`} />
      </CardBody>
    </Card>
  );
}

function Item({
  label,
  value,
  tone,
}: {
  label: string;
  value: string;
  tone?: "primary" | "normal";
}) {
  return (
    <div className="rounded-lg border border-[var(--border-divider)] bg-[var(--bg-surface-soft)] px-4 py-3">
      <div className="text-xs text-[var(--text-muted)]">{label}</div>
      <div
        className={[
          "mt-1 text-xl font-semibold",
          tone === "primary" ? "text-[var(--color-primary)]" : "text-[var(--text-primary)]",
        ].join(" ")}
      >
        {value}
      </div>
    </div>
  );
}


==========================================================================================
# FILE: components/StaffSummaryCard.tsx
==========================================================================================
// src/features/staff/components/StaffSummaryCard.tsx
import { Panel } from "@/shared/ui/ds";

import { StaffSummary } from "../api/staff.api";

export default function StaffSummaryCard({
  summary,
}: {
  summary?: StaffSummary;
}) {
  if (!summary) return null;

  return (
    <Card>
      <CardBody className="grid grid-cols-2 gap-4 sm:grid-cols-4">
        <Item label="ì´ë²ˆë‹¬ ê·¼ë¬´" value={`${summary.work_hours} h`} />
        <Item label="ê¸‰ì—¬" value={`${summary.work_amount.toLocaleString()} ì›`} />
        <Item label="ë¹„ìš©" value={`${summary.expense_amount.toLocaleString()} ì›`} />
        <Item
          label="ì‹¤ ì§€ê¸‰ì•¡"
          value={`${summary.total_amount.toLocaleString()} ì›`}
          primary
        />
      </CardBody>
    </Card>
  );
}

function Item({
  label,
  value,
  primary,
}: {
  label: string;
  value: string;
  primary?: boolean;
}) {
  return (
    <div className="rounded-lg border border-[var(--border-divider)] bg-[var(--bg-surface-soft)] px-4 py-3">
      <div className="text-xs text-[var(--text-muted)]">{label}</div>
      <div
        className={[
          "mt-1 text-lg font-semibold",
          primary
            ? "text-[var(--color-primary)]"
            : "text-[var(--text-primary)]",
        ].join(" ")}
      >
        {value}
      </div>
    </div>
  );
}


==========================================================================================
# FILE: components/StaffTable.tsx
==========================================================================================
// PATH: src/features/staff/components/StaffTable.tsx

import { useMemo } from "react";
import { useNavigate } from "react-router-dom";
import { lockWorkMonth } from "../api/staffWorkMonthLock.api";

interface Props {
  staffs: any[];
  summaries: Record<number, any>;
  me: any;
  loading: boolean;
  onRefresh?: () => Promise<void> | void;
}

function badgeTone(kind: "locked" | "open") {
  if (kind === "locked") return "bg-red-50 text-red-700 border-red-200";
  return "bg-green-50 text-green-700 border-green-200";
}

export function StaffTable({ staffs, summaries, me, loading, onRefresh }: Props) {
  const navigate = useNavigate();

  const canManagePayroll =
    !!me && (me.is_superuser || me.is_payroll_manager || me.is_staff);

  const rows = useMemo(() => staffs ?? [], [staffs]);

  if (loading) {
    return <div className="py-8 text-center text-[var(--text-muted)]">ë¡œë”©ì¤‘...</div>;
  }

  if (!rows.length) {
    return (
      <div className="rounded-xl border border-[var(--border-divider)] bg-[var(--bg-surface)] p-6 text-sm text-[var(--text-muted)]">
        í‘œì‹œí•  ì§ì›ì´ ì—†ìŠµë‹ˆë‹¤. í•„í„°ë¥¼ ë³€ê²½í•˜ê±°ë‚˜ ì§ì›ì„ ë“±ë¡í•´ ì£¼ì„¸ìš”.
      </div>
    );
  }

  return (
    <div className="overflow-hidden rounded-xl border border-[var(--border-divider)] bg-[var(--bg-surface)]">
      {/* Header */}
      <div className="grid grid-cols-[240px_140px_140px_160px_220px] gap-4 px-4 py-3 text-xs font-semibold text-[var(--text-muted)] border-b bg-[var(--bg-surface-soft)]">
        <div>ì§ì›</div>
        <div>ì›” ìƒíƒœ</div>
        <div>ìŠ¹ì¸ ëŒ€ê¸°</div>
        <div>ì´ë²ˆë‹¬ ìš”ì•½</div>
        <div className="text-right">ë¹ ë¥¸ ì‘ì—…</div>
      </div>

      {/* Body */}
      {rows.map((staff) => {
        const summary = summaries?.[staff.id];

        const isLocked = !!summary?.is_locked;
        const pendingCount = Number(summary?.pending_expense_count || 0);

        const year = Number(summary?.year);
        const month = Number(summary?.month);

        const lockDisabledReason = isLocked
          ? "ì´ë¯¸ ë§ˆê°ëœ ì›”ì…ë‹ˆë‹¤."
          : !canManagePayroll
          ? "ì›” ë§ˆê°ì€ ê´€ë¦¬ìë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤."
          : !Number.isFinite(year) || !Number.isFinite(month)
          ? "ë§ˆê° ì›” ì •ë³´(year/month)ê°€ ì—†ìŠµë‹ˆë‹¤. (summary ì‘ë‹µ í™•ì¸ í•„ìš”)"
          : "";

        return (
          <div
            key={staff.id}
            className="grid grid-cols-[240px_140px_140px_160px_220px] gap-4 px-4 py-3 text-sm border-b last:border-b-0 items-center"
          >
            {/* ì§ì› */}
            <div className="min-w-0">
              <div className="flex items-center gap-2">
                <div className="font-semibold truncate">{staff.name}</div>
                {!staff.is_active && (
                  <span className="px-2 py-0.5 rounded-full text-xs font-semibold border bg-gray-100 text-gray-700 border-gray-200">
                    ë¹„í™œì„±
                  </span>
                )}
              </div>
              <div className="text-xs text-[var(--text-muted)]">
                {staff.pay_type === "MONTHLY" ? "ê°•ì‚¬(ì›”ê¸‰)" : "ì¡°êµ(ì‹œê¸‰)"}
                {staff.phone ? ` Â· ${staff.phone}` : ""}
              </div>
            </div>

            {/* ì›” ìƒíƒœ */}
            <div>
              <span
                className={[
                  "inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-semibold border",
                  badgeTone(isLocked ? "locked" : "open"),
                ].join(" ")}
                title={isLocked ? "ë§ˆê°ë¨(ìˆ˜ì • ë¶ˆê°€)" : "ì§„í–‰ì¤‘"}
              >
                {isLocked ? "ğŸ”’ ë§ˆê°" : "ğŸ”“ ì§„í–‰ì¤‘"}
              </span>
            </div>

            {/* ìŠ¹ì¸ ëŒ€ê¸° */}
            <div>
              {pendingCount > 0 ? (
                <button
                  className="text-[var(--color-primary)] font-semibold hover:underline"
                  onClick={() => navigate(`/staffs/${staff.id}?tab=expenses`)}
                  title="ìŠ¹ì¸ ëŒ€ê¸° ë¹„ìš©ìœ¼ë¡œ ì´ë™"
                >
                  {pendingCount}ê±´
                </button>
              ) : (
                <span className="text-[var(--text-muted)]">â€”</span>
              )}
            </div>

            {/* ì´ë²ˆë‹¬ ìš”ì•½ */}
            <div>
              <div className="text-xs text-[var(--text-muted)]">
                ê·¼ë¬´ {Number(summary?.work_hours || 0)}h
              </div>
              <div className="font-semibold">
                {(Number(summary?.total_amount || 0) || 0).toLocaleString()}ì›
              </div>
            </div>

            {/* ì‘ì—… */}
            <div className="flex justify-end gap-2">
              <button
                className="h-[32px] px-3 rounded-lg border border-[var(--border-divider)] text-xs font-semibold hover:bg-[var(--bg-surface-soft)]"
                onClick={() => navigate(`/staffs/${staff.id}?tab=work-records`)}
                title="ê·¼ë¬´ê¸°ë¡ìœ¼ë¡œ ì´ë™"
              >
                ê·¼ë¬´
              </button>

              <button
                className="h-[32px] px-3 rounded-lg border border-[var(--border-divider)] text-xs font-semibold hover:bg-[var(--bg-surface-soft)]"
                onClick={() => navigate(`/staffs/${staff.id}?tab=expenses`)}
                title="ë¹„ìš©ìœ¼ë¡œ ì´ë™"
              >
                ë¹„ìš©
              </button>

              <button
                disabled={!!lockDisabledReason}
                title={
                  lockDisabledReason ||
                  "ì´ë²ˆ ë‹¬ ê·¼ë¬´/ë¹„ìš©ì„ í™•ì •(ë§ˆê°)í•©ë‹ˆë‹¤. ì´í›„ ìˆ˜ì •/ì‚­ì œ ë¶ˆê°€í•˜ë©° ê¸‰ì—¬ ìŠ¤ëƒ…ìƒ·ì´ ìƒì„±ë©ë‹ˆë‹¤."
                }
                className={[
                  "h-[32px] px-3 rounded-lg text-xs font-semibold border",
                  lockDisabledReason
                    ? "bg-gray-200 text-gray-600 border-gray-200 cursor-not-allowed"
                    : "bg-red-600 text-white border-red-600 hover:opacity-90",
                ].join(" ")}
                onClick={async () => {
                  if (lockDisabledReason) return;

                  const ok = window.confirm(
                    [
                      `${staff.name}ì˜ ${year}ë…„ ${month}ì›”ì„ ë§ˆê°í• ê¹Œìš”?`,
                      "",
                      "- ë§ˆê° í›„ì—ëŠ” ê·¼ë¬´/ë¹„ìš© ìˆ˜ì •Â·ì‚­ì œê°€ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.",
                      "- ê¸‰ì—¬ ìŠ¤ëƒ…ìƒ·(í™•ì • ë°ì´í„°)ì´ ìƒì„±ë©ë‹ˆë‹¤.",
                    ].join("\n")
                  );
                  if (!ok) return;

                  try {
                    await lockWorkMonth({ staff: staff.id, year, month });
                    alert("ì›” ë§ˆê°ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
                    await onRefresh?.();
                  } catch (e: any) {
                    const msg =
                      e?.response?.data?.message ||
                      e?.response?.data?.detail ||
                      "ì›” ë§ˆê°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.";
                    alert(msg);
                  }
                }}
              >
                ì›” ë§ˆê°
              </button>
            </div>
          </div>
        );
      })}
    </div>
  );
}


==========================================================================================
# FILE: components/WorkMonthLockBar.tsx
==========================================================================================
// PATH: src/features/staff/components/WorkMonthLockBar.tsx
import { WorkMonthLock } from "../api/staffWorkMonthLock.api";

export default function WorkMonthLockBar({
  locks,
  isManager,
  onLock,
}: {
  locks?: WorkMonthLock[];
  isManager: boolean;
  onLock?: () => void;
}) {
  const locked = !!locks?.some((l) => !!l.is_locked);

  const lockDisabledReason = locked
    ? "ì´ë¯¸ ë§ˆê°ëœ ì›”ì…ë‹ˆë‹¤."
    : !isManager
    ? "ë§ˆê°ì€ ê´€ë¦¬ìë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤."
    : "";

  return (
    <div className="space-y-2">
      <div
        className={[
          "flex items-center justify-between rounded-lg border px-4 py-3 text-sm",
          locked
            ? "border-red-300 bg-red-50 text-red-700"
            : "border-green-300 bg-green-50 text-green-700",
        ].join(" ")}
      >
        <div className="flex items-center gap-2">
          <div className="font-semibold">{locked ? "ğŸ”’ ë§ˆê°ëœ ì›”" : "ğŸ”“ ì—´ë ¤ìˆëŠ” ì›”"}</div>

          <span
            className={[
              "px-2 py-0.5 rounded-full text-xs font-semibold border",
              isManager
                ? "bg-blue-50 text-blue-700 border-blue-200"
                : "bg-gray-50 text-gray-600 border-gray-200",
            ].join(" ")}
            title={isManager ? "ê´€ë¦¬ì ê¶Œí•œ" : "ì¼ë°˜ ì‚¬ìš©ì ê¶Œí•œ"}
          >
            {isManager ? "ê´€ë¦¬ì" : "ì¼ë°˜ ì‚¬ìš©ì"}
          </span>
        </div>

        <button
          disabled={!!lockDisabledReason}
          title={
            lockDisabledReason ||
            "ì´ë²ˆ ë‹¬ ê·¼ë¬´ê¸°ë¡ì„ ë§ˆê°í•©ë‹ˆë‹¤. ì´í›„ ìˆ˜ì •/ì‚­ì œ ë¶ˆê°€í•˜ë©° ê¸‰ì—¬ ìŠ¤ëƒ…ìƒ·ì´ ìƒì„±ë©ë‹ˆë‹¤."
          }
          onClick={() => {
            if (locked || !isManager) return;
            if (
              !confirm(
                "ì´ë²ˆ ë‹¬ ê·¼ë¬´ê¸°ë¡ì„ ë§ˆê°í• ê¹Œìš”?\në§ˆê° ì´í›„ì—ëŠ” ê·¼ë¬´ê¸°ë¡ ìˆ˜ì •/ì‚­ì œê°€ ë¶ˆê°€ëŠ¥í•˜ë©°,\nê¸‰ì—¬ ìŠ¤ëƒ…ìƒ·(í™•ì •)ì´ ìƒì„±ë©ë‹ˆë‹¤."
              )
            )
              return;
            onLock?.();
          }}
          className={[
            "px-3 py-1.5 rounded-md text-xs font-semibold",
            lockDisabledReason
              ? "bg-gray-300 text-gray-600 cursor-not-allowed"
              : "bg-red-600 text-white hover:opacity-90",
          ].join(" ")}
        >
          ì´ë²ˆë‹¬ ë§ˆê°
        </button>
      </div>

      {/* âœ… ê³ ì • ì„¤ëª… */}
      <div className="text-[11px] text-[var(--text-muted)]">
        * <b>ì›” ë§ˆê°</b>ì€ í•´ë‹¹ ì›”ì˜ ê·¼ë¬´/ë¹„ìš©ì„ ê¸°ì¤€ìœ¼ë¡œ <b>ê¸‰ì—¬ë¥¼ í™•ì •</b>í•˜ê³ , ì´í›„ ë³€ê²½ì„ ë§‰ê¸° ìœ„í•´{" "}
        <b>ê¸‰ì—¬ ìŠ¤ëƒ…ìƒ·</b>ì„ ìƒì„±í•©ë‹ˆë‹¤.
      </div>
    </div>
  );
}


==========================================================================================
# FILE: components/WorkRecordModal.tsx
==========================================================================================
// PATH: src/features/staff/components/WorkRecordModal.tsx
import { useEffect, useMemo, useState } from "react";
import { WorkType } from "../api/staffWorkType.api";
import { WorkRecord } from "../api/staffWorkRecord.api";

export default function WorkRecordModal({
  open,
  title,
  workTypes,
  staffId,
  initialValue,
  onClose,
  onSubmit,
  onDelete,
}: {
  open: boolean;
  title: string;
  workTypes: WorkType[];
  staffId: number;
  initialValue?: WorkRecord;
  onClose: () => void;
  onSubmit: (payload: {
    staff: number;
    work_type: number;
    date: string;
    start_time: string;
    end_time: string;
    break_minutes: number;
    memo: string;
  }) => Promise<void>;
  onDelete?: () => Promise<void>;
}) {
  const isEdit = !!initialValue;

  const defaultWorkType = useMemo(() => {
    if (initialValue?.work_type) return initialValue.work_type;
    return workTypes[0]?.id ?? 0;
  }, [initialValue?.work_type, workTypes]);

  const [form, setForm] = useState({
    date: "",
    work_type: 0,
    start_time: "09:00",
    end_time: "18:00",
    break_minutes: 0,
    memo: "",
  });

  useEffect(() => {
    if (!open) return;
    if (initialValue) {
      setForm({
        date: initialValue.date,
        work_type: initialValue.work_type,
        start_time: (initialValue.start_time || "09:00").slice(0, 5),
        end_time: (initialValue.end_time || "18:00").slice(0, 5),
        break_minutes: Number(initialValue.break_minutes || 0),
        memo: initialValue.memo || "",
      });
    } else {
      const today = new Date().toISOString().slice(0, 10);
      setForm({
        date: today,
        work_type: defaultWorkType,
        start_time: "09:00",
        end_time: "18:00",
        break_minutes: 0,
        memo: "",
      });
    }
  }, [open, initialValue, defaultWorkType]);

  if (!open) return null;

  const submit = async () => {
    if (!form.date) return alert("ë‚ ì§œëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.");
    if (!form.work_type) return alert("ê·¼ë¬´ìœ í˜•ì„ ì„ íƒí•˜ì„¸ìš”.");
    if (!form.start_time || !form.end_time) return alert("ì‹œê°„ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.");

    await onSubmit({
      staff: staffId,
      work_type: Number(form.work_type),
      date: form.date,
      start_time: form.start_time,
      end_time: form.end_time,
      break_minutes: Number(form.break_minutes || 0),
      memo: form.memo || "",
    });
    onClose();
  };

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/40 p-4">
      <div className="w-full max-w-[520px] rounded-2xl bg-[var(--bg-surface)] shadow-2xl overflow-hidden">
        <div className="border-b border-[var(--border-divider)] px-5 py-3">
          <div className="text-sm font-semibold text-[var(--text-primary)]">{title}</div>
        </div>

        <div className="px-5 py-4 space-y-3">
          <div className="grid grid-cols-2 gap-3">
            <div>
              <div className="text-xs font-medium text-[var(--text-muted)] mb-1">ë‚ ì§œ</div>
              <input
                type="date"
                value={form.date}
                onChange={(e) => setForm((p) => ({ ...p, date: e.target.value }))}
                className="h-[38px] w-full rounded-lg border border-[var(--border-divider)] bg-[var(--bg-app)] px-3 text-sm outline-none"
              />
            </div>

            <div>
              <div className="text-xs font-medium text-[var(--text-muted)] mb-1">ê·¼ë¬´ìœ í˜•</div>
              <select
                value={form.work_type}
                onChange={(e) => setForm((p) => ({ ...p, work_type: Number(e.target.value) }))}
                className="h-[38px] w-full rounded-lg border border-[var(--border-divider)] bg-[var(--bg-app)] px-3 text-sm outline-none"
              >
                <option value={0}>ì„ íƒ</option>
                {workTypes.map((wt) => (
                  <option key={wt.id} value={wt.id}>
                    {wt.name}
                  </option>
                ))}
              </select>
            </div>
          </div>

          <div className="grid grid-cols-3 gap-3">
            <div>
              <div className="text-xs font-medium text-[var(--text-muted)] mb-1">ì‹œì‘</div>
              <input
                type="time"
                value={form.start_time}
                onChange={(e) => setForm((p) => ({ ...p, start_time: e.target.value }))}
                className="h-[38px] w-full rounded-lg border border-[var(--border-divider)] bg-[var(--bg-app)] px-3 text-sm outline-none"
              />
            </div>

            <div>
              <div className="text-xs font-medium text-[var(--text-muted)] mb-1">ì¢…ë£Œ</div>
              <input
                type="time"
                value={form.end_time}
                onChange={(e) => setForm((p) => ({ ...p, end_time: e.target.value }))}
                className="h-[38px] w-full rounded-lg border border-[var(--border-divider)] bg-[var(--bg-app)] px-3 text-sm outline-none"
              />
            </div>

            <div>
              <div className="text-xs font-medium text-[var(--text-muted)] mb-1">íœ´ê²Œ(ë¶„)</div>
              <input
                type="number"
                min={0}
                value={form.break_minutes}
                onChange={(e) => setForm((p) => ({ ...p, break_minutes: Number(e.target.value) }))}
                className="h-[38px] w-full rounded-lg border border-[var(--border-divider)] bg-[var(--bg-app)] px-3 text-sm outline-none"
              />
            </div>
          </div>

          <div>
            <div className="text-xs font-medium text-[var(--text-muted)] mb-1">ë©”ëª¨</div>
            <textarea
              rows={3}
              value={form.memo}
              onChange={(e) => setForm((p) => ({ ...p, memo: e.target.value }))}
              className="w-full rounded-lg border border-[var(--border-divider)] bg-[var(--bg-app)] px-3 py-2 text-sm outline-none resize-none"
              placeholder="ì˜µì…˜"
            />
          </div>

          {isEdit && (
            <div className="rounded-lg border border-[var(--border-divider)] bg-[var(--bg-surface-soft)] px-4 py-3">
              <div className="text-xs text-[var(--text-muted)] mb-1">ê³„ì‚°ê°’ (readonly)</div>
              <div className="text-sm text-[var(--text-primary)]">
                ê·¼ë¬´ì‹œê°„: <b>{String(initialValue?.work_hours ?? "-")}</b> h{" "}
                <span className="mx-2 text-[var(--text-muted)]">|</span>
                ê¸ˆì•¡: <b>{Number(initialValue?.amount ?? 0).toLocaleString()}</b> ì›
              </div>
            </div>
          )}
        </div>

        <div className="flex justify-between items-center gap-2 px-5 py-3 border-t border-[var(--border-divider)]">
          <div>
            {isEdit && onDelete && (
              <button
                onClick={async () => {
                  if (!confirm("ì‚­ì œí• ê¹Œìš”?")) return;
                  await onDelete();
                  onClose();
                }}
                className="px-3 py-1.5 text-sm rounded-md border border-[var(--color-danger)] text-[var(--color-danger)] hover:bg-[var(--color-danger)]/10"
              >
                ì‚­ì œ
              </button>
            )}
          </div>

          <div className="flex gap-2">
            <button
              onClick={onClose}
              className="px-3 py-1.5 text-sm rounded-md border border-[var(--border-divider)] text-[var(--text-secondary)] hover:bg-[var(--bg-surface-soft)]"
            >
              ì·¨ì†Œ
            </button>

            <button
              onClick={submit}
              className="px-3 py-1.5 text-sm rounded-md bg-[var(--color-primary)] text-white hover:opacity-90"
            >
              {isEdit ? "ì €ì¥" : "ë“±ë¡"}
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}


==========================================================================================
# FILE: hooks/useStaffDetail.ts
==========================================================================================
// PATH: src/features/staff/hooks/useStaffDetail.ts
import { useMemo } from "react";
import { useQuery } from "@tanstack/react-query";
import { fetchStaffDetail, fetchStaffSummaryByRange } from "../api/staff.detail.api";

function todayISO() {
  return new Date().toISOString().slice(0, 10);
}

function getMonthBoundsFrom(dateISO: string) {
  const y = Number(dateISO.slice(0, 4));
  const m = Number(dateISO.slice(5, 7));
  const from = `${y}-${String(m).padStart(2, "0")}-01`;
  const lastDay = new Date(y, m, 0).getDate();
  const to = `${y}-${String(m).padStart(2, "0")}-${String(lastDay).padStart(2, "0")}`;
  return { from, to };
}

export function useStaffDetail(staffId: number) {
  const baseDate = useMemo(() => todayISO(), []);
  const range = useMemo(() => getMonthBoundsFrom(baseDate), [baseDate]);

  const detailQ = useQuery({
    queryKey: ["staff", staffId],
    queryFn: () => fetchStaffDetail(staffId),
    enabled: !!staffId,
  });

  const summaryQ = useQuery({
    queryKey: ["staff-summary", staffId, range.from, range.to],
    queryFn: () => fetchStaffSummaryByRange(staffId, range.from, range.to),
    enabled: !!staffId,
  });

  return {
    range,
    staff: detailQ.data,
    summary: summaryQ.data,
    isLoading: detailQ.isLoading || summaryQ.isLoading,
    isError: detailQ.isError || summaryQ.isError,
  };
}


==========================================================================================
# FILE: hooks/useStaffDomain.ts
==========================================================================================
// PATH: src/features/staff/hooks/useStaffDomain.ts
import { useMemo, useState } from "react";
import { useQuery } from "@tanstack/react-query";
import {
  fetchStaffs,
  fetchStaffSummary,
  Staff,
  StaffSummary,
} from "../api/staff.api";

export type StaffFilters = {
  search: string;
  is_active: "ALL" | "ACTIVE" | "INACTIVE";
  is_manager: "ALL" | "MANAGER" | "STAFF";
  pay_type: "ALL" | "HOURLY" | "MONTHLY";
};

function todayISO() {
  return new Date().toISOString().slice(0, 10);
}

function getMonthBoundsFrom(dateISO: string) {
  const y = Number(dateISO.slice(0, 4));
  const m = Number(dateISO.slice(5, 7));
  const from = `${y}-${String(m).padStart(2, "0")}-01`;
  const lastDay = new Date(y, m, 0).getDate();
  const to = `${y}-${String(m).padStart(2, "0")}-${String(lastDay).padStart(2, "0")}`;
  return { from, to };
}

function toStaffListParams(filters: StaffFilters) {
  // âœ… ë°±ì—”ë“œ ë‹¨ì¼ì§„ì‹¤: ë¦¬ìŠ¤íŠ¸ í•„í„°/ê²€ìƒ‰ì€ ì„œë²„ì—ì„œ ìˆ˜í–‰
  const params: any = {};

  const q = filters.search.trim();
  if (q) params.search = q;

  if (filters.is_active !== "ALL") params.is_active = filters.is_active === "ACTIVE";
  if (filters.is_manager !== "ALL") params.is_manager = filters.is_manager === "MANAGER";
  if (filters.pay_type !== "ALL") params.pay_type = filters.pay_type;

  return params;
}

export function useStaffDomain() {
  const [filters, setFilters] = useState<StaffFilters>({
    search: "",
    is_active: "ALL",
    is_manager: "ALL",
    pay_type: "ALL",
  });

  const [baseDate] = useState(() => todayISO());
  const range = useMemo(() => getMonthBoundsFrom(baseDate), [baseDate]);

  const listParams = useMemo(() => toStaffListParams(filters), [filters]);

  const listQ = useQuery({
    queryKey: ["staffs", listParams],
    queryFn: () => fetchStaffs(listParams),
    staleTime: 10_000,
  });

  const rows = (listQ.data ?? []) as Staff[];

  const [summaries, setSummaries] = useState<Record<number, StaffSummary | undefined>>({});

  const hydrateSummaries = async (staffs: Staff[]) => {
    // âœ… í˜„ì¬ í™”ë©´ì˜ rows ê¸°ì¤€ìœ¼ë¡œë§Œ summary ë‹¹ê¹€ (í•„í„° ë°˜ì˜)
    const entries = await Promise.all(
      staffs.map(async (s) => {
        try {
          const sum = await fetchStaffSummary(s.id, {
            date_from: range.from,
            date_to: range.to,
          });
          return [s.id, sum] as const;
        } catch {
          return [s.id, undefined] as const;
        }
      })
    );

    const next: Record<number, StaffSummary | undefined> = {};
    entries.forEach(([id, sum]) => (next[id] = sum));
    setSummaries(next);
  };

  const ensureSummaries = async () => {
    const staffs = (listQ.data ?? []) as Staff[];
    if (!staffs.length) {
      setSummaries({});
      return;
    }
    await hydrateSummaries(staffs);
  };

  const kpis = useMemo(() => {
    const list = Object.values(summaries).filter(Boolean) as StaffSummary[];
    const staffCount = rows.length;

    const workHours = list.reduce((s, x) => s + Number(x.work_hours || 0), 0);
    const totalPay = list.reduce((s, x) => s + Number(x.work_amount || 0), 0);
    const totalExpense = list.reduce((s, x) => s + Number(x.expense_amount || 0), 0);

    return {
      staffCount,
      workHours: Math.round(workHours * 100) / 100,
      totalPay,
      totalExpense,
    };
  }, [summaries, rows.length]);

  return {
    range,
    filters,
    setFilters,

    rows,
    isLoading: listQ.isLoading,
    isError: listQ.isError,

    summaries,
    ensureSummaries,

    kpis,
    refetchList: () => listQ.refetch(),
  };
}


==========================================================================================
# FILE: pages/AdminPayrollListPage.tsx
==========================================================================================
// PATH: src/features/staff/pages/AdminPayrollListPage.tsx
import { useState } from "react";
import { useQuery } from "@tanstack/react-query";
import { Page, PageHeader, Section } from "@/shared/ui/ds";
import { Panel } from "@/shared/ui/ds";


import {
  fetchPayrollSnapshots,
  exportPayrollSnapshotExcel,
  PayrollSnapshot,
} from "../api/payrollSnapshot.api";

/* =========================
 * Utils
 * ========================= */

function currentYearMonth() {
  const d = new Date();
  return { year: d.getFullYear(), month: d.getMonth() + 1 };
}

function ymLabel(y: number, m: number) {
  return `${y}-${String(m).padStart(2, "0")}`;
}

/* =========================
 * Component
 * ========================= */

export default function AdminPayrollListPage() {
  const [ym, setYm] = useState(() => currentYearMonth());

  const listQ = useQuery({
    queryKey: ["admin-payroll-snapshots", ym.year, ym.month],
    queryFn: () =>
      fetchPayrollSnapshots({
        year: ym.year,
        month: ym.month,
      }),
  });

  const rows = (listQ.data ?? []) as PayrollSnapshot[];

  const totals = rows.reduce(
    (acc, r) => {
      acc.workHours += Number(r.work_hours || 0);
      acc.totalAmount += Number(r.total_amount || 0);
      return acc;
    },
    { workHours: 0, totalAmount: 0 }
  );

  return (
    <Page>
      <PageHeader
        title="ì›”ë³„ ê¸‰ì—¬ ì •ì‚°"
        description={`ê¸‰ì—¬ í™•ì • ìŠ¤ëƒ…ìƒ· Â· ${ymLabel(ym.year, ym.month)}`}
        actions={
          <button
            onClick={() =>
              exportPayrollSnapshotExcel({
                year: ym.year,
                month: ym.month,
              })
            }
            className="btn-primary"
          >
            ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
          </button>
        }
      />

      <Section>
        <div className="flex items-center gap-2 mb-4">
          <select
            value={ym.year}
            onChange={(e) =>
              setYm((p) => ({ ...p, year: Number(e.target.value) }))
            }
            className="input w-[100px]"
          >
            {[ym.year - 1, ym.year, ym.year + 1].map((y) => (
              <option key={y} value={y}>
                {y}
              </option>
            ))}
          </select>

          <select
            value={ym.month}
            onChange={(e) =>
              setYm((p) => ({ ...p, month: Number(e.target.value) }))
            }
            className="input w-[100px]"
          >
            {Array.from({ length: 12 }, (_, i) => i + 1).map((m) => (
              <option key={m} value={m}>
                {m}ì›”
              </option>
            ))}
          </select>
        </div>

        <Card>
          <CardBody className="p-0">
            <div className="grid grid-cols-[180px_120px_140px_140px_160px] gap-4 px-4 py-3 text-xs font-semibold text-[var(--text-muted)] border-b">
              <div>ì§ì›</div>
              <div>ê·¼ë¬´ì‹œê°„</div>
              <div>ê¸‰ì—¬</div>
              <div>ë¹„ìš©</div>
              <div>ì‹¤ì§€ê¸‰ì•¡</div>
            </div>

            {rows.length === 0 && (
              <div className="px-4 py-6 text-sm text-[var(--text-muted)]">
                í•´ë‹¹ ì›”ì— ë§ˆê°ëœ ê¸‰ì—¬ê°€ ì—†ìŠµë‹ˆë‹¤.
              </div>
            )}

            {rows.map((r) => (
              <div
                key={r.id}
                className="grid grid-cols-[180px_120px_140px_140px_160px] gap-4 px-4 py-3 text-sm border-b last:border-b-0"
              >
                <div className="font-semibold">
                  {r.staff_name ?? `Staff#${r.staff}`}
                </div>
                <div>{r.work_hours} h</div>
                <div>{r.work_amount.toLocaleString()}ì›</div>
                <div>
                  {r.approved_expense_amount.toLocaleString()}ì›
                </div>
                <div className="font-semibold text-[var(--color-primary)]">
                  {r.total_amount.toLocaleString()}ì›
                </div>
              </div>
            ))}
          </CardBody>
        </Card>

        {rows.length > 0 && (
          <div className="mt-3 text-xs text-[var(--text-muted)]">
            ì´ ê·¼ë¬´ì‹œê°„: {totals.workHours} h Â· ì´ ì§€ê¸‰ì•¡:{" "}
            {totals.totalAmount.toLocaleString()}ì›
          </div>
        )}
      </Section>
    </Page>
  );
}


==========================================================================================
# FILE: pages/StaffDetailPage.tsx
==========================================================================================
// PATH: src/features/staff/pages/StaffDetailPage.tsx

import { useParams } from "react-router-dom";
import { Tabs } from "antd";

import StaffHeader from "../components/StaffHeader";
import StaffInfoPanel from "../components/StaffInfoPanel";

import StaffSummaryTab from "../tabs/StaffSummaryTab";
import StaffWorkRecordsTab from "../tabs/StaffWorkRecordsTab";
import StaffExpensesTab from "../tabs/StaffExpensesTab";
import StaffPayrollSnapshotTab from "../tabs/StaffPayrollSnapshotTab";
import StaffPayrollHistoryTab from "../tabs/StaffPayrollHistoryTab";
import StaffWagesTab from "../tabs/StaffWagesTab";
import StaffProfileTab from "../tabs/StaffProfileTab";
import StaffReportTab from "../tabs/StaffReportTab";

import { useStaffDetail } from "../hooks/useStaffDetail";

export default function StaffDetailPage() {
  const { staffId } = useParams<{ staffId: string }>();
  const { staff, isLoading } = useStaffDetail(Number(staffId));

  if (isLoading || !staff) return null;

  return (
    <div>
      {/* ğŸ”¹ í—¤ë”: ì§ì› ì‹ë³„ìš© (ìœ ì§€) */}
      <StaffHeader staff={staff} />

      {/* ğŸ”¹ ê¸°ë³¸ ì •ë³´ íŒ¨ë„ (ìœ ì§€) */}
      <StaffInfoPanel staff={staff} />

      {/* ğŸ”¹ Detail Tabs (ì‹¤ì‚¬ìš© ê¸°ì¤€ ì¬ì •ë ¬) */}
      <Tabs
        defaultActiveKey="summary"
        items={[
          {
            key: "summary",
            label: "ìš”ì•½",
            children: <StaffSummaryTab staff={staff} />,
          },
          {
            key: "work-records",
            label: "ê·¼ë¬´ ê¸°ë¡",
            children: <StaffWorkRecordsTab staff={staff} />,
          },
          {
            key: "expenses",
            label: "ë¹„ìš©",
            children: <StaffExpensesTab staff={staff} />,
          },
          {
            key: "payroll-snapshot",
            label: "ê¸‰ì—¬ ìŠ¤ëƒ…ìƒ·",
            children: <StaffPayrollSnapshotTab staff={staff} />,
          },
          {
            key: "payroll-history",
            label: "ê¸‰ì—¬ íˆìŠ¤í† ë¦¬",
            children: <StaffPayrollHistoryTab staff={staff} />,
          },
          {
            key: "report",
            label: "ë¦¬í¬íŠ¸",
            children: <StaffReportTab staff={staff} />,
          },
          {
            key: "wages",
            label: "ì‹œê¸‰/ê·¼ë¬´ìœ í˜•",
            children: <StaffWagesTab staff={staff} />,
          },
          {
            key: "profile",
            label: "ê¸°ë³¸ ì •ë³´",
            children: <StaffProfileTab staff={staff} />,
          },
        ]}
      />
    </div>
  );
}


==========================================================================================
# FILE: pages/StaffPage.tsx
==========================================================================================
// PATH: src/features/staff/pages/StaffPage.tsx

import { useEffect, useMemo, useState } from "react";
import { useQuery } from "@tanstack/react-query";

import { Page, PageHeader, Section } from "@/shared/ui/ds";

import StaffHeader from "../components/StaffHeader";
import StaffKpiCard from "../components/StaffKpiCard";
import { StaffTable } from "../components/StaffTable";
import StaffCreateModal from "../components/StaffCreateModal";

import { useStaffDomain } from "../hooks/useStaffDomain";
import { fetchStaffMe } from "../api/staffMe.api";

function ymLabel(from: string, to: string) {
  return `${from} ~ ${to} (ì´ë²ˆë‹¬)`;
}

export default function StaffPage() {
  const {
    range,
    filters,
    setFilters,

    rows,
    isLoading,
    isError,

    summaries,
    ensureSummaries,
    kpis,
    refetchList,
  } = useStaffDomain();

  const meQ = useQuery({ queryKey: ["staff-me"], queryFn: fetchStaffMe });

  const [createOpen, setCreateOpen] = useState(false);

  // âœ… í˜„ì¬ í™”ë©´ì— í‘œì‹œë˜ëŠ” rows ê¸°ì¤€ìœ¼ë¡œë§Œ ìš”ì•½(summary) hydrate
  useEffect(() => {
    if (!rows || rows.length === 0) return;
    ensureSummaries();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [rows.length, range.from, range.to, filters.search, filters.is_active, filters.is_manager, filters.pay_type]);

  const canManagePayroll =
    !!meQ.data && (meQ.data.is_superuser || meQ.data.is_payroll_manager || meQ.data.is_staff);

  const rangeLabel = useMemo(() => ymLabel(range.from, range.to), [range.from, range.to]);

  // âœ… KPI: ëª©ë¡ì—ì„œ â€œì´ë²ˆë‹¬ ìš´ì˜â€ì— ë°”ë¡œ í•„ìš”í•œ ê²ƒë§Œ
  const derived = useMemo(() => {
    const list = Object.values(summaries || {}).filter(Boolean) as any[];

    const needLockCount = list.filter((s) => s && !s.is_locked).length;
    const lockedCount = list.filter((s) => !!s?.is_locked).length;

    const pendingExpenseCount = list.reduce(
      (acc: number, s: any) => acc + Number(s?.pending_expense_count || 0),
      0
    );

    const totalAmount = list.reduce(
      (acc: number, s: any) => acc + Number(s?.total_amount || 0),
      0
    );

    return { needLockCount, lockedCount, pendingExpenseCount, totalAmount };
  }, [summaries]);

  if (isError) {
    return (
      <Page>
        <PageHeader title="ì§ì› ê·¼ë¬´ Â· ê¸‰ì—¬ ê´€ë¦¬" description="ë¶ˆëŸ¬ì˜¤ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤." />
        <Section>
          <div className="text-sm text-[var(--text-muted)]">
            ì§ì› ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ìƒˆë¡œê³ ì¹¨ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.
          </div>
        </Section>
      </Page>
    );
  }

  return (
    <Page>
      <PageHeader
        title="ì§ì› ê·¼ë¬´ Â· ê¸‰ì—¬ ê´€ë¦¬"
        description={canManagePayroll ? "ê´€ë¦¬ì ëª¨ë“œ Â· ìŠ¹ì¸/ì›”ë§ˆê° ê°€ëŠ¥" : "ì¼ë°˜ ëª¨ë“œ"}
        actions={
          <button
            onClick={() => setCreateOpen(true)}
            className="btn-primary"
          >
            + ì§ì› ë“±ë¡
          </button>
        }
      />

      {/* âœ… í•„í„°/ê²€ìƒ‰/ìƒˆë¡œê³ ì¹¨: ê¸°ì¡´ StaffHeader ì¬ì‚¬ìš© */}
      <StaffHeader
        rangeLabel={rangeLabel}
        filters={filters}
        setFilters={setFilters}
        onRefresh={async () => {
          await refetchList();
          await ensureSummaries();
        }}
        onCreate={() => setCreateOpen(true)}
      />

      <Section>
        {/* âœ… KPI: â€œì´ë²ˆë‹¬ ìš´ì˜â€ ì§€í‘œ */}
        <StaffKpiCard
          staffCount={kpis.staffCount}
          workHours={kpis.workHours}
          totalPay={kpis.totalPay}
          totalExpense={kpis.totalExpense}
        />

        <div className="grid grid-cols-1 gap-3 sm:grid-cols-4 mt-4">
          <div className="rounded-lg border border-[var(--border-divider)] bg-[var(--bg-surface-soft)] px-4 py-3">
            <div className="text-xs text-[var(--text-muted)]">ë§ˆê° í•„ìš”</div>
            <div className="mt-1 text-lg font-semibold">{derived.needLockCount.toLocaleString()}</div>
          </div>

          <div className="rounded-lg border border-[var(--border-divider)] bg-[var(--bg-surface-soft)] px-4 py-3">
            <div className="text-xs text-[var(--text-muted)]">ìŠ¹ì¸ ëŒ€ê¸°</div>
            <div className="mt-1 text-lg font-semibold">{derived.pendingExpenseCount.toLocaleString()}</div>
          </div>

          <div className="rounded-lg border border-[var(--border-divider)] bg-[var(--bg-surface-soft)] px-4 py-3">
            <div className="text-xs text-[var(--text-muted)]">ì´ë²ˆë‹¬ ì§€ê¸‰ ì˜ˆì •</div>
            <div className="mt-1 text-lg font-semibold text-[var(--color-primary)]">
              {derived.totalAmount.toLocaleString()}ì›
            </div>
          </div>

          <div className="rounded-lg border border-[var(--border-divider)] bg-[var(--bg-surface-soft)] px-4 py-3">
            <div className="text-xs text-[var(--text-muted)]">ë§ˆê° ì™„ë£Œ</div>
            <div className="mt-1 text-lg font-semibold">{derived.lockedCount.toLocaleString()}</div>
          </div>
        </div>
      </Section>

      <Section>
        {/* âœ… í•µì‹¬: StaffPageì—ì„œ ëŒ€ë¶€ë¶„ ì‘ì—… ëë‚´ê¸° */}
        <StaffTable
          staffs={rows as any[]}
          summaries={summaries as any}
          me={meQ.data as any}
          loading={isLoading || meQ.isLoading}
          onRefresh={async () => {
            await ensureSummaries();
          }}
        />
      </Section>

      <StaffCreateModal
        open={createOpen}
        onClose={() => setCreateOpen(false)}
        onSuccess={async () => {
          await refetchList();
          await ensureSummaries();
        }}
      />
    </Page>
  );
}


==========================================================================================
# FILE: tabs/AdminWorkMonthLockHistoryTab.tsx
==========================================================================================
// PATH: src/features/staff/tabs/AdminWorkMonthLockHistoryTab.tsx
import { useState } from "react";
import { useQuery } from "@tanstack/react-query";
import { Panel } from "@/shared/ui/ds";

import { fetchWorkMonthLocks, WorkMonthLock } from "../api/staffWorkMonthLock.api";

/* =========================
 * Utils
 * ========================= */

function currentYearMonth() {
  const d = new Date();
  return { year: d.getFullYear(), month: d.getMonth() + 1 };
}

function ymLabel(y: number, m: number) {
  return `${y}-${String(m).padStart(2, "0")}`;
}

/* =========================
 * Component
 * ========================= */

export default function AdminWorkMonthLockHistoryTab() {
  const [ym, setYm] = useState(() => currentYearMonth());

  const listQ = useQuery({
    queryKey: ["work-month-locks-history", ym.year, ym.month],
    queryFn: () =>
      fetchWorkMonthLocks({
        year: ym.year,
        month: ym.month,
      } as any), // staff ì—†ì´ ì¡°íšŒ (ê´€ë¦¬ì ì „ìš©)
  });

  const rows = (listQ.data ?? []) as WorkMonthLock[];

  if (listQ.isLoading) {
    return <div className="text-sm text-[var(--text-muted)]">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>;
  }

  return (
    <div className="space-y-4">
      {/* Toolbar */}
      <div className="flex items-end justify-between gap-3">
        <div className="text-sm font-semibold">
          ì›” ë§ˆê° íˆìŠ¤í† ë¦¬ ({ymLabel(ym.year, ym.month)})
        </div>

        <div className="flex items-center gap-2">
          <select
            value={ym.year}
            onChange={(e) =>
              setYm((p) => ({ ...p, year: Number(e.target.value) }))
            }
            className="h-[36px] rounded-lg border px-2 text-sm"
          >
            {[ym.year - 1, ym.year, ym.year + 1].map((y) => (
              <option key={y} value={y}>
                {y}
              </option>
            ))}
          </select>

          <select
            value={ym.month}
            onChange={(e) =>
              setYm((p) => ({ ...p, month: Number(e.target.value) }))
            }
            className="h-[36px] rounded-lg border px-2 text-sm"
          >
            {Array.from({ length: 12 }, (_, i) => i + 1).map((m) => (
              <option key={m} value={m}>
                {m}ì›”
              </option>
            ))}
          </select>
        </div>
      </div>

      {/* Table */}
      <Card>
        <CardBody className="p-0">
          <div className="grid grid-cols-[180px_120px_140px_200px] gap-4 px-4 py-3 text-xs font-semibold text-[var(--text-muted)] border-b">
            <div>ì§ì›</div>
            <div>ë§ˆê°ì›”</div>
            <div>ë§ˆê°ì</div>
            <div>ë§ˆê°ì¼ì‹œ</div>
          </div>

          {rows.length === 0 && (
            <div className="px-4 py-6 text-sm text-[var(--text-muted)]">
              í•´ë‹¹ ì›”ì— ë§ˆê°ëœ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.
            </div>
          )}

          {rows.map((r) => (
            <div
              key={r.id}
              className="grid grid-cols-[180px_120px_140px_200px] gap-4 px-4 py-3 text-sm border-b last:border-b-0"
            >
              <div className="font-semibold">
                {r.staff_name ?? `Staff#${r.staff}`}
              </div>

              <div>{ymLabel(r.year, r.month)}</div>

              <div>{r.locked_by ?? "-"}</div>

              <div className="text-xs text-[var(--text-muted)]">
                {r.created_at
                  ? new Date(r.created_at).toLocaleString()
                  : "-"}
              </div>
            </div>
          ))}
        </CardBody>
      </Card>

      <div className="text-xs text-[var(--text-muted)]">
        * ë³¸ íˆìŠ¤í† ë¦¬ëŠ” ê¸‰ì—¬/íšŒê³„ ê°ì‚¬ ë¡œê·¸ì´ë©° ìˆ˜ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
      </div>
    </div>
  );
}


==========================================================================================
# FILE: tabs/StaffExpensesTab.tsx
==========================================================================================
// PATH: src/features/staff/tabs/StaffExpensesTab.tsx
import { useMemo, useState } from "react";
import { useParams } from "react-router-dom";
import { useMutation, useQuery, useQueryClient } from "@tanstack/react-query";
import { EmptyState } from "@/shared/ui/ds";

import {
  fetchExpenses,
  createExpense,
  patchExpense,
  deleteExpense,
  ExpenseRecord,
  ExpenseStatus,
} from "../api/staffExpense.api";

import { fetchStaffDetail } from "../api/staff.detail.api";
import { fetchStaffMe } from "../api/staffMe.api";

import {
  fetchWorkMonthLocks,
  isLockedFromLocks,
} from "../api/staffWorkMonthLock.api";

import ExpenseEditModal from "../components/ExpenseEditModal";

/* =========================
 * Utils
 * ========================= */

function todayISO() {
  return new Date().toISOString().slice(0, 10);
}

function getMonthBoundsFrom(dateISO: string) {
  const y = Number(dateISO.slice(0, 4));
  const m = Number(dateISO.slice(5, 7));
  const from = `${y}-${String(m).padStart(2, "0")}-01`;
  const lastDay = new Date(y, m, 0).getDate();
  const to = `${y}-${String(m).padStart(2, "0")}-${String(lastDay).padStart(2, "0")}`;
  return { from, to, year: y, month: m };
}

const STATUS_LABEL: Record<ExpenseStatus, string> = {
  PENDING: "ëŒ€ê¸°",
  APPROVED: "ìŠ¹ì¸",
  REJECTED: "ë°˜ë ¤",
};

function statusTone(status: ExpenseStatus) {
  if (status === "APPROVED") return "bg-green-100 text-green-700 border-green-200";
  if (status === "REJECTED") return "bg-red-100 text-red-700 border-red-200";
  return "bg-gray-200 text-gray-700 border-gray-200";
}

function StatusBadge({ status }: { status: ExpenseStatus }) {
  return (
    <span
      className={[
        "px-2 py-0.5 rounded-full text-xs font-semibold border",
        statusTone(status),
      ].join(" ")}
    >
      {STATUS_LABEL[status]}
    </span>
  );
}

function actionDisabledClass(disabled: boolean) {
  return disabled ? "opacity-50 cursor-not-allowed" : "hover:bg-[var(--bg-surface-soft)]";
}

/* =========================
 * Component
 * ========================= */

export default function StaffExpensesTab() {
  const { staffId } = useParams();
  const sid = Number(staffId);
  const qc = useQueryClient();

  // âœ… ê¶Œí•œ ë‹¨ì¼ì§„ì‹¤: í˜„ì¬ ë¡œê·¸ì¸ ì‚¬ìš©ì ê¸°ì¤€
  const meQ = useQuery({
    queryKey: ["staff-me"],
    queryFn: fetchStaffMe,
  });

  const canApprove =
    !!meQ.data &&
    (meQ.data.is_superuser || meQ.data.is_payroll_manager || meQ.data.is_staff);

  // staff ì •ë³´(í‘œì‹œ/ì»¨í…ìŠ¤íŠ¸ìš©) - ê¶Œí•œíŒì •ì— ì“°ì§€ ë§ ê²ƒ
  const staffQ = useQuery({
    queryKey: ["staff", sid],
    queryFn: () => fetchStaffDetail(sid),
    enabled: !!sid,
  });

  // âœ… ê¸°ê°„(ê¸°ë³¸: ì´ë²ˆë‹¬)
  const [range, setRange] = useState(() => getMonthBoundsFrom(todayISO()));
  const [statusFilter, setStatusFilter] = useState<"ALL" | ExpenseStatus>("ALL");

  // âœ… ì›” ë§ˆê° (Backend Truth)
  const locksQ = useQuery({
    queryKey: ["work-month-locks", sid, range.year, range.month],
    queryFn: () =>
      fetchWorkMonthLocks({
        staff: sid,
        year: range.year,
        month: range.month,
      }),
    enabled: !!sid,
  });

  const monthLocked = isLockedFromLocks(locksQ.data);

  const [modalOpen, setModalOpen] = useState(false);
  const [editing, setEditing] = useState<ExpenseRecord | undefined>(undefined);

  const listQ = useQuery({
    queryKey: ["expenses", sid, range.from, range.to, statusFilter],
    queryFn: () =>
      fetchExpenses({
        staff: sid,
        date_from: range.from,
        date_to: range.to,
        status: statusFilter === "ALL" ? undefined : statusFilter,
      }),
    enabled: !!sid,
  });

  const createM = useMutation({
    mutationFn: createExpense,
    onSuccess: () => {
      qc.invalidateQueries({ queryKey: ["expenses", sid, range.from, range.to] });
      qc.invalidateQueries({ queryKey: ["staff-summary", sid] });
      qc.invalidateQueries({ queryKey: ["payroll-snapshots"] });
    },
  });

  const patchM = useMutation({
    mutationFn: ({ id, payload }: { id: number; payload: any }) => patchExpense(id, payload),
    onSuccess: () => {
      qc.invalidateQueries({ queryKey: ["expenses", sid, range.from, range.to] });
      qc.invalidateQueries({ queryKey: ["staff-summary", sid] });
      qc.invalidateQueries({ queryKey: ["payroll-snapshots"] });
    },
  });

  const delM = useMutation({
    mutationFn: deleteExpense,
    onSuccess: () => {
      qc.invalidateQueries({ queryKey: ["expenses", sid, range.from, range.to] });
      qc.invalidateQueries({ queryKey: ["staff-summary", sid] });
      qc.invalidateQueries({ queryKey: ["payroll-snapshots"] });
    },
  });

  const rows = listQ.data ?? [];

  const totals = useMemo(() => {
    const sumAll = rows.reduce((s, r) => s + Number(r.amount || 0), 0);
    const sumApproved = rows
      .filter((r) => r.status === "APPROVED")
      .reduce((s, r) => s + Number(r.amount || 0), 0);

    return { sumAll, sumApproved };
  }, [rows]);

  const onQuickSetStatus = async (r: ExpenseRecord, next: ExpenseStatus) => {
    if (!canApprove) return;
    if (monthLocked) return;

    const lockedRow = r.status === "APPROVED" || r.status === "REJECTED";
    if (lockedRow) return;

    await patchM.mutateAsync({
      id: r.id,
      payload: { status: next },
    });
  };

  const createDisabledReason = monthLocked
    ? "ë§ˆê°ëœ ì›”ì€ ë¹„ìš©ì„ ì¶”ê°€í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
    : "";

  if (listQ.isLoading || staffQ.isLoading || meQ.isLoading || locksQ.isLoading) {
    return <div className="text-sm text-[var(--text-muted)]">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>;
  }

  return (
    <div className="space-y-4">
      {/* Month Lock Banner (readonly for Expenses) */}
      <div
        className={[
          "rounded-lg border px-4 py-3 text-sm flex items-center justify-between gap-3",
          monthLocked
            ? "border-red-300 bg-red-50 text-red-700"
            : "border-green-300 bg-green-50 text-green-700",
        ].join(" ")}
      >
        <div className="space-y-0.5">
          <div className="font-semibold">
            {monthLocked ? "ğŸ”’ ë§ˆê°ëœ ì›”" : "ğŸ”“ ì§„í–‰ì¤‘ì¸ ì›”"}
          </div>
          <div className="text-[11px] opacity-90">
            * ì›” ë§ˆê° = ê¸‰ì—¬ í™•ì •(ìŠ¤ëƒ…ìƒ· ìƒì„±) Â· ë§ˆê°ëœ ì›”ì€ ë¹„ìš© ìˆ˜ì •/ì‚­ì œ/ìŠ¹ì¸ ë¶ˆê°€
          </div>
        </div>

        <div
          className={[
            "px-2 py-1 rounded-full text-xs font-semibold border shrink-0",
            canApprove
              ? "bg-blue-50 text-blue-700 border-blue-200"
              : "bg-gray-50 text-gray-600 border-gray-200",
          ].join(" ")}
          title={canApprove ? "ê´€ë¦¬ì ê¶Œí•œ" : "ì¼ë°˜ ì‚¬ìš©ì ê¶Œí•œ"}
        >
          {canApprove ? "ê´€ë¦¬ì ëª¨ë“œ" : "ì¼ë°˜ ì‚¬ìš©ì ëª¨ë“œ"}
        </div>
      </div>

      {/* Context header */}
      <div className="flex flex-wrap items-center justify-between gap-3">
        <div className="space-y-0.5">
          <div className="text-sm font-semibold">
            ë¹„ìš© ê´€ë¦¬{" "}
            {staffQ.data?.name ? (
              <span className="text-[var(--text-muted)] font-normal">
                Â· {staffQ.data.name}
              </span>
            ) : null}
          </div>
          <div className="text-xs text-[var(--text-muted)]">
            ìŠ¹ì¸/ë°˜ë ¤ëŠ” ê´€ë¦¬ìë§Œ ê°€ëŠ¥ Â· ìŠ¹ì¸/ë°˜ë ¤ëœ ë¹„ìš©ì€ ìˆ˜ì •/ì‚­ì œ ë¶ˆê°€ Â· ë§ˆê°ëœ ì›”ì€ ì „ë¶€ ë³€ê²½ ë¶ˆê°€
          </div>
        </div>
      </div>

      {/* Toolbar */}
      <div className="flex flex-wrap items-end justify-between gap-3">
        <div className="flex flex-wrap items-end gap-3">
          <div className="space-y-1">
            <div className="text-xs font-medium text-[var(--text-muted)]">ê¸°ê°„ ì‹œì‘</div>
            <input
              type="date"
              value={range.from}
              onChange={(e) => {
                const next = e.target.value;
                setRange(getMonthBoundsFrom(next));
              }}
              className="h-[38px] rounded-lg border border-[var(--border-divider)] bg-[var(--bg-surface)] px-3 text-sm outline-none"
            />
          </div>

          <div className="space-y-1">
            <div className="text-xs font-medium text-[var(--text-muted)]">ê¸°ê°„ ì¢…ë£Œ</div>
            <input
              type="date"
              value={range.to}
              onChange={(e) => setRange((p) => ({ ...p, to: e.target.value }))}
              className="h-[38px] rounded-lg border border-[var(--border-divider)] bg-[var(--bg-surface)] px-3 text-sm outline-none"
            />
          </div>

          <div className="space-y-1">
            <div className="text-xs font-medium text-[var(--text-muted)]">ìƒíƒœ</div>
            <select
              value={statusFilter}
              onChange={(e) => setStatusFilter(e.target.value as any)}
              className="h-[38px] rounded-lg border border-[var(--border-divider)] bg-[var(--bg-surface)] px-3 text-sm outline-none"
            >
              <option value="ALL">ì „ì²´</option>
              <option value="PENDING">ëŒ€ê¸°</option>
              <option value="APPROVED">ìŠ¹ì¸</option>
              <option value="REJECTED">ë°˜ë ¤</option>
            </select>
          </div>

          <div className="pb-[2px] text-xs text-[var(--text-muted)]">
            í‘œì‹œ ê¸°ê°„: {range.from} ~ {range.to}
          </div>
        </div>

        <div className="flex items-center gap-2">
          <button
            onClick={() => {
              listQ.refetch();
              locksQ.refetch();
            }}
            className="h-[38px] px-4 rounded-lg border border-[var(--border-divider)] bg-[var(--bg-surface)] text-sm font-semibold"
          >
            ìƒˆë¡œê³ ì¹¨
          </button>

          <button
            disabled={!!createDisabledReason}
            title={createDisabledReason || "ë¹„ìš© ë“±ë¡"}
            onClick={() => {
              if (createDisabledReason) return;
              setEditing(undefined);
              setModalOpen(true);
            }}
            className={["btn-primary", actionDisabledClass(!!createDisabledReason)].join(" ")}
          >
            + ë¹„ìš© ë“±ë¡
          </button>
        </div>
      </div>

      {/* Summary */}
      <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
        <div className="rounded-lg border border-[var(--border-divider)] bg-[var(--bg-surface-soft)] px-4 py-3">
          <div className="text-xs text-[var(--text-muted)]">í•©ê³„(í‘œì‹œëœ ëª©ë¡)</div>
          <div className="mt-1 text-lg font-semibold">{totals.sumAll.toLocaleString()}ì›</div>
        </div>
        <div className="rounded-lg border border-[var(--border-divider)] bg-[var(--bg-surface-soft)] px-4 py-3">
          <div className="text-xs text-[var(--text-muted)]">ìŠ¹ì¸ í•©ê³„</div>
          <div className="mt-1 text-lg font-semibold text-[var(--color-primary)]">
            {totals.sumApproved.toLocaleString()}ì›
          </div>
        </div>
      </div>

      {rows.length === 0 && (
        <EmptyState title="ë¹„ìš©ì´ ì—†ìŠµë‹ˆë‹¤" message="ë¹„ìš©ì„ ë“±ë¡í•˜ê±°ë‚˜ ê¸°ê°„/ìƒíƒœ í•„í„°ë¥¼ ë³€ê²½í•´ ë³´ì„¸ìš”." />
      )}

      <div className="space-y-2">
        {rows.map((r) => {
          const lockedRow = r.status === "APPROVED" || r.status === "REJECTED";
          const hardLocked = monthLocked || lockedRow;

          const approveDisabledReason = monthLocked
            ? "ë§ˆê°ëœ ì›”ì€ ìƒíƒœ ë³€ê²½ì´ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤."
            : lockedRow
            ? "ìŠ¹ì¸/ë°˜ë ¤ëœ ë¹„ìš©ì€ ìƒíƒœ ë³€ê²½ì´ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤."
            : !canApprove
            ? "ìŠ¹ì¸/ë°˜ë ¤ëŠ” ê´€ë¦¬ìë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤."
            : "";

          const rejectDisabledReason = approveDisabledReason;

          const editDisabledReason = monthLocked
            ? "ë§ˆê°ëœ ì›”ì€ ìˆ˜ì •ì´ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤."
            : lockedRow
            ? "ìŠ¹ì¸/ë°˜ë ¤ëœ ë¹„ìš©ì€ ìˆ˜ì •ì´ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤."
            : "";

          const deleteDisabledReason = monthLocked
            ? "ë§ˆê°ëœ ì›”ì€ ì‚­ì œê°€ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤."
            : lockedRow
            ? "ìŠ¹ì¸/ë°˜ë ¤ëœ ë¹„ìš©ì€ ì‚­ì œê°€ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤."
            : "";

          return (
            <div
              key={r.id}
              className="rounded-lg border border-[var(--border-divider)] bg-[var(--bg-surface)] px-4 py-3"
            >
              <div className="flex flex-wrap items-center justify-between gap-3">
                <div className="min-w-[220px]">
                  <div className="flex items-center gap-2">
                    <div className="font-semibold text-sm">{r.title}</div>
                    <StatusBadge status={r.status} />
                    {monthLocked && (
                      <span
                        className="px-2 py-0.5 rounded-full text-xs font-semibold border bg-red-50 text-red-700 border-red-200"
                        title="ë§ˆê°ëœ ì›”"
                      >
                        ë§ˆê°
                      </span>
                    )}
                  </div>

                  <div className="text-xs text-[var(--text-muted)]">
                    {r.date}
                    {r.memo ? ` Â· ${r.memo}` : ""}
                  </div>

                  {r.approved_at && (
                    <div className="mt-1 text-[11px] text-[var(--text-muted)]">
                      ìŠ¹ì¸ì: <b>{r.approved_by_name || "-"}</b> Â· ìŠ¹ì¸ì‹œê°:{" "}
                      <b>{new Date(r.approved_at).toLocaleString()}</b>
                    </div>
                  )}
                </div>

                <div className="flex items-center gap-3">
                  <div className="font-semibold">{Number(r.amount || 0).toLocaleString()}ì›</div>

                  <div className="flex items-center gap-2">
                    <button
                      disabled={!!approveDisabledReason || r.status === "APPROVED"}
                      title={
                        approveDisabledReason ||
                        (r.status === "APPROVED" ? "ì´ë¯¸ ìŠ¹ì¸ ìƒíƒœì…ë‹ˆë‹¤." : "ìŠ¹ì¸ ì²˜ë¦¬")
                      }
                      onClick={() => onQuickSetStatus(r, "APPROVED")}
                      className={[
                        "h-[32px] px-3 rounded-lg border text-xs font-semibold",
                        "border-green-300 bg-green-50 text-green-700",
                        actionDisabledClass(!!approveDisabledReason || r.status === "APPROVED"),
                      ].join(" ")}
                    >
                      ìŠ¹ì¸
                    </button>

                    <button
                      disabled={!!rejectDisabledReason || r.status === "REJECTED"}
                      title={
                        rejectDisabledReason ||
                        (r.status === "REJECTED" ? "ì´ë¯¸ ë°˜ë ¤ ìƒíƒœì…ë‹ˆë‹¤." : "ë°˜ë ¤ ì²˜ë¦¬")
                      }
                      onClick={() => onQuickSetStatus(r, "REJECTED")}
                      className={[
                        "h-[32px] px-3 rounded-lg border text-xs font-semibold",
                        "border-red-300 bg-red-50 text-red-700",
                        actionDisabledClass(!!rejectDisabledReason || r.status === "REJECTED"),
                      ].join(" ")}
                    >
                      ë°˜ë ¤
                    </button>

                    <button
                      disabled={!!editDisabledReason}
                      title={editDisabledReason || "ìˆ˜ì •"}
                      onClick={() => {
                        if (hardLocked) return;
                        setEditing(r);
                        setModalOpen(true);
                      }}
                      className={[
                        "h-[32px] px-3 rounded-lg border border-[var(--border-divider)] text-xs font-semibold",
                        actionDisabledClass(!!editDisabledReason),
                      ].join(" ")}
                    >
                      ìˆ˜ì •
                    </button>

                    <button
                      disabled={!!deleteDisabledReason}
                      title={deleteDisabledReason || "ì‚­ì œ"}
                      onClick={() => {
                        if (hardLocked) return;
                        if (!confirm("ì‚­ì œí• ê¹Œìš”?")) return;
                        delM.mutate(r.id);
                      }}
                      className={[
                        "h-[32px] px-3 rounded-lg border border-[var(--color-danger)] text-[var(--color-danger)] text-xs font-semibold",
                        actionDisabledClass(!!deleteDisabledReason),
                      ].join(" ")}
                    >
                      ì‚­ì œ
                    </button>
                  </div>
                </div>
              </div>
            </div>
          );
        })}
      </div>

      {/* Modal */}
      <ExpenseEditModal
        open={modalOpen}
        title={editing ? "ë¹„ìš© ìˆ˜ì •" : "ë¹„ìš© ë“±ë¡"}
        staffId={sid}
        isManager={canApprove}
        initialValue={editing}
        onClose={() => setModalOpen(false)}
        onSubmit={async (payload) => {
          if (monthLocked) {
            alert("ë§ˆê°ëœ ì›”ì€ ë³€ê²½í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            return;
          }

          if (!editing) {
            const safePayload = canApprove
              ? payload
              : { ...payload, status: "PENDING" as ExpenseStatus };
            await createM.mutateAsync(safePayload);
          } else {
            if (editing.status === "APPROVED" || editing.status === "REJECTED") return;
            await patchM.mutateAsync({
              id: editing.id,
              payload: canApprove
                ? payload
                : { ...payload, status: "PENDING" as ExpenseStatus },
            });
          }
        }}
        onDelete={
          editing
            ? async () => {
                if (monthLocked) {
                  alert("ë§ˆê°ëœ ì›”ì€ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                  return;
                }
                if (editing.status === "APPROVED" || editing.status === "REJECTED") return;
                await delM.mutateAsync(editing.id);
              }
            : undefined
        }
      />
    </div>
  );
}


==========================================================================================
# FILE: tabs/StaffPayrollHistoryTab.tsx
==========================================================================================
// PATH: src/features/staff/tabs/StaffPayrollHistoryTab.tsx
import { useMemo, useState } from "react";
import { useParams } from "react-router-dom";
import { useQuery } from "@tanstack/react-query";
import { Panel } from "@/shared/ui/ds";

import { EmptyState } from "@/shared/ui/ds";

import {
  fetchPayrollSnapshots,
  exportPayrollSnapshotExcel,
  PayrollSnapshot,
} from "../api/payrollSnapshot.api";
import { exportPayrollSnapshotPdf } from "../api/payrollSnapshotPdf.api";

/* =========================
 * Utils
 * ========================= */

function currentYearMonth() {
  const d = new Date();
  return { year: d.getFullYear(), month: d.getMonth() + 1 };
}

function ymLabel(y: number, m: number) {
  return `${y}-${String(m).padStart(2, "0")}`;
}

function safeNumber(v: any) {
  const n = Number(v);
  return Number.isFinite(n) ? n : 0;
}

/* =========================
 * Component
 * ========================= */

export default function StaffPayrollHistoryTab() {
  const { staffId } = useParams();
  const sid = Number(staffId);

  const now = useMemo(() => currentYearMonth(), []);
  const [year, setYear] = useState<number>(now.year);
  const [month, setMonth] = useState<number | "ALL">("ALL");

  const listQ = useQuery({
    queryKey: ["payroll-snapshots-history", sid, year, month],
    queryFn: () =>
      fetchPayrollSnapshots({
        staff: sid,
        year,
        month: month === "ALL" ? undefined : month,
      }),
    enabled: !!sid && !!year,
  });

  const rows = (listQ.data ?? []) as PayrollSnapshot[];

  const totals = useMemo(() => {
    return rows.reduce(
      (acc, r) => {
        acc.workHours += safeNumber(r.work_hours);
        acc.workAmount += safeNumber(r.work_amount);
        acc.expenseAmount += safeNumber(r.approved_expense_amount);
        acc.totalAmount += safeNumber(r.total_amount);
        return acc;
      },
      { workHours: 0, workAmount: 0, expenseAmount: 0, totalAmount: 0 }
    );
  }, [rows]);

  const canExcel = month !== "ALL";

  if (listQ.isLoading) {
    return <div className="text-sm text-[var(--text-muted)]">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>;
  }

  return (
    <div className="space-y-4">
      {/* Header */}
      <div className="space-y-1">
        <div className="text-sm font-semibold">ê¸‰ì—¬ íˆìŠ¤í† ë¦¬</div>
        <div className="text-xs text-[var(--text-muted)]">
          ì›” ë§ˆê° ì‹œ ìƒì„±ëœ ê¸‰ì—¬ ìŠ¤ëƒ…ìƒ·(í™•ì • ë°ì´í„°) Â· ìˆ˜ì • ë¶ˆê°€
        </div>
      </div>

      {/* Toolbar */}
      <div className="flex flex-wrap items-end justify-between gap-3">
        <div className="flex flex-wrap items-end gap-2">
          <div className="space-y-1">
            <div className="text-xs font-medium text-[var(--text-muted)]">ì—°ë„</div>
            <select
              value={year}
              onChange={(e) => setYear(Number(e.target.value))}
              className="h-[38px] rounded-lg border border-[var(--border-divider)] bg-[var(--bg-surface)] px-3 text-sm outline-none"
            >
              {[now.year - 1, now.year, now.year + 1].map((y) => (
                <option key={y} value={y}>
                  {y}ë…„
                </option>
              ))}
            </select>
          </div>

          <div className="space-y-1">
            <div className="text-xs font-medium text-[var(--text-muted)]">ì›”</div>
            <select
              value={month}
              onChange={(e) => {
                const v = e.target.value;
                setMonth(v === "ALL" ? "ALL" : Number(v));
              }}
              className="h-[38px] rounded-lg border border-[var(--border-divider)] bg-[var(--bg-surface)] px-3 text-sm outline-none"
            >
              <option value="ALL">ì „ì²´</option>
              {Array.from({ length: 12 }, (_, i) => i + 1).map((m) => (
                <option key={m} value={m}>
                  {m}ì›”
                </option>
              ))}
            </select>
          </div>

          <div className="pb-[2px] text-xs text-[var(--text-muted)]">
            {month === "ALL" ? `${year}ë…„ ì „ì²´` : `${ymLabel(year, month)} ê¸°ì¤€`}
          </div>
        </div>

        <div className="flex items-center gap-2">
          <button
            onClick={() => listQ.refetch()}
            className="h-[38px] px-4 rounded-lg border border-[var(--border-divider)] bg-[var(--bg-surface)] text-sm font-semibold hover:bg-[var(--bg-surface-soft)]"
          >
            ìƒˆë¡œê³ ì¹¨
          </button>

          <button
            disabled={!canExcel}
            title={
              canExcel
                ? "ì„ íƒëœ ì›”ì˜ ê¸‰ì—¬ ìŠ¤ëƒ…ìƒ·ì„ ì—‘ì…€ë¡œ ë‹¤ìš´ë¡œë“œí•©ë‹ˆë‹¤."
                : "ì›”ì„ ì„ íƒí•˜ë©´ ì—‘ì…€ ë‹¤ìš´ë¡œë“œê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤."
            }
            onClick={() => {
              if (!canExcel) return;
              exportPayrollSnapshotExcel({
                year,
                month: month as number,
              });
            }}
            className={[
              "btn-primary",
              !canExcel ? "opacity-50 cursor-not-allowed" : "",
            ].join(" ")}
          >
            ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
          </button>
        </div>
      </div>

      {/* Empty */}
      {rows.length === 0 && (
        <EmptyState
          title="ê¸‰ì—¬ ìŠ¤ëƒ…ìƒ·ì´ ì—†ìŠµë‹ˆë‹¤"
          message="í•´ë‹¹ ê¸°ê°„ì— ì›” ë§ˆê°ì´ ì•„ì§ ì§„í–‰ë˜ì§€ ì•Šì•˜ê±°ë‚˜, ìƒì„±ëœ ìŠ¤ëƒ…ìƒ·ì´ ì—†ìŠµë‹ˆë‹¤."
        />
      )}

      {/* Totals */}
      {rows.length > 0 && (
        <Card>
          <CardBody className="grid grid-cols-2 gap-4 sm:grid-cols-4">
            <Kpi label="ì´ ê·¼ë¬´ì‹œê°„" value={`${Math.round(totals.workHours * 100) / 100} h`} />
            <Kpi label="ê¸‰ì—¬ í•©ê³„" value={`${totals.workAmount.toLocaleString()}ì›`} />
            <Kpi label="ìŠ¹ì¸ ë¹„ìš© í•©ê³„" value={`${totals.expenseAmount.toLocaleString()}ì›`} />
            <Kpi
              label="ì‹¤ ì§€ê¸‰ì•¡ í•©ê³„"
              value={`${totals.totalAmount.toLocaleString()}ì›`}
              primary
            />
          </CardBody>
        </Card>
      )}

      {/* Table */}
      {rows.length > 0 && (
        <div className="overflow-hidden rounded-xl border border-[var(--border-divider)] bg-[var(--bg-surface)]">
          <div className="grid grid-cols-[120px_120px_140px_140px_160px_140px] gap-4 px-4 py-3 text-xs font-semibold text-[var(--text-muted)] border-b bg-[var(--bg-surface-soft)]">
            <div>ì •ì‚°ì›”</div>
            <div>ê·¼ë¬´ì‹œê°„</div>
            <div>ê¸‰ì—¬</div>
            <div>ìŠ¹ì¸ë¹„ìš©</div>
            <div>ì‹¤ì§€ê¸‰ì•¡</div>
            <div className="text-right">ë‹¤ìš´ë¡œë“œ</div>
          </div>

          {rows
            .slice()
            .sort((a, b) => {
              const aa = a.year * 100 + a.month;
              const bb = b.year * 100 + b.month;
              return bb - aa;
            })
            .map((r) => {
              const label = ymLabel(r.year, r.month);

              return (
                <div
                  key={r.id}
                  className="grid grid-cols-[120px_120px_140px_140px_160px_140px] gap-4 px-4 py-3 text-sm border-b last:border-b-0 items-center"
                >
                  <div className="font-semibold">{label}</div>

                  <div>{safeNumber(r.work_hours)} h</div>

                  <div>{safeNumber(r.work_amount).toLocaleString()}ì›</div>

                  <div>{safeNumber(r.approved_expense_amount).toLocaleString()}ì›</div>

                  <div className="font-semibold text-[var(--color-primary)]">
                    {safeNumber(r.total_amount).toLocaleString()}ì›
                  </div>

                  <div className="flex justify-end gap-2">
                    <button
                      onClick={() => exportPayrollSnapshotPdf({ staff: sid, year: r.year, month: r.month })}
                      className="h-[32px] px-3 rounded-lg border border-[var(--border-divider)] bg-[var(--bg-surface)] text-xs font-semibold hover:bg-[var(--bg-surface-soft)]"
                      title="PDF ê¸‰ì—¬ëª…ì„¸ì„œ ë‹¤ìš´ë¡œë“œ"
                    >
                      PDF
                    </button>

                    <button
                      onClick={() => exportPayrollSnapshotExcel({ year: r.year, month: r.month })}
                      className="h-[32px] px-3 rounded-lg border border-[var(--border-divider)] bg-[var(--bg-surface)] text-xs font-semibold hover:bg-[var(--bg-surface-soft)]"
                      title="ì—‘ì…€(.xlsx) ë‹¤ìš´ë¡œë“œ"
                    >
                      XLSX
                    </button>
                  </div>

                  {(r.generated_by_name || r.created_at) && (
                    <div className="col-span-6 -mt-1 pb-3 text-[11px] text-[var(--text-muted)]">
                      {r.generated_by_name ? (
                        <>
                          ìƒì„±ì: <b>{r.generated_by_name}</b>
                        </>
                      ) : (
                        <>
                          ìƒì„±ì: <b>-</b>
                        </>
                      )}
                      <span className="mx-2 text-[var(--border-divider)]">|</span>
                      ìƒì„±ì‹œê°: <b>{r.created_at ? new Date(r.created_at).toLocaleString() : "-"}</b>
                    </div>
                  )}
                </div>
              );
            })}
        </div>
      )}

      <div className="text-xs text-[var(--text-muted)]">
        * ê¸‰ì—¬ ìŠ¤ëƒ…ìƒ·ì€ <b>ì›” ë§ˆê°</b> ì‹œ ìƒì„±ë˜ë©°, ì´í›„ ë³€ê²½ë˜ì§€ ì•ŠëŠ” í™•ì • ë°ì´í„°ì…ë‹ˆë‹¤.
      </div>
    </div>
  );
}

function Kpi({
  label,
  value,
  primary,
}: {
  label: string;
  value: string;
  primary?: boolean;
}) {
  return (
    <div className="rounded-lg border border-[var(--border-divider)] bg-[var(--bg-surface-soft)] px-4 py-3">
      <div className="text-xs text-[var(--text-muted)]">{label}</div>
      <div
        className={[
          "mt-1 text-lg font-semibold",
          primary ? "text-[var(--color-primary)]" : "text-[var(--text-primary)]",
        ].join(" ")}
      >
        {value}
      </div>
    </div>
  );
}


==========================================================================================
# FILE: tabs/StaffPayrollSnapshotTab.tsx
==========================================================================================
// PATH: src/features/staff/tabs/StaffPayrollSnapshotTab.tsx
import { useMemo, useState } from "react";
import { useParams } from "react-router-dom";
import { useQuery } from "@tanstack/react-query";
import { Panel } from "@/shared/ui/ds";


import {
  fetchPayrollSnapshots,
  exportPayrollSnapshotExcel,
} from "../api/payrollSnapshot.api";
import { exportPayrollSnapshotPdf } from "../api/payrollSnapshotPdf.api";

/* =========================
 * Utils
 * ========================= */

function currentYearMonth() {
  const d = new Date();
  return { year: d.getFullYear(), month: d.getMonth() + 1 };
}

/* =========================
 * Component
 * ========================= */

export default function StaffPayrollSnapshotTab() {
  const { staffId } = useParams();
  const sid = Number(staffId);

  const [ym, setYm] = useState(() => currentYearMonth());

  const listQ = useQuery({
    queryKey: ["payroll-snapshots", sid, ym.year, ym.month],
    queryFn: () =>
      fetchPayrollSnapshots({
        staff: sid,
        year: ym.year,
        month: ym.month,
      }),
    enabled: !!sid,
  });

  const snapshot = listQ.data?.[0];
  const label = useMemo(
    () => `${ym.year}-${String(ym.month).padStart(2, "0")}`,
    [ym]
  );

  if (listQ.isLoading) {
    return <div className="text-sm text-[var(--text-muted)]">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>;
  }

  if (!snapshot) {
    return (
      <div className="space-y-2">
        <div className="text-sm font-semibold">ê¸‰ì—¬ ìŠ¤ëƒ…ìƒ·</div>
        <div className="text-sm text-[var(--text-muted)]">
          í•´ë‹¹ ì›”ì€ ì•„ì§ ë§ˆê°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.
        </div>
      </div>
    );
  }

  return (
    <div className="space-y-4">
      {/* Toolbar */}
      <div className="flex flex-wrap items-end justify-between gap-3">
        <div className="space-y-1">
          <div className="text-sm font-semibold">ê¸‰ì—¬ ìŠ¤ëƒ…ìƒ·</div>
          <div className="text-xs text-[var(--text-muted)]">ì •ì‚° ì›”: {label}</div>
        </div>

        <div className="flex items-center gap-2">
          <select
            value={ym.year}
            onChange={(e) =>
              setYm((p) => ({ ...p, year: Number(e.target.value) }))
            }
            className="h-[38px] rounded-lg border border-[var(--border-divider)] bg-[var(--bg-surface)] px-3 text-sm outline-none"
          >
            {[ym.year - 1, ym.year, ym.year + 1].map((y) => (
              <option key={y} value={y}>
                {y}ë…„
              </option>
            ))}
          </select>

          <select
            value={ym.month}
            onChange={(e) =>
              setYm((p) => ({ ...p, month: Number(e.target.value) }))
            }
            className="h-[38px] rounded-lg border border-[var(--border-divider)] bg-[var(--bg-surface)] px-3 text-sm outline-none"
          >
            {Array.from({ length: 12 }, (_, i) => i + 1).map((m) => (
              <option key={m} value={m}>
                {m}ì›”
              </option>
            ))}
          </select>

          <button
            onClick={() =>
              exportPayrollSnapshotPdf({
                staff: sid,
                year: ym.year,
                month: ym.month,
              })
            }
            className="h-[38px] px-4 rounded-lg border border-[var(--border-divider)] bg-[var(--bg-surface)] text-sm font-semibold hover:bg-[var(--bg-surface-soft)]"
            title="PDF ê¸‰ì—¬ëª…ì„¸ì„œ ë‹¤ìš´ë¡œë“œ"
          >
            PDF
          </button>

          <button
            onClick={() =>
              exportPayrollSnapshotExcel({
                year: ym.year,
                month: ym.month,
              })
            }
            className="btn-primary"
            title="ì—‘ì…€(.xlsx) ë‹¤ìš´ë¡œë“œ"
          >
            XLSX
          </button>
        </div>
      </div>

      {/* Snapshot Summary */}
      <Card>
        <CardBody className="grid grid-cols-2 gap-4 sm:grid-cols-4">
          <Item label="ê·¼ë¬´ì‹œê°„" value={`${snapshot.work_hours} h`} />
          <Item
            label="ê¸‰ì—¬"
            value={`${snapshot.work_amount.toLocaleString()} ì›`}
          />
          <Item
            label="ìŠ¹ì¸ ë¹„ìš©"
            value={`${snapshot.approved_expense_amount.toLocaleString()} ì›`}
          />
          <Item
            label="ì‹¤ ì§€ê¸‰ì•¡"
            value={`${snapshot.total_amount.toLocaleString()} ì›`}
            primary
          />
        </CardBody>
      </Card>

      <div className="text-xs text-[var(--text-muted)]">
        * ë³¸ ë°ì´í„°ëŠ” ì›” ë§ˆê° ì‹œ ìƒì„±ëœ ê¸‰ì—¬ ìŠ¤ëƒ…ìƒ·ì´ë©° ìˆ˜ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
      </div>
    </div>
  );
}

/* =========================
 * UI
 * ========================= */

function Item({
  label,
  value,
  primary,
}: {
  label: string;
  value: string;
  primary?: boolean;
}) {
  return (
    <div className="rounded-lg border border-[var(--border-divider)] bg-[var(--bg-surface-soft)] px-4 py-3">
      <div className="text-xs text-[var(--text-muted)]">{label}</div>
      <div
        className={[
          "mt-1 text-lg font-semibold",
          primary
            ? "text-[var(--color-primary)]"
            : "text-[var(--text-primary)]",
        ].join(" ")}
      >
        {value}
      </div>
    </div>
  );
}


==========================================================================================
# FILE: tabs/StaffProfileTab.tsx
==========================================================================================
// PATH: src/features/staff/tabs/StaffProfileTab.tsx
import { useEffect, useState } from "react";
import { useParams, useNavigate } from "react-router-dom";
import { useMutation, useQuery, useQueryClient } from "@tanstack/react-query";

import {
  fetchStaffDetail,
  patchStaffDetail,
  StaffDetail,
} from "../api/staff.detail.api";
import api from "@/shared/api/axios";

export default function StaffProfileTab() {
  const { staffId } = useParams();
  const sid = Number(staffId);
  const nav = useNavigate();
  const qc = useQueryClient();

  const detailQ = useQuery({
    queryKey: ["staff", sid],
    queryFn: () => fetchStaffDetail(sid),
    enabled: !!sid,
  });

  const patchM = useMutation({
    mutationFn: (payload: Partial<StaffDetail>) =>
      patchStaffDetail(sid, payload),
    onSuccess: () => {
      qc.invalidateQueries({ queryKey: ["staff", sid] });
      alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
    },
  });

  const deleteM = useMutation({
    mutationFn: async () => {
      await api.delete(`/staffs/${sid}/`);
    },
    onSuccess: async () => {
      alert("ì§ì›ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
      await qc.invalidateQueries({ queryKey: ["staffs"] });
      nav("/admin/staff");
    },
  });

  const [form, setForm] = useState({
    name: "",
    phone: "",
    is_active: true,
    pay_type: "HOURLY" as "HOURLY" | "MONTHLY",
  });

  useEffect(() => {
    if (!detailQ.data) return;
    setForm({
      name: detailQ.data.name || "",
      phone: detailQ.data.phone || "",
      is_active: detailQ.data.is_active,
      pay_type: detailQ.data.pay_type,
    });
  }, [detailQ.data]);

  if (detailQ.isLoading || !detailQ.data) {
    return <div className="text-sm text-[var(--text-muted)]">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>;
  }

  return (
    <div className="max-w-[520px] space-y-6">
      <div className="space-y-3">
        <Field label="ì´ë¦„">
          <input
            value={form.name}
            onChange={(e) =>
              setForm((p) => ({ ...p, name: e.target.value }))
            }
            className="input"
          />
        </Field>

        <Field label="ì „í™”ë²ˆí˜¸">
          <input
            value={form.phone}
            onChange={(e) =>
              setForm((p) => ({ ...p, phone: e.target.value }))
            }
            className="input"
          />
        </Field>

        <Field label="ê¸‰ì—¬ íƒ€ì…">
          <select
            value={form.pay_type}
            onChange={(e) =>
              setForm((p) => ({ ...p, pay_type: e.target.value as any }))
            }
            className="input"
          >
            <option value="HOURLY">ì‹œê¸‰ (ì¡°êµ)</option>
            <option value="MONTHLY">ì›”ê¸‰ (ê°•ì‚¬)</option>
          </select>
        </Field>

        <label className="flex items-center gap-2 text-sm">
          <input
            type="checkbox"
            checked={form.is_active}
            onChange={(e) =>
              setForm((p) => ({ ...p, is_active: e.target.checked }))
            }
          />
          í™œì„±
        </label>
      </div>

      <div className="flex items-center justify-between pt-4 border-t">
        <button
          onClick={() => patchM.mutate(form)}
          className="btn-primary"
          disabled={patchM.isPending}
        >
          ì €ì¥
        </button>

        <button
          onClick={() => {
            if (
              !confirm(
                "âš ï¸ ì´ ì§ì›ì€ ê·¼ë¬´ / ê¸‰ì—¬ / ê°•ì˜ ë°ì´í„°ì™€ ì—°ê²°ë˜ì–´ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.\nì‚­ì œ ì‹œ ê´€ë ¨ ë°ì´í„°ë„ í•¨ê»˜ ì •ë¦¬ë©ë‹ˆë‹¤.\n\nì •ë§ ì‚­ì œí• ê¹Œìš”?"
              )
            )
              return;
            deleteM.mutate();
          }}
          className="px-3 py-1.5 text-sm rounded-md border border-[var(--color-danger)] text-[var(--color-danger)] hover:bg-[var(--color-danger)]/10"
        >
          ì§ì› ì‚­ì œ
        </button>
      </div>
    </div>
  );
}

function Field({
  label,
  children,
}: {
  label: string;
  children: React.ReactNode;
}) {
  return (
    <div className="space-y-1">
      <div className="text-xs font-medium text-[var(--text-muted)]">
        {label}
      </div>
      {children}
    </div>
  );
}


==========================================================================================
# FILE: tabs/StaffReportTab.tsx
==========================================================================================
// PATH: src/features/staff/tabs/StaffReportTab.tsx
import { useMemo, useState } from "react";
import { useParams } from "react-router-dom";
import { useQuery } from "@tanstack/react-query";
import { Panel } from "@/shared/ui/ds";


import { fetchStaffSummaryByRange } from "../api/staff.detail.api";
import { exportStaffReportXlsx } from "../api/staffReport.api";

function todayISO() {
  return new Date().toISOString().slice(0, 10);
}

function getMonthBoundsFrom(dateISO: string) {
  const y = Number(dateISO.slice(0, 4));
  const m = Number(dateISO.slice(5, 7));
  const from = `${y}-${String(m).padStart(2, "0")}-01`;
  const lastDay = new Date(y, m, 0).getDate();
  const to = `${y}-${String(m).padStart(2, "0")}-${String(lastDay).padStart(2, "0")}`;
  return { from, to };
}

export default function StaffReportTab() {
  const { staffId } = useParams();
  const sid = Number(staffId);

  const [range, setRange] = useState(() => getMonthBoundsFrom(todayISO()));
  const monthLabel = useMemo(() => `${range.from} ~ ${range.to}`, [range.from, range.to]);

  const summaryQ = useQuery({
    queryKey: ["staff-report-summary", sid, range.from, range.to],
    queryFn: () => fetchStaffSummaryByRange(sid, range.from, range.to),
    enabled: !!sid,
  });

  return (
    <div className="space-y-4">
      {/* Toolbar */}
      <div className="flex flex-wrap items-end justify-between gap-3">
        <div className="flex flex-wrap items-end gap-3">
          <div className="space-y-1">
            <div className="text-xs font-medium text-[var(--text-muted)]">ê¸°ê°„ ì‹œì‘</div>
            <input
              type="date"
              value={range.from}
              onChange={(e) => setRange((p) => ({ ...p, from: e.target.value }))}
              className="h-[38px] rounded-lg border border-[var(--border-divider)] bg-[var(--bg-surface)] px-3 text-sm outline-none"
            />
          </div>

          <div className="space-y-1">
            <div className="text-xs font-medium text-[var(--text-muted)]">ê¸°ê°„ ì¢…ë£Œ</div>
            <input
              type="date"
              value={range.to}
              onChange={(e) => setRange((p) => ({ ...p, to: e.target.value }))}
              className="h-[38px] rounded-lg border border-[var(--border-divider)] bg-[var(--bg-surface)] px-3 text-sm outline-none"
            />
          </div>

          <div className="pb-[2px] text-xs text-[var(--text-muted)]">{monthLabel}</div>
        </div>

        <div className="flex items-center gap-2">
          <button
            onClick={() => summaryQ.refetch()}
            className="h-[38px] px-4 rounded-lg border border-[var(--border-divider)] bg-[var(--bg-surface)] text-sm font-semibold hover:bg-[var(--bg-surface-soft)]"
          >
            ìƒˆë¡œê³ ì¹¨
          </button>

          <button
            onClick={async () => {
              await exportStaffReportXlsx({
                staffId: sid,
                date_from: range.from,
                date_to: range.to,
              });
            }}
            className="btn-primary"
          >
            ì—‘ì…€ ë‹¤ìš´ë¡œë“œ (.xlsx)
          </button>
        </div>
      </div>

      {/* Summary */}
      {summaryQ.isLoading && (
        <div className="text-sm text-[var(--text-muted)]">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
      )}

      {!summaryQ.isLoading && summaryQ.data && (
        <Card>
          <CardBody className="grid grid-cols-2 gap-4 sm:grid-cols-4">
            <Item label="ê·¼ë¬´ì‹œê°„" value={`${summaryQ.data.work_hours} h`} />
            <Item label="ê¸‰ì—¬" value={`${summaryQ.data.work_amount.toLocaleString()} ì›`} />
            <Item label="ë¹„ìš©" value={`${summaryQ.data.expense_amount.toLocaleString()} ì›`} />
            <Item
              label="ì‹¤ ì§€ê¸‰ì•¡"
              value={`${summaryQ.data.total_amount.toLocaleString()} ì›`}
              primary
            />
          </CardBody>
        </Card>
      )}

      <div className="text-xs text-[var(--text-muted)]">
        * ì—‘ì…€ì—ëŠ” Summary / WorkRecords / Expenses ì‹œíŠ¸ê°€ í¬í•¨ë©ë‹ˆë‹¤.
      </div>
    </div>
  );
}

function Item({
  label,
  value,
  primary,
}: {
  label: string;
  value: string;
  primary?: boolean;
}) {
  return (
    <div className="rounded-lg border border-[var(--border-divider)] bg-[var(--bg-surface-soft)] px-4 py-3">
      <div className="text-xs text-[var(--text-muted)]">{label}</div>
      <div
        className={[
          "mt-1 text-lg font-semibold",
          primary ? "text-[var(--color-primary)]" : "text-[var(--text-primary)]",
        ].join(" ")}
      >
        {value}
      </div>
    </div>
  );
}


==========================================================================================
# FILE: tabs/StaffSummaryTab.tsx
==========================================================================================
// PATH: src/features/staff/tabs/StaffSummaryTab.tsx
import { useParams } from "react-router-dom";
import { useQuery } from "@tanstack/react-query";
import { Panel } from "@/shared/ui/ds";


import { fetchStaffSummaryByRange } from "../api/staff.detail.api";
import {
  fetchWorkMonthLocks,
  isLockedFromLocks,
} from "../api/staffWorkMonthLock.api";

/* =========================
 * Utils
 * ========================= */

function todayISO() {
  return new Date().toISOString().slice(0, 10);
}

function getMonthBoundsFrom(dateISO: string) {
  const y = Number(dateISO.slice(0, 4));
  const m = Number(dateISO.slice(5, 7));
  const from = `${y}-${String(m).padStart(2, "0")}-01`;
  const lastDay = new Date(y, m, 0).getDate();
  const to = `${y}-${String(m).padStart(2, "0")}-${String(lastDay).padStart(2, "0")}`;
  return { from, to, year: y, month: m };
}

/* =========================
 * Component
 * ========================= */

export default function StaffSummaryTab() {
  const { staffId } = useParams();
  const sid = Number(staffId);

  const baseDate = todayISO();
  const range = getMonthBoundsFrom(baseDate);

  // âœ… Summary (Backend Truth)
  const summaryQ = useQuery({
    queryKey: ["staff-summary-tab", sid, range.from, range.to],
    queryFn: () =>
      fetchStaffSummaryByRange(sid, range.from, range.to),
    enabled: !!sid,
  });

  // âœ… Month Lock (Backend Truth)
  const locksQ = useQuery({
    queryKey: ["work-month-locks", sid, range.year, range.month],
    queryFn: () =>
      fetchWorkMonthLocks({
        staff: sid,
        year: range.year,
        month: range.month,
      }),
    enabled: !!sid,
  });

  const locked = isLockedFromLocks(locksQ.data);

  if (summaryQ.isLoading || locksQ.isLoading) {
    return <div className="text-sm text-[var(--text-muted)]">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>;
  }

  if (!summaryQ.data) {
    return <div className="text-sm text-[var(--text-muted)]">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>;
  }

  const summary = summaryQ.data;

  return (
    <div className="space-y-4">
      <Card>
        <CardBody className="grid grid-cols-2 gap-4 sm:grid-cols-4">
          <Item label="ì´ ê·¼ë¬´ì‹œê°„" value={`${summary.work_hours} h`} />
          <Item
            label="ê¸‰ì—¬ í•©ê³„"
            value={`${summary.work_amount.toLocaleString()} ì›`}
          />
          <Item
            label="ë¹„ìš© í•©ê³„"
            value={`${summary.expense_amount.toLocaleString()} ì›`}
          />
          <Item
            label="ì‹¤ ì§€ê¸‰ì•¡"
            value={`${summary.total_amount.toLocaleString()} ì›`}
            primary
          />
        </CardBody>
      </Card>

      <div className="flex items-center justify-between text-xs">
        <div className="text-[var(--text-muted)]">
          ê¸°ì¤€ ê¸°ê°„: {range.from} ~ {range.to}
        </div>

        <div
          className={[
            "px-2 py-0.5 rounded-full font-semibold",
            locked
              ? "bg-red-100 text-red-700"
              : "bg-green-100 text-green-700",
          ].join(" ")}
        >
          {locked ? "ë§ˆê°ë¨" : "ì§„í–‰ì¤‘"}
        </div>
      </div>
    </div>
  );
}

/* =========================
 * UI
 * ========================= */

function Item({
  label,
  value,
  primary,
}: {
  label: string;
  value: string;
  primary?: boolean;
}) {
  return (
    <div className="rounded-lg border border-[var(--border-divider)] bg-[var(--bg-surface-soft)] px-4 py-3">
      <div className="text-xs text-[var(--text-muted)]">{label}</div>
      <div
        className={[
          "mt-1 text-lg font-semibold",
          primary
            ? "text-[var(--color-primary)]"
            : "text-[var(--text-primary)]",
        ].join(" ")}
      >
        {value}
      </div>
    </div>
  );
}


==========================================================================================
# FILE: tabs/StaffWagesTab.tsx
==========================================================================================
// PATH: src/features/staff/tabs/StaffWagesTab.tsx
import { useMemo, useState } from "react";
import { useParams } from "react-router-dom";
import { useMutation, useQuery, useQueryClient } from "@tanstack/react-query";
import {
  fetchWorkTypes,
  fetchStaffWorkTypes,
  createStaffWorkType,
  patchStaffWorkType,
  deleteStaffWorkType,
  StaffWorkType,
  WorkType,
} from "../api/staffWorkType.api";
import { EmptyState } from "@/shared/ui/ds";

export default function StaffWagesTab() {
  const { staffId } = useParams();
  const sid = Number(staffId);
  const qc = useQueryClient();

  const staffWagesQ = useQuery({
    queryKey: ["staff-work-types", sid],
    queryFn: () => fetchStaffWorkTypes(sid),
    enabled: !!sid,
  });

  const workTypesQ = useQuery({
    queryKey: ["work-types", "active"],
    queryFn: () => fetchWorkTypes({ is_active: true }),
  });

  const rows = (staffWagesQ.data ?? []) as StaffWorkType[];
  const workTypes = (workTypesQ.data ?? []) as WorkType[];

  const usedWorkTypeIds = useMemo(() => new Set(rows.map((r) => r.work_type.id)), [rows]);
  const addable = useMemo(
    () => workTypes.filter((w) => !usedWorkTypeIds.has(w.id)),
    [workTypes, usedWorkTypeIds]
  );

  const addM = useMutation({
    mutationFn: (workTypeId: number) => createStaffWorkType(sid, { work_type_id: workTypeId }),
    onSuccess: () => qc.invalidateQueries({ queryKey: ["staff-work-types", sid] }),
  });

  const patchM = useMutation({
    mutationFn: ({ id, hourly_wage }: { id: number; hourly_wage: number | null }) =>
      patchStaffWorkType(id, { hourly_wage }),
    onSuccess: () => qc.invalidateQueries({ queryKey: ["staff-work-types", sid] }),
  });

  const delM = useMutation({
    mutationFn: (id: number) => deleteStaffWorkType(id),
    onSuccess: () => qc.invalidateQueries({ queryKey: ["staff-work-types", sid] }),
  });

  const [editing, setEditing] = useState<Record<number, string>>({});

  const GRID = "grid grid-cols-[220px_140px_160px_160px_80px] gap-4 items-center";

  if (staffWagesQ.isLoading) {
    return <div className="text-sm text-[var(--text-muted)]">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>;
  }

  return (
    <div className="space-y-4">
      {/* Table */}
      <div className="overflow-hidden rounded-xl border border-[var(--border-divider)] bg-[var(--bg-surface)]">
        <div className="px-4 py-3 bg-[var(--bg-surface-soft)] text-xs font-medium text-[var(--text-muted)]">
          <div className={GRID}>
            <div>ê·¼ë¬´ìœ í˜•</div>
            <div>ê¸°ë³¸ì‹œê¸‰</div>
            <div>ê°œë³„ì‹œê¸‰</div>
            <div>ì ìš©ì‹œê¸‰</div>
            <div className="text-right"> </div>
          </div>
        </div>

        {rows.length === 0 && (
          <div className="p-6">
            <EmptyState title="ì„¤ì •ëœ ê·¼ë¬´ìœ í˜•ì´ ì—†ìŠµë‹ˆë‹¤" message="ì•„ë˜ì—ì„œ ê·¼ë¬´ìœ í˜•ì„ ì¶”ê°€í•´ ë³´ì„¸ìš”." />
          </div>
        )}

        {rows.map((r) => {
          const value = editing[r.id] ?? (r.hourly_wage ?? "").toString();
          const usesBase = r.hourly_wage == null;

          return (
            <div key={r.id} className="px-4 py-3 border-t border-[var(--border-divider)]">
              <div className={GRID}>
                <div className="font-semibold text-sm text-[var(--text-primary)] flex items-center gap-2">
                  <span
                    className="inline-block w-2.5 h-2.5 rounded-full"
                    style={{ backgroundColor: r.work_type.color }}
                  />
                  {r.work_type.name}
                </div>

                <div className="text-sm">
                  {Number(r.work_type.base_hourly_wage || 0).toLocaleString()}ì›
                </div>

                <div className="text-sm">
                  <input
                    value={value}
                    onChange={(e) => setEditing((p) => ({ ...p, [r.id]: e.target.value }))}
                    onBlur={() => {
                      const raw = (editing[r.id] ?? "").trim();
                      const next = raw === "" ? null : Number(raw);
                      if (raw !== "" && Number.isNaN(next)) {
                        setEditing((p) => ({ ...p, [r.id]: (r.hourly_wage ?? "").toString() }));
                        return;
                      }
                      patchM.mutate({ id: r.id, hourly_wage: next });
                    }}
                    placeholder="ë¹„ìš°ë©´ ê¸°ë³¸ì‹œê¸‰"
                    className="h-[38px] w-[150px] rounded-lg border border-[var(--border-divider)] bg-[var(--bg-surface)] px-3 text-sm outline-none focus:border-[var(--color-primary)]"
                  />
                  {usesBase && (
                    <span className="ml-2 text-xs text-[var(--text-muted)]">ê¸°ë³¸ì‹œê¸‰ ì‚¬ìš©ì¤‘</span>
                  )}
                </div>

                <div className="text-sm font-semibold">
                  {Number(r.effective_hourly_wage || 0).toLocaleString()}ì›
                </div>

                <div className="flex justify-end">
                  <button
                    onClick={() => {
                      if (!confirm("ì´ ê·¼ë¬´ìœ í˜•ì„ ì‚­ì œí• ê¹Œìš”?")) return;
                      delM.mutate(r.id);
                    }}
                    className="text-xs font-semibold text-[var(--color-danger)] hover:underline"
                  >
                    ì‚­ì œ
                  </button>
                </div>
              </div>
            </div>
          );
        })}
      </div>

      {/* Add WorkType */}
      <div className="flex flex-wrap items-center gap-2">
        <div className="text-xs text-[var(--text-muted)] mr-1">ì¶”ê°€:</div>
        {addable.length === 0 ? (
          <div className="text-xs text-[var(--text-muted)]">ì¶”ê°€ ê°€ëŠ¥í•œ ê·¼ë¬´ìœ í˜•ì´ ì—†ìŠµë‹ˆë‹¤.</div>
        ) : (
          addable.map((wt) => (
            <button
              key={wt.id}
              onClick={() => addM.mutate(wt.id)}
              className="h-[34px] px-3 rounded-lg border border-[var(--border-divider)] bg-[var(--bg-surface)] text-xs font-semibold hover:bg-[var(--bg-surface-soft)]"
            >
              + {wt.name}
            </button>
          ))
        )}
      </div>
    </div>
  );
}


==========================================================================================
# FILE: tabs/StaffWorkRecordsTab.tsx
==========================================================================================
// PATH: src/features/staff/tabs/StaffWorkRecordsTab.tsx
import { useMemo, useState } from "react";
import { useParams } from "react-router-dom";
import { useMutation, useQuery, useQueryClient } from "@tanstack/react-query";
import { EmptyState } from "@/shared/ui/ds";

import { fetchStaffMe } from "../api/staffMe.api";

import { fetchWorkTypes, WorkType } from "../api/staffWorkType.api";
import {
  fetchWorkRecords,
  createWorkRecord,
  patchWorkRecord,
  deleteWorkRecord,
  WorkRecord,
} from "../api/staffWorkRecord.api";

import {
  fetchWorkMonthLocks,
  lockWorkMonth,
  isLockedFromLocks,
} from "../api/staffWorkMonthLock.api";

import WorkRecordModal from "../components/WorkRecordModal";
import WorkMonthLockBar from "../components/WorkMonthLockBar";

/* =========================
 * Utils
 * ========================= */

function todayISO() {
  return new Date().toISOString().slice(0, 10);
}

function getMonthBoundsFrom(dateISO: string) {
  const y = Number(dateISO.slice(0, 4));
  const m = Number(dateISO.slice(5, 7));
  const from = `${y}-${String(m).padStart(2, "0")}-01`;
  const lastDay = new Date(y, m, 0).getDate();
  const to = `${y}-${String(m).padStart(2, "0")}-${String(lastDay).padStart(2, "0")}`;
  return { from, to, year: y, month: m };
}

function btnDisabledClass(disabled: boolean) {
  return disabled ? "opacity-50 cursor-not-allowed" : "hover:bg-[var(--bg-surface-soft)]";
}

/* =========================
 * Component
 * ========================= */

export default function StaffWorkRecordsTab() {
  const { staffId } = useParams();
  const sid = Number(staffId);
  const qc = useQueryClient();

  // âœ… ê¶Œí•œ ë‹¨ì¼ì§„ì‹¤
  const meQ = useQuery({ queryKey: ["staff-me"], queryFn: fetchStaffMe });
  const canManage =
    !!meQ.data && (meQ.data.is_superuser || meQ.data.is_payroll_manager || meQ.data.is_staff);

  // ê¸°ê°„(ê¸°ë³¸: ì´ë²ˆë‹¬)
  const [range, setRange] = useState(() => getMonthBoundsFrom(todayISO()));

  const [modalOpen, setModalOpen] = useState(false);
  const [editing, setEditing] = useState<WorkRecord | undefined>(undefined);

  // Lock (Backend Truth)
  const locksQ = useQuery({
    queryKey: ["work-month-locks", sid, range.year, range.month],
    queryFn: () =>
      fetchWorkMonthLocks({
        staff: sid,
        year: range.year,
        month: range.month,
      }),
    enabled: !!sid,
  });

  const locked = isLockedFromLocks(locksQ.data);

  const lockM = useMutation({
    mutationFn: () =>
      lockWorkMonth({
        staff: sid,
        year: range.year,
        month: range.month,
      }),
    onSuccess: () => {
      qc.invalidateQueries({ queryKey: ["work-month-locks", sid] });
      qc.invalidateQueries({ queryKey: ["work-records", sid] });
      qc.invalidateQueries({ queryKey: ["payroll-snapshots"] });
      alert("ì›” ë§ˆê°ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
    },
  });

  const workTypesQ = useQuery({
    queryKey: ["work-types", "active"],
    queryFn: () => fetchWorkTypes({ is_active: true }),
  });

  const recordsQ = useQuery({
    queryKey: ["work-records", sid, range.from, range.to],
    queryFn: () =>
      fetchWorkRecords({
        staff: sid,
        date_from: range.from,
        date_to: range.to,
      }),
    enabled: !!sid,
  });

  const createM = useMutation({
    mutationFn: createWorkRecord,
    onSuccess: () => {
      qc.invalidateQueries({ queryKey: ["work-records", sid, range.from, range.to] });
      qc.invalidateQueries({ queryKey: ["staff-summary", sid] });
    },
  });

  const patchM = useMutation({
    mutationFn: ({ id, payload }: { id: number; payload: any }) => patchWorkRecord(id, payload),
    onSuccess: () => {
      qc.invalidateQueries({ queryKey: ["work-records", sid, range.from, range.to] });
      qc.invalidateQueries({ queryKey: ["staff-summary", sid] });
    },
  });

  const deleteM = useMutation({
    mutationFn: deleteWorkRecord,
    onSuccess: () => {
      qc.invalidateQueries({ queryKey: ["work-records", sid, range.from, range.to] });
      qc.invalidateQueries({ queryKey: ["staff-summary", sid] });
    },
  });

  const rows = recordsQ.data ?? [];
  const workTypes = (workTypesQ.data ?? []) as WorkType[];

  const totals = useMemo(() => {
    const totalHours = rows.reduce((s, r) => s + Number(r.work_hours || 0), 0);
    const totalAmount = rows.reduce((s, r) => s + Number(r.amount || 0), 0);
    return {
      totalHours: Math.round(totalHours * 100) / 100,
      totalAmount,
    };
  }, [rows]);

  const createDisabledReason = locked
    ? "ë§ˆê°ëœ ì›”ì€ ê·¼ë¬´ê¸°ë¡ì„ ì¶”ê°€í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
    : !canManage
    ? "ê·¼ë¬´ê¸°ë¡ ê´€ë¦¬ëŠ” ê´€ë¦¬ìë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤."
    : "";

  if (meQ.isLoading || locksQ.isLoading || recordsQ.isLoading) {
    return <div className="text-sm text-[var(--text-muted)]">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>;
  }

  return (
    <div className="space-y-4">
      <WorkMonthLockBar
        locks={locksQ.data}
        isManager={canManage}
        onLock={() => lockM.mutate()}
      />

      {/* Toolbar */}
      <div className="flex flex-wrap items-end justify-between gap-3">
        <div className="flex flex-wrap items-end gap-3">
          <div className="space-y-1">
            <div className="text-xs font-medium text-[var(--text-muted)]">ê¸°ê°„ ì‹œì‘</div>
            <input
              type="date"
              value={range.from}
              onChange={(e) => {
                const next = e.target.value;
                // range.year/monthëŠ” from ê¸°ì¤€ìœ¼ë¡œ ê°±ì‹ 
                setRange(getMonthBoundsFrom(next));
              }}
              className="h-[38px] rounded-lg border border-[var(--border-divider)] bg-[var(--bg-surface)] px-3 text-sm outline-none"
            />
          </div>

          <div className="space-y-1">
            <div className="text-xs font-medium text-[var(--text-muted)]">ê¸°ê°„ ì¢…ë£Œ</div>
            <input
              type="date"
              value={range.to}
              onChange={(e) => setRange((p) => ({ ...p, to: e.target.value }))}
              className="h-[38px] rounded-lg border border-[var(--border-divider)] bg-[var(--bg-surface)] px-3 text-sm outline-none"
            />
          </div>

          <div className="pb-[2px] text-xs text-[var(--text-muted)]">
            í‘œì‹œ ê¸°ê°„: {range.from} ~ {range.to}
          </div>
        </div>

        <div className="flex items-center gap-2">
          <button
            onClick={() => recordsQ.refetch()}
            className="h-[38px] px-4 rounded-lg border border-[var(--border-divider)] bg-[var(--bg-surface)] text-sm font-semibold"
          >
            ìƒˆë¡œê³ ì¹¨
          </button>

          <button
            disabled={!!createDisabledReason}
            title={createDisabledReason || "ê·¼ë¬´ê¸°ë¡ ì¶”ê°€"}
            onClick={() => {
              if (createDisabledReason) return;
              setEditing(undefined);
              setModalOpen(true);
            }}
            className={["btn-primary", btnDisabledClass(!!createDisabledReason)].join(" ")}
          >
            + ê·¼ë¬´ê¸°ë¡ ì¶”ê°€
          </button>
        </div>
      </div>

      {/* Summary */}
      <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
        <div className="rounded-lg border border-[var(--border-divider)] bg-[var(--bg-surface-soft)] px-4 py-3">
          <div className="text-xs text-[var(--text-muted)]">ì´ ê·¼ë¬´ì‹œê°„</div>
          <div className="mt-1 text-lg font-semibold">{totals.totalHours} h</div>
        </div>
        <div className="rounded-lg border border-[var(--border-divider)] bg-[var(--bg-surface-soft)] px-4 py-3">
          <div className="text-xs text-[var(--text-muted)]">ì´ ê¸ˆì•¡</div>
          <div className="mt-1 text-lg font-semibold text-[var(--color-primary)]">
            {totals.totalAmount.toLocaleString()}ì›
          </div>
        </div>
      </div>

      {/* List */}
      {rows.length === 0 && (
        <EmptyState title="ê·¼ë¬´ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤" message="ê¸°ê°„ì„ ë³€ê²½í•˜ê±°ë‚˜ ê·¼ë¬´ê¸°ë¡ì„ ì¶”ê°€í•´ ë³´ì„¸ìš”." />
      )}

      {rows.length > 0 && (
        <div className="overflow-hidden rounded-xl border border-[var(--border-divider)] bg-[var(--bg-surface)]">
          <div className="grid grid-cols-[120px_200px_120px_120px_100px_120px_140px] gap-4 px-4 py-3 text-xs font-semibold text-[var(--text-muted)] border-b bg-[var(--bg-surface-soft)]">
            <div>ë‚ ì§œ</div>
            <div>ê·¼ë¬´ìœ í˜•</div>
            <div>ì‹œì‘</div>
            <div>ì¢…ë£Œ</div>
            <div>íœ´ê²Œ(ë¶„)</div>
            <div>ê·¼ë¬´ì‹œê°„</div>
            <div className="text-right">ê¸ˆì•¡ / ì‘ì—…</div>
          </div>

          {rows.map((r) => {
            const rowLockedReason = locked ? "ë§ˆê°ëœ ì›”ì€ ìˆ˜ì •/ì‚­ì œê°€ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤." : "";
            const permReason = !canManage ? "ê·¼ë¬´ê¸°ë¡ ê´€ë¦¬ëŠ” ê´€ë¦¬ìë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤." : "";
            const editDisabledReason = rowLockedReason || permReason;
            const deleteDisabledReason = rowLockedReason || permReason;

            return (
              <div
                key={r.id}
                className="grid grid-cols-[120px_200px_120px_120px_100px_120px_140px] gap-4 px-4 py-3 text-sm border-b last:border-b-0 items-center"
              >
                <div className="font-semibold">{r.date}</div>

                <div className="text-sm">
                  {r.work_type_name ?? `#${r.work_type}`}
                </div>

                <div>{(r.start_time || "").slice(0, 5)}</div>
                <div>{(r.end_time || "").slice(0, 5)}</div>
                <div>{Number(r.break_minutes || 0)}</div>
                <div>{String(r.work_hours ?? "-")} h</div>

                <div className="flex items-center justify-end gap-2">
                  <span className="font-semibold">
                    {Number(r.amount || 0).toLocaleString()}ì›
                  </span>

                  <button
                    disabled={!!editDisabledReason}
                    title={editDisabledReason || "ìˆ˜ì •"}
                    onClick={() => {
                      if (editDisabledReason) return;
                      setEditing(r);
                      setModalOpen(true);
                    }}
                    className={[
                      "px-2 py-1 text-xs rounded-md border border-[var(--border-divider)]",
                      btnDisabledClass(!!editDisabledReason),
                    ].join(" ")}
                  >
                    ìˆ˜ì •
                  </button>

                  <button
                    disabled={!!deleteDisabledReason}
                    title={deleteDisabledReason || "ì‚­ì œ"}
                    onClick={() => {
                      if (deleteDisabledReason) return;
                      if (!confirm("ì‚­ì œí• ê¹Œìš”?")) return;
                      deleteM.mutate(r.id);
                    }}
                    className={[
                      "px-2 py-1 text-xs rounded-md border border-[var(--color-danger)] text-[var(--color-danger)]",
                      btnDisabledClass(!!deleteDisabledReason),
                    ].join(" ")}
                  >
                    ì‚­ì œ
                  </button>
                </div>
              </div>
            );
          })}
        </div>
      )}

      {/* Modal */}
      <WorkRecordModal
        open={modalOpen}
        title={editing ? "ê·¼ë¬´ê¸°ë¡ ìˆ˜ì •" : "ê·¼ë¬´ê¸°ë¡ ì¶”ê°€"}
        workTypes={workTypes}
        staffId={sid}
        initialValue={editing}
        onClose={() => setModalOpen(false)}
        onSubmit={async (payload) => {
          // ì •ì±… ë³´í˜¸
          if (locked) {
            alert("ë§ˆê°ëœ ì›”ì€ ë³€ê²½í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            return;
          }
          if (!canManage) {
            alert("ê·¼ë¬´ê¸°ë¡ ê´€ë¦¬ëŠ” ê´€ë¦¬ìë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
            return;
          }

          if (!editing) {
            await createM.mutateAsync(payload);
          } else {
            await patchM.mutateAsync({
              id: editing.id,
              payload,
            });
          }
        }}
        onDelete={
          editing
            ? async () => {
                if (locked) {
                  alert("ë§ˆê°ëœ ì›”ì€ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                  return;
                }
                if (!canManage) {
                  alert("ê·¼ë¬´ê¸°ë¡ ê´€ë¦¬ëŠ” ê´€ë¦¬ìë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
                  return;
                }
                await deleteM.mutateAsync(editing.id);
              }
            : undefined
        }
      />

      <div className="text-xs text-[var(--text-muted)]">
        * ì›” ë§ˆê° ì´í›„ì—ëŠ” ê·¼ë¬´ê¸°ë¡ì´ ë³€ê²½ ë¶ˆê°€í•˜ë©°, ê¸‰ì—¬ ìŠ¤ëƒ…ìƒ·(í™•ì • ë°ì´í„°)ì´ ìƒì„±ë©ë‹ˆë‹¤.
      </div>
    </div>
  );
}
