====================================================================================================
# FRONTEND FOLDER: features__videos
# ROOT PATH: C:\academyfront\src\features\videos
====================================================================================================


==========================================================================================
# FILE: api/uploadToR2.ts
==========================================================================================
// PATH: src/features/videos/api/uploadToR2.ts

export function uploadToR2(
  uploadUrl: string,
  file: File,
  contentType: string,
  onProgress?: (percent: number) => void
): Promise<void> {
  return new Promise((resolve, reject) => {
    if (!uploadUrl) {
      reject(new Error("uploadUrl is empty"));
      return;
    }

    const xhr = new XMLHttpRequest();

    try {
      xhr.open("PUT", uploadUrl, true);
    } catch (e) {
      reject(new Error("Failed to open XHR"));
      return;
    }

    if (contentType) {
      try {
        xhr.setRequestHeader("Content-Type", contentType);
      } catch {
        // presigned URL may forbid setting headers
      }
    }

    xhr.timeout = 60_000;

    xhr.upload.onprogress = (e) => {
      if (e.lengthComputable && onProgress) {
        const percent = Math.max(
          0,
          Math.min(100, Math.round((e.loaded / e.total) * 100))
        );
        onProgress(percent);
      }
    };

    xhr.onload = () => {
      if (xhr.status >= 200 && xhr.status < 300) {
        resolve();
      } else {
        reject(
          new Error(`R2 upload failed: ${xhr.status} ${xhr.statusText}`)
        );
      }
    };

    xhr.onerror = () => reject(new Error("R2 upload network error"));
    xhr.ontimeout = () => reject(new Error("R2 upload timeout"));
    xhr.onabort = () => reject(new Error("R2 upload aborted"));

    try {
      xhr.send(file);
    } catch (e) {
      reject(new Error("R2 upload send failed"));
    }
  });
}


==========================================================================================
# FILE: api/videos.ts
==========================================================================================
// PATH: src/features/videos/api/videos.ts

import api from "@/shared/api/axios";

/**
 * Backend Video.status enum (확정)
 */
export type VideoStatus =
  | "PENDING"
  | "UPLOADED"
  | "PROCESSING"
  | "READY"
  | "FAILED";

export type VideoSourceType = "s3" | "unknown";

export interface Video {
  id: number;
  session_id: number;
  folder?: number | null; // 전체공개영상 폴더 ID
  title: string;

  file_key: string;
  duration: number | null;
  order: number;
  status: VideoStatus;

  allow_skip: boolean;
  max_speed: number;
  show_watermark: boolean;

  thumbnail?: string | null;
  hls_path: string | null;

  thumbnail_url?: string | null;
  hls_url?: string | null;

  created_at: string;
  updated_at: string;

  source_type: VideoSourceType;
}

export interface VideoDetail extends Video {}

import type { AccessMode, VideoRule } from "../types/access-mode";

export interface VideoStatsStudent {
  enrollment: number;
  student_name: string;

  progress: number;
  completed: boolean;

  attendance_status: string | null;
  effective_rule: VideoRule; // Legacy field
  access_mode?: AccessMode; // New field

  parent_phone?: string | null;
  student_phone?: string | null;
  school?: string | null;
  grade?: string | null;
}

export interface VideoStats {
  video: VideoDetail;
  students: VideoStatsStudent[];
  total_filtered?: number;
}

export interface UploadInitResponse {
  video: Video;
  upload_url: string;
  file_key: string;
  content_type: string;
}

export type PolicyImpactRule = VideoRule; // Legacy type

export interface PolicyImpactRow {
  enrollment: number;
  student_name: string;
  effective_rule: PolicyImpactRule; // Legacy field
  access_mode?: AccessMode; // New field
  attendance_status?: string | null;
  completed?: boolean;
}

export interface PolicyImpactResponse {
  eligible_count: number;
  impacted_count: number;
  changed_fields: {
    allow_skip: { before: boolean; after: boolean };
    max_speed: { before: number; after: number };
    show_watermark: { before: boolean; after: boolean };
  };
  breakdown_by_rule: Record<PolicyImpactRule, number>;
  sample: PolicyImpactRow[];
}

function safeData<T>(d: any, fallback: T): T {
  if (d == null) return fallback;
  return d;
}

/**
 * ✅ 최소 추가
 * backend의 thumbnail → frontend thumbnail_url 매핑
 */
function normalizeVideo(v: any): Video {
  if (!v) return v;
  if (!v.thumbnail_url && v.thumbnail) {
    v.thumbnail_url = v.thumbnail;
  }
  return v as Video;
}

export async function fetchSessionVideos(
  sessionId: number
): Promise<Video[]> {
  const res = await api.get("/media/videos/", {
    params: { session: sessionId },
  });

  const d = res?.data;
  if (Array.isArray(d)) return d.map(normalizeVideo);
  if (Array.isArray(d?.results)) return d.results.map(normalizeVideo);
  return [];
}

/** 전체공개영상 전용 세션 조회/생성 — 업로드·목록에 사용 (테넌트당 1개) */
export async function fetchPublicSession(): Promise<{ session_id: number; lecture_id: number }> {
  const res = await api.get<{ session_id: number; lecture_id: number }>(
    "/media/videos/public-session/"
  );
  return res.data;
}

/** 진행 중인 영상(PROCESSING, UPLOADED) 목록 — 새로고침 후 작업 박스 복원용 */
export async function fetchInProgressVideos(): Promise<Video[]> {
  const statuses: VideoStatus[] = ["PROCESSING", "UPLOADED"];
  const all: Video[] = [];
  for (const s of statuses) {
    const res = await api.get("/media/videos/", { params: { status: s } });
    const d = res?.data;
    const list = Array.isArray(d) ? d : d?.results ?? [];
    all.push(...list.map(normalizeVideo));
  }
  return all;
}

export async function fetchVideoDetail(
  videoId: number
): Promise<VideoDetail> {
  const res = await api.get(`/media/videos/${videoId}/`);
  return normalizeVideo(
    safeData<VideoDetail>(res.data, {} as any)
  );
}

export async function fetchVideoStats(
  videoId: number
): Promise<VideoStats> {
  const res = await api.get(`/media/videos/${videoId}/stats/`);
  const data = safeData<VideoStats>(res.data, {
    video: {} as any,
    students: [],
  });

  if (data.video) {
    data.video = normalizeVideo(data.video);
  }

  return data;
}

export async function retryVideo(videoId: number): Promise<void> {
  await api.post(`/media/videos/${videoId}/retry/`);
}

export async function fetchPolicyImpact(params: {
  videoId: number;
  allow_skip: boolean;
  max_speed: number;
  show_watermark: boolean;
}): Promise<PolicyImpactResponse> {
  const res = await api.get(
    `/media/videos/${params.videoId}/policy-impact/`,
    {
      params: {
        allow_skip: params.allow_skip,
        max_speed: params.max_speed,
        show_watermark: params.show_watermark,
      },
    }
  );
  return safeData<PolicyImpactResponse>(res.data, {
    eligible_count: 0,
    impacted_count: 0,
    changed_fields: {
      allow_skip: { before: false, after: false },
      max_speed: { before: 1, after: 1 },
      show_watermark: { before: false, after: false },
    },
    breakdown_by_rule: { free: 0, once: 0, blocked: 0 },
    sample: [],
  });
}

export async function uploadInit(payload: {
  session: number;
  title: string;
  filename: string;
  content_type: string;
  allow_skip?: boolean;
  max_speed?: number;
  show_watermark?: boolean;
}): Promise<UploadInitResponse> {
  const res = await api.post("/media/videos/upload/init/", payload);
  res.data.video = normalizeVideo(res.data.video);
  return res.data;
}

export async function uploadComplete(
  videoId: number
): Promise<void> {
  await api.post(`/media/videos/${videoId}/upload/complete/`);
}

// ========================================================
// Video Folders (전체공개영상 폴더 구조)
// ========================================================

export type VideoFolder = {
  id: number;
  name: string;
  session_id: number;
  parent_id: number | null;
  order: number;
  created_at: string;
  updated_at: string;
};

export async function fetchVideoFolders(sessionId: number): Promise<VideoFolder[]> {
  const res = await api.get<VideoFolder[]>("/media/videos/folders/", {
    params: { session_id: sessionId },
  });
  return res.data;
}

export async function createVideoFolder(
  sessionId: number,
  name: string,
  parentId?: number | null
): Promise<VideoFolder> {
  const res = await api.post<VideoFolder>("/media/videos/folders/", {
    session_id: sessionId,
    name,
    parent_id: parentId ?? null,
  });
  return res.data;
}

export async function deleteVideoFolder(folderId: number): Promise<void> {
  await api.delete(`/media/videos/folders/${folderId}/`);
}


==========================================================================================
# FILE: audit/api/playbackAudit.ts
==========================================================================================
// PATH: src/features/videos/audit/api/playbackAudit.ts

import api from "@/shared/api/axios";

export function fetchPlaybackSessions(videoId: number) {
  return api
    .get(`/media/admin/videos/${videoId}/sessions/`)
    .then((res) => res.data);
}

export function fetchPlaybackEvents(sessionId: string) {
  return api
    .get(`/media/admin/playback-sessions/${sessionId}/events/`)
    .then((res) => res.data);
}


==========================================================================================
# FILE: audit/components/EventDetailModal.tsx
==========================================================================================
// PATH: src/features/videos/audit/components/EventDetailModal.tsx

interface Props {
  event: any;
  onClose: () => void;
}

export default function EventDetailModal({ event, onClose }: Props) {
  if (!event) return null;

  return (
    <div className="fixed inset-0 bg-black/40 flex items-center justify-center z-50 p-4">
      <div className="w-full max-w-[800px] max-h-[80vh] overflow-hidden rounded-xl bg-[var(--bg-surface)] shadow-xl">
        {/* ✅ header = 텍스트 블록 */}
        <div className="px-5 py-4">
          <div className="flex items-start justify-between gap-4">
            <div>
              <div className="text-sm font-semibold text-[var(--text-primary)]">
                이벤트 상세
              </div>
              <div className="mt-1 text-xs text-[var(--text-muted)]">
                재생 이벤트 원본 데이터 / 정책 스냅샷
              </div>
            </div>

            <button
              onClick={onClose}
              className="shrink-0 rounded border border-[var(--border-divider)] bg-[var(--bg-surface)] px-3 py-1.5 text-xs text-[var(--text-secondary)] hover:bg-[var(--bg-surface-soft)]"
            >
              닫기
            </button>
          </div>
        </div>

        {/* ✅ body = surface */}
        <div className="px-5 pb-5">
          <div className="bg-[var(--bg-surface-soft)] rounded-lg p-4 space-y-4 text-sm overflow-auto max-h-[70vh]">
            <Section
              title="기본 정보"
              data={{
                event_type: event.event_type,
                violated: event.violated,
                violation_reason: event.violation_reason,
                occurred_at: event.occurred_at,
                session_id: event.session_id,
              }}
            />

            <Section title="Payload" data={event.event_payload} />
            <Section title="Policy Snapshot" data={event.policy_snapshot} />
          </div>
        </div>
      </div>
    </div>
  );
}

function Section({ title, data }: { title: string; data: any }) {
  return (
    <div>
      <div className="text-xs font-semibold text-[var(--text-primary)] mb-2">
        {title}
      </div>
      <pre className="bg-[var(--bg-app)] rounded p-3 text-xs overflow-auto whitespace-pre-wrap text-[var(--text-secondary)]">
        {JSON.stringify(data || {}, null, 2)}
      </pre>
    </div>
  );
}


==========================================================================================
# FILE: audit/components/PlaybackEventTimeline.tsx
==========================================================================================
// PATH: src/features/videos/audit/components/PlaybackEventTimeline.tsx

import { PLAYBACK_EVENT_LABELS } from "../utils/eventLabels";
import { isAnomalyEvent } from "../utils/anomaly";

type PlaybackEvent = {
  id?: number;
  type: string;
  occurred_at?: number;
  payload?: Record<string, any>;
};

type Props = {
  events: PlaybackEvent[];
};

export default function PlaybackEventTimeline({ events }: Props) {
  if (!events.length) {
    return (
      <div className="text-sm text-[var(--text-muted)]">
        기록된 이벤트가 없습니다.
      </div>
    );
  }

  return (
    <div className="space-y-2">
      {events.map((e, idx) => {
        const label = PLAYBACK_EVENT_LABELS[e.type] ?? e.type;
        const anomaly = isAnomalyEvent(e.type);

        return (
          <div
            key={e.id ?? idx}
            className={`flex items-start gap-3 border-b border-[var(--border-divider)] pb-2 text-sm ${
              anomaly ? "bg-red-50" : ""
            }`}
          >
            <div className="w-20 shrink-0 text-[var(--text-muted)]">
              {e.occurred_at
                ? new Date(e.occurred_at * 1000).toLocaleTimeString("ko-KR")
                : "-"}
            </div>

            <div className="flex-1">
              <div
                className={`font-medium ${
                  anomaly ? "text-red-600" : "text-[var(--text-primary)]"
                }`}
              >
                {label}
              </div>

              {e.payload && (
                <pre className="mt-1 rounded bg-[var(--bg-surface-soft)] px-2 py-1 text-xs text-[var(--text-secondary)] overflow-x-auto">
                  {JSON.stringify(e.payload, null, 2)}
                </pre>
              )}
            </div>
          </div>
        );
      })}
    </div>
  );
}


==========================================================================================
# FILE: audit/components/PlaybackSessionTable.tsx
==========================================================================================
// PATH: src/features/videos/audit/components/PlaybackSessionTable.tsx

type PlaybackSession = {
  id: number;
  student_name: string;
  device_id: string;
  started_at: string;
  ended_at?: string | null;
  status: string;
};

type Props = {
  sessions: PlaybackSession[];
  selectedSessionId?: number | null;
  onSelect: (sessionId: number) => void;
};

export default function PlaybackSessionTable({
  sessions,
  selectedSessionId,
  onSelect,
}: Props) {
  if (!sessions.length) {
    return (
      <div className="text-sm text-[var(--text-muted)]">
        재생 세션이 없습니다.
      </div>
    );
  }

  return (
    <div className="rounded-xl border border-[var(--border-divider)] bg-[var(--bg-surface)] overflow-hidden">
      <table className="w-full text-sm">
        <thead className="bg-[var(--bg-surface-soft)] text-[var(--text-secondary)]">
          <tr>
            <th className="px-3 py-2 text-left">학생</th>
            <th className="px-3 py-2 text-left">기기</th>
            <th className="px-3 py-2 text-center">시작</th>
            <th className="px-3 py-2 text-center">종료</th>
            <th className="px-3 py-2 text-center">상태</th>
          </tr>
        </thead>

        <tbody>
          {sessions.map((s) => {
            const active = s.id === selectedSessionId;

            return (
              <tr
                key={s.id}
                onClick={() => onSelect(s.id)}
                className={`cursor-pointer border-t border-[var(--border-divider)] ${
                  active
                    ? "bg-[var(--bg-surface-soft)]"
                    : "hover:bg-[var(--bg-surface-soft)]"
                }`}
              >
                <td className="px-3 py-2 font-medium">{s.student_name}</td>
                <td className="px-3 py-2 text-xs text-[var(--text-secondary)]">
                  {s.device_id}
                </td>
                <td className="px-3 py-2 text-center text-xs">
                  {s.started_at
                    ? new Date(s.started_at).toLocaleString("ko-KR")
                    : "-"}
                </td>
                <td className="px-3 py-2 text-center text-xs">
                  {s.ended_at ? new Date(s.ended_at).toLocaleString("ko-KR") : "-"}
                </td>
                <td className="px-3 py-2 text-center text-xs">{s.status}</td>
              </tr>
            );
          })}
        </tbody>
      </table>
    </div>
  );
}


==========================================================================================
# FILE: audit/pages/VideoAuditPage.tsx
==========================================================================================
// PATH: src/features/videos/audit/pages/VideoAuditPage.tsx

import { useState } from "react";
import { useQuery } from "@tanstack/react-query";

import { fetchPlaybackSessions, fetchPlaybackEvents } from "../api/playbackAudit";
import PlaybackSessionTable from "../components/PlaybackSessionTable";
import PlaybackEventTimeline from "../components/PlaybackEventTimeline";

export default function VideoAuditPage({ videoId }: { videoId: number }) {
  const [selectedSession, setSelectedSession] = useState<string | null>(null);

  const { data: sessions } = useQuery({
    queryKey: ["audit-sessions", videoId],
    queryFn: () => fetchPlaybackSessions(videoId),
    enabled: !!videoId,
    staleTime: 5000,
    retry: 1,
  });

  const { data: events } = useQuery({
    queryKey: ["audit-events", selectedSession],
    queryFn: () => fetchPlaybackEvents(selectedSession!),
    enabled: !!selectedSession,
    staleTime: 3000,
    retry: 1,
  });

  return (
    <div className="space-y-6">
      <div className="grid grid-cols-2 gap-6">
        {/* SESSION LIST */}
        <section className="bg-[var(--bg-surface)] rounded-xl px-5 py-4 space-y-3">
          <div className="text-sm font-semibold text-[var(--text-primary)]">
            재생 세션
          </div>

          <PlaybackSessionTable
            sessions={sessions?.results ?? sessions ?? []}
            selectedSessionId={selectedSession ? Number(selectedSession) : null}
            onSelect={(id) => setSelectedSession(String(id))}
          />
        </section>

        {/* EVENT TIMELINE */}
        <section className="bg-[var(--bg-surface)] rounded-xl px-5 py-4 space-y-3">
          <div className="text-sm font-semibold text-[var(--text-primary)]">
            이벤트 타임라인
          </div>

          {selectedSession ? (
            <PlaybackEventTimeline events={events?.results ?? events ?? []} />
          ) : (
            <div className="text-sm text-[var(--text-muted)]">
              세션을 선택하세요.
            </div>
          )}
        </section>
      </div>
    </div>
  );
}


==========================================================================================
# FILE: audit/utils/anomaly.ts
==========================================================================================
// v1 기준: "위험 신호"만 표시 (판단/차단 ❌)

export const ANOMALY_EVENT_TYPES = new Set([
  "SEEK_ATTEMPT",
  "SPEED_CHANGE_ATTEMPT",
]);

export function isAnomalyEvent(type: string): boolean {
  return ANOMALY_EVENT_TYPES.has(type);
}


==========================================================================================
# FILE: audit/utils/eventLabels.ts
==========================================================================================
// src/features/videos/audit/utils/eventLabels.ts

// 관리자 audit 전용 이벤트 라벨 매핑
// ⚠️ backend enum 변경 금지 (v1 exact match)

export const PLAYBACK_EVENT_LABELS: Record<string, string> = {
  VISIBILITY_HIDDEN: "탭 이탈",
  VISIBILITY_VISIBLE: "탭 복귀",

  FOCUS_LOST: "포커스 잃음",
  FOCUS_GAINED: "포커스 획득",

  SEEK_ATTEMPT: "구간 이동 시도",
  SPEED_CHANGE_ATTEMPT: "배속 변경 시도",

  FULLSCREEN_ENTER: "전체화면 진입",
  FULLSCREEN_EXIT: "전체화면 종료",

  PLAYER_ERROR: "재생 오류",
};


==========================================================================================
# FILE: components/VideoExplorer.module.css
==========================================================================================
/* 영상 탐색기 — 저장소/메시지/시험과 동일한 폴더트리형 SSOT */

.root {
  display: flex;
  flex-direction: column;
  min-height: 400px;
  border-radius: var(--radius-lg);
  border: 1px solid var(--color-border-divider);
  background: var(--color-bg-surface);
  overflow: hidden;
}

.toolbar {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: var(--space-4);
  padding: var(--space-3) var(--space-4);
  border-bottom: 1px solid var(--color-border-divider);
  background: color-mix(in srgb, var(--color-brand-primary) 6%, var(--color-bg-surface));
}

.actions {
  display: flex;
  align-items: center;
  gap: var(--space-2);
}

.body {
  display: flex;
  flex: 1;
  min-height: 0;
}

.tree {
  width: 200px;
  min-width: 200px;
  border-right: 1px solid var(--color-border-divider);
  overflow: auto;
}

.gridWrap {
  flex: 1;
  padding: var(--space-4);
  overflow: auto;
}

/* 전체공개영상 영역 시각적 구분 */
.gridWrapPublic {
  background: color-mix(in srgb, var(--color-brand-primary) 4%, var(--color-bg-surface));
  border-left: 3px solid var(--color-brand-primary);
  padding-left: calc(var(--space-4) - 3px);
  position: relative;
}

.gridWrapPublic::before {
  content: "전체공개영상";
  position: absolute;
  top: var(--space-4);
  left: var(--space-4);
  font-size: 11px;
  font-weight: 600;
  color: var(--color-brand-primary);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  padding: var(--space-1) var(--space-2);
  background: color-mix(in srgb, var(--color-brand-primary) 12%, var(--color-bg-surface));
  border-radius: var(--radius-sm);
  border: 1px solid color-mix(in srgb, var(--color-brand-primary) 20%, transparent);
  z-index: 1;
}

.gridWrapPublic .grid {
  margin-top: calc(var(--space-2) + 24px); /* 라벨 높이만큼 여백 */
}

.gridWrapPublic .placeholder {
  margin-top: calc(var(--space-2) + 24px);
}

.emptyStateWrapper {
  margin-top: calc(var(--space-2) + 24px);
}

.placeholder {
  display: flex;
  align-items: center;
  justify-content: center;
  min-height: 200px;
  color: var(--color-text-muted);
  font-size: 13px;
}

.grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
  gap: var(--space-4);
}

.item {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-start;
  gap: var(--space-2);
  padding: var(--space-3);
  border-radius: var(--radius-md);
  border: 1px solid var(--color-border-divider);
  background: var(--color-bg-surface);
  cursor: pointer;
  font-size: 12px;
  font-weight: 600;
  color: var(--color-text-primary);
  transition: background 0.15s, border-color 0.15s;
}

.item:hover {
  background: var(--color-bg-surface-hover);
  border-color: color-mix(in srgb, var(--color-brand-primary) 30%, var(--color-border-divider));
}

.itemAdd {
  border-style: dashed;
  color: var(--color-text-muted);
}

.itemAdd:hover {
  color: var(--color-brand-primary);
}

.itemLabel {
  text-align: center;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  width: 100%;
}

.itemMeta {
  font-size: 10px;
  font-weight: 500;
  color: var(--color-text-muted);
}


==========================================================================================
# FILE: components/VideoExplorerTree.module.css
==========================================================================================
.root {
  padding: var(--space-2);
  font-size: 13px;
}

.node {
  margin-bottom: var(--space-2);
}

.lectureLabel {
  display: flex;
  align-items: center;
  gap: var(--space-2);
  padding: var(--space-1) var(--space-2);
  font-weight: 600;
  color: var(--color-text-primary);
}

.children {
  margin-left: var(--space-4);
}

.item {
  display: flex;
  align-items: center;
  gap: var(--space-2);
  width: 100%;
  padding: var(--space-1) var(--space-2);
  border: none;
  border-radius: var(--radius-sm);
  background: transparent;
  color: var(--color-text-primary);
  cursor: pointer;
  text-align: left;
  font-size: 13px;
  font-weight: 500;
}

.item:hover {
  background: var(--color-bg-surface-hover);
}

.itemActive {
  background: color-mix(in srgb, var(--color-brand-primary) 15%, transparent);
  color: var(--color-brand-primary);
}

/* 전체공개영상 최상단 항목 강조 스타일 */
.itemPublic {
  font-weight: 600;
  font-size: 14px;
  padding: var(--space-2) var(--space-3);
  margin-bottom: var(--space-3);
  border: 1px solid color-mix(in srgb, var(--color-brand-primary) 20%, transparent);
  background: color-mix(in srgb, var(--color-brand-primary) 8%, var(--color-bg-surface));
  color: var(--color-brand-primary);
  transition: all 0.15s ease;
}

.itemPublic:hover {
  background: color-mix(in srgb, var(--color-brand-primary) 12%, var(--color-bg-surface));
  border-color: color-mix(in srgb, var(--color-brand-primary) 30%, transparent);
  transform: translateX(2px);
}

.itemPublic.itemActive {
  background: color-mix(in srgb, var(--color-brand-primary) 18%, var(--color-bg-surface));
  border-color: var(--color-brand-primary);
  box-shadow: 0 0 0 2px color-mix(in srgb, var(--color-brand-primary) 10%, transparent);
}


==========================================================================================
# FILE: components/VideoExplorerTree.tsx
==========================================================================================
// 좌측 폴더 트리 — 영상: 전체공개영상(맨위) + 강의명 > 1~n차시

import { FolderOpen } from "lucide-react";
import type { Lecture } from "@/features/lectures/api/sessions";
import type { Session } from "@/features/lectures/api/sessions";
import type { VideoFolder } from "../api/videos";
import styles from "./VideoExplorerTree.module.css";

type LectureWithSessions = Lecture & { sessions?: Session[] };

export type VideoFolderId = "public" | number | null; // "public" | sessionId | folderId (음수는 폴더 ID)

type Props = {
  lectures: LectureWithSessions[];
  publicFolders?: VideoFolder[];
  currentFolderId: VideoFolderId;
  onSelectFolder: (folderId: VideoFolderId) => void;
};

function formatSessionTitle(s: Session): string {
  const order = s.order ?? 0;
  const date = s.date ? new Date(s.date).toLocaleDateString("ko-KR", { month: "2-digit", day: "2-digit" }) : "";
  return date ? `${order}차시 ${date}` : `${order}차시`;
}

function FolderTreeNode({
  folder,
  allFolders,
  currentFolderId,
  onSelectFolder,
  level = 0,
}: {
  folder: VideoFolder;
  allFolders: VideoFolder[];
  currentFolderId: VideoFolderId;
  onSelectFolder: (folderId: VideoFolderId) => void;
  level?: number;
}) {
  const children = allFolders.filter((f) => f.parent_id === folder.id);
  const folderId = -folder.id; // 음수로 폴더 ID 구분
  const isActive = currentFolderId === folderId;

  return (
    <div className={styles.node}>
      <button
        type="button"
        className={styles.item + (isActive ? " " + styles.itemActive : "")}
        onClick={() => onSelectFolder(folderId)}
        style={{ marginLeft: `${level * 16}px` }}
      >
        <FolderOpen size={16} aria-hidden />
        <span>{folder.name}</span>
      </button>
      {children.length > 0 && (
        <div className={styles.children}>
          {children.map((child) => (
            <FolderTreeNode
              key={child.id}
              folder={child}
              allFolders={allFolders}
              currentFolderId={currentFolderId}
              onSelectFolder={onSelectFolder}
              level={level + 1}
            />
          ))}
        </div>
      )}
    </div>
  );
}

export default function VideoExplorerTree({
  lectures,
  publicFolders = [],
  currentFolderId,
  onSelectFolder,
}: Props) {
  const rootFolders = publicFolders.filter((f) => !f.parent_id);

  return (
    <div className={styles.root}>
      <button
        type="button"
        className={
          styles.item +
          " " +
          styles.itemPublic +
          (currentFolderId === "public" ? " " + styles.itemActive : "")
        }
        onClick={() => onSelectFolder("public")}
      >
        <FolderOpen size={18} aria-hidden />
        <span>전체공개영상</span>
      </button>
      {currentFolderId === "public" && rootFolders.length > 0 && (
        <div className={styles.children}>
          {rootFolders.map((folder) => (
            <FolderTreeNode
              key={folder.id}
              folder={folder}
              allFolders={publicFolders}
              currentFolderId={currentFolderId}
              onSelectFolder={onSelectFolder}
            />
          ))}
        </div>
      )}
      {lectures.map((lec) => {
        const sessions = lec.sessions ?? [];
        return (
          <div key={lec.id} className={styles.node}>
            <div className={styles.lectureLabel}>
              <FolderOpen size={16} aria-hidden />
              <span>{lec.title || lec.name || "강의"}</span>
            </div>
            {sessions.length > 0 && (
              <div className={styles.children}>
                {sessions.map((s) => {
                  const isActive = currentFolderId === s.id;
                  return (
                    <button
                      key={s.id}
                      type="button"
                      className={styles.item + (isActive ? " " + styles.itemActive : "")}
                      onClick={() => onSelectFolder(s.id)}
                    >
                      <FolderOpen size={16} aria-hidden />
                      <span>{formatSessionTitle(s)}</span>
                    </button>
                  );
                })}
              </div>
            )}
          </div>
        );
      })}
    </div>
  );
}


==========================================================================================
# FILE: components/features/video-analytics/JsonViewerModal.tsx
==========================================================================================
// PATH: src/features/videos/components/features/video-analytics/JsonViewerModal.tsx

import { useMemo } from "react";

interface Props {
  open: boolean;
  title: string;
  payload: any;
  snapshot: any;
  onClose: () => void;
}

export default function JsonViewerModal({
  open,
  title,
  payload,
  snapshot,
  onClose,
}: Props) {
  const prettyPayload = useMemo(
    () => JSON.stringify(payload ?? {}, null, 2),
    [payload]
  );
  const prettySnap = useMemo(
    () => JSON.stringify(snapshot ?? {}, null, 2),
    [snapshot]
  );

  if (!open) return null;

  return (
    <div className="fixed inset-0 bg-black/40 flex items-center justify-center z-[400] p-4">
      <div className="w-[900px] h-[600px] rounded-xl bg-[var(--bg-surface)] shadow-xl overflow-hidden flex flex-col">
        {/* ✅ header = 텍스트 블록 */}
        <div className="px-5 py-4">
          <div className="flex items-start justify-between gap-4">
            <div>
              <div className="text-sm font-semibold text-[var(--text-primary)]">
                {title}
              </div>
              <div className="mt-1 text-xs text-[var(--text-muted)]">
                event_payload / policy_snapshot 비교
              </div>
            </div>

            <button
              className="shrink-0 rounded border border-[var(--border-divider)] bg-[var(--bg-surface)] px-3 py-1.5 text-xs text-[var(--text-secondary)] hover:bg-[var(--bg-surface-soft)]"
              onClick={onClose}
            >
              닫기
            </button>
          </div>
        </div>

        {/* ✅ body = surface */}
        <div className="px-5 pb-5 flex-1 min-h-0">
          <div className="bg-[var(--bg-surface-soft)] rounded-lg p-4 h-full min-h-0">
            <div className="h-full grid grid-cols-2 gap-3 min-h-0">
              <div className="rounded-lg bg-[var(--bg-surface)] overflow-hidden flex flex-col min-h-0">
                <div className="px-3 py-2 text-xs font-semibold text-[var(--text-secondary)]">
                  event_payload
                </div>
                <pre className="flex-1 p-3 text-[12px] overflow-auto whitespace-pre-wrap text-[var(--text-secondary)] bg-[var(--bg-app)]">
                  {prettyPayload}
                </pre>
              </div>

              <div className="rounded-lg bg-[var(--bg-surface)] overflow-hidden flex flex-col min-h-0">
                <div className="px-3 py-2 text-xs font-semibold text-[var(--text-secondary)]">
                  policy_snapshot
                </div>
                <pre className="flex-1 p-3 text-[12px] overflow-auto whitespace-pre-wrap text-[var(--text-secondary)] bg-[var(--bg-app)]">
                  {prettySnap}
                </pre>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}


==========================================================================================
# FILE: components/features/video-analytics/VideoAchievementTab.tsx
==========================================================================================
// PATH: src/features/videos/components/features/video-analytics/VideoAchievementTab.tsx

import { useMemo, useState } from "react";
import { useQuery } from "@tanstack/react-query";
import api from "@/shared/api/axios";

import {
  ResponsiveContainer,
  BarChart,
  Bar,
  XAxis,
  YAxis,
  Tooltip,
  CartesianGrid,
} from "recharts";

type Props = {
  videoId: number;
  onSelectStudent?: (enrollmentId: number) => void;
};

type Row = {
  enrollment: number;
  student_name: string;
  progress: number; // 0~100
  completed: boolean;
  watched_seconds: number;
  status: "completed" | "warning" | "danger";
};

function formatSeconds(sec: number) {
  const s = Math.max(0, Math.floor(sec || 0));
  const m = Math.floor(s / 60);
  const r = s % 60;
  if (m > 0) return `${m}분 ${r}초`;
  return `${r}초`;
}

/** 사이즈·색상 SSOT: ds-status-badge + data-tone (success/danger/warning) */
function StatusBadge({ status }: { status: Row["status"] }) {
  const tone = status === "completed" ? "success" : status === "danger" ? "danger" : "warning";
  const label: Record<Row["status"], string> = {
    completed: "완료",
    warning: "주의",
    danger: "위험",
  };
  return (
    <span className="ds-status-badge" data-tone={tone}>
      {label[status]}
    </span>
  );
}

function KpiCard({
  label,
  value,
  sub,
}: {
  label: string;
  value: string | number;
  sub?: string;
}) {
  return (
    <div className="rounded-xl border border-[var(--border-divider)] bg-[var(--bg-surface)] p-4">
      <div className="text-xs text-[var(--text-muted)]">{label}</div>
      <div className="mt-1 text-2xl font-bold text-[var(--text-primary)]">
        {value}
      </div>
      {sub ? (
        <div className="mt-1 text-xs text-[var(--text-muted)]">{sub}</div>
      ) : null}
    </div>
  );
}

export default function VideoAchievementTab({ videoId, onSelectStudent }: Props) {
  const [sortKey, setSortKey] = useState<"progress" | "name" | "status">("status");

  const { data, isFetching } = useQuery({
    queryKey: ["video", videoId, "achievement"],
    queryFn: async () => {
      const res = await api.get(`/media/videos/${videoId}/achievement/`);
      return res.data;
    },
    enabled: !!videoId,
    staleTime: 5000,
    retry: 1,
  });

  const students: Row[] = data?.students ?? [];
  const summary = data?.summary;

  const dist = useMemo(() => {
    const buckets = [
      { key: "0-49", label: "0~49%", count: 0 },
      { key: "50-79", label: "50~79%", count: 0 },
      { key: "80-94", label: "80~94%", count: 0 },
      { key: "95-100", label: "95~100%", count: 0 },
    ];

    for (const s of students) {
      const p = Number(s.progress ?? 0);
      if (p < 50) buckets[0].count += 1;
      else if (p < 80) buckets[1].count += 1;
      else if (p < 95) buckets[2].count += 1;
      else buckets[3].count += 1;
    }

    return buckets;
  }, [students]);

  const sorted = useMemo(() => {
    const copy = [...students];

    const statusRank: Record<Row["status"], number> = {
      danger: 0,
      warning: 1,
      completed: 2,
    };

    if (sortKey === "progress") {
      copy.sort((a, b) => (b.progress ?? 0) - (a.progress ?? 0));
    } else if (sortKey === "name") {
      copy.sort((a, b) => (a.student_name || "").localeCompare(b.student_name || ""));
    } else {
      copy.sort((a, b) => {
        const ra = statusRank[a.status] ?? 99;
        const rb = statusRank[b.status] ?? 99;
        if (ra !== rb) return ra - rb;
        return (a.student_name || "").localeCompare(b.student_name || "");
      });
    }
    return copy;
  }, [students, sortKey]);

  if (!data) return null;

  return (
    <div className="flex h-full flex-col gap-4">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div>
          <div className="text-sm font-semibold text-[var(--text-primary)]">
            학습 성취도{" "}
            {isFetching ? (
              <span className="ml-2 text-xs text-[var(--text-muted)]">
                동기화 중...
              </span>
            ) : null}
          </div>
          <div className="mt-1 text-xs text-[var(--text-muted)]">
            * 출석이 <b>ONLINE(영상)</b> 인 학생만 집계합니다.
          </div>
        </div>

        <div className="flex items-center gap-2">
          <div className="text-xs text-[var(--text-muted)]">정렬</div>
          <select
            className="rounded border border-[var(--border-divider)] bg-[var(--bg-surface)] px-2 py-1 text-xs text-[var(--text-primary)]"
            value={sortKey}
            onChange={(e) => setSortKey(e.target.value as any)}
          >
            <option value="status">상태(위험→완료)</option>
            <option value="progress">진도(높은순)</option>
            <option value="name">이름(가나다)</option>
          </select>
        </div>
      </div>

      {/* KPI */}
      <div className="grid grid-cols-4 gap-3">
        <KpiCard label="영상 수강 학생" value={`${summary?.total_students ?? 0}명`} />
        <KpiCard label="평균 진도율" value={`${summary?.avg_progress ?? 0}%`} />
        <KpiCard label="완료율" value={`${summary?.completed_rate ?? 0}%`} />
        <KpiCard label="미완료" value={`${summary?.incomplete_count ?? 0}명`} />
      </div>

      {/* Chart + Table */}
      <div className="grid flex-1 min-h-0 grid-cols-12 gap-4">
        {/* Chart */}
        <div className="col-span-5 flex min-h-0 flex-col rounded-xl border border-[var(--border-divider)] bg-[var(--bg-surface)] p-4">
          <div className="mb-2 text-sm font-semibold text-[var(--text-primary)]">
            진도 분포
          </div>
          <div className="flex-1 min-h-0">
            <ResponsiveContainer width="100%" height="100%">
              <BarChart
                data={dist}
                margin={{ left: 10, right: 10, top: 10, bottom: 10 }}
              >
                <CartesianGrid strokeDasharray="3 3" />
                <XAxis dataKey="label" tick={{ fontSize: 12 }} />
                <YAxis allowDecimals={false} tick={{ fontSize: 12 }} />
                <Tooltip
                  contentStyle={{
                    background: "var(--bg-surface-soft)",
                    border: "1px solid var(--border-divider)",
                    borderRadius: 8,
                    fontSize: 12,
                    color: "var(--text-primary)",
                  }}
                  labelStyle={{ color: "var(--text-secondary)" }}
                />
                <Bar dataKey="count" />
              </BarChart>
            </ResponsiveContainer>
          </div>

          <div className="mt-3 text-xs text-[var(--text-muted)]">
            * 95% 이상은 “완료”로 간주(백엔드 status 기준)
          </div>
        </div>

        {/* Table */}
        <div className="col-span-7 flex min-h-0 flex-col overflow-hidden rounded-xl border border-[var(--border-divider)] bg-[var(--bg-surface)]">
          <div className="flex items-center justify-between border-b border-[var(--border-divider)] bg-[var(--bg-surface-soft)] px-3 py-2 text-sm font-semibold">
            <span>학생별 현황</span>
            <span className="text-xs text-[var(--text-muted)]">
              클릭 → 권한 탭으로 이동
            </span>
          </div>

          <div className="grid grid-cols-12 border-b border-[var(--border-divider)] bg-[var(--bg-surface)] px-3 py-2 text-xs font-semibold text-[var(--text-secondary)]">
            <div className="col-span-3">이름</div>
            <div className="col-span-2 text-center">상태</div>
            <div className="col-span-2 text-center">진도</div>
            <div className="col-span-3">시청 위치</div>
            <div className="col-span-2 text-right">완료</div>
          </div>

          <div className="flex-1 overflow-auto">
            {sorted.length === 0 ? (
              <div className="p-4 text-sm text-[var(--text-muted)]">
                영상 수강(ONLINE) 학생이 없습니다.
              </div>
            ) : (
              sorted.map((s) => (
                <button
                  key={s.enrollment}
                  className="grid w-full grid-cols-12 border-b border-[var(--border-divider)] px-3 py-2 text-left text-sm hover:bg-[var(--bg-surface-soft)]"
                  onClick={() => onSelectStudent?.(s.enrollment)}
                >
                  <div className="col-span-3 truncate font-medium">
                    {s.student_name}
                  </div>
                  <div className="col-span-2 flex justify-center">
                    <StatusBadge status={s.status} />
                  </div>
                  <div className="col-span-2 text-center font-semibold">
                    {Number(s.progress ?? 0).toFixed(1)}%
                  </div>
                  <div className="col-span-3 text-[var(--text-secondary)]">
                    {formatSeconds(s.watched_seconds)}
                  </div>
                  <div className="col-span-2 text-right text-[var(--text-secondary)]">
                    {s.completed ? "Y" : "-"}
                  </div>
                </button>
              ))
            )}
          </div>
        </div>
      </div>
    </div>
  );
}


==========================================================================================
# FILE: components/features/video-analytics/VideoLogTab.tsx
==========================================================================================
// PATH: src/features/videos/components/features/video-analytics/VideoLogTab.tsx

import { useMemo, useState } from "react";
import { useQuery } from "@tanstack/react-query";
import api from "@/shared/api/axios";
import JsonViewerModal from "./JsonViewerModal";

type RangeKey = "24h" | "7d" | "all";

const SEV_COLORS: Record<string, string> = {
  danger: "bg-red-600",
  warn: "bg-yellow-500",
  info: "bg-[var(--bg-surface-muted)] text-[var(--text-secondary)]",
};

type Props = {
  videoId: number;
  onClickRiskStudent: (enrollmentId: number) => void;
};

export default function VideoLogTab({ videoId, onClickRiskStudent }: Props) {
  const [range, setRange] = useState<RangeKey>("24h");
  const [page, setPage] = useState(1);
  const pageSize = 50;

  const [selectedEvent, setSelectedEvent] = useState<any | null>(null);

  const listQueryKey = useMemo(
    () => ["video", videoId, "events", range, page],
    [videoId, range, page]
  );
  const riskQueryKey = useMemo(
    () => ["video", videoId, "events-risk", range],
    [videoId, range]
  );

  const { data: listData, isFetching } = useQuery({
    queryKey: listQueryKey,
    queryFn: async () => {
      const res = await api.get("/media/video-playback-events/", {
        params: { video: videoId, range, page, page_size: pageSize },
      });
      return res.data;
    },
    enabled: !!videoId,
    staleTime: 3000,
    retry: 1,
  });

  const { data: riskData } = useQuery({
    queryKey: riskQueryKey,
    queryFn: async () => {
      const res = await api.get("/media/video-playback-events/risk/", {
        params: { video: videoId, range, limit: 5 },
      });
      return res.data;
    },
    enabled: !!videoId,
    staleTime: 3000,
    retry: 1,
  });

  const events = useMemo(() => {
    if (!listData) return [];
    if (Array.isArray(listData)) return listData;
    return listData.results ?? [];
  }, [listData]);

  const totalCount = useMemo(() => {
    if (!listData) return 0;
    if (Array.isArray(listData)) return listData.length;
    return Number(listData.count ?? 0);
  }, [listData]);

  const riskTop = Array.isArray(riskData) ? riskData : riskData ?? [];

  const canPrev = page > 1;
  const canNext = events.length === pageSize;

  return (
    <div className="h-full flex gap-4">
      {/* LEFT */}
      <div className="w-[300px] rounded-xl border border-[var(--border-divider)] bg-[var(--bg-surface)] overflow-hidden flex flex-col">
        <div className="px-3 py-2 border-b border-[var(--border-divider)] bg-[var(--bg-surface-soft)] text-sm font-semibold">
          위반 / 이상 징후 학생
        </div>

        <div className="p-3 space-y-3">
          <div className="flex gap-2">
            {(["24h", "7d", "all"] as const).map((k) => (
              <button
                key={k}
                className={`text-xs px-2 py-1 rounded border border-[var(--border-divider)] ${
                  range === k
                    ? "bg-[var(--bg-surface)] font-semibold"
                    : "bg-[var(--bg-surface-soft)]"
                }`}
                onClick={() => {
                  setRange(k);
                  setPage(1);
                }}
              >
                {k === "24h" ? "24h" : k === "7d" ? "7d" : "전체"}
              </button>
            ))}
          </div>

          <button
            className="w-full text-xs px-3 py-2 rounded border border-[var(--border-divider)] bg-[var(--bg-surface)] hover:bg-[var(--bg-surface-soft)]"
            type="button"
          >
            CSV Export
          </button>

          <div className="text-[11px] text-[var(--text-muted)]">
            * 학생 클릭 → <b>권한 설정 탭</b>에서 해당 학생만 표시
          </div>

          <div className="space-y-2">
            {riskTop.length === 0 ? (
              <div className="text-xs text-[var(--text-muted)] p-2">
                데이터 없음
              </div>
            ) : (
              riskTop.map((r: any) => (
                <button
                  key={r.enrollment_id}
                  className="w-full text-left rounded-lg border border-[var(--border-divider)] px-3 py-2 hover:bg-[var(--bg-surface-soft)]"
                  onClick={() => onClickRiskStudent(r.enrollment_id)}
                  type="button"
                >
                  <div className="text-sm font-semibold">{r.student_name}</div>
                  <div className="text-xs text-[var(--text-secondary)] mt-1">
                    점수 <b>{r.score}</b> · danger {r.danger} · warn {r.warn}
                  </div>
                  <div className="text-[11px] text-[var(--text-muted)] mt-1 truncate">
                    last:{" "}
                    {r.last_occurred_at
                      ? new Date(r.last_occurred_at).toLocaleString()
                      : "-"}
                  </div>
                </button>
              ))
            )}
          </div>
        </div>

        <div className="mt-auto border-t border-[var(--border-divider)] p-3 text-xs text-[var(--text-muted)]">
          총 이벤트: {totalCount.toLocaleString()}건
        </div>
      </div>

      {/* RIGHT */}
      <div className="flex-1 rounded-xl border border-[var(--border-divider)] bg-[var(--bg-surface)] overflow-hidden flex flex-col">
        <div className="px-3 py-2 border-b border-[var(--border-divider)] bg-[var(--bg-surface-soft)] flex items-center justify-between">
          <div className="text-sm font-semibold">
            시청 로그
            {isFetching && (
              <span className="ml-2 text-xs text-[var(--text-muted)]">
                동기화 중...
              </span>
            )}
          </div>
          <div className="text-xs text-[var(--text-secondary)]">
            range: {range} · page: {page}
          </div>
        </div>

        <div className="grid grid-cols-12 text-xs font-semibold border-b border-[var(--border-divider)] px-3 py-2 bg-[var(--bg-surface)] text-[var(--text-secondary)]">
          <div className="col-span-2">시간</div>
          <div className="col-span-2">학생</div>
          <div className="col-span-3">타입</div>
          <div className="col-span-1 text-center">위반</div>
          <div className="col-span-2">사유</div>
          <div className="col-span-1 text-center">점수</div>
          <div className="col-span-1 text-center">세션</div>
        </div>

        <div className="flex-1 overflow-auto">
          {events.length === 0 ? (
            <div className="p-4 text-sm text-[var(--text-muted)]">
              이벤트가 없습니다.
            </div>
          ) : (
            events.map((e: any) => (
              <button
                key={e.id}
                className="w-full text-left grid grid-cols-12 px-3 py-2 border-b border-[var(--border-divider)] hover:bg-[var(--bg-surface-soft)] text-xs"
                onClick={() => setSelectedEvent(e)}
                type="button"
              >
                <div className="col-span-2 text-[var(--text-secondary)]">
                  {e.occurred_at ? new Date(e.occurred_at).toLocaleString() : "-"}
                </div>
                <div className="col-span-2 font-medium truncate">
                  {e.student_name}
                </div>
                <div className="col-span-3 flex items-center gap-2">
                  <span
                    className={`px-2 py-0.5 rounded-full text-white text-[10px] ${
                      SEV_COLORS[e.severity] || "bg-gray-500"
                    }`}
                  >
                    {e.severity}
                  </span>
                  <span className="truncate">{e.event_type}</span>
                </div>
                <div className="col-span-1 text-center">
                  {e.violated ? "Y" : "-"}
                </div>
                <div className="col-span-2 text-[var(--text-secondary)] truncate">
                  {e.violation_reason || "-"}
                </div>
                <div className="col-span-1 text-center font-bold">{e.score}</div>
                <div className="col-span-1 text-center text-[var(--text-muted)] truncate">
                  {e.session_id ? String(e.session_id).slice(0, 6) : "-"}
                </div>
              </button>
            ))
          )}
        </div>

        <div className="px-3 py-2 border-t border-[var(--border-divider)] bg-[var(--bg-surface-soft)] flex justify-end gap-2">
          <button
            className="text-xs px-3 py-1 rounded border border-[var(--border-divider)] bg-[var(--bg-surface)] disabled:opacity-50"
            disabled={!canPrev}
            onClick={() => setPage((p) => Math.max(1, p - 1))}
            type="button"
          >
            이전
          </button>
          <button
            className="text-xs px-3 py-1 rounded border border-[var(--border-divider)] bg-[var(--bg-surface)] disabled:opacity-50"
            disabled={!canNext}
            onClick={() => setPage((p) => p + 1)}
            type="button"
          >
            다음
          </button>
        </div>
      </div>

      <JsonViewerModal
        open={!!selectedEvent}
        title={`Event #${selectedEvent?.id} · ${selectedEvent?.student_name} · ${selectedEvent?.event_type}`}
        payload={selectedEvent?.event_payload}
        snapshot={selectedEvent?.policy_snapshot}
        onClose={() => setSelectedEvent(null)}
      />
    </div>
  );
}


==========================================================================================
# FILE: components/features/video-detail/components/AdminHlsPreview.tsx
==========================================================================================
// PATH: src/features/videos/components/features/video-detail/components/AdminHlsPreview.tsx

import { useEffect, useRef } from "react";
import Hls from "hls.js";

export default function AdminHlsPreview({ src }: { src: string }) {
  const ref = useRef<HTMLVideoElement | null>(null);

  useEffect(() => {
    const video = ref.current;
    if (!video) return;

    if (!src) {
      video.removeAttribute("src");
      try {
        video.load();
      } catch {}
      return;
    }

    if (video.canPlayType("application/vnd.apple.mpegurl")) {
      video.src = src;
      return;
    }

    if (Hls.isSupported()) {
      const hls = new Hls();
      hls.loadSource(src);
      hls.attachMedia(video);
      return () => hls.destroy();
    }

    video.src = src;
  }, [src]);

  return (
    <div className="rounded-lg overflow-hidden bg-black shadow">
      <video
        ref={ref}
        controls
        autoPlay
        muted
        playsInline
        className="w-full max-h-[520px] object-contain"
        controlsList="nodownload noremoteplayback"
      />
    </div>
  );
}


==========================================================================================
# FILE: components/features/video-detail/components/AdminMemoSection.tsx
==========================================================================================
// PATH: src/features/videos/components/features/video-detail/components/AdminMemoSection.tsx
// 좌측 패널용 "관리자 메모" 전용 (시안: 영상 미리보기 아래)

interface Props {
  memo: string;
  setMemo: (v: string) => void;
}

export default function AdminMemoSection({ memo, setMemo }: Props) {
  return (
    <textarea
      value={memo}
      onChange={(e) => setMemo(e.target.value)}
      className="w-full min-h-[100px] rounded-lg border border-[var(--color-border-divider)] bg-[var(--color-bg-app)] px-3 py-2.5 text-sm text-[var(--color-text-primary)] placeholder:text-[var(--color-text-muted)] focus:outline-none focus:ring-2 focus:ring-[var(--color-primary)]"
      placeholder="관리자 메모"
    />
  );
}


==========================================================================================
# FILE: components/features/video-detail/components/AdminStudentVideoPreview.tsx
==========================================================================================
// PATH: src/features/videos/components/features/video-detail/components/AdminStudentVideoPreview.tsx
// 관리자 전용: 학생 앱 플레이어를 "정책 미리보기" 용도로 감싸는 래퍼
// - 특정 학생 선택 없이도 재생 가능
// - audit / progress / heartbeat 저장 ❌
// - 정책(enforcement)만 동일 적용 ✅

import StudentVideoPlayer from "@/student/media/playback/player/StudentVideoPlayer";

interface Props {
  videoId: number;
  enrollmentId?: number | null; // 선택 학생 (옵션)
}

export default function AdminStudentVideoPreview({
  videoId,
  enrollmentId,
}: Props) {
  return (
    <StudentVideoPlayer
      videoId={videoId}
      enrollmentId={enrollmentId ?? -1} // dummy enrollment
      previewMode="admin"
    />
  );
}


==========================================================================================
# FILE: components/features/video-detail/components/StudentWatchPanel.tsx
==========================================================================================
// PATH: src/features/videos/components/features/video-detail/components/StudentWatchPanel.tsx

import { useMemo } from "react";
import { Button } from "@/shared/ui/ds";
import StudentNameWithLectureChip from "@/shared/ui/chips/StudentNameWithLectureChip";
import AttendanceStatusBadge from "@/shared/ui/badges/AttendanceStatusBadge";
import type { AttendanceStatus } from "@/shared/ui/badges/AttendanceStatusBadge";
import {
  RULE_COLORS,
  RULE_LABELS,
  getAccessLabel,
  getAccessTone,
} from "@/features/videos/components/features/video-permission/permission.constants";

interface Props {
  students: any[];
  onOpenPermission: () => void;
  selectedEnrollmentId?: number | null;
  onSelectPreviewStudent?: (enrollmentId: number) => void;
}

export default function StudentWatchPanel({
  students,
  onOpenPermission,
  selectedEnrollmentId,
  onSelectPreviewStudent,
}: Props) {
  const selectable = typeof onSelectPreviewStudent === "function";

  const sorted = useMemo(() => {
    return [...students].sort((a, b) =>
      String(a.student_name || "").localeCompare(String(b.student_name || ""))
    );
  }, [students]);

  return (
    <div className="w-full flex flex-col gap-3">
      {/* ACTION */}
      <div className="flex justify-end">
        <Button type="button" intent="primary" size="sm" onClick={onOpenPermission}>
          권한 관리
        </Button>
      </div>

      {/* LIST */}
      <div className="flex flex-col gap-2">
        {sorted.map((s: any) => {
          const progress = Math.round((Number(s.progress ?? 0) || 0) * 100);
          const barWidth = progress === 0 ? 2 : Math.min(100, Math.max(0, progress));
          const clickable = selectable && s.enrollment;
          const selected = selectedEnrollmentId === s.enrollment;

          return (
            <div
              key={s.enrollment}
              role={clickable ? "button" : undefined}
              tabIndex={clickable ? 0 : -1}
              onClick={() => {
                if (clickable) onSelectPreviewStudent!(s.enrollment);
              }}
              onKeyDown={(e) => {
                if (!clickable) return;
                if (e.key === "Enter" || e.key === " ") onSelectPreviewStudent!(s.enrollment);
              }}
              className={[
                "flex items-center gap-3",
                "rounded-lg border px-3 py-2.5 text-sm",
                "border-[var(--border-divider)] bg-[var(--bg-surface)]",
                "overflow-hidden",
                clickable && "cursor-pointer hover:bg-[var(--bg-surface-soft)]",
                selected && "ring-2 ring-[var(--color-primary)] border-[var(--color-primary)]",
              ]
                .filter(Boolean)
                .join(" ")}
            >
              {/* NAME + 아바타 + 강의 딱지 (전역 규칙) */}
              <div className="w-[90px] min-w-0 truncate font-medium text-[var(--text-primary)]">
                <StudentNameWithLectureChip
                  name={s.student_name ?? ""}
                  profilePhotoUrl={s.profile_photo_url ?? undefined}
                  avatarSize={24}
                  lectures={
                    s.lecture_title
                      ? [{ lectureName: s.lecture_title, color: s.lecture_color }]
                      : undefined
                  }
                  chipSize={14}
                />
              </div>

              {/* BADGES */}
              <div className="w-[140px] flex items-center gap-1 shrink-0">
                <AttendanceStatusBadge
                  status={(s.attendance_status ?? "INACTIVE") as AttendanceStatus}
                  variant="1ch"
                />
                <span
                  className="ds-status-badge"
                  data-tone={getAccessTone(s.access_mode, s.effective_rule)}
                >
                  {getAccessLabel(s.access_mode, s.effective_rule)}
                </span>
              </div>

              {/* PROGRESS */}
              <div className="flex-1 min-w-0 flex items-center gap-2">
                <div className="flex-1 h-[8px] rounded bg-[var(--bg-app)] overflow-hidden">
                  <div
                    className="h-full rounded bg-[var(--color-primary)]"
                    style={{ width: `${barWidth}%` }}
                  />
                </div>
                <div className="w-[40px] shrink-0 text-right text-xs text-[var(--text-muted)]">
                  {progress}%
                </div>
              </div>
            </div>
          );
        })}
      </div>
    </div>
  );
}


==========================================================================================
# FILE: components/features/video-detail/components/VideoInfoSection.tsx
==========================================================================================
// PATH: src/features/videos/components/features/video-detail/components/VideoInfoSection.tsx

interface Props {
  video: any;
  memo: string;
  setMemo: (v: string) => void;
}

export default function VideoInfoSection({ video, memo, setMemo }: Props) {
  const formatBytes = (b?: number) =>
    b ? `${(Number(b) / 1024 / 1024).toFixed(1)} MB` : "-";

  return (
    <div className="grid grid-cols-2 gap-4">
      {/* FILE INFO */}
      <div className="bg-[var(--bg-surface-soft)] rounded-lg p-4 text-sm space-y-1">
        <div className="font-medium text-[var(--text-primary)]">파일 기본 정보</div>

        <div className="text-xs text-[var(--text-secondary)]">
          <div>상태: {video.status}</div>
          <div>길이: {video.duration ?? "-"}</div>
          <div>업로드: {video.created_at}</div>
          <div>용량: {formatBytes(video.file_size)}</div>
        </div>
      </div>

      {/* POLICY SNAPSHOT + MEMO */}
      <div className="bg-[var(--bg-surface-soft)] rounded-lg p-4 text-sm space-y-2">
        <div className="font-medium text-[var(--text-primary)]">현재 적용 정책</div>

        <div className="text-xs text-[var(--text-secondary)]">
          워터마크: {video.show_watermark ? "ON" : "OFF"}
          <br />
          건너뛰기: {video.allow_skip ? "허용" : "차단"}
          <br />
          최대 배속: {Number(video.max_speed ?? 1).toFixed(2)}x
        </div>

        <textarea
          value={memo}
          onChange={(e) => setMemo(e.target.value)}
          className="h-20 w-full rounded border border-[var(--border-divider)] bg-[var(--bg-app)] p-2 text-xs"
          placeholder="관리자 메모"
        />
      </div>
    </div>
  );
}


==========================================================================================
# FILE: components/features/video-detail/components/VideoPolicySection.tsx
==========================================================================================
// PATH: src/features/videos/components/features/video-detail/components/VideoPolicySection.tsx

import ToggleSwitch from "@/features/videos/ui/ToggleSwitch";
import { useVideoPolicy } from "@/features/videos/hooks/useVideoPolicy";

interface Props {
  videoId: number;
  initial: {
    allow_skip: boolean;
    max_speed: number;
    show_watermark: boolean;
  };
}

export default function VideoPolicySection({ videoId, initial }: Props) {
  const { policy, canSave, setAllowSkip, setMaxSpeed, setShowWatermark, save } =
    useVideoPolicy({
      videoId,
      initial,
    } as any);

  return (
    <div className="space-y-4">
      {/* POLICY CONTROLS */}
      <div className="bg-[var(--bg-surface-soft)] rounded-lg p-4">
        <div className="flex items-center gap-6 text-xs text-[var(--text-secondary)]">
          <label className="flex items-center gap-2">
            워터마크
            <ToggleSwitch checked={policy.show_watermark} onChange={setShowWatermark} />
          </label>

          <label className="flex items-center gap-2">
            건너뛰기
            <ToggleSwitch checked={policy.allow_skip} onChange={setAllowSkip} />
          </label>

          <label className="flex items-center gap-2">
            최대 배속
            <input
              type="number"
              step={0.25}
              min={0.25}
              max={5}
              value={policy.max_speed}
              onChange={(e) => setMaxSpeed(Number(e.target.value))}
              className="w-20 rounded border border-[var(--border-divider)] bg-[var(--bg-app)] px-2 py-1 text-xs text-[var(--text-primary)]"
            />
            {policy.max_speed.toFixed(2)}x
          </label>

          <button
            onClick={() => save()}
            disabled={!canSave}
            className="ml-auto rounded bg-[var(--color-primary)] px-4 py-1.5 text-xs font-semibold text-white disabled:opacity-50"
            type="button"
          >
            저장
          </button>
        </div>
      </div>
    </div>
  );
}


==========================================================================================
# FILE: components/features/video-detail/components/VideoPreviewSection.tsx
==========================================================================================
import AdminHlsPreview from "./AdminHlsPreview";
import VideoProcessingPreview from "./VideoProcessingPreview";

type PreviewMode = "admin" | "student";

interface Props {
  previewMode: PreviewMode;
  setPreviewMode: (v: PreviewMode) => void;
  hlsSrc: string | null;
  status: string;
  progressPercent?: number | null;
}

export default function VideoPreviewSection({
  previewMode,
  setPreviewMode,
  hlsSrc,
  status,
  progressPercent,
}: Props) {
  const isReady = status === "READY";

  return (
    <div className="rounded-lg border border-[var(--border-divider)] bg-[var(--bg-surface-soft)] p-4 space-y-4">
      {/* MODE TOGGLE */}
      <div className="flex items-center gap-2">
        <button
          onClick={() => setPreviewMode("admin")}
          className={`rounded border px-3 py-1 text-xs ${
            previewMode === "admin"
              ? "bg-[var(--bg-surface)] font-semibold"
              : "bg-[var(--bg-surface-soft)]"
          }`}
        >
          관리자 미리보기
        </button>

        <button
          onClick={() => setPreviewMode("student")}
          className={`rounded border px-3 py-1 text-xs ${
            previewMode === "student"
              ? "bg-[var(--bg-surface)] font-semibold"
              : "bg-[var(--bg-surface-soft)]"
          }`}
        >
          학생 페이지로 보기
        </button>
      </div>

      {/* PREVIEW */}
      <div className="rounded-md bg-[var(--bg-surface)] p-3">
        {isReady && previewMode === "admin" && hlsSrc ? (
          <AdminHlsPreview src={hlsSrc} />
        ) : (
          <VideoProcessingPreview
            status={status}
            percent={progressPercent}
          />
        )}
      </div>
    </div>
  );
}


==========================================================================================
# FILE: components/features/video-detail/components/VideoProcessingPreview.tsx
==========================================================================================
// PATH: src/features/videos/components/features/video-detail/components/VideoProcessingPreview.tsx

interface Props {
  percent?: number | null;
  status: string;
}

export default function VideoProcessingPreview({ percent, status }: Props) {
  const safePercent =
    typeof percent === "number"
      ? Math.min(100, Math.max(0, Math.round(percent)))
      : null;

  return (
    <div className="flex flex-col items-center justify-center h-[320px] rounded-lg bg-[var(--bg-surface)] border border-[var(--border-divider)]">
      <div className="text-sm font-semibold text-[var(--text-primary)]">
        {status === "UPLOADED" ? "업로드 완료" : "영상 처리 중"}
      </div>

      <div className="mt-2 text-xs text-[var(--text-muted)]">
        썸네일 생성 및 인코딩 진행 중
      </div>

      {/* Progress Bar */}
      <div className="mt-6 w-[260px]">
        <div className="h-2 rounded bg-[var(--bg-app)] overflow-hidden">
          <div
            className="h-full bg-[var(--color-primary)] transition-all"
            style={{
              width: `${safePercent ?? 0}%`,
            }}
          />
        </div>

        <div className="mt-2 text-center text-xs text-[var(--text-secondary)]">
          {safePercent != null ? `${safePercent}%` : "진행률 계산 중..."}
        </div>
      </div>
    </div>
  );
}


==========================================================================================
# FILE: components/features/video-detail/components/VideoStudentsSection.tsx
==========================================================================================
// PATH: src/features/videos/components/features/video-detail/components/VideoStudentsSection.tsx

import { FiSettings, FiBarChart2, FiClock } from "react-icons/fi";
import { KPI, Button } from "@/shared/ui/ds";
import StudentWatchPanel from "./StudentWatchPanel";

interface Props {
  students: any[];
  onOpenPermission: () => void;
  onOpenAchievement?: () => void;
  onOpenLog?: () => void;
}

function percent(v: number) {
  return Number.isFinite(v) ? `${(v * 100).toFixed(1)}%` : "—";
}

export default function VideoStudentsSection({
  students,
  onOpenPermission,
  onOpenAchievement,
  onOpenLog,
}: Props) {
  const total = students.length;
  const completed100 = students.filter((s) => (Number(s.progress ?? 0) || 0) >= 1).length;
  const progressSum = students.reduce((a, s) => a + (Number(s.progress ?? 0) || 0), 0);
  const avgProgress = total > 0 ? progressSum / total : 0;

  return (
    <div className="space-y-5">
      {/* 상단 KPI 3개 */}
      <div className="grid grid-cols-3 gap-3">
        <KPI label="총 학생" value={total > 0 ? `${total}명` : "—"} />
        <KPI label="평균 만족도" value={percent(avgProgress)} />
        <KPI label="100% 완료" value={total > 0 ? `${completed100}명` : "—"} />
      </div>

      <StudentWatchPanel
        students={students}
        selectedEnrollmentId={null}
        onSelectPreviewStudent={() => {}}
        onOpenPermission={onOpenPermission}
      />

      {/* 하단 3버튼: 권한 설정 / 학습 성적표 / 시청 로그 */}
      <div className="flex flex-wrap items-center gap-2 pt-2 border-t border-[var(--color-border-divider)]">
        <Button
          type="button"
          intent="secondary"
          size="sm"
          onClick={onOpenPermission}
          className="inline-flex items-center gap-1.5"
        >
          <FiSettings size={14} />
          권한 설정
        </Button>
        {typeof onOpenAchievement === "function" && (
          <Button
            type="button"
            intent="ghost"
            size="sm"
            onClick={onOpenAchievement}
            className="inline-flex items-center gap-1.5"
          >
            <FiBarChart2 size={14} />
            학습 성적표
          </Button>
        )}
        {typeof onOpenLog === "function" && (
          <Button
            type="button"
            intent="ghost"
            size="sm"
            onClick={onOpenLog}
            className="inline-flex items-center gap-1.5"
          >
            <FiClock size={14} />
            시청 로그
          </Button>
        )}
      </div>
    </div>
  );
}


==========================================================================================
# FILE: components/features/video-detail/modals/PermissionModal.tsx
==========================================================================================
// PATH: src/features/videos/components/features/video-detail/modals/PermissionModal.tsx

import { useMemo, useState, useEffect } from "react";
import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";

import api from "@/shared/api/axios";
import { Button } from "@/shared/ui/ds";

import PermissionHeader from "../../video-permission/components/PermissionHeader";
import PermissionTable from "../../video-permission/components/PermissionTable";
import PermissionSidePanel from "../../video-permission/components/PermissionSidePanel";

import VideoAchievementTab from "../../video-analytics/VideoAchievementTab";
import VideoLogTab from "../../video-analytics/VideoLogTab";

import type { PermissionModalProps, TabKey } from "../../video-permission/permission.types";

import "../../video-permission/permission-modal.css";

/* ================= component ================= */

export default function PermissionModal({
  videoId,
  open,
  onClose,
  focusEnrollmentId,
  onChangeFocusEnrollmentId,
  initialTab = "permission",
}: PermissionModalProps) {
  const qc = useQueryClient();

  const [tab, setTab] = useState<TabKey>(initialTab);
  const [search, setSearch] = useState("");
  const [selected, setSelected] = useState<number[]>([]);
  const [focusEnrollment, setFocusEnrollment] = useState<number | null>(null);

  /* focus + initialTab sync */
  useEffect(() => {
    if (!open) return;
    if (focusEnrollmentId !== undefined) setFocusEnrollment(focusEnrollmentId ?? null);
    setTab(initialTab);
  }, [open, focusEnrollmentId, initialTab]);

  const setFocusBoth = (v: number | null) => {
    setFocusEnrollment(v);
    onChangeFocusEnrollmentId?.(v);
  };

  const switchTab = (next: TabKey) => {
    setTab(next);
    if (next !== "permission") {
      setSelected([]);
    }
  };

  /* ================= query ================= */

  const { data, isFetching } = useQuery({
    queryKey: ["video", videoId, "stats"],
    queryFn: async () => {
      const res = await api.get(`/media/videos/${videoId}/stats/`);
      return res.data;
    },
    enabled: open && !!videoId && tab === "permission",
    staleTime: 5000,
    retry: 1,
  });

  const studentsRaw = data?.students ?? [];

  /* ================= LEFT TABLE DATA ================= */

  const students = useMemo(() => {
    let list = studentsRaw;

    if (focusEnrollment) {
      list = list.filter((s: any) => s.enrollment === focusEnrollment);
    }

    const q = search.trim().toLowerCase();
    if (q) {
      list = list.filter((s: any) =>
        String(s.student_name || "").toLowerCase().includes(q)
      );
    }

    return list;
  }, [studentsRaw, focusEnrollment, search]);

  const toggle = (id: number) => {
    setSelected((prev) => (prev.includes(id) ? prev.filter((x) => x !== id) : [...prev, id]));
  };

  const toggleAll = () => {
    const ids = students.map((s: any) => s.enrollment);
    if (!ids.length) return;
    setSelected(selected.length === ids.length ? [] : ids);
  };

  /* ================= RIGHT PANEL DATA ================= */

  const selectedStudents = useMemo(() => {
    if (!selected.length) return [];
    const set = new Set(selected);
    return [...studentsRaw]
      .filter((s: any) => set.has(s.enrollment))
      .sort((a: any, b: any) =>
        String(a.student_name || "").localeCompare(String(b.student_name || ""))
      );
  }, [studentsRaw, selected]);

  const mutate = useMutation({
    mutationFn: async (ruleOrAccessMode: string) => {
      // Support both legacy 'rule' and new 'access_mode'
      const isAccessMode = ["FREE_REVIEW", "PROCTORED_CLASS", "BLOCKED"].includes(ruleOrAccessMode);
      
      const payload: any = {
        video_id: videoId,
        enrollments: selected,
      };
      
      if (isAccessMode) {
        payload.access_mode = ruleOrAccessMode;
      } else {
        // Legacy rule support
        payload.rule = ruleOrAccessMode;
      }
      
      await api.post(`/media/video-permissions/bulk-set/`, payload);
    },
    onSuccess: async () => {
      setSelected([]);
      await qc.invalidateQueries({ queryKey: ["video", videoId, "stats"] });
    },
  });

  if (!open) return null;

  const totalCount = students.length;

  return (
    <div className="permission-modal-overlay">
      <div className="permission-modal">
        {/* HEADER */}
        <div className="px-5 py-4">
          <div className="flex items-start justify-between gap-4">
            <div>
              <div className="text-sm font-semibold">시청 권한 관리</div>
              <div className="mt-1 text-xs text-[var(--text-muted)]">
                권한 설정 / 성취도 / 시청 로그
              </div>
            </div>

            <Button type="button" intent="ghost" size="sm" onClick={onClose}>
              닫기
            </Button>
          </div>

          <div className="mt-3">
            <PermissionHeader
              tab={tab}
              onChangeTab={switchTab}
              onClose={onClose}
              isFetching={!!isFetching}
              focusEnrollment={focusEnrollment}
              onClearFocus={() => setFocusBoth(null)}
            />
          </div>
        </div>

        {/* BODY */}
        <div className="permission-modal-body">
          <div className="permission-modal-surface">
            {tab === "permission" ? (
              <div className="h-full flex gap-4 min-h-0">
                {/* LEFT */}
                <div className="permission-left">
                  {/* SEARCH BAR ONLY */}
                  <div className="permission-header flex items-center gap-3">
                    <input
                      className="h-8 rounded border px-3 text-sm w-[220px]"
                      placeholder="이름 검색"
                      value={search}
                      onChange={(e) => setSearch(e.target.value)}
                    />

                    <div className="ml-auto text-sm text-[var(--text-secondary)]">
                      전체 {totalCount}명
                    </div>
                  </div>

                  <div className="flex-1 min-h-0 overflow-hidden">
                    <PermissionTable
                      students={students}
                      selected={selected}
                      toggle={toggle}
                      toggleAll={toggleAll}
                    />
                  </div>
                </div>

                {/* RIGHT */}
                <PermissionSidePanel
                  selectedStudents={selectedStudents}
                  selectedCount={selected.length}
                  pending={mutate.isPending}
                  onApply={(rule) => mutate.mutate(rule)}
                  onClear={() => setSelected([])}
                  onRemoveOne={(enrollment) =>
                    setSelected((prev) => prev.filter((x) => x !== enrollment))
                  }
                />
              </div>
            ) : tab === "achievement" ? (
              <VideoAchievementTab videoId={videoId} onSelectStudent={(id) => setFocusBoth(id)} />
            ) : (
              <VideoLogTab videoId={videoId} onClickRiskStudent={(id) => setFocusBoth(id)} />
            )}
          </div>
        </div>
      </div>
    </div>
  );
}


==========================================================================================
# FILE: components/features/video-detail/modals/VideoUploadModal.css
==========================================================================================
/* PATH: VideoUploadModal.css — 영상 추가 모달 전용 (드롭존·토글·컴팩트) */

.video-upload-modal__body {
  gap: var(--space-3);
}

.video-upload-modal__row {
  padding: var(--space-3) var(--space-4);
}

/* 라벨 없이 인풋만 — placeholder/영역 안 문구로 구분 */
.video-upload-modal__row--input-only {
  padding: var(--space-2) var(--space-4);
}
.video-upload-modal__row--input-only .ds-input,
.video-upload-modal__row--input-only .ds-textarea {
  width: 100%;
}
.video-upload-modal__row--input-only .video-upload-modal__dropzone {
  width: 100%;
}

/* 드롭존 — modal-form-group과 톤 통일 (inset 입체감) */
.video-upload-modal__dropzone {
  display: flex;
  align-items: center;
  justify-content: center;
  min-height: 120px;
  padding: var(--space-4);
  border: 1px solid var(--color-border-divider);
  border-radius: var(--radius-lg);
  background: color-mix(in srgb, var(--color-border-divider) 6%, var(--color-modal-bg));
  box-shadow:
    inset 0 1px 0 0 rgba(255, 255, 255, 0.06),
    inset 0 2px 4px rgba(0, 0, 0, 0.03);
  cursor: pointer;
  transition: border-color 160ms ease, background 160ms ease, box-shadow 160ms ease;
}

.video-upload-modal__dropzone--compact {
  min-height: 40px;
  padding: var(--space-2) var(--space-3);
  border-style: dashed;
}

/* 설명 영역 — 크기·위치 고정, 리사이즈 제한 */
.video-upload-modal__desc-wrap {
  padding: var(--space-2) var(--space-4);
}
.video-upload-modal__desc {
  width: 100%;
  min-height: 72px;
  max-height: 120px;
  resize: vertical;
  box-sizing: border-box;
}

.video-upload-modal__dropzone:hover,
.video-upload-modal__dropzone:focus-visible {
  border-color: color-mix(in srgb, var(--color-brand-primary) 35%, var(--color-border-divider));
  background: color-mix(in srgb, var(--color-brand-primary) 4%, var(--color-modal-bg));
  box-shadow:
    inset 0 1px 0 0 rgba(255, 255, 255, 0.1),
    inset 0 2px 4px rgba(255, 255, 255, 0.04),
    0 1px 2px rgba(0, 0, 0, 0.04);
  outline: none;
}

.video-upload-modal__dropzone-inner {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  text-align: center;
}

.video-upload-modal__filename {
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  gap: var(--space-2);
  font-size: 13px;
  font-weight: 600;
  color: var(--color-text-primary);
}

.video-upload-modal__clear-files {
  margin-left: var(--space-2);
  padding: 0 var(--space-1);
  font-size: 12px;
  font-weight: 500;
  color: var(--color-text-muted);
  background: none;
  border: none;
  cursor: pointer;
  border-radius: var(--radius-sm);
}
.video-upload-modal__clear-files:hover {
  color: var(--color-brand-primary);
}

.video-upload-modal__prompt {
  font-size: 13px;
  font-weight: 600;
  color: var(--color-text-primary);
}

/* 토글 스위치 — 재생 정책 (워터마크/건너뛰기), DS 입체감 통일 */
.video-upload-modal__toggle {
  position: relative;
  width: 44px;
  height: 24px;
  flex-shrink: 0;
  border: 1px solid var(--color-border-divider);
  border-radius: 999px;
  background: color-mix(in srgb, var(--color-border-divider) 8%, var(--color-bg-surface));
  box-shadow:
    inset 0 1px 0 0 rgba(255, 255, 255, 0.2),
    inset 0 2px 4px rgba(255, 255, 255, 0.05),
    0 1px 2px rgba(0, 0, 0, 0.04);
  cursor: pointer;
  transition: border-color 120ms ease, background 120ms ease, box-shadow 120ms ease;
}

.video-upload-modal__toggle:hover {
  border-color: var(--color-border-strong, var(--color-border-divider));
  box-shadow:
    inset 0 1px 0 0 rgba(255, 255, 255, 0.25),
    inset 0 2px 4px rgba(255, 255, 255, 0.06),
    0 2px 4px rgba(0, 0, 0, 0.06);
}

.video-upload-modal__toggle-thumb {
  position: absolute;
  top: 2px;
  left: 2px;
  width: 18px;
  height: 18px;
  border-radius: 999px;
  background: var(--color-bg-surface);
  box-shadow:
    inset 0 1px 0 0 rgba(255, 255, 255, 0.4),
    0 1px 2px rgba(0, 0, 0, 0.08);
  transition: transform 160ms ease;
}

.video-upload-modal__toggle-thumb[data-on="true"] {
  transform: translateX(20px);
}

.video-upload-modal__toggle[aria-checked="true"] {
  background: var(--color-brand-primary);
  border-color: var(--color-brand-primary);
}

.video-upload-modal__toggle[aria-checked="true"] .video-upload-modal__toggle-thumb {
  background: #fff;
}

/* 재생 정책 — 워터마크 · 건너뛰기 · 배속 가로 1자로 고정 */
.video-upload-modal__policy-row {
  display: flex;
  flex-wrap: nowrap;
  align-items: center;
  gap: var(--space-4);
}

.video-upload-modal__policy-item {
  display: inline-flex;
  align-items: center;
  gap: var(--space-2);
  cursor: default;
  flex-shrink: 0;
}

.video-upload-modal__policy-label {
  font-size: 12px;
  font-weight: 600;
  color: var(--color-text-muted);
}

/* 배속 — < 1.0x > 스테퍼, DS 버튼 SSOT 사용 */
.video-upload-modal__speed-wrap {
  margin-left: var(--space-2);
}

.video-upload-modal__speed-stepper {
  display: inline-flex;
  align-items: center;
  gap: 0;
  border-radius: var(--radius-md);
  overflow: hidden;
  box-shadow:
    inset 0 1px 0 0 rgba(255, 255, 255, 0.25),
    inset 0 2px 4px rgba(255, 255, 255, 0.06),
    0 1px 2px rgba(0, 0, 0, 0.04);
  background: color-mix(in srgb, var(--color-border-divider) 8%, var(--color-bg-surface));
  border: 1px solid var(--color-border-divider);
}

.video-upload-modal__speed-stepper .ds-button {
  border-radius: 0;
  border: none;
  box-shadow: none;
  min-height: var(--control-sm);
  width: var(--control-sm);
}
.video-upload-modal__speed-stepper .ds-button:hover:not(:disabled):not([data-disabled="true"]) {
  box-shadow: none;
}
.video-upload-modal__speed-stepper .ds-button:first-child {
  border-right: 1px solid var(--color-border-divider);
}
.video-upload-modal__speed-stepper .ds-button:last-child {
  border-left: 1px solid var(--color-border-divider);
}

.video-upload-modal__speed-value {
  min-width: 44px;
  padding: 0 var(--space-2);
  font-size: 13px;
  font-weight: 600;
  color: var(--color-text-primary);
  text-align: center;
  line-height: var(--control-sm);
}


==========================================================================================
# FILE: components/features/video-detail/modals/VideoUploadModal.tsx
==========================================================================================
// PATH: src/features/videos/components/features/video-detail/modals/VideoUploadModal.tsx
// 영상 추가 모달 — students 도메인 기준 모달 SSOT (AdminModal + ModalHeader/Body/Footer)

import { useEffect, useMemo, useRef, useState } from "react";
import { useQueryClient } from "@tanstack/react-query";
import { AdminModal, ModalBody, ModalFooter, ModalHeader, MODAL_WIDTH } from "@/shared/ui/modal";
import { Button } from "@/shared/ui/ds";
import { feedback } from "@/shared/ui/feedback/feedback";
import { initVideoUpload, uploadFileToR2AndComplete } from "@/features/videos/utils/videoUpload";
import "./VideoUploadModal.css";

function ChevronLeftIcon() {
  return (
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" aria-hidden>
      <path d="M15 18l-6-6 6-6" />
    </svg>
  );
}
function ChevronRightIcon() {
  return (
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" aria-hidden>
      <path d="M9 18l6-6-6-6" />
    </svg>
  );
}

type Props = {
  sessionId: number;
  isOpen: boolean;
  onClose: () => void;
};


export default function VideoUploadModal({ sessionId, isOpen, onClose }: Props) {
  const qc = useQueryClient();
  const fileInputRef = useRef<HTMLInputElement | null>(null);

  const [title, setTitle] = useState("");
  const [description, setDescription] = useState("");
  const [files, setFiles] = useState<File[]>([]);
  const [isUploading, setIsUploading] = useState(false);

  const [showWatermark, setShowWatermark] = useState(true);
  const [allowSkip, setAllowSkip] = useState(false);
  const [maxSpeed, setMaxSpeed] = useState<number>(1);

  useEffect(() => {
    if (!isOpen) return;
    setTitle("");
    setDescription("");
    setFiles([]);
    setShowWatermark(true);
    setAllowSkip(false);
    setMaxSpeed(1);
    setIsUploading(false);
  }, [isOpen]);

  const canSubmit = useMemo(() => {
    return Number.isFinite(sessionId) && sessionId > 0 && files.length > 0 && title.trim().length > 0;
  }, [sessionId, files.length, title]);

  if (!isOpen) return null;

  const pickFile = () => fileInputRef.current?.click();

  const handleUpload = async () => {
    if (files.length === 0) return;
    setIsUploading(true);

    const initResults: { init: Awaited<ReturnType<typeof initVideoUpload>>; file: File }[] = [];
    const initErrors: string[] = [];

    // 1) 각 파일 init 먼저 (DB에 영상 row 생성)
    for (let i = 0; i < files.length; i++) {
      const file = files[i];
      const fileTitle = files.length === 1 ? title.trim() : `${title.trim()} ${i + 1}`;

      try {
        const init = await initVideoUpload({
          sessionId,
          file,
          title: fileTitle,
          description,
          showWatermark,
          allowSkip,
          maxSpeed,
        });
        initResults.push({ init, file });
      } catch (error) {
        const err = error as { response?: { status?: number; data?: { detail?: string } }; message?: string };
        let msg =
          err?.response?.data?.detail ||
          err?.message ||
          "업로드에 실패했습니다.";
        if (err?.response?.status === 403 && !err?.response?.data?.detail) {
          msg = "권한이 없습니다. 관리자 또는 스태프 계정으로 로그인했는지 확인하세요.";
        }
        initErrors.push(`${file.name}: ${msg}`);
      }
    }

    // 2) 목록 갱신 후 모달 닫기 → 화면에 바로 표시
    if (initResults.length > 0) {
      qc.invalidateQueries({ queryKey: ["session-videos", sessionId] });
    }
    onClose();
    setIsUploading(false);

    if (initErrors.length > 0) {
      feedback.error(initErrors.join(" / "));
    }

    // 3) R2 업로드 + complete는 백그라운드에서 진행
    const results = await Promise.allSettled(
      initResults.map(({ init, file }) => uploadFileToR2AndComplete(init, file))
    );

    const successCount = results.filter((r) => r.status === "fulfilled").length;
    const r2Errors: string[] = [];
    results.forEach((r, idx) => {
      if (r.status === "rejected") {
        r2Errors.push(`${initResults[idx].file.name}: ${(r.reason as Error)?.message || "업로드 실패"}`);
      }
    });

    if (successCount > 0) {
      feedback.success(
        r2Errors.length > 0
          ? `${successCount}개 업로드 완료. ${r2Errors.length}개 실패. 인코딩은 우하단 작업 박스에서 확인하세요.`
          : `${successCount}개 업로드 완료. 인코딩은 우하단 작업 박스에서 이어서 진행됩니다.`
      );
    }
    if (r2Errors.length > 0) {
      feedback.error(r2Errors.join(" / "));
    }
  };

  return (
    <AdminModal open={isOpen} onClose={onClose} type="action" width={MODAL_WIDTH.md}>
      <ModalHeader
        type="action"
        title="영상 추가"
        description="파일 업로드 및 재생 정책을 설정합니다."
      />

      <ModalBody>
        <div className="modal-scroll-body modal-scroll-body--compact video-upload-modal__body">
          {/* 제목 — 묶음 단위. 다중 업로드 시 "제목 1", "제목 2" 형태로 자동 부여 */}
          <div className="modal-form-group video-upload-modal__row video-upload-modal__row--input-only">
            <input
              className="ds-input"
              placeholder="제목 (예: 수학의 정석 — 여러 파일 시 제목 1, 2, 3... 자동)"
              value={title}
              onChange={(e) => setTitle(e.target.value)}
              autoFocus
            />
          </div>

          {/* 파일 — 드롭존만, 다중 선택 가능 */}
          <div className="modal-form-group video-upload-modal__row video-upload-modal__row--input-only">
            <div
              className="video-upload-modal__dropzone video-upload-modal__dropzone--compact"
              onClick={pickFile}
              role="button"
              tabIndex={0}
              onKeyDown={(e) => {
                if (e.key === "Enter" || e.key === " ") {
                  e.preventDefault();
                  pickFile();
                }
              }}
              onDrop={(e) => {
                e.preventDefault();
                e.stopPropagation();
                const items = e.dataTransfer?.files;
                if (items?.length) {
                  setFiles((prev) => [...prev, ...Array.from(items)].filter((f) => f.type.startsWith("video/")));
                }
              }}
              onDragOver={(e) => e.preventDefault()}
              aria-label="동영상 파일 선택 (다중 선택 가능)"
            >
              {files.length > 0 ? (
                <span className="video-upload-modal__filename">
                  {files.length === 1
                    ? files[0].name
                    : `${files.length}개 파일 선택됨${files.length <= 3 ? ` (${files.map((f) => f.name).join(", ")})` : ""}`}
                  <button
                    type="button"
                    className="video-upload-modal__clear-files"
                    onClick={(e) => {
                      e.stopPropagation();
                      setFiles([]);
                    }}
                    aria-label="선택 해제"
                  >
                    선택 해제
                  </button>
                </span>
              ) : (
                <span className="video-upload-modal__prompt">파일: 클릭 또는 드래그하여 업로드 (mp4 등, 다중 선택 가능)</span>
              )}
            </div>
            <input
              ref={fileInputRef}
              type="file"
              className="hidden"
              accept="video/*"
              multiple
              onChange={(e) => {
                const list = e.target.files ? Array.from(e.target.files) : [];
                setFiles((prev) => (list.length > 0 ? [...prev, ...list] : prev));
                e.target.value = "";
              }}
            />
          </div>

          {/* 설명 — textarea만, placeholder로 안내, 크기·위치 고정 */}
          <div className="modal-form-group modal-form-group--neutral video-upload-modal__row video-upload-modal__row--input-only video-upload-modal__desc-wrap">
            <textarea
              className="ds-textarea video-upload-modal__desc"
              placeholder="설명 (선택)"
              value={description}
              onChange={(e) => setDescription(e.target.value)}
              rows={3}
            />
          </div>

          {/* 재생 정책 — 워터마크 · 건너뛰기 · 배속 가로 1줄, 배속은 올림/내림 버튼 밖으로 */}
          <div className="modal-form-group modal-form-group--neutral video-upload-modal__row">
            <div className="video-upload-modal__policy-row">
              <label className="video-upload-modal__policy-item">
                <span className="video-upload-modal__policy-label">워터마크</span>
                <button
                  type="button"
                  role="switch"
                  aria-checked={showWatermark}
                  onClick={() => setShowWatermark((v) => !v)}
                  className="video-upload-modal__toggle"
                >
                  <span className="video-upload-modal__toggle-thumb" data-on={showWatermark} />
                </button>
              </label>
              <label className="video-upload-modal__policy-item">
                <span className="video-upload-modal__policy-label">건너뛰기</span>
                <button
                  type="button"
                  role="switch"
                  aria-checked={allowSkip}
                  onClick={() => setAllowSkip((v) => !v)}
                  className="video-upload-modal__toggle"
                >
                  <span className="video-upload-modal__toggle-thumb" data-on={allowSkip} />
                </button>
              </label>
              <div className="video-upload-modal__policy-item video-upload-modal__speed-wrap">
                <span className="video-upload-modal__policy-label">배속</span>
                <div className="video-upload-modal__speed-stepper" role="group" aria-label="최대 배속">
                  <Button
                    type="button"
                    intent="secondary"
                    size="sm"
                    iconOnly
                    leftIcon={<ChevronLeftIcon />}
                    onClick={() => setMaxSpeed((v) => Math.max(1, v - 0.25))}
                    disabled={maxSpeed <= 1}
                    aria-label="배속 낮추기"
                  />
                  <span className="video-upload-modal__speed-value">
                    {maxSpeed % 1 === 0 ? `${maxSpeed}x` : `${maxSpeed.toFixed(2)}x`}
                  </span>
                  <Button
                    type="button"
                    intent="secondary"
                    size="sm"
                    iconOnly
                    leftIcon={<ChevronRightIcon />}
                    onClick={() => setMaxSpeed((v) => Math.min(5, v + 0.25))}
                    disabled={maxSpeed >= 5}
                    aria-label="배속 높이기"
                  />
                </div>
              </div>
            </div>
          </div>
        </div>
      </ModalBody>

      <ModalFooter
        left={
          <span className="modal-hint" style={{ marginBottom: 0 }}>
            업로드 버튼을 누르면 우하단 작업 박스에서 업로드·인코딩 진행 상황을 확인할 수 있습니다.
          </span>
        }
        right={
          <>
            <Button intent="secondary" onClick={onClose} disabled={isUploading}>
              취소
            </Button>
            <Button
              intent="primary"
              onClick={handleUpload}
              disabled={!canSubmit || isUploading}
              loading={isUploading}
            >
              {isUploading ? "업로드 중…" : "업로드"}
            </Button>
          </>
        }
      />
    </AdminModal>
  );
}


==========================================================================================
# FILE: components/features/video-permission/permission-modal.css
==========================================================================================
/* PATH: src/features/videos/components/features/video-permission/permission-modal.css */
@reference "tailwindcss";

/* Overlay / Modal */
.permission-modal-overlay {
  @apply fixed inset-0 z-[200] bg-black/50 flex items-center justify-center;
}

.permission-modal {
  @apply w-[1400px] h-[880px]
         bg-[var(--bg-surface)]
         rounded-2xl shadow-2xl
         flex flex-col;
}

/* Body (soft surface) */
.permission-modal-body {
  @apply flex-1 px-5 pb-5 min-h-0;
}

.permission-modal-surface {
  @apply bg-[var(--bg-surface-soft)]
         rounded-xl
         p-4
         h-full
         min-h-0
         overflow-hidden;
}

/* Left panel */
.permission-left {
  @apply flex-1
         bg-[var(--bg-surface)]
         rounded-xl
         border border-[var(--border-divider)]
         flex flex-col
         min-h-0
         overflow-hidden;
}

.permission-header {
  @apply px-4 py-3
         flex items-center justify-between
         border-b border-[var(--border-divider)];
}

/* Table */
.permission-table-header {
  @apply px-4 py-2
         flex items-center
         text-xs font-semibold
         text-[var(--text-secondary)]
         border-b border-[var(--border-divider)]
         bg-[var(--bg-surface-soft)];
}

.permission-row {
  @apply px-4 py-2
         flex items-center
         text-sm
         border-b border-[var(--border-divider)]
         transition
         hover:bg-[var(--bg-surface-soft)];
}

.permission-row-selected {
  @apply bg-[var(--bg-surface-soft)];
}

/* Right panel (NEW UX) */
.permission-right {
  @apply w-[480px]
         bg-[var(--bg-surface)]
         rounded-xl
         border border-[var(--border-divider)]
         flex flex-col
         min-h-0
         overflow-hidden;
}

.permission-right-head {
  @apply px-4 py-4
         border-b border-[var(--border-divider)]
         bg-[var(--bg-surface)];
}

.permission-right-actions {
  @apply px-4 py-4
         border-b border-[var(--border-divider)]
         bg-[var(--bg-surface-soft)];
}

.permission-right-listWrap {
  @apply flex-1 min-h-0
         bg-[var(--bg-surface)]
         flex flex-col;
}

.permission-right-listHeader {
  @apply px-4 py-2
         border-b border-[var(--border-divider)]
         bg-[var(--bg-surface-soft)]
         text-xs font-semibold
         text-[var(--text-secondary)]
         flex items-center gap-3;
}

.permission-right-listBody {
  @apply flex-1 min-h-0 overflow-auto;
}

.permission-right-row {
  @apply px-4 py-3
         border-b border-[var(--border-divider)]
         flex items-center gap-3
         hover:bg-[var(--bg-surface-soft)]
         transition;
}

.permission-right-footer {
  @apply px-4 py-3
         border-t border-[var(--border-divider)]
         bg-[var(--bg-surface)];
}

/* === PATCH: checkbox / column alignment polish === */

.permission-checkbox {
  @apply w-[28px] flex items-center justify-center;
}

.permission-checkbox input[type="checkbox"] {
  @apply h-4 w-4 cursor-pointer;
  accent-color: var(--color-primary);
}

.permission-name {
  @apply w-[130px] truncate font-medium;
}

.permission-text-xs {
  @apply text-xs text-[var(--text-secondary)] truncate;
}


==========================================================================================
# FILE: components/features/video-permission/permission.constants.ts
==========================================================================================
// PATH: src/features/videos/components/features/video-permission/permission.constants.ts

/**
 * ✅ permission.constants (UI v2)
 * - "출결"은 공용 AttendanceBadge를 쓰는 쪽으로 정리 (PermissionRow에서 사용)
 * - 여기서는 기존 계약을 깨지 않기 위해 LABEL은 유지
 * - 색상은 Tailwind 고정색 → theme var 기반으로 변경 (대기업 SaaS 룩)
 */

export const ATT_LABELS: Record<string, string> = {
  PRESENT: "현장",
  LATE: "지각",
  ONLINE: "영상",
  SUPPLEMENT: "보강",
  EARLY_LEAVE: "조퇴",
  ABSENT: "결석",
  RUNAWAY: "출튀",
  MATERIAL: "자료",
  INACTIVE: "부재",
  SECESSION: "탈퇴",
};

/**
 * ⚠️ 기존 ATT_COLORS는 레거시 호환용 유지
 * - PermissionRow에서는 AttendanceBadge로 교체되어 직접 사용 빈도 ↓
 * - 남아있는 화면이 있으면 최소한 테마에 맞게 보이도록만 유지
 */
export const ATT_COLORS: Record<string, string> = {
  PRESENT: "bg-[color-mix(in_srgb,var(--color-primary)_18%,transparent)] text-[var(--color-primary)]",
  LATE: "bg-[color-mix(in_srgb,var(--color-warning)_18%,transparent)] text-[var(--color-warning)]",
  ONLINE: "bg-[color-mix(in_srgb,var(--color-primary)_14%,transparent)] text-[var(--color-primary)]",
  SUPPLEMENT: "bg-[color-mix(in_srgb,var(--color-primary)_10%,transparent)] text-[var(--text-primary)]",
  EARLY_LEAVE: "bg-[color-mix(in_srgb,var(--color-warning)_14%,transparent)] text-[var(--color-warning)]",
  ABSENT: "bg-[color-mix(in_srgb,var(--color-danger)_18%,transparent)] text-[var(--color-danger)]",
  RUNAWAY: "bg-[color-mix(in_srgb,var(--color-danger)_18%,transparent)] text-[var(--color-danger)]",
  MATERIAL: "bg-[color-mix(in_srgb,var(--text-muted)_16%,transparent)] text-[var(--text-secondary)]",
  INACTIVE: "bg-[color-mix(in_srgb,var(--text-muted)_16%,transparent)] text-[var(--text-secondary)]",
  SECESSION: "bg-[color-mix(in_srgb,var(--text-muted)_16%,transparent)] text-[var(--text-secondary)]",
};

// Legacy rule labels (backward compatibility)
export const RULE_LABELS: Record<string, string> = {
  free: "무제한",
  once: "1회",
  blocked: "제한",
};

// New access mode labels
export const ACCESS_MODE_LABELS: Record<string, string> = {
  FREE_REVIEW: "복습",
  PROCTORED_CLASS: "온라인 수업 대체",
  BLOCKED: "제한",
};

// Combined labels (access_mode takes precedence)
export const getAccessLabel = (accessMode?: string, rule?: string): string => {
  if (accessMode && ACCESS_MODE_LABELS[accessMode]) {
    return ACCESS_MODE_LABELS[accessMode];
  }
  if (rule && RULE_LABELS[rule]) {
    return RULE_LABELS[rule];
  }
  return "미정";
};

/**
 * ✅ RULE_COLORS도 Tailwind 고정 → theme var 기반 (더 고급스러운 톤)
 * - 텍스트는 on-* 계열 변수가 없다면 white로 유지
 */
export const RULE_COLORS: Record<string, string> = {
  free: "bg-[color-mix(in_srgb,var(--color-primary)_85%,black)]",
  once: "bg-yellow-400 text-black",
  blocked: "bg-[color-mix(in_srgb,var(--color-danger)_85%,black)]",
};

// New access mode colors (레거시; 가능하면 getAccessTone 사용)
export const ACCESS_MODE_COLORS: Record<string, string> = {
  FREE_REVIEW: "bg-[color-mix(in_srgb,var(--color-primary)_85%,black)]",
  PROCTORED_CLASS: "bg-yellow-400 text-black",
  BLOCKED: "bg-[color-mix(in_srgb,var(--color-danger)_85%,black)]",
};

/** 공용 톤 SSOT: 상태 뱃지 색상 하드코딩 대신 data-tone 사용 */
export const ACCESS_MODE_TONE: Record<string, "success" | "danger" | "warning" | "primary" | "neutral"> = {
  FREE_REVIEW: "primary",
  PROCTORED_CLASS: "warning",
  BLOCKED: "danger",
};
export const RULE_TONE: Record<string, "success" | "danger" | "warning" | "primary" | "neutral"> = {
  free: "primary",
  once: "warning",
  blocked: "danger",
};

export function getAccessTone(accessMode?: string, rule?: string): "success" | "danger" | "warning" | "primary" | "neutral" {
  if (accessMode && ACCESS_MODE_TONE[accessMode]) return ACCESS_MODE_TONE[accessMode];
  if (rule && RULE_TONE[rule]) return RULE_TONE[rule];
  return "neutral";
}

// Combined colors (access_mode takes precedence) — 레거시
export const getAccessColor = (accessMode?: string, rule?: string): string => {
  if (accessMode && ACCESS_MODE_COLORS[accessMode]) {
    return ACCESS_MODE_COLORS[accessMode];
  }
  if (rule && RULE_COLORS[rule]) {
    return RULE_COLORS[rule];
  }
  return "bg-gray-500";
};


==========================================================================================
# FILE: components/features/video-permission/permission.types.ts
==========================================================================================
// src/features/videos/components/permission/permission.types.ts

export type TabKey = "permission" | "achievement" | "log";

export interface PermissionModalProps {
  videoId: number;
  open: boolean;
  onClose: () => void;
  focusEnrollmentId?: number | null;
  onChangeFocusEnrollmentId?: (v: number | null) => void;
  /** 열릴 때 초기 탭 (권한 설정 / 학습 성적표 / 시청 로그) */
  initialTab?: TabKey;
}


==========================================================================================
# FILE: components/features/video-permission/components/PermissionFilter.tsx
==========================================================================================
// PATH: src/features/videos/components/features/video-permission/components/PermissionFilter.tsx

import { useEffect, useState } from "react";

interface Props {
  filters: any;
  setFilters: (f: any) => void;
  onClose: () => void;
}

function cx(...xs: Array<string | false | null | undefined>) {
  return xs.filter(Boolean).join(" ");
}

function Chip({
  active,
  label,
  onClick,
}: {
  active: boolean;
  label: string;
  onClick: () => void;
}) {
  return (
    <button
      type="button"
      onClick={onClick}
      className={cx(
        "h-8 px-3 rounded-full border text-xs font-semibold transition",
        active
          ? "bg-[var(--color-primary)] text-[var(--color-on-primary)] border-[var(--color-primary)]"
          : "bg-[var(--bg-surface)] text-[var(--text-secondary)] border-[var(--border-divider)] hover:bg-[var(--bg-app)]"
      )}
    >
      {label}
    </button>
  );
}

/** ✅ 출결 상태 10개 — 역할 순서: 출석인정 → 경고 → 부정 → 중립 (AttendanceStatusBadge SSOT) */
const ATTENDANCE_OPTIONS = [
  { value: "PRESENT", label: "현장" },
  { value: "ONLINE", label: "영상" },
  { value: "SUPPLEMENT", label: "보강" },
  { value: "LATE", label: "지각" },
  { value: "EARLY_LEAVE", label: "조퇴" },
  { value: "ABSENT", label: "결석" },
  { value: "RUNAWAY", label: "출튀" },
  { value: "MATERIAL", label: "자료" },
  { value: "INACTIVE", label: "부재" },
  { value: "SECESSION", label: "퇴원" },
] as const;

/** 권한 */
const RULE_OPTIONS = [
  { value: "free", label: "무제한" },
  { value: "once", label: "1회" },
  { value: "blocked", label: "제한" },
] as const;

export default function PermissionFilter({
  filters,
  setFilters,
  onClose,
}: Props) {
  const [local, setLocal] = useState<any>({
    attendance_status: filters.attendance_status ?? "",
    rule: filters.rule ?? "",
    grade: filters.grade ?? "",
  });

  // ✅ 선택 즉시 반영 (적용 버튼 없음)
  useEffect(() => {
    const next: any = {};
    Object.entries(local).forEach(([k, v]) => {
      if (v) next[k] = v;
    });
    setFilters(next);
  }, [local]);

  const reset = () => {
    setLocal({
      attendance_status: "",
      rule: "",
      grade: "",
    });
    setFilters({});
  };

  return (
    <div className="permission-modal-overlay">
      <div className="w-full max-w-[640px] rounded-xl bg-[var(--bg-surface)] shadow-xl">
        {/* HEADER */}
        <div className="px-5 py-4">
          <div className="flex items-start justify-between">
            <div>
              <div className="text-sm font-semibold">필터</div>
              <div className="mt-1 text-xs text-[var(--text-muted)]">
                선택 즉시 반영됩니다
              </div>
            </div>
            <button
              onClick={onClose}
              className="rounded border px-3 py-1.5 text-xs"
            >
              닫기
            </button>
          </div>
        </div>

        {/* BODY */}
        <div className="px-5 pb-5">
          <div className="rounded-lg bg-[var(--bg-surface-soft)] p-4 space-y-5">
            {/* 출석 */}
            <div>
              <div className="text-xs font-semibold mb-2">출석</div>
              <div className="flex flex-wrap gap-2">
                {ATTENDANCE_OPTIONS.map((o) => (
                  <Chip
                    key={o.value}
                    label={o.label}
                    active={local.attendance_status === o.value}
                    onClick={() =>
                      setLocal({
                        ...local,
                        attendance_status:
                          local.attendance_status === o.value ? "" : o.value,
                      })
                    }
                  />
                ))}
              </div>
            </div>

            {/* 권한 */}
            <div>
              <div className="text-xs font-semibold mb-2">권한</div>
              <div className="flex gap-2">
                {RULE_OPTIONS.map((o) => (
                  <Chip
                    key={o.value}
                    label={o.label}
                    active={local.rule === o.value}
                    onClick={() =>
                      setLocal({
                        ...local,
                        rule: local.rule === o.value ? "" : o.value,
                      })
                    }
                  />
                ))}
              </div>
            </div>

            {/* 학년 */}
            <div>
              <div className="text-xs font-semibold mb-2">학년</div>
              {[
                { label: "초", nums: ["1", "2", "3", "4", "5", "6"] },
                { label: "중", nums: ["1", "2", "3"] },
                { label: "고", nums: ["1", "2", "3"] },
              ].map((g) => (
                <div key={g.label} className="flex items-center gap-2 mb-2">
                  <span className="w-6 text-xs text-[var(--text-muted)]">
                    {g.label}
                  </span>
                  {g.nums.map((n) => {
                    const value = `${g.label}${n}`;
                    return (
                      <Chip
                        key={value}
                        label={n}
                        active={local.grade === value}
                        onClick={() =>
                          setLocal({
                            ...local,
                            grade: local.grade === value ? "" : value,
                          })
                        }
                      />
                    );
                  })}
                </div>
              ))}
            </div>

            {/* RESET */}
            <div className="flex justify-end">
              <button
                onClick={reset}
                className="h-8 px-3 text-xs rounded border hover:bg-[var(--bg-app)]"
              >
                전체 초기화
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}


==========================================================================================
# FILE: components/features/video-permission/components/PermissionHeader.tsx
==========================================================================================
// PATH: src/features/videos/components/features/video-permission/components/PermissionHeader.tsx

import type { TabKey } from "../permission.types";

export default function PermissionHeader({
  tab,
  onChangeTab,
  isFetching,
  focusEnrollment,
  onClearFocus,
}: {
  tab: TabKey;
  onChangeTab: (t: TabKey) => void;
  isFetching: boolean;
  focusEnrollment: number | null;
  onClearFocus: () => void;
}) {
  return (
    <div className="flex items-center gap-2 px-4 py-2 border-b border-[var(--border-divider)] bg-[var(--bg-surface-soft)]">
      {(["permission", "achievement", "log"] as TabKey[]).map((key) => (
        <button
          key={key}
          className={`text-sm px-3 py-1 rounded border ${
            tab === key
              ? "bg-[var(--bg-surface)] font-semibold"
              : "bg-[var(--bg-surface-soft)]"
          }`}
          onClick={() => onChangeTab(key)}
        >
          {key === "permission"
            ? "권한 설정"
            : key === "achievement"
            ? "학습 성취도"
            : "시청 로그"}
        </button>
      ))}

      {tab === "permission" && (
        <span className="text-xs text-[var(--text-muted)] ml-2">
          {isFetching ? "동기화 중..." : "최신"}
        </span>
      )}

      {focusEnrollment && tab === "permission" && (
        <button
          className="ml-2 text-xs px-2 py-1 rounded border border-[var(--border-divider)] bg-[var(--bg-surface)] hover:bg-[var(--bg-surface-soft)]"
          onClick={onClearFocus}
        >
          학생 필터 해제
        </button>
      )}
    </div>
  );
}


==========================================================================================
# FILE: components/features/video-permission/components/PermissionRow.tsx
==========================================================================================
// PATH: src/features/videos/components/features/video-permission/components/PermissionRow.tsx

import AttendanceStatusBadge from "@/shared/ui/badges/AttendanceStatusBadge";
import type { AttendanceStatus } from "@/shared/ui/badges/AttendanceStatusBadge";
import StudentNameWithLectureChip from "@/shared/ui/chips/StudentNameWithLectureChip";
import { RULE_COLORS, RULE_LABELS, getAccessLabel, getAccessTone } from "../permission.constants";

function Pill({
  className,
  children,
}: {
  className: string;
  children: React.ReactNode;
}) {
  return (
    <span
      className={[
        "inline-flex items-center justify-center",
        "h-[22px] px-2 rounded-full",
        "text-[11px] font-semibold leading-none",
        className,
      ].join(" ")}
    >
      {children}
    </span>
  );
}

export default function PermissionRow({
  student,
  selected,
  onToggle,
}: {
  student: any;
  selected: boolean;
  onToggle: () => void;
}) {
  return (
    <div
      className={[
        "permission-row",
        selected ? "permission-row-selected" : "",
        // ✅ row hover/active 강화 (SaaS 느낌)
        "transition",
        selected
          ? "ring-1 ring-[color-mix(in_srgb,var(--color-primary)_45%,transparent)]"
          : "",
      ].join(" ")}
      onClick={onToggle}
      role="button"
      tabIndex={0}
      onKeyDown={(e) => {
        if (e.key === "Enter" || e.key === " ") onToggle();
      }}
    >
      {/* CHECK */}
      <div className="permission-checkbox" onClick={(e) => e.stopPropagation()}>
        <input type="checkbox" checked={selected} onChange={onToggle} />
      </div>

      {/* NAME + 아바타 + 강의 딱지 (전역 규칙) */}
      <div className="permission-name text-[var(--text-primary)]">
        <StudentNameWithLectureChip
          name={student.student_name ?? ""}
          profilePhotoUrl={student.profile_photo_url ?? undefined}
          avatarSize={24}
          lectures={
            student.lecture_title
              ? [{ lectureName: student.lecture_title, color: student.lecture_color }]
              : undefined
          }
          chipSize={14}
        />
      </div>

      {/* ✅ ATTENDANCE (SSOT: AttendanceStatusBadge 1ch) */}
      <div className="w-[90px] flex justify-center">
        <AttendanceStatusBadge
          status={(student.attendance_status ?? "INACTIVE") as AttendanceStatus}
          variant="1ch"
        />
      </div>

      {/* ACCESS MODE — SSOT: ds-status-badge + data-tone */}
      <div className="w-[90px] flex justify-center">
        <span
          className="ds-status-badge"
          data-tone={getAccessTone(student.access_mode, student.effective_rule)}
        >
          {getAccessLabel(student.access_mode, student.effective_rule)}
        </span>
      </div>

      {/* COMPLETED */}
      <div className="w-[80px] flex justify-center">
        <span className="text-xs text-[var(--text-secondary)]">
          {student.completed ? "완료" : "미완료"}
        </span>
      </div>

      {/* PHONES / META */}
      <div className="w-[150px] permission-text-xs">
        {student.parent_phone || "-"}
      </div>
      <div className="w-[150px] permission-text-xs">
        {student.student_phone || "-"}
      </div>
      <div className="w-[140px] permission-text-xs">
        {student.school || "-"}
      </div>
      <div className="w-[60px] text-center text-xs text-[var(--text-secondary)]">
        {student.grade || "-"}
      </div>
    </div>
  );
}


==========================================================================================
# FILE: components/features/video-permission/components/PermissionSidePanel.tsx
==========================================================================================
// PATH: src/features/videos/components/features/video-permission/components/PermissionSidePanel.tsx

import AttendanceStatusBadge from "@/shared/ui/badges/AttendanceStatusBadge";
import type { AttendanceStatus } from "@/shared/ui/badges/AttendanceStatusBadge";
import { Button } from "@/shared/ui/ds";
import StudentNameWithLectureChip from "@/shared/ui/chips/StudentNameWithLectureChip";
import { formatPhone } from "@/shared/utils/formatPhone";
import { RULE_COLORS, RULE_LABELS, ACCESS_MODE_LABELS, getAccessLabel, getAccessTone } from "../permission.constants";

function cx(...xs: Array<string | false | null | undefined>) {
  return xs.filter(Boolean).join(" ");
}

function ApplyPillButton({
  label,
  tone,
  disabled,
  onClick,
}: {
  label: string;
  tone: "free" | "once" | "blocked" | "FREE_REVIEW" | "PROCTORED_CLASS" | "BLOCKED";
  disabled: boolean;
  onClick: () => void;
}) {
  const isProctored = tone === "once" || tone === "PROCTORED_CLASS";
  const isBlocked = tone === "blocked" || tone === "BLOCKED";
  const intent = isBlocked ? "danger" : isProctored ? "secondary" : "primary";
  const onceClass = isProctored ? "!bg-yellow-400 hover:!bg-yellow-500 !border-yellow-500 !text-black" : "";

  return (
    <Button
      type="button"
      intent={intent}
      size="sm"
      disabled={disabled}
      onClick={onClick}
      className={cx("text-xs", onceClass)}
      title={`${label} 적용`}
    >
      {label}
    </Button>
  );
}

export default function PermissionSidePanel({
  selectedCount,
  selectedStudents,
  onApply,
  onClear,
  onRemoveOne,
  pending,
}: {
  selectedCount: number;
  selectedStudents: any[];
  onApply: (rule: string) => void;
  onClear: () => void;
  onRemoveOne: (enrollment: number) => void;
  pending: boolean;
}) {
  const disabledApply = selectedCount === 0 || pending;

  return (
    <div className="permission-right">
      {/* HEADER */}
      <div className="px-4 py-3 border-b border-[var(--border-divider)]">
        <div className="flex items-start justify-between gap-3">
          <div>
            <div className="text-sm font-semibold text-[var(--text-primary)]">
              선택된 학생
            </div>
            <div className="mt-0.5 text-xs text-[var(--text-muted)]">
              {selectedCount > 0
                ? `${selectedCount}명 선택됨`
                : "좌측에서 학생을 선택하세요."}
            </div>
          </div>

          <Button
            type="button"
            intent="secondary"
            size="sm"
            onClick={onClear}
            disabled={selectedCount === 0}
            className="shrink-0"
          >
            선택 해제
          </Button>
        </div>

        {/* 권한 적용 버튼 */}
        <div className="mt-3 flex items-center gap-2">
          <ApplyPillButton
            label={ACCESS_MODE_LABELS.FREE_REVIEW || RULE_LABELS.free}
            tone="FREE_REVIEW"
            disabled={disabledApply}
            onClick={() => onApply("FREE_REVIEW")}
          />
          <ApplyPillButton
            label={ACCESS_MODE_LABELS.PROCTORED_CLASS || RULE_LABELS.once}
            tone="PROCTORED_CLASS"
            disabled={disabledApply}
            onClick={() => onApply("PROCTORED_CLASS")}
          />
          <ApplyPillButton
            label={ACCESS_MODE_LABELS.BLOCKED || RULE_LABELS.blocked}
            tone="BLOCKED"
            disabled={disabledApply}
            onClick={() => onApply("BLOCKED")}
          />

          {pending && (
            <span className="ml-1 text-xs text-[var(--text-muted)]">
              적용 중...
            </span>
          )}
        </div>

        <div className="mt-2 text-[11px] text-[var(--text-muted)]">
          * 권한은 <b>선택된 학생</b> 기준으로 즉시 반영됩니다.
        </div>
      </div>

      {/* BODY */}
      <div className="flex-1 min-h-0 p-4">
        <div className="h-full rounded-xl border border-[var(--border-divider)] bg-[var(--bg-surface)] overflow-hidden flex flex-col min-h-0">
          {/* table head */}
          <div className="
            grid grid-cols-12
            px-3 py-2
            text-xs font-semibold
            text-[var(--text-secondary)]
            border-b border-[var(--border-divider)]
            bg-[var(--bg-surface-soft)]
          ">
            <div className="col-span-2 text-center">출석</div>
            <div className="col-span-2 text-center">접근 모드</div>
            <div className="col-span-1 text-center">완료</div>
            <div className="col-span-3">이름</div>
            <div className="col-span-3">학부모 번호</div>
            <div className="col-span-1 text-right">삭제</div>
          </div>



          {/* table body */}
          <div className="flex-1 min-h-0 overflow-auto">
            {selectedStudents.length === 0 ? (
              <div className="p-6 text-sm text-[var(--text-muted)]">
                선택된 학생이 없습니다. <br />
                <span className="text-xs">
                  좌측 체크 → 우측 상단에서 권한을 바로 적용하세요.
                </span>
              </div>
            ) : (
              selectedStudents.map((s: any) => (
                <div
                  key={s.enrollment}
                  className="grid grid-cols-12 px-3 py-2 items-center border-b border-[var(--border-divider)] hover:bg-[var(--bg-surface-soft)]"
                >
                  {/* 출석 — SSOT: AttendanceStatusBadge 1ch */}
                  <div className="col-span-2 flex justify-center">
                    <AttendanceStatusBadge
                      status={(s.attendance_status ?? "INACTIVE") as AttendanceStatus}
                      variant="1ch"
                    />
                  </div>

                  {/* 접근 모드 — SSOT: ds-status-badge + data-tone */}
                  <div className="col-span-2 flex justify-center">
                    <span
                      className="ds-status-badge"
                      data-tone={getAccessTone(s.access_mode, s.effective_rule)}
                    >
                      {getAccessLabel(s.access_mode, s.effective_rule)}
                    </span>
                  </div>

                  {/* 완료 */}
                  <div className="col-span-1 flex justify-center">
                    <span className="text-xs text-[var(--text-secondary)]">
                      {s.completed ? "완료" : "미완료"}
                    </span>
                  </div>

                  {/* 이름 + 아바타 + 강의 딱지 (전역 규칙) */}
                  <div className="col-span-3 min-w-0">
                    <div className="text-sm font-semibold text-[var(--text-primary)] truncate">
                      <StudentNameWithLectureChip
                        name={s.student_name ?? ""}
                        profilePhotoUrl={s.profile_photo_url ?? undefined}
                        avatarSize={24}
                        lectures={
                          s.lecture_title
                            ? [{ lectureName: s.lecture_title, color: s.lecture_color }]
                            : undefined
                        }
                        chipSize={14}
                      />
                    </div>
                    <div className="text-[11px] text-[var(--text-muted)] truncate">
                      학생번호 {formatPhone(s.student_phone)}
                    </div>
                  </div>

                  {/* 학부모 번호 */}
                  <div className="col-span-3 text-sm text-[var(--text-secondary)] truncate">
                    {formatPhone(s.parent_phone)}
                  </div>

                  {/* 삭제 */}
                  <div className="col-span-1 flex justify-end">
                    <Button
                      type="button"
                      intent="ghost"
                      size="sm"
                      onClick={() => onRemoveOne(s.enrollment)}
                      className="!min-w-0 !w-10 !h-7"
                      title="선택에서 제거"
                    >
                      ✕
                    </Button>
                  </div>
                </div>
              ))
            )}
          </div>
        </div>
      </div>

      {/* FOOTER */}
      <div className="p-4 border-t border-[var(--border-divider)]">
        <Button
          type="button"
          intent="secondary"
          size="md"
          disabled={selectedCount === 0}
          onClick={onClear}
          className="w-full"
        >
          전체 선택 해제
        </Button>
      </div>
    </div>
  );
}


==========================================================================================
# FILE: components/features/video-permission/components/PermissionTable.tsx
==========================================================================================
// PATH: src/features/videos/components/features/video-permission/components/PermissionTable.tsx

import PermissionRow from "./PermissionRow";

export default function PermissionTable({
  students,
  selected,
  toggle,
  toggleAll,
}: {
  students: any[];
  selected: number[];
  toggle: (id: number) => void;
  toggleAll: () => void;
}) {
  return (
    <>
      <div className="permission-table-header">
        <div className="permission-checkbox">
          <input
            type="checkbox"
            checked={students.length > 0 && selected.length === students.length}
            onChange={toggleAll}
          />
        </div>

        <div className="w-[130px]">이름</div>
        <div className="w-[90px] text-center">출석</div>
        <div className="w-[90px] text-center">접근 모드</div>
        <div className="w-[80px] text-center">완료</div>
        <div className="w-[150px]">학부모 번호</div>
        <div className="w-[150px]">학생 번호</div>
        <div className="w-[140px]">학교</div>
        <div className="w-[60px] text-center">학년</div>
      </div>

      <div className="flex-1 overflow-auto">
        {students.map((s: any) => (
          <PermissionRow
            key={s.enrollment}
            student={s}
            selected={selected.includes(s.enrollment)}
            onToggle={() => toggle(s.enrollment)}
          />
        ))}

        {students.length === 0 && (
          <div className="p-6 text-sm text-[var(--text-muted)]">
            표시할 학생이 없습니다.
          </div>
        )}
      </div>
    </>
  );
}


==========================================================================================
# FILE: hooks/useSessionVideos.ts
==========================================================================================
// PATH: src/features/videos/hooks/useSessionVideos.ts

import { useQuery } from "@tanstack/react-query";
import { fetchSessionVideos, Video } from "../api/videos";

function shouldPoll(videos: Video[]): boolean {
  return videos.some((v) => v.status !== "READY" && v.status !== "FAILED");
}

export function useSessionVideos(sessionId: number) {
  return useQuery({
    queryKey: ["session-videos", sessionId],
    queryFn: () => fetchSessionVideos(sessionId),
    enabled: Number.isFinite(sessionId) && sessionId > 0,
    staleTime: 2000,
    retry: 1,
    refetchOnWindowFocus: false,
    refetchInterval: (query) => {
      const videos = query.state.data;
      if (!videos) return 5000;
      return shouldPoll(videos) ? 5000 : false;
    },
  });
}


==========================================================================================
# FILE: hooks/useVideoPolicy.ts
==========================================================================================
// PATH: src/features/videos/hooks/useVideoPolicy.ts
// --------------------------------------------------
// useVideoPolicy
// --------------------------------------------------
// 책임:
// - 영상 시청 정책 상태 관리 (allow_skip / max_speed / show_watermark)
// - dirty 여부 계산
// - 저장(patch) + react-query invalidate
//
// ⚠️ UI / JSX / UX 관여 ❌
// ⚠️ VideoDetailPage 에서만 사용 예정 (A-1)
// --------------------------------------------------

import { useEffect, useMemo, useState } from "react";
import { useMutation, useQueryClient } from "@tanstack/react-query";
import api from "@/shared/api/axios";

export interface VideoPolicy {
  allow_skip: boolean;
  max_speed: number;
  show_watermark: boolean;
}

interface Options {
  videoId: number;
  initial?: VideoPolicy | null;
}

export function useVideoPolicy({ videoId, initial }: Options) {
  const qc = useQueryClient();

  // -------------------------------
  // State
  // -------------------------------
  const [policy, setPolicy] = useState<VideoPolicy>({
    allow_skip: false,
    max_speed: 1.0,
    show_watermark: true,
  });

  const [dirty, setDirty] = useState(false);

  // -------------------------------
  // Init from server
  // -------------------------------
  useEffect(() => {
    if (!initial) return;

    setPolicy({
      allow_skip: Boolean(initial.allow_skip),
      max_speed: Number(initial.max_speed ?? 1),
      show_watermark: Boolean(initial.show_watermark),
    });

    setDirty(false);
  }, [initial?.allow_skip, initial?.max_speed, initial?.show_watermark]);

  // -------------------------------
  // Helpers
  // -------------------------------
  const update = <K extends keyof VideoPolicy>(key: K, value: VideoPolicy[K]) => {
    setPolicy((prev) => {
      if (prev[key] === value) return prev;
      return { ...prev, [key]: value };
    });
    setDirty(true);
  };

  // -------------------------------
  // Save
  // -------------------------------
  const saveMutation = useMutation({
    mutationFn: async () => {
      if (!videoId) return;

      await api.patch(`/media/videos/${videoId}/`, {
        allow_skip: policy.allow_skip,
        max_speed: policy.max_speed,
        show_watermark: policy.show_watermark,
      });
    },

    onSuccess: async () => {
      setDirty(false);

      await qc.invalidateQueries({ queryKey: ["video-stats", videoId] });
      await qc.invalidateQueries({ queryKey: ["video", videoId, "stats"] });
    },
  });

  // -------------------------------
  // Derived
  // -------------------------------
  const canSave = useMemo(() => dirty && !saveMutation.isPending, [dirty, saveMutation.isPending]);

  return {
    policy,
    dirty,
    canSave,

    // setters
    setAllowSkip: (v: boolean) => update("allow_skip", v),
    setMaxSpeed: (v: number) => update("max_speed", v),
    setShowWatermark: (v: boolean) => update("show_watermark", v),

    // actions
    save: saveMutation.mutate,
    saving: saveMutation.isPending,
  };
}


==========================================================================================
# FILE: pages/VideoAdminPage.tsx
==========================================================================================
/**
 * 영상 (사이드바) — 강의별 영상 진입점 · 차시 내 영상은 각 강의 > 차시에서 관리
 * Design: 저장소 양식 통일 (DomainLayout + wrap 구조)
 */

import { useState, useMemo } from "react";
import { useNavigate } from "react-router-dom";
import { useQuery } from "@tanstack/react-query";
import { fetchLectures } from "@/features/lectures/api/sessions";
import { DomainLayout } from "@/shared/ui/layout";
import { DomainListToolbar, DomainTable, TABLE_COL, STATUS_ACTIVE_COLOR, STATUS_INACTIVE_COLOR } from "@/shared/ui/domain";
import { Button, EmptyState } from "@/shared/ui/ds";
import styles from "@/shared/ui/domain/StorageStyleTabs.module.css";

export default function VideoAdminPage() {
  const navigate = useNavigate();
  const [searchInput, setSearchInput] = useState("");
  const [search, setSearch] = useState("");

  const { data: lectures = [], isLoading } = useQuery({
    queryKey: ["admin-videos-lectures"],
    queryFn: () => fetchLectures({ is_active: undefined }),
  });

  const filtered = useMemo(() => {
    if (!search.trim()) return lectures;
    const k = search.trim().toLowerCase();
    return lectures.filter(
      (l) =>
        (l.title && l.title.toLowerCase().includes(k)) ||
        (l.name && l.name.toLowerCase().includes(k)) ||
        (l.subject && l.subject.toLowerCase().includes(k))
    );
  }, [lectures, search]);

  const totalWidth = TABLE_COL.title + TABLE_COL.subject + TABLE_COL.medium + TABLE_COL.status + TABLE_COL.actions;

  return (
    <DomainLayout
      title="영상"
      description="강의·차시 단위 영상을 관리합니다. 영상 업로드·재생 정책은 각 강의 > 차시에서 설정하세요."
    >
      <div className={styles.wrap}>
        <DomainListToolbar
          totalLabel={isLoading ? "…" : `총 ${filtered.length}개 강의`}
          searchSlot={
            <input
              className="ds-input"
              placeholder="강의명 · 과목 검색"
              value={searchInput}
              onChange={(e) => setSearchInput(e.target.value)}
              onBlur={() => setSearch(searchInput)}
              onKeyDown={(e) => e.key === "Enter" && setSearch(searchInput)}
              style={{ maxWidth: 280 }}
            />
          }
          primaryAction={
            <Button intent="primary" onClick={() => navigate("/admin/lectures")}>
              강의 목록
            </Button>
          }
        />

        {isLoading ? (
          <EmptyState scope="panel" tone="loading" title="불러오는 중…" />
        ) : !filtered.length ? (
          <EmptyState
            scope="panel"
            tone="empty"
            title="강의가 없습니다"
            description="강의를 추가한 뒤, 각 강의 > 차시에서 영상을 업로드하고 재생 정책을 설정할 수 있습니다."
            actions={
              <Button intent="primary" onClick={() => navigate("/admin/lectures")}>
                강의 목록
              </Button>
            }
          />
        ) : (
          <DomainTable tableClassName="ds-table--flat" tableStyle={{ tableLayout: "fixed", width: totalWidth }}>
            <colgroup>
              <col style={{ width: TABLE_COL.title }} />
              <col style={{ width: TABLE_COL.subject }} />
              <col style={{ width: TABLE_COL.medium }} />
              <col style={{ width: TABLE_COL.status }} />
              <col style={{ width: TABLE_COL.actions }} />
            </colgroup>
            <thead>
              <tr>
                <th scope="col">강의명</th>
                <th scope="col">과목</th>
                <th scope="col">기간</th>
                <th scope="col">상태</th>
                <th scope="col" />
              </tr>
            </thead>
            <tbody>
              {filtered.map((l) => (
                <tr
                  key={l.id}
                  className="cursor-pointer hover:bg-[var(--color-bg-surface-hover)]"
                  onClick={() => navigate(`/admin/lectures/${l.id}`)}
                >
                  <td className="font-semibold text-[var(--color-text-primary)] truncate" title={l.title || l.name}>
                    {l.title || l.name || "—"}
                  </td>
                  <td className="text-[var(--color-text-secondary)] truncate">{l.subject || "—"}</td>
                  <td className="text-[var(--color-text-muted)]">
                    {l.start_date && l.end_date
                      ? `${l.start_date} ~ ${l.end_date}`
                      : l.start_date || "—"}
                  </td>
                  <td>
                    <span
                      style={{
                        fontSize: 12,
                        fontWeight: 700,
                        color: l.is_active ? STATUS_ACTIVE_COLOR : STATUS_INACTIVE_COLOR,
                      }}
                    >
                      {l.is_active ? "활성" : "비활성"}
                    </span>
                  </td>
                  <td onClick={(ev) => ev.stopPropagation()}>
                    <Button
                      intent="primary"
                      size="sm"
                      onClick={() => navigate(`/admin/lectures/${l.id}`)}
                    >
                      영상 관리
                    </Button>
                  </td>
                </tr>
              ))}
            </tbody>
          </DomainTable>
        )}
      </div>
    </DomainLayout>
  );
}


==========================================================================================
# FILE: pages/VideoDetail.styles.ts
==========================================================================================
// PATH: src/features/videos/pages/VideoDetail.styles.ts
// 시안: 상단 헤더(제목+서브+설명, 우측 드롭다운) / 2컬럼(좌: 미리보기+정책+메모, 우: 현황+통계+버튼) / 하단 파일정보+통계

export const styles = {
  page: {
    subtitle: "mt-1 text-sm text-[var(--color-text-muted)]",
  },

  layout: {
    root: "grid grid-cols-1 gap-8 lg:grid-cols-[1fr_420px] items-start",
    left: "flex flex-col gap-6 min-w-0",
    right: "min-w-0 lg:sticky lg:top-4",
  },

  section: {
    wrapper: "bg-[var(--color-bg-surface)] rounded-xl border border-[var(--color-border-divider)] overflow-hidden",
    header: "px-5 py-4 text-sm font-semibold text-[var(--color-text-primary)] border-b border-[var(--color-border-divider)]",
    body: "px-5 py-5 space-y-4",
    description: "text-xs text-[var(--color-text-muted)]",
  },

  header: {
    wrap: "flex flex-wrap items-start justify-between gap-4",
    title: "text-2xl font-bold text-[var(--color-text-primary)] tracking-tight",
    subtitle: "mt-1.5 text-sm text-[var(--color-text-secondary)]",
    description: "mt-0.5 text-xs text-[var(--color-text-muted)]",
    actions: "flex items-center gap-2 shrink-0",
    backLink:
      "rounded-lg border border-[var(--color-border-divider)] px-4 py-2 text-sm font-semibold bg-[var(--color-bg-surface)] hover:bg-[var(--color-bg-surface-soft)] transition",
    primaryDropdown:
      "rounded-lg px-4 py-2 text-sm font-semibold bg-[var(--color-primary)] text-white hover:brightness-95 transition inline-flex items-center gap-2",
  },

  /** 하단 파일정보 / 통계 스트립 */
  bottom: {
    wrap: "mt-8 pt-6 border-t border-[var(--color-border-divider)] space-y-4",
    row: "flex flex-wrap items-center gap-6 text-xs text-[var(--color-text-secondary)]",
    label: "font-semibold text-[var(--color-text-primary)]",
  },

  /** 우측 현황 상단 KPI 카드 그리드 */
  kpiGrid: "grid grid-cols-3 gap-3",
};


==========================================================================================
# FILE: pages/VideoDetailLayout.tsx
==========================================================================================
// PATH: src/features/videos/pages/VideoDetailLayout.tsx

import { ReactNode } from "react";
import { styles } from "./VideoDetail.styles";

interface Props {
  header: ReactNode;
  subtitle?: ReactNode;
  left: ReactNode;
  right: ReactNode;
  bottom?: ReactNode;
}

export default function VideoDetailLayout({ header, subtitle, left, right, bottom }: Props) {
  return (
    <div className="space-y-6">
      {/* PAGE HEADER: 제목 + 서브타이틀 + 설명, 우측 액션 */}
      <header className={styles.header.wrap}>
        {header}
      </header>
      {subtitle != null && <div className={styles.page.subtitle}>{subtitle}</div>}

      {/* PAGE BODY: 좌(미리보기+정책+메모) | 우(학생 시청 현황) */}
      <div className={styles.layout.root}>
        <div className={styles.layout.left}>{left}</div>
        <div className={styles.layout.right}>{right}</div>
      </div>

      {/* BOTTOM: 파일 정보 / 통계 */}
      {bottom != null && <div className={styles.bottom.wrap}>{bottom}</div>}
    </div>
  );
}


==========================================================================================
# FILE: pages/VideoDetailPage.tsx
==========================================================================================
// PATH: src/features/videos/pages/VideoDetailPage.tsx

import { useState } from "react";
import { useParams, Link } from "react-router-dom";
import { useQuery } from "@tanstack/react-query";
import api from "@/shared/api/axios";

import VideoDetailLayout from "./VideoDetailLayout";
import { styles } from "./VideoDetail.styles";

import PermissionModal from "@/features/videos/components/features/video-detail/modals/PermissionModal";
import VideoPreviewSection from "@/features/videos/components/features/video-detail/components/VideoPreviewSection";
import VideoPolicySection from "@/features/videos/components/features/video-detail/components/VideoPolicySection";
import AdminMemoSection from "@/features/videos/components/features/video-detail/components/AdminMemoSection";
import VideoStudentsSection from "@/features/videos/components/features/video-detail/components/VideoStudentsSection";
import type { TabKey } from "@/features/videos/components/features/video-permission/permission.types";

type PreviewMode = "admin" | "student";

function formatBytes(b?: number) {
  return b ? `${(Number(b) / 1024 / 1024).toFixed(1)} MB` : "—";
}

export default function VideoDetailPage() {
  const params = useParams();
  const lectureId = Number(params.lectureId);
  const sessionId = Number(params.sessionId);
  const videoId = Number(params.videoId);

  const [previewMode, setPreviewMode] = useState<PreviewMode>("admin");
  const [permissionOpen, setPermissionOpen] = useState(false);
  const [permissionTab, setPermissionTab] = useState<TabKey>("permission");
  const [memo, setMemo] = useState("");

  const { data, isLoading } = useQuery({
    queryKey: ["video-stats", videoId],
    queryFn: async () => {
      const res = await api.get(`/media/videos/${videoId}/stats/`);
      return res.data;
    },
    enabled: !!videoId,
    retry: 1,
  });

  if (isLoading || !data?.video) {
    return <div className="text-sm text-[var(--color-text-muted)]">로딩중…</div>;
  }

  const video = data.video;
  const students = data.students ?? [];
  const total = students.length;
  const completed100 = students.filter((s) => (Number(s.progress ?? 0) || 0) >= 1).length;
  const progressSum = students.reduce((a, s) => a + (Number(s.progress ?? 0) || 0), 0);
  const avgProgress = total > 0 ? progressSum / total : 0;
  const completed90 = students.filter((s) => (Number(s.progress ?? 0) || 0) >= 0.9).length;

  const openModal = (tab: TabKey) => {
    setPermissionTab(tab);
    setPermissionOpen(true);
  };

  return (
    <>
      <VideoDetailLayout
        header={
          <>
            <div>
              <h1 className={styles.header.title}>{video.title}</h1>
              <p className={styles.header.subtitle}>
                세션 영상 관리 · 정책 / 시청 / 로그
              </p>
              <p className={styles.header.description}>
                이 영상에 대한 시청 정책, 학생 성과, 로그 데이터를 관리합니다.
              </p>
            </div>
            <div className={styles.header.actions}>
              <Link
                to={`/admin/lectures/${lectureId}/sessions/${sessionId}`}
                className={styles.header.primaryDropdown}
              >
                출석 화면으로
              </Link>
            </div>
          </>
        }
        left={
          <>
            <section className={styles.section.wrapper}>
              <div className={styles.section.header}>영상 미리보기</div>
              <div className={styles.section.body}>
                <VideoPreviewSection
                  previewMode={previewMode}
                  setPreviewMode={setPreviewMode}
                  hlsSrc={video.hls_url}
                  status={video.status}
                  progressPercent={null}
                />
              </div>
            </section>

            <section className={styles.section.wrapper}>
              <div className={styles.section.header}>학생 시청 정책</div>
              <div className={styles.section.body}>
                <VideoPolicySection
                  videoId={videoId}
                  initial={{
                    allow_skip: video.allow_skip,
                    max_speed: video.max_speed,
                    show_watermark: video.show_watermark,
                  }}
                />
              </div>
            </section>

            <section className={styles.section.wrapper}>
              <div className={styles.section.header}>관리자 메모</div>
              <div className={styles.section.body}>
                <AdminMemoSection memo={memo} setMemo={setMemo} />
              </div>
            </section>
          </>
        }
        right={
          <section className={styles.section.wrapper}>
            <div className={styles.section.header}>학생 시청 현황</div>
            <div className={styles.section.body}>
              <VideoStudentsSection
                students={students}
                onOpenPermission={() => openModal("permission")}
                onOpenAchievement={() => openModal("achievement")}
                onOpenLog={() => openModal("log")}
              />
            </div>
          </section>
        }
        bottom={
          <>
            <div className={styles.bottom.row}>
              <span className={styles.bottom.label}>파일 정보</span>
              <span>
                {video.status ?? "—"} / {video.duration ?? "—"} / {formatBytes(video.file_size)} / {video.created_at ?? "—"}
              </span>
            </div>
            <div className={styles.bottom.row}>
              <span className={styles.bottom.label}>통계</span>
              <span>
                평균 만족도 {total > 0 ? `${(avgProgress * 100).toFixed(1)}%` : "—"} / 100% 완료 {completed100}명 / 90% 완료 {completed90}명
              </span>
            </div>
          </>
        }
      />

      <PermissionModal
        open={permissionOpen}
        onClose={() => setPermissionOpen(false)}
        videoId={videoId}
        initialTab={permissionTab}
      />
    </>
  );
}


==========================================================================================
# FILE: pages/VideoExplorerPage.tsx
==========================================================================================
/**
 * 영상 (사이드바 첫 페이지) — 저장소/메시지/시험과 동일한 폴더트리형 SSOT
 * 전체공개영상(맨위) + 강의명 > 1~n차시 트리, 우측에 영상 그리드
 */

import { useState, useMemo, useCallback } from "react";
import { useNavigate } from "react-router-dom";
import { useQuery, useQueries, useQueryClient } from "@tanstack/react-query";
import { FilePlus, Video, Folder } from "lucide-react";
import { Button, EmptyState } from "@/shared/ui/ds";
import { DomainLayout } from "@/shared/ui/layout";
import { AdminModal, ModalHeader, ModalBody, ModalFooter, MODAL_WIDTH } from "@/shared/ui/modal";
import Breadcrumb from "@/features/storage/components/Breadcrumb";
import VideoExplorerTree, { type VideoFolderId } from "../components/VideoExplorerTree";
import VideoUploadModal from "../components/features/video-detail/modals/VideoUploadModal";
import VideoThumbnail from "../ui/VideoThumbnail";
import VideoStatusBadge from "../ui/VideoStatusBadge";
import {
  fetchSessionVideos,
  fetchPublicSession,
  fetchVideoFolders,
  createVideoFolder,
  deleteVideoFolder,
  type Video as ApiVideo,
  type VideoFolder,
} from "../api/videos";
import {
  fetchLectures,
  fetchSessions,
  sortSessionsByDateDesc,
  type Lecture,
  type Session,
} from "@/features/lectures/api/sessions";
import styles from "../components/VideoExplorer.module.css";

type LectureWithSessions = Lecture & { sessions: Session[] };

function formatDate(iso: string | null): string {
  if (!iso) return "—";
  try {
    return new Date(iso).toLocaleDateString("ko-KR", {
      year: "2-digit",
      month: "2-digit",
      day: "2-digit",
      hour: "2-digit",
      minute: "2-digit",
      hour12: false,
    });
  } catch {
    return "—";
  }
}

export default function VideoExplorerPage() {
  const navigate = useNavigate();
  const queryClient = useQueryClient();
  const [selectedFolderId, setSelectedFolderId] = useState<VideoFolderId>(null);
  const [uploadModalOpen, setUploadModalOpen] = useState(false);
  const [uploadTargetSessionId, setUploadTargetSessionId] = useState<number | null>(null);
  const [newFolderName, setNewFolderName] = useState("");
  const [newFolderOpen, setNewFolderOpen] = useState(false);
  const [addChoiceModalOpen, setAddChoiceModalOpen] = useState(false);

  const { data: lectures = [], isLoading: lecturesLoading } = useQuery({
    queryKey: ["admin-videos-lectures"],
    queryFn: () => fetchLectures({ is_active: undefined }),
  });

  const sessionQueries = useQueries({
    queries: lectures.map((lec) => ({
      queryKey: ["lecture-sessions-videos", lec.id],
      queryFn: () => fetchSessions(lec.id),
      enabled: lectures.length > 0,
    })),
  });

  const lecturesWithSessions: LectureWithSessions[] = useMemo(() => {
    // 전체공개영상 Lecture는 제외 (별도로 최상단에 표시되므로)
    const filteredLectures = lectures.filter(
      (lec) => lec.title !== "전체공개영상" && lec.name !== "전체공개영상"
    );
    return filteredLectures.map((lec, i) => {
      const originalIndex = lectures.indexOf(lec);
      const sessions = (sessionQueries[originalIndex]?.data as Session[] | undefined) ?? [];
      return { ...lec, sessions: sortSessionsByDateDesc(sessions) };
    });
  }, [lectures, sessionQueries]);

  // 사이드바로 진입 시에도 media API가 먼저 호출되도록 마운트 시점에 public-session prefetch
  const {
    data: publicSession,
    isLoading: publicSessionLoading,
    isError: publicSessionError,
  } = useQuery({
    queryKey: ["public-session"],
    queryFn: fetchPublicSession,
    enabled: true,
    staleTime: 60_000,
  });

  const { data: sessionVideos = [], isLoading: sessionVideosLoading } = useQuery({
    queryKey: ["session-videos", selectedFolderId],
    queryFn: () => fetchSessionVideos(selectedFolderId as number),
    enabled: typeof selectedFolderId === "number",
  });

  // 전체공개영상 폴더 목록
  const { data: publicFolders = [], isLoading: publicFoldersLoading } = useQuery({
    queryKey: ["video-folders", publicSession?.session_id],
    queryFn: () => fetchVideoFolders(publicSession!.session_id),
    enabled: !!publicSession?.session_id,
  });

  // 선택된 폴더 ID (음수는 폴더, 양수는 세션)
  const selectedPublicFolderId = useMemo(() => {
    if (selectedFolderId === "public") return null;
    if (typeof selectedFolderId === "number" && selectedFolderId < 0) {
      return -selectedFolderId; // 음수를 양수로 변환
    }
    return null;
  }, [selectedFolderId]);

  const { data: publicVideos = [], isLoading: publicVideosLoading } = useQuery({
    queryKey: ["session-videos", publicSession?.session_id, selectedPublicFolderId],
    queryFn: () => {
      if (selectedPublicFolderId) {
        // 폴더별 영상 조회
        return fetchSessionVideos(publicSession!.session_id).then((videos) =>
          videos.filter((v) => v.folder === selectedPublicFolderId)
        );
      }
      // 루트 폴더 영상 (folder가 null인 것만)
      return fetchSessionVideos(publicSession!.session_id).then((videos) =>
        videos.filter((v) => !v.folder)
      );
    },
    enabled: selectedFolderId === "public" && !!publicSession?.session_id,
  });

  const videos = selectedFolderId === "public" ? publicVideos : sessionVideos;
  const videosLoading =
    selectedFolderId === "public"
      ? publicSessionLoading || publicVideosLoading || publicFoldersLoading
      : sessionVideosLoading;

  const sessionsLoading = sessionQueries.some((q) => q.isLoading);
  const isLoading = lecturesLoading || sessionsLoading;

  const selectedSession = useMemo(() => {
    if (typeof selectedFolderId !== "number") return null;
    for (const lec of lecturesWithSessions) {
      const s = lec.sessions.find((x) => x.id === selectedFolderId);
      if (s) return { lecture: lec, session: s };
    }
    return null;
  }, [lecturesWithSessions, selectedFolderId]);

  const breadcrumbPath = useMemo(() => {
    const path: { id: string | null; name: string }[] = [{ id: null, name: "영상" }];
    if (selectedFolderId === "public") {
      path.push({ id: "public", name: "전체공개영상" });
    } else if (selectedSession) {
      path.push({
        id: String(selectedSession.lecture.id),
        name: selectedSession.lecture.title || selectedSession.lecture.name || "강의",
      });
      path.push({ id: String(selectedSession.session.id), name: `${selectedSession.session.order}차시` });
    }
    return path;
  }, [selectedFolderId, selectedSession]);

  const handleBreadcrumbSelect = (id: string | null) => {
    if (!id) setSelectedFolderId(null);
    else if (id === "public") setSelectedFolderId("public");
    else {
      const num = Number(id);
      const asSession = lecturesWithSessions.some((l) => l.sessions.some((s) => s.id === num));
      if (asSession) setSelectedFolderId(num);
      else {
        const lec = lecturesWithSessions.find((l) => l.id === num);
        const firstSession = lec?.sessions?.[0];
        setSelectedFolderId(firstSession ? firstSession.id : null);
      }
    }
  };

  const openVideoDetail = (video: ApiVideo) => {
    if (selectedFolderId === "public" && publicSession && video.session_id === publicSession.session_id) {
      navigate(
        `/admin/lectures/${publicSession.lecture_id}/sessions/${publicSession.session_id}/videos/${video.id}`
      );
      return;
    }
    if (video.session_id && selectedSession) {
      navigate(
        `/admin/lectures/${selectedSession.lecture.id}/sessions/${selectedSession.session.id}/videos/${video.id}`
      );
      return;
    }
    const lecWithSession = lecturesWithSessions.find((l) =>
      l.sessions.some((s) => s.id === video.session_id)
    );
    const sess = lecWithSession?.sessions.find((s) => s.id === video.session_id);
    if (lecWithSession && sess) {
      navigate(`/admin/lectures/${lecWithSession.id}/sessions/${sess.id}/videos/${video.id}`);
    }
  };

  const openUploadModal = (sessionId: number) => {
    setUploadTargetSessionId(sessionId);
    setUploadModalOpen(true);
  };

  const closeUploadModal = () => {
    setUploadModalOpen(false);
    setUploadTargetSessionId(null);
  };

  const handleCreateFolder = useCallback(async () => {
    if (!newFolderName.trim() || !publicSession) return;
    try {
      const parentId =
        selectedPublicFolderId && selectedFolderId !== "public" ? selectedPublicFolderId : null;
      await createVideoFolder(publicSession.session_id, newFolderName.trim(), parentId);
      queryClient.invalidateQueries({ queryKey: ["video-folders", publicSession.session_id] });
      setNewFolderName("");
      setNewFolderOpen(false);
    } catch (e) {
      alert((e as Error).message || "폴더 생성에 실패했습니다.");
    }
  }, [newFolderName, publicSession, selectedPublicFolderId, selectedFolderId, queryClient]);

  const handleDeleteFolder = useCallback(
    async (folderId: number) => {
      if (!confirm("폴더를 삭제하시겠습니까? 폴더 내 영상이 있으면 삭제할 수 없습니다.")) return;
      try {
        await deleteVideoFolder(folderId);
        queryClient.invalidateQueries({ queryKey: ["video-folders", publicSession?.session_id] });
        queryClient.invalidateQueries({
          queryKey: ["session-videos", publicSession?.session_id],
        });
        if (selectedFolderId === -folderId) {
          setSelectedFolderId("public");
        }
      } catch (e) {
        alert((e as Error).message || "폴더 삭제에 실패했습니다.");
      }
    },
    [publicSession, selectedFolderId, queryClient]
  );

  return (
    <DomainLayout
      title="영상"
      description="강의·차시 단위 영상을 관리합니다. 전체공개영상은 프로그램에 등록된 모든 학생이 시청할 수 있는 영상입니다."
    >
      <div className={styles.root}>
        <div className={styles.toolbar}>
          <Breadcrumb
            path={breadcrumbPath.length > 1 ? breadcrumbPath : [{ id: null, name: "영상" }]}
            onSelect={(id) => handleBreadcrumbSelect(id)}
          />
          <div className={styles.actions}>
            <Button intent="primary" size="sm" onClick={() => navigate("/admin/lectures")}>
              강의 목록
            </Button>
          </div>
        </div>

        <div className={styles.body}>
          <aside className={styles.tree}>
            <VideoExplorerTree
              lectures={lecturesWithSessions}
              publicFolders={publicFolders}
              currentFolderId={selectedFolderId}
              onSelectFolder={setSelectedFolderId}
            />
          </aside>

          <div
            className={`${styles.gridWrap} ${selectedFolderId === "public" ? styles.gridWrapPublic : ""}`}
          >
            {isLoading ? (
              <div className={styles.placeholder}>불러오는 중…</div>
            ) : selectedFolderId === null ? (
              <div className={styles.placeholder}>좌측에서 폴더를 선택하세요</div>
            ) : selectedFolderId === "public" && publicSessionError ? (
              <div className={styles.placeholder} style={{ color: "var(--color-text-error, #b91c1c)" }}>
                전체공개영상 영역을 불러오지 못했습니다. 같은 도메인(예: tchul.com)으로 로그인했는지, 관리자·스태프 권한이 있는지 확인하세요.
              </div>
            ) : videosLoading ? (
              <div className={styles.placeholder}>영상 목록 불러오는 중…</div>
            ) : videos.length === 0 ? (
              <div
                className={selectedFolderId === "public" ? styles.emptyStateWrapper : ""}
                style={{ display: "flex", alignItems: "center", justifyContent: "center", minHeight: 200 }}
              >
                <EmptyState
                  scope="panel"
                  tone="empty"
                  title={
                    selectedFolderId === "public"
                      ? "등록된 영상이 없습니다"
                      : "이 차시에 등록된 영상이 없습니다"
                  }
                  description={
                    selectedFolderId === "public"
                      ? "아래 버튼으로 전체공개 영상을 업로드하세요. 프로그램에 등록된 모든 학생이 시청할 수 있습니다."
                      : "아래 버튼으로 이 차시에 영상을 추가하세요."
                  }
                  actions={
                    (selectedFolderId === "public" && publicSession ? (
                      <Button intent="primary" size="sm" onClick={() => openUploadModal(publicSession.session_id)}>
                        영상 추가
                      </Button>
                    ) : selectedSession ? (
                      <Button intent="primary" size="sm" onClick={() => openUploadModal(selectedSession.session.id)}>
                        영상 추가
                      </Button>
                    ) : null)
                  }
                />
              </div>
            ) : (
              <div className={styles.grid}>
                {selectedFolderId === "public" && publicSession && (
                  <div
                    className={styles.item + " " + styles.itemAdd}
                    onClick={() => setAddChoiceModalOpen(true)}
                    title="추가"
                  >
                    <FilePlus size={32} />
                    <span>추가</span>
                  </div>
                )}
                {selectedSession && selectedFolderId !== "public" && (
                  <div
                    className={styles.item + " " + styles.itemAdd}
                    onClick={() => openUploadModal(selectedSession.session.id)}
                    title="영상 추가"
                  >
                    <FilePlus size={32} />
                    <span>추가</span>
                  </div>
                )}
                {videos.map((v) => (
                  <div key={v.id} className={styles.item} onClick={() => openVideoDetail(v)}>
                    <VideoThumbnail
                      title={v.title}
                      status={v.status ?? "PENDING"}
                      thumbnail_url={v.thumbnail_url}
                    />
                    <span className={styles.itemLabel} title={v.title}>
                      {v.title || "—"}
                    </span>
                    <span className={styles.itemMeta}>{formatDate(v.created_at)}</span>
                    <VideoStatusBadge status={v.status ?? "PENDING"} />
                  </div>
                ))}
              </div>
            )}
          </div>
        </div>
      </div>

      {uploadTargetSessionId != null && (
        <VideoUploadModal
          sessionId={uploadTargetSessionId}
          isOpen={uploadModalOpen}
          onClose={closeUploadModal}
        />
      )}

      {/* 추가 선택 모달 (전체공개영상 내에서만) */}
      {addChoiceModalOpen && publicSession && (
        <AdminModal
          open={addChoiceModalOpen}
          onClose={() => setAddChoiceModalOpen(false)}
          width={MODAL_WIDTH.smallModal}
        >
          <ModalHeader title="추가하기" onClose={() => setAddChoiceModalOpen(false)} />
          <ModalBody>
            <div className="space-y-3">
              <button
                type="button"
                onClick={() => {
                  setAddChoiceModalOpen(false);
                  openUploadModal(publicSession.session_id);
                }}
                className="w-full flex items-center gap-3 p-4 rounded-lg border border-[var(--color-border-divider)] hover:border-[var(--color-brand-primary)] hover:bg-[var(--color-bg-surface-hover)] transition-all text-left"
              >
                <div className="w-10 h-10 rounded-lg bg-[var(--color-brand-primary)]/10 flex items-center justify-center">
                  <Video size={20} className="text-[var(--color-brand-primary)]" />
                </div>
                <div className="flex-1">
                  <div className="text-sm font-semibold text-[var(--color-text-primary)]">영상 업로드</div>
                  <div className="text-xs text-[var(--color-text-muted)] mt-0.5">
                    새로운 영상을 업로드합니다
                  </div>
                </div>
              </button>
              <button
                type="button"
                onClick={() => {
                  setAddChoiceModalOpen(false);
                  setNewFolderOpen(true);
                }}
                className="w-full flex items-center gap-3 p-4 rounded-lg border border-[var(--color-border-divider)] hover:border-[var(--color-brand-primary)] hover:bg-[var(--color-bg-surface-hover)] transition-all text-left"
              >
                <div className="w-10 h-10 rounded-lg bg-[var(--color-brand-primary)]/10 flex items-center justify-center">
                  <Folder size={20} className="text-[var(--color-brand-primary)]" />
                </div>
                <div className="flex-1">
                  <div className="text-sm font-semibold text-[var(--color-text-primary)]">폴더 생성</div>
                  <div className="text-xs text-[var(--color-text-muted)] mt-0.5">
                    새로운 폴더를 생성합니다
                  </div>
                </div>
              </button>
            </div>
          </ModalBody>
          <ModalFooter>
            <Button intent="secondary" onClick={() => setAddChoiceModalOpen(false)}>
              취소
            </Button>
          </ModalFooter>
        </AdminModal>
      )}

      {/* 폴더 생성 모달 */}
      {newFolderOpen && (
        <AdminModal
          open={newFolderOpen}
          onClose={() => {
            setNewFolderOpen(false);
            setNewFolderName("");
          }}
          width={MODAL_WIDTH.smallModal}
        >
          <ModalHeader title="새 폴더" onClose={() => {
            setNewFolderOpen(false);
            setNewFolderName("");
          }} />
          <ModalBody>
            <div className="space-y-3">
              <div>
                <label className="text-sm font-semibold text-[var(--color-text-primary)] mb-2 block">
                  폴더 이름
                </label>
                <input
                  type="text"
                  value={newFolderName}
                  onChange={(e) => setNewFolderName(e.target.value)}
                  onKeyDown={(e) => {
                    if (e.key === "Enter") handleCreateFolder();
                    if (e.key === "Escape") {
                      setNewFolderOpen(false);
                      setNewFolderName("");
                    }
                  }}
                  placeholder="폴더 이름을 입력하세요"
                  autoFocus
                  className="w-full px-3 py-2 border border-[var(--color-border-divider)] rounded-lg text-sm focus:outline-none focus:border-[var(--color-brand-primary)]"
                />
              </div>
            </div>
          </ModalBody>
          <ModalFooter>
            <Button
              intent="secondary"
              onClick={() => {
                setNewFolderOpen(false);
                setNewFolderName("");
              }}
            >
              취소
            </Button>
            <Button intent="primary" onClick={handleCreateFolder} disabled={!newFolderName.trim()}>
              생성
            </Button>
          </ModalFooter>
        </AdminModal>
      )}
    </DomainLayout>
  );
}


==========================================================================================
# FILE: types/access-mode.ts
==========================================================================================
// PATH: src/features/videos/types/access-mode.ts

/**
 * Video Access Mode Type
 * 
 * Replaces ambiguous "once" logic with clear access model:
 * - FREE_REVIEW: Free review mode (no restrictions)
 * - PROCTORED_CLASS: Online replacement class (restrictions apply)
 * - BLOCKED: Access blocked
 */
export type AccessMode = "FREE_REVIEW" | "PROCTORED_CLASS" | "BLOCKED";

/**
 * Legacy rule type (backward compatibility)
 * @deprecated Use AccessMode instead
 */
export type VideoRule = "free" | "once" | "blocked";

/**
 * Map legacy rule to access mode
 */
export function mapRuleToAccessMode(rule: VideoRule): AccessMode {
  const mapping: Record<VideoRule, AccessMode> = {
    free: "FREE_REVIEW",
    once: "PROCTORED_CLASS",
    blocked: "BLOCKED",
  };
  return mapping[rule] || "FREE_REVIEW";
}

/**
 * Map access mode to legacy rule (for backward compatibility)
 */
export function mapAccessModeToRule(accessMode: AccessMode): VideoRule {
  const mapping: Record<AccessMode, VideoRule> = {
    FREE_REVIEW: "free",
    PROCTORED_CLASS: "once",
    BLOCKED: "blocked",
  };
  return mapping[accessMode] || "free";
}


==========================================================================================
# FILE: ui/ToggleSwitch.tsx
==========================================================================================
// PATH: src/features/videos/ui/ToggleSwitch.tsx

interface Props {
  checked: boolean;
  onChange: (v: boolean) => void;
  disabled?: boolean;
}

export default function ToggleSwitch({ checked, onChange, disabled = false }: Props) {
  return (
    <button
      type="button"
      disabled={disabled}
      onClick={() => onChange(!checked)}
      aria-pressed={checked}
      className={[
        "relative h-6 w-11 rounded-full border transition",
        "border-[var(--border-divider)]",
        checked ? "bg-[var(--color-primary)]" : "bg-[var(--bg-app)]",
        disabled ? "opacity-60 cursor-not-allowed" : "cursor-pointer hover:bg-[var(--bg-surface-soft)]",
      ].join(" ")}
    >
      <span
        className={[
          "absolute top-0.5 h-5 w-5 rounded-full bg-white shadow-sm transition",
          checked ? "left-5" : "left-0.5",
        ].join(" ")}
      />
    </button>
  );
}


==========================================================================================
# FILE: ui/VideoInfoCards.tsx
==========================================================================================
// src/features/videos/components/VideoInfoCards.tsx

import dayjs from "dayjs";

type Props = {
  video: any;
  stats: any;
  memo: string;
  setMemo: (v: string) => void;
};

export default function VideoInfoCards({ video, stats, memo, setMemo }: Props) {
  const size = video.file_size
    ? (video.file_size / (1024 * 1024)).toFixed(1)
    : "-";

  const avg =
    stats?.avg_progress != null
      ? (stats.avg_progress * 100).toFixed(1) + "%"
      : "-";

  const created = video.created_at
    ? dayjs(video.created_at).format("YYYY-MM-DD HH:mm")
    : "-";

  const allowSkipLabel = video.allow_skip ? "허용" : "금지";
  const maxSpeedLabel = video.max_speed
    ? `${Number(video.max_speed).toFixed(2)}x`
    : "-";
  const watermarkLabel = video.show_watermark ? "표시" : "숨김";

  return (
    <div className="space-y-3 text-sm">
      {/* FILE INFO + STATS (compact) */}
      <div className="grid grid-cols-3 gap-3">
        
        {/* FILE INFO */}
        <div className="rounded border bg-white p-3 space-y-0.5">
          <div className="font-semibold text-xs mb-1">파일 정보</div>
          <div className="truncate">이름: {video.title}</div>
          <div>용량: {size}MB</div>
          <div>업로드: {created}</div>

          <div className="pt-1 text-[11px] text-gray-600 space-y-0.5">
            <div>건너뛰기: {allowSkipLabel}</div>
            <div>최대 배속: {maxSpeedLabel}</div>
            <div>워터마크: {watermarkLabel}</div>
          </div>
        </div>

        {/* STATS */}
        <div className="rounded border bg-white p-3 space-y-0.5">
          <div className="font-semibold text-xs mb-1">통계</div>
          <div>100% 완료: {stats?.completed_100 ?? 0}</div>
          <div>90%+ 완료: {stats?.completed_90 ?? 0}</div>
          <div>평균 진도율: {avg}</div>
        </div>

        {/* MEMO */}
        <div className="rounded border bg-white p-3 flex flex-col">
          <div className="font-semibold text-xs mb-1">메모</div>
          <textarea
            className="w-full border rounded px-2 py-1 text-xs flex-1"
            placeholder="메모..."
            value={memo}
            onChange={(e) => setMemo(e.target.value)}
          />
        </div>
      </div>
    </div>
  );
}


==========================================================================================
# FILE: ui/VideoStatusBadge.tsx
==========================================================================================
// PATH: src/features/videos/ui/VideoStatusBadge.tsx

import type { VideoStatus } from "../api/videos";

import { VIDEO_STATUS_LABEL, VIDEO_STATUS_TONE } from "../utils/videoStatus";

interface Props {
  status?: VideoStatus;
}

export default function VideoStatusBadge({ status }: Props) {
  if (!status) return null;

  return (
    <span className="ds-status-badge" data-tone={VIDEO_STATUS_TONE[status]}>
      {VIDEO_STATUS_LABEL[status]}
    </span>
  );
}


==========================================================================================
# FILE: ui/VideoThumbnail.tsx
==========================================================================================
// PATH: src/features/videos/ui/VideoThumbnail.tsx

import { useEffect, useState } from "react";
import { Button } from "@/shared/ui/ds";

type VideoStatus = "READY" | "PROCESSING" | "FAILED" | "PENDING" | "UPLOADED";

interface Props {
  title?: string;
  status?: VideoStatus;
  thumbnail_url?: string | null;
}

/**
 * ✅ SaaS 표준 Thumbnail
 * - thumbnail_url이 절대 URL이면 그대로 사용
 * - 상대 경로면 CDN BASE + default tenant 보정
 * - 실패 시 placeholder fallback
 * - 🔁 수동 재처리(캐시 무효화) 버튼
 */
export default function VideoThumbnail({ title, status, thumbnail_url }: Props) {
  const CDN_BASE = import.meta.env.VITE_MEDIA_CDN_BASE || "";

  const resolveThumbnailSrc = () => {
    if (!thumbnail_url) return null;

    // ✅ 이미 절대 URL이면 그대로
    if (thumbnail_url.startsWith("http://") || thumbnail_url.startsWith("https://")) {
      return thumbnail_url;
    }

    // ✅ 상대경로 + tenant 누락 → default 보정
    let path = thumbnail_url.replace(/^\/+/, "");

    if (path.startsWith("media/hls/videos/")) {
      // media/hls/videos/{video_id}/...  → default tenant 삽입
      path = path.replace(
        "media/hls/videos/",
        "media/hls/videos/default/videos/"
      );
    }

    return CDN_BASE ? `${CDN_BASE}/${path}` : `/${path}`;
  };

  let computedSrc = "/placeholder-video.png";

  const resolved = resolveThumbnailSrc();
  if (resolved) {
    computedSrc = resolved;
  } else if (status === "PROCESSING") {
    computedSrc = "/placeholder-processing.png";
  } else if (status === "FAILED") {
    computedSrc = "/placeholder-failed.png";
  }

  const [src, setSrc] = useState(computedSrc);

  // ✅ props 변경 시 동기화
  useEffect(() => {
    setSrc(computedSrc);
  }, [computedSrc]);

  const refreshThumbnail = () => {
    if (!resolved) return;
    const v = Date.now();
    const next =
      resolved.includes("?")
        ? `${resolved}&v=${v}`
        : `${resolved}?v=${v}`;
    setSrc(next);
  };

  return (
    <div className="aspect-video w-full overflow-hidden rounded-md bg-gray-100 shadow-sm relative">
      <img
        src={src}
        alt={title || "영상 썸네일"}
        className="h-full w-full object-cover"
        loading="lazy"
        decoding="async"
        onError={() => {
          setSrc("/placeholder-video.png");
        }}
      />

      {resolved && (
        <Button
          type="button"
          intent="secondary"
          size="sm"
          onClick={(e) => {
            e.preventDefault();
            e.stopPropagation();
            refreshThumbnail();
          }}
          className="absolute bottom-2 right-2 !bg-black/60 hover:!bg-black/80 !text-white !border-0"
        >
          🔄 썸네일 새로고침
        </Button>
      )}
    </div>
  );
}


==========================================================================================
# FILE: utils/videoStatus.ts
==========================================================================================
// PATH: src/features/videos/utils/videoStatus.ts

import type { VideoStatus } from "../api/videos";

export const VIDEO_STATUS_LABEL: Record<VideoStatus, string> = {
  PENDING: "업로드 대기",
  UPLOADED: "업로드 완료",
  PROCESSING: "인코딩 중",
  READY: "시청 가능",
  FAILED: "처리 실패",
};

/** 공용 톤 SSOT: success(초록) | danger(빨강) | warning(노랑) | primary(강조) | neutral(회색) */
export const VIDEO_STATUS_TONE: Record<VideoStatus, "success" | "danger" | "warning" | "primary" | "neutral"> = {
  PENDING: "neutral",
  UPLOADED: "primary",
  PROCESSING: "warning",
  READY: "success",
  FAILED: "danger",
};


==========================================================================================
# FILE: utils/videoUpload.ts
==========================================================================================
// PATH: src/features/videos/utils/videoUpload.ts
// 영상 업로드 유틸리티 — 모달 밖에서 실행되어 작업 박스에서 진행률 표시

import api from "@/shared/api/axios";
import { asyncStatusStore } from "@/shared/ui/asyncStatus";

type UploadInitResponse = {
  video: { id: number };
  upload_url: string;
  file_key: string;
  content_type?: string;
};

export interface VideoUploadParams {
  sessionId: number;
  file: File;
  title: string;
  description?: string;
  showWatermark: boolean;
  allowSkip: boolean;
  maxSpeed: number;
}

export interface InitVideoResult {
  videoId: number;
  uploadUrl: string;
  putHeaders: Record<string, string>;
  tempId: string;
}

/**
 * 업로드 init만 수행 — DB에 영상 row 생성, 목록에 바로 표시 가능
 */
export async function initVideoUpload(params: VideoUploadParams): Promise<InitVideoResult> {
  const { sessionId, file, title, description, showWatermark, allowSkip, maxSpeed } = params;

  const initPayload = {
    session: sessionId,
    title: title.trim(),
    filename: file.name,
    content_type: file.type || "video/mp4",
    show_watermark: showWatermark,
    allow_skip: allowSkip,
    max_speed: maxSpeed,
    ...(description?.trim() ? { description: description.trim() } : {}),
  };

  const tempId = `video-upload-${sessionId}-${Date.now()}-${Math.random().toString(36).slice(2, 9)}`;
  asyncStatusStore.addTask("영상 추가", tempId);

  const initRes = await api.post<UploadInitResponse>("/media/videos/upload/init/", initPayload);

  const uploadUrl = initRes.data?.upload_url;
  const videoId = initRes.data?.video?.id;
  const contentTypeFromServer = initRes.data?.content_type;

  if (!uploadUrl || !videoId) {
    asyncStatusStore.completeTask(tempId, "error", "업로드 초기화에 실패했습니다.");
    throw new Error("업로드 초기화에 실패했습니다.");
  }

  const putHeaders: Record<string, string> = {};
  if (contentTypeFromServer) {
    putHeaders["Content-Type"] = contentTypeFromServer;
  }

  return { videoId, uploadUrl, putHeaders, tempId };
}

/**
 * R2 PUT + complete — init 이후 백그라운드에서 실행
 */
export async function uploadFileToR2AndComplete(
  initResult: InitVideoResult,
  file: File
): Promise<number> {
  const { videoId, uploadUrl, putHeaders, tempId } = initResult;

  try {
    await new Promise<void>((resolve, reject) => {
      const xhr = new XMLHttpRequest();
      xhr.upload.addEventListener("progress", (e) => {
        if (e.lengthComputable) {
          const percent = Math.round((e.loaded / e.total) * 100);
          asyncStatusStore.updateProgress(tempId, percent);
        }
      });
      xhr.addEventListener("load", () => {
        if (xhr.status >= 200 && xhr.status < 300) {
          resolve();
        } else {
          reject(new Error(`R2 업로드 실패: ${xhr.status} ${xhr.statusText}`));
        }
      });
      xhr.addEventListener("error", () => reject(new Error("R2 업로드 중 네트워크 오류")));
      xhr.open("PUT", uploadUrl);
      Object.entries(putHeaders).forEach(([key, value]) => {
        xhr.setRequestHeader(key, value);
      });
      xhr.send(file);
    });

    await api.post<{ id: number }>(`/media/videos/${videoId}/upload/complete/`, {
      ok: true,
    });

    asyncStatusStore.attachWorkerMeta(tempId, String(videoId), "video_processing");
    return videoId;
  } catch (error) {
    const msg =
      (error as { response?: { data?: { detail?: string } }; message?: string })?.response?.data
        ?.detail ||
      (error as Error)?.message ||
      "업로드에 실패했습니다.";
    asyncStatusStore.completeTask(tempId, "error", msg);
    throw error;
  }
}

/**
 * 영상 업로드 전체 실행 — init + R2 + complete (기존 단일 호출용)
 * @returns videoId
 */
export async function uploadVideo(params: VideoUploadParams): Promise<number> {
  const initResult = await initVideoUpload(params);
  return uploadFileToR2AndComplete(initResult, params.file);
}
