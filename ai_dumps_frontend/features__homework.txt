====================================================================================================
# FRONTEND FOLDER: features__homework
# ROOT PATH: C:\academyfront\src\features\homework
====================================================================================================


==========================================================================================
# FILE: queryKeys.ts
==========================================================================================
// PATH: src/features/homework/queryKeys.ts

export const QUERY_KEYS = {
  // ===== Scores (Session ì„±ì  íƒ­ ë‹¨ì¼ ì§„ì‹¤) =====
  SESSION_SCORES: (sessionId: number) => ["session-scores", sessionId] as const,

  // ===== Homework (ë‹¨ì¼ ì§„ì‹¤ë“¤) =====
  ADMIN_HOMEWORK: (homeworkId: number) =>
    ["admin-homework", homeworkId] as const,

  HOMEWORK_POLICY: (sessionId: number) =>
    ["homework-policy", sessionId] as const,

  HOMEWORK_ASSIGNMENTS: (homeworkId: number) =>
    ["homework-assignments", homeworkId] as const,

  HOMEWORK_SESSION_ENROLLMENTS: (sessionId: number) =>
    ["homework-session-enrollments", sessionId] as const,

  HOMEWORKS_LIST: (sessionId: number) => ["homeworks", sessionId] as const,
};


==========================================================================================
# FILE: types.ts
==========================================================================================
// PATH: src/features/homework/types.ts
/**
 * HomeworkPolicy (Session ë‹¨ìœ„ ì •ì±…)
 *
 * âœ… LOCKED
 * - í”„ë¡ íŠ¸ëŠ” "ì„¤ì • ì…ë ¥"ë§Œ í•œë‹¤
 * - passed/clinic íŒë‹¨ì€ ì„œë²„ ë‹¨ì¼ ì§„ì‹¤
 *
 * âœ… ì¶”ê°€ ìš”êµ¬ì‚¬í•­
 * - ì»¤íŠ¸ë¼ì¸ ì…ë ¥ ëª¨ë“œ ì„ íƒ (% or ë¬¸í•­ìˆ˜)
 * - ë°˜ì˜¬ë¦¼ ë‹¨ìœ„ëŠ” ìœ ì§€
 * - í´ë¦¬ë‹‰ ì˜µì…˜ì€ UIì—ì„œ ì œê±° (ìë™ ì œê³µ)
 */

export type HomeworkCutlineMode = "PERCENT" | "COUNT";

export type HomeworkPolicy = {
  id: number;
  session: number;

  cutline_mode: HomeworkCutlineMode; // "PERCENT" | "COUNT"
  cutline_value: number; // 70 or 40

  round_unit_percent: number; // percent ëª¨ë“œì—ì„œë§Œ ì‹¤ì§ˆ ì˜ë¯¸ (ì˜ˆ: 5)

  created_at: string;
  updated_at: string;
};


==========================================================================================
# FILE: ìŠ¤í™.ts
==========================================================================================
// âš ï¸ LOCKED
// - Homework 1ê°œ = cutline 1ê°œ
// - HomeworkëŠ” sessionë‹¹ ì—¬ëŸ¬ ê°œ ê°€ëŠ¥
// - HomeworkScoreëŠ” "í™•ì • ìŠ¤ëƒ…ìƒ·"
// - AI íŒì •ì€ CLOSED ì´í›„ì—ë„ ê°€ëŠ¥
// - í•™ìƒ í™”ë©´ì€ ì—¬ê¸°ì„œ ë‹¤ë£¨ì§€ ì•ŠìŒ


==========================================================================================
# FILE: api/adminHomework.ts
==========================================================================================
// PATH: src/features/homework/api/adminHomework.ts
import api from "@/shared/api/axios";

export type AdminHomeworkDetail = {
  id: number;
  session_id?: number;

  title: string;
  description?: string;

  status: "DRAFT" | "OPEN" | "CLOSED";

  created_at: string;
  updated_at: string;
};

function normalize(raw: any): AdminHomeworkDetail {
  const rawSession = raw?.session_id ?? raw?.session ?? raw?.sessionId;

  return {
    id: Number(raw?.id),
    session_id:
      typeof rawSession === "number" && rawSession > 0 ? rawSession : undefined,

    title: String(raw?.title ?? ""),
    description: raw?.description ?? undefined,

    status: (raw?.status ?? "DRAFT") as any,

    created_at: String(raw?.created_at ?? ""),
    updated_at: String(raw?.updated_at ?? ""),
  };
}

export async function fetchAdminHomework(homeworkId: number) {
  const res = await api.get(`/homeworks/${homeworkId}/`);
  return normalize(res.data);
}

export async function updateAdminHomework(
  homeworkId: number,
  payload: Partial<AdminHomeworkDetail>
) {
  const res = await api.patch(`/homeworks/${homeworkId}/`, payload);
  return normalize(res.data);
}


==========================================================================================
# FILE: api/homeworkAssignments.ts
==========================================================================================
// PATH: src/features/homework/api/homeworkAssignments.ts
/**
 * Homework Assignments API
 *
 * ë‹¨ì¼ ì§„ì‹¤:
 * - GET  /homework/assignments/?homework_id=
 * - PUT  /homework/assignments/?homework_id=  { enrollment_ids: number[] }
 *
 * ì‘ë‹µ ê°€ì •(í˜„ì¬ ë„ˆ ì½”ë“œ ê¸°ì¤€):
 * - res.data.items: Array<{ enrollment_id, student_name, is_selected }>
 */

import api from "@/shared/api/axios";

export type HomeworkAssignmentItem = {
  enrollment_id: number;
  student_name: string;
  is_selected: boolean;
};

export type HomeworkAssignmentsResponse = {
  items: HomeworkAssignmentItem[];
  selected_ids: number[];
};

function normalizeItems(raw: any): HomeworkAssignmentItem[] {
  const list = Array.isArray(raw?.items) ? raw.items : [];
  return list.map((r: any) => ({
    enrollment_id: Number(r?.enrollment_id),
    student_name: String(r?.student_name ?? ""),
    is_selected: Boolean(r?.is_selected),
  }));
}

export async function fetchHomeworkAssignments(
  homeworkId: number
): Promise<HomeworkAssignmentsResponse> {
  const hid = Number(homeworkId);
  if (!Number.isFinite(hid) || hid <= 0) {
    return { items: [], selected_ids: [] };
  }

  const res = await api.get("/homework/assignments/", {
    params: { homework_id: hid },
  });

  const items = normalizeItems(res.data);
  const selected_ids = items
    .filter((x) => x.is_selected)
    .map((x) => x.enrollment_id);

  return { items, selected_ids };
}

export async function putHomeworkAssignments(params: {
  homeworkId: number;
  enrollment_ids: number[];
}): Promise<void> {
  const hid = Number(params.homeworkId);
  await api.put(
    "/homework/assignments/",
    { enrollment_ids: params.enrollment_ids },
    { params: { homework_id: hid } }
  );
}


==========================================================================================
# FILE: api/homeworkPolicy.ts
==========================================================================================
// PATH: src/features/homework/api/homeworkPolicy.ts
/**
 * HomeworkPolicy API
 *
 * âœ… ëª©í‘œ
 * - ì»¤íŠ¸ë¼ì¸ ëª¨ë“œ(PERCENT/COUNT) + ê°’(cutline_value) ê´€ë¦¬
 * - ë°˜ì˜¬ë¦¼ ë‹¨ìœ„ ìœ ì§€
 *
 * ğŸ”’ ê³„ì•½
 * - POST ì—†ìŒ (í”„ë¡ íŠ¸ ìƒì„± ê¸ˆì§€)
 * - passed/clinic íŒë‹¨ì€ ì„œë²„ ë‹¨ì¼ ì§„ì‹¤
 */

import api from "@/shared/api/axios";
import type { HomeworkPolicy, HomeworkCutlineMode } from "../types";

function normalize(raw: any): HomeworkPolicy {
  const session = Number(raw?.session ?? raw?.session_id ?? 0);

  // ì„œë²„ê°€ ìƒˆ ìŠ¤í™ì„ ì´ë¯¸ ì§€ì›í•˜ëŠ” ê²½ìš°
  const modeRaw = String(raw?.cutline_mode ?? "").toUpperCase();
  const mode: HomeworkCutlineMode =
    modeRaw === "COUNT" ? "COUNT" : "PERCENT";

  const valueRaw =
    raw?.cutline_value ??
    // â›‘ï¸ êµ¬í˜• í˜¸í™˜: cutline_percentë§Œ ìˆìœ¼ë©´ percent ëª¨ë“œë¡œ í¡ìˆ˜
    raw?.cutline_percent ??
    80;

  return {
    id: Number(raw?.id),
    session,

    cutline_mode: mode,
    cutline_value: Number(valueRaw),

    round_unit_percent: Number(raw?.round_unit_percent ?? 5),

    created_at: String(raw?.created_at ?? ""),
    updated_at: String(raw?.updated_at ?? ""),
  };
}

export async function fetchHomeworkPolicyBySession(
  sessionId: number
): Promise<HomeworkPolicy | null> {
  if (!Number.isFinite(sessionId) || sessionId <= 0) return null;

  const res = await api.get("/homework/policies/", {
    params: { session: sessionId },
  });

  const data = res.data;
  const list = Array.isArray(data?.results)
    ? data.results
    : Array.isArray(data)
    ? data
    : [];

  if (list.length === 0) return null;
  return normalize(list[0]);
}

/**
 * PATCH /homework/policies/{id}/
 *
 * payload ì˜ˆì‹œ:
 * - { cutline_mode:"PERCENT", cutline_value:70, round_unit_percent:5 }
 * - { cutline_mode:"COUNT", cutline_value:40 }
 */
export async function patchHomeworkPolicy(
  id: number,
  payload: Partial<
    Pick<HomeworkPolicy, "cutline_mode" | "cutline_value" | "round_unit_percent">
  >
): Promise<HomeworkPolicy> {
  const res = await api.patch(`/homework/policies/${id}/`, payload);
  return normalize(res.data);
}


==========================================================================================
# FILE: api/homeworkScores.ts
==========================================================================================
// PATH: src/features/homework/api/homeworkScores.ts
/**
 * HomeworkScore API
 *
 * âœ… LOCKED SPEC
 * - GET   /homework/scores/?session=&lecture=&enrollment_id=&is_locked=
 * - PATCH /homework/scores/{id}/
 * - PATCH /homework/scores/quick/  (ì¡°êµ ë¹ ë¥¸ ì…ë ¥)
 *
 * âœ… PATCH ì—ëŸ¬ ê³„ì•½ (Backend ê¸°ì¤€)
 * - is_locked == true â†’ 409 + {code:"LOCKED", lock_reason?}
 *
 * âœ… ì£¼ì˜
 * - NO_SUBMISSIONì€ "PATCH ê²°ê³¼ payload ì•ˆì— progress.reason"ìœ¼ë¡œ ë‚´ë ¤ì˜¬ ë¿,
 *   PATCH ìì²´ê°€ 409ë¥¼ ë‚´ì§€ ì•ŠìŒ (í˜„ì¬ ë°±ì—”ë“œ êµ¬í˜„ ê¸°ì¤€)
 *
 * ğŸš« í”„ë¡ íŠ¸ ê¸ˆì§€
 * - HomeworkScore ìƒì„± âŒ
 * - passed ê³„ì‚° âŒ (ì„œë²„ PATCH ê²°ê³¼ë§Œ ì‹ ë¢°)
 */

import api from "@/shared/api/axios";
import type { HomeworkScore } from "../types";

export type HomeworkPatchErrorCode = "LOCKED" | "UNKNOWN";

export type HomeworkPatchError = {
  code: HomeworkPatchErrorCode;
  detail: string;
  lock_reason?: string | null;
};

function normalizeScore(raw: any): HomeworkScore {
  return {
    id: Number(raw?.id),

    enrollment_id: Number(raw?.enrollment_id ?? raw?.enrollment ?? 0),
    session: Number(raw?.session ?? raw?.session_id ?? 0),

    score: raw?.score == null ? null : Number(raw.score),
    max_score: raw?.max_score == null ? null : Number(raw.max_score),

    teacher_approved: Boolean(raw?.teacher_approved ?? false),

    // âœ… backend ë‹¨ì¼ ì§„ì‹¤
    passed: Boolean(raw?.passed ?? false),
    clinic_required: Boolean(raw?.clinic_required ?? false),

    is_locked: Boolean(raw?.is_locked ?? false),
    lock_reason: (raw?.lock_reason ?? null) as any,

    updated_by_user_id:
      raw?.updated_by_user_id == null ? null : Number(raw.updated_by_user_id),

    meta: raw?.meta ?? null,

    created_at: String(raw?.created_at ?? ""),
    updated_at: String(raw?.updated_at ?? ""),
  };
}

/**
 * GET /homework/scores/
 */
export async function fetchHomeworkScores(params: {
  session?: number;
  lecture?: number;
  enrollment_id?: number;
  is_locked?: boolean;
}): Promise<HomeworkScore[]> {
  const res = await api.get("/homework/scores/", { params });

  const data = res.data;
  const list = Array.isArray(data?.results)
    ? data.results
    : Array.isArray(data)
    ? data
    : [];

  return list.map(normalizeScore);
}

/**
 * PATCH /homework/scores/{id}/
 */
export async function patchHomeworkScore(
  id: number,
  payload: Partial<Pick<HomeworkScore, "score" | "max_score" | "teacher_approved">>
): Promise<HomeworkScore> {
  try {
    const res = await api.patch(`/homework/scores/${id}/`, payload);
    return normalizeScore(res.data);
  } catch (e: any) {
    const status = e?.response?.status;
    const data = e?.response?.data;

    // âœ… backend LOCK ì—ëŸ¬ ê·œê²©
    if (status === 409 && String(data?.code).toUpperCase() === "LOCKED") {
      const err: HomeworkPatchError = {
        code: "LOCKED",
        detail: String(data?.detail ?? "score block is locked"),
        lock_reason: data?.lock_reason ?? null,
      };
      throw err;
    }

    const err: HomeworkPatchError = {
      code: "UNKNOWN",
      detail: String(data?.detail ?? e?.message ?? "PATCH failed"),
    };
    throw err;
  }
}

/**
 * PATCH /homework/scores/quick/
 *
 * âœ… Quick ì…ë ¥ (ì¡°êµ UX)
 * - percent ì…ë ¥: score=85, max_score ìƒëµ/ null
 * - raw/max ì…ë ¥: score=18, max_score=20
 *
 * â—ì£¼ì˜
 * - ì´ í˜¸ì¶œì€ "ìŠ¤ëƒ…ìƒ· ìƒì„±"ì„ ì˜ë¯¸í•˜ì§€ë§Œ,
 *   í”„ë¡ íŠ¸ì—ì„œëŠ” "HomeworkScore ìƒì„± APIë¥¼ ë”°ë¡œ ë§Œë“¤ì§€ ì•ŠëŠ”ë‹¤"ëŠ” ê³„ì•½ ìœ ì§€
 *   â†’ quick_patchë§Œ upsertë¡œ í—ˆìš©ë˜ëŠ” í†µë¡œ
 */
export async function quickPatchHomeworkScore(payload: {
  session_id: number;
  enrollment_id: number;
  score: number;
  max_score?: number | null;
}): Promise<HomeworkScore> {
  try {
    const res = await api.patch(`/homework/scores/quick/`, payload);
    return normalizeScore(res.data);
  } catch (e: any) {
    const status = e?.response?.status;
    const data = e?.response?.data;

    if (status === 409 && String(data?.code).toUpperCase() === "LOCKED") {
      const err: HomeworkPatchError = {
        code: "LOCKED",
        detail: String(data?.detail ?? "score block is locked"),
        lock_reason: data?.lock_reason ?? null,
      };
      throw err;
    }

    const err: HomeworkPatchError = {
      code: "UNKNOWN",
      detail: String(data?.detail ?? e?.message ?? "QUICK PATCH failed"),
    };
    throw err;
  }
}


==========================================================================================
# FILE: api/homeworks.ts
==========================================================================================
// PATH: src/features/homework/api/homeworks.ts
/**
 * Homework List/Create API
 *
 * âœ… ëª©í‘œ
 * - SessionAssessmentSidePanel(ì„¸ì…˜ ê³µìš©íƒ­)ì—ì„œ ìƒì„±/ì‚­ì œ/ì„ íƒ íë¦„ì„ ì‹œí—˜ê³¼ ë™ì¼í•˜ê²Œ ìœ ì§€
 * - ë°±ì—”ë“œ endpoint/í•„ë“œëª…ì´ ì•½ê°„ ë‹¬ë¼ë„ í”„ë¡ íŠ¸ê°€ í¡ìˆ˜ (session vs session_id)
 */

import api from "@/shared/api/axios";

export type HomeworkListItem = {
  id: number;
  title: string;
  status: "DRAFT" | "OPEN" | "CLOSED";
  session_id?: number;
};

function normalizeListItem(raw: any): HomeworkListItem {
  const sid = raw?.session_id ?? raw?.session ?? raw?.sessionId;

  return {
    id: Number(raw?.id),
    title: String(raw?.title ?? ""),
    status: (raw?.status ?? "DRAFT") as any,
    session_id: typeof sid === "number" && sid > 0 ? sid : undefined,
  };
}

export async function fetchHomeworks(params?: { session_id?: number }) {
  const res = await api.get("/homeworks/", { params });
  const d = res.data;

  const list = Array.isArray(d?.results)
    ? d.results
    : Array.isArray(d?.items)
    ? d.items
    : Array.isArray(d)
    ? d
    : [];

  return list.map(normalizeListItem);
}

/**
 * âœ… POST /homeworks/
 * - payloadëŠ” backend í¸ì°¨ í¡ìˆ˜ ìœ„í•´ session_id + session ë‘˜ ë‹¤ ë³´ëƒ„
 */
export async function createHomework(payload: {
  session_id: number;
  title: string;
  status?: "DRAFT" | "OPEN" | "CLOSED";
}) {
  const res = await api.post("/homeworks/", {
    session_id: payload.session_id,
    session: payload.session_id, // âœ… í˜¸í™˜ìš© (backendê°€ session í•„ë“œë§Œ ë°›ëŠ” ê²½ìš°)
    title: payload.title,
    status: payload.status ?? "DRAFT",
  });

  return res.data;
}

/**
 * âœ… DELETE /homeworks/{id}/
 */
export async function deleteHomework(homeworkId: number) {
  const res = await api.delete(`/homeworks/${homeworkId}/`);
  return res.data;
}


==========================================================================================
# FILE: api/sessionEnrollments.ts
==========================================================================================
// PATH: src/features/homework/api/sessionEnrollments.ts
/**
 * SessionEnrollment API (homework wrapper)
 *
 * âœ… ë‹¨ì¼ ì§„ì‹¤
 * - í•™ìƒ ëª©ë¡: SessionEnrollment
 * - ì‹ë³„ì: enrollment_id (student_id âŒ)
 *
 * API:
 * - GET /enrollments/session-enrollments/?session={sessionId}
 */

import api from "@/shared/api/axios";
import type { SessionEnrollment } from "../types";

export async function fetchSessionEnrollments(
  sessionId: number
): Promise<SessionEnrollment[]> {
  const res = await api.get("/enrollments/session-enrollments/", {
    params: { session: sessionId },
  });

  const data = res.data;
  const list = Array.isArray(data?.results)
    ? data.results
    : Array.isArray(data)
    ? data
    : [];

  return list.map((raw: any) => ({
    id: Number(raw?.id),
    session: Number(raw?.session),
    enrollment: Number(raw?.enrollment),
    student_name: String(raw?.student_name ?? ""),
    created_at: String(raw?.created_at ?? ""),
  }));
}


==========================================================================================
# FILE: components/AdminHomeworkDetail.tsx
==========================================================================================
// PATH: src/features/homework/components/AdminHomeworkDetail.tsx
/**
 * AdminHomeworkDetail
 *
 * âœ… ì‹œí—˜ UX 100% ë³µì œ
 * íƒ­: setup / assets / submissions / results
 *
 * ğŸš« ê¸ˆì§€
 * - ì ìˆ˜ ê³„ì‚° âŒ
 * - passed ê³„ì‚° âŒ
 * - HomeworkScore ìƒì„± âŒ
 */

import { useState } from "react";
import type { HomeworkTabKey, HomeworkSummary } from "../types";

import HomeworkHeader from "./common/HomeworkHeader";
import HomeworkTabs from "./common/HomeworkTabs";
import { useAdminHomework } from "../hooks/useAdminHomework";
import HomeworkSetupPanel from "../panels/HomeworkSetupPanel";
import HomeworkAssetsPanel from "../panels/HomeworkAssetsPanel";
import HomeworkSubmissionsPanel from "../panels/HomeworkSubmissionsPanel";
import HomeworkResultsPanel from "../panels/HomeworkResultsPanel";

export default function AdminHomeworkDetail({ homeworkId }: { homeworkId: number }) {
  const [activeTab, setActiveTab] = useState<HomeworkTabKey>("setup");
  const { data, isLoading, isError } = useAdminHomework(homeworkId);

  if (!Number.isFinite(homeworkId) || homeworkId <= 0) {
    return (
      <div className="rounded border bg-yellow-50 p-4 text-sm text-yellow-800">
        homeworkIdê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.
      </div>
    );
  }

  if (isLoading) {
    return <div className="text-sm text-gray-500">ê³¼ì œ ì •ë³´ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>;
  }

  if (isError || !data) {
    return <div className="text-sm text-red-600">ê³¼ì œ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</div>;
  }

  const summary: HomeworkSummary = {
    id: data.id,
    title: data.title,
    status: data.status,
  };

  return (
    <div className="space-y-6">
      <HomeworkHeader homework={summary} />
      <HomeworkTabs activeTab={activeTab} onChange={setActiveTab} />

      {activeTab === "setup" && <HomeworkSetupPanel homeworkId={homeworkId} />}
      {activeTab === "assets" && <HomeworkAssetsPanel homeworkId={homeworkId} />}
      {activeTab === "submissions" && <HomeworkSubmissionsPanel homeworkId={homeworkId} />}
      {activeTab === "results" && <HomeworkResultsPanel homeworkId={homeworkId} />}
    </div>
  );
}


==========================================================================================
# FILE: components/CreateHomeworkModal.tsx
==========================================================================================
// PATH: src/features/homework/components/CreateHomeworkModal.tsx
// ------------------------------------------------------------
// CreateHomeworkModal âœ… FINAL (ì‹œí—˜ ìƒì„± UXì™€ ë™ì¼í•œ ìœ„ì¹˜ì—ì„œ ì‚¬ìš©)
// ------------------------------------------------------------
// ì±…ì„:
// - ê³¼ì œ ìƒì„± UI
// - ìƒì„± ì„±ê³µ ì‹œ onCreated(newId) í˜¸ì¶œ
//
// âœ… ë°±ì—”ë“œ í¸ì°¨ í¡ìˆ˜:
// - session_id / session ë‘˜ ë‹¤ ì „ì†¡
// ------------------------------------------------------------

import { useEffect, useState } from "react";
import { useMutation } from "@tanstack/react-query";

import { createHomework } from "../api/homeworks";

type Props = {
  open: boolean;
  onClose: () => void;
  sessionId: number;
  onCreated: (newId: number) => void;
};

type HomeworkStatus = "DRAFT" | "OPEN" | "CLOSED";

export default function CreateHomeworkModal({
  open,
  onClose,
  sessionId,
  onCreated,
}: Props) {
  const [title, setTitle] = useState("");
  const [status, setStatus] = useState<HomeworkStatus>("DRAFT");

  // ëª¨ë‹¬ ì—´ë¦´ ë•Œ ê¸°ë³¸ê°’ ë¦¬ì…‹
  useEffect(() => {
    if (open) {
      setTitle("");
      setStatus("DRAFT");
    }
  }, [open]);

  const m = useMutation({
    mutationFn: async () => {
      const res = await createHomework({
        session_id: sessionId,
        title: title.trim(),
        status,
      });
      return res;
    },
    onSuccess: (data: any) => {
      const newId = Number(data?.id);
      if (Number.isFinite(newId) && newId > 0) {
        onCreated(newId);
        onClose();
        return;
      }

      // idê°€ ë‹¤ë¥¸ í‚¤ë¡œ ì˜¤ë©´ ì—¬ê¸°ë„ í¡ìˆ˜
      const fallbackId = Number(data?.homework_id ?? data?.pk ?? NaN);
      if (Number.isFinite(fallbackId) && fallbackId > 0) {
        onCreated(fallbackId);
        onClose();
        return;
      }

      alert(
        "ê³¼ì œ ìƒì„±ì€ ì„±ê³µí–ˆì§€ë§Œ ì‘ë‹µì—ì„œ idë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.\në°±ì—”ë“œ ì‘ë‹µ í¬ë§·ì„ í™•ì¸í•˜ì„¸ìš”."
      );
    },
    onError: (e: any) => {
      const detail =
        e?.response?.data?.detail ||
        e?.message ||
        "ê³¼ì œ ìƒì„± ì‹¤íŒ¨ (API ì—°ê²° í™•ì¸ í•„ìš”)";
      alert(detail);
    },
  });

  if (!open) return null;

  const disabled =
    m.isPending || title.trim().length === 0 || !(sessionId > 0);

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/30 p-4">
      <div className="w-full max-w-md rounded-xl bg-[var(--bg-surface)] p-5 shadow-lg">
        <div className="mb-3 text-lg font-semibold text-[var(--text-primary)]">
          ê³¼ì œ ìƒì„±
        </div>

        <div className="space-y-3">
          <div>
            <div className="mb-1 text-xs font-medium text-[var(--text-secondary)]">
              ì œëª©
            </div>
            <input
              className="w-full rounded border border-[var(--border-divider)] bg-[var(--bg-app)] px-3 py-2 text-sm text-[var(--text-primary)] placeholder:text-[var(--text-muted)]"
              placeholder="ì˜ˆ) 1ì£¼ì°¨ ê³¼ì œ"
              value={title}
              onChange={(e) => setTitle(e.target.value)}
              autoFocus
            />
          </div>

          <div>
            <div className="mb-1 text-xs font-medium text-[var(--text-secondary)]">
              ìƒíƒœ
            </div>
            <select
              className="w-full rounded border border-[var(--border-divider)] bg-[var(--bg-app)] px-3 py-2 text-sm text-[var(--text-primary)]"
              value={status}
              onChange={(e) => setStatus(e.target.value as HomeworkStatus)}
            >
              <option value="DRAFT">DRAFT</option>
              <option value="OPEN">OPEN</option>
              <option value="CLOSED">CLOSED</option>
            </select>
          </div>

          <div className="pt-2 text-xs text-[var(--text-muted)]">
            session_id: {sessionId}
          </div>
        </div>

        <div className="mt-5 flex justify-end gap-2">
          <button
            className="rounded border border-[var(--border-divider)] px-3 py-2 text-sm text-[var(--text-secondary)] hover:bg-[var(--bg-surface-soft)]"
            onClick={onClose}
            disabled={m.isPending}
          >
            ì·¨ì†Œ
          </button>

          <button
            className="rounded bg-[var(--color-primary)] px-4 py-2 text-sm font-semibold text-white disabled:opacity-50"
            onClick={() => m.mutate()}
            disabled={disabled}
          >
            {m.isPending ? "ìƒì„± ì¤‘..." : "ìƒì„±"}
          </button>
        </div>
      </div>
    </div>
  );
}


==========================================================================================
# FILE: components/HomeworkEnrollmentManageModal.tsx
==========================================================================================
// PATH: src/features/homework/components/HomeworkEnrollmentManageModal.tsx
/**
 * HomeworkEnrollmentManageModal
 *
 * âœ… ê³¼ì œ ì „ìš© ëŒ€ìƒ í•™ìƒ ê´€ë¦¬ ëª¨ë‹¬ (ëŒ€ê¸°ì—… UX ê°œì„  ë²„ì „)
 *
 * ì±…ì„:
 * - homework_assignment ê´€ë¦¬ UI
 * - enrollment ì„ íƒ/í•´ì œ
 *
 * UX ì›ì¹™:
 * - "ì €ì¥ ê°€ëŠ¥ ìƒíƒœ"ë¥¼ ë²„íŠ¼/ë¬¸êµ¬ë¡œ ëª…í™•íˆ ë³´ì—¬ì¤€ë‹¤ (í´ë¦­í–ˆëŠ”ë° ë¬´ë°˜ì‘ ê¸ˆì§€)
 * - ë³€ê²½ì‚¬í•­ ìˆì„ ë•Œ ë‹«ê¸°/ì˜¤ë²„ë ˆì´/ESCëŠ” confirm
 * - loading/saving ìƒíƒœì—ì„œ ìƒí˜¸ì‘ìš© ìµœì†Œí™”
 *
 * âŒ ê¸ˆì§€:
 * - ì ìˆ˜ / HomeworkScore / quick_patch
 * - ì‹œí—˜ / ì„±ì  ëª¨ë‹¬ ì¬ì‚¬ìš©
 */

import { useEffect, useMemo, useState } from "react";
import type { EnrollmentRow } from "@/features/sessions/components/enrollment/types";

type Props = {
  open: boolean;
  onClose: () => void;

  title: string;
  description?: string;

  rows: EnrollmentRow[];
  loading?: boolean;
  error?: string | null;

  selectedIds: Set<number>;
  onToggle: (id: number) => void;
  onSetSelectedIds: (next: Set<number>) => void;

  onSave: () => void;
  saving?: boolean;

  /** âœ… Panelì´ ë‹¨ì¼ ì§„ì‹¤ë¡œ ê³„ì‚°í•´ì„œ ë‚´ë ¤ì¤€ë‹¤ */
  dirty: boolean;
};

export default function HomeworkEnrollmentManageModal({
  open,
  onClose,
  title,
  description,
  rows,
  loading = false,
  error,
  selectedIds,
  onToggle,
  onSetSelectedIds,
  onSave,
  saving = false,
  dirty,
}: Props) {
  const [keyword, setKeyword] = useState("");

  useEffect(() => {
    if (!open) setKeyword("");
  }, [open]);

  // ESC ë‹«ê¸° + dirty confirm
  useEffect(() => {
    if (!open) return;

    const onKeyDown = (e: KeyboardEvent) => {
      if (e.key !== "Escape") return;
      e.preventDefault();
      safeClose();
    };

    window.addEventListener("keydown", onKeyDown);
    return () => window.removeEventListener("keydown", onKeyDown);
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [open, dirty, saving, loading]);

  const filtered = useMemo(() => {
    const k = keyword.trim().toLowerCase();
    if (!k) return rows;
    return rows.filter((r) =>
      (r.student_name ?? "").toLowerCase().includes(k)
    );
  }, [rows, keyword]);

  if (!open) return null;

  const canInteract = !loading && !saving;
  const canSave = dirty && !loading && !saving;

  const safeClose = () => {
    if (saving) return; // ì €ì¥ì¤‘ ë‹«ê¸° ê¸ˆì§€
    if (!dirty) {
      onClose();
      return;
    }
    const ok = window.confirm(
      "ë³€ê²½ì‚¬í•­ì´ ìˆìŠµë‹ˆë‹¤.\nì €ì¥í•˜ì§€ ì•Šê³  ë‹«ì„ê¹Œìš”?"
    );
    if (ok) onClose();
  };

  const selectAll = () => {
    if (!canInteract) return;
    const next = new Set(selectedIds);
    filtered.forEach((r) => next.add(r.enrollment_id));
    onSetSelectedIds(next);
  };

  const clearAll = () => {
    if (!canInteract) return;
    const next = new Set(selectedIds);
    filtered.forEach((r) => next.delete(r.enrollment_id));
    onSetSelectedIds(next);
  };

  return (
    <div
      className="fixed inset-0 z-50 flex items-center justify-center bg-black/30 p-4"
      onMouseDown={(e) => {
        // ì˜¤ë²„ë ˆì´ í´ë¦­ ë‹«ê¸° (ì¹´ë“œ ë‚´ë¶€ í´ë¦­ì€ ë¬´ì‹œ)
        if (e.target === e.currentTarget) safeClose();
      }}
    >
      <div className="w-full max-w-2xl overflow-hidden rounded-xl bg-[var(--bg-surface)] shadow-lg">
        {/* Header */}
        <div className="flex items-start justify-between gap-4 border-b border-[var(--border-divider)] px-5 py-4">
          <div className="min-w-0">
            <div className="text-base font-semibold text-[var(--text-primary)]">
              {title}
            </div>
            {description && (
              <div className="mt-1 text-xs text-[var(--text-secondary)]">
                {description}
              </div>
            )}
          </div>

          <button
            type="button"
            className={[
              "shrink-0 text-sm",
              saving ? "text-[var(--text-disabled)]" : "text-[var(--text-muted)] hover:text-[var(--text-primary)]",
            ].join(" ")}
            onClick={safeClose}
            disabled={saving}
          >
            ë‹«ê¸°
          </button>
        </div>

        {/* Body */}
        <div className="space-y-4 px-5 py-4">
          {/* Toolbar */}
          <div className="flex flex-wrap items-center justify-between gap-2">
            <input
              value={keyword}
              onChange={(e) => setKeyword(e.target.value)}
              placeholder="í•™ìƒ ì´ë¦„ ê²€ìƒ‰"
              className="h-9 w-[240px] rounded border border-[var(--border-divider)] bg-[var(--bg-app)] px-3 text-sm text-[var(--text-primary)] placeholder:text-[var(--text-muted)]"
              disabled={!canInteract}
            />

            <div className="text-xs text-[var(--text-secondary)]">
              ì„ íƒë¨ <b>{selectedIds.size}</b>ëª… / ì „ì²´ {rows.length}ëª…
              {loading && (
                <span className="ml-2 text-[var(--text-muted)]">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</span>
              )}
            </div>

            <div className="flex gap-2">
              <button
                type="button"
                onClick={selectAll}
                disabled={!canInteract || filtered.length === 0}
                className="h-9 rounded border border-[var(--border-divider)] bg-[var(--bg-surface)] px-3 text-sm hover:bg-[var(--bg-surface-soft)] disabled:opacity-50"
              >
                í˜„ì¬ ëª©ë¡ ì „ì²´ ì„ íƒ
              </button>
              <button
                type="button"
                onClick={clearAll}
                disabled={!canInteract || filtered.length === 0}
                className="h-9 rounded border border-[var(--border-divider)] bg-[var(--bg-surface)] px-3 text-sm hover:bg-[var(--bg-surface-soft)] disabled:opacity-50"
              >
                í˜„ì¬ ëª©ë¡ ì „ì²´ í•´ì œ
              </button>
            </div>
          </div>

          {error && (
            <div className="rounded border border-[var(--color-danger)] bg-[var(--color-danger-soft)] px-4 py-3 text-sm text-[var(--color-danger)]">
              {error}
            </div>
          )}

          <div className="rounded border border-[var(--border-divider)] bg-[var(--bg-surface-soft)] px-4 py-3 text-xs text-[var(--text-secondary)]">
            âš  ì €ì¥ ë²„íŠ¼ì„ ëˆŒëŸ¬ì•¼ ì„œë²„ì— ì‹¤ì œ ë°˜ì˜ë©ë‹ˆë‹¤.
          </div>

          {/* Table */}
          <div className="max-h-[360px] overflow-auto rounded border border-[var(--border-divider)]">
            {loading ? (
              <div className="p-6 text-sm text-[var(--text-muted)]">
                ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
              </div>
            ) : filtered.length === 0 ? (
              <div className="p-6 text-sm text-[var(--text-muted)]">
                í‘œì‹œí•  í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤.
              </div>
            ) : (
              <table className="w-full text-sm">
                <thead className="sticky top-0 border-b border-[var(--border-divider)] bg-[var(--bg-surface-soft)] text-[var(--text-secondary)]">
                  <tr>
                    <th className="w-12 px-3 py-2 text-left">ì„ íƒ</th>
                    <th className="px-3 py-2 text-left">í•™ìƒ</th>
                    <th className="px-3 py-2 text-left">enrollment_id</th>
                  </tr>
                </thead>
                <tbody>
                  {filtered.map((r) => {
                    const checked = selectedIds.has(r.enrollment_id);
                    return (
                      <tr
                        key={r.enrollment_id}
                        className="border-t border-[var(--border-divider)] hover:bg-[var(--bg-surface-soft)]"
                      >
                        <td className="px-3 py-2">
                          <input
                            type="checkbox"
                            checked={checked}
                            disabled={!canInteract}
                            onChange={() => onToggle(r.enrollment_id)}
                          />
                        </td>
                        <td className="px-3 py-2 font-medium text-[var(--text-primary)]">
                          {r.student_name || "(ì´ë¦„ ì—†ìŒ)"}
                        </td>
                        <td className="px-3 py-2 text-[var(--text-muted)]">
                          {r.enrollment_id}
                        </td>
                      </tr>
                    );
                  })}
                </tbody>
              </table>
            )}
          </div>
        </div>

        {/* Footer */}
        <div className="flex items-center justify-between border-t border-[var(--border-divider)] px-5 py-4">
          <div className="text-xs text-[var(--text-muted)]">
            {saving
              ? "ì €ì¥ ì¤‘... ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”."
              : dirty
              ? "ë³€ê²½ì‚¬í•­ì´ ìˆìŠµë‹ˆë‹¤. ì €ì¥í•˜ë©´ í™•ì •ë©ë‹ˆë‹¤."
              : "ë³€ê²½ì‚¬í•­ ì—†ìŒ"}
          </div>

          <div className="flex gap-2">
            <button
              type="button"
              className="h-9 rounded border border-[var(--border-divider)] px-4 text-sm hover:bg-[var(--bg-surface-soft)] disabled:opacity-50"
              onClick={safeClose}
              disabled={saving}
            >
              ì·¨ì†Œ
            </button>

            <button
              type="button"
              className="h-9 rounded bg-[var(--color-primary)] px-4 text-sm font-semibold text-white disabled:opacity-50"
              onClick={onSave}
              disabled={!canSave}
              title={
                !dirty
                  ? "ë³€ê²½ì‚¬í•­ì´ ì—†ì–´ì„œ ì €ì¥í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
                  : loading
                  ? "ë¡œë”© ì¤‘ì—ëŠ” ì €ì¥í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
                  : saving
                  ? "ì €ì¥ ì¤‘..."
                  : "ì €ì¥"
              }
            >
              {saving ? "ì €ì¥ì¤‘..." : "ì„ íƒ í™•ì •(ì €ì¥)"}
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}


==========================================================================================
# FILE: components/HomeworkPolicyCard.tsx
==========================================================================================
// PATH: src/features/homework/components/HomeworkPolicyCard.tsx
/**
 * HomeworkPolicyCard
 *
 * âš ï¸ ë¡œì§ / ìƒíƒœ / API ë³€ê²½ ì—†ìŒ
 * âœ… ì „ì—­ ë””ìì¸ í† í° ì ìš©ë§Œ ìˆ˜í–‰
 */

import { useEffect, useMemo, useState } from "react";
import type { HomeworkPolicy, HomeworkCutlineMode } from "../types";

type PatchPayload = Partial<
  Pick<HomeworkPolicy, "cutline_mode" | "cutline_value" | "round_unit_percent">
>;

export default function HomeworkPolicyCard({
  policy,
  onPatch,
  isPatching,
}: {
  policy: HomeworkPolicy | null;
  onPatch: (payload: PatchPayload) => void;
  isPatching: boolean;
}) {
  const canEdit = !!policy && !isPatching;

  const [mode, setMode] = useState<HomeworkCutlineMode>(
    policy?.cutline_mode ?? "PERCENT"
  );
  const [cutlineValue, setCutlineValue] = useState<number>(
    policy?.cutline_value ?? 80
  );
  const [roundUnit, setRoundUnit] = useState<number>(
    policy?.round_unit_percent ?? 5
  );

  useEffect(() => {
    setMode(policy?.cutline_mode ?? "PERCENT");
    setCutlineValue(policy?.cutline_value ?? 80);
    setRoundUnit(policy?.round_unit_percent ?? 5);
  }, [
    policy?.id,
    policy?.cutline_mode,
    policy?.cutline_value,
    policy?.round_unit_percent,
  ]);

  const dirty = useMemo(() => {
    if (!policy) return false;
    return (
      mode !== policy.cutline_mode ||
      cutlineValue !== policy.cutline_value ||
      roundUnit !== policy.round_unit_percent
    );
  }, [policy, mode, cutlineValue, roundUnit]);

  const clampCutline = (v: number, nextMode: HomeworkCutlineMode) => {
    if (!Number.isFinite(v)) return 0;
    if (nextMode === "PERCENT") return Math.max(0, Math.min(100, v));
    return Math.max(0, v);
  };

  const helperText = useMemo(() => {
    if (mode === "COUNT") return "ì˜ˆ: 40ë¬¸í•­ ì´ìƒ í†µê³¼";
    return `ì˜ˆ: 70% (ë°˜ì˜¬ë¦¼ ë‹¨ìœ„ ${roundUnit}% ì ìš©)`;
  }, [mode, roundUnit]);

  if (!policy) {
    return (
      <div className="rounded border bg-[var(--bg-surface-soft)] p-3 text-sm text-[var(--text-muted)]">
        âš ï¸ ì´ ì„¸ì…˜ì˜ ê³¼ì œ ì •ì±…ì´ ì•„ì§ ì—†ìŠµë‹ˆë‹¤.
        <div className="mt-1 text-xs">
          - ì •ì±… ìƒì„±ì€ ë°±ì—”ë“œì—ì„œë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.
        </div>
      </div>
    );
  }

  return (
    <div className="space-y-4">
      {/* ì»¤íŠ¸ë¼ì¸ ê¸°ì¤€ */}
      <div className="space-y-2">
        <div className="text-sm font-medium text-[var(--text-secondary)]">
          ì»¤íŠ¸ë¼ì¸ ê¸°ì¤€
        </div>

        <div className="flex gap-2">
          <button
            type="button"
            disabled={!canEdit}
            onClick={() => {
              const nextMode: HomeworkCutlineMode = "PERCENT";
              setMode(nextMode);
              setCutlineValue((prev) => clampCutline(prev, nextMode));
            }}
            className={[
              "rounded border px-3 py-2 text-sm",
              mode === "PERCENT"
                ? "border-[var(--color-primary)] bg-[var(--bg-surface-soft)] font-semibold text-[var(--color-primary)]"
                : "text-[var(--text-secondary)] hover:bg-[var(--bg-surface-soft)]",
              !canEdit ? "opacity-50" : "",
            ].join(" ")}
          >
            í¼ì„¼íŠ¸ (%)
          </button>

          <button
            type="button"
            disabled={!canEdit}
            onClick={() => {
              const nextMode: HomeworkCutlineMode = "COUNT";
              setMode(nextMode);
              setCutlineValue((prev) => clampCutline(prev, nextMode));
            }}
            className={[
              "rounded border px-3 py-2 text-sm",
              mode === "COUNT"
                ? "border-[var(--color-primary)] bg-[var(--bg-surface-soft)] font-semibold text-[var(--color-primary)]"
                : "text-[var(--text-secondary)] hover:bg-[var(--bg-surface-soft)]",
              !canEdit ? "opacity-50" : "",
            ].join(" ")}
          >
            ë¬¸í•­ ìˆ˜
          </button>
        </div>

        <div className="text-xs text-[var(--text-muted)]">
          {helperText}
        </div>
      </div>

      {/* ê°’ ì„¤ì • */}
      <div className="grid grid-cols-2 gap-3">
        <label className="text-sm">
          <div className="mb-1 text-xs font-medium text-[var(--text-secondary)]">
            ì»¤íŠ¸ë¼ì¸ ê°’
          </div>

          <div className="flex items-center gap-2">
            <input
              type="number"
              min={0}
              max={mode === "PERCENT" ? 100 : undefined}
              className="w-full rounded border px-3 py-2 text-sm bg-[var(--bg-app)]"
              value={Number.isFinite(cutlineValue) ? cutlineValue : 0}
              onChange={(e) =>
                setCutlineValue(
                  clampCutline(Number(e.target.value), mode)
                )
              }
              disabled={!canEdit}
            />
            <span className="text-xs text-[var(--text-muted)]">
              {mode === "PERCENT" ? "%" : "ë¬¸í•­"}
            </span>
          </div>
        </label>

        <label className="text-sm">
          <div className="mb-1 text-xs font-medium text-[var(--text-secondary)]">
            ë°˜ì˜¬ë¦¼ ë‹¨ìœ„
          </div>

          <div className="flex items-center gap-2">
            <input
              type="number"
              min={1}
              max={50}
              className="w-full rounded border px-3 py-2 text-sm bg-[var(--bg-app)]"
              value={Number.isFinite(roundUnit) ? roundUnit : 5}
              onChange={(e) =>
                setRoundUnit(Math.max(1, Number(e.target.value)))
              }
              disabled={!canEdit || mode !== "PERCENT"}
            />
            <span className="text-xs text-[var(--text-muted)]">%</span>
          </div>
        </label>
      </div>

      {/* Footer */}
      <div className="flex items-center justify-between pt-2">
        <div className="text-xs text-[var(--text-muted)]">
          â€» íŒì •ì€ ì„œë²„ ê²°ê³¼ë§Œ í‘œì‹œ
        </div>

        <button
          type="button"
          className="btn disabled:opacity-50"
          disabled={!canEdit || !dirty}
          onClick={() => {
            onPatch({
              cutline_mode: mode,
              cutline_value: cutlineValue,
              round_unit_percent: roundUnit,
            });
          }}
        >
          {isPatching ? "ì €ì¥ ì¤‘..." : "ì •ì±… ì €ì¥"}
        </button>
      </div>
    </div>
  );
}


==========================================================================================
# FILE: components/common/HomeworkHeader.tsx
==========================================================================================
// PATH: src/features/homework/components/common/HomeworkHeader.tsx
/**
 * HomeworkHeader
 * - exams/common/ExamHeader UX ë³µì œ
 * - ê³¼ì œ ì ìˆ˜/íŒì •ì€ "ì„¸ì…˜ > ì„±ì "ì—ì„œ ì²˜ë¦¬(ê³ ì • ì•ˆë‚´)
 */

import type { HomeworkSummary } from "../../types";

export default function HomeworkHeader({
  homework,
}: {
  homework: HomeworkSummary;
}) {
  const statusLabel =
    homework.status === "OPEN"
      ? "OPEN"
      : homework.status === "CLOSED"
      ? "CLOSED"
      : "DRAFT";

  return (
    <div className="mb-6 space-y-2">
      <h2 className="text-lg font-semibold text-[var(--text-primary)]">
        {homework.title}
      </h2>

      <div className="text-sm text-[var(--text-secondary)]">
        ìƒíƒœ: <span className="font-medium">{statusLabel}</span>
      </div>

      <div className="text-xs text-[var(--text-muted)]">
        â€» ê³¼ì œì˜ <b>ì„±ì  ì…ë ¥ Â· íŒì •</b>ì€ <b>ì„¸ì…˜ &gt; ì„±ì </b> ë©”ë‰´ì—ì„œ
        ì§„í–‰í•©ë‹ˆë‹¤.
      </div>
    </div>
  );
}


==========================================================================================
# FILE: components/common/HomeworkTabs.tsx
==========================================================================================
// PATH: src/features/homework/components/common/HomeworkTabs.tsx
import type { HomeworkTabKey } from "../../types";

const TABS: { key: HomeworkTabKey; label: string }[] = [
  { key: "setup", label: "ê¸°ë³¸ ì„¤ì •" },
  { key: "assets", label: "ìì‚°" },
  { key: "submissions", label: "ì œì¶œ" },
  { key: "results", label: "ê²°ê³¼ Â· í†µê³„" },
];

export default function HomeworkTabs({
  activeTab,
  onChange,
}: {
  activeTab: HomeworkTabKey;
  onChange: (tab: HomeworkTabKey) => void;
}) {
  return (
    <div className="flex gap-6 border-b border-[var(--border-divider)]">
      {TABS.map((tab) => {
        const isActive = activeTab === tab.key;

        return (
          <button
            key={tab.key}
            type="button"
            onClick={() => onChange(tab.key)}
            className={[
              "pb-2 text-sm border-b-2 transition-colors",
              isActive
                ? "border-[var(--color-primary)] font-semibold text-[var(--text-primary)]"
                : "border-transparent text-[var(--text-secondary)] hover:text-[var(--text-primary)]",
            ].join(" ")}
          >
            {tab.label}
          </button>
        );
      })}
    </div>
  );
}


==========================================================================================
# FILE: hooks/useAdminHomework.ts
==========================================================================================
// PATH: src/features/homework/hooks/useAdminHomework.ts
import { useQuery } from "@tanstack/react-query";
import { fetchAdminHomework } from "../api/adminHomework";

export function useAdminHomework(homeworkId?: number) {
  const id = Number(homeworkId);

  return useQuery({
    queryKey: ["admin-homework", id],
    queryFn: () => fetchAdminHomework(id),
    enabled: Number.isFinite(id) && id > 0,
  });
}


==========================================================================================
# FILE: hooks/useHomeworkAssignments.ts
==========================================================================================
// PATH: src/features/homework/hooks/useHomeworkAssignments.ts
/**
 * useHomeworkAssignments
 * - ê³¼ì œ ëŒ€ìƒ í•™ìƒ(ì„ íƒ ìƒíƒœ í¬í•¨) ë‹¨ì¼ ì§„ì‹¤ query
 */

import { useQuery } from "@tanstack/react-query";
import { QUERY_KEYS } from "../queryKeys";
import { fetchHomeworkAssignments } from "../api/homeworkAssignments";

export function useHomeworkAssignments(homeworkId: number) {
  const hid = Number(homeworkId);
  const enabled = Number.isFinite(hid) && hid > 0;

  return useQuery({
    queryKey: QUERY_KEYS.HOMEWORK_ASSIGNMENTS(hid),
    queryFn: () => fetchHomeworkAssignments(hid),
    enabled,
    // UX: í˜ì´ì§€ ë‹¤ì‹œ ë“¤ì–´ì™”ì„ ë•Œ "0ëª…" ê°™ì€ ê¹œë¹¡ì„ ì¤„ì´ê¸°
    staleTime: 10_000,
  });
}


==========================================================================================
# FILE: hooks/useHomeworkPolicy.ts
==========================================================================================
// PATH: src/features/homework/hooks/useHomeworkPolicy.ts
/**
 * useHomeworkPolicy (FIX: í˜„ types.ts ìŠ¤í™ê³¼ ì¼ì¹˜)
 *
 * âœ… ì±…ì„
 * - sessionId ê¸°ì¤€ policy ì¡°íšŒ
 * - policy PATCH í›„ invalidate
 *
 * ğŸ”’ ê³„ì•½
 * - POST ì—†ìŒ (í”„ë¡ íŠ¸ ìƒì„± ê¸ˆì§€)
 * - passed ê³„ì‚° ì—†ìŒ (ì„œë²„ ë‹¨ì¼ ì§„ì‹¤)
 */

import { useMutation, useQuery, useQueryClient } from "@tanstack/react-query";
import {
  fetchHomeworkPolicyBySession,
  patchHomeworkPolicy,
} from "../api/homeworkPolicy";
import type { HomeworkPolicy } from "../types";

type PatchData = Partial<
  Pick<HomeworkPolicy, "cutline_mode" | "cutline_value" | "round_unit_percent">
>;

export function useHomeworkPolicy(sessionId: number) {
  const qc = useQueryClient();

  const safeSessionId =
    Number.isFinite(sessionId) && sessionId > 0 ? sessionId : 0;

  const q = useQuery({
    queryKey: ["homework-policy", safeSessionId],
    queryFn: () => fetchHomeworkPolicyBySession(safeSessionId),
    enabled: safeSessionId > 0,
  });

  const patchPolicy = useMutation({
    mutationFn: async (payload: { id: number; data: PatchData }) =>
      patchHomeworkPolicy(payload.id, payload.data),
    onSuccess: async () => {
      await qc.invalidateQueries({ queryKey: ["homework-policy", safeSessionId] });
    },
  });

  return {
    ...q,
    patchPolicy,
  };
}


==========================================================================================
# FILE: hooks/useSessionEnrollments.ts
==========================================================================================
// PATH: src/features/homework/hooks/useSessionEnrollments.ts
/**
 * useSessionEnrollments
 * - homework ë„ë©”ì¸ì—ì„œ â€œëŒ€ìƒ í•™ìƒ ëª©ë¡â€ ë‹¨ì¼ ì§„ì‹¤ ì¡°íšŒ
 */

import { useQuery } from "@tanstack/react-query";
import { fetchSessionEnrollments } from "../api/sessionEnrollments";

export function useSessionEnrollments(sessionId: number) {
  return useQuery({
    queryKey: ["homework-session-enrollments", sessionId],
    queryFn: () => fetchSessionEnrollments(sessionId),
    enabled: Number.isFinite(sessionId) && sessionId > 0,
  });
}


==========================================================================================
# FILE: panels/HomeworkAssetsPanel.tsx
==========================================================================================
// PATH: src/features/homework/panels/HomeworkAssetsPanel.tsx
/**
 * HomeworkAssetsPanel
 *
 * âœ… exams/panels/ExamAssetsPanel UX ë³µì œ
 *
 * âš ï¸ Homework asset APIëŠ” ì•„ì§ ë¯¸í™•ì • â†’ UI ìŠ¬ë¡¯ë§Œ ì œê³µ
 */

export default function HomeworkAssetsPanel({
  homeworkId,
}: {
  homeworkId: number;
}) {
  return (
    <div className="space-y-6">
      <section className="rounded border border-[var(--border-divider)] bg-[var(--bg-surface)]">
        <div className="border-b border-[var(--border-divider)] px-4 py-3">
          <div className="text-sm font-semibold text-[var(--text-primary)]">
            ìì‚°
          </div>
          <div className="text-xs text-[var(--text-muted)]">
            ê³¼ì œì— ì—°ê²°ëœ íŒŒì¼/ìë£Œë¥¼ ê´€ë¦¬í•©ë‹ˆë‹¤.
          </div>
        </div>

        <div className="space-y-3 p-4 text-sm text-[var(--text-primary)]">
          <div className="rounded border border-[var(--border-divider)] bg-[var(--bg-surface-soft)] p-3 text-xs text-[var(--text-muted)]">
            âš ï¸ Homework asset APIê°€ ì•„ì§ í™•ì •ë˜ì§€ ì•Šì•„ UI ìŠ¬ë¡¯ë§Œ ì œê³µí•©ë‹ˆë‹¤.
            <div className="mt-2 text-xs">
              ì—°ê²° í›„ë³´:
              <ul className="mt-1 list-disc space-y-1 pl-5">
                <li>GET /homeworks/{`{id}`}/assets/</li>
                <li>POST /homeworks/{`{id}`}/assets/ (multipart)</li>
              </ul>
            </div>
          </div>

          <div className="text-xs text-[var(--text-muted)]">
            homeworkId: {homeworkId}
          </div>

          <button
            type="button"
            className="rounded border border-[var(--border-divider)] px-3 py-2 text-sm hover:bg-[var(--bg-surface-soft)]"
            onClick={() => alert("asset ì—…ë¡œë“œëŠ” API í™•ì • í›„ ì—°ê²°")}
          >
            + ìì‚° ì—…ë¡œë“œ
          </button>
        </div>
      </section>
    </div>
  );
}


==========================================================================================
# FILE: panels/HomeworkResultsPanel.tsx
==========================================================================================
// PATH: src/features/homework/panels/HomeworkResultsPanel.tsx
/**
 * HomeworkResultsPanel
 *
 * ìš”êµ¬ì‚¬í•­:
 * - â€œë¯¸ì œì¶œ í•™ìƒë§Œâ€ ëœ¨ë©´ ë¨
 *
 * âš ï¸ ë‹¨ì¼ ì§„ì‹¤ì´ ì•„ì§ í™•ì •ë˜ì§€ ì•Šì•˜ìœ¼ë¯€ë¡œ UI ìŠ¬ë¡¯ë§Œ ì œê³µ
 */

import { useMemo } from "react";
import { useAdminHomework } from "../hooks/useAdminHomework";

export default function HomeworkResultsPanel({
  homeworkId,
}: {
  homeworkId: number;
}) {
  const { data } = useAdminHomework(homeworkId);

  const sessionId = useMemo(() => {
    const v = Number(data?.session_id);
    return Number.isFinite(v) && v > 0 ? v : 0;
  }, [data?.session_id]);

  return (
    <div className="space-y-6">
      <section className="rounded border border-[var(--border-divider)] bg-[var(--bg-surface)]">
        <div className="border-b border-[var(--border-divider)] px-4 py-3">
          <div className="text-sm font-semibold text-[var(--text-primary)]">
            ê²°ê³¼
          </div>
          <div className="text-xs text-[var(--text-muted)]">
            ì´ íƒ­ì€ <b>ë¯¸ì œì¶œ í•™ìƒ</b>ë§Œ í‘œì‹œí•©ë‹ˆë‹¤.
          </div>
        </div>

        <div className="space-y-2 p-4 text-sm text-[var(--text-primary)]">
          <div className="rounded border border-[var(--border-divider)] bg-[var(--bg-surface-soft)] p-3 text-xs text-[var(--text-muted)]">
            âš ï¸ ë¯¸ì œì¶œ íŒë‹¨ ë°ì´í„° ì†ŒìŠ¤(API)ê°€ ì•„ì§ í™•ì •ë˜ì§€ ì•Šì•„ UI ìŠ¬ë¡¯ë§Œ
            ì œê³µí•©ë‹ˆë‹¤.
          </div>

          <div className="text-xs text-[var(--text-muted)]">
            sessionId: {sessionId || "-"}
          </div>
        </div>
      </section>
    </div>
  );
}


==========================================================================================
# FILE: panels/HomeworkSetupPanel.tsx
==========================================================================================
/**
 * HomeworkSetupPanel
 * - setup íƒ­ í™”ë©´
 * - ì»¤íŠ¸ë¼ì¸(policy) + ê³¼ì œ ëŒ€ìƒì ìš”ì•½
 */

import { useMemo } from "react";
import { useAdminHomework } from "../hooks/useAdminHomework";

import HomeworkPolicyPanel from "./setup/HomeworkPolicyPanel";
import HomeworkEnrollmentPanel from "./setup/HomeworkEnrollmentPanel";

export default function HomeworkSetupPanel({ homeworkId }: { homeworkId: number }) {
  const { data } = useAdminHomework(homeworkId);

  const sessionId = useMemo(() => {
    const v = Number(data?.session_id);
    return Number.isFinite(v) && v > 0 ? v : 0;
  }, [data?.session_id]);

  return (
    <div className="space-y-6">
      <HomeworkPolicyPanel sessionId={sessionId} />
      <HomeworkEnrollmentPanel homeworkId={homeworkId} />

      <section className="rounded border border-[var(--border-divider)] bg-[var(--bg-surface-soft)] p-4 text-sm text-[var(--text-secondary)]">
        â„¹ï¸ ê³¼ì œ ì ìˆ˜ ì…ë ¥Â·íŒì •ì€ <b>ì„¸ì…˜ &gt; ì„±ì </b> ë©”ë‰´ì—ì„œ ì§„í–‰í•©ë‹ˆë‹¤.
      </section>
    </div>
  );
}


==========================================================================================
# FILE: panels/HomeworkSubmissionsPanel.tsx
==========================================================================================
// PATH: src/features/homework/panels/HomeworkSubmissionsPanel.tsx
/**
 * HomeworkSubmissionsPanel
 *
 * âœ… ì˜ë„
 * - ì‹ ê·œ ì œì¶œ ì‹œìŠ¤í…œ ë§Œë“¤ì§€ ì•ŠìŒ
 * - submissions ë„ë©”ì¸ ì¬ì‚¬ìš© ì „ì œ
 *
 * âš ï¸ í˜„ì¬ëŠ” API ìŠ¤í™ ë¯¸í™•ì • â†’ UI ìŠ¬ë¡¯ë§Œ ì œê³µ
 */

import { useMemo } from "react";
import { useAdminHomework } from "../hooks/useAdminHomework";

export default function HomeworkSubmissionsPanel({
  homeworkId,
}: {
  homeworkId: number;
}) {
  const { data } = useAdminHomework(homeworkId);

  const sessionId = useMemo(() => {
    const v = Number(data?.session_id);
    return Number.isFinite(v) && v > 0 ? v : 0;
  }, [data?.session_id]);

  return (
    <div className="space-y-6">
      <section className="rounded border border-[var(--border-divider)] bg-[var(--bg-surface)]">
        <div className="border-b border-[var(--border-divider)] px-4 py-3">
          <div className="text-sm font-semibold text-[var(--text-primary)]">
            ì œì¶œ
          </div>
          <div className="text-xs text-[var(--text-muted)]">
            ì˜¨ë¼ì¸ ê³¼ì œ ì œì¶œì€ <b>submissions</b> ë„ë©”ì¸ì„ ì¬ì‚¬ìš©í•©ë‹ˆë‹¤.
          </div>
        </div>

        <div className="space-y-2 p-4 text-sm text-[var(--text-primary)]">
          <div className="rounded border border-[var(--border-divider)] bg-[var(--bg-surface-soft)] p-3 text-xs text-[var(--text-muted)]">
            âœ… ì—¬ê¸°ëŠ” ì•„ë˜ ì¤‘ í•˜ë‚˜ë¡œ ì—°ê²°í•˜ë©´ ë©ë‹ˆë‹¤.
            <ul className="mt-2 list-disc space-y-1 pl-5">
              <li>ê¸°ì¡´ Submission ì—…ë¡œë“œ/ë“±ë¡ ì»´í¬ë„ŒíŠ¸ ì¬ì‚¬ìš©</li>
              <li>
                submissions APIì— homework target_type ì§€ì› ì‹œ
                ëª©ë¡/ì—…ë¡œë“œ UI ì œê³µ
              </li>
            </ul>
          </div>

          <div className="text-xs text-[var(--text-muted)]">
            sessionId: {sessionId || "-"}
          </div>
        </div>
      </section>

      <section className="rounded border border-[var(--border-divider)] bg-[var(--bg-surface-soft)] p-4 text-sm text-[var(--text-muted)]">
        â„¹ï¸ ì´ íƒ­ì€ â€œì œì¶œ ì›ë³¸ ê´€ë¦¬â€ ëª©ì ì´ë©°, ì ìˆ˜/íŒì •ì€ ì„±ì íƒ­ì—ì„œ
        í•©ë‹ˆë‹¤.
      </section>
    </div>
  );
}


==========================================================================================
# FILE: panels/setup/HomeworkEnrollmentPanel.tsx
==========================================================================================
// PATH: src/features/homework/panels/setup/HomeworkEnrollmentPanel.tsx
/**
 * HomeworkEnrollmentPanel âœ… FINAL (0ëª… ë¬¸ì œ ì¢…ê²°íŒ)
 *
 * ê·œì¹™(ëŒ€ê¸°ì—… ê¸°ì¤€):
 * - "ì„ íƒë¨ Nëª…" ìš”ì•½ì€ í•­ìƒ ì„œë²„ ë‹¨ì¼ ì§„ì‹¤(query)ë¡œ í‘œì‹œ
 * - ëª¨ë‹¬ì€ í¸ì§‘ìš© ì„ì‹œ stateë§Œ ì‚¬ìš©
 * - ì €ì¥ ì„±ê³µ ì‹œì—ë§Œ invalidate (ë‹«ê¸°/ì·¨ì†Œ ì‹œ invalidate ê¸ˆì§€)
 * - ëª¨ë‹¬ open ì‹œ refetchë¡œ ìµœì‹  í¸ì§‘ ì‹œì‘
 */

import { useEffect, useMemo, useState } from "react";
import { useMutation, useQueryClient } from "@tanstack/react-query";

import HomeworkEnrollmentManageModal from "@/features/homework/components/HomeworkEnrollmentManageModal";
import type { EnrollmentRow } from "@/features/sessions/components/enrollment/types";

import { QUERY_KEYS } from "@/features/homework/queryKeys";
import { useAdminHomework } from "@/features/homework/hooks/useAdminHomework";
import { useHomeworkAssignments } from "@/features/homework/hooks/useHomeworkAssignments";
import {
  putHomeworkAssignments,
  type HomeworkAssignmentsResponse,
} from "@/features/homework/api/homeworkAssignments";

export default function HomeworkEnrollmentPanel({
  homeworkId,
}: {
  homeworkId: number;
}) {
  const qc = useQueryClient();
  const hid = Number(homeworkId);
  const hasHomework = Number.isFinite(hid) && hid > 0;

  const { data: homework } = useAdminHomework(hid);
  const sessionId = Number(homework?.session_id ?? 0);

  // âœ… ë‹¨ì¼ ì§„ì‹¤ query (ìš”ì•½ í‘œì‹œìš©)
  const {
    data: assignments,
    isLoading: loadingAssignments,
    isError: isAssignmentsError,
    refetch: refetchAssignments,
  } = useHomeworkAssignments(hid);

  // ----------------------------
  // modal local editing states
  // ----------------------------
  const [open, setOpen] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const [rows, setRows] = useState<EnrollmentRow[]>([]);
  const [selectedIds, setSelectedIds] = useState<Set<number>>(new Set());
  const [originSelectedIds, setOriginSelectedIds] = useState<Set<number>>(
    new Set()
  );

  const selectedCount = useMemo(() => {
    // âœ… ìš”ì•½ì€ ë‹¨ì¼ ì§„ì‹¤
    return assignments?.selected_ids?.length ?? 0;
  }, [assignments?.selected_ids]);

  const hydrateLocalFromQuery = (q: HomeworkAssignmentsResponse | undefined) => {
    const items = q?.items ?? [];
    const normalizedRows: EnrollmentRow[] = items.map((x) => ({
      enrollment_id: x.enrollment_id,
      student_name: x.student_name,
    }));
    const initSelected = new Set<number>(q?.selected_ids ?? []);
    setRows(normalizedRows);
    setSelectedIds(new Set(initSelected));
    setOriginSelectedIds(new Set(initSelected));
  };

  // ëª¨ë‹¬ ì—´ ë•Œ ìµœì‹  ë°ì´í„°ë¡œ í¸ì§‘ ì‹œì‘
  useEffect(() => {
    if (!open) return;

    let cancelled = false;
    setError(null);

    // 1) ìµœì‹ í™”
    Promise.resolve(refetchAssignments())
      .then((res) => {
        if (cancelled) return;
        hydrateLocalFromQuery(res.data);
      })
      .catch(() => {
        if (cancelled) return;
        // refetch ì‹¤íŒ¨í•´ë„ ê¸°ì¡´ ìºì‹œë¡œë¼ë„ í¸ì§‘ ì‹œì‘
        hydrateLocalFromQuery(assignments);
      });

    return () => {
      cancelled = true;
    };
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [open]);

  // ----------------------------
  // dirty ê³„ì‚° (ëª¨ë‹¬ ë‚´ë¶€ ë‹¨ì¼ ì§„ì‹¤)
  // ----------------------------
  const dirty = useMemo(() => {
    if (selectedIds.size !== originSelectedIds.size) return true;
    for (const id of selectedIds) {
      if (!originSelectedIds.has(id)) return true;
    }
    return false;
  }, [selectedIds, originSelectedIds]);

  const toggleOne = (id: number) => {
    setSelectedIds((prev) => {
      const next = new Set(prev);
      next.has(id) ? next.delete(id) : next.add(id);
      return next;
    });
  };

  // ----------------------------
  // SAVE (ì„±ê³µ ì‹œì—ë§Œ invalidate)
  // ----------------------------
  const saveMut = useMutation({
    mutationFn: async () => {
      setError(null);
      await putHomeworkAssignments({
        homeworkId: hid,
        enrollment_ids: Array.from(selectedIds),
      });
    },
    onSuccess: async () => {
      // âœ… í¸ì§‘ ìƒíƒœ í™•ì •
      setOriginSelectedIds(new Set(selectedIds));
      setOpen(false);

      // âœ… ë‹¨ì¼ ì§„ì‹¤ ë™ê¸°í™” (ì €ì¥ ì„±ê³µ ì‹œë§Œ)
      await qc.invalidateQueries({
        queryKey: QUERY_KEYS.HOMEWORK_ASSIGNMENTS(hid),
      });

      if (Number.isFinite(sessionId) && sessionId > 0) {
        await qc.invalidateQueries({
          queryKey: QUERY_KEYS.SESSION_SCORES(sessionId),
        });

        await qc.invalidateQueries({
          queryKey: QUERY_KEYS.HOMEWORK_SESSION_ENROLLMENTS(sessionId),
        });
      }
    },
    onError: (e: any) => {
      setError(e?.response?.data?.detail || "ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
    },
  });

  return (
    <section className="rounded border border-[var(--border-divider)] bg-[var(--bg-surface)]">
      <div className="border-b border-[var(--border-divider)] px-4 py-3">
        <div className="text-sm font-semibold text-[var(--text-primary)]">
          ê³¼ì œ ëŒ€ìƒ í•™ìƒ
        </div>
        <div className="text-xs text-[var(--text-muted)]">
          ì´ ê³¼ì œì— í¬í•¨ë  í•™ìƒì„ ì„ íƒí•©ë‹ˆë‹¤.
        </div>
      </div>

      <div className="space-y-3 p-4">
        {!hasHomework && (
          <div className="rounded border bg-[var(--bg-surface-soft)] p-3 text-sm text-[var(--text-muted)]">
            âš ï¸ homeworkIdê°€ ì—†ì–´ ëŒ€ìƒìë¥¼ ê´€ë¦¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
          </div>
        )}

        {hasHomework && (
          <>
            <div className="flex items-center justify-between rounded border bg-[var(--bg-surface-soft)] px-3 py-2">
              <div className="text-sm text-[var(--text-primary)]">
                ì„ íƒë¨{" "}
                <span className="font-semibold">
                  {loadingAssignments ? "..." : selectedCount}
                </span>
                ëª…
                {isAssignmentsError && (
                  <span className="ml-2 text-xs text-[var(--color-danger)]">
                    (ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨)
                  </span>
                )}
              </div>
              <div className="text-xs text-[var(--text-muted)]">homework #{hid}</div>
            </div>

            <button
              type="button"
              className="rounded border border-[var(--border-divider)] px-3 py-2 text-sm hover:bg-[var(--bg-surface-soft)]"
              onClick={() => setOpen(true)}
            >
              ëŒ€ìƒì ëª©ë¡ ë³´ê¸° / ê´€ë¦¬
            </button>
          </>
        )}
      </div>

      <HomeworkEnrollmentManageModal
        open={open}
        onClose={() => setOpen(false)}
        title="ê³¼ì œ ëŒ€ìƒ í•™ìƒ ê´€ë¦¬"
        description="ì´ ê³¼ì œì— í¬í•¨í•  í•™ìƒì„ ì„ íƒ í›„ ì €ì¥í•˜ì„¸ìš”."
        rows={rows}
        loading={saveMut.isPending ? false : false /* ëª¨ë‹¬ ë‚´ë¶€ ë¡œë”©ì€ refetchë¡œ ì²˜ë¦¬ */}
        error={error}
        selectedIds={selectedIds}
        onToggle={toggleOne}
        onSetSelectedIds={setSelectedIds}
        onSave={() => {
          if (saveMut.isPending) return;
          if (!dirty) return;
          saveMut.mutate();
        }}
        saving={saveMut.isPending}
        dirty={dirty}
      />
    </section>
  );
}


==========================================================================================
# FILE: panels/setup/HomeworkPolicyPanel.tsx
==========================================================================================
// PATH: src/features/homework/panels/setup/HomeworkPolicyPanel.tsx
/**
 * HomeworkPolicyPanel
 * - exams/setup/ExamPolicyPanel UX ë³µì œ
 * - Wrapper ì¹´ë“œ(ê³¼ì œ ì„¤ì •)ë§Œ ë‹´ë‹¹
 */

import { useMemo } from "react";
import { useMutation, useQueryClient } from "@tanstack/react-query";

import { useHomeworkPolicy } from "../../hooks/useHomeworkPolicy";
import { patchHomeworkPolicy } from "../../api/homeworkPolicy";
import HomeworkPolicyCard from "../../components/HomeworkPolicyCard";
import type { HomeworkPolicy } from "../../types";

export default function HomeworkPolicyPanel({ sessionId }: { sessionId: number }) {
  const qc = useQueryClient();

  const safeSessionId = useMemo(() => {
    const v = Number(sessionId);
    return Number.isFinite(v) && v > 0 ? v : 0;
  }, [sessionId]);

  const { data: policy, isLoading, isError } = useHomeworkPolicy(safeSessionId);

  const updateMut = useMutation({
    mutationFn: (payload: {
      id: number;
      data: Partial<
        Pick<HomeworkPolicy, "cutline_mode" | "cutline_value" | "round_unit_percent">
      >;
    }) => patchHomeworkPolicy(payload.id, payload.data),
    onSuccess: async () => {
      await qc.invalidateQueries({ queryKey: ["homework-policy", safeSessionId] });
      alert("ê³¼ì œ ì •ì±…ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
    },
    onError: (e: any) => {
      alert(e?.response?.data?.detail || "ê³¼ì œ ì •ì±… ì €ì¥ ì‹¤íŒ¨");
    },
  });

  return (
    <section className="space-y-3">
      <div className="rounded border bg-[var(--bg-surface)]">
        <div className="border-b px-4 py-3">
          <div className="text-sm font-semibold text-[var(--text-primary)]">
            ê³¼ì œ ì„¤ì •
          </div>
          <div className="text-xs text-[var(--text-muted)]">
            ì»¤íŠ¸ë¼ì¸ ê¸°ì¤€(%/ë¬¸í•­ ìˆ˜) Â· ë°˜ì˜¬ë¦¼ ë‹¨ìœ„ ì„¤ì •
          </div>
        </div>

        <div className="p-4 space-y-3">
          {!safeSessionId && (
            <div className="rounded border bg-[var(--bg-surface-soft)] p-3 text-sm text-[var(--text-muted)]">
              âš ï¸ sessionIdê°€ ì—†ì–´ ê³¼ì œ ì •ì±…ì„ ì¡°íšŒí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
            </div>
          )}

          {safeSessionId > 0 && isLoading && (
            <div className="text-sm text-[var(--text-muted)]">ì •ì±… ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
          )}

          {safeSessionId > 0 && isError && (
            <div className="text-sm text-red-600">ì •ì±… ì¡°íšŒ ì‹¤íŒ¨</div>
          )}

          {safeSessionId > 0 && !isLoading && !isError && (
            <HomeworkPolicyCard
              policy={policy ?? null}
              isPatching={updateMut.isPending}
              onPatch={(data) => {
                if (!policy) return;
                updateMut.mutate({ id: policy.id, data });
              }}
            />
          )}
        </div>
      </div>
    </section>
  );
}
