====================================================================================================
# FRONTEND FOLDER: features__community
# ROOT PATH: C:\academyfront\src\features\community
====================================================================================================


==========================================================================================
# FILE: RedirectToCommunity.tsx
==========================================================================================
// PATH: src/features/community/RedirectToCommunity.tsx
// ê°•ì˜ ë‚´ ìë£Œì‹¤/ê²Œì‹œíŒì—ì„œ í†µí•© ì½˜ì†”ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸

import { Navigate, useParams } from "react-router-dom";

export function RedirectToCommunityMaterials() {
  const { lectureId } = useParams<{ lectureId: string }>();
  const id = lectureId != null && Number.isFinite(Number(lectureId)) ? lectureId : "";
  if (!id) return <Navigate to="/admin/community/materials" replace />;
  return <Navigate to={`/admin/community/materials?scope=lecture&lectureId=${id}`} replace />;
}

export function RedirectToCommunityNotice() {
  const { lectureId } = useParams<{ lectureId: string }>();
  const id = lectureId != null && Number.isFinite(Number(lectureId)) ? lectureId : "";
  if (!id) return <Navigate to="/admin/community/admin?tab=notice" replace />;
  return <Navigate to={`/admin/community/admin?tab=notice&scope=lecture&lectureId=${id}`} replace />;
}


==========================================================================================
# FILE: community_code.html
==========================================================================================
<!doctype html>
<html lang="ko">
<meta charset="utf-8">
<title>community</title>
<style>
body{background:#0f1115;color:#eaeaea;font-family:Consolas,monospace;padding:24px}
h2{color:#7dd3fc;font-size:14px}
pre{background:#111418;padding:16px;border-radius:8px;overflow-x:auto;font-size:13px}
section{margin-bottom:28px}
</style>
<h1>ğŸ“¦ community</h1>

<section>
<h2>components\BoardTabs.tsx</h2>
<pre><code>// src/features/community/components/BoardTabs.tsx
import { NavLink } from &quot;react-router-dom&quot;;

export default function BoardTabs() {
  const base = &quot;/community&quot;;

  const tabClass = ({ isActive }: any) =&gt;
    `px-3 py-2 text-sm font-medium border-b-2 ${
      isActive 
        ? &quot;border-blue-600 text-blue-600&quot;
        : &quot;border-transparent text-gray-600 hover:text-gray-800&quot;
    }`;

  return (
    &lt;div className=&quot;flex gap-6 border-b mb-6&quot;&gt;
      &lt;NavLink to={`${base}/notice`} className={tabClass}&gt;ê³µì§€ì‚¬í•­&lt;/NavLink&gt;
      &lt;NavLink to={`${base}/qna`} className={tabClass}&gt;QnA&lt;/NavLink&gt;
      &lt;NavLink to={`${base}/review`} className={tabClass}&gt;ìˆ˜ê°•í›„ê¸°&lt;/NavLink&gt;
    &lt;/div&gt;
  );
}
</code></pre>
</section>

<section>
<h2>pages\CommunityPage.tsx</h2>
<pre><code>// src/features/community/pages/CommunityPage.tsx
import PageContainer from &quot;@student/shared/components/Page&quot;;
import PageHeader from &quot;@/shared/ui/dsHeader&quot;;
import BoardTabs from &quot;../components/BoardTabs&quot;;
import { Outlet } from &quot;react-router-dom&quot;;

export default function CommunityPage() {
  return (
    &lt;PageContainer&gt;
      &lt;PageHeader title=&quot;ì»¤ë®¤ë‹ˆí‹°&quot; /&gt;

      &lt;BoardTabs /&gt;

      &lt;Outlet /&gt;
    &lt;/PageContainer&gt;
  );
}
</code></pre>
</section>

<section>
<h2>pages\NoticeBoardPage.tsx</h2>
<pre><code>export default function NoticeBoardPage() {
  return (
    &lt;div&gt;

      &lt;p className=&quot;text-gray-500&quot;&gt;ì•„ì§ ë“±ë¡ëœ ê³µì§€ê°€ ì—†ìŠµë‹ˆë‹¤.&lt;/p&gt;
    &lt;/div&gt;
  );
}
</code></pre>
</section>

<section>
<h2>pages\QnaBoardPage.tsx</h2>
<pre><code>import BoardTabs from &quot;../components/BoardTabs&quot;;

export default function QnaBoardPage() {
  return (
    &lt;div className=&quot;p-6&quot;&gt;

      {/* ê²€ìƒ‰ &amp; í•„í„° */}
      &lt;div className=&quot;flex items-center gap-2 mb-4&quot;&gt;
        &lt;select className=&quot;border rounded px-2 py-1 text-sm&quot;&gt;
          &lt;option&gt;ì „ì²´&lt;/option&gt;
          &lt;option&gt;ë‹µë³€ í•„ìš”&lt;/option&gt;
        &lt;/select&gt;

        &lt;input
          className=&quot;border rounded px-2 py-1 text-sm flex-1&quot;
          placeholder=&quot;ê²€ìƒ‰&quot;
        /&gt;

        &lt;button className=&quot;px-3 py-1.5 bg-blue-600 text-white rounded text-sm&quot;&gt;
          ê²€ìƒ‰
        &lt;/button&gt;
      &lt;/div&gt;

      {/* ë¦¬ìŠ¤íŠ¸ */}
      &lt;div className=&quot;border rounded p-4 text-sm text-gray-700 mb-3&quot;&gt;
        &lt;div className=&quot;font-semibold&quot;&gt;ì˜ˆì‹œ QnA ì œëª©&lt;/div&gt;
        &lt;div className=&quot;text-gray-500 text-xs&quot;&gt;ì‘ì„±ì Â· ë‚ ì§œ&lt;/div&gt;
      &lt;/div&gt;

      &lt;div className=&quot;text-center mt-6 text-gray-400 text-sm&quot;&gt;1&lt;/div&gt;
    &lt;/div&gt;
  );
}
</code></pre>
</section>

<section>
<h2>pages\ReviewBoardPage.tsx</h2>
<pre><code>import BoardTabs from &quot;../components/BoardTabs&quot;;

export default function ReviewBoardPage() {
  return (
    &lt;div className=&quot;p-6&quot;&gt;

      &lt;div className=&quot;mt-6 text-gray-500 text-sm&quot;&gt;
        ì•„ì§ ë“±ë¡ëœ í›„ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤.
      &lt;/div&gt;
    &lt;/div&gt;
  );
}
</code></pre>
</section>

</html>


==========================================================================================
# FILE: api/community.api.ts
==========================================================================================
// PATH: src/features/community/api/community.api.ts
// Community SSOT API â€” scope-nodes, block-types, posts (ê³µì§€/ì§ˆì˜ ë“±)
// baseURLì´ /api/v1 ì´ë¯€ë¡œ PREFIX = "/community" â†’ /api/v1/community

import api from "@/shared/api/axios";

const PREFIX = "/community";

export type CommunityScope = "all" | "lecture" | "session";

export interface CommunityScopeParams {
  scope: CommunityScope;
  lectureId?: number | null;
  sessionId?: number | null;
}

// ----------------------------------------
// ì‹ ê·œ íƒ€ì… (ë°±ì—”ë“œ community SSOT)
// ----------------------------------------
export interface BlockType {
  id: number;
  code: string;
  label: string;
  order: number;
}

export interface ScopeNodeMinimal {
  id: number;
  level: "COURSE" | "SESSION";
  lecture: number;
  session: number | null;
  lecture_title: string;
  session_title: string | null;
}

export interface PostMappingItem {
  id: number;
  post: number;
  node: number;
  node_detail: ScopeNodeMinimal;
  created_at: string;
}

export interface PostEntity {
  id: number;
  tenant?: number;
  block_type: number;
  block_type_label: string;
  title: string;
  content: string;
  created_by: number | null;
  created_at: string;
  updated_at?: string;
  replies_count?: number;
  mappings: PostMappingItem[];
}

// ----------------------------------------
// Scope nodes (ê°•ì˜/ì°¨ì‹œ íŠ¸ë¦¬ â†’ node_id ë„ì¶œìš©)
// ----------------------------------------
export async function fetchScopeNodes(): Promise<ScopeNodeMinimal[]> {
  const res = await api.get(`${PREFIX}/scope-nodes/`);
  return Array.isArray(res.data) ? res.data : [];
}

/** scope + lectureId/sessionIdì— í•´ë‹¹í•˜ëŠ” ë‹¨ì¼ node_id. ì—†ìœ¼ë©´ null */
export function resolveNodeIdFromScope(
  nodes: ScopeNodeMinimal[],
  params: CommunityScopeParams
): number | null {
  if (params.scope === "all") return null; // ì „ì²´ ëª©ë¡ì€ node_id ì—†ì´ ì¡°íšŒ
  if (params.scope === "lecture" && params.lectureId != null) {
    const n = nodes.find((x) => x.lecture === params.lectureId && x.session == null);
    return n?.id ?? null;
  }
  if (params.scope === "session" && params.lectureId != null && params.sessionId != null) {
    const n = nodes.find(
      (x) => x.lecture === params.lectureId && x.session === params.sessionId
    );
    return n?.id ?? null;
  }
  return null;
}

// ----------------------------------------
// Block types (ì»¤ìŠ¤í…€ ìœ í˜• ìƒì„±/ìˆ˜ì •/ì‚­ì œ)
// ----------------------------------------
export async function fetchBlockTypes(): Promise<BlockType[]> {
  const res = await api.get(`${PREFIX}/block-types/`);
  const data = res?.data;
  // DRF PageNumberPagination: { results: [...], count, next, previous }
  if (data != null && Array.isArray((data as { results?: BlockType[] }).results)) {
    return (data as { results: BlockType[] }).results;
  }
  return Array.isArray(data) ? data : [];
}

export async function createBlockType(data: {
  label: string;
  code?: string;
  order?: number;
}): Promise<BlockType> {
  const res = await api.post(`${PREFIX}/block-types/`, data);
  return res.data as BlockType;
}

export async function updateBlockType(
  id: number,
  data: { label?: string; code?: string; order?: number }
): Promise<BlockType> {
  const res = await api.patch(`${PREFIX}/block-types/${id}/`, data);
  return res.data as BlockType;
}

export async function deleteBlockType(id: number): Promise<void> {
  await api.delete(`${PREFIX}/block-types/${id}/`);
}

// ----------------------------------------
// Post templates (ì–‘ì‹ ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸°)
// ----------------------------------------
export interface PostTemplate {
  id: number;
  name: string;
  block_type: number | null;
  block_type_label: string | null;
  title: string;
  content: string;
  order: number;
  created_at: string;
  updated_at: string;
}

export async function fetchPostTemplates(): Promise<PostTemplate[]> {
  const res = await api.get(`${PREFIX}/post-templates/`);
  return Array.isArray(res.data) ? res.data : [];
}

export async function createPostTemplate(data: {
  name: string;
  block_type?: number | null;
  title?: string;
  content?: string;
  order?: number;
}): Promise<PostTemplate> {
  const res = await api.post(`${PREFIX}/post-templates/`, data);
  return res.data as PostTemplate;
}

export async function updatePostTemplate(
  id: number,
  data: { name?: string; block_type?: number | null; title?: string; content?: string; order?: number }
): Promise<PostTemplate> {
  const res = await api.patch(`${PREFIX}/post-templates/${id}/`, data);
  return res.data as PostTemplate;
}

export async function deletePostTemplate(id: number): Promise<void> {
  await api.delete(`${PREFIX}/post-templates/${id}/`);
}

// ----------------------------------------
// Posts (ê³µì§€/ì§ˆì˜ ë“±)
// ----------------------------------------
/** node_id ìˆìœ¼ë©´ í•´ë‹¹ ë…¸ë“œ(ë° ìƒì†) ê²Œì‹œë¬¼, ì—†ìœ¼ë©´ tenant ì „ì²´. DRF í˜ì´ì§€ë„¤ì´ì…˜(results) ì§€ì› */
export async function fetchPosts(params: { nodeId?: number | null }): Promise<PostEntity[]> {
  const url = params.nodeId != null
    ? `${PREFIX}/posts/?node_id=${params.nodeId}`
    : `${PREFIX}/posts/`;
  const res = await api.get(url);
  const data = res.data as PostEntity[] | { results?: PostEntity[] };
  if (data != null && Array.isArray((data as { results?: PostEntity[] }).results)) {
    return (data as { results: PostEntity[] }).results;
  }
  return Array.isArray(data) ? data : [];
}

/** ê²Œì‹œë¬¼ ë‹¨ê±´ ì¡°íšŒ (í•™ìƒì•± ìƒì„¸ ë“±) */
export async function fetchPost(id: number): Promise<PostEntity | null> {
  try {
    const res = await api.get(`${PREFIX}/posts/${id}/`);
    return res.data as PostEntity;
  } catch {
    return null;
  }
}

/** ê´€ë¦¬ì ëª©ë¡: block_type_id, lecture_id, page, page_size */
export async function fetchAdminPosts(params: {
  blockTypeId?: number | null;
  lectureId?: number | null;
  page?: number;
  pageSize?: number;
}): Promise<{ results: PostEntity[]; count: number }> {
  const res = await api.get(`${PREFIX}/admin/posts/`, {
    params: {
      block_type_id: params.blockTypeId ?? undefined,
      lecture_id: params.lectureId ?? undefined,
      page: params.page ?? 1,
      page_size: params.pageSize ?? 20,
    },
  });
  const data = res.data as { results?: PostEntity[]; count?: number };
  return {
    results: Array.isArray(data.results) ? data.results : [],
    count: typeof data.count === "number" ? data.count : 0,
  };
}

export async function createPost(data: {
  block_type: number;
  title: string;
  content: string;
  created_by?: number | null;
  node_ids: number[];
}): Promise<PostEntity> {
  const res = await api.post(`${PREFIX}/posts/`, data);
  return res.data as PostEntity;
}

export async function updatePostNodes(postId: number, nodeIds: number[]): Promise<PostEntity> {
  const res = await api.patch(`${PREFIX}/posts/${postId}/nodes/`, { node_ids: nodeIds });
  return res.data as PostEntity;
}

// ----------------------------------------
// í•˜ìœ„ í˜¸í™˜ìš© ë³„ì¹­ (ê¸°ì¡´ í˜ì´ì§€ ì ì§„ ì „í™˜)
// ----------------------------------------
/** @deprecated use BlockType */
export type BoardCategory = BlockType & { name?: string };

/** @deprecated use PostEntity; í•„ë“œ ë§¤í•‘ë§Œ ì œê³µ */
export interface BoardPost {
  id: number;
  tenant: number | null;
  lecture: number | null;
  session: number | null;
  category: number;
  title: string;
  content: string;
  created_by: number | null;
  created_at: string;
  attachments: { id: number; post: number; file: string }[];
  lecture_title?: string;
  category_name?: string;
}

function postEntityToBoardPost(p: PostEntity): BoardPost {
  const firstNode = p.mappings?.[0]?.node_detail;
  return {
    id: p.id,
    tenant: p.tenant ?? null,
    lecture: firstNode?.lecture ?? null,
    session: firstNode?.session ?? null,
    category: p.block_type,
    title: p.title,
    content: p.content,
    created_by: p.created_by ?? null,
    created_at: p.created_at,
    attachments: [],
    lecture_title: firstNode?.lecture_title,
    category_name: p.block_type_label,
  };
}

/** scope/lecture/sessionì— ë§ëŠ” node_idë¡œ ëª©ë¡ ì¡°íšŒ í›„ BoardPost[] í˜•íƒœë¡œ ë°˜í™˜ (ë ˆê±°ì‹œ í˜¸í™˜) */
export async function fetchCommunityBoardPosts(
  params: CommunityScopeParams & { categoryId?: number | null }
): Promise<BoardPost[]> {
  const nodes = await fetchScopeNodes();
  const nodeId = resolveNodeIdFromScope(nodes, params);
  const list = await fetchPosts({ nodeId: nodeId ?? undefined });
  const filtered =
    params.categoryId != null
      ? list.filter((p) => p.block_type === params.categoryId)
      : list;
  return filtered.map(postEntityToBoardPost);
}

/** block-typesë¥¼ ì¹´í…Œê³ ë¦¬ í˜•íƒœë¡œ ë°˜í™˜ (ë ˆê±°ì‹œ í˜¸í™˜) */
export async function fetchCommunityBoardCategories(
  _params: CommunityScopeParams
): Promise<BoardCategory[]> {
  const list = await fetchBlockTypes();
  return list.map((b) => ({
    ...b,
    name: b.label,
    tenant: null,
    lecture: null,
  }));
}

/** block-typesëŠ” ì½ê¸° ì „ìš©. ë ˆê±°ì‹œ í˜¸ì¶œ ì‹œ no-op ë˜ëŠ” ì—ëŸ¬ ë°©ì§€ìš© */
export async function createCommunityBoardCategory(_data: {
  scope: CommunityScope;
  lectureId?: number | null;
  name: string;
  order?: number;
}): Promise<BoardCategory> {
  throw new Error("block-typesëŠ” ì½ê¸° ì „ìš©ì…ë‹ˆë‹¤. ê´€ë¦¬ì ì„¤ì •ì„ ì‚¬ìš©í•˜ì„¸ìš”.");
}

/** JSON ê¸°ë°˜ ìƒì„± (FormData ëŒ€ì²´) */
export async function createCommunityBoardPost(data: {
  block_type: number;
  title: string;
  content: string;
  node_ids: number[];
}): Promise<BoardPost> {
  const post = await createPost({
    block_type: data.block_type,
    title: data.title,
    content: data.content,
    node_ids: data.node_ids,
  });
  return postEntityToBoardPost(post);
}

// ----------------------------------------
// QnA (block_type qnaì¸ Post)
// ----------------------------------------
export interface Question {
  id: number;
  enrollment?: number;
  title: string;
  content: string;
  created_at: string;
  is_answered?: boolean;
  student_name?: string;
  lecture_id?: number;
  lecture_title?: string;
}

function postEntityToQuestion(p: PostEntity): Omit<Question, "is_answered"> {
  const firstNode = p.mappings?.[0]?.node_detail;
  return {
    id: p.id,
    title: p.title,
    content: p.content,
    created_at: p.created_at,
    lecture_id: firstNode?.lecture,
    lecture_title: firstNode?.lecture_title,
  };
}

/** ë¸”ë¡íƒ€ì… codeê°€ "qna"ì¸ id ë°˜í™˜ (ì„ ìƒ/í•™ìƒ ì•± ê³µí†µ). ì—†ìœ¼ë©´ null */
export async function getQnaBlockTypeId(): Promise<number | null> {
  const types = await fetchBlockTypes();
  const qna = types.find((t) => (t.code || "").toLowerCase() === "qna");
  return qna?.id ?? null;
}

/** QNA ë¸”ë¡íƒ€ì…ë§Œ í•„í„°í•œ ì§ˆë¬¸ ëª©ë¡ (code "qna" ê¸°ì¤€ â€” ì„ ìƒ ì•±ê³¼ ë™ì¼) */
export async function fetchCommunityQuestions(
  params?: CommunityScopeParams | null
): Promise<Question[]> {
  const qnaBlockTypeId = await getQnaBlockTypeId();
  const toQuestion = (p: PostEntity): Question => ({
    ...postEntityToQuestion(p),
    is_answered: (p.replies_count ?? 0) > 0,
  });

  const isQnaPost = (p: PostEntity) =>
    qnaBlockTypeId != null ? p.block_type === qnaBlockTypeId : (p.block_type_label || "").toLowerCase().includes("qna");

  if (!params) {
    const { results } = await fetchAdminPosts({
      blockTypeId: qnaBlockTypeId ?? undefined,
      pageSize: 500,
    });
    const filtered = qnaBlockTypeId != null ? results : results.filter(isQnaPost);
    return filtered.map(toQuestion);
  }
  const nodes = await fetchScopeNodes();
  const nodeId = resolveNodeIdFromScope(nodes, params);
  const list = await fetchPosts({ nodeId: nodeId ?? undefined });
  const qnaOnly = list.filter(isQnaPost);
  return qnaOnly.map(toQuestion);
}

export interface Answer {
  id: number;
  question: number;
  content: string;
  created_at: string;
}

/**
 * ê²Œì‹œë¬¼ì˜ ë‹µë³€ ëª©ë¡ ì¡°íšŒ
 */
export async function fetchPostReplies(postId: number): Promise<Answer[]> {
  try {
    const res = await api.get(`${PREFIX}/posts/${postId}/replies/`);
    return Array.isArray(res.data) ? res.data : [];
  } catch (error) {
    console.error("ë‹µë³€ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨:", error);
    return [];
  }
}

/** ì§ˆë¬¸ì˜ ì²« ë²ˆì§¸ ë‹µë³€ ì¡°íšŒ (í•˜ìœ„ í˜¸í™˜) */
export async function fetchQuestionAnswer(questionId: number): Promise<Answer | null> {
  const replies = await fetchPostReplies(questionId);
  return replies.length > 0 ? replies[0] : null;
}

/** ê²Œì‹œë¬¼(ì§ˆë¬¸)ì— ë‹µë³€ ë“±ë¡ â€” POST /community/posts/:id/replies/ */
export async function createAnswer(questionId: number, content: string): Promise<Answer> {
  const res = await api.post<{ id: number; post: number; question: number; content: string; created_at: string }>(
    `${PREFIX}/posts/${questionId}/replies/`,
    { content }
  );
  const d = res.data;
  return {
    id: d.id,
    question: d.question ?? d.post,
    content: d.content,
    created_at: d.created_at,
  };
}

// ----------------------------------------
// ìë£Œì‹¤ (ë°±ì—”ë“œ ë¯¸ì œê³µ â€” ìŠ¤í…)
// ----------------------------------------
export interface Material {
  id: number;
  tenant: number | null;
  lecture: number | null;
  session: number | null;
  category: number | null;
  title: string;
  description: string;
  file: string | null;
  url: string | null;
  order: number;
  is_public: boolean;
  created_at: string;
  lecture_title?: string;
}

export interface MaterialCategory {
  id: number;
  tenant: number | null;
  lecture: number | null;
  name: string;
  order: number;
}

export async function fetchCommunityMaterials(
  _params: CommunityScopeParams & { categoryId?: number | null }
): Promise<Material[]> {
  return [];
}

export async function fetchCommunityMaterialCategories(
  _params: CommunityScopeParams
): Promise<MaterialCategory[]> {
  return [];
}

export async function createCommunityMaterialCategory(_data: {
  scope: CommunityScope;
  lectureId?: number | null;
  name: string;
  order?: number;
}): Promise<MaterialCategory> {
  throw new Error("ìë£Œì‹¤ APIê°€ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.");
}

export async function createCommunityMaterial(_formData: FormData): Promise<Material> {
  throw new Error("ìë£Œì‹¤ APIê°€ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.");
}


==========================================================================================
# FILE: components/BlockTypeFormModal.tsx
==========================================================================================
// PATH: src/features/community/components/BlockTypeFormModal.tsx
// ë¸”ë¡ ìœ í˜• ì¶”ê°€/ìˆ˜ì • ëª¨ë‹¬ â€” ê²Œì‹œê´€ë¦¬Â·ì„¤ì • ì–‘ìª½ì—ì„œ ì‚¬ìš©

import { useState } from "react";
import { useMutation, useQueryClient } from "@tanstack/react-query";
import {
  createBlockType,
  updateBlockType,
  type BlockType,
} from "../api/community.api";
import { Button } from "@/shared/ui/ds";
import { AdminModal, ModalBody, ModalFooter, ModalHeader } from "@/shared/ui/modal";

export interface BlockTypeFormModalProps {
  edit?: BlockType;
  onClose: () => void;
  onSuccess: () => void;
  /** ì¶”ê°€ ì‹œ ìƒì„±ëœ ìœ í˜• ì „ë‹¬ (ê²Œì‹œê´€ë¦¬ì—ì„œ ì¦‰ì‹œ ì„ íƒìš©) */
  onSuccessWithCreated?: (block: BlockType) => void;
}

export default function BlockTypeFormModal({
  edit,
  onClose,
  onSuccess,
  onSuccessWithCreated,
}: BlockTypeFormModalProps) {
  const [label, setLabel] = useState(edit?.label ?? "");
  const [order, setOrder] = useState(edit?.order ?? 100);
  const qc = useQueryClient();

  const createMut = useMutation({
    mutationFn: () => createBlockType({ label: label.trim(), order }),
    onSuccess: (data) => {
      qc.invalidateQueries({ queryKey: ["community-block-types"] });
      onSuccess();
      onSuccessWithCreated?.(data);
    },
  });
  const updateMut = useMutation({
    mutationFn: () =>
      updateBlockType(edit!.id, { label: label.trim(), order }),
    onSuccess: () => {
      qc.invalidateQueries({ queryKey: ["community-block-types"] });
      onSuccess();
    },
  });

  const handleSubmit = () => {
    if (!label.trim()) return;
    if (edit) updateMut.mutate();
    else createMut.mutate();
  };

  const pending = createMut.isPending || updateMut.isPending;

  return (
    <AdminModal open onClose={onClose} type="action" width={420}>
      <ModalHeader
        type="action"
        title={edit ? "ìœ í˜• ìˆ˜ì •" : "ìœ í˜• ì¶”ê°€"}
        description={edit ? "í‘œì‹œëª…ê³¼ ìˆœì„œë¥¼ ìˆ˜ì •í•©ë‹ˆë‹¤." : "ê¸€ ì‘ì„± ì‹œ ì„ íƒí•  ìœ í˜•ì„ ì¶”ê°€í•©ë‹ˆë‹¤."}
      />
      <ModalBody>
        <div style={{ marginBottom: 12 }}>
          <label className="block text-sm font-semibold text-[var(--color-text-secondary)] mb-1">
            í‘œì‹œëª…
          </label>
          <input
            className="ds-input w-full"
            value={label}
            onChange={(e) => setLabel(e.target.value)}
            placeholder="ì˜ˆ: ì‹œí—˜ ê³µì§€"
            disabled={pending}
          />
        </div>
        <div style={{ marginBottom: 0 }}>
          <label className="block text-sm font-semibold text-[var(--color-text-secondary)] mb-1">
            ì •ë ¬ ìˆœì„œ (ì‘ì„ìˆ˜ë¡ ì•ì— í‘œì‹œ)
          </label>
          <input
            type="number"
            className="ds-input w-full"
            value={order}
            onChange={(e) => setOrder(Number(e.target.value) || 0)}
            min={0}
            disabled={pending}
          />
        </div>
      </ModalBody>
      <ModalFooter
        right={
          <>
            <Button intent="secondary" size="sm" onClick={onClose} disabled={pending}>
              ì·¨ì†Œ
            </Button>
            <Button
              intent="primary"
              size="sm"
              onClick={handleSubmit}
              disabled={!label.trim() || pending}
            >
              {edit ? (updateMut.isPending ? "ì €ì¥ ì¤‘â€¦" : "ì €ì¥") : createMut.isPending ? "ì¶”ê°€ ì¤‘â€¦" : "ì¶”ê°€"}
            </Button>
          </>
        }
      />
    </AdminModal>
  );
}


==========================================================================================
# FILE: components/BoardTabs.tsx
==========================================================================================
// src/features/community/components/BoardTabs.tsx
// SSOT: í˜ì´ì§€ íƒ­ â†’ í”Œë«íƒ­ (ds-tabs--flat + ds-tab)
import { NavLink } from "react-router-dom";

export default function BoardTabs() {
  const base = "/admin/community";

  const tabClass = ({ isActive }: { isActive: boolean }) =>
    `ds-tab ${isActive ? "is-active" : ""}`;

  return (
    <div className="ds-tabs ds-tabs--flat border-b border-[var(--color-border-divider)] mb-6" role="tablist">
      <NavLink to={`${base}/admin?tab=notice`} className={tabClass}>ê³µì§€ì‚¬í•­</NavLink>
      <NavLink to={`${base}/qna`} className={tabClass}>QnA</NavLink>
      <NavLink to={`${base}/review`} className={tabClass}>ìˆ˜ê°•í›„ê¸°</NavLink>
    </div>
  );
}


==========================================================================================
# FILE: components/CommunityScopeSelector.tsx
==========================================================================================
// PATH: src/features/community/components/CommunityScopeSelector.tsx
// ë…¸ì¶œ ë²”ìœ„ ì„ íƒ: í†µí•© | ê°•ì˜ë³„ | ì„¸ì…˜ë³„ (CommunityScopeContext ì—°ë™)

import { useQuery } from "@tanstack/react-query";
import { useCommunityScope } from "../context/CommunityScopeContext";
import { fetchLectures } from "@/features/lectures/api/sessions";
import { fetchSessions } from "@/features/lectures/api/sessions";

const WRAPPER_STYLE = {
  padding: "var(--space-3) 0",
  borderBottom: "1px solid var(--color-border-divider)",
  marginBottom: "var(--space-4)",
};

export default function CommunityScopeSelector() {
  const { scope, setScope, lectureId, setLectureId, sessionId, setSessionId } = useCommunityScope();

  const { data: lectures = [] } = useQuery({
    queryKey: ["lectures-list"],
    queryFn: () => fetchLectures({ is_active: true }),
  });

  const { data: sessions = [] } = useQuery({
    queryKey: ["lecture-sessions", lectureId],
    queryFn: () => fetchSessions(lectureId!),
    enabled: scope !== "all" && Number.isFinite(lectureId ?? 0),
  });

  return (
    <div className="flex flex-wrap items-center gap-3" style={WRAPPER_STYLE}>
      <span
        style={{
          fontSize: "var(--text-sm)",
          fontWeight: "var(--font-title)",
          color: "var(--color-text-secondary)",
        }}
      >
        ë…¸ì¶œ ë²”ìœ„
      </span>
      <select
        className="ds-input"
        value={scope}
        onChange={(e) => {
          const v = e.target.value as "all" | "lecture" | "session";
          setScope(v);
          if (v === "all") {
            setLectureId(null);
            setSessionId(null);
          } else if (v === "lecture") {
            setSessionId(null);
          }
        }}
        style={{ width: 140 }}
      >
        <option value="all">í†µí•© (ì „ì²´ í•™ìƒ)</option>
        <option value="lecture">ê°•ì˜ë³„</option>
        <option value="session">ì„¸ì…˜ë³„</option>
      </select>

      {(scope === "lecture" || scope === "session") && (
        <select
          className="ds-input"
          value={lectureId ?? ""}
          onChange={(e) => {
            const v = e.target.value ? Number(e.target.value) : null;
            setLectureId(v);
            setSessionId(null);
          }}
          style={{ width: 220 }}
        >
          <option value="">ê°•ì˜ ì„ íƒ</option>
          {lectures.map((lec) => (
            <option key={lec.id} value={lec.id}>
              {lec.title}
            </option>
          ))}
        </select>
      )}

      {scope === "session" && lectureId && (
        <select
          className="ds-input"
          value={sessionId ?? ""}
          onChange={(e) => setSessionId(e.target.value ? Number(e.target.value) : null)}
          style={{ width: 200 }}
        >
          <option value="">ì°¨ì‹œ ì„ íƒ</option>
          {sessions.map((s) => (
            <option key={s.id} value={s.id}>
              {s.order}ì°¨ì‹œ Â· {s.title || "ì œëª© ì—†ìŒ"}
            </option>
          ))}
        </select>
      )}
    </div>
  );
}


==========================================================================================
# FILE: context/CommunityScopeContext.tsx
==========================================================================================
// PATH: src/features/community/context/CommunityScopeContext.tsx
// í†µí•© | ê°•ì˜ë³„ | ì„¸ì…˜ë³„ scope + ì„ íƒëœ ê°•ì˜/ì„¸ì…˜ (URL ì¿¼ë¦¬ì™€ ë™ê¸°í™”)

import { createContext, useContext, useMemo, useState, useEffect, type ReactNode } from "react";
import { useSearchParams } from "react-router-dom";
import type { CommunityScope } from "../api/community.api";

export type CommunityScopeContextValue = {
  scope: CommunityScope;
  setScope: (s: CommunityScope) => void;
  lectureId: number | null;
  setLectureId: (id: number | null) => void;
  sessionId: number | null;
  setSessionId: (id: number | null) => void;
  /** í˜„ì¬ scopeì— ë”°ë¥¸ ì‹¤ì œ ì‚¬ìš©í•  lectureId (í†µí•©ì´ë©´ null, ê°•ì˜/ì„¸ì…˜ë³„ì´ë©´ ì„ íƒëœ ê°•ì˜) */
  effectiveLectureId: number | null;
};

const CommunityScopeContext = createContext<CommunityScopeContextValue | null>(null);

export function CommunityScopeProvider({ children }: { children: ReactNode }) {
  const [searchParams] = useSearchParams();
  const [scope, setScope] = useState<CommunityScope>("all");
  const [lectureId, setLectureId] = useState<number | null>(null);
  const [sessionId, setSessionId] = useState<number | null>(null);

  // URL ì¿¼ë¦¬ì™€ ë™ê¸°í™” (ê°•ì˜ ëª©ë¡ì—ì„œ ë°”ë¡œê°€ê¸° ë“±ìœ¼ë¡œ ì§„ì… ì‹œ)
  useEffect(() => {
    const scopeParam = searchParams.get("scope") as CommunityScope | null;
    const lid = searchParams.get("lectureId");
    const sid = searchParams.get("sessionId");
    if (scopeParam === "lecture" || scopeParam === "session" || scopeParam === "all") setScope(scopeParam);
    if (lid != null && lid !== "" && Number.isFinite(Number(lid))) setLectureId(Number(lid));
    else setLectureId(null);
    if (sid != null && sid !== "" && Number.isFinite(Number(sid))) setSessionId(Number(sid));
    else setSessionId(null);
  }, [searchParams]);

  const effectiveLectureId = useMemo(() => {
    if (scope === "all") return null;
    return lectureId;
  }, [scope, lectureId]);

  const value = useMemo<CommunityScopeContextValue>(
    () => ({
      scope,
      setScope,
      lectureId,
      setLectureId,
      sessionId,
      setSessionId,
      effectiveLectureId,
    }),
    [scope, lectureId, sessionId, effectiveLectureId]
  );

  return (
    <CommunityScopeContext.Provider value={value}>
      {children}
    </CommunityScopeContext.Provider>
  );
}

export function useCommunityScope() {
  const ctx = useContext(CommunityScopeContext);
  if (!ctx) throw new Error("useCommunityScope must be used within CommunityScopeProvider");
  return ctx;
}


==========================================================================================
# FILE: pages/CommunityAdminPage.tsx
==========================================================================================
// PATH: src/features/community/pages/CommunityAdminPage.tsx
// ê²Œì‹œ ê´€ë¦¬: ê²Œì‹œíŒ ê´€ë¦¬(3íŒ¨ë„) + ê³µì§€ì‚¬í•­(ScopeSelector + ëª©ë¡/ì‘ì„±)

import { useMemo, useState } from "react";
import { useSearchParams } from "react-router-dom";
import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { Layout, Tree, Table, Select, Tag, message } from "antd";
import type { DataNode } from "antd/es/tree";
import {
  fetchScopeNodes,
  fetchBlockTypes,
  fetchAdminPosts,
  updatePostNodes,
  type PostEntity,
  type ScopeNodeMinimal,
} from "../api/community.api";
import { EmptyState, Button } from "@/shared/ui/ds";
import CommunityScopeSelector from "../components/CommunityScopeSelector";
import BlockTypeFormModal from "../components/BlockTypeFormModal";
import { NoticeBoardContent } from "./NoticeBoardPage";

const PAGE_SIZE = 20;

function buildTreeData(nodes: ScopeNodeMinimal[]): DataNode[] {
  const byLecture = new Map<number, ScopeNodeMinimal[]>();
  nodes.forEach((n) => {
    const arr = byLecture.get(n.lecture) ?? [];
    arr.push(n);
    byLecture.set(n.lecture, arr);
  });
  return Array.from(byLecture.entries())
    .map(([, list]) => {
      const course = list.find((n) => n.session == null);
      const sessions = list.filter((n) => n.session != null);
      if (!course) return null;
      return {
        key: String(course.id),
        title: course.lecture_title,
        children: sessions.map((s) => ({
          key: String(s.id),
          title: s.session_title ?? "ì°¨ì‹œ",
        })),
      };
    })
    .filter(Boolean) as DataNode[];
}

const SUB_TAB_BOARD = "board";
const SUB_TAB_NOTICE = "notice";

export default function CommunityAdminPage() {
  const qc = useQueryClient();
  const [searchParams, setSearchParams] = useSearchParams();
  const subTab = searchParams.get("tab") === SUB_TAB_NOTICE ? SUB_TAB_NOTICE : SUB_TAB_BOARD;
  const setSubTab = (tab: string) => setSearchParams(tab === SUB_TAB_BOARD ? {} : { tab });

  const [blockTypeId, setBlockTypeId] = useState<number | null>(null);
  const [lectureId, setLectureId] = useState<number | null>(null);
  const [page, setPage] = useState(1);
  const [selectedPost, setSelectedPost] = useState<PostEntity | null>(null);
  const [inspectorNodeIds, setInspectorNodeIds] = useState<number[]>([]);
  const [showAddBlockType, setShowAddBlockType] = useState(false);

  const { data: scopeNodes = [] } = useQuery({
    queryKey: ["community-scope-nodes"],
    queryFn: () => fetchScopeNodes(),
  });

  const { data: blockTypes = [] } = useQuery({
    queryKey: ["community-block-types"],
    queryFn: () => fetchBlockTypes(),
  });

  const { data: adminData, isLoading: loadingPosts } = useQuery({
    queryKey: ["community-admin-posts", blockTypeId, lectureId, page],
    queryFn: () =>
      fetchAdminPosts({
        blockTypeId: blockTypeId ?? undefined,
        lectureId: lectureId ?? undefined,
        page,
        pageSize: PAGE_SIZE,
      }),
  });

  const treeData = useMemo(() => buildTreeData(scopeNodes), [scopeNodes]);

  const lectureOptions = useMemo(() => {
    const seen = new Set<number>();
    return scopeNodes
      .filter((n) => n.session == null)
      .filter((n) => {
        if (seen.has(n.lecture)) return false;
        seen.add(n.lecture);
        return true;
      })
      .map((n) => ({ label: n.lecture_title, value: n.lecture }));
  }, [scopeNodes]);

  const posts = adminData?.results ?? [];
  const total = adminData?.count ?? 0;

  const columns = [
    {
      title: "ì œëª©",
      dataIndex: "title",
      key: "title",
      ellipsis: true,
      render: (t: string, r: PostEntity) => (
        <button
          type="button"
          className="text-left font-semibold text-[var(--color-primary)] hover:underline"
          onClick={() => {
            setSelectedPost(r);
            setInspectorNodeIds(r.mappings?.map((m) => m.node) ?? []);
          }}
        >
          {t}
        </button>
      ),
    },
    {
      title: "ìœ í˜•",
      dataIndex: "block_type_label",
      key: "block_type_label",
      width: 100,
      render: (label: string) => <Tag>{label}</Tag>,
    },
    {
      title: "ë…¸ì¶œ ë…¸ë“œ",
      key: "nodes",
      width: 220,
      render: (_: unknown, r: PostEntity) => (
        <div className="flex flex-wrap gap-1">
          {r.mappings?.map((m) => (
            <Tag key={m.id}>{m.node_detail?.lecture_title} {m.node_detail?.session_title ? `Â· ${m.node_detail.session_title}` : "(ì „ì²´)"}</Tag>
          )) ?? null}
        </div>
      ),
    },
    {
      title: "ì‘ì„±ì¼",
      dataIndex: "created_at",
      key: "created_at",
      width: 110,
      render: (v: string) => v?.slice(0, 10),
    },
  ];

  const updateNodesMut = useMutation({
    mutationFn: ({ postId, nodeIds }: { postId: number; nodeIds: number[] }) =>
      updatePostNodes(postId, nodeIds),
    onSuccess: () => {
      message.success("ë…¸ì¶œ ë…¸ë“œê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
      qc.invalidateQueries({ queryKey: ["community-admin-posts"] });
      setSelectedPost(null);
    },
    onError: () => message.error("ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."),
  });

  const handleSaveNodes = () => {
    if (!selectedPost || inspectorNodeIds.length === 0) return;
    updateNodesMut.mutate({ postId: selectedPost.id, nodeIds: inspectorNodeIds });
  };

  const nodePickerOptions = useMemo(() => {
    return scopeNodes.map((n) => ({
      label: n.session_title ? `${n.lecture_title} Â· ${n.session_title}` : `${n.lecture_title} (ì „ì²´)`,
      value: n.id,
    }));
  }, [scopeNodes]);

  return (
    <div className="flex flex-col gap-4">
      <div className="flex items-center gap-2 border-b border-[var(--color-border-divider)] pb-2">
        <button
          type="button"
          className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-colors ${
            subTab === SUB_TAB_BOARD
              ? "bg-[var(--color-primary)] text-white"
              : "text-[var(--color-text-secondary)] hover:bg-[var(--color-bg-elevated)]"
          }`}
          onClick={() => setSubTab(SUB_TAB_BOARD)}
        >
          ê²Œì‹œíŒ ê´€ë¦¬
        </button>
        <button
          type="button"
          className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-colors ${
            subTab === SUB_TAB_NOTICE
              ? "bg-[var(--color-primary)] text-white"
              : "text-[var(--color-text-secondary)] hover:bg-[var(--color-bg-elevated)]"
          }`}
          onClick={() => setSubTab(SUB_TAB_NOTICE)}
        >
          ê³µì§€ì‚¬í•­
        </button>
      </div>

      {subTab === SUB_TAB_NOTICE ? (
        <>
          <CommunityScopeSelector />
          <NoticeBoardContent />
        </>
      ) : (
    <Layout className="!bg-transparent !min-h-0">
        <Layout.Sider
          width={280}
          className="!bg-[var(--color-bg-surface)] !rounded-xl border border-[var(--color-border-divider)] overflow-hidden"
        >
          <div className="p-3 border-b border-[var(--color-border-divider)] font-semibold text-sm text-[var(--color-text-secondary)]">
            ë…¸ì¶œ ìœ„ì¹˜ (ScopeNode)
          </div>
          <div className="p-2 overflow-auto" style={{ maxHeight: "calc(100vh - 280px)" }}>
            {treeData.length === 0 ? (
              <EmptyState scope="panel" title="ë…¸ë“œ ì—†ìŒ" />
            ) : (
              <Tree
                showLine
                defaultExpandAll
                treeData={treeData}
                selectable={false}
              />
            )}
          </div>
        </Layout.Sider>

        <Layout.Content className="px-4 !min-w-0">
          <div className="flex flex-wrap items-center gap-2 mb-3">
            <Select
              placeholder="ìœ í˜•"
              allowClear
              value={blockTypeId}
              onChange={setBlockTypeId}
              options={blockTypes.map((b) => ({ label: b.label, value: b.id }))}
              style={{ width: 120 }}
            />
            <Button intent="secondary" size="sm" onClick={() => setShowAddBlockType(true)}>
              + ë¸”ë¡ ì¶”ê°€
            </Button>
            <Select
              placeholder="ê°•ì˜"
              allowClear
              value={lectureId}
              onChange={setLectureId}
              options={lectureOptions}
              style={{ width: 200 }}
            />
          </div>
          <div className="rounded-xl border border-[var(--color-border-divider)] bg-[var(--color-bg-surface)] overflow-hidden">
            {loadingPosts ? (
              <EmptyState scope="panel" tone="loading" title="ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦" />
            ) : (
              <Table
                rowKey="id"
                size="small"
                pagination={{
                  current: page,
                  pageSize: PAGE_SIZE,
                  total,
                  onChange: setPage,
                  showSizeChanger: false,
                }}
                columns={columns}
                dataSource={posts}
                locale={{ emptyText: "ê²Œì‹œë¬¼ì´ ì—†ìŠµë‹ˆë‹¤." }}
              />
            )}
          </div>
        </Layout.Content>

        <Layout.Sider
          width={320}
          className="!bg-[var(--color-bg-surface)] !rounded-xl border border-[var(--color-border-divider)] overflow-hidden"
        >
          <div className="p-3 border-b border-[var(--color-border-divider)] font-semibold text-sm text-[var(--color-text-secondary)]">
            Inspector
          </div>
          <div className="p-4 overflow-auto" style={{ maxHeight: "calc(100vh - 280px)" }}>
            {!selectedPost ? (
              <EmptyState scope="panel" title="ê¸€ì„ ì„ íƒí•˜ì„¸ìš”" description="ì¤‘ì•™ ëª©ë¡ì—ì„œ í–‰ì„ í´ë¦­í•˜ì„¸ìš”." />
            ) : (
              <>
                <div className="mb-4">
                  <div className="font-bold text-[var(--color-text-primary)] mb-1">{selectedPost.title}</div>
                  <Tag>{selectedPost.block_type_label}</Tag>
                  <div className="text-xs text-[var(--color-text-muted)] mt-2">
                    {selectedPost.created_at?.slice(0, 16)}
                  </div>
                </div>
                <div className="mb-2 text-sm font-semibold text-[var(--color-text-secondary)]">
                  ë…¸ì¶œ ë…¸ë“œ
                </div>
                <Select
                  mode="multiple"
                  placeholder="ë…¸ë“œ ì¶”ê°€"
                  value={inspectorNodeIds}
                  onChange={setInspectorNodeIds}
                  options={nodePickerOptions}
                  style={{ width: "100%", marginBottom: 12 }}
                  maxTagCount="responsive"
                />
                <div className="flex gap-2">
                  <Button intent="primary" size="sm" onClick={handleSaveNodes} loading={updateNodesMut.isPending}>
                    ì €ì¥
                  </Button>
                  <Button intent="secondary" size="sm" onClick={() => setSelectedPost(null)}>
                    ë‹«ê¸°
                  </Button>
                </div>
              </>
            )}
          </div>
        </Layout.Sider>
      </Layout>
      )}

      {showAddBlockType && (
        <BlockTypeFormModal
          onClose={() => setShowAddBlockType(false)}
          onSuccess={() => setShowAddBlockType(false)}
          onSuccessWithCreated={(block) => setBlockTypeId(block.id)}
        />
      )}
    </div>
  );
}


==========================================================================================
# FILE: pages/CommunityPage.tsx
==========================================================================================
// PATH: src/features/community/pages/CommunityPage.tsx
// ì»¤ë®¤ë‹ˆí‹° â€” ê²Œì‹œ ê´€ë¦¬(ê²Œì‹œíŒ+ê³µì§€) Â· QnA Â· ìë£Œì‹¤ Â· ì„¤ì •

import { Outlet, useLocation } from "react-router-dom";
import { DomainLayout } from "@/shared/ui/layout";
import { CommunityScopeProvider } from "../context/CommunityScopeContext";
import CommunityScopeSelector from "../components/CommunityScopeSelector";

const COMMUNITY_TABS = [
  { key: "admin", label: "ê²Œì‹œ ê´€ë¦¬", path: "/admin/community/admin" },
  { key: "qna", label: "QnA", path: "/admin/community/qna" },
  { key: "materials", label: "ìë£Œì‹¤", path: "/admin/community/materials" },
  { key: "settings", label: "ì„¤ì •", path: "/admin/community/settings" },
];

function CommunityPageInner() {
  const location = useLocation();
  const isAdminPanel = location.pathname.endsWith("/admin");
  const isSettingsPanel = location.pathname.endsWith("/settings");

  return (
    <DomainLayout
      title="ì»¤ë®¤ë‹ˆí‹°"
      description="ê²Œì‹œ ê´€ë¦¬ Â· QnA Â· ìë£Œì‹¤"
      tabs={COMMUNITY_TABS}
    >
      {!isAdminPanel && !isSettingsPanel && <CommunityScopeSelector />}
      <Outlet />
    </DomainLayout>
  );
}

export default function CommunityPage() {
  return (
    <CommunityScopeProvider>
      <CommunityPageInner />
    </CommunityScopeProvider>
  );
}


==========================================================================================
# FILE: pages/CommunitySettingsPage.tsx
==========================================================================================
// PATH: src/features/community/pages/CommunitySettingsPage.tsx
// ë¸”ë¡ ìœ í˜•Â·ì–‘ì‹ ê´€ë¦¬ â€” ì»¤ìŠ¤í…€ ìœ í˜• ì¶”ê°€/ìˆ˜ì •, ìì£¼ ì“°ëŠ” ê¸€ ì–‘ì‹ ì €ì¥Â·í¸ì§‘

import { useState } from "react";
import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import {
  fetchBlockTypes,
  deleteBlockType,
  fetchPostTemplates,
  createPostTemplate,
  updatePostTemplate,
  deletePostTemplate,
  type BlockType,
  type PostTemplate,
} from "../api/community.api";
import { Button, EmptyState } from "@/shared/ui/ds";
import { AdminModal, ModalBody, ModalFooter, ModalHeader } from "@/shared/ui/modal";
import BlockTypeFormModal from "../components/BlockTypeFormModal";

const SECTION_STYLE = {
  borderRadius: "var(--radius-xl)",
  border: "1px solid var(--color-border-divider)",
  background: "var(--color-bg-surface)",
  padding: "var(--space-5)",
  marginBottom: "var(--space-6)",
};

export default function CommunitySettingsPage() {
  const qc = useQueryClient();
  const [blockTypeModal, setBlockTypeModal] = useState<{ open: boolean; edit?: BlockType }>({ open: false });
  const [templateModal, setTemplateModal] = useState<{ open: boolean; edit?: PostTemplate }>({ open: false });

  const { data: blockTypes = [], isLoading: loadingTypes } = useQuery({
    queryKey: ["community-block-types"],
    queryFn: () => fetchBlockTypes(),
  });

  const { data: templates = [], isLoading: loadingTemplates } = useQuery({
    queryKey: ["community-post-templates"],
    queryFn: () => fetchPostTemplates(),
  });

  return (
    <div className="max-w-4xl">
      <h1 className="text-xl font-bold text-[var(--color-text-primary)] mb-1">ì„¤ì •</h1>
      <p
        className="mb-4"
        style={{ fontSize: "var(--text-sm)", color: "var(--color-text-muted)" }}
      >
        ê²Œì‹œë¬¼ ìœ í˜•ê³¼ ìì£¼ ì“°ëŠ” ê¸€ ì–‘ì‹ì„ ê´€ë¦¬í•©ë‹ˆë‹¤. ìœ í˜•ì„ ì¶”ê°€í•˜ë©´ ê¸€ ì‘ì„± ì‹œ ì„ íƒí•  ìˆ˜ ìˆê³ , ì–‘ì‹ì€ ë¶ˆëŸ¬ì™€ì„œ ìˆ˜ì •í•´ ì“°ë©´ ë©ë‹ˆë‹¤.
      </p>

      {/* ë¸”ë¡ ìœ í˜• */}
      <section style={SECTION_STYLE}>
        <div className="flex items-center justify-between mb-4">
          <h2 style={{ fontSize: "var(--text-lg)", fontWeight: 700, margin: 0 }}>
            ë¸”ë¡ ìœ í˜•
          </h2>
          <Button
            intent="primary"
            size="sm"
            onClick={() => setBlockTypeModal({ open: true })}
          >
            + ìœ í˜• ì¶”ê°€
          </Button>
        </div>
        {loadingTypes ? (
          <EmptyState scope="panel" tone="loading" title="ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦" />
        ) : blockTypes.length === 0 ? (
          <EmptyState
            scope="panel"
            title="ë“±ë¡ëœ ìœ í˜•ì´ ì—†ìŠµë‹ˆë‹¤."
            description="ìœ„ 'ìœ í˜• ì¶”ê°€'ë¡œ ê³µì§€Â·ì§ˆì˜Â·ì˜¤íƒˆì ì™¸ì— í•„ìš”í•œ ìœ í˜•ì„ ë§Œë“œì„¸ìš”."
          />
        ) : (
          <ul className="flex flex-wrap gap-2" style={{ listStyle: "none", padding: 0, margin: 0 }}>
            {blockTypes.map((b) => (
              <li
                key={b.id}
                className="flex items-center gap-2 rounded-lg border border-[var(--color-border-divider)] px-3 py-2 bg-[var(--color-bg-surface-soft)]"
              >
                <span style={{ fontWeight: 600 }}>{b.label}</span>
                <span style={{ fontSize: 12, color: "var(--color-text-muted)" }}>({b.code})</span>
                <Button
                  intent="ghost"
                  size="sm"
                  onClick={() => setBlockTypeModal({ open: true, edit: b })}
                >
                  ìˆ˜ì •
                </Button>
                <Button
                  intent="ghost"
                  size="sm"
                  onClick={() => {
                    if (window.confirm(`"${b.label}" ìœ í˜•ì„ ì‚­ì œí• ê¹Œìš”?`)) {
                      deleteBlockType(b.id).then(() =>
                        qc.invalidateQueries({ queryKey: ["community-block-types"] })
                      );
                    }
                  }}
                >
                  ì‚­ì œ
                </Button>
              </li>
            ))}
          </ul>
        )}
      </section>

      {/* ì–‘ì‹ */}
      <section style={SECTION_STYLE}>
        <div className="flex items-center justify-between mb-4">
          <h2 style={{ fontSize: "var(--text-lg)", fontWeight: 700, margin: 0 }}>
            ê¸€ ì–‘ì‹
          </h2>
          <Button
            intent="primary"
            size="sm"
            onClick={() => setTemplateModal({ open: true })}
          >
            + ì–‘ì‹ ì¶”ê°€
          </Button>
        </div>
        {loadingTemplates ? (
          <EmptyState scope="panel" tone="loading" title="ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦" />
        ) : templates.length === 0 ? (
          <EmptyState
            scope="panel"
            title="ì €ì¥ëœ ì–‘ì‹ì´ ì—†ìŠµë‹ˆë‹¤."
            description="ê¸€ ì‘ì„± í™”ë©´ì—ì„œ 'ì–‘ì‹ìœ¼ë¡œ ì €ì¥'í•˜ê±°ë‚˜ ì—¬ê¸°ì„œ 'ì–‘ì‹ ì¶”ê°€'ë¡œ ìì£¼ ì“°ëŠ” ì œëª©Â·ë‚´ìš©ì„ ë“±ë¡í•˜ì„¸ìš”."
          />
        ) : (
          <ul className="space-y-2" style={{ listStyle: "none", padding: 0, margin: 0 }}>
            {templates.map((t) => (
              <li
                key={t.id}
                className="rounded-lg border border-[var(--color-border-divider)] p-3 bg-[var(--color-bg-surface-soft)]"
              >
                <div className="flex items-start justify-between gap-2">
                  <div className="min-w-0 flex-1">
                    <div style={{ fontWeight: 600, marginBottom: 4 }}>{t.name}</div>
                    {t.block_type_label && (
                      <span
                        className="inline-block rounded px-2 py-0.5 text-xs"
                        style={{ background: "var(--color-bg-muted)", color: "var(--color-text-secondary)" }}
                      >
                        {t.block_type_label}
                      </span>
                    )}
                    {t.title && (
                      <div style={{ fontSize: 13, color: "var(--color-text-muted)", marginTop: 6 }}>
                        {t.title.slice(0, 60)}{t.title.length > 60 ? "â€¦" : ""}
                      </div>
                    )}
                  </div>
                  <div className="flex gap-1 shrink-0">
                    <Button
                      intent="ghost"
                      size="sm"
                      onClick={() => setTemplateModal({ open: true, edit: t })}
                    >
                      ìˆ˜ì •
                    </Button>
                    <Button
                      intent="ghost"
                      size="sm"
                      onClick={() => {
                        if (window.confirm(`"${t.name}" ì–‘ì‹ì„ ì‚­ì œí• ê¹Œìš”?`)) {
                          deletePostTemplate(t.id).then(() =>
                            qc.invalidateQueries({ queryKey: ["community-post-templates"] })
                          );
                        }
                      }}
                    >
                      ì‚­ì œ
                    </Button>
                  </div>
                </div>
              </li>
            ))}
          </ul>
        )}
      </section>

      {blockTypeModal.open && (
        <BlockTypeFormModal
          edit={blockTypeModal.edit}
          onClose={() => setBlockTypeModal({ open: false })}
          onSuccess={() => setBlockTypeModal({ open: false })}
        />
      )}
      {templateModal.open && (
        <PostTemplateFormModal
          edit={templateModal.edit}
          blockTypes={blockTypes}
          onClose={() => setTemplateModal({ open: false })}
          onSuccess={() => {
            qc.invalidateQueries({ queryKey: ["community-post-templates"] });
            setTemplateModal({ open: false });
          }}
        />
      )}
    </div>
  );
}

function PostTemplateFormModal({
  edit,
  blockTypes,
  onClose,
  onSuccess,
}: {
  edit?: PostTemplate;
  blockTypes: BlockType[];
  onClose: () => void;
  onSuccess: () => void;
}) {
  const [name, setName] = useState(edit?.name ?? "");
  const [blockTypeId, setBlockTypeId] = useState<number | null>(edit?.block_type ?? null);
  const [title, setTitle] = useState(edit?.title ?? "");
  const [content, setContent] = useState(edit?.content ?? "");

  const createMut = useMutation({
    mutationFn: () =>
      createPostTemplate({
        name: name.trim(),
        block_type: blockTypeId ?? undefined,
        title: title.trim() || undefined,
        content: content.trim() || undefined,
      }),
    onSuccess: () => onSuccess(),
  });
  const updateMut = useMutation({
    mutationFn: () =>
      updatePostTemplate(edit!.id, {
        name: name.trim(),
        block_type: blockTypeId ?? undefined,
        title: title.trim() || undefined,
        content: content.trim() || undefined,
      }),
    onSuccess: () => onSuccess(),
  });

  const handleSubmit = () => {
    if (!name.trim()) return;
    if (edit) updateMut.mutate();
    else createMut.mutate();
  };

  const pending = createMut.isPending || updateMut.isPending;

  return (
    <AdminModal open onClose={onClose} type="action" width={560}>
      <ModalHeader
        type="action"
        title={edit ? "ì–‘ì‹ ìˆ˜ì •" : "ì–‘ì‹ ì¶”ê°€"}
        description={edit ? "ì–‘ì‹ ì´ë¦„ê³¼ ë‚´ìš©ì„ ìˆ˜ì •í•©ë‹ˆë‹¤." : "ìì£¼ ì“°ëŠ” ì œëª©Â·ë‚´ìš©ì„ ì €ì¥í•´ ë‘ì—ˆë‹¤ê°€ ê¸€ ì‘ì„± ì‹œ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤."}
      />
      <ModalBody>
        <div style={{ marginBottom: 12 }}>
          <label className="block text-sm font-semibold text-[var(--color-text-secondary)] mb-1">
            ì–‘ì‹ ì´ë¦„
          </label>
          <input
            className="ds-input w-full"
            value={name}
            onChange={(e) => setName(e.target.value)}
            placeholder="ì˜ˆ: ì¤‘ê°„ê³ ì‚¬ ê³µì§€"
            disabled={pending}
          />
        </div>
        <div style={{ marginBottom: 12 }}>
          <label className="block text-sm font-semibold text-[var(--color-text-secondary)] mb-1">
            ê¸°ë³¸ ìœ í˜• (ì„ íƒ)
          </label>
          <select
            className="ds-input w-full"
            value={blockTypeId ?? ""}
            onChange={(e) => setBlockTypeId(e.target.value ? Number(e.target.value) : null)}
            disabled={pending}
          >
            <option value="">ì„ íƒ ì•ˆ í•¨</option>
            {blockTypes.map((b) => (
              <option key={b.id} value={b.id}>
                {b.label}
              </option>
            ))}
          </select>
        </div>
        <div style={{ marginBottom: 12 }}>
          <label className="block text-sm font-semibold text-[var(--color-text-secondary)] mb-1">
            ì œëª© (ê¸°ë³¸ê°’)
          </label>
          <input
            className="ds-input w-full"
            value={title}
            onChange={(e) => setTitle(e.target.value)}
            placeholder="ë¶ˆëŸ¬ì˜¬ ë•Œ ì±„ì›Œì§ˆ ì œëª©"
            disabled={pending}
          />
        </div>
        <div style={{ marginBottom: 0 }}>
          <label className="block text-sm font-semibold text-[var(--color-text-secondary)] mb-1">
            ë‚´ìš© (ê¸°ë³¸ê°’)
          </label>
          <textarea
            className="ds-input w-full"
            value={content}
            onChange={(e) => setContent(e.target.value)}
            placeholder="ë¶ˆëŸ¬ì˜¬ ë•Œ ì±„ì›Œì§ˆ ë³¸ë¬¸"
            rows={6}
            style={{ resize: "vertical" }}
            disabled={pending}
          />
        </div>
      </ModalBody>
      <ModalFooter
        right={
          <>
            <Button intent="secondary" size="sm" onClick={onClose} disabled={pending}>
              ì·¨ì†Œ
            </Button>
            <Button
              intent="primary"
              size="sm"
              onClick={handleSubmit}
              disabled={!name.trim() || pending}
            >
              {edit ? (updateMut.isPending ? "ì €ì¥ ì¤‘â€¦" : "ì €ì¥") : createMut.isPending ? "ì¶”ê°€ ì¤‘â€¦" : "ì¶”ê°€"}
            </Button>
          </>
        }
      />
    </AdminModal>
  );
}


==========================================================================================
# FILE: pages/MaterialsBoardPage.tsx
==========================================================================================
// PATH: src/features/community/pages/MaterialsBoardPage.tsx
// ì»¤ë®¤ë‹ˆí‹° ìë£Œì‹¤ â€” scopeì— ë”°ë¼ ëª©ë¡

import { useState, useMemo } from "react";
import { useQuery } from "@tanstack/react-query";
import { useCommunityScope } from "../context/CommunityScopeContext";
import {
  fetchCommunityMaterials,
  fetchCommunityMaterialCategories,
  type Material,
  type MaterialCategory,
} from "../api/community.api";
import { fetchLectures } from "@/features/lectures/api/sessions";
import { EmptyState, Button } from "@/shared/ui/ds";

export default function MaterialsBoardPage() {
  const { scope, sessionId, effectiveLectureId } = useCommunityScope();
  const [selectedCategoryId, setSelectedCategoryId] = useState<number | null>(null);

  const scopeParams = {
    scope,
    lectureId: effectiveLectureId ?? undefined,
    sessionId: sessionId ?? undefined,
  };

  const { data: lectures = [] } = useQuery({
    queryKey: ["lectures-list"],
    queryFn: () => fetchLectures({ is_active: true }),
  });

  const { data: categories = [] } = useQuery<MaterialCategory[]>({
    queryKey: ["community-material-categories", scope, effectiveLectureId, sessionId],
    queryFn: () => fetchCommunityMaterialCategories(scopeParams),
    enabled: true,
  });

  const { data: materials = [], isLoading } = useQuery<Material[]>({
    queryKey: ["community-materials", scope, effectiveLectureId, sessionId, selectedCategoryId],
    queryFn: () =>
      fetchCommunityMaterials({
        ...scopeParams,
        categoryId: selectedCategoryId ?? undefined,
      }),
    enabled: scope === "all" || (scope === "lecture" && effectiveLectureId != null) || (scope === "session" && sessionId != null),
  });

  const lectureTitleMap = useMemo(() => {
    const m = new Map<number, string>();
    lectures.forEach((l) => m.set(l.id, l.title));
    return m;
  }, [lectures]);

  if ((scope === "lecture" && effectiveLectureId == null) || (scope === "session" && (!effectiveLectureId || sessionId == null))) {
    return (
      <EmptyState
        scope="panel"
        title={scope === "session" ? "ê°•ì˜Â·ì°¨ì‹œë¥¼ ì„ íƒí•˜ì„¸ìš”" : "ê°•ì˜ë¥¼ ì„ íƒí•˜ì„¸ìš”"}
        description={
          scope === "session"
            ? "ë…¸ì¶œ ë²”ìœ„ë¥¼ 'ì„¸ì…˜ë³„'ë¡œ ë‘ê³  ê°•ì˜ì™€ ì°¨ì‹œë¥¼ ì„ íƒí•˜ë©´ í•´ë‹¹ ì°¨ì‹œ ìë£Œë¥¼ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤."
            : "ë…¸ì¶œ ë²”ìœ„ë¥¼ 'ê°•ì˜ë³„'ë¡œ ë‘ê³  ìœ„ì—ì„œ ê°•ì˜ë¥¼ ì„ íƒí•˜ë©´ í•´ë‹¹ ê°•ì˜ì˜ ìë£Œì‹¤ì„ ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."
        }
      />
    );
  }

  return (
    <div className="flex flex-col gap-4">
      <div className="flex items-center justify-between">
        <span
          style={{
            fontSize: "var(--text-sm)",
            fontWeight: "var(--font-title)",
            color: "var(--color-text-muted)",
          }}
        >
          {scope === "all" ? "ì „ì²´ ìë£Œ" : scope === "session" ? "í•´ë‹¹ ì°¨ì‹œ ìë£Œ" : "í•´ë‹¹ ê°•ì˜ ìë£Œ"} Â· {materials.length}ê°œ
        </span>
      </div>

      {categories.length > 0 && (
        <div className="flex flex-wrap gap-2">
          <Button
            intent={selectedCategoryId === null ? "secondary" : "ghost"}
            size="sm"
            onClick={() => setSelectedCategoryId(null)}
          >
            ì „ì²´
          </Button>
          {categories.map((c) => (
            <Button
              key={c.id}
              intent={selectedCategoryId === c.id ? "secondary" : "ghost"}
              size="sm"
              onClick={() => setSelectedCategoryId(c.id)}
            >
              {c.name}
            </Button>
          ))}
        </div>
      )}

      {isLoading ? (
        <EmptyState scope="panel" tone="loading" title="ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦" />
      ) : materials.length === 0 ? (
        <EmptyState
          scope="panel"
          title="ë“±ë¡ëœ ìë£Œê°€ ì—†ìŠµë‹ˆë‹¤."
          description="ê°•ì˜ë³„ ë˜ëŠ” ì„¸ì…˜ë³„ ë…¸ì¶œ ë²”ìœ„ì—ì„œ ìë£Œë¥¼ ì¶”ê°€í•˜ê±°ë‚˜, í†µí•© ìë£Œì‹¤ì— ìë£Œë¥¼ ë“±ë¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."
        />
      ) : (
        <ul className="flex flex-col gap-2" style={{ listStyle: "none", padding: 0, margin: 0 }}>
          {materials.map((m) => (
            <li
              key={m.id}
              style={{
                padding: "var(--space-4)",
                borderRadius: "var(--radius-lg)",
                border: "1px solid var(--color-border-divider)",
                background: "var(--color-bg-surface)",
              }}
            >
              <div className="flex items-start justify-between gap-2">
                <div>
                  <div
                    style={{
                      fontSize: "var(--text-md)",
                      fontWeight: 700,
                      color: "var(--color-text-primary)",
                    }}
                  >
                    {m.title}
                  </div>
                  {m.description && (
                    <div
                      style={{
                        fontSize: "var(--text-sm)",
                        color: "var(--color-text-secondary)",
                        marginTop: 4,
                      }}
                    >
                      {m.description}
                    </div>
                  )}
                  {scope === "all" && m.lecture != null && m.lecture && (
                    <span
                      style={{
                        fontSize: "var(--text-xs)",
                        color: "var(--color-text-muted)",
                        marginTop: 4,
                        display: "inline-block",
                      }}
                    >
                      {lectureTitleMap.get(m.lecture) ?? `ê°•ì˜ #${m.lecture}`}
                    </span>
                  )}
                  <div
                    style={{
                      fontSize: "var(--text-xs)",
                      color: "var(--color-text-muted)",
                      marginTop: 6,
                    }}
                  >
                    {new Date(m.created_at).toLocaleDateString("ko-KR")}
                    {m.file && (
                      <a
                        href={m.file}
                        target="_blank"
                        rel="noopener noreferrer"
                        className="ml-2"
                        style={{ color: "var(--color-primary)" }}
                      >
                        íŒŒì¼
                      </a>
                    )}
                    {m.url && (
                      <a
                        href={m.url}
                        target="_blank"
                        rel="noopener noreferrer"
                        className="ml-2"
                        style={{ color: "var(--color-primary)" }}
                      >
                        ë§í¬
                      </a>
                    )}
                  </div>
                </div>
              </div>
            </li>
          ))}
        </ul>
      )}
    </div>
  );
}


==========================================================================================
# FILE: pages/NoticeBoardPage.tsx
==========================================================================================
// PATH: src/features/community/pages/NoticeBoardPage.tsx
// ê³µì§€ì‚¬í•­ ëª©ë¡+ì‘ì„± (ê²Œì‹œ ê´€ë¦¬ ë‚´ "ê³µì§€ì‚¬í•­" íƒ­ì—ì„œ ì‚¬ìš©, ë˜ëŠ” ë‹¨ë… ë¼ìš°íŠ¸ìš©)

import { useState, useMemo } from "react";
import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { useCommunityScope } from "../context/CommunityScopeContext";
import {
  fetchScopeNodes,
  resolveNodeIdFromScope,
  fetchCommunityBoardPosts,
  fetchCommunityBoardCategories,
  createCommunityBoardPost,
  fetchBlockTypes,
  fetchPostTemplates,
  createPostTemplate,
  type BoardPost,
  type BlockType,
  type PostTemplate,
  type ScopeNodeMinimal,
  type CommunityScopeParams,
} from "../api/community.api";
import { fetchLectures } from "@/features/lectures/api/sessions";
import { EmptyState, Button } from "@/shared/ui/ds";

/** ê²Œì‹œ ê´€ë¦¬ ë‚´ "ê³µì§€ì‚¬í•­" íƒ­ì—ì„œ ì„ë² ë“œìš©. ScopeSelectorëŠ” ìƒìœ„(ê²Œì‹œ ê´€ë¦¬)ì—ì„œ ë…¸ì¶œ. */
export function NoticeBoardContent() {
  const qc = useQueryClient();
  const { scope, lectureId, sessionId, effectiveLectureId } = useCommunityScope();
  const [selectedCategoryId, setSelectedCategoryId] = useState<number | null>(null);
  const [showCreate, setShowCreate] = useState(false);

  const scopeParams = { scope, lectureId: effectiveLectureId ?? undefined, sessionId: sessionId ?? undefined };

  const { data: lectures = [] } = useQuery({
    queryKey: ["lectures-list"],
    queryFn: () => fetchLectures({ is_active: true }),
  });

  const { data: scopeNodes = [] } = useQuery<ScopeNodeMinimal[]>({
    queryKey: ["community-scope-nodes"],
    queryFn: () => fetchScopeNodes(),
    enabled: true,
  });

  const nodeId = useMemo(
    () => resolveNodeIdFromScope(scopeNodes, scopeParams),
    [scopeNodes, scope, effectiveLectureId, sessionId]
  );

  const { data: categories = [], isLoading: loadingCats } = useQuery<BlockType[]>({
    queryKey: ["community-block-types"],
    queryFn: () => fetchBlockTypes(),
    enabled: true,
  });

  const { data: templates = [] } = useQuery<PostTemplate[]>({
    queryKey: ["community-post-templates"],
    queryFn: () => fetchPostTemplates(),
    enabled: showCreate,
  });

  const { data: posts = [], isLoading: loadingPosts } = useQuery<BoardPost[]>({
    queryKey: ["community-board-posts", scope, effectiveLectureId, sessionId, selectedCategoryId, nodeId],
    queryFn: () =>
      fetchCommunityBoardPosts({
        ...scopeParams,
        categoryId: selectedCategoryId ?? undefined,
      }),
    enabled: scope === "all" || (scope === "lecture" && effectiveLectureId != null) || (scope === "session" && sessionId != null),
  });

  const lectureTitleMap = useMemo(() => {
    const m = new Map<number, string>();
    lectures.forEach((l) => m.set(l.id, l.title));
    return m;
  }, [lectures]);

  if ((scope === "lecture" && effectiveLectureId == null) || (scope === "session" && (!effectiveLectureId || sessionId == null))) {
    return (
      <EmptyState
        scope="panel"
        title={scope === "session" ? "ê°•ì˜Â·ì°¨ì‹œë¥¼ ì„ íƒí•˜ì„¸ìš”" : "ê°•ì˜ë¥¼ ì„ íƒí•˜ì„¸ìš”"}
        description={
          scope === "session"
            ? "ë…¸ì¶œ ë²”ìœ„ë¥¼ 'ì„¸ì…˜ë³„'ë¡œ ë‘ê³  ê°•ì˜ì™€ ì°¨ì‹œë¥¼ ì„ íƒí•˜ë©´ í•´ë‹¹ ì°¨ì‹œ ê³µì§€ë¥¼ ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."
            : "ë…¸ì¶œ ë²”ìœ„ë¥¼ 'ê°•ì˜ë³„'ë¡œ ë‘ê³  ìœ„ì—ì„œ ê°•ì˜ë¥¼ ì„ íƒí•˜ë©´ í•´ë‹¹ ê°•ì˜ì˜ ê³µì§€ë¥¼ ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."
        }
      />
    );
  }

  const canCreate = scope === "all" || (scope === "lecture" && effectiveLectureId) || (scope === "session" && sessionId);

  return (
    <div className="flex flex-col gap-4">
      <div className="flex items-center justify-between">
        <span
          style={{
            fontSize: "var(--text-sm)",
            fontWeight: "var(--font-title)",
            color: "var(--color-text-muted)",
          }}
        >
          {scope === "all" ? "ì „ì²´ ê³µì§€" : scope === "session" ? "í•´ë‹¹ ì°¨ì‹œ ê³µì§€" : "í•´ë‹¹ ê°•ì˜ ê³µì§€"} Â· {posts.length}ê°œ
        </span>
        {canCreate && (
          <Button intent="primary" size="sm" onClick={() => setShowCreate(true)}>
            + ê³µì§€ ì‘ì„±
          </Button>
        )}
      </div>

      {categories.length > 0 && (
        <div className="flex flex-wrap gap-2">
          <Button
            intent={selectedCategoryId === null ? "secondary" : "ghost"}
            size="sm"
            onClick={() => setSelectedCategoryId(null)}
          >
            ì „ì²´
          </Button>
          {categories.map((c) => (
            <Button
              key={c.id}
              intent={selectedCategoryId === c.id ? "secondary" : "ghost"}
              size="sm"
              onClick={() => setSelectedCategoryId(c.id)}
            >
              {c.label}
            </Button>
          ))}
        </div>
      )}

      {loadingPosts ? (
        <EmptyState scope="panel" tone="loading" title="ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦" />
      ) : posts.length === 0 ? (
        <EmptyState
          scope="panel"
          title="ë“±ë¡ëœ ê³µì§€ê°€ ì—†ìŠµë‹ˆë‹¤."
          description="ìœ„ 'ê³µì§€ ì‘ì„±'ìœ¼ë¡œ ë“±ë¡í•˜ê±°ë‚˜, ë…¸ì¶œ ë²”ìœ„ë¥¼ ë°”ê¿” ë‹¤ë¥¸ ê³µì§€ë¥¼ í™•ì¸í•˜ì„¸ìš”."
        />
      ) : (
        <ul className="flex flex-col gap-2" style={{ listStyle: "none", padding: 0, margin: 0 }}>
          {posts.map((p) => (
            <li
              key={p.id}
              style={{
                padding: "var(--space-4)",
                borderRadius: "var(--radius-lg)",
                border: "1px solid var(--color-border-divider)",
                background: "var(--color-bg-surface)",
              }}
            >
              <div className="flex items-start justify-between gap-2">
                <div>
                  <div
                    style={{
                      fontSize: "var(--text-md)",
                      fontWeight: 700,
                      color: "var(--color-text-primary)",
                    }}
                  >
                    {p.title}
                  </div>
                  {scope === "all" && p.lecture != null && p.lecture && (
                    <span
                      style={{
                        fontSize: "var(--text-xs)",
                        color: "var(--color-text-muted)",
                        marginTop: 4,
                        display: "inline-block",
                      }}
                    >
                      {lectureTitleMap.get(p.lecture) ?? `ê°•ì˜ #${p.lecture}`}
                    </span>
                  )}
                  <div
                    style={{
                      fontSize: "var(--text-xs)",
                      color: "var(--color-text-muted)",
                      marginTop: 6,
                    }}
                  >
                    {new Date(p.created_at).toLocaleDateString("ko-KR")}
                  </div>
                </div>
              </div>
            </li>
          ))}
        </ul>
      )}

      {showCreate && canCreate && (
        <NoticeCreateModal
          scope={scope}
          scopeNodes={scopeNodes}
          scopeParams={scopeParams}
          effectiveLectureId={effectiveLectureId ?? undefined}
          sessionId={sessionId ?? undefined}
          blockTypes={categories}
          templates={templates}
          onClose={() => setShowCreate(false)}
          onSuccess={() => {
            qc.invalidateQueries({ queryKey: ["community-board-posts"] });
            setShowCreate(false);
          }}
        />
      )}
    </div>
  );
}

function NoticeCreateModal({
  scope,
  scopeNodes,
  scopeParams,
  effectiveLectureId,
  sessionId,
  blockTypes,
  templates,
  onClose,
  onSuccess,
}: {
  scope: "all" | "lecture" | "session";
  scopeNodes: ScopeNodeMinimal[];
  scopeParams: CommunityScopeParams;
  effectiveLectureId?: number;
  sessionId?: number | null;
  blockTypes: BlockType[];
  templates: PostTemplate[];
  onClose: () => void;
  onSuccess: () => void;
}) {
  const [title, setTitle] = useState("");
  const [content, setContent] = useState("");
  const [blockTypeId, setBlockTypeId] = useState<number | null>(blockTypes[0]?.id ?? null);
  const [selectedNodeId, setSelectedNodeId] = useState<number | null>(null);
  const [showSaveAsTemplate, setShowSaveAsTemplate] = useState(false);
  const [templateName, setTemplateName] = useState("");
  const qc = useQueryClient();

  const loadTemplate = (t: PostTemplate) => {
    setTitle(t.title ?? "");
    setContent(t.content ?? "");
    if (t.block_type != null) setBlockTypeId(t.block_type);
  };

  const saveAsTemplateMut = useMutation({
    mutationFn: () =>
      createPostTemplate({
        name: templateName.trim(),
        block_type: blockTypeId ?? undefined,
        title: title.trim() || undefined,
        content: content.trim() || undefined,
      }),
    onSuccess: () => {
      qc.invalidateQueries({ queryKey: ["community-post-templates"] });
      setShowSaveAsTemplate(false);
      setTemplateName("");
    },
  });

  const nodeIds = useMemo(() => {
    if (scope === "lecture" && effectiveLectureId != null) {
      const n = scopeNodes.find((x) => x.lecture === effectiveLectureId && x.session == null);
      return n ? [n.id] : [];
    }
    if (scope === "session" && effectiveLectureId != null && sessionId != null) {
      const n = scopeNodes.find(
        (x) => x.lecture === effectiveLectureId && x.session === sessionId
      );
      return n ? [n.id] : [];
    }
    if (scope === "all" && selectedNodeId != null) return [selectedNodeId];
    return [];
  }, [scope, scopeNodes, effectiveLectureId, sessionId, selectedNodeId]);

  const createMut = useMutation({
    mutationFn: () =>
      createCommunityBoardPost({
        block_type: blockTypeId ?? blockTypes[0]!.id,
        title: title.trim(),
        content: content.trim(),
        node_ids: nodeIds,
      }),
    onSuccess: () => onSuccess(),
  });

  const canSubmit =
    title.trim() &&
    content.trim() &&
    blockTypes.length > 0 &&
    (blockTypeId != null || blockTypes[0]?.id) &&
    nodeIds.length > 0;

  const courseNodes = useMemo(
    () => scopeNodes.filter((n) => n.level === "COURSE"),
    [scopeNodes]
  );

  return (
    <div
      role="dialog"
      aria-modal="true"
      style={{
        position: "fixed",
        inset: 0,
        background: "rgba(0,0,0,0.4)",
        display: "flex",
        alignItems: "center",
        justifyContent: "center",
        zIndex: 1000,
      }}
      onClick={onClose}
    >
      <div
        style={{
          background: "var(--color-bg-surface)",
          borderRadius: "var(--radius-xl)",
          padding: "var(--space-6)",
          maxWidth: 480,
          width: "90%",
          boxShadow: "var(--elevation-3)",
        }}
        onClick={(e) => e.stopPropagation()}
      >
        <h3 style={{ marginBottom: 16, fontSize: 18, fontWeight: 700 }}>ê³µì§€ ì‘ì„±</h3>
        {templates.length > 0 && (
          <div style={{ marginBottom: 12 }}>
            <label style={{ fontSize: 12, color: "var(--color-text-muted)", display: "block", marginBottom: 4 }}>
              ì–‘ì‹ì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸°
            </label>
            <select
              className="ds-input"
              style={{ width: "100%" }}
              value=""
              onChange={(e) => {
                const id = e.target.value ? Number(e.target.value) : 0;
                const t = templates.find((x) => x.id === id);
                if (t) loadTemplate(t);
                e.target.value = "";
              }}
            >
              <option value="">ì„ íƒí•˜ì„¸ìš”</option>
              {templates.map((t) => (
                <option key={t.id} value={t.id}>
                  {t.name}
                  {t.block_type_label ? ` (${t.block_type_label})` : ""}
                </option>
              ))}
            </select>
          </div>
        )}
        {blockTypes.length === 0 ? (
          <p style={{ fontSize: 13, color: "var(--color-text-muted)", marginBottom: 16 }}>
            ë¸”ë¡ íƒ€ì…ì´ ì—†ìŠµë‹ˆë‹¤. ê´€ë¦¬ì ì„¤ì •ì—ì„œ í™•ì¸í•˜ì„¸ìš”.
          </p>
        ) : (
          <>
            <div style={{ marginBottom: 12 }}>
              <label style={{ fontSize: 12, color: "var(--color-text-muted)", display: "block", marginBottom: 4 }}>
                ìœ í˜•
              </label>
              <select
                className="ds-input"
                value={blockTypeId ?? ""}
                onChange={(e) => setBlockTypeId(e.target.value ? Number(e.target.value) : null)}
                style={{ width: "100%" }}
              >
                {blockTypes.map((b) => (
                  <option key={b.id} value={b.id}>
                    {b.label}
                  </option>
                ))}
              </select>
            </div>
            {scope === "all" && (
              <div style={{ marginBottom: 12 }}>
                <label style={{ fontSize: 12, color: "var(--color-text-muted)", display: "block", marginBottom: 4 }}>
                  ë…¸ì¶œ ìœ„ì¹˜(ê°•ì˜)
                </label>
                <select
                  className="ds-input"
                  value={selectedNodeId ?? ""}
                  onChange={(e) => setSelectedNodeId(e.target.value ? Number(e.target.value) : null)}
                  style={{ width: "100%" }}
                >
                  <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                  {courseNodes.map((n) => (
                    <option key={n.id} value={n.id}>
                      {n.lecture_title}
                    </option>
                  ))}
                </select>
              </div>
            )}
            <div style={{ marginBottom: 12 }}>
              <label style={{ fontSize: 12, color: "var(--color-text-muted)", display: "block", marginBottom: 4 }}>
                ì œëª©
              </label>
              <input
                className="ds-input"
                value={title}
                onChange={(e) => setTitle(e.target.value)}
                placeholder="ì œëª©"
                style={{ width: "100%" }}
              />
            </div>
            <div style={{ marginBottom: 16 }}>
              <label style={{ fontSize: 12, color: "var(--color-text-muted)", display: "block", marginBottom: 4 }}>
                ë‚´ìš©
              </label>
              <textarea
                className="ds-input"
                value={content}
                onChange={(e) => setContent(e.target.value)}
                placeholder="ë‚´ìš©"
                rows={4}
                style={{ width: "100%", resize: "vertical" }}
              />
            </div>
          </>
        )}
        <div className="flex flex-wrap items-center justify-between gap-2">
          <div className="flex gap-2">
            {(title.trim() || content.trim()) && (
              <Button
                intent="ghost"
                size="sm"
                onClick={() => setShowSaveAsTemplate(true)}
              >
                í˜„ì¬ ë‚´ìš©ì„ ì–‘ì‹ìœ¼ë¡œ ì €ì¥
              </Button>
            )}
          </div>
          <div className="flex gap-2">
            <Button intent="secondary" size="sm" onClick={onClose}>
              ì·¨ì†Œ
            </Button>
            <Button
              intent="primary"
              size="sm"
              onClick={() => createMut.mutate()}
              disabled={!canSubmit || createMut.isPending}
            >
              {createMut.isPending ? "ë“±ë¡ ì¤‘â€¦" : "ë“±ë¡"}
            </Button>
          </div>
        </div>
      </div>

      {showSaveAsTemplate && (
        <div
          role="dialog"
          aria-modal="true"
          style={{
            position: "fixed",
            inset: 0,
            background: "rgba(0,0,0,0.35)",
            display: "flex",
            alignItems: "center",
            justifyContent: "center",
            zIndex: 1001,
          }}
          onClick={() => !saveAsTemplateMut.isPending && setShowSaveAsTemplate(false)}
        >
          <div
            style={{
              background: "var(--color-bg-surface)",
              borderRadius: "var(--radius-lg)",
              padding: "var(--space-5)",
              minWidth: 320,
              boxShadow: "var(--elevation-3)",
            }}
            onClick={(e) => e.stopPropagation()}
          >
            <h4 style={{ marginBottom: 12, fontSize: 16, fontWeight: 700 }}>ì–‘ì‹ìœ¼ë¡œ ì €ì¥</h4>
            <input
              className="ds-input"
              value={templateName}
              onChange={(e) => setTemplateName(e.target.value)}
              placeholder="ì–‘ì‹ ì´ë¦„ (ì˜ˆ: ì¤‘ê°„ê³ ì‚¬ ê³µì§€)"
              style={{ width: "100%", marginBottom: 16 }}
              disabled={saveAsTemplateMut.isPending}
            />
            <div className="flex gap-2 justify-end">
              <Button
                intent="secondary"
                size="sm"
                onClick={() => setShowSaveAsTemplate(false)}
                disabled={saveAsTemplateMut.isPending}
              >
                ì·¨ì†Œ
              </Button>
              <Button
                intent="primary"
                size="sm"
                onClick={() => templateName.trim() && saveAsTemplateMut.mutate()}
                disabled={!templateName.trim() || saveAsTemplateMut.isPending}
              >
                {saveAsTemplateMut.isPending ? "ì €ì¥ ì¤‘â€¦" : "ì €ì¥"}
              </Button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

// ë¸”ë¡ íƒ€ì…ì€ ë°±ì—”ë“œ ì‹œë“œ/ê´€ë¦¬. í”„ë¡ íŠ¸ì—ì„œ ì¹´í…Œê³ ë¦¬ ì¶”ê°€ ë¹„í™œì„±í™”.

/** ë‹¨ë… ë¼ìš°íŠ¸ìš©(ë¦¬ë‹¤ì´ë ‰íŠ¸ ëŒ€ìƒ ë“±). ê¸°ë³¸ì€ ê²Œì‹œ ê´€ë¦¬ ë‚´ ê³µì§€ì‚¬í•­ íƒ­ ì‚¬ìš© ê¶Œì¥. */
export default function NoticeBoardPage() {
  return <NoticeBoardContent />;
}


==========================================================================================
# FILE: pages/QnaBoardPage.tsx
==========================================================================================
// PATH: src/features/community/pages/QnaBoardPage.tsx
// ì»¤ë®¤ë‹ˆí‹° QnA â€” scopeì— ë”°ë¼ ëª©ë¡ + ë‹µë³€

import { useState } from "react";
import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { useCommunityScope } from "../context/CommunityScopeContext";
import {
  fetchCommunityQuestions,
  fetchQuestionAnswer,
  createAnswer,
  type Question,
} from "../api/community.api";
import { EmptyState, Button } from "@/shared/ui/ds";

export default function QnaBoardPage() {
  const qc = useQueryClient();
  const { scope, lectureId, sessionId, effectiveLectureId } = useCommunityScope();
  const [openedId, setOpenedId] = useState<number | null>(null);
  const [filterAnswered, setFilterAnswered] = useState<"all" | "pending">("all");

  const scopeParams = {
    scope,
    lectureId: effectiveLectureId ?? undefined,
    sessionId: sessionId ?? undefined,
  };

  const { data: questions = [], isLoading } = useQuery<Question[]>({
    queryKey: ["community-questions", scope, effectiveLectureId, sessionId],
    queryFn: () => fetchCommunityQuestions(scopeParams),
    enabled: scope === "all" || (scope === "lecture" && effectiveLectureId != null) || (scope === "session" && sessionId != null),
  });

  const filtered = filterAnswered === "pending"
    ? questions.filter((q) => !q.is_answered)
    : questions;

  if ((scope === "lecture" && effectiveLectureId == null) || (scope === "session" && (!effectiveLectureId || sessionId == null))) {
    return (
      <EmptyState
        scope="panel"
        title={scope === "session" ? "ê°•ì˜Â·ì°¨ì‹œë¥¼ ì„ íƒí•˜ì„¸ìš”" : "ê°•ì˜ë¥¼ ì„ íƒí•˜ì„¸ìš”"}
        description={
          scope === "session"
            ? "ë…¸ì¶œ ë²”ìœ„ë¥¼ 'ì„¸ì…˜ë³„'ë¡œ ë‘ê³  ê°•ì˜ì™€ ì°¨ì‹œë¥¼ ì„ íƒí•˜ë©´ í•´ë‹¹ ì°¨ì‹œ QnAë¥¼ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤."
            : "ë…¸ì¶œ ë²”ìœ„ë¥¼ 'ê°•ì˜ë³„'ë¡œ ë‘ê³  ìœ„ì—ì„œ ê°•ì˜ë¥¼ ì„ íƒí•˜ë©´ í•´ë‹¹ ê°•ì˜ì˜ QnAë¥¼ ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."
        }
      />
    );
  }

  return (
    <div className="flex flex-col gap-4">
      <div className="flex items-center gap-2">
        <select
          className="ds-input"
          value={filterAnswered}
          onChange={(e) => setFilterAnswered(e.target.value as "all" | "pending")}
          style={{ width: 140 }}
        >
          <option value="all">ì „ì²´</option>
          <option value="pending">ë‹µë³€ ëŒ€ê¸°</option>
        </select>
        <span
          style={{
            fontSize: "var(--text-sm)",
            color: "var(--color-text-muted)",
          }}
        >
          {filtered.length}ê±´
        </span>
      </div>

      {isLoading ? (
        <EmptyState scope="panel" tone="loading" title="ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦" />
      ) : filtered.length === 0 ? (
        <EmptyState
          scope="panel"
          title="ì§ˆë¬¸ì´ ì—†ìŠµë‹ˆë‹¤."
          description="í•™ìƒì´ ì˜¬ë¦° ì§ˆë¬¸ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤."
        />
      ) : (
        <ul className="flex flex-col gap-2" style={{ listStyle: "none", padding: 0, margin: 0 }}>
          {filtered.map((q) => (
            <li key={q.id}>
              <QuestionRow
                question={q}
                isOpen={openedId === q.id}
                onToggle={() => setOpenedId((id) => (id === q.id ? null : q.id))}
                onAnswerSuccess={() => {
                  qc.invalidateQueries({ queryKey: ["community-questions"] });
                  setOpenedId(null);
                }}
              />
            </li>
          ))}
        </ul>
      )}
    </div>
  );
}

function QuestionRow({
  question,
  isOpen,
  onToggle,
  onAnswerSuccess,
}: {
  question: Question;
  isOpen: boolean;
  onToggle: () => void;
  onAnswerSuccess: () => void;
}) {
  const { data: answer } = useQuery({
    queryKey: ["question-answer", question.id],
    queryFn: () => fetchQuestionAnswer(question.id),
    enabled: isOpen,
  });

  return (
    <div
      style={{
        padding: "var(--space-4)",
        borderRadius: "var(--radius-lg)",
        border: "1px solid var(--color-border-divider)",
        background: "var(--color-bg-surface)",
      }}
    >
      <button
        type="button"
        onClick={onToggle}
        className="w-full text-left"
        style={{
          display: "flex",
          alignItems: "center",
          justifyContent: "space-between",
          gap: 8,
        }}
      >
        <span
          style={{
            fontSize: "var(--text-md)",
            fontWeight: 600,
            color: "var(--color-text-primary)",
          }}
        >
          {question.title}
        </span>
        <span
          style={{
            fontSize: "var(--text-xs)",
            padding: "2px 8px",
            borderRadius: 999,
            background: question.is_answered
              ? "color-mix(in srgb, var(--color-primary) 15%, transparent)"
              : "var(--color-bg-surface-soft)",
            color: question.is_answered ? "var(--color-primary)" : "var(--color-text-muted)",
          }}
        >
          {question.is_answered ? "ë‹µë³€ ì™„ë£Œ" : "ë‹µë³€ ëŒ€ê¸°"}
        </span>
      </button>
      <div style={{ fontSize: "var(--text-xs)", color: "var(--color-text-muted)", marginTop: 6 }}>
        {new Date(question.created_at).toLocaleDateString("ko-KR")}
      </div>

      {isOpen && (
        <div style={{ marginTop: 16, paddingTop: 16, borderTop: "1px solid var(--color-border-divider)" }}>
          <div
            style={{
              fontSize: "var(--text-sm)",
              color: "var(--color-text-secondary)",
              whiteSpace: "pre-wrap",
            }}
          >
            {question.content}
          </div>
          {answer && (
            <div
              style={{
                marginTop: 12,
                padding: 12,
                background: "var(--color-bg-surface-soft)",
                borderRadius: "var(--radius-md)",
                fontSize: "var(--text-sm)",
              }}
            >
              <div style={{ fontWeight: 600, marginBottom: 4 }}>ë‹µë³€</div>
              <div style={{ whiteSpace: "pre-wrap" }}>{answer.content}</div>
            </div>
          )}
          {!question.is_answered && (
            <AnswerForm questionId={question.id} onSuccess={onAnswerSuccess} />
          )}
        </div>
      )}
    </div>
  );
}

function AnswerForm({ questionId, onSuccess }: { questionId: number; onSuccess: () => void }) {
  const [content, setContent] = useState("");
  const qc = useQueryClient();
  const createMut = useMutation({
    mutationFn: () => createAnswer(questionId, content),
    onSuccess: () => {
      qc.invalidateQueries({ queryKey: ["community-questions"] });
      qc.invalidateQueries({ queryKey: ["question-answer", questionId] });
      qc.invalidateQueries({ queryKey: ["admin", "notification-counts"] });
      setContent("");
      onSuccess();
    },
  });

  return (
    <div style={{ marginTop: 12 }}>
      <textarea
        className="ds-input"
        value={content}
        onChange={(e) => setContent(e.target.value)}
        placeholder="ë‹µë³€ ì…ë ¥"
        rows={3}
        style={{ width: "100%", resize: "vertical" }}
      />
      <Button
        intent="primary"
        size="sm"
        className="mt-2"
        onClick={() => createMut.mutate()}
        disabled={!content.trim() || createMut.isPending}
      >
        {createMut.isPending ? "ë“±ë¡ ì¤‘â€¦" : "ë‹µë³€ ë“±ë¡"}
      </Button>
    </div>
  );
}


==========================================================================================
# FILE: pages/ReviewBoardPage.tsx
==========================================================================================
import BoardTabs from "../components/BoardTabs";

export default function ReviewBoardPage() {
  return (
    <div className="p-6">

      <div className="mt-6 text-gray-500 text-sm">
        ì•„ì§ ë“±ë¡ëœ í›„ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤.
      </div>
    </div>
  );
}
