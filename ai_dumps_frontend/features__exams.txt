====================================================================================================
# FRONTEND FOLDER: features__exams
# ROOT PATH: C:\academyfront\src\features\exams
====================================================================================================


==========================================================================================
# FILE: readme.md
==========================================================================================
1ï¸âƒ£ ì§€ê¸ˆ ì½”ë“œ ê¸°ì¤€ìœ¼ë¡œ ë³¸ â€œì‚¬ì‹¤ ê´€ê³„â€ ì •ë¦¬
(A) ìë£Œì‹¤(Materials)ì´ ì‹¤ì œë¡œ ì±…ì„ì§€ê³  ìˆëŠ” ê²ƒë“¤

ë„¤ê°€ ì˜¬ë¦° í”„ë¡ íŠ¸ ì½”ë“œ ê¸°ì¤€ìœ¼ë¡œ ë³´ë©´, ìë£Œì‹¤ì€ ì´ë¯¸ ë‹¤ìŒì„ ì™„ì „íˆ ì†Œìœ í•œë‹¤.

âœ… ìë£Œì‹¤(Materials) ì±…ì„ (ì´ë¯¸ êµ¬í˜„ë¨)
í•­ëª©	ê·¼ê±°
ì‹œí—˜ì§€ ìƒí’ˆ(Sheet) ìƒì„±	POST /exams/ â† í”„ë¡ íŠ¸ì—ì„œëŠ” materials/api/sheets
ì‹œí—˜ì§€ ëª©ë¡/ì¡°íšŒ	listSheetsApi, getSheetApi
ë¬¸í•­ êµ¬ì¡°	getSheetQuestionsApi
ë¬¸í•­ ë°°ì 	patchSheetQuestionScoreApi
ì •ë‹µ(AnswerKey)	getSheetAnswerKeyApi, upsertSheetAnswerKeyApi
OMR ë©”íƒ€ ì¡°íšŒ	/api/v1/assets/omr/objective/meta/
OMR PDF ìƒì„±	/api/v1/assets/omr/objective/pdf/
OMR ì‹œê°ì  ë¯¸ë¦¬ë³´ê¸°	Paper ì»´í¬ë„ŒíŠ¸
â€œë‹¨ì¼ ì§„ì‹¤â€ ì„ ì–¸	UI í…ìŠ¤íŠ¸, ì €ì¥ ë¡œì§ ì „ë°˜

ğŸ‘‰ ì´ê±´ 100% â€˜ì‹œí—˜ ì „ì— ë¯¸ë¦¬ ë§Œë“œëŠ” ìƒí’ˆâ€™ì´ë‹¤.
ğŸ‘‰ Exams(ì‹¤ì œ ì‹œí—˜)ê°€ ê°œì…í•  ì—¬ì§€ê°€ ì—†ë‹¤.

(B) Exams ë„ë©”ì¸ì´ í•´ì•¼ í•  ì¼ (ê·¸ë¦¬ê³  ì‹¤ì œë¡œ í•˜ëŠ” ì¼)

ë°˜ëŒ€ë¡œ **ExamsëŠ” â€˜ì‹¤í–‰ ì»¨í…ìŠ¤íŠ¸â€™**ë‹¤.

âœ… Exams ì±…ì„ (ì´ë¯¸ ë‹¤ë¥¸ ê³³ì—ì„œ êµ¬í˜„ë¨)
í•­ëª©	ì„¤ëª…
ì‹œí—˜ ì¼ì •	open_at / close_at
ì‹œí—˜ ì„¸ì…˜	session_id
ì‘ì‹œì ë“±ë¡	enrollment
ì œì¶œ ìƒì„±	submission
AI ì±„ì  íŠ¸ë¦¬ê±°	AIJob ìƒì„±
ì±„ì  ê²°ê³¼ ì €ì¥	submission_answers
ì„±ì  ê³„ì‚°	score aggregation
í´ë¦¬ë‹‰/ì˜¤ë‹µë…¸íŠ¸	after-submit flow

ğŸ‘‰ ExamsëŠ” Materialsë¥¼ â€œì°¸ì¡°ë§Œâ€ í•´ì•¼ í•œë‹¤.
ğŸ‘‰ ì ˆëŒ€ ìˆ˜ì •í•˜ë©´ ì•ˆ ë¨.

2ï¸âƒ£ ì™œ ì§€ê¸ˆ â€œí—·ê°ˆë ¤ ë³´ì´ëŠëƒ?â€

ì´ìœ ëŠ” ë”± í•˜ë‚˜ë‹¤.

ì—”ë“œí¬ì¸íŠ¸ URLì´ /exams/ ë¼ì„œ ê·¸ë ‡ë‹¤.

í•˜ì§€ë§Œ í”„ë¡ íŠ¸ ë„ë©”ì¸ ê²½ê³„ëŠ” ì´ë¯¸ ì˜¬ë°”ë¥´ë‹¤.

// src/features/materials/api/sheets.ts
/**
 * materials(ë‹¨ì¼ì§„ì‹¤) ë‚´ë¶€ì—ì„œ "ì‹œí—˜ì§€ ìƒí’ˆ"ì„ ì¡°íšŒ/ìƒì„±í•œë‹¤.
 * - ë°±ì—”ë“œ ì—”ë“œí¬ì¸íŠ¸ê°€ /exams/ ë¼ë„ í”„ë¡ íŠ¸ ë„ë©”ì¸ ê²½ê³„ëŠ” ìœ ì§€í•œë‹¤.
 */


ì´ ì£¼ì„ì€ ì•„ì£¼ ì •í™•í•˜ê³ , ëŒ€ê¸°ì—…ì—ì„œë„ ì‹¤ì œë¡œ ì“°ëŠ” ë°©ì‹ì´ë‹¤.

ğŸ“Œ URL â‰  ë„ë©”ì¸ ì±…ì„

ğŸ“Œ ë„ë©”ì¸ ì±…ì„ì€ â€œëˆ„ê°€ ìˆ˜ì • ê¶Œí•œì„ ê°€ì§€ëŠëƒâ€

3ï¸âƒ£ ì§€ê¸ˆ ìƒíƒœë¥¼ â€œê³µì‹ ì±…ì„ ê²½ê³„â€ë¡œ í™•ì •í•˜ë©´ ì´ë ‡ê²Œ ëœë‹¤

ì•„ë˜ë¥¼ SSOTë¡œ í™•ì •í•´ë„ ëœë‹¤.

ğŸŸ¦ Materials (ìë£Œì‹¤) â€” ì‹œí—˜ì§€ ìƒí’ˆ ë„ë©”ì¸

ì‹œí—˜ ì „ì— ë§Œë“¤ì–´ì§€ëŠ”, ìˆ˜ì • ê°€ëŠ¥í•œ ëª¨ë“  ê²ƒ

Materialsê°€ ë‹¨ì¼ ì§„ì‹¤ì¸ ê²ƒ

ì‹œí—˜ì§€(Sheet)

ë¬¸í•­ ëª©ë¡/ë²ˆí˜¸

ë°°ì 

ì •ë‹µ

OMR ë©”íƒ€

OMR PDF

ì‹œê°ì  ë ˆì´ì•„ì›ƒ

Materialsì˜ ì›ì¹™

ì‹œí—˜ê³¼ ë…ë¦½ì 

ì—¬ëŸ¬ ì‹œí—˜ì—ì„œ ì¬ì‚¬ìš© ê°€ëŠ¥

ìˆ˜ì •ì€ â€œì‹œí—˜ ì‹œì‘ ì „â€ë§Œ ê°€ëŠ¥

ìˆ˜ì • ì‹œ ê¸°ì¡´ ì‹œí—˜ì— ì˜í–¥ ì—†ìŒ

ğŸŸ¥ Exams â€” ì‹œí—˜ ì‹¤í–‰ ë„ë©”ì¸

ì‹œí—˜ ì‹œì‘ ì´í›„ì˜ ëª¨ë“  ê²ƒ

Examsê°€ ë‹¨ì¼ ì§„ì‹¤ì¸ ê²ƒ

ì–´ë–¤ ì‹œí—˜ì´ ì–´ë–¤ ì‹œí—˜ì§€ë¥¼ ì“°ëŠ”ì§€

ì‘ì‹œì

ì œì¶œ

ì±„ì  ê²°ê³¼

ì ìˆ˜

í´ë¦¬ë‹‰/í”¼ë“œë°±

Examsì˜ ì›ì¹™

MaterialsëŠ” read-only

ì‹œí—˜ ì‹œì‘ í›„ Materials ë³€ê²½ ë¶ˆê°€

ê²°ê³¼ëŠ” Exams ì†Œìœ 

4ï¸âƒ£ â€œê·¸ëŸ¼ examsì— êµ¬í˜„í•´ë‘” ê²Œ ì˜ëª»ì´ëƒ?â€

âŒ ì•„ë‹ˆë‹¤.
ì§€ê¸ˆì€ â€œê¸°ìˆ ì  ìœ„ì¹˜â€ì™€ â€œë„ë©”ì¸ ì±…ì„â€ì´ ì‚´ì§ ì–´ê¸‹ë‚˜ ìˆì„ ë¿ì´ë‹¤.

ì§€ê¸ˆ ìƒíƒœë¥¼ ì •í™•íˆ í‘œí˜„í•˜ë©´

ë°±ì—”ë“œ ì•± ì´ë¦„: exams

ì‹¤ì œ ì—­í• :

materials.exams (ì‹œí—˜ì§€ ìƒí’ˆ)

runtime.exams (ì‹¤ì œ ì‹œí—˜)

ğŸ‘‰ ì´ê±´ ë¦¬íŒ©í† ë§ ëŒ€ìƒì´ì§€, ì„¤ê³„ ì˜¤ë¥˜ëŠ” ì•„ë‹˜ì´ë‹¤.

5ï¸âƒ£ ì§€ê¸ˆ ë‹¹ì¥ í•´ì•¼ í•  ê²°ë¡  ì¡°ì¹˜ (ì¤‘ìš”)
âœ… 1. ë¬¸ì„œë¡œ í™•ì •í•´ë¼ (ì´ê²Œ ì œì¼ ì¤‘ìš”)

â€œì‹œí—˜ì§€ ìƒí’ˆ(Sheet), ë¬¸í•­, ì •ë‹µ, ë°°ì , OMR ë©”íƒ€ëŠ”
Materials ë„ë©”ì¸ì˜ ë‹¨ì¼ ì§„ì‹¤ì´ë‹¤.â€

ì´ ë¬¸ì¥ í•˜ë‚˜ë©´ ëœë‹¤.

âœ… 2. Exams ìª½ì—ì„œ ì ˆëŒ€ í•˜ì§€ ë§ì•„ì•¼ í•  ê²ƒ

âŒ AnswerKey ìˆ˜ì •

âŒ ë°°ì  ìˆ˜ì •

âŒ OMR ë©”íƒ€ ì¬ê³„ì‚°

âŒ ë¬¸í•­ ìˆ˜ ë³€ê²½

âœ… 3. ë‚˜ì¤‘ì— í•  ìˆ˜ ìˆëŠ” ì„ íƒì  ì •ë¦¬ (ì§€ê¸ˆì€ X)

/exams/ â†’ /materials/sheets/

DB í…Œì´ë¸” rename

ì•± ë¶„ë¦¬

ğŸ‘‰ ì§€ê¸ˆ ë‹¨ê³„ì—ì„œëŠ” ì ˆëŒ€ í•„ìš” ì—†ìŒ

6ï¸âƒ£ ë„¤ ì§ˆë¬¸ì— ëŒ€í•œ ìµœì¢… ë‹µë³€

â€œì—¬ê¸°ê°€ ì‹œí—˜í…œí”Œë¦¿ ê´€ë¦¬ ìë£Œì‹¤ì¸ë° examsì™€ ìë£Œì‹¤ì˜ ëª…í™•í•œ ì±…ì„ê²½ê³„ êµ¬ë¶„ì„ í™•ì •ì§“ê³  ì‹¶ë‹¤. ì§€ê¸ˆ examsì— êµ¬í˜„ì„ í•´ë‘” ìƒíƒœê°™ì€ë° ë§ëŠ”ê°€?â€

âœ… ë‹µë³€

ë§ë‹¤.

êµ¬í˜„ì€ exams ì•±ì— ìˆì§€ë§Œ

ì±…ì„ì€ ì´ë¯¸ Materialsë¡œ ì •í™•íˆ ë¶„ë¦¬ë¼ ìˆë‹¤

ì§€ê¸ˆ í•„ìš”í•œ ê±´ ì´ ê²½ê³„ë¥¼ â€˜ì„ ì–¸â€™í•˜ê³  ìœ ì§€í•˜ëŠ” ê²ƒì´ì§€, ì½”ë“œë¥¼ ê°ˆì•„ì—ëŠ” ê²Œ ì•„ë‹ˆë‹¤.


==========================================================================================
# FILE: types.ts
==========================================================================================
export type ExamType = "template" | "regular";

export type ExamTabKey =
  | "setup"
  | "assets"
  | "submissions"
  | "results";

/**
 * âœ… ì„œë²„ ë‹¨ì¼ì§„ì‹¤ ê¸°ë°˜ Exam
 * exams_exam ìŠ¤í‚¤ë§ˆì™€ 1:1 ì •í•©
 */
export type Exam = {
  id: number;

  title: string;
  description: string;
  subject: string;

  exam_type: ExamType;

  is_active: boolean;
  allow_retake: boolean;
  max_attempts: number;

  pass_score: number;

  open_at: string | null;
  close_at: string | null;

  template_exam_id: number | null;

  created_at: string;
  updated_at: string;
};


==========================================================================================
# FILE: api/adminExam.ts
==========================================================================================
import api from "@/shared/api/axios";
import { Exam } from "../types";

function normalizeExam(raw: any): Exam {
  return {
    id: Number(raw.id),

    title: String(raw.title ?? ""),
    description: String(raw.description ?? ""),
    subject: String(raw.subject ?? ""),

    exam_type: raw.exam_type,

    is_active: Boolean(raw.is_active),
    allow_retake: Boolean(raw.allow_retake),
    max_attempts: Number(raw.max_attempts ?? 0),

    pass_score: Number(raw.pass_score ?? 0),

    open_at: raw.open_at ?? null,
    close_at: raw.close_at ?? null,

    template_exam_id: raw.template_exam_id ?? null,

    created_at: raw.created_at,
    updated_at: raw.updated_at,
  };
}

/**
 * GET /exams/{id}/
 */
export async function fetchAdminExam(
  examId: number
): Promise<Exam> {
  const res = await api.get(`/exams/${examId}/`);
  return normalizeExam(res.data);
}

/**
 * PATCH /exams/{id}/
 * âœ… ì„œë²„ í•„ë“œë§Œ í—ˆìš©
 */
export async function updateAdminExam(
  examId: number,
  payload: Partial<Pick<
    Exam,
    | "title"
    | "description"
    | "subject"
    | "is_active"
    | "allow_retake"
    | "max_attempts"
    | "pass_score"
    | "open_at"
    | "close_at"
  >>
): Promise<Exam> {
  const res = await api.patch(`/exams/${examId}/`, payload);
  return normalizeExam(res.data);
}

/**
 * POST /exams/{id}/recalculate/
 * (ì—†ìœ¼ë©´ no-op)
 */
export async function recalculateExam(
  examId: number
) {
  try {
    const res = await api.post(
      `/exams/${examId}/recalculate/`
    );
    return res.data;
  } catch {
    console.warn("recalculateExam not implemented");
    return null;
  }
}


==========================================================================================
# FILE: api/answerKeyApi.ts
==========================================================================================
// PATH: src/features/exams/api/answerKeyApi.ts
import { api } from "@/shared/api";

export interface AnswerKey {
  id: number;
  exam: number; // template exam id
  answers: Record<string, string>;
  created_at: string;
  updated_at: string;
}

export async function fetchAnswerKeyByExam(examId: number) {
  // backend: AnswerKeyViewSet.get_queryset() uses ?exam=<id> and resolves template
  return api.get<AnswerKey[]>(`/exams/answer-keys/`, { params: { exam: examId } });
}

export async function createAnswerKey(payload: { exam: number; answers: Record<string, string> }) {
  return api.post<AnswerKey>(`/exams/answer-keys/`, payload);
}

export async function updateAnswerKey(id: number, payload: { answers: Record<string, string> }) {
  return api.put<AnswerKey>(`/exams/answer-keys/${id}/`, payload);
}


==========================================================================================
# FILE: api/assets.ts
==========================================================================================
import api from "@/shared/api/axios";

export type ExamAssetType = "problem_pdf" | "omr_sheet";

export interface ExamAsset {
  id: number;
  exam: number;
  asset_type: ExamAssetType;
  file_key: string;
  file_type: string | null;
  file_size: number | null;
  download_url: string;
  created_at?: string;
}

function normalizeList(data: any): ExamAsset[] {
  if (Array.isArray(data)) return data;
  if (Array.isArray(data?.results)) return data.results;
  if (Array.isArray(data?.items)) return data.items;
  return [];
}

/**
 * GET /api/v1/exams/{id}/assets/
 */
export async function fetchExamAssets(
  examId: number
): Promise<ExamAsset[]> {
  const res = await api.get(`/exams/${examId}/assets/`);
  return normalizeList(res.data);
}


==========================================================================================
# FILE: api/autoQuestionsApi.ts
==========================================================================================
// PATH: src/features/exams/api/autoQuestionsApi.ts
import { api } from "@/shared/api";
import { ExamQuestion } from "./questionApi";

export type Box = [number, number, number, number]; // [x,y,w,h]

export async function postAutoQuestions(sheetId: number, boxes: Box[]) {
  // backend: POST /exams/sheets/<sheet_id>/auto-questions/  { boxes: [[x,y,w,h], ...] }
  return api.post<ExamQuestion[]>(`/exams/sheets/${sheetId}/auto-questions/`, { boxes });
}


==========================================================================================
# FILE: api/enrollments.ts
==========================================================================================
// PATH: src/features/exams/api/enrollments.ts

import api from "@/shared/api/axios";

export type ExamEnrollment = {
  id: number;
  student_id: number;
  student_name: string;
};

export async function fetchExamEnrollments(
  examId: number
): Promise<ExamEnrollment[]> {
  const res = await api.get(`/exams/${examId}/enrollments/`);

  const d = res.data;

  // âœ… ì•ˆì „ íŒŒì‹± (DRF pagination ëŒ€ì‘)
  const items =
    Array.isArray(d?.results)
      ? d.results
      : Array.isArray(d)
      ? d
      : [];

  return items.map((x: any) => ({
    id: Number(x.id),
    student_id: Number(x.student_id),
    student_name: String(x.student_name ?? ""),
  }));
}


==========================================================================================
# FILE: api/examAssetApi.ts
==========================================================================================
// PATH: src/features/exams/api/examAssetApi.ts
import { api } from "@/shared/api";

export type ExamAssetType = "problem_pdf" | "omr_sheet";

export interface ExamAsset {
  id: number;
  exam: number; // template exam id
  asset_type: ExamAssetType;
  file_key: string;
  file_type?: string | null;
  file_size?: number | null;
  download_url: string;
  created_at: string;
  updated_at: string;
}

export async function fetchExamAssets(examId: number) {
  // backend: GET /exams/<exam_id>/assets/ -> resolves template if regular
  return api.get<ExamAsset[]>(`/exams/${examId}/assets/`);
}

export async function uploadExamAsset(params: {
  examId: number;
  assetType: ExamAssetType;
  file: File;
}) {
  // backend: POST /exams/<exam_id>/assets/ (template only, locked check)
  const fd = new FormData();
  fd.append("asset_type", params.assetType);
  fd.append("file", params.file);

  return api.post<ExamAsset>(`/exams/${params.examId}/assets/`, fd, {
    headers: { "Content-Type": "multipart/form-data" },
  });
}


==========================================================================================
# FILE: api/examEnrollments.ts
==========================================================================================
import api from "@/shared/api/axios";

export type ExamEnrollmentRow = {
  enrollment_id: number;
  student_name: string;
  is_selected: boolean;
};

export type ExamEnrollmentManageResponse = {
  exam_id: number;
  session_id: number;
  items: ExamEnrollmentRow[];
};

/**
 * ë‹¨ì¼ ì§„ì‹¤:
 * - enrollment_idë§Œ ì‚¬ìš© (student_id ê¸ˆì§€)
 *
 * GET /api/v1/exams/{examId}/enrollments/?session_id=
 */
export async function fetchExamEnrollmentRows(params: {
  examId: number;
  sessionId: number;
}): Promise<ExamEnrollmentManageResponse> {
  const res = await api.get(
    `/exams/${params.examId}/enrollments/`,
    { params: { session_id: params.sessionId } }
  );
  return res.data;
}

/**
 * PUT /api/v1/exams/{examId}/enrollments/?session_id=
 */
export async function updateExamEnrollmentRows(params: {
  examId: number;
  sessionId: number;
  enrollment_ids: number[];
}) {
  const res = await api.put(
    `/exams/${params.examId}/enrollments/`,
    { enrollment_ids: params.enrollment_ids },
    { params: { session_id: params.sessionId } }
  );

  return res.data;
}


==========================================================================================
# FILE: api/exams.ts
==========================================================================================
import api from "@/shared/api/axios";
import type { Exam, ExamType } from "../types";

function normalizeExam(raw: any): Exam {
  return {
    /**
     * âœ… í•µì‹¬ FIX
     * - id ìš°ì„ 
     * - ì—†ìœ¼ë©´ exam_id fallback
     */
    id: Number(raw.id ?? raw.exam_id),

    title: String(raw.title ?? ""),
    description: String(raw.description ?? ""),
    subject: String(raw.subject ?? ""),

    exam_type: raw.exam_type as ExamType,

    is_active: Boolean(raw.is_active),
    allow_retake: Boolean(raw.allow_retake),
    max_attempts: Number(raw.max_attempts ?? 0),

    pass_score: Number(raw.pass_score ?? 0),

    open_at: raw.open_at ?? null,
    close_at: raw.close_at ?? null,

    template_exam_id: raw.template_exam_id ?? null,

    created_at: String(raw.created_at ?? ""),
    updated_at: String(raw.updated_at ?? ""),
  };
}

/**
 * GET /exams/
 */
export async function fetchExams(params?: {
  exam_type?: ExamType;
}): Promise<Exam[]> {
  const res = await api.get(`/exams/`, { params });

  const data = res.data;

  const items = Array.isArray(data)
    ? data
    : Array.isArray(data?.results)
    ? data.results
    : Array.isArray(data?.items)
    ? data.items
    : [];

  return items.map(normalizeExam);
}

/**
 * GET /exams/{id}/
 */
export async function fetchExam(
  examId: number
): Promise<Exam> {
  const res = await api.get(`/exams/${examId}/`);
  return normalizeExam(res.data);
}

/**
 * POST /exams/
 */
export async function createTemplateExam(
  payload: {
    title: string;
    subject: string;
    description?: string;
  }
): Promise<Exam> {
  const res = await api.post(`/exams/`, {
    title: payload.title,
    subject: payload.subject,
    description: payload.description ?? "",
    exam_type: "template",
  });

  return normalizeExam(res.data);
}

/**
 * POST /exams/
 */
export async function createRegularExam(
  payload: {
    title: string;
    template_exam_id: number;
    description?: string;
  }
): Promise<Exam> {
  const res = await api.post(`/exams/`, {
    title: payload.title,
    template_exam_id: payload.template_exam_id,
    description: payload.description ?? "",
    exam_type: "regular",
  });

  return normalizeExam(res.data);
}


==========================================================================================
# FILE: api/questionApi.ts
==========================================================================================
// PATH: src/features/exams/api/questionApi.ts
import { api } from "@/shared/api";

export interface ExamQuestion {
  id: number;
  sheet: number;
  number: number;
  score: number;
  image?: string;
  region_meta?: {
    x: number;
    y: number;
    w: number;
    h: number;
  };
}

export function fetchQuestionsByExam(examId: number) {
  return api.get<ExamQuestion[]>(`/exams/${examId}/questions/`);
}


==========================================================================================
# FILE: api/regularExamApi.ts
==========================================================================================
// PATH: src/features/exams/api/regularExamApi.ts
import { api } from "@/shared/api";
import { Exam } from "./examApi";

export async function createRegularExam(params: {
  title: string;
  description?: string;
  template_exam_id: number;
  session_id: number;
}) {
  return api.post<Exam>("/exams/", {
    exam_type: "regular",
    title: params.title,
    description: params.description,
    template_exam_id: params.template_exam_id,
    session_id: params.session_id,
  });
}


==========================================================================================
# FILE: api/sessionEnrollments.ts
==========================================================================================
/**
 * PATH: src/features/exams/api/sessionEnrollments.ts
 *
 * âœ… SessionEnrollment API
 *
 * ì„¤ê³„ ê³„ì•½ (LOCKED):
 * - ë‹¨ì¼ ì§„ì‹¤: SessionEnrollment
 * - í•™ìƒ ì‹ë³„ì: enrollment_id (student_id âŒ)
 *
 * API:
 * GET /api/v1/enrollments/session-enrollments/?session={sessionId}
 *
 * ë°©ì–´ ì •ì±…:
 * - 404 / 501 â†’ ë¹ˆ ë°°ì—´ ë°˜í™˜ (UI ê¹¨ì§ ë°©ì§€)
 * - ê·¸ ì™¸ ì—ëŸ¬ â†’ throw
 */

import api from "@/shared/api/axios";
import axios from "axios";

export type SessionEnrollment = {
  id: number;
  session: number;
  enrollment: number; // â­ ë‹¨ì¼ ì§„ì‹¤
  student_name: string;
  created_at: string;
};

export async function fetchSessionEnrollments(
  sessionId: number
): Promise<SessionEnrollment[]> {
  try {
    const res = await api.get(
      `/enrollments/session-enrollments/`, // âœ… FIX: enrollments (s í¬í•¨)
      {
        params: { session: sessionId },
      }
    );

    /**
     * DRF pagination ëŒ€ì‘
     */
    if (Array.isArray(res.data?.results)) {
      return res.data.results as SessionEnrollment[];
    }

    if (Array.isArray(res.data)) {
      return res.data as SessionEnrollment[];
    }

    return [];
  } catch (err: any) {
    /**
     * ğŸ”’ ë°©ì–´ ê·œì¹™ (í•©ì˜ë¨)
     * - ì•„ì§ API ë¯¸êµ¬í˜„ / ê¶Œí•œ ì—†ìŒ â†’ ë¹ˆ ë°°ì—´
     */
    if (axios.isAxiosError(err)) {
      const status = err.response?.status;

      if (status === 404 || status === 501) {
        console.warn(
          "[SessionEnrollment] API not available yet. Return empty list."
        );
        return [];
      }
    }

    // ì§„ì§œ ì¥ì• ëŠ” ê·¸ëŒ€ë¡œ throw
    throw err;
  }
}


==========================================================================================
# FILE: api/templateEditorApi.ts
==========================================================================================
// PATH: src/features/exams/api/templateEditorApi.ts
import { api } from "@/shared/api";

export interface TemplateEditorSummary {
  exam_id: number;
  title: string;
  subject: string;
  sheet_id: number;
  total_questions: number;
  has_answer_key: boolean;
  is_locked: boolean;
}

export interface TemplateValidationResult {
  template_exam_id: number;
  ok: boolean;
  reason?: string;
}

export function fetchTemplateEditor(examId: number) {
  return api.get<TemplateEditorSummary>(`/exams/${examId}/template-editor/`);
}

export function fetchTemplateValidation(examId: number) {
  return api.get<TemplateValidationResult>(
    `/exams/${examId}/template-validation/`
  );
}


==========================================================================================
# FILE: components/AdminExamDetail.tsx
==========================================================================================
import { useState } from "react";
import { useAdminExam } from "../hooks/useAdminExam";

import ExamTabs from "./common/ExamTabs";
import ExamHeader from "./common/ExamHeader";

import ExamSetupPanel from "../panels/setup/ExamSetupPanel";
import ExamAssetsPanel from "../panels/ExamAssetsPanel";
import ExamSubmissionsPanel from "../panels/ExamSubmissionsPanel";
import ExamResultsViewerPanel from "../panels/ExamResultsViewerPanel";

export default function AdminExamDetail({ examId }: { examId: number }) {
  const { data: exam, isLoading } = useAdminExam(examId);
  const [tab, setTab] = useState<"setup" | "assets" | "submissions" | "results">(
    "setup"
  );

  if (isLoading) return <div>Loading...</div>;
  if (!exam) return <div>ì‹œí—˜ ì—†ìŒ</div>;

  return (
    <div className="space-y-6">
      <ExamHeader exam={exam} />

      <ExamTabs
        activeTab={tab}
        onChange={setTab}
        hasSession={true}
        assetsReady={true}
      />

      {tab === "setup" && <ExamSetupPanel examId={examId} />}
      {tab === "assets" && <ExamAssetsPanel examId={examId} />}
      {tab === "submissions" && <ExamSubmissionsPanel examId={examId} />}
      {tab === "results" && <ExamResultsViewerPanel examId={examId} />}
    </div>
  );
}


==========================================================================================
# FILE: components/AnswerKeyEditor.tsx
==========================================================================================
// PATH: src/features/exams/components/AnswerKeyEditor.tsx
import { useEffect, useMemo, useState } from "react";
import {
  createAnswerKey,
  fetchAnswerKeyByExam,
  updateAnswerKey,
  AnswerKey,
} from "../api/answerKeyApi";
import { fetchQuestionsByExam, ExamQuestion } from "../api/questionApi";

interface Props {
  examId: number; // template or regular id (backend resolves)
  disabled: boolean; // template lockedì´ë©´ true (ì •ë‹µ ë³€ê²½ ê¸ˆì§€ ì •ì±… ë°˜ì˜)
}

function normalizeAnswers(input: Record<string, string>) {
  const out: Record<string, string> = {};
  Object.entries(input || {}).forEach(([k, v]) => {
    out[String(k)] = String(v ?? "").trim();
  });
  return out;
}

export function AnswerKeyEditor({ examId, disabled }: Props) {
  const [questions, setQuestions] = useState<ExamQuestion[]>([]);
  const [answerKey, setAnswerKey] = useState<AnswerKey | null>(null);
  const [draft, setDraft] = useState<Record<string, string>>({});
  const [busy, setBusy] = useState(false);
  const [msg, setMsg] = useState<string>("");

  useEffect(() => {
    async function load() {
      const q = await fetchQuestionsByExam(examId);
      setQuestions(q.data);

      const ak = await fetchAnswerKeyByExam(examId);
      const first = (ak.data || [])[0] ?? null;
      setAnswerKey(first);
      setDraft(first ? normalizeAnswers(first.answers) : {});
    }
    load();
  }, [examId]);

  const sorted = useMemo(() => {
    return [...questions].sort((a, b) => a.number - b.number);
  }, [questions]);

  async function save() {
    if (disabled) return;

    setBusy(true);
    setMsg("");

    try {
      const normalized = normalizeAnswers(draft);

      if (!answerKey) {
        // âš ï¸ backend contract: create needs template exam id
        // ì—¬ê¸°ì„œëŠ” backendê°€ regular->template resolveë¥¼ createì— ì ìš©í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ
        // ì´ EditorëŠ” "í…œí”Œë¦¿ í™”ë©´ì—ì„œ" ì“°ëŠ” ê²ƒì´ ì•ˆì „ (SSOT ì¤€ìˆ˜).
        // (ì •ê·œì‹œí—˜ í™”ë©´ì—ì„œëŠ” ì¡°íšŒë§Œ í—ˆìš©í•˜ëŠ” í˜•íƒœë¡œ ì‚¬ìš©í•  ì˜ˆì •)
        const created = await createAnswerKey({ exam: examId, answers: normalized });
        setAnswerKey(created.data);
        setMsg("ì €ì¥ ì™„ë£Œ");
      } else {
        const updated = await updateAnswerKey(answerKey.id, { answers: normalized });
        setAnswerKey(updated.data);
        setMsg("ì €ì¥ ì™„ë£Œ");
      }
    } catch (e: any) {
      setMsg(e?.response?.data?.detail || "ì €ì¥ ì‹¤íŒ¨");
    } finally {
      setBusy(false);
    }
  }

  return (
    <section className="space-y-2">
      <div className="flex items-center justify-between">
        <h3 className="font-medium">ì •ë‹µí‘œ</h3>

        <div className="flex items-center gap-2">
          {disabled && (
            <span className="text-xs text-red-500">
              í…œí”Œë¦¿ì´ ì´ë¯¸ ì‚¬ìš© ì¤‘ì´ë¼ ì •ë‹µ ìˆ˜ì •ì´ ë´‰ì¸ë©ë‹ˆë‹¤
            </span>
          )}
          <button
            onClick={save}
            disabled={disabled || busy}
            className={`px-3 py-2 rounded text-sm ${
              disabled || busy
                ? "bg-gray-300 text-gray-500 cursor-not-allowed"
                : "bg-black text-white"
            }`}
          >
            ì €ì¥
          </button>
        </div>
      </div>

      {msg && <div className="text-xs text-gray-600">{msg}</div>}

      <div className="border rounded">
        {sorted.length === 0 && (
          <div className="p-3 text-sm text-gray-400">ë¬¸í•­ì´ ì—†ìŠµë‹ˆë‹¤.</div>
        )}

        {sorted.map((q) => {
          const key = String(q.id);
          return (
            <div key={q.id} className="flex items-center gap-3 border-b p-2 text-sm">
              <div className="w-12 text-right font-medium">{q.number}</div>

              <input
                disabled={disabled}
                value={draft[key] ?? ""}
                onChange={(ev) => setDraft((prev) => ({ ...prev, [key]: ev.target.value }))}
                className={`flex-1 border rounded px-2 py-1 ${
                  disabled ? "bg-gray-100 text-gray-500" : ""
                }`}
                placeholder="ì •ë‹µ ì…ë ¥"
              />

              <div className="w-16 text-right text-gray-500">
                {q.score}
              </div>
            </div>
          );
        })}
      </div>

      <div className="text-xs text-gray-400">
        * ì €ì¥ ë‹¨ìœ„: key = ExamQuestion.id (string), value = ì •ë‹µ
      </div>
    </section>
  );
}


==========================================================================================
# FILE: components/AssetReadinessBadge.tsx
==========================================================================================
// PATH: src/features/exams/components/AssetReadinessBadge.tsx
import { ExamAsset } from "../api/assets";
import { isAssetsReady } from "../hooks/useExamAssets";

export default function AssetReadinessBadge({ assets }: { assets: ExamAsset[] }) {
  const ready = isAssetsReady(assets);

  return (
    <span
      className={[
        "rounded-full px-3 py-1 text-xs",
        ready
          ? "bg-emerald-600/10 text-emerald-600"
          : "bg-red-600/10 text-red-600",
      ].join(" ")}
    >
      {ready ? "ìš´ì˜ ì¤€ë¹„ ì™„ë£Œ" : "ìì‚° ëˆ„ë½"}
    </span>
  );
}


==========================================================================================
# FILE: components/AttemptSelectorPanel.tsx
==========================================================================================
import { useQuery } from "@tanstack/react-query";
import api from "@/shared/api/axios";

type Attempt = {
  id: number;
  attempt_index: number;
  is_representative: boolean;
  score: number | null;
};

export default function AttemptSelectorPanel({
  examId,
  enrollmentId,
}: {
  examId: number;
  enrollmentId: number;
}) {
  const q = useQuery({
    queryKey: ["attempts", examId, enrollmentId],
    queryFn: async () => {
      const res = await api.get(
        `/results/admin/exams/${examId}/enrollments/${enrollmentId}/attempts/`
      );
      return res.data as Attempt[];
    },
    enabled:
      Number.isFinite(examId) &&
      Number.isFinite(enrollmentId),
  });

  if (q.isLoading) return <div>ë¡œë”©...</div>;
  if (q.isError) return <div>ì¡°íšŒ ì‹¤íŒ¨</div>;

  return (
    <div className="space-y-2">
      {q.data?.map((a) => (
        <div
          key={a.id}
          className="border rounded px-3 py-2 text-sm"
        >
          Attempt #{a.attempt_index} Â· ì ìˆ˜: {a.score ?? "-"}{" "}
          {a.is_representative && "â­"}
        </div>
      ))}
    </div>
  );
}


==========================================================================================
# FILE: components/AutoQuestionsImporter.tsx
==========================================================================================
// PATH: src/features/exams/components/AutoQuestionsImporter.tsx
import { useState } from "react";
import { postAutoQuestions, Box } from "../api/autoQuestionsApi";

interface Props {
  sheetId: number;
  disabled: boolean; // template locked
  onDone?: () => void;
}

/**
 * ëª©ì :
 * - Vision/Segmentation worker ê²°ê³¼(JSON boxes)ë¥¼ ê·¸ëŒ€ë¡œ ë¶™ì—¬ë„£ì–´ ë°˜ì˜
 * - í´ë¦­ ìµœì†Œí™”, í‚¤ë³´ë“œ ì¤‘ì‹¬
 */
export function AutoQuestionsImporter({ sheetId, disabled, onDone }: Props) {
  const [raw, setRaw] = useState("");
  const [busy, setBusy] = useState(false);
  const [msg, setMsg] = useState("");

  function parseBoxes(): Box[] {
    const parsed = JSON.parse(raw);
    if (!Array.isArray(parsed)) {
      throw new Error("boxes must be an array");
    }
    return parsed.map((b) => {
      if (!Array.isArray(b) || b.length !== 4) {
        throw new Error("each box must be [x,y,w,h]");
      }
      return [Number(b[0]), Number(b[1]), Number(b[2]), Number(b[3])] as Box;
    });
  }

  async function submit() {
    if (disabled) return;
    setBusy(true);
    setMsg("");

    try {
      const boxes = parseBoxes();
      await postAutoQuestions(sheetId, boxes);
      setMsg("ë¬¸í•­ ìƒì„± ì™„ë£Œ");
      setRaw("");
      onDone?.();
    } catch (e: any) {
      setMsg(e?.response?.data?.detail || e.message || "ì‹¤íŒ¨");
    } finally {
      setBusy(false);
    }
  }

  return (
    <section className="space-y-2">
      <h3 className="font-medium">ë¬¸í•­ ìë™ ìƒì„± (AI ê²°ê³¼ ì…ë ¥)</h3>

      {disabled && (
        <div className="text-xs text-red-500">
          í…œí”Œë¦¿ì´ ì´ë¯¸ ì‚¬ìš© ì¤‘ì´ë¼ ë¬¸í•­ êµ¬ì¡° ë³€ê²½ì´ ë´‰ì¸ë©ë‹ˆë‹¤
        </div>
      )}

      <textarea
        disabled={disabled}
        value={raw}
        onChange={(e) => setRaw(e.target.value)}
        rows={6}
        placeholder='[[x,y,w,h], ...]'
        className="w-full border rounded p-2 text-sm font-mono"
      />

      <div className="flex items-center gap-2">
        <button
          disabled={disabled || busy}
          onClick={submit}
          className={`px-3 py-2 rounded text-sm ${
            disabled || busy
              ? "bg-gray-300 text-gray-500"
              : "bg-black text-white"
          }`}
        >
          ì ìš©
        </button>

        {busy && <span className="text-xs text-gray-400">ì²˜ë¦¬ ì¤‘â€¦</span>}
        {msg && <span className="text-xs text-gray-600">{msg}</span>}
      </div>
    </section>
  );
}


==========================================================================================
# FILE: components/BlockReason.tsx
==========================================================================================
// PATH: src/features/exams/components/BlockReason.tsx
export default function BlockReason({
  title,
  description,
}: {
  title: string;
  description: string;
}) {
  return (
    <div className="rounded border border-red-600/30 bg-red-600/10 p-4 text-sm text-red-700">
      <div className="font-semibold">{title}</div>
      <div className="mt-1">{description}</div>
    </div>
  );
}


==========================================================================================
# FILE: components/ExamAssetManager.tsx
==========================================================================================
// PATH: src/features/exams/components/ExamAssetManager.tsx
import { useEffect, useState } from "react";
import {
  fetchExamAssets,
  uploadExamAsset,
  ExamAsset,
  ExamAssetType,
} from "../api/examAssetApi";

interface Props {
  examId: number; // template or regular id (backend resolves on GET)
  disabled: boolean; // template lockedì´ë©´ true (ì—…ë¡œë“œ ë´‰ì¸ ì •ì±… ë°˜ì˜)
}

const ASSET_LABEL: Record<ExamAssetType, string> = {
  problem_pdf: "ë¬¸ì œ PDF",
  omr_sheet: "OMR ë‹µì•ˆì§€",
};

export function ExamAssetManager({ examId, disabled }: Props) {
  const [items, setItems] = useState<ExamAsset[]>([]);
  const [busy, setBusy] = useState(false);
  const [msg, setMsg] = useState("");

  async function reload() {
    const res = await fetchExamAssets(examId);
    setItems(res.data || []);
  }

  useEffect(() => {
    reload();
  }, [examId]);

  async function onUpload(assetType: ExamAssetType, file: File | null) {
    if (!file || disabled) return;

    setBusy(true);
    setMsg("");

    try {
      await uploadExamAsset({ examId, assetType, file });
      await reload();
      setMsg("ì—…ë¡œë“œ ì™„ë£Œ");
    } catch (e: any) {
      setMsg(e?.response?.data?.detail || "ì—…ë¡œë“œ ì‹¤íŒ¨");
    } finally {
      setBusy(false);
    }
  }

  function find(type: ExamAssetType) {
    return items.find((x) => x.asset_type === type) ?? null;
  }

  return (
    <section className="space-y-2">
      <div className="flex items-center justify-between">
        <h3 className="font-medium">ì‹œí—˜ ìì‚°</h3>
        {disabled && (
          <span className="text-xs text-red-500">
            í…œí”Œë¦¿ì´ ì´ë¯¸ ì‚¬ìš© ì¤‘ì´ë¼ ìì‚° êµì²´ê°€ ë´‰ì¸ë©ë‹ˆë‹¤
          </span>
        )}
      </div>

      {msg && <div className="text-xs text-gray-600">{msg}</div>}

      <div className="border rounded divide-y">
        {(Object.keys(ASSET_LABEL) as ExamAssetType[]).map((t) => {
          const existing = find(t);
          return (
            <div key={t} className="p-3 flex items-center gap-3">
              <div className="w-28 text-sm font-medium">{ASSET_LABEL[t]}</div>

              <div className="flex-1 text-xs text-gray-500">
                {existing ? (
                  <>
                    <span className="mr-2">{existing.file_key}</span>
                    <span className="mr-2">
                      {existing.file_size ? `${existing.file_size} bytes` : ""}
                    </span>
                  </>
                ) : (
                  <span>ë“±ë¡ëœ íŒŒì¼ ì—†ìŒ</span>
                )}
              </div>

              {existing?.download_url && (
                <a
                  className="text-sm underline"
                  href={existing.download_url}
                  target="_blank"
                  rel="noreferrer"
                >
                  ë‹¤ìš´ë¡œë“œ
                </a>
              )}

              <label className={`text-sm px-3 py-2 rounded border cursor-pointer ${
                disabled || busy ? "bg-gray-100 text-gray-400 cursor-not-allowed" : "bg-white"
              }`}>
                êµì²´ ì—…ë¡œë“œ
                <input
                  type="file"
                  className="hidden"
                  disabled={disabled || busy}
                  onChange={(ev) => onUpload(t, ev.target.files?.[0] ?? null)}
                />
              </label>
            </div>
          );
        })}
      </div>

      {busy && <div className="text-xs text-gray-400">ì²˜ë¦¬ ì¤‘...</div>}
    </section>
  );
}


==========================================================================================
# FILE: components/ExamCreateErrorBox.tsx
==========================================================================================
// PATH: src/features/exams/components/ExamCreateErrorBox.tsx
export default function ExamCreateErrorBox({ error }: { error: any }) {
  if (!error) return null;

  const status = error?.response?.status;
  const detail = error?.response?.data?.detail;

  let message = "ì‹œí—˜ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.";

  if (status === 400) {
    if (detail?.includes("template")) {
      message = "í…œí”Œë¦¿ ì„ íƒì´ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.";
    } else if (detail?.includes("session")) {
      message = "ì°¨ì‹œ(session) ì„ íƒì´ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.";
    } else {
      message = "ì…ë ¥ê°’ì„ ë‹¤ì‹œ í™•ì¸í•˜ì„¸ìš”.";
    }
  }

  if (status === 403) {
    message = "ì„ ìƒë‹˜ ë˜ëŠ” ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.";
  }

  return (
    <div className="rounded border border-red-600/30 bg-red-600/10 p-3 text-sm text-red-700">
      {message}
    </div>
  );
}


==========================================================================================
# FILE: components/ExamTargetEditModal.tsx
==========================================================================================
// PATH: src/features/exams/components/ExamTargetEditModal.tsx

import { useEffect, useState } from "react";
import api from "@/shared/api/axios";

type SessionEnrollment = {
  enrollment: number;
  student_name: string;
};

export default function ExamTargetEditModal({
  sessionId,
  open,
  onClose,
}: {
  sessionId: number;
  open: boolean;
  onClose: () => void;
}) {
  const [rows, setRows] = useState<SessionEnrollment[]>([]);
  const [loading, setLoading] = useState(false);

  useEffect(() => {
    if (!open) return;

    setLoading(true);
    api
      .get("/enrollments/session-enrollments/", {
        params: { session: sessionId },
      })
      .then((res) => {
        setRows(res.data?.results ?? res.data ?? []);
      })
      .finally(() => setLoading(false));
  }, [open, sessionId]);

  if (!open) return null;

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/40">
      <div className="w-[520px] rounded bg-surface shadow">
        <div className="border-b px-4 py-3 flex justify-between">
          <div className="text-sm font-semibold">ì‹œí—˜ ëŒ€ìƒ í•™ìƒ</div>
          <button onClick={onClose} className="text-sm text-muted">
            ë‹«ê¸°
          </button>
        </div>

        <div className="max-h-[60vh] overflow-auto px-4 py-3">
          {loading ? (
            <div className="text-sm text-muted">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
          ) : (
            <ul className="space-y-1 text-sm">
              {rows.map((r) => (
                <li
                  key={r.enrollment}
                  className="flex justify-between rounded border px-3 py-2"
                >
                  <span>{r.student_name}</span>
                  <span className="text-xs text-muted">
                    #{r.enrollment}
                  </span>
                </li>
              ))}
            </ul>
          )}
        </div>

        <div className="border-t px-4 py-2 text-right">
          <button className="btn" onClick={onClose}>
            ë‹«ê¸°
          </button>
        </div>
      </div>
    </div>
  );
}


==========================================================================================
# FILE: components/QuestionEditorRow.tsx
==========================================================================================
// PATH: src/features/exams/components/QuestionEditorRow.tsx
import { ExamQuestion } from "../api/questionApi";

interface Props {
  question: ExamQuestion;
  disabled: boolean;
}

export function QuestionEditorRow({ question, disabled }: Props) {
  return (
    <div
      className="flex items-center gap-3 border-b py-2 text-sm"
      tabIndex={0}
    >
      <div className="w-10 text-right font-medium">
        {question.number}
      </div>

      <div className="flex-1 text-gray-700">
        ì ìˆ˜: {question.score}
        {question.region_meta && (
          <span className="ml-2 text-xs text-gray-400">
            bbox ìˆìŒ
          </span>
        )}
      </div>

      {disabled && (
        <div className="text-xs text-red-500">
          LOCKED
        </div>
      )}
    </div>
  );
}


==========================================================================================
# FILE: components/RegularExamCreatePanel.tsx
==========================================================================================
// PATH: src/features/exams/components/RegularExamCreatePanel.tsx
import { useState } from "react";
import { createRegularExam } from "../api/regularExamApi";

interface Props {
  templateExamId: number;
  sessionId: number;
  onCreated?: (examId: number) => void;
}

/**
 * ëª©ì :
 * - template â†’ ì‹¤ì œ ìš´ì˜ ì‹œí—˜ ìƒì„±
 * - subject/êµ¬ì¡°ëŠ” ì„œë²„ ë‹¨ì¼ì§„ì‹¤
 */
export function RegularExamCreatePanel({
  templateExamId,
  sessionId,
  onCreated,
}: Props) {
  const [title, setTitle] = useState("");
  const [desc, setDesc] = useState("");
  const [busy, setBusy] = useState(false);
  const [msg, setMsg] = useState("");

  async function submit() {
    setBusy(true);
    setMsg("");

    try {
      const res = await createRegularExam({
        title,
        description: desc,
        template_exam_id: templateExamId,
        session_id: sessionId,
      });
      setMsg("ì‹œí—˜ ìƒì„± ì™„ë£Œ");
      setTitle("");
      setDesc("");
      onCreated?.(res.data.id);
    } catch (e: any) {
      setMsg(e?.response?.data?.detail || "ìƒì„± ì‹¤íŒ¨");
    } finally {
      setBusy(false);
    }
  }

  return (
    <section className="space-y-2">
      <h3 className="font-medium">ìš´ì˜ ì‹œí—˜ ìƒì„±</h3>

      <input
        value={title}
        onChange={(e) => setTitle(e.target.value)}
        placeholder="ì‹œí—˜ëª…"
        className="w-full border rounded px-2 py-1 text-sm"
      />

      <textarea
        value={desc}
        onChange={(e) => setDesc(e.target.value)}
        placeholder="ì„¤ëª… (ì„ íƒ)"
        rows={3}
        className="w-full border rounded p-2 text-sm"
      />

      <div className="flex items-center gap-2">
        <button
          disabled={busy || !title}
          onClick={submit}
          className={`px-3 py-2 rounded text-sm ${
            busy || !title
              ? "bg-gray-300 text-gray-500"
              : "bg-black text-white"
          }`}
        >
          ìƒì„±
        </button>

        {busy && <span className="text-xs text-gray-400">ì²˜ë¦¬ ì¤‘â€¦</span>}
        {msg && <span className="text-xs text-gray-600">{msg}</span>}
      </div>
    </section>
  );
}


==========================================================================================
# FILE: components/TemplateEditor.tsx
==========================================================================================
// PATH: src/features/exams/components/TemplateEditor.tsx
import { useEffect, useState } from "react";
import {
  fetchTemplateEditor,
  fetchTemplateValidation,
  TemplateEditorSummary,
} from "../api/templateEditorApi";
import { fetchQuestionsByExam, ExamQuestion } from "../api/questionApi";
import { QuestionEditorRow } from "./QuestionEditorRow";

interface Props {
  examId: number;
}

export function TemplateEditor({ examId }: Props) {
  const [summary, setSummary] = useState<TemplateEditorSummary | null>(null);
  const [questions, setQuestions] = useState<ExamQuestion[]>([]);
  const [validation, setValidation] = useState<{
    ok: boolean;
    reason?: string;
  } | null>(null);

  useEffect(() => {
    async function load() {
      const s = await fetchTemplateEditor(examId);
      setSummary(s.data);

      const q = await fetchQuestionsByExam(examId);
      setQuestions(q.data);

      const v = await fetchTemplateValidation(examId);
      setValidation(v.data);
    }

    load();
  }, [examId]);

  if (!summary) {
    return <div className="p-4">ë¡œë”© ì¤‘...</div>;
  }

  return (
    <div className="p-4 space-y-4">
      <header>
        <h2 className="text-xl font-semibold">
          {summary.title}
        </h2>
        <div className="text-sm text-gray-500">
          ê³¼ëª©: {summary.subject}
        </div>
      </header>

      <section>
        <div className="flex items-center justify-between mb-2">
          <h3 className="font-medium">
            ë¬¸í•­ ({questions.length})
          </h3>

          {summary.is_locked && (
            <span className="text-xs text-red-500">
              ì´ í…œí”Œë¦¿ì€ ì´ë¯¸ ì‹œí—˜ì— ì‚¬ìš© ì¤‘ì…ë‹ˆë‹¤
            </span>
          )}
        </div>

        <div className="border rounded">
          {questions.length === 0 && (
            <div className="p-4 text-sm text-gray-400">
              ì•„ì§ ë¬¸í•­ì´ ì—†ìŠµë‹ˆë‹¤.
            </div>
          )}

          {questions.map((q) => (
            <QuestionEditorRow
              key={q.id}
              question={q}
              disabled={summary.is_locked}
            />
          ))}
        </div>
      </section>

      <section className="flex justify-end gap-2">
        <button
          disabled={!validation?.ok}
          className={`px-4 py-2 rounded text-sm ${
            validation?.ok
              ? "bg-blue-600 text-white"
              : "bg-gray-300 text-gray-500 cursor-not-allowed"
          }`}
        >
          ì‹¤ì œ ì‹œí—˜ ìƒì„±
        </button>
      </section>

      {!validation?.ok && validation?.reason && (
        <div className="text-xs text-red-500">
          ì‹œí—˜ ìƒì„± ë¶ˆê°€ ì‚¬ìœ : {validation.reason}
        </div>
      )}
    </div>
  );
}


==========================================================================================
# FILE: components/assets/AssetBlockNotice.tsx
==========================================================================================
// PATH: src/features/exams/components/assets/AssetBlockNotice.tsx
export default function AssetBlockNotice({
  title,
  description,
}: {
  title: string;
  description: string;
}) {
  return (
    <div className="rounded border border-yellow-600/30 bg-yellow-600/10 p-4 text-sm text-yellow-800">
      <div className="font-semibold">{title}</div>
      <div className="mt-1">{description}</div>
    </div>
  );
}


==========================================================================================
# FILE: components/assets/AssetReadinessGate.tsx
==========================================================================================
import { ExamAsset } from "../../api/assets";
import RequireAssetsReady from "../guards/RequireAssetsReady";

/**
 * âœ… Gate ë‹¨ì¼í™”:
 * ì‹¤ì œ ë¡œì§ì€ RequireAssetsReadyê°€ ë‹¨ì¼ì§„ì‹¤.
 */
export default function AssetReadinessGate({
  assets,
  children,
}: {
  assets: ExamAsset[];
  children: React.ReactNode;
}) {
  return (
    <RequireAssetsReady assets={assets}>
      {children}
    </RequireAssetsReady>
  );
}


==========================================================================================
# FILE: components/assets/AssetUploadSection.tsx
==========================================================================================
/**
 * AssetUploadSection (Production)
 * - ë‹¨ì¼ì§„ì‹¤: exams ExamAssetView (POST /exams/{examId}/assets/)
 * - multipart: asset_type + file
 * - ì„±ê³µ ì‹œ exam-assets query invalidateë¡œ ì¦‰ì‹œ ë°˜ì˜
 */

import { useMemo, useState } from "react";
import { useQueryClient } from "@tanstack/react-query";
import api from "@/shared/api/axios";

type Props = {
  examId: number;
  assetType: string; // "problem_pdf" | "omr_sheet"
  title: string;
  accept: string;
};

function humanizeBytes(bytes: number) {
  if (!Number.isFinite(bytes) || bytes <= 0) return "-";
  const units = ["B", "KB", "MB", "GB"];
  let v = bytes;
  let i = 0;
  while (v >= 1024 && i < units.length - 1) {
    v /= 1024;
    i += 1;
  }
  return `${v.toFixed(i === 0 ? 0 : 1)} ${units[i]}`;
}

export default function AssetUploadSection({
  examId,
  assetType,
  title,
  accept,
}: Props) {
  const qc = useQueryClient();

  const [file, setFile] = useState<File | null>(null);
  const [submitting, setSubmitting] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [doneMsg, setDoneMsg] = useState<string | null>(null);

  const canSubmit = useMemo(() => {
    return (
      Number.isFinite(examId) &&
      examId > 0 &&
      !!file &&
      !submitting
    );
  }, [examId, file, submitting]);

  const upload = async () => {
    if (!canSubmit || !file) return;

    try {
      setSubmitting(true);
      setError(null);
      setDoneMsg(null);

      const form = new FormData();
      form.append("asset_type", assetType);
      form.append("file", file);

      await api.post(`/exams/${examId}/assets/`, form, {
        headers: { "Content-Type": "multipart/form-data" },
      });

      setDoneMsg("ì—…ë¡œë“œ ì™„ë£Œ");
      setFile(null);

      // âœ… ì¦‰ì‹œ ë°˜ì˜
      await qc.invalidateQueries({ queryKey: ["exam-assets", examId] });
    } catch (e: any) {
      const status = e?.response?.status;
      const detail = e?.response?.data?.detail;

      // ë°±ì—”ë“œ ë´‰ì¸ ë©”ì‹œì§€/ê¶Œí•œ/ê²€ì¦ ë©”ì‹œì§€ë¥¼ ê°€ëŠ¥í•œ ê·¸ëŒ€ë¡œ ë…¸ì¶œ
      let msg =
        detail ||
        "ì—…ë¡œë“œ ì‹¤íŒ¨. íŒŒì¼/ê¶Œí•œ/í…œí”Œë¦¿ ë´‰ì¸ ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”.";

      if (status === 403) {
        msg =
          detail ||
          "ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤. (Teacher/Admin í•„ìš” ë˜ëŠ” ìš´ì˜ì‹œí—˜ì€ ì—…ë¡œë“œ ë¶ˆê°€)";
      }

      if (status === 400) {
        msg = detail || "ìš”ì²­ ê°’ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.";
      }

      setError(String(msg));
    } finally {
      setSubmitting(false);
    }
  };

  return (
    <div className="rounded border border-[var(--border-divider)] bg-[var(--bg-surface)] p-4 space-y-3">
      <div className="flex items-start justify-between gap-3">
        <div>
          <div className="text-sm font-semibold text-[var(--text-primary)]">
            {title}
          </div>
          <div className="text-xs text-[var(--text-muted)]">
            ìš´ì˜ ì‹œí—˜ ì œì¶œ/ì±„ì ì— í•„ìš”í•©ë‹ˆë‹¤. (asset_type: <b>{assetType}</b>)
          </div>
        </div>

        <div className="text-xs text-[var(--text-muted)] text-right">
          {file ? (
            <>
              <div className="font-medium text-[var(--text-secondary)]">
                {file.name}
              </div>
              <div>{humanizeBytes(file.size)}</div>
            </>
          ) : (
            <div>íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”</div>
          )}
        </div>
      </div>

      <div className="flex flex-wrap items-center gap-2">
        <input
          type="file"
          accept={accept}
          onChange={(e) => {
            setDoneMsg(null);
            setError(null);
            const f = e.target.files?.[0] ?? null;
            setFile(f);
          }}
          disabled={submitting}
          className="text-sm"
        />

        <button
          type="button"
          className="btn-primary"
          disabled={!canSubmit}
          onClick={() => void upload()}
          title="í…œí”Œë¦¿ ì‹œí—˜ì—ì„œë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤."
        >
          {submitting ? "ì—…ë¡œë“œ ì¤‘..." : "ì—…ë¡œë“œ"}
        </button>

        {file && !submitting && (
          <button
            type="button"
            className="btn"
            onClick={() => {
              setFile(null);
              setError(null);
              setDoneMsg(null);
            }}
          >
            ì„ íƒ ì·¨ì†Œ
          </button>
        )}
      </div>

      {error && (
        <div className="rounded border border-red-600/30 bg-red-600/10 p-3 text-sm text-red-700">
          {error}
        </div>
      )}

      {doneMsg && (
        <div className="rounded border border-emerald-600/30 bg-emerald-600/10 p-3 text-sm text-emerald-700">
          {doneMsg}
        </div>
      )}

      <div className="text-xs text-[var(--text-muted)]">
        â€» í…œí”Œë¦¿ì´ ì´ë¯¸ ìš´ì˜ì‹œí—˜(regular)ì— ì˜í•´ ì‚¬ìš© ì¤‘ì´ë©´, ì„œë²„ ì •ì±…ìƒ ìì‚° êµì²´ê°€ ë´‰ì¸ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
      </div>
    </div>
  );
}


==========================================================================================
# FILE: components/common/ExamHeader.tsx
==========================================================================================
import type { Exam } from "../../types";

function deriveState(exam: Exam) {
  // âœ… ì„œë²„ ë‹¨ì¼ì§„ì‹¤ ê¸°ë°˜ íŒŒìƒ (í”„ë¡ íŠ¸ í‘œì‹œìš©)
  // - is_active + open_at/close_atë¡œ Badge ìƒíƒœë§Œ ê³„ì‚°
  const now = new Date();

  const openAt = exam.open_at ? new Date(exam.open_at) : null;
  const closeAt = exam.close_at ? new Date(exam.close_at) : null;

  if (!exam.is_active) {
    return { key: "inactive" as const, label: "ë¹„í™œì„±" };
  }

  if (openAt && now < openAt) {
    return { key: "scheduled" as const, label: "ì˜ˆì •" };
  }

  if (closeAt && now > closeAt) {
    return { key: "closed" as const, label: "ì¢…ë£Œ" };
  }

  // open_at/close_atì´ ì—†ê±°ë‚˜, í˜„ì¬ê°€ êµ¬ê°„ ì•ˆì´ë©´ ì§„í–‰ì¤‘ìœ¼ë¡œ ë³¸ë‹¤
  return { key: "open" as const, label: "ì§„í–‰ì¤‘" };
}

function Badge({ state }: { state: ReturnType<typeof deriveState> }) {
  const cls =
    state.key === "open"
      ? "bg-emerald-600/10 text-emerald-700"
      : state.key === "scheduled"
      ? "bg-blue-600/10 text-blue-700"
      : state.key === "closed"
      ? "bg-gray-600/10 text-gray-700"
      : "bg-red-600/10 text-red-700";

  return (
    <span className={`rounded-full px-3 py-1 text-xs ${cls}`}>
      {state.label}
    </span>
  );
}

export default function ExamHeader({ exam }: { exam: Exam }) {
  const state = deriveState(exam);

  return (
    <div className="space-y-2">
      <div className="flex items-start justify-between gap-3">
        <div className="space-y-1">
          <h2 className="text-lg font-semibold">{exam.title}</h2>
          <div className="text-xs text-muted">
            {exam.exam_type === "template" ? "í…œí”Œë¦¿" : "ìš´ì˜"} Â·{" "}
            {exam.subject || "ê³¼ëª© ë¯¸ì§€ì •"}
          </div>
        </div>

        <div className="flex items-center gap-2">
          <Badge state={state} />
        </div>
      </div>

      {exam.description?.trim() && (
        <div className="text-sm text-muted whitespace-pre-wrap">
          {exam.description}
        </div>
      )}

      <div className="text-xs text-muted">
        â€» ì„±ì  ì…ë ¥ Â· ì±„ì  Â· íŒì •ì€ <b>ì„¸ì…˜ &gt; ì„±ì </b> ë„ë©”ì¸ì´ ë‹¨ì¼ì§„ì‹¤ì…ë‹ˆë‹¤.
      </div>
    </div>
  );
}


==========================================================================================
# FILE: components/common/ExamTabs.tsx
==========================================================================================
import type { ExamTabKey } from "../../types";

type Props = {
  activeTab: ExamTabKey;
  onChange: (k: ExamTabKey) => void;
  hasSession: boolean;
  assetsReady: boolean;
};

const TABS: { key: ExamTabKey; label: string }[] = [
  { key: "setup", label: "ê¸°ë³¸ ì„¤ì •" },
  { key: "assets", label: "ìì‚°" },
  { key: "submissions", label: "ì œì¶œ" },
  { key: "results", label: "ê²°ê³¼" },
];

export default function ExamTabs({ activeTab, onChange }: Props) {
  return (
    <div className="flex gap-6 border-b border-[var(--border-divider)]">
      {TABS.map((t) => {
        const isActive = activeTab === t.key;

        return (
          <button
            key={t.key}
            type="button"
            onClick={() => onChange(t.key)}
            className={[
              "pb-2 text-sm border-b-2 transition-colors",
              isActive
                ? "border-[var(--color-primary)] font-semibold text-[var(--text-primary)]"
                : "border-transparent text-[var(--text-secondary)] hover:text-[var(--text-primary)]",
            ].join(" ")}
          >
            {t.label}
          </button>
        );
      })}
    </div>
  );
}


==========================================================================================
# FILE: components/common/GateNotice.tsx
==========================================================================================
/**
 * GateNotice
 *
 * WHY:
 * - ê¸°ëŠ¥ ë¹„í™œì„±ì€ "ìˆ¨ê¹€"ì´ ì•„ë‹ˆë¼ "ì´ìœ  ì„¤ëª…"ì´ ì›ì¹™
 * - session / asset / lock ê²Œì´íŠ¸ë¥¼ ê³µí†µ UXë¡œ í‘œí˜„
 * - exams / homework í˜•ì œ ë„ë©”ì¸ì—ì„œ ë™ì¼ íŒ¨í„´ ì‚¬ìš© ê°€ëŠ¥
 */

type GateNoticeProps = {
  title: string;
  description: string;
  checklist?: string[];
  cta?: {
    label: string;
    onClick: () => void;
  };
};

export default function GateNotice({
  title,
  description,
  checklist,
  cta,
}: GateNoticeProps) {
  return (
    <div className="rounded border border-[var(--border-divider)] bg-[var(--bg-surface-soft)] p-5 space-y-3">
      <div className="text-base font-semibold text-[var(--text-primary)]">
        {title}
      </div>

      <div className="text-sm text-[var(--text-secondary)]">
        {description}
      </div>

      {checklist && checklist.length > 0 && (
        <ul className="list-disc pl-5 text-sm text-[var(--text-secondary)] space-y-1">
          {checklist.map((item, idx) => (
            <li key={idx}>{item}</li>
          ))}
        </ul>
      )}

      {cta && (
        <div className="pt-2">
          <button
            type="button"
            onClick={cta.onClick}
            className="rounded bg-[var(--color-primary)] px-4 py-2 text-sm font-semibold text-white"
          >
            {cta.label}
          </button>
        </div>
      )}
    </div>
  );
}


==========================================================================================
# FILE: components/common/InfoBanner.tsx
==========================================================================================
/**
 * InfoBanner
 *
 * WHY:
 * - ë‹¨ìˆœ ê²½ê³ /ì•ˆë‚´ë¥¼ ì¹´ë“œí˜•ìœ¼ë¡œ í†µì¼
 * - results / submissions / setup ì „ë°˜ì—ì„œ ì¬ì‚¬ìš©
 */

export default function InfoBanner({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <div className="rounded border border-[var(--border-divider)] bg-[var(--bg-surface-soft)] p-3 text-sm text-[var(--text-secondary)]">
      {children}
    </div>
  );
}


==========================================================================================
# FILE: components/common/SectionHeader.tsx
==========================================================================================
/**
 * SectionHeader
 *
 * WHY:
 * - ì‹œí—˜/ê³¼ì œ ê³µí†µ ì„¹ì…˜ íƒ€ì´í¬ ê³„ì¸µ í†µì¼
 * - "í° ì œëª© + í•œ ì¤„ ìš”ì•½" íŒ¨í„´ ê³ ì •
 */

export default function SectionHeader({
  title,
  description,
}: {
  title: string;
  description?: string;
}) {
  return (
    <div className="space-y-1">
      <div className="text-base font-semibold text-[var(--text-primary)]">
        {title}
      </div>
      {description && (
        <div className="text-xs text-[var(--text-muted)]">
          {description}
        </div>
      )}
    </div>
  );
}


==========================================================================================
# FILE: components/create/CreateRegularExamModal.tsx
==========================================================================================
// PATH: src/features/exams/components/create/CreateRegularExamModal.tsx
// ------------------------------------------------------------------
// Regular Exam Create Modal (Production Grade - FINAL)
// ------------------------------------------------------------------

import { useEffect, useState } from "react";
import { useQuery } from "@tanstack/react-query";
import api from "@/shared/api/axios";

type ExamTemplate = {
  id: number;
  title: string;
  subject: string;
};

type Props = {
  open: boolean;
  onClose: () => void;
  sessionId: number;
  onCreated: (examId: number) => void;
};

export default function CreateRegularExamModal({
  open,
  onClose,
  sessionId,
  onCreated,
}: Props) {
  const [title, setTitle] = useState("");
  const [description, setDescription] = useState("");
  const [templateId, setTemplateId] = useState<number | null>(null);

  const [error, setError] = useState<string | null>(null);
  const [submitting, setSubmitting] = useState(false);

  // -----------------------------------
  // âœ… Template ëª©ë¡ ì¡°íšŒ (í•µì‹¬ ìˆ˜ì •)
  // -----------------------------------
  const { data: templates = [], isLoading } = useQuery({
    queryKey: ["exam-templates"],
    queryFn: async (): Promise<ExamTemplate[]> => {
      const res = await api.get("/exams/", {
        params: { exam_type: "template" },
      });

      const data = res.data;

      // ğŸ”¥ DRF pagination ëŒ€ì‘
      if (Array.isArray(data)) return data;
      if (Array.isArray(data?.results)) return data.results;

      return [];
    },
    enabled: open,
  });

  // -----------------------------------
  // ì´ˆê¸°í™”
  // -----------------------------------
  useEffect(() => {
    if (!open) return;
    setTitle("");
    setDescription("");
    setTemplateId(null);
    setError(null);
    setSubmitting(false);
  }, [open]);

  if (!open) return null;

  // -----------------------------------
  // ê²€ì¦
  // -----------------------------------
  const validate = () => {
    if (!title.trim()) return "ì‹œí—˜ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”.";
    if (!templateId) return "í…œí”Œë¦¿ ì‹œí—˜ì„ ì„ íƒí•˜ì„¸ìš”.";
    if (!sessionId) return "ì„¸ì…˜ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.";
    return null;
  };

  // -----------------------------------
  // ìƒì„±
  // -----------------------------------
  const handleSubmit = async () => {
    const v = validate();
    if (v) {
      setError(v);
      return;
    }

    try {
      setSubmitting(true);
      setError(null);

      const res = await api.post("/exams/", {
        title: title.trim(),
        description: description.trim(),
        exam_type: "regular",
        template_exam_id: templateId,
        session_id: sessionId,
      });

      const newExamId = res.data?.id;

      if (!newExamId) {
        throw new Error("ìƒì„±ì€ ë˜ì—ˆìœ¼ë‚˜ ID ë°˜í™˜ ì—†ìŒ");
      }

      onCreated(Number(newExamId));
      onClose();
    } catch (e: any) {
      console.error(e);

      const msg =
        e?.response?.data?.detail ||
        "ì‹œí—˜ ìƒì„± ì‹¤íŒ¨. ì…ë ¥ê°’ì„ í™•ì¸í•˜ì„¸ìš”.";

      setError(msg);
    } finally {
      setSubmitting(false);
    }
  };

  // -----------------------------------
  // UI
  // -----------------------------------
  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/40">
      <div className="w-[480px] rounded-lg bg-white p-6 shadow-xl">
        <h2 className="mb-4 text-lg font-semibold">
          ìš´ì˜ ì‹œí—˜ ìƒì„±
        </h2>

        <div className="space-y-4">
          {/* ì œëª© */}
          <div>
            <label className="text-sm font-medium">ì‹œí—˜ ì œëª©</label>
            <input
              value={title}
              onChange={(e) => setTitle(e.target.value)}
              className="mt-1 w-full rounded border px-3 py-2 text-sm"
              placeholder="ì˜ˆ: 3ì›” ëª¨ì˜ê³ ì‚¬"
            />
          </div>

          {/* í…œí”Œë¦¿ ì„ íƒ */}
          <div>
            <label className="text-sm font-medium">
              ì‹œí—˜ í…œí”Œë¦¿ (í•„ìˆ˜)
            </label>

            <select
              value={templateId ?? ""}
              onChange={(e) =>
                setTemplateId(Number(e.target.value))
              }
              className="mt-1 w-full rounded border px-3 py-2 text-sm"
            >
              <option value="">
                {isLoading ? "ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘..." : "ì„ íƒí•˜ì„¸ìš”"}
              </option>

              {templates.map((t) => (
                <option key={t.id} value={t.id}>
                  {t.title} ({t.subject})
                </option>
              ))}
            </select>

            <p className="mt-1 text-xs text-gray-500">
              â€» ê³¼ëª©(subject)ì€ í…œí”Œë¦¿ ì‹œí—˜ ê°’ì„ ë”°ë¦…ë‹ˆë‹¤.
            </p>
          </div>

          {/* ì„¤ëª… */}
          <div>
            <label className="text-sm font-medium">
              ì„¤ëª… (ì„ íƒ)
            </label>
            <textarea
              value={description}
              onChange={(e) =>
                setDescription(e.target.value)
              }
              className="mt-1 w-full rounded border px-3 py-2 text-sm"
              rows={3}
            />
          </div>

          {/* ì—ëŸ¬ */}
          {error && (
            <div className="rounded bg-red-50 p-2 text-sm text-red-600">
              {error}
            </div>
          )}

          {/* ë²„íŠ¼ */}
          <div className="flex justify-end gap-2 pt-2">
            <button
              onClick={onClose}
              className="rounded border px-4 py-2 text-sm"
              disabled={submitting}
            >
              ì·¨ì†Œ
            </button>

            <button
              onClick={handleSubmit}
              disabled={submitting}
              className="rounded bg-green-600 px-4 py-2 text-sm text-white disabled:opacity-50"
            >
              {submitting ? "ìƒì„± ì¤‘..." : "ìƒì„±"}
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}


==========================================================================================
# FILE: components/create/CreateTemplateExamModal.tsx
==========================================================================================
// PATH: src/features/exams/components/create/CreateTemplateExamModal.tsx

import { useState } from "react";
import { useMutation } from "@tanstack/react-query";
import { createTemplateExam } from "../../api/exams";
import ExamCreateErrorBox from "../ExamCreateErrorBox";

export default function CreateTemplateExamModal({
  open,
  onClose,
  onCreated,
}: {
  open: boolean;
  onClose: () => void;
  onCreated: (examId: number) => void;
}) {
  const [title, setTitle] = useState("");
  const [subject, setSubject] = useState("");
  const [description, setDescription] = useState("");

  const m = useMutation({
    mutationFn: createTemplateExam,

    onSuccess: (exam) => {
      /**
       * âœ… í•µì‹¬ FIX
       * - ì„œë²„ëŠ” id
       * - sessions íŒ¨ë„ì€ exam_id ê¸°ë°˜
       * â†’ ì—¬ê¸°ì„œ í†µì¼
       */
      const safeId =
        Number(exam?.id) ||
        Number((exam as any)?.exam_id) ||
        0;

      if (!safeId) {
        alert(
          "ì‹œí—˜ ìƒì„±ì€ ë˜ì—ˆì§€ë§Œ ID í™•ì¸ ì‹¤íŒ¨. ìƒˆë¡œê³ ì¹¨ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”."
        );
        return;
      }

      onCreated(safeId);
      onClose();
    },
  });

  if (!open) return null;

  const canSubmit = title.trim() && subject.trim();

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/40">
      <div className="w-[420px] rounded bg-surface p-6 space-y-4">
        <h2 className="text-lg font-semibold">
          ì‹œí—˜ í…œí”Œë¦¿ ìƒì„±
        </h2>

        <label className="text-sm">
          ì‹œí—˜ ì œëª©
          <input
            className="mt-1 w-full rounded border px-3 py-2"
            value={title}
            onChange={(e) => setTitle(e.target.value)}
          />
        </label>

        <label className="text-sm">
          ê³¼ëª© (í•„ìˆ˜)
          <input
            className="mt-1 w-full rounded border px-3 py-2"
            value={subject}
            onChange={(e) => setSubject(e.target.value)}
          />
        </label>

        <label className="text-sm">
          ì„¤ëª… (ì„ íƒ)
          <textarea
            className="mt-1 w-full rounded border px-3 py-2"
            value={description}
            onChange={(e) =>
              setDescription(e.target.value)
            }
          />
        </label>

        <ExamCreateErrorBox error={m.error} />

        <div className="flex justify-end gap-2 pt-2">
          <button className="btn" onClick={onClose}>
            ì·¨ì†Œ
          </button>

          <button
            className="btn-primary"
            disabled={!canSubmit || m.isPending}
            onClick={() =>
              m.mutate({
                title,
                subject,
                description:
                  description || undefined,
              })
            }
          >
            {m.isPending
              ? "ìƒì„± ì¤‘..."
              : "ìƒì„±"}
          </button>
        </div>
      </div>
    </div>
  );
}


==========================================================================================
# FILE: components/guards/RequireAssetsReady.tsx
==========================================================================================
import { ExamAsset } from "../../api/assets";

export default function RequireAssetsReady({
  assets,
  children,
}: {
  assets: ExamAsset[];
  children: React.ReactNode;
}) {
  // âœ… íŒë§¤/ì²´í—˜ ëª¨ë“œ: í•­ìƒ í†µê³¼
  return <>{children}</>;
}


==========================================================================================
# FILE: components/guards/RequireSessionContext.tsx
==========================================================================================
export default function RequireSessionContext({
  sessionId,
  children,
}: {
  sessionId?: number;
  children: React.ReactNode;
}) {
  // âœ… UX ì²´í—˜ ëª¨ë“œ: session ì—†ì–´ë„ ì „ë¶€ ë…¸ì¶œ
  return <>{children}</>;
}


==========================================================================================
# FILE: components/submissions/AdminOmrUploadSection.tsx
==========================================================================================
/**
 * AdminOmrUploadSection
 *
 * WHY:
 * - submissions ë„ë©”ì¸ì€ "ì œì¶œ ì´ë²¤íŠ¸ ìƒì„±"ê¹Œì§€ë§Œ ì±…ì„ì§„ë‹¤
 * - ì ìˆ˜/íŒì •/ìƒíƒœ í•´ì„ì€ ì ˆëŒ€ í•˜ì§€ ì•ŠëŠ”ë‹¤
 * - FINAL SPEC: POST /submissions/exams/{exam_id}/omr/ ë§Œ ì‚¬ìš©
 * - JSX ì‚¬ìš© â†’ ë°˜ë“œì‹œ .tsx
 */

import { useState } from "react";
import api from "@/shared/api/axios";

type Props = {
  examId: number;
};

export default function AdminOmrUploadSection({ examId }: Props) {
  const [enrollmentId, setEnrollmentId] = useState("");
  const [sheetId, setSheetId] = useState("");
  const [fileKey, setFileKey] = useState("");

  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [success, setSuccess] = useState<string | null>(null);

  const submit = async () => {
    setError(null);
    setSuccess(null);

    const eid = Number(enrollmentId);
    const sid = Number(sheetId);

    if (!eid || !sid || !fileKey.trim()) {
      setError("enrollment_id, sheet_id, file_keyëŠ” ëª¨ë‘ í•„ìˆ˜ì…ë‹ˆë‹¤.");
      return;
    }

    try {
      setLoading(true);

      await api.post(`/submissions/exams/${examId}/omr/`, {
        enrollment_id: eid,
        sheet_id: sid,
        file_key: fileKey.trim(),
      });

      setSuccess(
        "ì œì¶œì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹µì•ˆ ì¶”ì¶œ ë° ì±„ì ì€ ìë™ìœ¼ë¡œ ì§„í–‰ë©ë‹ˆë‹¤."
      );

      // reset
      setEnrollmentId("");
      setSheetId("");
      setFileKey("");
    } catch (e: any) {
      setError(
        e?.response?.data?.detail ??
          "ì œì¶œ ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì„¸ì…˜/ìì‚°/ID ì¡°ê±´ì„ í™•ì¸í•˜ì„¸ìš”."
      );
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="rounded border border-[var(--border-divider)] bg-[var(--bg-surface)] p-4 space-y-4">
      <div>
        <div className="text-sm font-semibold text-[var(--text-primary)]">
          OMR ì œì¶œ ë“±ë¡
        </div>
        <div className="text-xs text-[var(--text-muted)]">
          ìŠ¤ìº”ëœ OMR íŒŒì¼ì˜ ìœ„ì¹˜(file_key)ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì œì¶œ ì´ë²¤íŠ¸ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
        </div>
      </div>

      {error && (
        <div className="rounded border border-red-400 bg-red-50 p-3 text-sm text-red-700">
          {error}
        </div>
      )}

      {success && (
        <div className="rounded border border-green-400 bg-green-50 p-3 text-sm text-green-700">
          {success}
        </div>
      )}

      <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
        <input
          placeholder="enrollment_id"
          className="rounded border px-3 py-2 text-sm"
          value={enrollmentId}
          onChange={(e) => setEnrollmentId(e.target.value)}
          disabled={loading}
        />

        <input
          placeholder="sheet_id"
          className="rounded border px-3 py-2 text-sm"
          value={sheetId}
          onChange={(e) => setSheetId(e.target.value)}
          disabled={loading}
        />

        <input
          placeholder="file_key (R2 ê²½ë¡œ)"
          className="rounded border px-3 py-2 text-sm"
          value={fileKey}
          onChange={(e) => setFileKey(e.target.value)}
          disabled={loading}
        />
      </div>

      <button
        type="button"
        onClick={submit}
        disabled={loading}
        className="rounded bg-[var(--color-primary)] px-4 py-2 text-sm font-semibold text-white disabled:opacity-50"
      >
        {loading ? "ë“±ë¡ ì¤‘..." : "ì œì¶œ ë“±ë¡"}
      </button>
    </div>
  );
}


==========================================================================================
# FILE: hooks/useAdminExam.ts
==========================================================================================
//src/features/exams/hooks/useAdminExam.ts

import { useQuery } from "@tanstack/react-query";
import { fetchAdminExam } from "../api/adminExam";

/**
 * âœ… ê´€ë¦¬ì ì‹œí—˜ ìƒì„¸ ì¡°íšŒ í›…
 * - examId ì¤€ë¹„ ì „ì—” ìš”ì²­ âŒ
 */
export function useAdminExam(examId?: number) {
  const safeId = Number(examId);

  return useQuery({
    queryKey: ["admin-exam", safeId],
    queryFn: () => fetchAdminExam(safeId),
    enabled: Number.isFinite(safeId),
  });
}


==========================================================================================
# FILE: hooks/useExam.ts
==========================================================================================
// PATH: src/features/exams/hooks/useExam.ts

import { useQuery } from "@tanstack/react-query";
import api from "@/shared/api/axios";

export type ExamDetail = {
  id: number;
  title: string;
  description: string;
  subject: string;
  exam_type: "template" | "regular";
  open_at: string | null;
  close_at: string | null;
  allow_retake: boolean;
  max_attempts: number;
};

async function fetchExam(examId: number): Promise<ExamDetail> {
  const res = await api.get(`/exams/${examId}/`);
  return res.data;
}

export function useExam(examId: number | null | undefined) {
  return useQuery({
    queryKey: ["exam-detail", examId],
    queryFn: () => fetchExam(Number(examId)),

    // âœ…ğŸ”¥ Production Fix (NaN ë°©ì§€ í•µì‹¬)
    enabled: Number.isFinite(examId),

    staleTime: 1000 * 60 * 5,
  });
}


==========================================================================================
# FILE: hooks/useExamAssets.ts
==========================================================================================
/**
 * useExamAssets (ENHANCED)
 *
 * WHY:
 * - ê¸°ì¡´ ê³„ì•½ ìœ ì§€: useExamAssets()ëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ExamAsset[]ë¥¼ ë°˜í™˜í•œë‹¤.
 * - ë‹¨, Batch1ì˜ submissions UXì—ì„œ "problem_pdf/omr_sheet ì¡´ì¬ ì—¬ë¶€"ë¥¼ ì§ê´€ì ìœ¼ë¡œ ì“°ê¸° ìœ„í•´
 *   ë°˜í™˜ ë°°ì—´ì— ë³´ì¡° í”„ë¡œí¼í‹°(problem_pdf/omr_sheet)ë¥¼ ë¶€ì°©í•œë‹¤ (íƒ€ì… êµë€ ì—†ì´ í˜¸í™˜).
 * - ìƒˆ endpoint ê¸ˆì§€, ê¸°ì¡´ fetchExamAssets ê·¸ëŒ€ë¡œ ì‚¬ìš©.
 */

import { useQuery } from "@tanstack/react-query";
import { fetchExamAssets, ExamAsset } from "../api/assets";

export type ExamAssetsList = ExamAsset[] & {
  /** convenience flags (non-authoritative, UI gate only) */
  problem_pdf?: boolean;
  omr_sheet?: boolean;
};

export function useExamAssets(examId?: number) {
  return useQuery<ExamAssetsList>({
    queryKey: ["exam-assets", examId],
    queryFn: async () => {
      const list = (await fetchExamAssets(examId as number)) as ExamAssetsList;

      // âš ï¸ UI í¸ì˜ìš© flag (ì„œë²„ ë‹¨ì¼ì§„ì‹¤ = assets list)
      (list as any).problem_pdf = list.some((a) => a.asset_type === "problem_pdf");
      (list as any).omr_sheet = list.some((a) => a.asset_type === "omr_sheet");

      return list;
    },
    enabled:
      typeof examId === "number" &&
      Number.isFinite(examId) &&
      examId > 0,
  });
}

export function isAssetsReady(assets: ExamAsset[]) {
  const hasPdf = assets.some((a) => a.asset_type === "problem_pdf");
  const hasOmr = assets.some((a) => a.asset_type === "omr_sheet");
  return hasPdf && hasOmr;
}


==========================================================================================
# FILE: hooks/useExamDetail.ts
==========================================================================================
/**
 * useExamDetail
 *
 * WHY:
 * - Batch1 Submissions íŒ¨ë„ì´ "exam ìƒì„¸"ë¥¼ ê°„ë‹¨íˆ ì†Œë¹„í•  ìˆ˜ ìˆë„ë¡ ë˜í•‘
 * - ê¸°ì¡´ useExam í›…(LOCKED)ì„ ì¡´ì¤‘í•˜ê³ , ì¶”ë¡ /ê³„ì‚° ì—†ì´ ê·¸ëŒ€ë¡œ ì „ë‹¬
 * - exams ë„ë©”ì¸ ë²”ìœ„ ë‚´ì—ì„œë§Œ ì œê³µ (ìƒˆ endpoint ê¸ˆì§€)
 */

import { useExam } from "./useExam";

export function useExamDetail(examId: number) {
  return useExam(examId);
}


==========================================================================================
# FILE: hooks/useExamEnrollments.ts
==========================================================================================
import { useQuery, useMutation } from "@tanstack/react-query";
import {
  fetchExamEnrollmentRows,
  updateExamEnrollmentRows,
} from "../api/examEnrollments";

export function useExamEnrollmentRows(
  examId?: number,
  sessionId?: number
) {
  return useQuery({
    queryKey: ["exam-enrollment", examId, sessionId],
    queryFn: () =>
      fetchExamEnrollmentRows({
        examId: examId!,
        sessionId: sessionId!,
      }),
    enabled:
      Number.isFinite(examId) &&
      Number.isFinite(sessionId),
  });
}

export function useUpdateExamEnrollmentRows(
  examId: number,
  sessionId: number
) {
  return useMutation({
    mutationFn: (payload: { enrollment_ids: number[] }) =>
      updateExamEnrollmentRows({
        examId,
        sessionId,
        enrollment_ids: payload.enrollment_ids,
      }),
  });
}


==========================================================================================
# FILE: pages/ExamAdminPage.tsx
==========================================================================================
import {
  Panel,
  Section,
  KPI,
  Button,
  StatusBadge,
} from "@/shared/ui/ds";
import { DomainLayout } from "@/shared/ui/layout";

export default function ExamControlCenter() {
  return (
    <DomainLayout
      title="ìƒëª…ê³¼í•™ ì‹œí—˜ ìš´ì˜ ì„¼í„°"
      description="ê°•ì˜ Â· ì°¨ì‹œ Â· í•™êµ ë‹¨ìœ„ ì‹œí—˜ì„ í†µí•© ìš´ì˜í•©ë‹ˆë‹¤."
    >
      <div className="p-6 space-y-6">
        <div className="flex items-center justify-end">
          <Button intent="primary" size="md">
            ì‹ ê·œ ì‹œí—˜ ìƒì„±
          </Button>
        </div>

        {/* KPI */}
        <Section level="primary" title="ì‹œí—˜ ìš´ì˜ ìš”ì•½">
        <div className="grid grid-cols-4 gap-6">
          <KPI label="ìš´ì˜ ì¤‘ ì‹œí—˜" value="9" hint="ì „ì²´ ê°•ì˜ ê¸°ì¤€" />
          <KPI label="ì´ ì‘ì‹œ ì¸ì›" value="428" hint="ìµœê·¼ ì‹œí—˜ ê¸°ì¤€" />
          <KPI label="ì±„ì  ì™„ë£Œìœ¨" value="96%" hint="ìë™ + ìˆ˜ë™" />
          <KPI label="í´ë¦¬ë‹‰ ì—°ê³„" value="7" hint="ì‹œí—˜ ê¸°ì¤€" />
        </div>
      </Section>

      {/* ===============================
          EXAM TABLE
      =============================== */}
      <Panel
        title="ì‹œí—˜ ëª©ë¡"
        description="ê°•ì˜Â·í•™êµ ë‹¨ìœ„ ì‹œí—˜ì„ í•œ í™”ë©´ì—ì„œ ê´€ë¦¬í•©ë‹ˆë‹¤."
        right={
          <div className="flex items-center gap-3">
            <Button intent="ghost" size="sm">í•™êµ í•„í„°</Button>
            <Button intent="ghost" size="sm">ê°•ì˜ í•„í„°</Button>
          </div>
        }
      >
        <div>
          <table className="w-full text-sm">
            <thead>
              <tr className="text-left text-[var(--color-text-muted)]">
                <th className="py-3">ê°•ì˜</th>
                <th>ì°¨ì‹œ</th>
                <th>ì‹œí—˜ëª…</th>
                <th>ëŒ€ìƒ í•™êµ</th>
                <th>ì‘ì‹œ</th>
                <th>ìƒíƒœ</th>
                <th />
              </tr>
            </thead>

            <tbody className="divide-y divide-[var(--color-border-divider)]">
              {[
                {
                  lecture: "ê³ 3 ìƒëª…ê³¼í•™â… ",
                  session: "12ê°•",
                  title: "ìœ ì „ì ë°œí˜„ ë‹¨ì› í‰ê°€",
                  school: "ëŒ€ì¹˜ê³  Â· íœ˜ë¬¸ê³ ",
                  count: 142,
                  status: "active",
                },
                {
                  lecture: "ê³ 2 ìƒëª…ê³¼í•™ ë‚´ì‹ ",
                  session: "5ê°•",
                  title: "ì„¸í¬ ì£¼ê¸° ì¤‘ê°„ ì ê²€",
                  school: "ì¤‘ë™ê³ ",
                  count: 96,
                  status: "active",
                },
                {
                  lecture: "ê³ 1 ìƒëª…ê³¼í•™ ê¸°ì´ˆ",
                  session: "2ê°•",
                  title: "íš¨ì†Œ ë‹¨ì› í™•ì¸",
                  school: "ëŒ€ì¹˜ê³ ",
                  count: 54,
                  status: "inactive",
                },
              ].map((e, i) => (
                <tr key={i} className="hover:bg-[var(--color-bg-surface-hover)]">
                  <td className="py-4 font-semibold">{e.lecture}</td>
                  <td>{e.session}</td>
                  <td className="font-medium">{e.title}</td>
                  <td>{e.school}</td>
                  <td>{e.count}</td>
                  <td>
                    <StatusBadge status={e.status as any} />
                  </td>
                  <td className="text-right">
                    <Button intent="ghost" size="sm">
                      ê´€ë¦¬
                    </Button>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </Panel>

        <div className="text-center text-xs font-semibold text-[var(--color-text-muted)]">
          HakwonPlus Â· Biology Exam Operations Console
        </div>
      </div>
    </DomainLayout>
  );
}


==========================================================================================
# FILE: panels/ExamAssetsPanel.tsx
==========================================================================================
/**
 * ExamAssetsPanel (Production)
 * - assets ë‹¨ì¼ì§„ì‹¤: GET /exams/{id}/assets/ (regularë„ template resolve)
 * - templateì—ì„œë§Œ ì—…ë¡œë“œ UI ë…¸ì¶œ(ë´‰ì¸ ì •ì±… ì¡´ì¤‘)
 * - ìì‚° ëˆ„ë½ ì‹œ "ì œì¶œ/ì±„ì  ì°¨ë‹¨ ì‚¬ìœ " ì²´í¬ë¦¬ìŠ¤íŠ¸ ì•ˆë‚´
 */

import { useMemo } from "react";
import { useSearchParams } from "react-router-dom";

import { useAdminExam } from "../hooks/useAdminExam";
import { useExamAssets } from "../hooks/useExamAssets";

import AssetReadinessBadge from "../components/AssetReadinessBadge";
import AssetBlockNotice from "../components/assets/AssetBlockNotice";
import AssetUploadSection from "../components/assets/AssetUploadSection";
import BlockReason from "../components/BlockReason";

function hasAsset(assets: any[], t: string) {
  return (assets ?? []).some((a) => a?.asset_type === t);
}

export default function ExamAssetsPanel({ examId }: { examId: number }) {
  const { data: exam } = useAdminExam(examId);
  const q = useExamAssets(examId);
  const assets = q.data ?? [];

  const [sp] = useSearchParams();
  const sessionId = Number(sp.get("session_id"));
  const hasSession = Number.isFinite(sessionId) && sessionId > 0;

  const hasPdf = useMemo(() => hasAsset(assets, "problem_pdf"), [assets]);
  const hasOmr = useMemo(() => hasAsset(assets, "omr_sheet"), [assets]);

  if (!exam) return null;

  const isTemplate = exam.exam_type === "template";
  const isRegular = exam.exam_type === "regular";

  return (
    <div className="space-y-4">
      <div className="flex justify-between border rounded p-4 bg-[var(--bg-surface)] border-[var(--border-divider)]">
        <div>
          <div className="font-semibold text-sm text-[var(--text-primary)]">
            ì‹œí—˜ ìì‚°
          </div>
          <div className="text-xs text-[var(--text-muted)]">
            ìš´ì˜ì— í•„ìš”í•œ PDF/OMR ìƒíƒœ (ì œì¶œ/ì±„ì  ê²Œì´íŠ¸)
          </div>
        </div>

        <AssetReadinessBadge assets={assets} />
      </div>

      {q.isLoading && (
        <div className="text-sm text-[var(--text-muted)]">
          ìì‚° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
        </div>
      )}

      {q.isError && (
        <BlockReason
          title="ìì‚° ì¡°íšŒ ì‹¤íŒ¨"
          description={
            String((q.error as any)?.response?.data?.detail || "ìì‚° ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.")
          }
        />
      )}

      {!q.isLoading && !q.isError && (
        <>
          {/* âœ… ìš´ì˜ ì‹œí—˜ ì•ˆë‚´ */}
          {isRegular && (
            <AssetBlockNotice
              title="ì½ê¸° ì „ìš© (ìš´ì˜ ì‹œí—˜)"
              description="ìš´ì˜ ì‹œí—˜ì€ í…œí”Œë¦¿ ìì‚°ì„ ì‚¬ìš©í•©ë‹ˆë‹¤. ìì‚° ì—…ë¡œë“œ/êµì²´ëŠ” í…œí”Œë¦¿ ì‹œí—˜ì—ì„œë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤."
            />
          )}

          {/* âœ… ìì‚° ëˆ„ë½ ì²´í¬ë¦¬ìŠ¤íŠ¸ */}
          {(!hasPdf || !hasOmr) && (
            <div className="rounded border border-yellow-600/30 bg-yellow-600/10 p-4 text-sm text-yellow-800 space-y-2">
              <div className="font-semibold">ìš´ì˜ ë¶ˆê°€: ìì‚°ì´ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤</div>
              <div className="text-xs">
                ì•„ë˜ í•­ëª©ì´ ëª¨ë‘ ì¶©ì¡±ë˜ì–´ì•¼ ì œì¶œ/ì±„ì  ê¸°ëŠ¥ì´ ì—´ë¦½ë‹ˆë‹¤.
              </div>

              <ul className="list-disc pl-5 text-sm">
                <li className={hasPdf ? "opacity-60" : ""}>
                  ì‹œí—˜ì§€ PDF (problem_pdf) {hasPdf ? "âœ…" : "âŒ"}
                </li>
                <li className={hasOmr ? "opacity-60" : ""}>
                  OMR ë‹µì•ˆì§€ (omr_sheet) {hasOmr ? "âœ…" : "âŒ"}
                </li>
              </ul>

              {isRegular && (
                <div className="text-xs">
                  â€» ì´ ì‹œí—˜ì€ <b>ìš´ì˜ ì‹œí—˜</b>ì´ë¼ ì—¬ê¸°ì„œ ì—…ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í…œí”Œë¦¿ ì‹œí—˜ì—ì„œ ìì‚°ì„ ë“±ë¡í•œ ë’¤ ë‹¤ì‹œ í™•ì¸í•˜ì„¸ìš”.
                </div>
              )}
            </div>
          )}

          {/* âœ… session_id ì•ˆë‚´(ìì‚°ê³¼ëŠ” ë³„ê°œì§€ë§Œ ìš´ì˜ íë¦„ìƒ ê°™ì´ ë³´ì—¬ì£¼ë©´ ì¢‹ìŒ) */}
          {!hasSession && (
            <div className="rounded border bg-[var(--bg-surface-soft)] p-3 text-sm text-[var(--text-muted)]">
              â„¹ï¸ í˜„ì¬ URLì— <b>session_id</b>ê°€ ì—†ìŠµë‹ˆë‹¤. ìì‚° ë“±ë¡ê³¼ ë³„ê°œë¡œ, ì œì¶œ/ê²°ê³¼/ëŒ€ìƒì ê´€ë¦¬ëŠ” session_idê°€ ìˆì–´ì•¼ ì—´ë¦½ë‹ˆë‹¤.
            </div>
          )}

          {/* âœ… ì—…ë¡œë“œ UIëŠ” templateì—ì„œë§Œ */}
          {isTemplate && (
            <div className="space-y-4">
              <AssetUploadSection
                examId={examId}
                assetType="problem_pdf"
                title="ì‹œí—˜ì§€ PDF"
                accept="application/pdf"
              />

              <AssetUploadSection
                examId={examId}
                assetType="omr_sheet"
                title="OMR ë‹µì•ˆì§€"
                accept="application/pdf"
              />
            </div>
          )}
        </>
      )}
    </div>
  );
}


==========================================================================================
# FILE: panels/ExamResultsPanel.tsx
==========================================================================================
/**
 * ExamResultsPanel (UX wrapper)
 *
 * WHY:
 * - results ë„ë©”ì¸ì´ ë‹¨ì¼ì§„ì‹¤: ì ìˆ˜/í•©ë¶ˆ/í†µê³„ëŠ” ì—¬ê¸°ì„œ ê³„ì‚° ê¸ˆì§€
 * - exams íƒ­ì—ì„œ "ê²°ê³¼ê°€ ì–´ë””ì„œ ìƒì„±ë˜ê³  ì–´ë””ì„œ ìˆ˜ì •ë˜ëŠ”ì§€"ë¥¼ ì‚¬ëŒ ì–¸ì–´ë¡œ ì•ˆë‚´
 * - ì‹¤ì œ í‘œ/í†µê³„ëŠ” results featureì˜ ExamResultsPanelì„ ê·¸ëŒ€ë¡œ ì‚¬ìš©
 */

import ExamResultsPanelInner from "@/features/results/panels/ExamResultsPanel";

export default function ExamResultsPanel({ examId }: { examId: number }) {
  return (
    <div className="space-y-4">
      <section className="rounded border border-[var(--border-divider)] bg-[var(--bg-surface)] p-4">
        <div className="text-sm font-semibold text-[var(--text-primary)]">
          ê²°ê³¼ / í†µê³„
        </div>
        <div className="mt-1 text-xs text-[var(--text-muted)]">
          ì ìˆ˜Â·í•©ë¶ˆÂ·í†µê³„ëŠ” <b>results</b> ë„ë©”ì¸ì´ ë‹¨ì¼ ì§„ì‹¤ì´ë©°, ì´ í™”ë©´ì€ í‘œì‹œë§Œ í•©ë‹ˆë‹¤.
        </div>
      </section>

      <ExamResultsPanelInner examId={examId} />
    </div>
  );
}


==========================================================================================
# FILE: panels/ExamResultsViewerPanel.tsx
==========================================================================================
import ExamResultsPanel
  from "@/features/results/panels/ExamResultsPanel";

export default function ExamResultsViewerPanel({
  examId,
}: {
  examId: number;
}) {
  return (
    <div className="space-y-3">
      <div>
        <div className="font-semibold text-sm">
          ì‹œí—˜ ê²°ê³¼
        </div>
        <div className="text-xs text-muted">
          í•™ìƒë³„ ê²°ê³¼ ë° í†µê³„
        </div>
      </div>

      <ExamResultsPanel examId={examId} />
    </div>
  );
}


==========================================================================================
# FILE: panels/ExamSubmissionsPanel.tsx
==========================================================================================
// PATH: src/features/exams/panels/ExamSubmissionsPanel.tsx
/**
 * ExamSubmissionsPanel - "ì‹¤ì œ ì‘ì—…ëŒ€"
 * - ì¡°êµ ì…ë ¥ì¹¸ ì—†ìŒ: íŒŒì¼ë§Œ ë“œë¡­/ì„ íƒ
 * - ì‹¤íŒ¨í•´ë„ UX ë§‰ì§€ ì•ŠìŒ (í•­ìƒ ì¬ì‹œë„ ê°€ëŠ¥)
 * - ì—…ë¡œë“œ -> ëª©ë¡ ìë™ ê°±ì‹ 
 */

import { useState } from "react";
import AdminOmrUploadSection from "@/features/submissions/components/AdminOmrUploadSection";
import AdminSubmissionsPanel from "@/features/submissions/components/AdminSubmissionsPanel";

type Props = {
  examId: number;
};

export default function ExamSubmissionsPanel({ examId }: Props) {
  const [refreshKey, setRefreshKey] = useState(0);

  return (
    <div className="space-y-6">
      {/* ìƒë‹¨: ìš´ì˜ ì•ˆë‚´ */}
      <div className="rounded-xl border border-neutral-800 bg-neutral-950 p-5">
        <div className="text-sm font-semibold text-neutral-100">
          OMR ì‹œí—˜ ìš´ì˜ ì‘ì—…ëŒ€
        </div>
        <div className="mt-2 text-xs text-neutral-400 leading-relaxed">
          ì¡°êµëŠ” <b>ìŠ¤ìº” íŒŒì¼ë§Œ ì—…ë¡œë“œ</b>í•˜ë©´ ë©ë‹ˆë‹¤. <br />
          í•™ìƒ ì‹ë³„(ë²ˆí˜¸ 8ìë¦¬)ì€ <b>OMR ë§ˆí‚¹ê°’</b>ì„ ì„œë²„ê°€ ì½ìŠµë‹ˆë‹¤. (ìˆ˜ë™ ì…ë ¥ âŒ)
        </div>

        <ol className="mt-3 list-decimal pl-4 text-xs text-neutral-300 space-y-1">
          <li>OMR ìŠ¤ìº”ë³¸ ì—…ë¡œë“œ (ë‹¨ê±´/ë‹¤ê±´)</li>
          <li>ì„œë²„: ì‹ë³„/ë‹µì•ˆì¶”ì¶œ/ì±„ì  ì›Œì»¤ ìë™ ì‹¤í–‰</li>
          <li>ì•„ë˜ ëª©ë¡ì—ì„œ ì²˜ë¦¬ ìƒíƒœ í™•ì¸</li>
          <li>ì‹¤íŒ¨í•œ ê±´ì€ ì¬ì—…ë¡œë“œ/ì¬ì²˜ë¦¬ ê°€ëŠ¥</li>
        </ol>
      </div>

      {/* 1) ì—…ë¡œë“œ ë°•ìŠ¤ */}
      <AdminOmrUploadSection
        examId={examId}
        onUploaded={() => setRefreshKey((k) => k + 1)}
      />

      {/* 2) ì œì¶œ/ì²˜ë¦¬ ìƒíƒœ */}
      <AdminSubmissionsPanel
        examId={examId}
        refreshKey={refreshKey}
      />

      {/* í•˜ë‹¨: ì‹¤íŒ¨ë„ ì •ìƒ íë¦„ */}
      <div className="rounded-lg border border-neutral-800 bg-neutral-900/40 p-4">
        <div className="text-xs text-neutral-400">
          âš ï¸ ì‹¤íŒ¨/ì§€ì—°ì€ ì •ìƒì…ë‹ˆë‹¤. <br />
          ìš´ì˜ì€ â€œë§‰íˆì§€ ì•Šê³  ê³„ì† ì‹œë„â€ê°€ ì •ë‹µì…ë‹ˆë‹¤. (ì¬ì—…ë¡œë“œ/ì¬ì²˜ë¦¬ ê°€ëŠ¥)
        </div>
      </div>
    </div>
  );
}


==========================================================================================
# FILE: panels/RegularExamPanel.tsx
==========================================================================================
// PATH: src/features/exams/panels/RegularExamPanel.tsx
import { useState } from "react";
import { Exam } from "../api/examApi";
import { ExamAssetManager } from "../components/ExamAssetManager";
import { AnswerKeyEditor } from "../components/AnswerKeyEditor";

/**
 * ìš´ì˜ ì‹œí—˜ íŒ¨ë„
 * - ì •ë‹µ/ìì‚°ì€ templateì—ì„œ resolveë˜ì–´ read-only
 * - ì‹¤ì œ ì‘ì‹œ/ì œì¶œ/ì±„ì ì€ backend pipelineìœ¼ë¡œ ì—°ê²°
 */
export function RegularExamPanel({ exam }: { exam: Exam }) {
  // regular examì€ template êµ¬ì¡°ë¥¼ ìˆ˜ì •í•  ìˆ˜ ì—†ìŒ
  const locked = true;

  return (
    <div className="space-y-6">
      <header>
        <h2 className="text-lg font-bold">{exam.title}</h2>
        <div className="text-sm text-gray-500">
          ìš´ì˜ ì‹œí—˜ (Template ê¸°ë°˜)
        </div>
      </header>

      <ExamAssetManager examId={exam.id} disabled={locked} />

      <AnswerKeyEditor examId={exam.id} disabled={locked} />

      <div className="text-xs text-gray-400">
        * ì •ë‹µ/ìì‚°ì€ í…œí”Œë¦¿ ë‹¨ì¼ì§„ì‹¤ ê¸°ì¤€ìœ¼ë¡œ ì¡°íšŒë©ë‹ˆë‹¤.
      </div>
    </div>
  );
}


==========================================================================================
# FILE: panels/TemplateExamPanel.tsx
==========================================================================================
// PATH: src/features/exams/panels/TemplateExamPanel.tsx
import { TemplateEditor } from "../components/TemplateEditor";

interface Props {
  examId: number;
}

export default function TemplateExamPanel({ examId }: Props) {
  return (
    <div className="max-w-4xl mx-auto">
      <TemplateEditor examId={examId} />
    </div>
  );
}


==========================================================================================
# FILE: panels/setup/ExamBulkActionsPanel.tsx
==========================================================================================
// PATH: src/features/exams/panels/setup/ExamBulkActionsPanel.tsx

import { useMutation } from "@tanstack/react-query";
import { recalculateExam } from "../../api/adminExam";
import AdminOmrBatchUploadBox from "@/features/submissions/components/AdminOmrBatchUploadBox";

export default function ExamBulkActionsPanel({ examId }: { examId: number }) {
  const recalc = useMutation({
    mutationFn: () => recalculateExam(examId),
  });

  return (
    <div className="space-y-3">
      <div>
        <div className="text-sm font-semibold">ì¼ê´„ ì‘ì—…</div>
        <div className="text-xs text-muted">
          ì¬ì±„ì  ì‹¤í–‰ ë° OMR / ì œì¶œ ë°ì´í„° ê´€ë¦¬
        </div>
      </div>

      <div className="surface p-4 space-y-4">
        <button
          onClick={() => recalc.mutate()}
          className="btn-danger"
          disabled={recalc.isPending}
        >
          {recalc.isPending ? "ì¬ì±„ì  ì¤‘..." : "ì¬ì±„ì  ì‹¤í–‰"}
        </button>

        <div className="surface-muted p-3">
          <div className="mb-2 text-xs font-semibold text-muted">
            OMR / ì œì¶œ ë°ì´í„° ì—…ë¡œë“œ
          </div>
          <AdminOmrBatchUploadBox examId={examId} />
        </div>
      </div>
    </div>
  );
}


==========================================================================================
# FILE: panels/setup/ExamEnrollmentPanel.tsx
==========================================================================================
/**
 * ExamEnrollmentPanel â€“ OPERATOR UX
 *
 * WHY:
 * - ëŒ€ìƒì ê´€ë¦¬ëŠ” "ì„¤ì • í™”ë©´"ì´ ì•„ë‹ˆë¼ "ì„ íƒ ëª¨ë‹¬"ì´ ë§ë‹¤
 * - ExamEnrollment PUT = ì™„ì „ ì¹˜í™˜ ê³„ì•½ ìœ ì§€
 * - enrollment_idë§Œ ì‚¬ìš© (student_id ì¶”ë¡  âŒ)
 */

import { useEffect, useState } from "react";
import { useSearchParams } from "react-router-dom";
import {
  useExamEnrollmentRows,
  useUpdateExamEnrollmentRows,
} from "../../hooks/useExamEnrollments";
import { fetchSessionEnrollments } from "../../api/sessionEnrollments";
import BlockReason from "../../components/BlockReason";

export default function ExamEnrollmentPanel({ examId }: { examId: number }) {
  const [sp] = useSearchParams();
  const sessionId = Number(sp.get("session_id"));

  if (!sessionId) {
    return (
      <BlockReason
        title="ì„¸ì…˜ ì»¨í…ìŠ¤íŠ¸ í•„ìš”"
        description="ëŒ€ìƒì ê´€ë¦¬ëŠ” ì„¸ì…˜(Session) ê¸°ì¤€ìœ¼ë¡œë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤."
      />
    );
  }

  const rowsQ = useExamEnrollmentRows(examId, sessionId);
  const updateMut = useUpdateExamEnrollmentRows(examId, sessionId);

  const serverRows = rowsQ.data?.items ?? [];

  const [open, setOpen] = useState(false);
  const [selected, setSelected] = useState<Set<number>>(new Set());

  useEffect(() => {
    const init = new Set<number>();
    serverRows.forEach((r) => {
      if (r.is_selected) init.add(r.enrollment_id);
    });
    setSelected(init);
  }, [serverRows]);

  const toggle = (id: number) => {
    setSelected((prev) => {
      const next = new Set(prev);
      next.has(id) ? next.delete(id) : next.add(id);
      return next;
    });
  };

  const apply = async () => {
    await updateMut.mutateAsync({
      enrollment_ids: Array.from(selected),
    });
    setOpen(false);
  };

  const importFromSession = async () => {
    const list = await fetchSessionEnrollments(sessionId);
    const ids = list.map((x) => x.enrollment);
    setSelected(new Set(ids));
  };

  return (
    <section className="rounded border border-[var(--border-divider)] bg-[var(--bg-surface)] p-6 space-y-4">
      <div className="flex justify-between items-center">
        <div>
          <div className="text-sm font-semibold">ì‹œí—˜ ëŒ€ìƒì</div>
          <div className="text-xs text-[var(--text-muted)]">
            í˜„ì¬ ì„ íƒ: {selected.size}ëª…
          </div>
        </div>

        <button
          onClick={() => setOpen(true)}
          className="h-10 px-4 rounded bg-[var(--color-primary)] text-white text-sm font-semibold"
        >
          ëŒ€ìƒì ë“±ë¡
        </button>
      </div>

      {/* ëª¨ë‹¬ */}
      {open && (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/40">
          <div className="w-[560px] max-h-[80vh] overflow-hidden rounded bg-white shadow">
            <div className="border-b px-4 py-3 flex justify-between">
              <div className="font-semibold">ëŒ€ìƒì ì„ íƒ</div>
              <button onClick={() => setOpen(false)}>ë‹«ê¸°</button>
            </div>

            <div className="p-4 space-y-3 overflow-auto">
              <button
                onClick={importFromSession}
                className="text-sm underline"
              >
                ì„¸ì…˜ ë‚´ í•™ìƒ ì „ì²´ ì„ íƒ
              </button>

              <div className="space-y-2">
                {serverRows.map((r) => (
                  <label
                    key={r.enrollment_id}
                    className="flex justify-between items-center border rounded px-3 py-2 text-sm"
                  >
                    <span>{r.student_name}</span>
                    <input
                      type="checkbox"
                      checked={selected.has(r.enrollment_id)}
                      onChange={() => toggle(r.enrollment_id)}
                    />
                  </label>
                ))}
              </div>
            </div>

            <div className="border-t px-4 py-3 flex justify-end gap-2">
              <button className="btn" onClick={() => setOpen(false)}>
                ì·¨ì†Œ
              </button>
              <button
                className="btn-primary"
                onClick={apply}
                disabled={updateMut.isPending}
              >
                ì ìš©
              </button>
            </div>
          </div>
        </div>
      )}
    </section>
  );
}


==========================================================================================
# FILE: panels/setup/ExamPolicyPanel.tsx
==========================================================================================
/**
 * ExamPolicyPanel â€“ FINAL / HUMAN / SAFE
 *
 * WHY:
 * - exam ì •ì±…ì€ setup íŒ¨ë„ì˜ í•µì‹¬ì´ë¯€ë¡œ self-contained
 * - ë¹„ë™ê¸° ë¡œë”© / PATCH / dirty íŒë‹¨ì„ ë‚´ë¶€ì—ì„œ ëª¨ë‘ ì±…ì„
 * - pass_score / is_activeë§Œ ì œì–´ (results ë‹¨ì¼ì§„ì‹¤ ìœ ì§€)
 */

import { useEffect, useMemo, useState } from "react";
import { useMutation, useQueryClient } from "@tanstack/react-query";
import { useAdminExam } from "../../hooks/useAdminExam";
import { updateAdminExam } from "../../api/adminExam";

export default function ExamPolicyPanel({ examId }: { examId: number }) {
  const qc = useQueryClient();
  const { data: exam, isLoading } = useAdminExam(examId);

  const [passScore, setPassScore] = useState(0);
  const [savedScore, setSavedScore] = useState(0);
  const [isActive, setIsActive] = useState(false);

  useEffect(() => {
    if (!exam) return;
    const ps = Number(exam.pass_score ?? 0);
    setPassScore(ps);
    setSavedScore(ps);
    setIsActive(Boolean(exam.is_active));
  }, [exam?.id]);

  const isDirty = useMemo(
    () => passScore !== savedScore,
    [passScore, savedScore]
  );

  const patchMut = useMutation({
    mutationFn: (payload: {
      pass_score: number;
      is_active: boolean;
    }) => updateAdminExam(examId, payload),
    onSuccess: async () => {
      await qc.invalidateQueries({ queryKey: ["admin-exam", examId] });
    },
  });

  if (isLoading || !exam) {
    return (
      <section className="rounded border bg-[var(--bg-surface-soft)] p-4 text-sm text-[var(--text-muted)]">
        ì‹œí—˜ ì •ì±…ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤â€¦
      </section>
    );
  }

  const savePassScore = async () => {
    await patchMut.mutateAsync({
      pass_score: passScore,
      is_active: isActive,
    });
    setSavedScore(passScore);
  };

  const toggleActive = async () => {
    const next = !isActive;
    setIsActive(next);
    await patchMut.mutateAsync({
      pass_score: passScore,
      is_active: next,
    });
  };

  return (
    <section className="space-y-6 rounded border border-[var(--border-divider)] bg-[var(--bg-surface)] p-5">
      <div>
        <div className="text-lg font-semibold">ì‹œí—˜ ì •ì±…</div>
        <div className="text-xs text-muted">
          ì»¤íŠ¸ë¼ì¸ê³¼ ì‹œí—˜ ì§„í–‰ ìƒíƒœë¥¼ ì„¤ì •í•©ë‹ˆë‹¤
        </div>
      </div>

      <div className="flex items-end gap-6">
        <div>
          <div className="mb-1 text-sm text-muted">ì»¤íŠ¸ë¼ì¸</div>
          <input
            type="number"
            min={0}
            value={passScore}
            onChange={(e) => setPassScore(Number(e.target.value))}
            className="w-[180px] rounded border px-3 py-2 text-4xl font-bold"
            disabled={patchMut.isPending}
          />
        </div>

        <button
          onClick={savePassScore}
          disabled={!isDirty || patchMut.isPending}
          className={[
            "h-14 rounded px-8 text-lg font-semibold",
            !isDirty || patchMut.isPending
              ? "bg-gray-300 text-gray-500 cursor-not-allowed"
              : "bg-[var(--color-primary)] text-white",
          ].join(" ")}
        >
          ì €ì¥
        </button>

        <button
          onClick={toggleActive}
          disabled={patchMut.isPending}
          className={[
            "h-14 rounded px-10 text-lg font-bold",
            isActive
              ? "bg-emerald-600 text-white"
              : "bg-red-600 text-white",
          ].join(" ")}
        >
          {isActive ? "ì§„í–‰ì¤‘" : "ì¢…ë£Œ"}
        </button>
      </div>

      <div className="text-xs text-muted">
        â€¢ í•©ê²©/ë¶ˆí•©ê²© íŒì •ì€ Results ë„ë©”ì¸ì—ì„œ ìë™ ê³„ì‚°ë©ë‹ˆë‹¤.<br />
        â€¢ ì‹œí—˜ ì‹œì‘/ì¢…ë£Œ ì‹œì ì€ ì„¸ì…˜ ì¼ì •ê³¼ ì—°ë™ë©ë‹ˆë‹¤.
      </div>
    </section>
  );
}


==========================================================================================
# FILE: panels/setup/ExamSetupPanel.tsx
==========================================================================================
// // PATH: src/features/exams/panels/setup/ExamSetupPanel.tsx
// /**
//  * ExamSetupPanel
//  *
//  * âœ… HomeworkSetupPanel UI íŒ¨í„´ì„ canonicalë¡œ ì ìš©
//  * - card wrapper ì œê±°
//  * - section ë‹¨ìœ„ êµ¬ì„±
//  * - ì•ˆë‚´ ì˜ì—­ì€ bg-surface-soft ì‚¬ìš©
//  *
//  * âŒ ë¡œì§ / API / ìƒíƒœ ë³€ê²½ ì—†ìŒ
//  */

// import { useMemo, useState, useEffect } from "react";
// import { useSearchParams } from "react-router-dom";
// import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";

// import ExamPolicyPanel from "./ExamPolicyPanel";
// import ExamBulkActionsPanel from "./ExamBulkActionsPanel";

// import { useAdminExam } from "../../hooks/useAdminExam";
// import {
//   fetchExamEnrollmentRows,
//   updateExamEnrollmentRows,
//   type ExamEnrollmentRow,
// } from "../../api/examEnrollments";

// // âœ… ì‚¬ìš©
// import EnrollmentManageModal
//   from "@/features/sessions/components/enrollment/EnrollmentManageModal";
// export default function ExamSetupPanel({ examId }: { examId: number }) {
//   const qc = useQueryClient();
//   const { data: exam } = useAdminExam(examId);
//   const [searchParams] = useSearchParams();

//   const sessionId = useMemo(() => {
//     const fromQuery = Number(searchParams.get("sessionId"));
//     if (Number.isFinite(fromQuery) && fromQuery > 0) return fromQuery;

//     const path = window.location.pathname;
//     const idx = path.indexOf("/sessions/");
//     if (idx >= 0) {
//       const rest = path.slice(idx + "/sessions/".length);
//       const sid = Number(rest.split("/")[0]);
//       if (Number.isFinite(sid) && sid > 0) return sid;
//     }

//     return 0;
//   }, [searchParams]);

//   const hasSession = Number.isFinite(sessionId) && sessionId > 0;

//   const enrollQ = useQuery({
//     queryKey: ["exam-enrollment-manage", examId, sessionId],
//     queryFn: () => fetchExamEnrollmentRows({ examId, sessionId }),
//     enabled: hasSession && Number.isFinite(examId),
//   });

//   const serverRows: ExamEnrollmentRow[] = enrollQ.data?.items ?? [];

//   const [selected, setSelected] = useState<Set<number>>(new Set());
//   const [open, setOpen] = useState(false);

//   useEffect(() => {
//     if (!open) return;
//     const init = new Set<number>();
//     for (const r of serverRows) {
//       if (r.is_selected) init.add(r.enrollment_id);
//     }
//     setSelected(init);
//   }, [open, serverRows]);

//   const selectedCount = selected.size;

//   const saveMut = useMutation({
//     mutationFn: async () => {
//       const ids = Array.from(selected).sort((a, b) => a - b);
//       return updateExamEnrollmentRows({
//         examId,
//         sessionId,
//         enrollment_ids: ids,
//       });
//     },
//     onSuccess: async () => {
//       await qc.invalidateQueries({
//         queryKey: ["exam-enrollment-manage", examId, sessionId],
//       });
//       alert("ì €ì¥ ì™„ë£Œ: ì‹œí—˜ ì‘ì‹œ ëŒ€ìƒìê°€ ê°±ì‹ ë˜ì—ˆìŠµë‹ˆë‹¤.");
//       setOpen(false);
//     },
//     onError: (e: any) => {
//       alert(e?.response?.data?.detail || "ì €ì¥ ì‹¤íŒ¨");
//     },
//   });

//   const toggle = (id: number) => {
//     setSelected((prev) => {
//       const next = new Set(prev);
//       next.has(id) ? next.delete(id) : next.add(id);
//       return next;
//     });
//   };

//   return (
//     <div className="space-y-6">
//       {/* ì‹œí—˜ ì •ì±… */}
//       <ExamPolicyPanel examId={examId} />

//       {/* ì‹œí—˜ ì‘ì‹œ ëŒ€ìƒ í•™ìƒ */}
//       <section className="rounded border bg-[var(--bg-surface)]">
//         <div className="border-b px-4 py-3">
//           <div className="text-sm font-semibold text-[var(--text-primary)]">
//             ì‹œí—˜ ì‘ì‹œ ëŒ€ìƒ í•™ìƒ
//           </div>
//           <div className="text-xs text-[var(--text-muted)]">
//             ì„¸ì…˜ ë“±ë¡ í•™ìƒ ì¤‘ ì„ íƒí•˜ì—¬ ì‹œí—˜ ì‘ì‹œ ëŒ€ìƒìë¥¼ ê´€ë¦¬í•©ë‹ˆë‹¤.
//           </div>
//         </div>

//         <div className="p-4 space-y-3">
//           {!hasSession && (
//             <div className="rounded border bg-[var(--bg-surface-soft)] p-3 text-sm text-[var(--text-muted)]">
//               âš ï¸ sessionId ì»¨í…ìŠ¤íŠ¸ê°€ ì—†ì–´ ëŒ€ìƒì ê´€ë¦¬ë¥¼ í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
//             </div>
//           )}

//           {hasSession && enrollQ.isLoading && (
//             <div className="text-sm text-[var(--text-muted)]">
//               ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
//             </div>
//           )}

//           {hasSession && enrollQ.isError && (
//             <div className="text-sm text-red-600">
//               ëŒ€ìƒì ì¡°íšŒ ì‹¤íŒ¨ (examê³¼ session ì—°ê²° í™•ì¸ í•„ìš”)
//             </div>
//           )}

//           {hasSession && !enrollQ.isLoading && !enrollQ.isError && (
//             <>
//               <div className="flex items-center justify-between rounded border bg-[var(--bg-surface-soft)] px-3 py-2">
//                 <div className="text-sm text-[var(--text-primary)]">
//                   ì„ íƒëœ ëŒ€ìƒì:{" "}
//                   <span className="font-semibold">{selectedCount}ëª…</span>
//                 </div>
//                 <div className="text-xs text-[var(--text-muted)]">
//                   session #{sessionId}
//                 </div>
//               </div>

//               <button
//                 type="button"
//                 className="rounded border px-3 py-2 text-sm hover:bg-[var(--bg-surface-soft)]"
//                 onClick={() => setOpen(true)}
//               >
//                 ì‹œí—˜ ì‘ì‹œ ëŒ€ìƒì ë“±ë¡ / ì œê±°
//               </button>
//             </>
//           )}
//         </div>
//       </section>

//       {/* ì•ˆë‚´ */}
//       <section className="rounded border bg-[var(--bg-surface-soft)] p-4 text-sm text-[var(--text-muted)]">
//         â„¹ï¸ ì‹œí—˜ ì ìˆ˜ ì…ë ¥ Â· ì±„ì  Â· íŒì •ì€{" "}
//         <b className="text-[var(--text-primary)]">ì„¸ì…˜ &gt; ì„±ì </b> ë©”ë‰´ì—ì„œ
//         ì§„í–‰í•©ë‹ˆë‹¤.
//       </section>

//       {/* ì¼ê´„ ì‘ì—… */}
//       <ExamBulkActionsPanel examId={examId} />

//       {/* ê³µìš© Enrollment Modal (ë‹¤ìŒ ë‹¨ê³„ì—ì„œ ì „ì—­í™” ì˜ˆì •) */}
//       {hasSession && (
//         <EnrollmentManageModal
//           open={open}
//           onClose={() => setOpen(false)}
//           title="ì‹œí—˜ ì‘ì‹œ ëŒ€ìƒì ê´€ë¦¬"
//           description="ì„¸ì…˜ ë“±ë¡ í•™ìƒ ì¤‘ì—ì„œ ì‹œí—˜ ì‘ì‹œ ëŒ€ìƒìë¥¼ ì„ íƒ í›„ ì €ì¥í•˜ì„¸ìš”."
//           sessionId={sessionId}
//           rows={serverRows}
//           loading={enrollQ.isLoading}
//           error={
//             enrollQ.isError
//               ? "ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨ (session_id ì—°ê²°ì„ í™•ì¸í•˜ì„¸ìš”)"
//               : null
//           }
//           selectedIds={selected}
//           onToggle={toggle}
//           onSave={() => saveMut.mutate()}
//           saving={saveMut.isPending}
//         />
//       )}
//     </div>
//   );
// }

import { useSearchParams } from "react-router-dom";
import ExamPolicyPanel from "./ExamPolicyPanel";
import ExamBulkActionsPanel from "./ExamBulkActionsPanel";
import BlockReason from "../../components/BlockReason";

export default function ExamSetupPanel({ examId }: { examId: number }) {
  const [sp] = useSearchParams();
  const sessionId = Number(sp.get("session_id"));

  const hasSession = Number.isFinite(sessionId) && sessionId > 0;

  return (
    <div className="space-y-6">
      <ExamPolicyPanel examId={examId} />

      {!hasSession && (
        <BlockReason
          title="ì„¸ì…˜ ì»¨í…ìŠ¤íŠ¸ í•„ìš”"
          description="ëŒ€ìƒì ê´€ë¦¬ ë° ì œì¶œ/ê²°ê³¼ëŠ” session_idê°€ ìˆì„ ë•Œë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤."
        />
      )}

      <ExamBulkActionsPanel examId={examId} />
    </div>
  );
}


==========================================================================================
# FILE: types/ui.ts
==========================================================================================
// PATH: src/features/exams/types/ui.ts

export type QuestionImageItem = {
  question_no: number;
  image_url: string;
};


==========================================================================================
# FILE: utils/sessionContext.ts
==========================================================================================
// PATH: src/features/exams/utils/sessionContext.ts

/**
 * Session Context Resolver
 *
 * ìš°ì„ ìˆœìœ„:
 * 1) query ?session_id=
 * 2) pathname /sessions/:id
 */
export function resolveSessionIdFromLocation(
  search: string,
  pathname: string
): number {
  // 1) query ?session_id=
  const sp = new URLSearchParams(search);
  const q = Number(sp.get("session_id"));
  if (Number.isFinite(q) && q > 0) return q;

  // 2) pathname /sessions/:id
  const m = pathname.match(/\/sessions\/(\d+)/);
  const p = m ? Number(m[1]) : 0;
  if (Number.isFinite(p) && p > 0) return p;

  return 0;
}
