====================================================================================================
# FRONTEND FOLDER: features__exams
# ROOT PATH: C:\academyfront\src\features\exams
====================================================================================================


==========================================================================================
# FILE: types.ts
==========================================================================================
export type ExamType = "template" | "regular";

export type ExamTabKey =
  | "setup"
  | "assets"
  | "submissions"
  | "results";

/**
 * âœ… ì„œë²„ ë‹¨ì¼ì§„ì‹¤ ê¸°ë°˜ Exam
 * exams_exam ìŠ¤í‚¤ë§ˆì™€ 1:1 ì •í•©
 */
export type Exam = {
  id: number;

  title: string;
  description: string;
  subject: string;

  exam_type: ExamType;

  is_active: boolean;
  allow_retake: boolean;
  max_attempts: number;

  pass_score: number;

  open_at: string | null;
  close_at: string | null;

  template_exam_id: number | null;

  created_at: string;
  updated_at: string;
};


==========================================================================================
# FILE: api/adminExam.ts
==========================================================================================
import api from "@/shared/api/axios";
import { Exam } from "../types";

function normalizeExam(raw: any): Exam {
  return {
    id: Number(raw.id),

    title: String(raw.title ?? ""),
    description: String(raw.description ?? ""),
    subject: String(raw.subject ?? ""),

    exam_type: raw.exam_type,

    is_active: Boolean(raw.is_active),
    allow_retake: Boolean(raw.allow_retake),
    max_attempts: Number(raw.max_attempts ?? 0),

    pass_score: Number(raw.pass_score ?? 0),

    open_at: raw.open_at ?? null,
    close_at: raw.close_at ?? null,

    template_exam_id: raw.template_exam_id ?? null,

    created_at: raw.created_at,
    updated_at: raw.updated_at,
  };
}

/**
 * GET /exams/{id}/
 */
export async function fetchAdminExam(
  examId: number
): Promise<Exam> {
  const res = await api.get(`/exams/${examId}/`);
  return normalizeExam(res.data);
}

/**
 * PATCH /exams/{id}/
 * âœ… ì„œë²„ í•„ë“œë§Œ í—ˆìš©
 */
export async function updateAdminExam(
  examId: number,
  payload: Partial<Pick<
    Exam,
    | "title"
    | "description"
    | "subject"
    | "is_active"
    | "allow_retake"
    | "max_attempts"
    | "pass_score"
    | "open_at"
    | "close_at"
  >>
): Promise<Exam> {
  const res = await api.patch(`/exams/${examId}/`, payload);
  return normalizeExam(res.data);
}

/**
 * POST /exams/{id}/recalculate/
 * (ì—†ìœ¼ë©´ no-op)
 */
export async function recalculateExam(
  examId: number
) {
  try {
    const res = await api.post(
      `/exams/${examId}/recalculate/`
    );
    return res.data;
  } catch {
    console.warn("recalculateExam not implemented");
    return null;
  }
}


==========================================================================================
# FILE: api/assets.ts
==========================================================================================
import api from "@/shared/api/axios";

export type ExamAssetType = "problem_pdf" | "omr_sheet";

export interface ExamAsset {
  id: number;
  exam: number;
  asset_type: ExamAssetType;
  file_key: string;
  file_type: string | null;
  file_size: number | null;
  download_url: string;
  created_at?: string;
}

function normalizeList(data: any): ExamAsset[] {
  if (Array.isArray(data)) return data;
  if (Array.isArray(data?.results)) return data.results;
  if (Array.isArray(data?.items)) return data.items;
  return [];
}

/**
 * GET /api/v1/exams/{id}/assets/
 */
export async function fetchExamAssets(
  examId: number
): Promise<ExamAsset[]> {
  const res = await api.get(`/exams/${examId}/assets/`);
  return normalizeList(res.data);
}


==========================================================================================
# FILE: api/enrollments.ts
==========================================================================================
// PATH: src/features/exams/api/enrollments.ts

import api from "@/shared/api/axios";

export type ExamEnrollment = {
  id: number;
  student_id: number;
  student_name: string;
};

export async function fetchExamEnrollments(
  examId: number
): Promise<ExamEnrollment[]> {
  const res = await api.get(`/exams/${examId}/enrollments/`);

  const d = res.data;

  // âœ… ì•ˆì „ íŒŒì‹± (DRF pagination ëŒ€ì‘)
  const items =
    Array.isArray(d?.results)
      ? d.results
      : Array.isArray(d)
      ? d
      : [];

  return items.map((x: any) => ({
    id: Number(x.id),
    student_id: Number(x.student_id),
    student_name: String(x.student_name ?? ""),
  }));
}


==========================================================================================
# FILE: api/examEnrollments.ts
==========================================================================================
import api from "@/shared/api/axios";

export type ExamEnrollmentRow = {
  enrollment_id: number;
  student_name: string;
  is_selected: boolean;
};

export type ExamEnrollmentManageResponse = {
  exam_id: number;
  session_id: number;
  items: ExamEnrollmentRow[];
};

/**
 * ë‹¨ì¼ ì§„ì‹¤:
 * - enrollment_idë§Œ ì‚¬ìš© (student_id ê¸ˆì§€)
 *
 * GET /api/v1/exams/{examId}/enrollments/?session_id=
 */
export async function fetchExamEnrollmentRows(params: {
  examId: number;
  sessionId: number;
}): Promise<ExamEnrollmentManageResponse> {
  const res = await api.get(
    `/exams/${params.examId}/enrollments/`,
    { params: { session_id: params.sessionId } }
  );
  return res.data;
}

/**
 * PUT /api/v1/exams/{examId}/enrollments/?session_id=
 */
export async function updateExamEnrollmentRows(params: {
  examId: number;
  sessionId: number;
  enrollment_ids: number[];
}) {
  const res = await api.put(
    `/exams/${params.examId}/enrollments/`,
    { enrollment_ids: params.enrollment_ids },
    { params: { session_id: params.sessionId } }
  );

  return res.data;
}


==========================================================================================
# FILE: api/exams.ts
==========================================================================================
import api from "@/shared/api/axios";
import type { Exam, ExamType } from "../types";

function normalizeExam(raw: any): Exam {
  return {
    /**
     * âœ… í•µì‹¬ FIX
     * - id ìš°ì„ 
     * - ì—†ìœ¼ë©´ exam_id fallback
     */
    id: Number(raw.id ?? raw.exam_id),

    title: String(raw.title ?? ""),
    description: String(raw.description ?? ""),
    subject: String(raw.subject ?? ""),

    exam_type: raw.exam_type as ExamType,

    is_active: Boolean(raw.is_active),
    allow_retake: Boolean(raw.allow_retake),
    max_attempts: Number(raw.max_attempts ?? 0),

    pass_score: Number(raw.pass_score ?? 0),

    open_at: raw.open_at ?? null,
    close_at: raw.close_at ?? null,

    template_exam_id: raw.template_exam_id ?? null,

    created_at: String(raw.created_at ?? ""),
    updated_at: String(raw.updated_at ?? ""),
  };
}

/**
 * GET /exams/
 */
export async function fetchExams(params?: {
  exam_type?: ExamType;
}): Promise<Exam[]> {
  const res = await api.get(`/exams/`, { params });

  const data = res.data;

  const items = Array.isArray(data)
    ? data
    : Array.isArray(data?.results)
    ? data.results
    : Array.isArray(data?.items)
    ? data.items
    : [];

  return items.map(normalizeExam);
}

/**
 * GET /exams/{id}/
 */
export async function fetchExam(
  examId: number
): Promise<Exam> {
  const res = await api.get(`/exams/${examId}/`);
  return normalizeExam(res.data);
}

/**
 * POST /exams/
 */
export async function createTemplateExam(
  payload: {
    title: string;
    subject: string;
    description?: string;
  }
): Promise<Exam> {
  const res = await api.post(`/exams/`, {
    title: payload.title,
    subject: payload.subject,
    description: payload.description ?? "",
    exam_type: "template",
  });

  return normalizeExam(res.data);
}

/**
 * POST /exams/
 */
export async function createRegularExam(
  payload: {
    title: string;
    template_exam_id: number;
    description?: string;
  }
): Promise<Exam> {
  const res = await api.post(`/exams/`, {
    title: payload.title,
    template_exam_id: payload.template_exam_id,
    description: payload.description ?? "",
    exam_type: "regular",
  });

  return normalizeExam(res.data);
}


==========================================================================================
# FILE: api/sessionEnrollments.ts
==========================================================================================
/**
 * PATH: src/features/exams/api/sessionEnrollments.ts
 *
 * âœ… SessionEnrollment API
 *
 * ì„¤ê³„ ê³„ì•½ (LOCKED):
 * - ë‹¨ì¼ ì§„ì‹¤: SessionEnrollment
 * - í•™ìƒ ì‹ë³„ì: enrollment_id (student_id âŒ)
 *
 * API:
 * GET /api/v1/enrollments/session-enrollments/?session={sessionId}
 *
 * ë°©ì–´ ì •ì±…:
 * - 404 / 501 â†’ ë¹ˆ ë°°ì—´ ë°˜í™˜ (UI ê¹¨ì§ ë°©ì§€)
 * - ê·¸ ì™¸ ì—ëŸ¬ â†’ throw
 */

import api from "@/shared/api/axios";
import axios from "axios";

export type SessionEnrollment = {
  id: number;
  session: number;
  enrollment: number; // â­ ë‹¨ì¼ ì§„ì‹¤
  student_name: string;
  created_at: string;
};

export async function fetchSessionEnrollments(
  sessionId: number
): Promise<SessionEnrollment[]> {
  try {
    const res = await api.get(
      `/enrollments/session-enrollments/`, // âœ… FIX: enrollments (s í¬í•¨)
      {
        params: { session: sessionId },
      }
    );

    /**
     * DRF pagination ëŒ€ì‘
     */
    if (Array.isArray(res.data?.results)) {
      return res.data.results as SessionEnrollment[];
    }

    if (Array.isArray(res.data)) {
      return res.data as SessionEnrollment[];
    }

    return [];
  } catch (err: any) {
    /**
     * ğŸ”’ ë°©ì–´ ê·œì¹™ (í•©ì˜ë¨)
     * - ì•„ì§ API ë¯¸êµ¬í˜„ / ê¶Œí•œ ì—†ìŒ â†’ ë¹ˆ ë°°ì—´
     */
    if (axios.isAxiosError(err)) {
      const status = err.response?.status;

      if (status === 404 || status === 501) {
        console.warn(
          "[SessionEnrollment] API not available yet. Return empty list."
        );
        return [];
      }
    }

    // ì§„ì§œ ì¥ì• ëŠ” ê·¸ëŒ€ë¡œ throw
    throw err;
  }
}


==========================================================================================
# FILE: components/AdminExamDetail.tsx
==========================================================================================
// PATH: src/features/exams/components/AdminExamDetail.tsx

/**
 * AdminExamDetail (UX ê°•í™”)
 *
 * FIX:
 * - session ì»¨í…ìŠ¤íŠ¸: query(session_id) ë˜ëŠ” pathname(/sessions/:id)ì—ì„œ ìë™ resolve
 * - session_id ìˆ˜ë™ ì…ë ¥í¼ ì œê±° (ìš´ì˜ íë¦„ì€ ì„¸ì…˜ì—ì„œ ë“¤ì–´ì˜¤ëŠ” ê²ƒì´ ì •ì„)
 */

import { useMemo, useState } from "react";
import { useSearchParams } from "react-router-dom";

import { useAdminExam } from "../hooks/useAdminExam";
import { useExamAssets, isAssetsReady } from "../hooks/useExamAssets";

import ExamTabs from "./common/ExamTabs";
import ExamHeader from "./common/ExamHeader";

import ExamSetupPanel from "../panels/setup/ExamSetupPanel";
import ExamAssetsPanel from "../panels/ExamAssetsPanel";
import ExamSubmissionsPanel from "../panels/ExamSubmissionsPanel";
import ExamResultsViewerPanel from "../panels/ExamResultsViewerPanel";

import BlockReason from "./BlockReason";
import GateNotice from "./common/GateNotice";
import { resolveSessionIdFromLocation } from "../utils/sessionContext";

export default function AdminExamDetail({ examId }: { examId: number }) {
  const safeExamId = Number.isFinite(examId) && examId > 0 ? examId : 0;

  // spëŠ” ìœ ì§€(ê¸°ì¡´ ë¼ìš°íŒ… ì˜í–¥ ìµœì†Œí™”). ë‹¨, sessionIdëŠ” location ê¸°ë°˜ìœ¼ë¡œ resolve.
  const [sp] = useSearchParams();

  const sessionId = useMemo(() => {
    return resolveSessionIdFromLocation(
      window.location.search,
      window.location.pathname
    );
  }, [sp]);

  const hasSession = Number.isFinite(sessionId) && sessionId > 0;

  const { data: exam, isLoading } = useAdminExam(safeExamId);

  const assetsQ = useExamAssets(safeExamId);
  const assets = assetsQ.data ?? [];
  const assetsReady = useMemo(() => isAssetsReady(assets), [assets]);

  const [tab, setTab] = useState<"setup" | "assets" | "submissions" | "results">(
    "setup"
  );

  if (!safeExamId) {
    return (
      <BlockReason title="ì˜ëª»ëœ ì‹œí—˜ ID" description="ì‹œí—˜ì„ ë‹¤ì‹œ ì„ íƒí•˜ì„¸ìš”." />
    );
  }

  if (isLoading) return <div>Loading...</div>;

  if (!exam) {
    return (
      <BlockReason
        title="ì‹œí—˜ ì¡°íšŒ ì‹¤íŒ¨"
        description="ì‹œí—˜ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤."
      />
    );
  }

  return (
    <div className="space-y-6">
      <ExamHeader exam={exam} />

      {/* âœ… Session Gate: ìˆ˜ë™ ì…ë ¥ ê¸ˆì§€, ëŒ€ì‹  ì •í™•í•œ í–‰ë™ ì•ˆë‚´ */}
      {!hasSession && (
        <GateNotice
          title="ì„¸ì…˜ ì»¨í…ìŠ¤íŠ¸ê°€ í•„ìš”í•©ë‹ˆë‹¤"
          description="ì‹œí—˜ ìš´ì˜(ì œì¶œ/ê²°ê³¼/ëŒ€ìƒì ê´€ë¦¬)ì€ ì„¸ì…˜(Session) í™”ë©´ì—ì„œ ì§„ì…í•´ì•¼ í•©ë‹ˆë‹¤."
          checklist={[
            "ì„¸ì…˜ í™”ë©´ì—ì„œ ì‹œí—˜ìœ¼ë¡œ ì§„ì…í•˜ë©´ session ì»¨í…ìŠ¤íŠ¸ê°€ ìë™ í¬í•¨ë©ë‹ˆë‹¤.",
            "í˜„ì¬ URLì´ /sessions/:id ê²½ë¡œë¼ë©´ ìë™ ì¸ì‹ë©ë‹ˆë‹¤.",
            "ì§ì ‘ ì¿¼ë¦¬ë¥¼ ë¶™ì—¬ì•¼ í•œë‹¤ë©´ ?session_id= í˜•íƒœë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤. (ì„ì‹œ/ìš´ì˜ ë¹„ê¶Œì¥)",
          ]}
        />
      )}

      {/* âœ… Asset Gate: ë§‰í˜ ì´ìœ  + ë‹¤ìŒ í–‰ë™ CTA */}
      {hasSession && !assetsReady && (
        <GateNotice
          title="ì œì¶œ/ì±„ì  ì¤€ë¹„ê°€ ì™„ë£Œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤"
          description={
            exam.exam_type === "regular"
              ? "ìš´ì˜ ì‹œí—˜ì€ í…œí”Œë¦¿ ìì‚°(PDF/OMR)ì„ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤. í…œí”Œë¦¿ì—ì„œ ìì‚°ì„ ë“±ë¡í•˜ì„¸ìš”."
              : "ì‹œí—˜ì§€ PDFì™€ OMR ë‹µì•ˆì§€ê°€ ë“±ë¡ë˜ì–´ì•¼ ì œì¶œ ì…ë ¥ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤."
          }
          checklist={[
            assets.some((a) => a.asset_type === "problem_pdf")
              ? "ë¬¸ì œì§€ PDF âœ”"
              : "ë¬¸ì œì§€ PDF í•„ìš”",
            assets.some((a) => a.asset_type === "omr_sheet")
              ? "OMR ë‹µì•ˆì§€ âœ”"
              : "OMR ë‹µì•ˆì§€ í•„ìš”",
          ]}
          cta={{
            label: "ìì‚° íƒ­ìœ¼ë¡œ ì´ë™",
            onClick: () => setTab("assets"),
          }}
        />
      )}

      <ExamTabs
        activeTab={tab}
        onChange={setTab}
        hasSession={hasSession}
        assetsReady={assetsReady}
      />

      {tab === "setup" && <ExamSetupPanel examId={safeExamId} />}

      {tab === "assets" && <ExamAssetsPanel examId={safeExamId} />}

      {tab === "submissions" && (
        <ExamSubmissionsPanel examId={safeExamId} sessionId={sessionId} />
      )}

      {tab === "results" && (
        <>
          {!hasSession && (
            <BlockReason
              title="ì„¸ì…˜ í•„ìš”"
              description="ê²°ê³¼ ì¡°íšŒëŠ” ì„¸ì…˜ ì»¨í…ìŠ¤íŠ¸ê°€ ìˆì„ ë•Œë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤."
            />
          )}

          {hasSession && <ExamResultsViewerPanel examId={safeExamId} />}
        </>
      )}
    </div>
  );
}


==========================================================================================
# FILE: components/AssetReadinessBadge.tsx
==========================================================================================
// PATH: src/features/exams/components/AssetReadinessBadge.tsx
import { ExamAsset } from "../api/assets";
import { isAssetsReady } from "../hooks/useExamAssets";

export default function AssetReadinessBadge({ assets }: { assets: ExamAsset[] }) {
  const ready = isAssetsReady(assets);

  return (
    <span
      className={[
        "rounded-full px-3 py-1 text-xs",
        ready
          ? "bg-emerald-600/10 text-emerald-600"
          : "bg-red-600/10 text-red-600",
      ].join(" ")}
    >
      {ready ? "ìš´ì˜ ì¤€ë¹„ ì™„ë£Œ" : "ìì‚° ëˆ„ë½"}
    </span>
  );
}


==========================================================================================
# FILE: components/AttemptSelectorPanel.tsx
==========================================================================================
import { useQuery } from "@tanstack/react-query";
import api from "@/shared/api/axios";

type Attempt = {
  id: number;
  attempt_index: number;
  is_representative: boolean;
  score: number | null;
};

export default function AttemptSelectorPanel({
  examId,
  enrollmentId,
}: {
  examId: number;
  enrollmentId: number;
}) {
  const q = useQuery({
    queryKey: ["attempts", examId, enrollmentId],
    queryFn: async () => {
      const res = await api.get(
        `/results/admin/exams/${examId}/enrollments/${enrollmentId}/attempts/`
      );
      return res.data as Attempt[];
    },
    enabled:
      Number.isFinite(examId) &&
      Number.isFinite(enrollmentId),
  });

  if (q.isLoading) return <div>ë¡œë”©...</div>;
  if (q.isError) return <div>ì¡°íšŒ ì‹¤íŒ¨</div>;

  return (
    <div className="space-y-2">
      {q.data?.map((a) => (
        <div
          key={a.id}
          className="border rounded px-3 py-2 text-sm"
        >
          Attempt #{a.attempt_index} Â· ì ìˆ˜: {a.score ?? "-"}{" "}
          {a.is_representative && "â­"}
        </div>
      ))}
    </div>
  );
}


==========================================================================================
# FILE: components/BlockReason.tsx
==========================================================================================
// PATH: src/features/exams/components/BlockReason.tsx
export default function BlockReason({
  title,
  description,
}: {
  title: string;
  description: string;
}) {
  return (
    <div className="rounded border border-red-600/30 bg-red-600/10 p-4 text-sm text-red-700">
      <div className="font-semibold">{title}</div>
      <div className="mt-1">{description}</div>
    </div>
  );
}


==========================================================================================
# FILE: components/ExamCreateErrorBox.tsx
==========================================================================================
// PATH: src/features/exams/components/ExamCreateErrorBox.tsx
export default function ExamCreateErrorBox({ error }: { error: any }) {
  if (!error) return null;

  const status = error?.response?.status;
  const detail = error?.response?.data?.detail;

  let message = "ì‹œí—˜ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.";

  if (status === 400) {
    if (detail?.includes("template")) {
      message = "í…œí”Œë¦¿ ì„ íƒì´ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.";
    } else if (detail?.includes("session")) {
      message = "ì°¨ì‹œ(session) ì„ íƒì´ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.";
    } else {
      message = "ì…ë ¥ê°’ì„ ë‹¤ì‹œ í™•ì¸í•˜ì„¸ìš”.";
    }
  }

  if (status === 403) {
    message = "ì„ ìƒë‹˜ ë˜ëŠ” ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.";
  }

  return (
    <div className="rounded border border-red-600/30 bg-red-600/10 p-3 text-sm text-red-700">
      {message}
    </div>
  );
}


==========================================================================================
# FILE: components/ExamTargetEditModal.tsx
==========================================================================================
// PATH: src/features/exams/components/ExamTargetEditModal.tsx

import { useEffect, useState } from "react";
import api from "@/shared/api/axios";

type SessionEnrollment = {
  enrollment: number;
  student_name: string;
};

export default function ExamTargetEditModal({
  sessionId,
  open,
  onClose,
}: {
  sessionId: number;
  open: boolean;
  onClose: () => void;
}) {
  const [rows, setRows] = useState<SessionEnrollment[]>([]);
  const [loading, setLoading] = useState(false);

  useEffect(() => {
    if (!open) return;

    setLoading(true);
    api
      .get("/enrollments/session-enrollments/", {
        params: { session: sessionId },
      })
      .then((res) => {
        setRows(res.data?.results ?? res.data ?? []);
      })
      .finally(() => setLoading(false));
  }, [open, sessionId]);

  if (!open) return null;

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/40">
      <div className="w-[520px] rounded bg-surface shadow">
        <div className="border-b px-4 py-3 flex justify-between">
          <div className="text-sm font-semibold">ì‹œí—˜ ëŒ€ìƒ í•™ìƒ</div>
          <button onClick={onClose} className="text-sm text-muted">
            ë‹«ê¸°
          </button>
        </div>

        <div className="max-h-[60vh] overflow-auto px-4 py-3">
          {loading ? (
            <div className="text-sm text-muted">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
          ) : (
            <ul className="space-y-1 text-sm">
              {rows.map((r) => (
                <li
                  key={r.enrollment}
                  className="flex justify-between rounded border px-3 py-2"
                >
                  <span>{r.student_name}</span>
                  <span className="text-xs text-muted">
                    #{r.enrollment}
                  </span>
                </li>
              ))}
            </ul>
          )}
        </div>

        <div className="border-t px-4 py-2 text-right">
          <button className="btn" onClick={onClose}>
            ë‹«ê¸°
          </button>
        </div>
      </div>
    </div>
  );
}


==========================================================================================
# FILE: components/assets/AssetBlockNotice.tsx
==========================================================================================
// PATH: src/features/exams/components/assets/AssetBlockNotice.tsx
export default function AssetBlockNotice({
  title,
  description,
}: {
  title: string;
  description: string;
}) {
  return (
    <div className="rounded border border-yellow-600/30 bg-yellow-600/10 p-4 text-sm text-yellow-800">
      <div className="font-semibold">{title}</div>
      <div className="mt-1">{description}</div>
    </div>
  );
}


==========================================================================================
# FILE: components/assets/AssetReadinessGate.tsx
==========================================================================================
import { ExamAsset } from "../../api/assets";
import RequireAssetsReady from "../guards/RequireAssetsReady";

/**
 * âœ… Gate ë‹¨ì¼í™”:
 * ì‹¤ì œ ë¡œì§ì€ RequireAssetsReadyê°€ ë‹¨ì¼ì§„ì‹¤.
 */
export default function AssetReadinessGate({
  assets,
  children,
}: {
  assets: ExamAsset[];
  children: React.ReactNode;
}) {
  return (
    <RequireAssetsReady assets={assets}>
      {children}
    </RequireAssetsReady>
  );
}


==========================================================================================
# FILE: components/assets/AssetUploadSection.tsx
==========================================================================================
/**
 * AssetUploadSection (Production)
 * - ë‹¨ì¼ì§„ì‹¤: exams ExamAssetView (POST /exams/{examId}/assets/)
 * - multipart: asset_type + file
 * - ì„±ê³µ ì‹œ exam-assets query invalidateë¡œ ì¦‰ì‹œ ë°˜ì˜
 */

import { useMemo, useState } from "react";
import { useQueryClient } from "@tanstack/react-query";
import api from "@/shared/api/axios";

type Props = {
  examId: number;
  assetType: string; // "problem_pdf" | "omr_sheet"
  title: string;
  accept: string;
};

function humanizeBytes(bytes: number) {
  if (!Number.isFinite(bytes) || bytes <= 0) return "-";
  const units = ["B", "KB", "MB", "GB"];
  let v = bytes;
  let i = 0;
  while (v >= 1024 && i < units.length - 1) {
    v /= 1024;
    i += 1;
  }
  return `${v.toFixed(i === 0 ? 0 : 1)} ${units[i]}`;
}

export default function AssetUploadSection({
  examId,
  assetType,
  title,
  accept,
}: Props) {
  const qc = useQueryClient();

  const [file, setFile] = useState<File | null>(null);
  const [submitting, setSubmitting] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [doneMsg, setDoneMsg] = useState<string | null>(null);

  const canSubmit = useMemo(() => {
    return (
      Number.isFinite(examId) &&
      examId > 0 &&
      !!file &&
      !submitting
    );
  }, [examId, file, submitting]);

  const upload = async () => {
    if (!canSubmit || !file) return;

    try {
      setSubmitting(true);
      setError(null);
      setDoneMsg(null);

      const form = new FormData();
      form.append("asset_type", assetType);
      form.append("file", file);

      await api.post(`/exams/${examId}/assets/`, form, {
        headers: { "Content-Type": "multipart/form-data" },
      });

      setDoneMsg("ì—…ë¡œë“œ ì™„ë£Œ");
      setFile(null);

      // âœ… ì¦‰ì‹œ ë°˜ì˜
      await qc.invalidateQueries({ queryKey: ["exam-assets", examId] });
    } catch (e: any) {
      const status = e?.response?.status;
      const detail = e?.response?.data?.detail;

      // ë°±ì—”ë“œ ë´‰ì¸ ë©”ì‹œì§€/ê¶Œí•œ/ê²€ì¦ ë©”ì‹œì§€ë¥¼ ê°€ëŠ¥í•œ ê·¸ëŒ€ë¡œ ë…¸ì¶œ
      let msg =
        detail ||
        "ì—…ë¡œë“œ ì‹¤íŒ¨. íŒŒì¼/ê¶Œí•œ/í…œí”Œë¦¿ ë´‰ì¸ ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”.";

      if (status === 403) {
        msg =
          detail ||
          "ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤. (Teacher/Admin í•„ìš” ë˜ëŠ” ìš´ì˜ì‹œí—˜ì€ ì—…ë¡œë“œ ë¶ˆê°€)";
      }

      if (status === 400) {
        msg = detail || "ìš”ì²­ ê°’ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.";
      }

      setError(String(msg));
    } finally {
      setSubmitting(false);
    }
  };

  return (
    <div className="rounded border border-[var(--border-divider)] bg-[var(--bg-surface)] p-4 space-y-3">
      <div className="flex items-start justify-between gap-3">
        <div>
          <div className="text-sm font-semibold text-[var(--text-primary)]">
            {title}
          </div>
          <div className="text-xs text-[var(--text-muted)]">
            ìš´ì˜ ì‹œí—˜ ì œì¶œ/ì±„ì ì— í•„ìš”í•©ë‹ˆë‹¤. (asset_type: <b>{assetType}</b>)
          </div>
        </div>

        <div className="text-xs text-[var(--text-muted)] text-right">
          {file ? (
            <>
              <div className="font-medium text-[var(--text-secondary)]">
                {file.name}
              </div>
              <div>{humanizeBytes(file.size)}</div>
            </>
          ) : (
            <div>íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”</div>
          )}
        </div>
      </div>

      <div className="flex flex-wrap items-center gap-2">
        <input
          type="file"
          accept={accept}
          onChange={(e) => {
            setDoneMsg(null);
            setError(null);
            const f = e.target.files?.[0] ?? null;
            setFile(f);
          }}
          disabled={submitting}
          className="text-sm"
        />

        <button
          type="button"
          className="btn-primary"
          disabled={!canSubmit}
          onClick={() => void upload()}
          title="í…œí”Œë¦¿ ì‹œí—˜ì—ì„œë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤."
        >
          {submitting ? "ì—…ë¡œë“œ ì¤‘..." : "ì—…ë¡œë“œ"}
        </button>

        {file && !submitting && (
          <button
            type="button"
            className="btn"
            onClick={() => {
              setFile(null);
              setError(null);
              setDoneMsg(null);
            }}
          >
            ì„ íƒ ì·¨ì†Œ
          </button>
        )}
      </div>

      {error && (
        <div className="rounded border border-red-600/30 bg-red-600/10 p-3 text-sm text-red-700">
          {error}
        </div>
      )}

      {doneMsg && (
        <div className="rounded border border-emerald-600/30 bg-emerald-600/10 p-3 text-sm text-emerald-700">
          {doneMsg}
        </div>
      )}

      <div className="text-xs text-[var(--text-muted)]">
        â€» í…œí”Œë¦¿ì´ ì´ë¯¸ ìš´ì˜ì‹œí—˜(regular)ì— ì˜í•´ ì‚¬ìš© ì¤‘ì´ë©´, ì„œë²„ ì •ì±…ìƒ ìì‚° êµì²´ê°€ ë´‰ì¸ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
      </div>
    </div>
  );
}


==========================================================================================
# FILE: components/common/ExamHeader.tsx
==========================================================================================
import type { Exam } from "../../types";

function deriveState(exam: Exam) {
  // âœ… ì„œë²„ ë‹¨ì¼ì§„ì‹¤ ê¸°ë°˜ íŒŒìƒ (í”„ë¡ íŠ¸ í‘œì‹œìš©)
  // - is_active + open_at/close_atë¡œ Badge ìƒíƒœë§Œ ê³„ì‚°
  const now = new Date();

  const openAt = exam.open_at ? new Date(exam.open_at) : null;
  const closeAt = exam.close_at ? new Date(exam.close_at) : null;

  if (!exam.is_active) {
    return { key: "inactive" as const, label: "ë¹„í™œì„±" };
  }

  if (openAt && now < openAt) {
    return { key: "scheduled" as const, label: "ì˜ˆì •" };
  }

  if (closeAt && now > closeAt) {
    return { key: "closed" as const, label: "ì¢…ë£Œ" };
  }

  // open_at/close_atì´ ì—†ê±°ë‚˜, í˜„ì¬ê°€ êµ¬ê°„ ì•ˆì´ë©´ ì§„í–‰ì¤‘ìœ¼ë¡œ ë³¸ë‹¤
  return { key: "open" as const, label: "ì§„í–‰ì¤‘" };
}

function Badge({ state }: { state: ReturnType<typeof deriveState> }) {
  const cls =
    state.key === "open"
      ? "bg-emerald-600/10 text-emerald-700"
      : state.key === "scheduled"
      ? "bg-blue-600/10 text-blue-700"
      : state.key === "closed"
      ? "bg-gray-600/10 text-gray-700"
      : "bg-red-600/10 text-red-700";

  return (
    <span className={`rounded-full px-3 py-1 text-xs ${cls}`}>
      {state.label}
    </span>
  );
}

export default function ExamHeader({ exam }: { exam: Exam }) {
  const state = deriveState(exam);

  return (
    <div className="space-y-2">
      <div className="flex items-start justify-between gap-3">
        <div className="space-y-1">
          <h2 className="text-lg font-semibold">{exam.title}</h2>
          <div className="text-xs text-muted">
            {exam.exam_type === "template" ? "í…œí”Œë¦¿" : "ìš´ì˜"} Â·{" "}
            {exam.subject || "ê³¼ëª© ë¯¸ì§€ì •"}
          </div>
        </div>

        <div className="flex items-center gap-2">
          <Badge state={state} />
        </div>
      </div>

      {exam.description?.trim() && (
        <div className="text-sm text-muted whitespace-pre-wrap">
          {exam.description}
        </div>
      )}

      <div className="text-xs text-muted">
        â€» ì„±ì  ì…ë ¥ Â· ì±„ì  Â· íŒì •ì€ <b>ì„¸ì…˜ &gt; ì„±ì </b> ë„ë©”ì¸ì´ ë‹¨ì¼ì§„ì‹¤ì…ë‹ˆë‹¤.
      </div>
    </div>
  );
}


==========================================================================================
# FILE: components/common/ExamTabs.tsx
==========================================================================================
/**
 * ExamTabs
 *
 * WHY:
 * - disabled íƒ­ì„ "ìˆ¨ê¹€"í•˜ì§€ ì•Šê³ , ì™œ ë§‰í˜”ëŠ”ì§€ íˆ´íŒ/ì‚¬ìœ ë¡œ ëª…ì‹œ
 * - ë¼ìš°íŒ…/íƒ­ êµ¬ì¡° ìœ ì§€ (state ê¸°ë°˜ íƒ­ ì „í™˜ ìœ ì§€)
 * - session/assets gateëŠ” UIì—ì„œë§Œ ì•ˆë‚´í•˜ê³ , ê³„ì‚°/íŒì •ì€ ì ˆëŒ€ í•˜ì§€ ì•ŠëŠ”ë‹¤
 */

import type { ExamTabKey } from "../../types";

type Props = {
  activeTab: ExamTabKey;
  onChange: (k: ExamTabKey) => void;
  hasSession: boolean;
  assetsReady: boolean;
};

const TABS: { key: ExamTabKey; label: string }[] = [
  { key: "setup", label: "ê¸°ë³¸ ì„¤ì •" },
  { key: "assets", label: "ìì‚°" },
  { key: "submissions", label: "ì œì¶œ" },
  { key: "results", label: "ê²°ê³¼" },
];

function disabledReason(
  key: ExamTabKey,
  hasSession: boolean,
  assetsReady: boolean
) {
  if (key === "submissions") {
    if (!hasSession) return "ì„¸ì…˜ ì»¨í…ìŠ¤íŠ¸(session_id)ê°€ í•„ìš”í•©ë‹ˆë‹¤.";
    if (!assetsReady) return "ì‹œí—˜ ìì‚°(PDF/OMR)ì´ ì¤€ë¹„ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.";
  }

  if (key === "results") {
    if (!hasSession) return "ì„¸ì…˜ ì»¨í…ìŠ¤íŠ¸(session_id)ê°€ í•„ìš”í•©ë‹ˆë‹¤.";
  }

  return "";
}

export default function ExamTabs({
  activeTab,
  onChange,
  hasSession,
  assetsReady,
}: Props) {
  return (
    <div className="flex gap-6 border-b border-[var(--border-divider)]">
      {TABS.map((t) => {
        const reason = disabledReason(t.key, hasSession, assetsReady);
        const disabled = !!reason;

        const isActive = activeTab === t.key;

        return (
          <div key={t.key} className="flex flex-col">
            <button
              type="button"
              disabled={disabled}
              onClick={() => !disabled && onChange(t.key)}
              title={disabled ? reason : undefined}
              className={[
                "pb-2 text-sm border-b-2 transition-colors",
                disabled && "opacity-40 cursor-not-allowed",
                isActive
                  ? "border-[var(--color-primary)] font-semibold text-[var(--text-primary)]"
                  : "border-transparent text-[var(--text-secondary)] hover:text-[var(--text-primary)]",
              ].join(" ")}
            >
              {t.label}
            </button>

            {/* âœ… disabled ì‚¬ìœ ë¥¼ hoverë¿ ì•„ë‹ˆë¼ í…ìŠ¤íŠ¸ë¡œë„ ë…¸ì¶œ (ì ‘ê·¼ì„±/í˜„ì¥ UX) */}
            {disabled && (
              <div className="mt-1 text-[11px] text-[var(--text-muted)]">
                {reason}
              </div>
            )}
          </div>
        );
      })}
    </div>
  );
}


==========================================================================================
# FILE: components/common/GateNotice.tsx
==========================================================================================
/**
 * GateNotice
 *
 * WHY:
 * - ê¸°ëŠ¥ ë¹„í™œì„±ì€ "ìˆ¨ê¹€"ì´ ì•„ë‹ˆë¼ "ì´ìœ  ì„¤ëª…"ì´ ì›ì¹™
 * - session / asset / lock ê²Œì´íŠ¸ë¥¼ ê³µí†µ UXë¡œ í‘œí˜„
 * - exams / homework í˜•ì œ ë„ë©”ì¸ì—ì„œ ë™ì¼ íŒ¨í„´ ì‚¬ìš© ê°€ëŠ¥
 */

type GateNoticeProps = {
  title: string;
  description: string;
  checklist?: string[];
  cta?: {
    label: string;
    onClick: () => void;
  };
};

export default function GateNotice({
  title,
  description,
  checklist,
  cta,
}: GateNoticeProps) {
  return (
    <div className="rounded border border-[var(--border-divider)] bg-[var(--bg-surface-soft)] p-5 space-y-3">
      <div className="text-base font-semibold text-[var(--text-primary)]">
        {title}
      </div>

      <div className="text-sm text-[var(--text-secondary)]">
        {description}
      </div>

      {checklist && checklist.length > 0 && (
        <ul className="list-disc pl-5 text-sm text-[var(--text-secondary)] space-y-1">
          {checklist.map((item, idx) => (
            <li key={idx}>{item}</li>
          ))}
        </ul>
      )}

      {cta && (
        <div className="pt-2">
          <button
            type="button"
            onClick={cta.onClick}
            className="rounded bg-[var(--color-primary)] px-4 py-2 text-sm font-semibold text-white"
          >
            {cta.label}
          </button>
        </div>
      )}
    </div>
  );
}


==========================================================================================
# FILE: components/common/InfoBanner.tsx
==========================================================================================
/**
 * InfoBanner
 *
 * WHY:
 * - ë‹¨ìˆœ ê²½ê³ /ì•ˆë‚´ë¥¼ ì¹´ë“œí˜•ìœ¼ë¡œ í†µì¼
 * - results / submissions / setup ì „ë°˜ì—ì„œ ì¬ì‚¬ìš©
 */

export default function InfoBanner({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <div className="rounded border border-[var(--border-divider)] bg-[var(--bg-surface-soft)] p-3 text-sm text-[var(--text-secondary)]">
      {children}
    </div>
  );
}


==========================================================================================
# FILE: components/common/SectionHeader.tsx
==========================================================================================
/**
 * SectionHeader
 *
 * WHY:
 * - ì‹œí—˜/ê³¼ì œ ê³µí†µ ì„¹ì…˜ íƒ€ì´í¬ ê³„ì¸µ í†µì¼
 * - "í° ì œëª© + í•œ ì¤„ ìš”ì•½" íŒ¨í„´ ê³ ì •
 */

export default function SectionHeader({
  title,
  description,
}: {
  title: string;
  description?: string;
}) {
  return (
    <div className="space-y-1">
      <div className="text-base font-semibold text-[var(--text-primary)]">
        {title}
      </div>
      {description && (
        <div className="text-xs text-[var(--text-muted)]">
          {description}
        </div>
      )}
    </div>
  );
}


==========================================================================================
# FILE: components/create/CreateRegularExamModal.tsx
==========================================================================================
// PATH: src/features/exams/components/create/CreateRegularExamModal.tsx
// ------------------------------------------------------------------
// Regular Exam Create Modal (Production Grade - FINAL)
// ------------------------------------------------------------------

import { useEffect, useState } from "react";
import { useQuery } from "@tanstack/react-query";
import api from "@/shared/api/axios";

type ExamTemplate = {
  id: number;
  title: string;
  subject: string;
};

type Props = {
  open: boolean;
  onClose: () => void;
  sessionId: number;
  onCreated: (examId: number) => void;
};

export default function CreateRegularExamModal({
  open,
  onClose,
  sessionId,
  onCreated,
}: Props) {
  const [title, setTitle] = useState("");
  const [description, setDescription] = useState("");
  const [templateId, setTemplateId] = useState<number | null>(null);

  const [error, setError] = useState<string | null>(null);
  const [submitting, setSubmitting] = useState(false);

  // -----------------------------------
  // âœ… Template ëª©ë¡ ì¡°íšŒ (í•µì‹¬ ìˆ˜ì •)
  // -----------------------------------
  const { data: templates = [], isLoading } = useQuery({
    queryKey: ["exam-templates"],
    queryFn: async (): Promise<ExamTemplate[]> => {
      const res = await api.get("/exams/", {
        params: { exam_type: "template" },
      });

      const data = res.data;

      // ğŸ”¥ DRF pagination ëŒ€ì‘
      if (Array.isArray(data)) return data;
      if (Array.isArray(data?.results)) return data.results;

      return [];
    },
    enabled: open,
  });

  // -----------------------------------
  // ì´ˆê¸°í™”
  // -----------------------------------
  useEffect(() => {
    if (!open) return;
    setTitle("");
    setDescription("");
    setTemplateId(null);
    setError(null);
    setSubmitting(false);
  }, [open]);

  if (!open) return null;

  // -----------------------------------
  // ê²€ì¦
  // -----------------------------------
  const validate = () => {
    if (!title.trim()) return "ì‹œí—˜ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”.";
    if (!templateId) return "í…œí”Œë¦¿ ì‹œí—˜ì„ ì„ íƒí•˜ì„¸ìš”.";
    if (!sessionId) return "ì„¸ì…˜ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.";
    return null;
  };

  // -----------------------------------
  // ìƒì„±
  // -----------------------------------
  const handleSubmit = async () => {
    const v = validate();
    if (v) {
      setError(v);
      return;
    }

    try {
      setSubmitting(true);
      setError(null);

      const res = await api.post("/exams/", {
        title: title.trim(),
        description: description.trim(),
        exam_type: "regular",
        template_exam_id: templateId,
        session_id: sessionId,
      });

      const newExamId = res.data?.id;

      if (!newExamId) {
        throw new Error("ìƒì„±ì€ ë˜ì—ˆìœ¼ë‚˜ ID ë°˜í™˜ ì—†ìŒ");
      }

      onCreated(Number(newExamId));
      onClose();
    } catch (e: any) {
      console.error(e);

      const msg =
        e?.response?.data?.detail ||
        "ì‹œí—˜ ìƒì„± ì‹¤íŒ¨. ì…ë ¥ê°’ì„ í™•ì¸í•˜ì„¸ìš”.";

      setError(msg);
    } finally {
      setSubmitting(false);
    }
  };

  // -----------------------------------
  // UI
  // -----------------------------------
  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/40">
      <div className="w-[480px] rounded-lg bg-white p-6 shadow-xl">
        <h2 className="mb-4 text-lg font-semibold">
          ìš´ì˜ ì‹œí—˜ ìƒì„±
        </h2>

        <div className="space-y-4">
          {/* ì œëª© */}
          <div>
            <label className="text-sm font-medium">ì‹œí—˜ ì œëª©</label>
            <input
              value={title}
              onChange={(e) => setTitle(e.target.value)}
              className="mt-1 w-full rounded border px-3 py-2 text-sm"
              placeholder="ì˜ˆ: 3ì›” ëª¨ì˜ê³ ì‚¬"
            />
          </div>

          {/* í…œí”Œë¦¿ ì„ íƒ */}
          <div>
            <label className="text-sm font-medium">
              ì‹œí—˜ í…œí”Œë¦¿ (í•„ìˆ˜)
            </label>

            <select
              value={templateId ?? ""}
              onChange={(e) =>
                setTemplateId(Number(e.target.value))
              }
              className="mt-1 w-full rounded border px-3 py-2 text-sm"
            >
              <option value="">
                {isLoading ? "ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘..." : "ì„ íƒí•˜ì„¸ìš”"}
              </option>

              {templates.map((t) => (
                <option key={t.id} value={t.id}>
                  {t.title} ({t.subject})
                </option>
              ))}
            </select>

            <p className="mt-1 text-xs text-gray-500">
              â€» ê³¼ëª©(subject)ì€ í…œí”Œë¦¿ ì‹œí—˜ ê°’ì„ ë”°ë¦…ë‹ˆë‹¤.
            </p>
          </div>

          {/* ì„¤ëª… */}
          <div>
            <label className="text-sm font-medium">
              ì„¤ëª… (ì„ íƒ)
            </label>
            <textarea
              value={description}
              onChange={(e) =>
                setDescription(e.target.value)
              }
              className="mt-1 w-full rounded border px-3 py-2 text-sm"
              rows={3}
            />
          </div>

          {/* ì—ëŸ¬ */}
          {error && (
            <div className="rounded bg-red-50 p-2 text-sm text-red-600">
              {error}
            </div>
          )}

          {/* ë²„íŠ¼ */}
          <div className="flex justify-end gap-2 pt-2">
            <button
              onClick={onClose}
              className="rounded border px-4 py-2 text-sm"
              disabled={submitting}
            >
              ì·¨ì†Œ
            </button>

            <button
              onClick={handleSubmit}
              disabled={submitting}
              className="rounded bg-green-600 px-4 py-2 text-sm text-white disabled:opacity-50"
            >
              {submitting ? "ìƒì„± ì¤‘..." : "ìƒì„±"}
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}


==========================================================================================
# FILE: components/create/CreateTemplateExamModal.tsx
==========================================================================================
// PATH: src/features/exams/components/create/CreateTemplateExamModal.tsx

import { useState } from "react";
import { useMutation } from "@tanstack/react-query";
import { createTemplateExam } from "../../api/exams";
import ExamCreateErrorBox from "../ExamCreateErrorBox";

export default function CreateTemplateExamModal({
  open,
  onClose,
  onCreated,
}: {
  open: boolean;
  onClose: () => void;
  onCreated: (examId: number) => void;
}) {
  const [title, setTitle] = useState("");
  const [subject, setSubject] = useState("");
  const [description, setDescription] = useState("");

  const m = useMutation({
    mutationFn: createTemplateExam,

    onSuccess: (exam) => {
      /**
       * âœ… í•µì‹¬ FIX
       * - ì„œë²„ëŠ” id
       * - sessions íŒ¨ë„ì€ exam_id ê¸°ë°˜
       * â†’ ì—¬ê¸°ì„œ í†µì¼
       */
      const safeId =
        Number(exam?.id) ||
        Number((exam as any)?.exam_id) ||
        0;

      if (!safeId) {
        alert(
          "ì‹œí—˜ ìƒì„±ì€ ë˜ì—ˆì§€ë§Œ ID í™•ì¸ ì‹¤íŒ¨. ìƒˆë¡œê³ ì¹¨ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”."
        );
        return;
      }

      onCreated(safeId);
      onClose();
    },
  });

  if (!open) return null;

  const canSubmit = title.trim() && subject.trim();

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/40">
      <div className="w-[420px] rounded bg-surface p-6 space-y-4">
        <h2 className="text-lg font-semibold">
          ì‹œí—˜ í…œí”Œë¦¿ ìƒì„±
        </h2>

        <label className="text-sm">
          ì‹œí—˜ ì œëª©
          <input
            className="mt-1 w-full rounded border px-3 py-2"
            value={title}
            onChange={(e) => setTitle(e.target.value)}
          />
        </label>

        <label className="text-sm">
          ê³¼ëª© (í•„ìˆ˜)
          <input
            className="mt-1 w-full rounded border px-3 py-2"
            value={subject}
            onChange={(e) => setSubject(e.target.value)}
          />
        </label>

        <label className="text-sm">
          ì„¤ëª… (ì„ íƒ)
          <textarea
            className="mt-1 w-full rounded border px-3 py-2"
            value={description}
            onChange={(e) =>
              setDescription(e.target.value)
            }
          />
        </label>

        <ExamCreateErrorBox error={m.error} />

        <div className="flex justify-end gap-2 pt-2">
          <button className="btn" onClick={onClose}>
            ì·¨ì†Œ
          </button>

          <button
            className="btn-primary"
            disabled={!canSubmit || m.isPending}
            onClick={() =>
              m.mutate({
                title,
                subject,
                description:
                  description || undefined,
              })
            }
          >
            {m.isPending
              ? "ìƒì„± ì¤‘..."
              : "ìƒì„±"}
          </button>
        </div>
      </div>
    </div>
  );
}


==========================================================================================
# FILE: components/guards/RequireAssetsReady.tsx
==========================================================================================
import { ExamAsset } from "../../api/assets";

function isReady(assets: ExamAsset[]) {
  const hasPdf = assets.some(a => a.asset_type === "problem_pdf");
  const hasOmr = assets.some(a => a.asset_type === "omr_sheet");
  return hasPdf && hasOmr;
}

export default function RequireAssetsReady({
  assets,
  children,
}: {
  assets: ExamAsset[];
  children: React.ReactNode;
}) {
  if (!isReady(assets)) {
    return (
      <div className="rounded border border-yellow-600/30 bg-yellow-600/10 p-4 text-sm text-yellow-800">
        <div className="font-semibold">ìš´ì˜ ë¶ˆê°€</div>
        <div className="mt-1">
          ì‹œí—˜ì§€ PDF ë˜ëŠ” OMR ë‹µì•ˆì§€ê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤.
        </div>
      </div>
    );
  }

  return <>{children}</>;
}


==========================================================================================
# FILE: components/guards/RequireSessionContext.tsx
==========================================================================================
// PATH: src/features/exams/components/guards/RequireSessionContext.tsx
export default function RequireSessionContext({
  sessionId,
  children,
}: {
  sessionId?: number;
  children: React.ReactNode;
}) {
  if (!sessionId) {
    return (
      <div className="rounded border bg-[var(--bg-surface-soft)] p-4 text-sm text-muted">
        âš ï¸ ì„¸ì…˜ ì»¨í…ìŠ¤íŠ¸(session_id)ê°€ í•„ìš”í•©ë‹ˆë‹¤.  
        <br />
        ì„¸ì…˜ í™”ë©´ì—ì„œ ì‹œí—˜ìœ¼ë¡œ ì§„ì…í•˜ê±°ë‚˜, URLì— session_idë¥¼ í¬í•¨í•˜ì„¸ìš”.
      </div>
    );
  }
  return <>{children}</>;
}


==========================================================================================
# FILE: components/submissions/AdminOmrUploadSection.tsx
==========================================================================================
/**
 * AdminOmrUploadSection
 *
 * WHY:
 * - submissions ë„ë©”ì¸ì€ "ì œì¶œ ì´ë²¤íŠ¸ ìƒì„±"ê¹Œì§€ë§Œ ì±…ì„ì§„ë‹¤
 * - ì ìˆ˜/íŒì •/ìƒíƒœ í•´ì„ì€ ì ˆëŒ€ í•˜ì§€ ì•ŠëŠ”ë‹¤
 * - FINAL SPEC: POST /submissions/exams/{exam_id}/omr/ ë§Œ ì‚¬ìš©
 * - JSX ì‚¬ìš© â†’ ë°˜ë“œì‹œ .tsx
 */

import { useState } from "react";
import api from "@/shared/api/axios";

type Props = {
  examId: number;
};

export default function AdminOmrUploadSection({ examId }: Props) {
  const [enrollmentId, setEnrollmentId] = useState("");
  const [sheetId, setSheetId] = useState("");
  const [fileKey, setFileKey] = useState("");

  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [success, setSuccess] = useState<string | null>(null);

  const submit = async () => {
    setError(null);
    setSuccess(null);

    const eid = Number(enrollmentId);
    const sid = Number(sheetId);

    if (!eid || !sid || !fileKey.trim()) {
      setError("enrollment_id, sheet_id, file_keyëŠ” ëª¨ë‘ í•„ìˆ˜ì…ë‹ˆë‹¤.");
      return;
    }

    try {
      setLoading(true);

      await api.post(`/submissions/exams/${examId}/omr/`, {
        enrollment_id: eid,
        sheet_id: sid,
        file_key: fileKey.trim(),
      });

      setSuccess(
        "ì œì¶œì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹µì•ˆ ì¶”ì¶œ ë° ì±„ì ì€ ìë™ìœ¼ë¡œ ì§„í–‰ë©ë‹ˆë‹¤."
      );

      // reset
      setEnrollmentId("");
      setSheetId("");
      setFileKey("");
    } catch (e: any) {
      setError(
        e?.response?.data?.detail ??
          "ì œì¶œ ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì„¸ì…˜/ìì‚°/ID ì¡°ê±´ì„ í™•ì¸í•˜ì„¸ìš”."
      );
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="rounded border border-[var(--border-divider)] bg-[var(--bg-surface)] p-4 space-y-4">
      <div>
        <div className="text-sm font-semibold text-[var(--text-primary)]">
          OMR ì œì¶œ ë“±ë¡
        </div>
        <div className="text-xs text-[var(--text-muted)]">
          ìŠ¤ìº”ëœ OMR íŒŒì¼ì˜ ìœ„ì¹˜(file_key)ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì œì¶œ ì´ë²¤íŠ¸ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
        </div>
      </div>

      {error && (
        <div className="rounded border border-red-400 bg-red-50 p-3 text-sm text-red-700">
          {error}
        </div>
      )}

      {success && (
        <div className="rounded border border-green-400 bg-green-50 p-3 text-sm text-green-700">
          {success}
        </div>
      )}

      <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
        <input
          placeholder="enrollment_id"
          className="rounded border px-3 py-2 text-sm"
          value={enrollmentId}
          onChange={(e) => setEnrollmentId(e.target.value)}
          disabled={loading}
        />

        <input
          placeholder="sheet_id"
          className="rounded border px-3 py-2 text-sm"
          value={sheetId}
          onChange={(e) => setSheetId(e.target.value)}
          disabled={loading}
        />

        <input
          placeholder="file_key (R2 ê²½ë¡œ)"
          className="rounded border px-3 py-2 text-sm"
          value={fileKey}
          onChange={(e) => setFileKey(e.target.value)}
          disabled={loading}
        />
      </div>

      <button
        type="button"
        onClick={submit}
        disabled={loading}
        className="rounded bg-[var(--color-primary)] px-4 py-2 text-sm font-semibold text-white disabled:opacity-50"
      >
        {loading ? "ë“±ë¡ ì¤‘..." : "ì œì¶œ ë“±ë¡"}
      </button>
    </div>
  );
}


==========================================================================================
# FILE: hooks/useAdminExam.ts
==========================================================================================
//src/features/exams/hooks/useAdminExam.ts

import { useQuery } from "@tanstack/react-query";
import { fetchAdminExam } from "../api/adminExam";

/**
 * âœ… ê´€ë¦¬ì ì‹œí—˜ ìƒì„¸ ì¡°íšŒ í›…
 * - examId ì¤€ë¹„ ì „ì—” ìš”ì²­ âŒ
 */
export function useAdminExam(examId?: number) {
  const safeId = Number(examId);

  return useQuery({
    queryKey: ["admin-exam", safeId],
    queryFn: () => fetchAdminExam(safeId),
    enabled: Number.isFinite(safeId),
  });
}


==========================================================================================
# FILE: hooks/useExam.ts
==========================================================================================
// PATH: src/features/exams/hooks/useExam.ts

import { useQuery } from "@tanstack/react-query";
import api from "@/shared/api/axios";

export type ExamDetail = {
  id: number;
  title: string;
  description: string;
  subject: string;
  exam_type: "template" | "regular";
  open_at: string | null;
  close_at: string | null;
  allow_retake: boolean;
  max_attempts: number;
};

async function fetchExam(examId: number): Promise<ExamDetail> {
  const res = await api.get(`/exams/${examId}/`);
  return res.data;
}

export function useExam(examId: number | null | undefined) {
  return useQuery({
    queryKey: ["exam-detail", examId],
    queryFn: () => fetchExam(Number(examId)),

    // âœ…ğŸ”¥ Production Fix (NaN ë°©ì§€ í•µì‹¬)
    enabled: Number.isFinite(examId),

    staleTime: 1000 * 60 * 5,
  });
}


==========================================================================================
# FILE: hooks/useExamAssets.ts
==========================================================================================
/**
 * useExamAssets (ENHANCED)
 *
 * WHY:
 * - ê¸°ì¡´ ê³„ì•½ ìœ ì§€: useExamAssets()ëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ExamAsset[]ë¥¼ ë°˜í™˜í•œë‹¤.
 * - ë‹¨, Batch1ì˜ submissions UXì—ì„œ "problem_pdf/omr_sheet ì¡´ì¬ ì—¬ë¶€"ë¥¼ ì§ê´€ì ìœ¼ë¡œ ì“°ê¸° ìœ„í•´
 *   ë°˜í™˜ ë°°ì—´ì— ë³´ì¡° í”„ë¡œí¼í‹°(problem_pdf/omr_sheet)ë¥¼ ë¶€ì°©í•œë‹¤ (íƒ€ì… êµë€ ì—†ì´ í˜¸í™˜).
 * - ìƒˆ endpoint ê¸ˆì§€, ê¸°ì¡´ fetchExamAssets ê·¸ëŒ€ë¡œ ì‚¬ìš©.
 */

import { useQuery } from "@tanstack/react-query";
import { fetchExamAssets, ExamAsset } from "../api/assets";

export type ExamAssetsList = ExamAsset[] & {
  /** convenience flags (non-authoritative, UI gate only) */
  problem_pdf?: boolean;
  omr_sheet?: boolean;
};

export function useExamAssets(examId?: number) {
  return useQuery<ExamAssetsList>({
    queryKey: ["exam-assets", examId],
    queryFn: async () => {
      const list = (await fetchExamAssets(examId as number)) as ExamAssetsList;

      // âš ï¸ UI í¸ì˜ìš© flag (ì„œë²„ ë‹¨ì¼ì§„ì‹¤ = assets list)
      (list as any).problem_pdf = list.some((a) => a.asset_type === "problem_pdf");
      (list as any).omr_sheet = list.some((a) => a.asset_type === "omr_sheet");

      return list;
    },
    enabled:
      typeof examId === "number" &&
      Number.isFinite(examId) &&
      examId > 0,
  });
}

export function isAssetsReady(assets: ExamAsset[]) {
  const hasPdf = assets.some((a) => a.asset_type === "problem_pdf");
  const hasOmr = assets.some((a) => a.asset_type === "omr_sheet");
  return hasPdf && hasOmr;
}


==========================================================================================
# FILE: hooks/useExamDetail.ts
==========================================================================================
/**
 * useExamDetail
 *
 * WHY:
 * - Batch1 Submissions íŒ¨ë„ì´ "exam ìƒì„¸"ë¥¼ ê°„ë‹¨íˆ ì†Œë¹„í•  ìˆ˜ ìˆë„ë¡ ë˜í•‘
 * - ê¸°ì¡´ useExam í›…(LOCKED)ì„ ì¡´ì¤‘í•˜ê³ , ì¶”ë¡ /ê³„ì‚° ì—†ì´ ê·¸ëŒ€ë¡œ ì „ë‹¬
 * - exams ë„ë©”ì¸ ë²”ìœ„ ë‚´ì—ì„œë§Œ ì œê³µ (ìƒˆ endpoint ê¸ˆì§€)
 */

import { useExam } from "./useExam";

export function useExamDetail(examId: number) {
  return useExam(examId);
}


==========================================================================================
# FILE: hooks/useExamEnrollments.ts
==========================================================================================
import { useQuery, useMutation } from "@tanstack/react-query";
import {
  fetchExamEnrollmentRows,
  updateExamEnrollmentRows,
} from "../api/examEnrollments";

export function useExamEnrollmentRows(
  examId?: number,
  sessionId?: number
) {
  return useQuery({
    queryKey: ["exam-enrollment", examId, sessionId],
    queryFn: () =>
      fetchExamEnrollmentRows({
        examId: examId!,
        sessionId: sessionId!,
      }),
    enabled:
      Number.isFinite(examId) &&
      Number.isFinite(sessionId),
  });
}

export function useUpdateExamEnrollmentRows(
  examId: number,
  sessionId: number
) {
  return useMutation({
    mutationFn: (payload: { enrollment_ids: number[] }) =>
      updateExamEnrollmentRows({
        examId,
        sessionId,
        enrollment_ids: payload.enrollment_ids,
      }),
  });
}


==========================================================================================
# FILE: panels/ExamAssetsPanel.tsx
==========================================================================================
/**
 * ExamAssetsPanel (Production)
 * - assets ë‹¨ì¼ì§„ì‹¤: GET /exams/{id}/assets/ (regularë„ template resolve)
 * - templateì—ì„œë§Œ ì—…ë¡œë“œ UI ë…¸ì¶œ(ë´‰ì¸ ì •ì±… ì¡´ì¤‘)
 * - ìì‚° ëˆ„ë½ ì‹œ "ì œì¶œ/ì±„ì  ì°¨ë‹¨ ì‚¬ìœ " ì²´í¬ë¦¬ìŠ¤íŠ¸ ì•ˆë‚´
 */

import { useMemo } from "react";
import { useSearchParams } from "react-router-dom";

import { useAdminExam } from "../hooks/useAdminExam";
import { useExamAssets } from "../hooks/useExamAssets";

import AssetReadinessBadge from "../components/AssetReadinessBadge";
import AssetBlockNotice from "../components/assets/AssetBlockNotice";
import AssetUploadSection from "../components/assets/AssetUploadSection";
import BlockReason from "../components/BlockReason";

function hasAsset(assets: any[], t: string) {
  return (assets ?? []).some((a) => a?.asset_type === t);
}

export default function ExamAssetsPanel({ examId }: { examId: number }) {
  const { data: exam } = useAdminExam(examId);
  const q = useExamAssets(examId);
  const assets = q.data ?? [];

  const [sp] = useSearchParams();
  const sessionId = Number(sp.get("session_id"));
  const hasSession = Number.isFinite(sessionId) && sessionId > 0;

  const hasPdf = useMemo(() => hasAsset(assets, "problem_pdf"), [assets]);
  const hasOmr = useMemo(() => hasAsset(assets, "omr_sheet"), [assets]);

  if (!exam) return null;

  const isTemplate = exam.exam_type === "template";
  const isRegular = exam.exam_type === "regular";

  return (
    <div className="space-y-4">
      <div className="flex justify-between border rounded p-4 bg-[var(--bg-surface)] border-[var(--border-divider)]">
        <div>
          <div className="font-semibold text-sm text-[var(--text-primary)]">
            ì‹œí—˜ ìì‚°
          </div>
          <div className="text-xs text-[var(--text-muted)]">
            ìš´ì˜ì— í•„ìš”í•œ PDF/OMR ìƒíƒœ (ì œì¶œ/ì±„ì  ê²Œì´íŠ¸)
          </div>
        </div>

        <AssetReadinessBadge assets={assets} />
      </div>

      {q.isLoading && (
        <div className="text-sm text-[var(--text-muted)]">
          ìì‚° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
        </div>
      )}

      {q.isError && (
        <BlockReason
          title="ìì‚° ì¡°íšŒ ì‹¤íŒ¨"
          description={
            String((q.error as any)?.response?.data?.detail || "ìì‚° ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.")
          }
        />
      )}

      {!q.isLoading && !q.isError && (
        <>
          {/* âœ… ìš´ì˜ ì‹œí—˜ ì•ˆë‚´ */}
          {isRegular && (
            <AssetBlockNotice
              title="ì½ê¸° ì „ìš© (ìš´ì˜ ì‹œí—˜)"
              description="ìš´ì˜ ì‹œí—˜ì€ í…œí”Œë¦¿ ìì‚°ì„ ì‚¬ìš©í•©ë‹ˆë‹¤. ìì‚° ì—…ë¡œë“œ/êµì²´ëŠ” í…œí”Œë¦¿ ì‹œí—˜ì—ì„œë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤."
            />
          )}

          {/* âœ… ìì‚° ëˆ„ë½ ì²´í¬ë¦¬ìŠ¤íŠ¸ */}
          {(!hasPdf || !hasOmr) && (
            <div className="rounded border border-yellow-600/30 bg-yellow-600/10 p-4 text-sm text-yellow-800 space-y-2">
              <div className="font-semibold">ìš´ì˜ ë¶ˆê°€: ìì‚°ì´ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤</div>
              <div className="text-xs">
                ì•„ë˜ í•­ëª©ì´ ëª¨ë‘ ì¶©ì¡±ë˜ì–´ì•¼ ì œì¶œ/ì±„ì  ê¸°ëŠ¥ì´ ì—´ë¦½ë‹ˆë‹¤.
              </div>

              <ul className="list-disc pl-5 text-sm">
                <li className={hasPdf ? "opacity-60" : ""}>
                  ì‹œí—˜ì§€ PDF (problem_pdf) {hasPdf ? "âœ…" : "âŒ"}
                </li>
                <li className={hasOmr ? "opacity-60" : ""}>
                  OMR ë‹µì•ˆì§€ (omr_sheet) {hasOmr ? "âœ…" : "âŒ"}
                </li>
              </ul>

              {isRegular && (
                <div className="text-xs">
                  â€» ì´ ì‹œí—˜ì€ <b>ìš´ì˜ ì‹œí—˜</b>ì´ë¼ ì—¬ê¸°ì„œ ì—…ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í…œí”Œë¦¿ ì‹œí—˜ì—ì„œ ìì‚°ì„ ë“±ë¡í•œ ë’¤ ë‹¤ì‹œ í™•ì¸í•˜ì„¸ìš”.
                </div>
              )}
            </div>
          )}

          {/* âœ… session_id ì•ˆë‚´(ìì‚°ê³¼ëŠ” ë³„ê°œì§€ë§Œ ìš´ì˜ íë¦„ìƒ ê°™ì´ ë³´ì—¬ì£¼ë©´ ì¢‹ìŒ) */}
          {!hasSession && (
            <div className="rounded border bg-[var(--bg-surface-soft)] p-3 text-sm text-[var(--text-muted)]">
              â„¹ï¸ í˜„ì¬ URLì— <b>session_id</b>ê°€ ì—†ìŠµë‹ˆë‹¤. ìì‚° ë“±ë¡ê³¼ ë³„ê°œë¡œ, ì œì¶œ/ê²°ê³¼/ëŒ€ìƒì ê´€ë¦¬ëŠ” session_idê°€ ìˆì–´ì•¼ ì—´ë¦½ë‹ˆë‹¤.
            </div>
          )}

          {/* âœ… ì—…ë¡œë“œ UIëŠ” templateì—ì„œë§Œ */}
          {isTemplate && (
            <div className="space-y-4">
              <AssetUploadSection
                examId={examId}
                assetType="problem_pdf"
                title="ì‹œí—˜ì§€ PDF"
                accept="application/pdf"
              />

              <AssetUploadSection
                examId={examId}
                assetType="omr_sheet"
                title="OMR ë‹µì•ˆì§€"
                accept="application/pdf"
              />
            </div>
          )}
        </>
      )}
    </div>
  );
}


==========================================================================================
# FILE: panels/ExamResultsPanel.tsx
==========================================================================================
/**
 * ExamResultsPanel (UX wrapper)
 *
 * WHY:
 * - results ë„ë©”ì¸ì´ ë‹¨ì¼ì§„ì‹¤: ì ìˆ˜/í•©ë¶ˆ/í†µê³„ëŠ” ì—¬ê¸°ì„œ ê³„ì‚° ê¸ˆì§€
 * - exams íƒ­ì—ì„œ "ê²°ê³¼ê°€ ì–´ë””ì„œ ìƒì„±ë˜ê³  ì–´ë””ì„œ ìˆ˜ì •ë˜ëŠ”ì§€"ë¥¼ ì‚¬ëŒ ì–¸ì–´ë¡œ ì•ˆë‚´
 * - ì‹¤ì œ í‘œ/í†µê³„ëŠ” results featureì˜ ExamResultsPanelì„ ê·¸ëŒ€ë¡œ ì‚¬ìš©
 */

import ExamResultsPanelInner from "@/features/results/panels/ExamResultsPanel";

export default function ExamResultsPanel({ examId }: { examId: number }) {
  return (
    <div className="space-y-4">
      <section className="rounded border border-[var(--border-divider)] bg-[var(--bg-surface)] p-4">
        <div className="text-sm font-semibold text-[var(--text-primary)]">
          ê²°ê³¼ / í†µê³„
        </div>
        <div className="mt-1 text-xs text-[var(--text-muted)]">
          ì ìˆ˜Â·í•©ë¶ˆÂ·í†µê³„ëŠ” <b>results</b> ë„ë©”ì¸ì´ ë‹¨ì¼ ì§„ì‹¤ì´ë©°, ì´ í™”ë©´ì€ í‘œì‹œë§Œ í•©ë‹ˆë‹¤.
        </div>
      </section>

      <ExamResultsPanelInner examId={examId} />
    </div>
  );
}


==========================================================================================
# FILE: panels/ExamResultsViewerPanel.tsx
==========================================================================================
import ExamResultsPanel
  from "@/features/results/panels/ExamResultsPanel";

export default function ExamResultsViewerPanel({
  examId,
}: {
  examId: number;
}) {
  return (
    <div className="space-y-3">
      <div>
        <div className="font-semibold text-sm">
          ì‹œí—˜ ê²°ê³¼
        </div>
        <div className="text-xs text-muted">
          í•™ìƒë³„ ê²°ê³¼ ë° í†µê³„
        </div>
      </div>

      <ExamResultsPanel examId={examId} />
    </div>
  );
}


==========================================================================================
# FILE: panels/ExamSubmissionsPanel.tsx
==========================================================================================
/**
 * ExamSubmissionsPanel
 *
 * WHY:
 * - ì‹œí—˜ ì œì¶œì€ session + asset ì¡°ê±´ì„ ë°˜ë“œì‹œ ë§Œì¡±í•´ì•¼ í•œë‹¤
 * - ë§‰íŒ ì´ìœ ë¥¼ ìƒë‹¨ì—ì„œ ëª…í™•íˆ ì„¤ëª…í•œë‹¤
 * - submissionsì˜ ì—­í• ê³¼ ê²°ê³¼ íë¦„ì„ ì‚¬ëŒ ì–¸ì–´ë¡œ ì•ˆë‚´í•œë‹¤
 */

import { useMemo } from "react";
import GateNotice from "../components/common/GateNotice";
import AdminOmrUploadSection from "../components/submissions/AdminOmrUploadSection";
import { useExamDetail } from "../hooks/useExamDetail";
import { useExamAssets } from "../hooks/useExamAssets";

export default function ExamSubmissionsPanel({
  examId,
  sessionId,
}: {
  examId: number;
  sessionId?: number;
}) {
  const { data: exam } = useExamDetail(examId);
  const { data: assets } = useExamAssets(examId);

  const hasSession = Number.isFinite(sessionId) && Number(sessionId) > 0;
  const hasProblemPdf = Boolean(assets?.problem_pdf);
  const hasOmrSheet = Boolean(assets?.omr_sheet);

  const blockedReason = useMemo(() => {
    if (!hasSession) return "NO_SESSION";
    if (!hasProblemPdf || !hasOmrSheet) return "NO_ASSET";
    return null;
  }, [hasSession, hasProblemPdf, hasOmrSheet]);

  if (blockedReason === "NO_SESSION") {
    return (
      <GateNotice
        title="ì„¸ì…˜ì´ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤"
        description="ì‹œí—˜ ì œì¶œì€ ë°˜ë“œì‹œ ì„¸ì…˜ ì»¨í…ìŠ¤íŠ¸ì—ì„œë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤."
        checklist={[
          "URLì— session_idê°€ í¬í•¨ë˜ì–´ì•¼ í•©ë‹ˆë‹¤",
          "ìš´ì˜ ì¤‘ì¸ ì°¨ì‹œ(Session)ë¥¼ ì„ íƒí•´ì•¼ í•©ë‹ˆë‹¤",
        ]}
      />
    );
  }

  if (blockedReason === "NO_ASSET") {
    return (
      <GateNotice
        title="ì‹œí—˜ ìì‚°ì´ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤"
        description="OMR ì œì¶œì„ ìœ„í•´ì„œëŠ” ë¬¸ì œì§€ì™€ OMR ì–‘ì‹ì´ ëª¨ë‘ í•„ìš”í•©ë‹ˆë‹¤."
        checklist={[
          hasProblemPdf ? "ë¬¸ì œì§€ PDF âœ”" : "ë¬¸ì œì§€ PDF í•„ìš”",
          hasOmrSheet ? "OMR ì–‘ì‹ âœ”" : "OMR ì–‘ì‹ í•„ìš”",
        ]}
      />
    );
  }

  return (
    <div className="space-y-6">
      <section className="rounded border border-[var(--border-divider)] bg-[var(--bg-surface)] p-4">
        <div className="text-sm font-semibold text-[var(--text-primary)]">
          ì œì¶œ ì²˜ë¦¬ íë¦„ ì•ˆë‚´
        </div>
        <ul className="mt-2 list-disc pl-5 text-sm text-[var(--text-secondary)] space-y-1">
          <li>ì œì¶œì€ submissions ë„ë©”ì¸ì—ì„œ ì´ë²¤íŠ¸ë¡œ ê¸°ë¡ë©ë‹ˆë‹¤.</li>
          <li>ë‹µì•ˆ ì¶”ì¶œ í›„ ìë™ìœ¼ë¡œ ì±„ì  íŒŒì´í”„ë¼ì¸ì´ ì‹¤í–‰ë©ë‹ˆë‹¤.</li>
          <li>ì ìˆ˜/í•©ë¶ˆ íŒë‹¨ì€ ê²°ê³¼ íƒ­ì—ì„œ í™•ì¸í•©ë‹ˆë‹¤.</li>
        </ul>
      </section>

      <AdminOmrUploadSection examId={examId} />
    </div>
  );
}


==========================================================================================
# FILE: panels/setup/ExamBulkActionsPanel.tsx
==========================================================================================
// PATH: src/features/exams/panels/setup/ExamBulkActionsPanel.tsx

import { useMutation } from "@tanstack/react-query";
import { recalculateExam } from "../../api/adminExam";
import AdminOmrBatchUploadBox from "@/features/submissions/components/AdminOmrBatchUploadBox";

export default function ExamBulkActionsPanel({ examId }: { examId: number }) {
  const recalc = useMutation({
    mutationFn: () => recalculateExam(examId),
  });

  return (
    <div className="space-y-3">
      <div>
        <div className="text-sm font-semibold">ì¼ê´„ ì‘ì—…</div>
        <div className="text-xs text-muted">
          ì¬ì±„ì  ì‹¤í–‰ ë° OMR / ì œì¶œ ë°ì´í„° ê´€ë¦¬
        </div>
      </div>

      <div className="surface p-4 space-y-4">
        <button
          onClick={() => recalc.mutate()}
          className="btn-danger"
          disabled={recalc.isPending}
        >
          {recalc.isPending ? "ì¬ì±„ì  ì¤‘..." : "ì¬ì±„ì  ì‹¤í–‰"}
        </button>

        <div className="surface-muted p-3">
          <div className="mb-2 text-xs font-semibold text-muted">
            OMR / ì œì¶œ ë°ì´í„° ì—…ë¡œë“œ
          </div>
          <AdminOmrBatchUploadBox examId={examId} />
        </div>
      </div>
    </div>
  );
}


==========================================================================================
# FILE: panels/setup/ExamEnrollmentPanel.tsx
==========================================================================================
/**
 * ExamEnrollmentPanel â€“ OPERATOR UX
 *
 * WHY:
 * - ëŒ€ìƒì ê´€ë¦¬ëŠ” "ì„¤ì • í™”ë©´"ì´ ì•„ë‹ˆë¼ "ì„ íƒ ëª¨ë‹¬"ì´ ë§ë‹¤
 * - ExamEnrollment PUT = ì™„ì „ ì¹˜í™˜ ê³„ì•½ ìœ ì§€
 * - enrollment_idë§Œ ì‚¬ìš© (student_id ì¶”ë¡  âŒ)
 */

import { useEffect, useState } from "react";
import { useSearchParams } from "react-router-dom";
import {
  useExamEnrollmentRows,
  useUpdateExamEnrollmentRows,
} from "../../hooks/useExamEnrollments";
import { fetchSessionEnrollments } from "../../api/sessionEnrollments";
import BlockReason from "../../components/BlockReason";

export default function ExamEnrollmentPanel({ examId }: { examId: number }) {
  const [sp] = useSearchParams();
  const sessionId = Number(sp.get("session_id"));

  if (!sessionId) {
    return (
      <BlockReason
        title="ì„¸ì…˜ ì»¨í…ìŠ¤íŠ¸ í•„ìš”"
        description="ëŒ€ìƒì ê´€ë¦¬ëŠ” ì„¸ì…˜(Session) ê¸°ì¤€ìœ¼ë¡œë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤."
      />
    );
  }

  const rowsQ = useExamEnrollmentRows(examId, sessionId);
  const updateMut = useUpdateExamEnrollmentRows(examId, sessionId);

  const serverRows = rowsQ.data?.items ?? [];

  const [open, setOpen] = useState(false);
  const [selected, setSelected] = useState<Set<number>>(new Set());

  useEffect(() => {
    const init = new Set<number>();
    serverRows.forEach((r) => {
      if (r.is_selected) init.add(r.enrollment_id);
    });
    setSelected(init);
  }, [serverRows]);

  const toggle = (id: number) => {
    setSelected((prev) => {
      const next = new Set(prev);
      next.has(id) ? next.delete(id) : next.add(id);
      return next;
    });
  };

  const apply = async () => {
    await updateMut.mutateAsync({
      enrollment_ids: Array.from(selected),
    });
    setOpen(false);
  };

  const importFromSession = async () => {
    const list = await fetchSessionEnrollments(sessionId);
    const ids = list.map((x) => x.enrollment);
    setSelected(new Set(ids));
  };

  return (
    <section className="rounded border border-[var(--border-divider)] bg-[var(--bg-surface)] p-6 space-y-4">
      <div className="flex justify-between items-center">
        <div>
          <div className="text-sm font-semibold">ì‹œí—˜ ëŒ€ìƒì</div>
          <div className="text-xs text-[var(--text-muted)]">
            í˜„ì¬ ì„ íƒ: {selected.size}ëª…
          </div>
        </div>

        <button
          onClick={() => setOpen(true)}
          className="h-10 px-4 rounded bg-[var(--color-primary)] text-white text-sm font-semibold"
        >
          ëŒ€ìƒì ë“±ë¡
        </button>
      </div>

      {/* ëª¨ë‹¬ */}
      {open && (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/40">
          <div className="w-[560px] max-h-[80vh] overflow-hidden rounded bg-white shadow">
            <div className="border-b px-4 py-3 flex justify-between">
              <div className="font-semibold">ëŒ€ìƒì ì„ íƒ</div>
              <button onClick={() => setOpen(false)}>ë‹«ê¸°</button>
            </div>

            <div className="p-4 space-y-3 overflow-auto">
              <button
                onClick={importFromSession}
                className="text-sm underline"
              >
                ì„¸ì…˜ ë‚´ í•™ìƒ ì „ì²´ ì„ íƒ
              </button>

              <div className="space-y-2">
                {serverRows.map((r) => (
                  <label
                    key={r.enrollment_id}
                    className="flex justify-between items-center border rounded px-3 py-2 text-sm"
                  >
                    <span>{r.student_name}</span>
                    <input
                      type="checkbox"
                      checked={selected.has(r.enrollment_id)}
                      onChange={() => toggle(r.enrollment_id)}
                    />
                  </label>
                ))}
              </div>
            </div>

            <div className="border-t px-4 py-3 flex justify-end gap-2">
              <button className="btn" onClick={() => setOpen(false)}>
                ì·¨ì†Œ
              </button>
              <button
                className="btn-primary"
                onClick={apply}
                disabled={updateMut.isPending}
              >
                ì ìš©
              </button>
            </div>
          </div>
        </div>
      )}
    </section>
  );
}


==========================================================================================
# FILE: panels/setup/ExamPolicyPanel.tsx
==========================================================================================
/**
 * ExamPolicyPanel â€“ PRODUCTION SAFE
 *
 * WHY:
 * - examì€ ë¹„ë™ê¸° ë¡œë”© ëŒ€ìƒì´ë¯€ë¡œ undefined ë°©ì–´ í•„ìˆ˜
 * - ì»¤íŠ¸ë¼ì¸ / ì§„í–‰ìƒíƒœë§Œ ì¸ê°„ ì¹œí™”ì ìœ¼ë¡œ ì œì–´
 * - session_id ì…ë ¥ / ì¶”ë¡  UIëŠ” ì ˆëŒ€ ë…¸ì¶œí•˜ì§€ ì•ŠìŒ
 */

import { useEffect, useMemo, useState } from "react";
import type { Exam } from "../../types";

type PatchPayload = Pick<Exam, "pass_score" | "is_active">;

export default function ExamPolicyPanel({
  exam,
  onPatch,
  isPatching,
}: {
  exam?: Exam | null;
  onPatch: (payload: PatchPayload) => Promise<void>;
  isPatching: boolean;
}) {
  // ----------------------------
  // ì•ˆì „ ê°€ë“œ (ê°€ì¥ ì¤‘ìš”)
  // ----------------------------
  if (!exam) {
    return (
      <section className="rounded border border-[var(--border-divider)] bg-[var(--bg-surface-soft)] p-4">
        <div className="text-sm font-medium text-[var(--text-muted)]">
          ì‹œí—˜ ì •ì±…ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤â€¦
        </div>
      </section>
    );
  }

  // ----------------------------
  // local state
  // ----------------------------
  const [passScore, setPassScore] = useState<number>(0);
  const [savedScore, setSavedScore] = useState<number>(0);
  const [isActive, setIsActive] = useState<boolean>(false);

  useEffect(() => {
    const ps = Number(exam.pass_score ?? 0);
    setPassScore(ps);
    setSavedScore(ps);
    setIsActive(Boolean(exam.is_active));
  }, [exam.id]);

  const isDirty = useMemo(
    () => passScore !== savedScore,
    [passScore, savedScore]
  );

  // ----------------------------
  // actions
  // ----------------------------
  const savePassScore = async () => {
    await onPatch({
      pass_score: passScore,
      is_active: isActive,
    });
    setSavedScore(passScore);
  };

  const toggleActive = async () => {
    const next = !isActive;
    setIsActive(next);
    await onPatch({
      pass_score: passScore,
      is_active: next,
    });
  };

  // ----------------------------
  // render
  // ----------------------------
  return (
    <section className="space-y-6 rounded border border-[var(--border-divider)] bg-[var(--bg-surface)] p-5">
      {/* Header */}
      <div>
        <div className="text-lg font-semibold text-[var(--text-primary)]">
          ì‹œí—˜ ì •ì±…
        </div>
        <div className="text-xs text-[var(--text-muted)]">
          ì»¤íŠ¸ë¼ì¸ê³¼ ì‹œí—˜ ì§„í–‰ ìƒíƒœë¥¼ ì„¤ì •í•©ë‹ˆë‹¤
        </div>
      </div>

      {/* Control Row */}
      <div className="flex items-end gap-6">
        {/* Pass Score */}
        <div>
          <div className="mb-1 text-sm text-[var(--text-muted)]">
            ì»¤íŠ¸ë¼ì¸
          </div>
          <input
            type="number"
            min={0}
            value={passScore}
            onChange={(e) => setPassScore(Number(e.target.value))}
            className="w-[180px] rounded border px-3 py-2 text-4xl font-bold"
            disabled={isPatching}
          />
        </div>

        {/* Save */}
        <button
          type="button"
          onClick={savePassScore}
          disabled={!isDirty || isPatching}
          className={[
            "h-14 rounded px-8 text-lg font-semibold transition",
            !isDirty || isPatching
              ? "cursor-not-allowed bg-gray-300 text-gray-500"
              : "bg-[var(--color-primary)] text-white",
          ].join(" ")}
        >
          ì»¤íŠ¸ë¼ì¸ ì €ì¥
        </button>

        {/* Status */}
        <button
          type="button"
          onClick={toggleActive}
          disabled={isPatching}
          className={[
            "h-14 rounded px-10 text-lg font-bold transition",
            isActive
              ? "bg-emerald-600 text-white"
              : "bg-red-600 text-white",
          ].join(" ")}
        >
          {isActive ? "ì§„í–‰ì¤‘" : "ì¢…ë£Œ"}
        </button>
      </div>

      {/* Help */}
      <div className="text-xs text-[var(--text-muted)] leading-relaxed">
        â€¢ ì´ ì ìˆ˜ ì´ìƒì´ë©´ í•©ê²© ì—¬ë¶€ëŠ” Results ë„ë©”ì¸ì—ì„œ ìë™ íŒì •ë©ë‹ˆë‹¤.<br />
        â€¢ ì‹œí—˜ ì‹œì‘ ë‚ ì§œëŠ” ì°¨ì‹œ(Session) ì¼ì •ê³¼ ìë™ìœ¼ë¡œ ì—°ë™ë©ë‹ˆë‹¤.
      </div>
    </section>
  );
}


==========================================================================================
# FILE: panels/setup/ExamSetupPanel.tsx
==========================================================================================
// // PATH: src/features/exams/panels/setup/ExamSetupPanel.tsx
// /**
//  * ExamSetupPanel
//  *
//  * âœ… HomeworkSetupPanel UI íŒ¨í„´ì„ canonicalë¡œ ì ìš©
//  * - card wrapper ì œê±°
//  * - section ë‹¨ìœ„ êµ¬ì„±
//  * - ì•ˆë‚´ ì˜ì—­ì€ bg-surface-soft ì‚¬ìš©
//  *
//  * âŒ ë¡œì§ / API / ìƒíƒœ ë³€ê²½ ì—†ìŒ
//  */

// import { useMemo, useState, useEffect } from "react";
// import { useSearchParams } from "react-router-dom";
// import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";

// import ExamPolicyPanel from "./ExamPolicyPanel";
// import ExamBulkActionsPanel from "./ExamBulkActionsPanel";

// import { useAdminExam } from "../../hooks/useAdminExam";
// import {
//   fetchExamEnrollmentRows,
//   updateExamEnrollmentRows,
//   type ExamEnrollmentRow,
// } from "../../api/examEnrollments";

// // âœ… ì‚¬ìš©
// import EnrollmentManageModal
//   from "@/features/sessions/components/enrollment/EnrollmentManageModal";
// export default function ExamSetupPanel({ examId }: { examId: number }) {
//   const qc = useQueryClient();
//   const { data: exam } = useAdminExam(examId);
//   const [searchParams] = useSearchParams();

//   const sessionId = useMemo(() => {
//     const fromQuery = Number(searchParams.get("sessionId"));
//     if (Number.isFinite(fromQuery) && fromQuery > 0) return fromQuery;

//     const path = window.location.pathname;
//     const idx = path.indexOf("/sessions/");
//     if (idx >= 0) {
//       const rest = path.slice(idx + "/sessions/".length);
//       const sid = Number(rest.split("/")[0]);
//       if (Number.isFinite(sid) && sid > 0) return sid;
//     }

//     return 0;
//   }, [searchParams]);

//   const hasSession = Number.isFinite(sessionId) && sessionId > 0;

//   const enrollQ = useQuery({
//     queryKey: ["exam-enrollment-manage", examId, sessionId],
//     queryFn: () => fetchExamEnrollmentRows({ examId, sessionId }),
//     enabled: hasSession && Number.isFinite(examId),
//   });

//   const serverRows: ExamEnrollmentRow[] = enrollQ.data?.items ?? [];

//   const [selected, setSelected] = useState<Set<number>>(new Set());
//   const [open, setOpen] = useState(false);

//   useEffect(() => {
//     if (!open) return;
//     const init = new Set<number>();
//     for (const r of serverRows) {
//       if (r.is_selected) init.add(r.enrollment_id);
//     }
//     setSelected(init);
//   }, [open, serverRows]);

//   const selectedCount = selected.size;

//   const saveMut = useMutation({
//     mutationFn: async () => {
//       const ids = Array.from(selected).sort((a, b) => a - b);
//       return updateExamEnrollmentRows({
//         examId,
//         sessionId,
//         enrollment_ids: ids,
//       });
//     },
//     onSuccess: async () => {
//       await qc.invalidateQueries({
//         queryKey: ["exam-enrollment-manage", examId, sessionId],
//       });
//       alert("ì €ì¥ ì™„ë£Œ: ì‹œí—˜ ì‘ì‹œ ëŒ€ìƒìê°€ ê°±ì‹ ë˜ì—ˆìŠµë‹ˆë‹¤.");
//       setOpen(false);
//     },
//     onError: (e: any) => {
//       alert(e?.response?.data?.detail || "ì €ì¥ ì‹¤íŒ¨");
//     },
//   });

//   const toggle = (id: number) => {
//     setSelected((prev) => {
//       const next = new Set(prev);
//       next.has(id) ? next.delete(id) : next.add(id);
//       return next;
//     });
//   };

//   return (
//     <div className="space-y-6">
//       {/* ì‹œí—˜ ì •ì±… */}
//       <ExamPolicyPanel examId={examId} />

//       {/* ì‹œí—˜ ì‘ì‹œ ëŒ€ìƒ í•™ìƒ */}
//       <section className="rounded border bg-[var(--bg-surface)]">
//         <div className="border-b px-4 py-3">
//           <div className="text-sm font-semibold text-[var(--text-primary)]">
//             ì‹œí—˜ ì‘ì‹œ ëŒ€ìƒ í•™ìƒ
//           </div>
//           <div className="text-xs text-[var(--text-muted)]">
//             ì„¸ì…˜ ë“±ë¡ í•™ìƒ ì¤‘ ì„ íƒí•˜ì—¬ ì‹œí—˜ ì‘ì‹œ ëŒ€ìƒìë¥¼ ê´€ë¦¬í•©ë‹ˆë‹¤.
//           </div>
//         </div>

//         <div className="p-4 space-y-3">
//           {!hasSession && (
//             <div className="rounded border bg-[var(--bg-surface-soft)] p-3 text-sm text-[var(--text-muted)]">
//               âš ï¸ sessionId ì»¨í…ìŠ¤íŠ¸ê°€ ì—†ì–´ ëŒ€ìƒì ê´€ë¦¬ë¥¼ í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
//             </div>
//           )}

//           {hasSession && enrollQ.isLoading && (
//             <div className="text-sm text-[var(--text-muted)]">
//               ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
//             </div>
//           )}

//           {hasSession && enrollQ.isError && (
//             <div className="text-sm text-red-600">
//               ëŒ€ìƒì ì¡°íšŒ ì‹¤íŒ¨ (examê³¼ session ì—°ê²° í™•ì¸ í•„ìš”)
//             </div>
//           )}

//           {hasSession && !enrollQ.isLoading && !enrollQ.isError && (
//             <>
//               <div className="flex items-center justify-between rounded border bg-[var(--bg-surface-soft)] px-3 py-2">
//                 <div className="text-sm text-[var(--text-primary)]">
//                   ì„ íƒëœ ëŒ€ìƒì:{" "}
//                   <span className="font-semibold">{selectedCount}ëª…</span>
//                 </div>
//                 <div className="text-xs text-[var(--text-muted)]">
//                   session #{sessionId}
//                 </div>
//               </div>

//               <button
//                 type="button"
//                 className="rounded border px-3 py-2 text-sm hover:bg-[var(--bg-surface-soft)]"
//                 onClick={() => setOpen(true)}
//               >
//                 ì‹œí—˜ ì‘ì‹œ ëŒ€ìƒì ë“±ë¡ / ì œê±°
//               </button>
//             </>
//           )}
//         </div>
//       </section>

//       {/* ì•ˆë‚´ */}
//       <section className="rounded border bg-[var(--bg-surface-soft)] p-4 text-sm text-[var(--text-muted)]">
//         â„¹ï¸ ì‹œí—˜ ì ìˆ˜ ì…ë ¥ Â· ì±„ì  Â· íŒì •ì€{" "}
//         <b className="text-[var(--text-primary)]">ì„¸ì…˜ &gt; ì„±ì </b> ë©”ë‰´ì—ì„œ
//         ì§„í–‰í•©ë‹ˆë‹¤.
//       </section>

//       {/* ì¼ê´„ ì‘ì—… */}
//       <ExamBulkActionsPanel examId={examId} />

//       {/* ê³µìš© Enrollment Modal (ë‹¤ìŒ ë‹¨ê³„ì—ì„œ ì „ì—­í™” ì˜ˆì •) */}
//       {hasSession && (
//         <EnrollmentManageModal
//           open={open}
//           onClose={() => setOpen(false)}
//           title="ì‹œí—˜ ì‘ì‹œ ëŒ€ìƒì ê´€ë¦¬"
//           description="ì„¸ì…˜ ë“±ë¡ í•™ìƒ ì¤‘ì—ì„œ ì‹œí—˜ ì‘ì‹œ ëŒ€ìƒìë¥¼ ì„ íƒ í›„ ì €ì¥í•˜ì„¸ìš”."
//           sessionId={sessionId}
//           rows={serverRows}
//           loading={enrollQ.isLoading}
//           error={
//             enrollQ.isError
//               ? "ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨ (session_id ì—°ê²°ì„ í™•ì¸í•˜ì„¸ìš”)"
//               : null
//           }
//           selectedIds={selected}
//           onToggle={toggle}
//           onSave={() => saveMut.mutate()}
//           saving={saveMut.isPending}
//         />
//       )}
//     </div>
//   );
// }

import { useSearchParams } from "react-router-dom";
import ExamPolicyPanel from "./ExamPolicyPanel";
import ExamBulkActionsPanel from "./ExamBulkActionsPanel";
import BlockReason from "../../components/BlockReason";

export default function ExamSetupPanel({ examId }: { examId: number }) {
  const [sp] = useSearchParams();
  const sessionId = Number(sp.get("session_id"));

  const hasSession = Number.isFinite(sessionId) && sessionId > 0;

  return (
    <div className="space-y-6">
      <ExamPolicyPanel examId={examId} />

      {!hasSession && (
        <BlockReason
          title="ì„¸ì…˜ ì»¨í…ìŠ¤íŠ¸ í•„ìš”"
          description="ëŒ€ìƒì ê´€ë¦¬ ë° ì œì¶œ/ê²°ê³¼ëŠ” session_idê°€ ìˆì„ ë•Œë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤."
        />
      )}

      <ExamBulkActionsPanel examId={examId} />
    </div>
  );
}


==========================================================================================
# FILE: types/ui.ts
==========================================================================================
// PATH: src/features/exams/types/ui.ts

export type QuestionImageItem = {
  question_no: number;
  image_url: string;
};


==========================================================================================
# FILE: utils/sessionContext.ts
==========================================================================================
// PATH: src/features/exams/utils/sessionContext.ts

/**
 * Session Context Resolver
 *
 * ìš°ì„ ìˆœìœ„:
 * 1) query ?session_id=
 * 2) pathname /sessions/:id
 */
export function resolveSessionIdFromLocation(
  search: string,
  pathname: string
): number {
  // 1) query ?session_id=
  const sp = new URLSearchParams(search);
  const q = Number(sp.get("session_id"));
  if (Number.isFinite(q) && q > 0) return q;

  // 2) pathname /sessions/:id
  const m = pathname.match(/\/sessions\/(\d+)/);
  const p = m ? Number(m[1]) : 0;
  if (Number.isFinite(p) && p > 0) return p;

  return 0;
}
