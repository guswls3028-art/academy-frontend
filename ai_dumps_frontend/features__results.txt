====================================================================================================
# FRONTEND FOLDER: features__results
# ROOT PATH: C:\academyfront\src\features\results
====================================================================================================


==========================================================================================
# FILE: api/adminExamItemScore.ts
==========================================================================================
/**
 * PATH: src/features/results/api/adminExamItemScore.ts
 *
 * âœ… Admin Subjective Item Score API
 *
 * ì±…ì„:
 * - ì£¼ê´€ì‹ ë¬¸í•­ ì ìˆ˜ ë‹¨ìœ„ PATCH
 *
 * â— ê·œì¹™:
 * - ì„±ê³µ/ì‹¤íŒ¨ ì—¬ë¶€ë§Œ íŒë‹¨
 * - ê²°ê³¼ ìƒíƒœëŠ” ë°˜ë“œì‹œ detail ì¬ì¡°íšŒë¡œ í™•ì¸
 */

import api from "@/shared/api/axios";

export async function patchExamItemScore(params: {
  examId: number;
  enrollmentId: number;
  questionId: number;
  score: number;
}) {
  const { examId, enrollmentId, questionId, score } = params;

  const res = await api.patch(
    `/results/admin/exams/${examId}/enrollments/${enrollmentId}/items/${questionId}/`,
    { score }
  );

  return res.data;
}


==========================================================================================
# FILE: api/adminExamResultDetail.ts
==========================================================================================
/**
 * PATH: src/features/results/api/adminExamResultDetail.ts
 *
 * âœ… Admin Exam Result Detail API (Phase 4 - A1)
 *
 * ë³€ê²½ ìš”ì•½:
 * - edit_state í•„ë“œ ëª…ì‹œì  í¬í•¨ (optional âŒ)
 * - ë¬¸í•­ ë‹¨ìœ„ is_editable backend flag ë°˜ì˜
 *
 * âš ï¸ ê·œì¹™:
 * - edit_state ëˆ„ë½ ì‹œ í”„ë¡ íŠ¸ëŠ” í¸ì§‘ ë¶ˆê°€ ì²˜ë¦¬
 */

import api from "@/shared/api/axios";
import type { EditState } from "../types/editState";

export type ExamResultItem = {
  question_id: number;
  answer: string;
  is_correct: boolean;
  score: number;
  max_score: number;

  /**
   * âœ… backend ì±…ì„
   * - ì£¼ê´€ì‹/ê°ê´€ì‹ íŒë‹¨ âŒ
   * - í”„ë¡ íŠ¸ëŠ” ì´ ê°’ë§Œ ì‹ ë¢°
   */
  is_editable: boolean;

  meta?: any;
};

export type ExamResultDetail = {
  target_type: "exam";
  target_id: number;
  enrollment_id: number;

  attempt_id: number | null;

  total_score: number;
  max_score: number;
  submitted_at: string | null;

  items: ExamResultItem[];

  /**
   * ğŸ”’ Phase 4 í•µì‹¬
   * - ë°˜ë“œì‹œ ì¡´ì¬í•´ì•¼ í•¨
   * - ì—†ìœ¼ë©´ í”„ë¡ íŠ¸ëŠ” Fail Closed
   */
  edit_state: EditState;
};

export async function fetchAdminExamResultDetail(
  examId: number,
  enrollmentId: number
): Promise<ExamResultDetail> {
  const res = await api.get(
    `/results/admin/exams/${examId}/enrollments/${enrollmentId}/`
  );
  return res.data;
}


==========================================================================================
# FILE: api/adminSessionExams.ts
==========================================================================================
// PATH: src/features/results/api/adminSessionExams.ts

import api from "@/shared/api/axios";

export type SessionExamRow = {
  exam_id: number;
  title: string;
  open_at: string | null;
  close_at: string | null;
  allow_retake: boolean;
  max_attempts: number;
};

export async function fetchAdminSessionExams(sessionId: number) {
  const res = await api.get(
    `/results/admin/sessions/${sessionId}/exams/`
  );

  const d = res.data;

  // âœ… ë°©ì–´ íŒŒì‹±ë§Œ ì¶”ê°€ (ì´ê²ƒë§Œ)
  if (Array.isArray(d)) return d;
  if (Array.isArray(d?.items)) return d.items;
  if (Array.isArray(d?.results)) return d.results;

  return [];
}


==========================================================================================
# FILE: api/client.ts
==========================================================================================
// src/features/results/api/client.ts
// ------------------------------------------------------------
// Results Domain ApiClient
// - ê´€ë¦¬ì / ìš´ì˜ììš© ì„±ì Â·í†µê³„Â·ì˜¤ë‹µ API ì „ìš©
// - exams / lectures ë„ë©”ì¸ ì ‘ê·¼ âŒ
// ------------------------------------------------------------

import axios, { AxiosInstance } from "axios";

type ClientOptions = {
  baseUrl: string;
  getAccessToken?: () => string | null;
};

export class ApiClient {
  private http: AxiosInstance;

  constructor({ baseUrl, getAccessToken }: ClientOptions) {
    this.http = axios.create({
      baseURL: baseUrl,
    });

    // âœ… access token ìë™ ì£¼ì…
    this.http.interceptors.request.use((config) => {
      const token = getAccessToken?.();
      if (token) {
        config.headers.Authorization = `Bearer ${token}`;
      }
      return config;
    });
  }

  /* =====================================================
   * ğŸ”§ [ì¶”ê°€]
   * Generic HTTP helpers
   *
   * ëª©ì :
   * - hooks / panels ì—ì„œ api.get<T>() íŒ¨í„´ ì‚¬ìš© ê°€ëŠ¥í•˜ê²Œ
   * - axios ì§ì ‘ ë…¸ì¶œ âŒ
   * - results ë„ë©”ì¸ ë‚´ë¶€ í†µì‹  í‘œì¤€í™”
   * ===================================================== */

  async get<T = any>(url: string, config?: any): Promise<T> {
    const res = await this.http.get(url, config);
    return res.data as T;
  }

  async post<T = any>(url: string, data?: any, config?: any): Promise<T> {
    const res = await this.http.post(url, data, config);
    return res.data as T;
  }

  async put<T = any>(url: string, data?: any, config?: any): Promise<T> {
    const res = await this.http.put(url, data, config);
    return res.data as T;
  }

  async delete<T = any>(url: string, config?: any): Promise<T> {
    const res = await this.http.delete(url, config);
    return res.data as T;
  }

  /* =====================================================
   * Admin Exam Results (ë„ë©”ì¸ ì „ìš© ê³ ìˆ˜ì¤€ API)
   * ===================================================== */

  /**
   * ê´€ë¦¬ì ì‹œí—˜ ì„±ì  ë¦¬ìŠ¤íŠ¸
   * GET /results/admin/exams/{exam_id}/results/
   */
  async getAdminExamResults(examId: number) {
    const res = await this.http.get(
      `/results/admin/exams/${examId}/results/`
    );
    return res.data;
  }

  /**
   * ê´€ë¦¬ì ì‹œí—˜ í†µê³„ ìš”ì•½
   * GET /results/admin/exams/{exam_id}/summary/
   */
  async getAdminExamSummary(examId: number) {
    const res = await this.http.get(
      `/results/admin/exams/${examId}/summary/`
    );
    return res.data;
  }

  /**
   * ì„¸ì…˜ ë‹¨ìœ„ ì„±ì  ìš”ì•½
   * GET /results/admin/sessions/{session_id}/score-summary/
   */
  async getSessionScoreSummary(sessionId: number) {
    const res = await this.http.get(
      `/results/admin/sessions/${sessionId}/score-summary/`
    );
    return res.data;
  }

  /* =====================================================
   * Question / Wrong Note
   * ===================================================== */

  /**
   * ë¬¸í•­ë³„ í†µê³„
   * GET /results/admin/exams/{exam_id}/questions/
   */
  async getExamQuestionStats(examId: number) {
    const res = await this.http.get(
      `/results/admin/exams/${examId}/questions/`
    );
    return res.data;
  }

  /**
   * ë‹¨ì¼ í•™ìƒ ì˜¤ë‹µ ë…¸íŠ¸
   * GET /results/wrong-notes?exam_id=&enrollment_id=
   */
  async getWrongNotes(params: {
    examId: number;
    enrollmentId: number;
  }) {
    const res = await this.http.get(`/results/wrong-notes`, {
      params: {
        exam_id: params.examId,
        enrollment_id: params.enrollmentId,
      },
    });
    return res.data;
  }
}


==========================================================================================
# FILE: api/endpoints.ts
==========================================================================================
export const resultsEndpoints = {
  // 1) Results
  myExamResult: (examId: number) => `/results/me/exams/${examId}/`,
  adminExamResults: (examId: number) => `/results/admin/exams/${examId}/results/`,
  adminExamResultDetail: (examId: number, enrollmentId: number) =>
    `/results/admin/exams/${examId}/enrollments/${enrollmentId}/`,

  // 2) Analytics
  adminExamSummary: (examId: number) => `/results/admin/exams/${examId}/summary/`,
  sessionScoreSummary: (sessionId: number) => `/results/admin/sessions/${sessionId}/score-summary/`,
  questionStats: (examId: number) => `/results/admin/exams/${examId}/questions/`,
  topWrongQuestions: (examId: number, n = 5) => `/results/admin/exams/${examId}/questions/top-wrong/?n=${n}`,

  // 3) Wrong notes
  wrongNotes: (params: {
    enrollment_id: number;
    exam_id?: number;
    lecture_id?: number;
    from_session_order?: number;
    offset?: number;
    limit?: number;
  }) => {
    const q = new URLSearchParams();
    q.set("enrollment_id", String(params.enrollment_id));
    if (params.exam_id != null) q.set("exam_id", String(params.exam_id));
    if (params.lecture_id != null) q.set("lecture_id", String(params.lecture_id));
    if (params.from_session_order != null) q.set("from_session_order", String(params.from_session_order));
    if (params.offset != null) q.set("offset", String(params.offset));
    if (params.limit != null) q.set("limit", String(params.limit));
    return `/results/wrong-notes?${q.toString()}`;
  },

  wrongNotePdfCreate: `/results/wrong-notes/pdf/`,
  wrongNotePdfStatus: (jobId: number) => `/results/wrong-notes/pdf/${jobId}/`,
};


==========================================================================================
# FILE: api/myExamResult.ts
==========================================================================================
// PATH: src/features/results/api/myExamResult.ts
import api from "@/shared/api/axios";

export type MyExamResultItem = {
  question_id: number;
  answer: string;
  is_correct: boolean;
  score: number;
  max_score: number;
  source: string;
};

export type MyExamResult = {
  target_type: "exam";
  target_id: number; // exam_id
  enrollment_id: number;

  // âœ… ë°±ì—”ë“œê°€ ë‚´ë ¤ì¤Œ (ëŒ€í‘œ attempt ìŠ¤ëƒ…ìƒ· ê¸°ì¤€)
  attempt_id: number | null;

  total_score: number;
  max_score: number;
  submitted_at: string | null;

  // âœ… ì¬ì‹œí—˜ ë²„íŠ¼ íŒë‹¨ìš©: ë°±ì—”ë“œ ê³„ì‚°ê°’
  allow_retake: boolean;
  max_attempts: number;
  can_retake: boolean;

  // âœ… progress pipeline ê²°ê³¼
  clinic_required: boolean;

  // âš ï¸ ì£¼ì˜: passedëŠ” í˜„ì¬ ë°±ì—”ë“œê°€ ëª…ì‹œì ìœ¼ë¡œ ì œê³µí•˜ì§€ ì•ŠìŒ
  // - pass ì—¬ë¶€ë¥¼ í™”ë©´ì— ë³´ì—¬ì£¼ë ¤ë©´ pass_score ì •ì±…ê³¼ ê³„ì‚° ê¸°ì¤€ì„ ë°±ì—”ë“œì™€ ë¨¼ì € í™•ì •í•´ì•¼ ì•ˆì „í•¨
  passed?: boolean;

  items: MyExamResultItem[];
};

export async function fetchMyExamResult(examId: number): Promise<MyExamResult> {
  const res = await api.get(`/results/me/exams/${examId}/`);
  return res.data;
}


==========================================================================================
# FILE: api/wrongNotes.ts
==========================================================================================
// PATH: src/features/results/api/wrongNotes.ts
import api from "@/shared/api/axios";

export type WrongNoteItem = {
  exam_id: number;
  attempt_id: number;

  // âœ… ë³´ì™„: ë°±ì—”ë“œ ì‘ë‹µì— ì¡´ì¬ (í‘œì‹œ/ì •ë ¬/attempt ë¹„êµ UXì— ìœ ìš©)
  attempt_created_at?: string | null;

  question_id: number;
  question_number?: number | null;

  // âœ… ë³´ì™„: ê°ê´€ì‹/ì£¼ê´€ì‹ êµ¬ë¶„ ë° UI ë¶„ê¸°ìš©
  answer_type?: string;

  student_answer: string;
  correct_answer: string;

  // âœ… ë³´ì™„: ë°±ì—”ë“œê°€ ë‚´ë ¤ì£¼ëŠ” is_correct/ë©”íƒ€ ê¸°ë°˜ UI ì²˜ë¦¬ ê°€ëŠ¥
  is_correct?: boolean;

  score: number;
  max_score: number;

  // âœ… í•µì‹¬: bbox í•˜ì´ë¼ì´íŠ¸, invalid_reason(LOW_CONFIDENCE ë“±) í‘œì‹œìš©
  meta?: any;

  // âœ… í™•ì¥ í¬ì¸íŠ¸ (í•´ì„¤/ì§€ë¬¸ ë“±)
  extra?: any;
};

export type WrongNoteResponse = {
  count: number;
  next: number | null;
  prev: number | null;
  results: WrongNoteItem[];
};

export async function fetchWrongNotes(params: {
  enrollment_id: number;
  exam_id?: number;
  lecture_id?: number;
  from_session_order?: number;
  offset?: number;
  limit?: number;
}) {
  const res = await api.get("/results/wrong-notes", { params });
  return res.data as WrongNoteResponse;
}

export type WrongNotePDFCreateResponse = {
  job_id: number;
  status: string; // PENDING/RUNNING/DONE/FAILED
  status_url: string; // absolute url (backend provides)
};

export async function createWrongNotePDF(payload: {
  enrollment_id: number;
  exam_id?: number;
  lecture_id?: number;
  from_session_order?: number;
}) {
  const res = await api.post("/results/wrong-notes/pdf/", payload);
  return res.data as WrongNotePDFCreateResponse;
}

export type WrongNotePDFStatusResponse = {
  job_id: number;
  status: string; // PENDING/RUNNING/DONE/FAILED
  file_path: string;
  file_url: string | null;
  error_message: string;
  created_at: string;
  updated_at: string;
};

export async function fetchWrongNotePDFStatus(jobId: number) {
  // âœ… ë³´ì™„: polling ì „ìš© API
  const res = await api.get(`/results/wrong-notes/pdf/${jobId}/`);
  return res.data as WrongNotePDFStatusResponse;
}


==========================================================================================
# FILE: components/AdminExamResultsTable.tsx
==========================================================================================
/**
 * PATH: src/features/results/components/AdminExamResultsTable.tsx
 *
 * âœ… AdminExamResultsTable (Backend Contract Aligned)
 *
 * ë³€ê²½ ìš”ì•½:
 * - exam_score / exam_max_score ì˜ì¡´ ì œê±° (ë°±ì—”ë“œ ë¦¬ìŠ¤íŠ¸ ê³„ì•½ì— ì—†ìŒ)
 * - final_score / passed ê¸°ë°˜ í‘œì‹œ
 * - ëŒ€í‘œ attempt/ìµœì¢… ì ìˆ˜ ì—†ëŠ” ì¼€ì´ìŠ¤ë¥¼ "â€”" ë¡œ ëª…í™•í™”
 *
 * â— ê¸°ì¡´ props / êµ¬ì¡° ìœ ì§€
 */

import { AdminExamResultRow } from "../types/results.types";
import { deriveFrontResultStatus } from "../utils/deriveFrontResultStatus";
import FrontResultStatusBadge from "./FrontResultStatusBadge";

function scoreCell(r: AdminExamResultRow) {
  // ëŒ€í‘œ attempt ê¸°ì¤€ final_scoreê°€ ë‹¨ì¼ ì§„ì‹¤
  const fs = r.final_score;
  if (fs === null || fs === undefined) return "â€”";
  if (typeof fs === "number") return String(fs);
  return "â€”";
}

export default function AdminExamResultsTable({
  rows,
  onSelectEnrollment,
}: {
  rows: AdminExamResultRow[];
  onSelectEnrollment: (id: number) => void;
}) {
  return (
    <table className="w-full text-sm border">
      <thead className="bg-gray-100">
        <tr>
          <th className="p-2 text-left">í•™ìƒ</th>
          <th className="p-2 text-center">ìµœì¢…ì ìˆ˜</th>
          <th className="p-2 text-center">ìƒíƒœ</th>
          <th className="p-2 text-center">í•©ê²©</th>
        </tr>
      </thead>

      <tbody>
        {rows.map((r) => {
          const frontStatus = deriveFrontResultStatus(r);
          const passed = r.passed;

          return (
            <tr
              key={r.enrollment_id}
              className="cursor-pointer hover:bg-gray-50"
              onClick={() => onSelectEnrollment(r.enrollment_id)}
              title={`enrollment_id: ${r.enrollment_id}`}
            >
              <td className="p-2">{r.student_name}</td>

              <td className="p-2 text-center font-semibold">
                {scoreCell(r)}
              </td>

              <td className="p-2 text-center">
                <FrontResultStatusBadge status={frontStatus} />
              </td>

              <td className="p-2 text-center">
                {passed === true ? (
                  <span className="text-emerald-700 font-semibold">í•©ê²©</span>
                ) : passed === false ? (
                  <span className="text-red-700 font-semibold">ë¶ˆí•©ê²©</span>
                ) : (
                  <span className="text-gray-400">â€”</span>
                )}
              </td>
            </tr>
          );
        })}
      </tbody>
    </table>
  );
}


==========================================================================================
# FILE: components/AdminExamSummaryBar.tsx
==========================================================================================
// src/features/results/components/AdminExamSummaryBar.tsx

import type { AdminExamSummary } from "../types/results.types";

export default function AdminExamSummaryBar({ data }: { data: AdminExamSummary }) {
  const avg = typeof data.avg_score === "number" ? data.avg_score.toFixed(1) : "-";

  return (
    <div className="grid grid-cols-6 gap-2 rounded bg-gray-50 p-3 text-sm">
      <div>ì‘ì‹œ: {data.participant_count ?? "-"}</div>
      <div>í‰ê· : {avg}</div>
      <div>ìµœì €: {data.min_score ?? "-"}</div>
      <div>ìµœê³ : {data.max_score ?? "-"}</div>
      <div>
        í•©ê²©ë¥ :{" "}
        {typeof data.pass_rate === "number" ? `${(data.pass_rate * 100).toFixed(1)}%` : "-"}
      </div>
      <div>í´ë¦¬ë‹‰: {data.clinic_count ?? 0}</div>
    </div>
  );
}


==========================================================================================
# FILE: components/AttemptSelectorPanel.tsx
==========================================================================================
/**
 * PATH: src/features/results/components/AttemptSelectorPanel.tsx
 *
 * âœ… AttemptSelectorPanel (Representative Attempt UX ê°•í™”)
 *
 * ë³€ê²½ ì‚¬í•­(ìš´ì˜ í•„ìˆ˜):
 * 1) ëŒ€í‘œ Attempt ë³€ê²½ ì„±ê³µ ì‹œ ì¦‰ì‹œ ë°˜ì˜:
 *    - attempts query invalidate
 *    - í•™ìƒ ìƒì„¸(detail) invalidate
 *    - ì‹œí—˜ ê²°ê³¼ ë¦¬ìŠ¤íŠ¸ invalidate (final_score/passed/clinic_required ê°±ì‹ )
 * 2) attempt.status unknown ê°’ â†’ LOCK ì²˜ë¦¬ (ê¸°ì¡´ ìœ ì§€)
 * 3) grading ìƒíƒœ attemptëŠ” ì„ íƒ ë¶ˆê°€ (ê¸°ì¡´ ìœ ì§€)
 *
 * ì„¤ê³„ ê³„ì•½:
 * - ë‹¨ì¼ ì§„ì‹¤ í‚¤: enrollment_id
 * - ëŒ€í‘œ Attempt ë³€ê²½ = final_score/passed/clinic_required ì¬ê³„ì‚° íŠ¸ë¦¬ê±°
 */

import { useMutation, useQuery, useQueryClient } from "@tanstack/react-query";
import api from "@/shared/api/axios";

type Attempt = {
  id: number;
  attempt_index: number;
  is_retake: boolean;
  is_representative: boolean;
  status: string; // â— string ê·¸ëŒ€ë¡œ ë°›ìŒ
  created_at: string;

  meta?: {
    grading?: {
      total_score?: number;
      total_max_score?: number;
    };
  };
};

type Props = {
  examId: number;
  enrollmentId: number;
  onChanged?: () => void;
};

async function fetchAttempts(examId: number, enrollmentId: number): Promise<Attempt[]> {
  const res = await api.get(`/results/admin/exams/${examId}/enrollments/${enrollmentId}/attempts/`);
  return Array.isArray(res.data) ? res.data : [];
}

async function setRepresentativeAttempt(params: {
  examId: number;
  enrollmentId: number;
  attemptId: number;
}) {
  return api.post(`/results/admin/exams/${params.examId}/representative-attempt/`, {
    enrollment_id: params.enrollmentId,
    attempt_id: params.attemptId,
  });
}

export default function AttemptSelectorPanel({ examId, enrollmentId, onChanged }: Props) {
  const qc = useQueryClient();

  const q = useQuery({
    queryKey: ["exam-attempts", examId, enrollmentId],
    queryFn: () => fetchAttempts(examId, enrollmentId),
    enabled: Number.isFinite(examId) && Number.isFinite(enrollmentId),
  });

  const changeMut = useMutation({
    mutationFn: setRepresentativeAttempt,

    onSuccess: async () => {
      /**
       * âœ… í•µì‹¬: ëŒ€í‘œ ë³€ê²½ì€ ì•„ë˜ê°€ â€œì¦‰ì‹œâ€ ë°”ë€Œì–´ì•¼ ìš´ì˜ì—ì„œ í—·ê°ˆë¦¬ì§€ ì•ŠëŠ”ë‹¤.
       * - attempts ëª©ë¡(ëŒ€í‘œ ê°•ì¡°)
       * - í•™ìƒ ìƒì„¸(ëŒ€í‘œ attempt_id/ë¬¸í•­/ì´ì )
       * - ì‹œí—˜ ë¦¬ìŠ¤íŠ¸(final_score/passed/clinic_required)
       */
      await Promise.all([
        qc.invalidateQueries({ queryKey: ["exam-attempts", examId, enrollmentId] }),
        qc.invalidateQueries({ queryKey: ["admin-exam-detail", examId, enrollmentId] }),
        qc.invalidateQueries({ queryKey: ["admin-exam-results", examId] }),
      ]);

      onChanged?.();
    },

    onError: (e: any) => {
      alert(e?.response?.data?.detail || "ëŒ€í‘œ attempt ë³€ê²½ ì‹¤íŒ¨");
    },
  });

  if (q.isLoading) {
    return <div className="px-4 py-2 text-xs text-gray-500">Attempt ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>;
  }

  if (q.isError) {
    return <div className="px-4 py-2 text-xs text-red-600">Attempt ì¡°íšŒ ì‹¤íŒ¨</div>;
  }

  const attempts = q.data ?? [];

  return (
    <div className="border-b bg-gray-50 px-4 py-3">
      <div className="mb-2 text-xs font-semibold text-gray-700">Attempt ì„ íƒ</div>

      <div className="flex flex-wrap gap-2">
        {attempts.map((a) => {
          const raw = String(a.status).toLowerCase();
          const isKnown = ["pending", "grading", "done", "failed"].includes(raw);
          const isLocked = raw === "grading" || !isKnown;
          const isActive = a.is_representative;

          // âœ… "ë¯¸ì±„ì " ë³´ì¡° UX: doneì¸ë° meta ì ìˆ˜ ì—†ìœ¼ë©´ ìš´ì˜ìƒ ìœ„í—˜ ì‹ í˜¸
          const gradingScore = a.meta?.grading?.total_score;
          const gradingMax = a.meta?.grading?.total_max_score;
          const isUngradedHint =
            raw === "done" &&
            (gradingScore === undefined || gradingScore === null || gradingMax === undefined || gradingMax === null);

          return (
            <button
              key={a.id}
              type="button"
              disabled={isLocked || isActive || changeMut.isPending}
              onClick={() =>
                changeMut.mutate({
                  examId,
                  enrollmentId,
                  attemptId: a.id,
                })
              }
              className={[
                "rounded border px-3 py-1 text-xs",
                isActive ? "border-blue-600 bg-blue-50 font-semibold" : "border-gray-300 bg-white",
                isLocked ? "cursor-not-allowed opacity-40" : "hover:bg-gray-100",
              ].join(" ")}
              title={
                !isKnown
                  ? "ì•Œ ìˆ˜ ì—†ëŠ” ìƒíƒœ (ì ê¹€)"
                  : raw === "grading"
                    ? "ì±„ì  ì¤‘ì¸ attemptëŠ” ì„ íƒí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
                    : isActive
                      ? "í˜„ì¬ ëŒ€í‘œ attempt"
                      : "ëŒ€í‘œ attemptë¡œ ì„¤ì •"
              }
            >
              #{a.attempt_index}
              {a.is_retake && <span className="ml-1 text-[10px] text-orange-600">ì¬ì‹œí—˜</span>}
              {isLocked && <span className="ml-1 text-[10px] text-red-600">ì ê¹€</span>}
              {isUngradedHint && <span className="ml-1 text-[10px] text-blue-700">ë¯¸ì±„ì </span>}
            </button>
          );
        })}
      </div>
    </div>
  );
}


==========================================================================================
# FILE: components/EditReasonInput.tsx
==========================================================================================
/**
 * PATH: src/features/results/components/EditReasonInput.tsx
 *
 * âœ… EditReasonInput
 *
 * ì±…ì„:
 * - í¸ì§‘ ì‚¬ìœ  ì…ë ¥ (UI ì „ìš©)
 *
 * âš ï¸ Phase 4:
 * - ì„œë²„ ì „ì†¡ âŒ
 * - ìƒíƒœ ë³´ì¡´ë§Œ
 */

type Props = {
  value: string;
  onChange: (v: string) => void;
};

export default function EditReasonInput({ value, onChange }: Props) {
  return (
    <div className="border-b bg-yellow-50 px-4 py-2">
      <div className="mb-1 text-xs font-semibold text-yellow-800">
        í¸ì§‘ ì‚¬ìœ  (ì„ íƒ)
      </div>

      <input
        value={value}
        onChange={(e) => onChange(e.target.value)}
        placeholder="ì˜ˆ: ì£¼ê´€ì‹ ì±„ì  ë³´ì •"
        className="w-full rounded border px-2 py-1 text-xs"
      />
    </div>
  );
}


==========================================================================================
# FILE: components/FrontResultStatusBadge.tsx
==========================================================================================
/**
 * PATH: src/features/results/components/FrontResultStatusBadge.tsx
 *
 * âœ… FrontResultStatus ì „ìš© Badge
 *
 * ì‚¬ìš© ìœ„ì¹˜:
 * - AdminExamResultsTable (ìƒíƒœ ì»¬ëŸ¼)
 * - AdminStudentResultDrawer Header
 *
 * âŒ SubmissionStatusBadge ëŒ€ì²´ ì•„ë‹˜
 * - SubmissionStatusBadgeëŠ” "ì œì¶œ ìƒíƒœ" ì „ìš©
 */

import type { FrontResultStatus } from "../types/frontResultStatus";
import { FRONT_RESULT_STATUS_LABEL, FRONT_RESULT_STATUS_TONE } from "../containers/frontResultStatusMaps";

export default function FrontResultStatusBadge({
  status,
}: {
  status: FrontResultStatus;
}) {
  const tone = FRONT_RESULT_STATUS_TONE[status];

  return (
    <span className="ds-status-badge" data-tone={tone}>
      {FRONT_RESULT_STATUS_LABEL[status]}
    </span>
  );
}


==========================================================================================
# FILE: components/ResultsExplorer.module.css
==========================================================================================
/* ì„±ì  íƒìƒ‰ê¸° â€” ì €ì¥ì†Œ/ë©”ì‹œì§€/ì‹œí—˜ê³¼ ë™ì¼í•œ í´ë”íŠ¸ë¦¬í˜• SSOT */

.root {
  display: flex;
  flex-direction: column;
  min-height: 400px;
  border-radius: var(--radius-lg);
  border: 1px solid var(--color-border-divider);
  background: var(--color-bg-surface);
  overflow: hidden;
}

.toolbar {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: var(--space-4);
  padding: var(--space-3) var(--space-4);
  border-bottom: 1px solid var(--color-border-divider);
  background: color-mix(in srgb, var(--color-brand-primary) 6%, var(--color-bg-surface));
}

.actions {
  display: flex;
  align-items: center;
  gap: var(--space-2);
}

.body {
  display: flex;
  flex: 1;
  min-height: 0;
}

.tree {
  width: 200px;
  min-width: 200px;
  border-right: 1px solid var(--color-border-divider);
  overflow: auto;
}

.gridWrap {
  flex: 1;
  padding: var(--space-4);
  overflow: auto;
}

.placeholder {
  display: flex;
  align-items: center;
  justify-content: center;
  min-height: 200px;
  color: var(--color-text-muted);
  font-size: 13px;
}

.grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
  gap: var(--space-4);
}

.item {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: var(--space-2);
  padding: var(--space-4);
  border-radius: var(--radius-md);
  border: 1px solid var(--color-border-divider);
  background: var(--color-bg-surface);
  cursor: pointer;
  font-size: 12px;
  font-weight: 600;
  color: var(--color-text-primary);
  transition: background 0.15s, border-color 0.15s;
}

.item:hover {
  background: var(--color-bg-surface-hover);
  border-color: color-mix(in srgb, var(--color-brand-primary) 30%, var(--color-border-divider));
}

.itemAdd {
  border-style: dashed;
  color: var(--color-text-muted);
}

.itemAdd:hover {
  color: var(--color-brand-primary);
}

.itemLabel {
  text-align: center;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  width: 100%;
}

.itemMeta {
  font-size: 10px;
  font-weight: 500;
  color: var(--color-text-muted);
}


==========================================================================================
# FILE: components/WrongNotePanel.tsx
==========================================================================================
// PATH: src/features/results/components/WrongNotePanel.tsx
import { useEffect, useMemo, useState } from "react";
import { useQuery, useMutation } from "@tanstack/react-query";
import {
  fetchWrongNotes,
  createWrongNotePDF,
  fetchWrongNotePDFStatus,
  WrongNotePDFCreateResponse,
} from "../api/wrongNotes";

type Props = {
  enrollmentId: number;
  examId?: number;
};

export default function WrongNotePanel({ enrollmentId, examId }: Props) {
  const { data } = useQuery({
    queryKey: ["wrong-notes", enrollmentId, examId],
    queryFn: () =>
      fetchWrongNotes({
        enrollment_id: enrollmentId,
        exam_id: examId,
      }),
    enabled: Number.isFinite(enrollmentId),
  });

  // ==============================
  // PDF ìƒì„± ìƒíƒœ ê´€ë¦¬
  // ==============================
  const [pdfJob, setPdfJob] =
    useState<WrongNotePDFCreateResponse | null>(null);
  const [pdfFileUrl, setPdfFileUrl] = useState<string>("");
  const [pdfError, setPdfError] = useState<string>("");

  const pdfMutation = useMutation({
    mutationFn: () =>
      createWrongNotePDF({
        enrollment_id: enrollmentId,
        exam_id: examId,
      }),
    onSuccess: (res) => {
      setPdfJob(res);
      setPdfFileUrl("");
      setPdfError("");
    },
    onError: (e: any) => {
      setPdfError(String(e?.message || "PDF ìƒì„± ìš”ì²­ ì‹¤íŒ¨"));
    },
  });

  // ==============================
  // PDF ìƒíƒœ polling
  // ==============================
  useEffect(() => {
    if (!pdfJob?.job_id) return;

    let stopped = false;
    const jobId = pdfJob.job_id;

    const tick = async () => {
      try {
        const st = await fetchWrongNotePDFStatus(jobId);

        if (st.status === "DONE") {
          if (!stopped) {
            setPdfFileUrl(st.file_url || "");
            setPdfError("");
          }
          return;
        }

        if (st.status === "FAILED") {
          if (!stopped) {
            setPdfError(st.error_message || "PDF ìƒì„± ì‹¤íŒ¨");
          }
          return;
        }

        if (!stopped) {
          setTimeout(tick, 1500);
        }
      } catch (err: any) {
        if (!stopped) {
          setPdfError(
            String(err?.message || "PDF ìƒíƒœ ì¡°íšŒ ì‹¤íŒ¨")
          );
          setTimeout(tick, 2000);
        }
      }
    };

    tick();
    return () => {
      stopped = true;
    };
  }, [pdfJob]);

  const wrongList = useMemo(
    () => data?.results ?? [],
    [data]
  );

  return (
    <div className="mt-4 rounded border bg-gray-50 p-3">
      <div className="mb-2 text-sm font-semibold">
        ì˜¤ë‹µë…¸íŠ¸
      </div>

      {!data || wrongList.length === 0 ? (
        <div className="text-xs text-gray-400">
          ì˜¤ë‹µì´ ì—†ìŠµë‹ˆë‹¤.
        </div>
      ) : (
        <ul className="space-y-1 text-xs">
          {wrongList.map((it) => (
            <li
              /**
               * ğŸ”¥ FIX: keyì— index ì‚¬ìš© ì œê±°
               * - attempt_id + question_id ì¡°í•©ì€ ë„ë©”ì¸ì ìœ¼ë¡œ ìœ ë‹ˆí¬
               * - polling / refetch / pagination ì—ì„œë„ ì•ˆì „
               */
              key={`${it.attempt_id}-${it.question_id}`}
            >
              Q{it.question_number ?? it.question_id} :{" "}
              {it.student_answer} â†’ {it.correct_answer}
            </li>
          ))}
        </ul>
      )}

      <div className="mt-3 flex items-center gap-2">
        <button
          className="rounded bg-purple-600 px-3 py-1 text-xs text-white disabled:opacity-50"
          onClick={() => pdfMutation.mutate()}
          disabled={pdfMutation.isPending}
        >
          {pdfMutation.isPending
            ? "ìš”ì²­ ì¤‘..."
            : "PDF ìƒì„±"}
        </button>

        {pdfJob && !pdfFileUrl && !pdfError && (
          <span className="text-xs text-gray-500">
            PDF ìƒì„± ì¤‘... ({pdfJob.status})
          </span>
        )}

        {pdfError && (
          <span className="text-xs text-red-600">
            {pdfError}
          </span>
        )}

        {pdfFileUrl && (
          <a
            className="text-xs text-blue-600 underline"
            href={pdfFileUrl}
            target="_blank"
            rel="noreferrer"
          >
            PDF ë‹¤ìš´ë¡œë“œ
          </a>
        )}
      </div>
    </div>
  );
}


==========================================================================================
# FILE: components/attempt/AttemptMetaPanel.tsx
==========================================================================================
/**
 * âœ… AttemptMetaPanel
 *
 * ì±…ì„:
 * - confidence
 * - invalid_reason
 * - detected answer ë“± "ì´ìœ  ì„¤ëª…"
 */

type Props = {
  fact: {
    meta?: any;
    answer?: string;
  } | null;
};

export default function AttemptMetaPanel({ fact }: Props) {
  if (!fact) return null;

  const omr = fact.meta?.omr;
  const grading = fact.meta?.grading;

  return (
    <div className="rounded border bg-gray-50 p-3 text-sm">
      <div className="mb-1 font-semibold">ì±„ì  ì •ë³´</div>

      <ul className="space-y-1 text-xs">
        <li>ê°ì§€ ë‹µì•ˆ: {fact.answer || "-"}</li>

        {typeof omr?.confidence === "number" && (
          <li>
            ì‹ ë¢°ë„:{" "}
            <span
              className={
                omr.confidence < 0.7
                  ? "font-semibold text-red-600"
                  : ""
              }
            >
              {omr.confidence}
            </span>
          </li>
        )}

        {grading?.invalid_reason && (
          <li className="font-semibold text-red-600">
            ì²˜ë¦¬ ì‚¬ìœ : {grading.invalid_reason}
          </li>
        )}
      </ul>
    </div>
  );
}


==========================================================================================
# FILE: components/attempt/AttemptOMRViewer.tsx
==========================================================================================
import BBoxOverlay from "../bbox/BBoxOverlay";
import { BBoxMeta } from "../bbox/types";

/**
 * âœ… AttemptOMRViewer
 *
 * ì±…ì„:
 * - ì„ íƒëœ ë¬¸í•­ì˜ meta.omr.bbox ë¥¼ í™”ë©´ì— í‘œì‹œ
 * - invalid_reason ì‹œê°ì  ê°•ì¡°
 */
type Props = {
  imageSrc: string;
  fact: {
    meta?: any;
  } | null;
  originalWidth: number;
  displayWidth: number;
};

export default function AttemptOMRViewer({
  imageSrc,
  fact,
  originalWidth,
  displayWidth,
}: Props) {
  if (!fact) {
    return (
      <div className="flex h-64 items-center justify-center rounded border text-sm text-gray-400">
        ë¬¸í•­ì„ ì„ íƒí•˜ì„¸ìš”
      </div>
    );
  }

  const omr = fact.meta?.omr;
  if (!omr?.bbox) {
    return (
      <div className="flex h-64 items-center justify-center rounded border text-sm text-gray-400">
        BBox ì •ë³´ ì—†ìŒ
      </div>
    );
  }

  const invalidReason = fact.meta?.grading?.invalid_reason;

  const boxes: BBoxMeta[] = [
    {
      bbox: omr.bbox,
      label: invalidReason ?? "OMR",
      confidence: omr.confidence,
      invalid_reason: invalidReason,
    },
  ];

  return (
    <div className="rounded border p-2">
      <BBoxOverlay
        src={imageSrc}
        width={displayWidth}
        originalWidth={originalWidth}
        boxes={boxes}
      />
    </div>
  );
}


==========================================================================================
# FILE: components/attempt/AttemptQuestionList.tsx
==========================================================================================
/**
 * âœ… AttemptQuestionList
 *
 * ì±…ì„:
 * - ë¬¸í•­ ëª©ë¡ í‘œì‹œ
 * - ì •ë‹µ/ì˜¤ë‹µ ìƒíƒœ ì‹œê°í™”
 * - ì„ íƒ ìƒíƒœ ê´€ë¦¬ (ìƒìœ„ì—ì„œ ì œì–´)
 */

type Fact = {
  question_id: number;
  is_correct: boolean;
  meta?: any;
};

type Props = {
  facts: Fact[];
  selectedQuestionId: number | null;
  onSelect: (qid: number) => void;
};

export default function AttemptQuestionList({
  facts,
  selectedQuestionId,
  onSelect,
}: Props) {
  return (
    <ul className="space-y-1 text-sm">
      {facts.map((f) => {
        const invalidReason =
          f.meta?.grading?.invalid_reason ?? null;

        return (
          <li
            key={f.question_id}
            className={`cursor-pointer rounded px-2 py-1
              ${
                selectedQuestionId === f.question_id
                  ? "bg-blue-100 font-semibold"
                  : "hover:bg-gray-100"
              }
            `}
            onClick={() => onSelect(f.question_id)}
          >
            Q{f.question_id}{" "}
            {f.is_correct ? "âœ…" : "âŒ"}
            {invalidReason && (
              <span className="ml-1 text-xs text-red-600">
                ({invalidReason})
              </span>
            )}
          </li>
        );
      })}
    </ul>
  );
}


==========================================================================================
# FILE: components/attempt/AttemptViewerPanel.tsx
==========================================================================================
// PATH: src/features/results/components/attempt/AttemptViewerPanel.tsx

import { useMemo, useState, useEffect } from "react";
import AttemptQuestionList from "./AttemptQuestionList";
import AttemptOMRViewer from "./AttemptOMRViewer";
import AttemptMetaPanel from "./AttemptMetaPanel";

/**
 * âœ… AttemptViewerPanel
 *
 * ì±…ì„:
 * - attempt_id ê¸°ì¤€ ResultFact(meta í¬í•¨) ì‹œê°í™”
 * - ë¬¸í•­ ì„ íƒ â†’ OMR Overlay â†’ ë©”íƒ€ ì •ë³´ í‘œì‹œ
 *
 * ğŸ”§ PATCH ìš”ì•½:
 * 1ï¸âƒ£ ìµœì´ˆ ì§„ì… ì‹œ ì²« ë¬¸í•­ ìë™ ì„ íƒ (UX í•„ìˆ˜)
 * 2ï¸âƒ£ imageSrc / originalWidth ì—†ì„ ë•Œ meta ê¸°ë°˜ fallback
 * 3ï¸âƒ£ OMR ì´ë¯¸ì§€ ë¯¸ì¤€ë¹„ ìƒíƒœ ë°©ì–´ UI
 */
type Fact = {
  question_id: number;
  answer: string;
  is_correct: boolean;
  score: number;
  max_score: number;
  meta?: any;
};

type Props = {
  attemptId: number;
  facts: Fact[];

  // âœ… ì™¸ë¶€ì—ì„œ ì£¼ì… ê°€ëŠ¥ (ê¶Œì¥)
  imageSrc?: string;

  // âœ… ì—†ìœ¼ë©´ metaì—ì„œ ìë™ ì¶”ë¡ 
  originalWidth?: number;

  // âœ… í™”ë©´ í‘œì‹œìš© width
  displayWidth?: number;

  // âœ… UX ì˜µì…˜: ì²« ë¬¸í•­ ìë™ ì„ íƒ
  autoSelectFirst?: boolean;
};

/**
 * ğŸ”§ PATCH: meta ê¸°ë°˜ image url ìë™ ì¶”ë¡ 
 * - backend contractê°€ ì•„ì§ ê³ ì •ë˜ì§€ ì•Šì€ ìƒíƒœë¥¼ ëŒ€ë¹„
 */
function inferImageSrc(facts: Fact[]): string {
  for (const f of facts) {
    const m = f.meta;
    const candidates = [
      m?.omr?.image_url,
      m?.omr?.imageUrl,
      m?.image_url,
      m?.imageUrl,
      m?.omr?.page_image_url,
    ];
    const hit = candidates.find(
      (v) => typeof v === "string" && v.length > 0
    );
    if (hit) return hit;
  }
  return "";
}

/**
 * ğŸ”§ PATCH: original width fallback
 */
function inferOriginalWidth(facts: Fact[]): number {
  for (const f of facts) {
    const w =
      f.meta?.omr?.original_width ??
      f.meta?.omr?.originalWidth ??
      f.meta?.original_width ??
      f.meta?.originalWidth;

    const n = Number(w);
    if (Number.isFinite(n) && n > 0) return n;
  }

  // âš ï¸ ìµœí›„ fallback (scale ê³„ì‚°ìš©)
  return 1000;
}

export default function AttemptViewerPanel({
  attemptId,
  facts,
  imageSrc,
  originalWidth,
  displayWidth = 520,
  autoSelectFirst = true,
}: Props) {
  /**
   * =====================================
   * ì„ íƒëœ ë¬¸í•­ ìƒíƒœ
   * =====================================
   */
  const [selectedQuestionId, setSelectedQuestionId] =
    useState<number | null>(null);

  /**
   * ğŸ”¥ PATCH #1
   * ìµœì´ˆ ì§„ì… ì‹œ ì²« ë¬¸í•­ ìë™ ì„ íƒ
   * - ì—†ìœ¼ë©´ ìš°ì¸¡ íŒ¨ë„ì´ "ë¹ˆ í™”ë©´" â†’ ê³ ì¥ë‚œ UX
   */
  useEffect(() => {
    if (!autoSelectFirst) return;
    if (selectedQuestionId !== null) return;
    if (facts.length === 0) return;

    setSelectedQuestionId(facts[0].question_id);
  }, [facts, selectedQuestionId, autoSelectFirst]);

  const selectedFact = useMemo(
    () =>
      facts.find((f) => f.question_id === selectedQuestionId) ??
      null,
    [facts, selectedQuestionId]
  );

  /**
   * ğŸ”§ PATCH #2
   * imageSrc / originalWidth ìµœì¢… ê²°ì •
   */
  const finalImageSrc = imageSrc || inferImageSrc(facts);
  const finalOriginalWidth =
    typeof originalWidth === "number" && originalWidth > 0
      ? originalWidth
      : inferOriginalWidth(facts);

  return (
    <div className="flex h-full gap-4">
      {/* ===============================
          LEFT: ë¬¸í•­ ë¦¬ìŠ¤íŠ¸
         =============================== */}
      <div className="w-52 shrink-0 border-r pr-2">
        <div className="mb-2 text-xs text-gray-500">
          attempt #{attemptId}
        </div>

        <AttemptQuestionList
          facts={facts.map((f) => ({
            question_id: f.question_id,
            is_correct: f.is_correct,
            meta: f.meta,
          }))}
          selectedQuestionId={selectedQuestionId}
          onSelect={setSelectedQuestionId}
        />
      </div>

      {/* ===============================
          RIGHT: OMR + ë©”íƒ€
         =============================== */}
      <div className="flex flex-1 flex-col gap-3">
        {/* ğŸ”¥ PATCH #3: OMR ì´ë¯¸ì§€ ë¯¸ì¡´ì¬ ë°©ì–´ */}
        {!finalImageSrc ? (
          <div className="rounded border bg-gray-50 p-4 text-sm text-gray-500">
            OMR ì´ë¯¸ì§€ê°€ ì•„ì§ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.
            <br />
            <span className="text-xs">
              (ê¶Œì¥) backendì—ì„œ meta.omr.image_url ì œê³µ ë˜ëŠ”
              ìƒìœ„ì—ì„œ imageSrc prop ì£¼ì…
            </span>
          </div>
        ) : (
          <AttemptOMRViewer
            imageSrc={finalImageSrc}
            fact={selectedFact}
            originalWidth={finalOriginalWidth}
            displayWidth={displayWidth}
          />
        )}

        <AttemptMetaPanel fact={selectedFact} />
      </div>
    </div>
  );
}


==========================================================================================
# FILE: components/bbox/BBoxLayer.tsx
==========================================================================================
// PATH: src/features/results/components/bbox/BBoxLayer.tsx
import { BBoxMeta } from "./types";

type Props = {
  meta: BBoxMeta;
  scale: number;
};

export default function BBoxLayer({ meta, scale }: Props) {
  const { bbox } = meta;

  return (
    <div
      className="absolute border-2 border-red-500 bg-red-200/20 pointer-events-none"
      style={{
        left: bbox.x * scale,
        top: bbox.y * scale,
        width: bbox.width * scale,
        height: bbox.height * scale,
      }}
    >
      {meta.label && (
        <div className="absolute -top-5 left-0 rounded bg-red-600 px-1 text-[10px] text-white">
          {meta.label}
        </div>
      )}
    </div>
  );
}


==========================================================================================
# FILE: components/bbox/BBoxOverlay.tsx
==========================================================================================
// PATH: src/features/results/components/bbox/BBoxOverlay.tsx
import { useMemo } from "react";
import BBoxLayer from "./BBoxLayer";
import { BBoxMeta } from "./types";

type Props = {
  src: string;                // image or rendered PDF page
  width: number;              // display width
  originalWidth: number;      // backend ê¸°ì¤€ ì›ë³¸ width
  boxes: BBoxMeta[];
};

export default function BBoxOverlay({
  src,
  width,
  originalWidth,
  boxes,
}: Props) {
  const scale = useMemo(
    () => width / originalWidth,
    [width, originalWidth]
  );

  return (
    <div className="relative">
      <img src={src} style={{ width }} />

      {boxes.map((b) => (
        <BBoxLayer
          /**
           * ğŸ”¥ FIX: index key ì œê±°
           *
           * bbox ì¢Œí‘œ ìì²´ê°€ "ë¬¸í•­ ì˜ì—­ì˜ ì •ì²´ì„±"
           * - ì¢Œí‘œê°€ ê°™ìœ¼ë©´ ê°™ì€ ë°•ìŠ¤
           * - ì¢Œí‘œê°€ ë°”ë€Œë©´ ë‹¤ë¥¸ ë°•ìŠ¤
           *
           * invalid_reason / confidence ë³€ê²½ì—ë„
           * React reconciliation ì•ˆì „
           */
          key={`${b.bbox.x}-${b.bbox.y}-${b.bbox.width}-${b.bbox.height}`}
          meta={b}
          scale={scale}
        />
      ))}
    </div>
  );
}


==========================================================================================
# FILE: components/bbox/types.ts
==========================================================================================
// PATH: src/features/results/components/bbox/types.ts

export type BBox = {
  x: number;      // left (px)
  y: number;      // top (px)
  width: number;
  height: number;
};

export type BBoxMeta = {
  bbox: BBox;
  label?: string;          // e.g. "Q3"
  confidence?: number;     // optional
  invalid_reason?: string; // LOW_CONFIDENCE ë“±
};


==========================================================================================
# FILE: containers/frontResultStatusMaps.ts
==========================================================================================
/**
 * PATH: src/features/results/constants/frontResultStatusMaps.ts
 *
 * âœ… FrontResultStatus UI ê·œê²©
 *
 * - ëª¨ë“  ì„±ì /ì œì¶œ í™”ë©´ì—ì„œ ì´ ê·œê²©ë§Œ ì‚¬ìš©
 *
 * UX ê³„ì•½(ìš´ì˜ ê¸°ì¤€):
 * - partial_doneì€ "ë¶€ë¶„ ì™„ë£Œ" ê°™ì€ ì• ë§¤í•œ ë‹¨ì–´ ê¸ˆì§€ â†’ "ë¯¸ì±„ì /í›„ì²˜ë¦¬"ë¡œ ê³ ì •
 */

import type { FrontResultStatus } from "../types/frontResultStatus";

export const FRONT_RESULT_STATUS_LABEL: Record<FrontResultStatus, string> = {
  waiting: "ë¯¸ì œì¶œ",
  processing: "ì±„ì ì¤‘",
  partial_done: "ë¯¸ì±„ì ",
  done: "ì™„ë£Œ",
  failed: "ì‹¤íŒ¨",
};

export const FRONT_RESULT_STATUS_COLOR: Record<FrontResultStatus, string> = {
  waiting: "gray",
  processing: "yellow",
  partial_done: "blue",
  done: "green",
  failed: "red",
};

/** ê³µìš© í†¤ SSOT: success | danger | warning | primary | neutral */
export const FRONT_RESULT_STATUS_TONE: Record<FrontResultStatus, "success" | "danger" | "warning" | "primary" | "neutral"> = {
  waiting: "neutral",
  processing: "warning",
  partial_done: "primary",
  done: "success",
  failed: "danger",
};


==========================================================================================
# FILE: hooks/useAdminExamResults.ts
==========================================================================================
// FIX: pagination ëŒ€ì‘

import { useEffect, useState } from "react";
import { ApiClient } from "../api/client";
import { resultsEndpoints } from "../api/endpoints";
import { AdminExamResultRow } from "../types/results.types";

type AdminExamResultsResponse = {
  count: number;
  next: number | null;
  previous: number | null;
  results: AdminExamResultRow[];
};

export function useAdminExamResults(api: ApiClient, examId?: number) {
  const [rows, setRows] = useState<AdminExamResultRow[]>([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    if (!examId) return;
    let cancelled = false;

    setLoading(true);
    setError(null);

    api
      .get<AdminExamResultsResponse>(
        resultsEndpoints.adminExamResults(examId)
      )
      .then((res) => {
        if (cancelled) return;
        setRows(Array.isArray(res?.results) ? res.results : []);
      })
      .catch((e) => {
        if (!cancelled) setError(String(e?.message || e));
      })
      .finally(() => {
        if (!cancelled) setLoading(false);
      });

    return () => {
      cancelled = true;
    };
  }, [api, examId]);

  return { rows, loading, error };
}


==========================================================================================
# FILE: hooks/useExamResult.ts
==========================================================================================
import { useEffect, useState } from "react";
import { ApiClient } from "../api/client";
import { resultsEndpoints } from "../api/endpoints";
import { StudentExamResult } from "../types/results.types";

export function useExamResult(api: ApiClient, examId?: number) {
  const [data, setData] = useState<StudentExamResult | null>(null);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    if (!examId) return;
    let cancelled = false;

    setLoading(true);
    setError(null);

    api.get<StudentExamResult>(resultsEndpoints.myExamResult(examId))
      .then((res) => {
        if (!cancelled) setData(res);
      })
      .catch((e) => {
        if (!cancelled) setError(String(e?.message || e));
      })
      .finally(() => {
        if (!cancelled) setLoading(false);
      });

    return () => { cancelled = true; };
  }, [api, examId]);

  return { data, loading, error };
}


==========================================================================================
# FILE: hooks/useExamSummary.ts
==========================================================================================
import { useEffect, useState } from "react";
import { ApiClient } from "../api/client";
import { resultsEndpoints } from "../api/endpoints";
import { AdminExamSummary } from "../types/results.types";

export function useExamSummary(api: ApiClient, examId?: number) {
  const [data, setData] = useState<AdminExamSummary | null>(null);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    if (!examId) return;
    let cancelled = false;

    setLoading(true);
    setError(null);

    api.get<AdminExamSummary>(resultsEndpoints.adminExamSummary(examId))
      .then((res) => !cancelled && setData(res))
      .catch((e) => !cancelled && setError(String(e?.message || e)))
      .finally(() => !cancelled && setLoading(false));

    return () => { cancelled = true; };
  }, [api, examId]);

  return { data, loading, error };
}


==========================================================================================
# FILE: hooks/useMyExamResult.ts
==========================================================================================
// PATH: src/features/results/hooks/useMyExamResult.ts
import { useQuery } from "@tanstack/react-query";
import { fetchMyExamResult } from "../api/myExamResult";

export function useMyExamResult(examId: number | undefined) {
  // âœ… ë„ˆê°€ ê°•ì¡°í•œ íŒ¨í„´ ê·¸ëŒ€ë¡œ: examId ì¤€ë¹„ ì „ì´ë©´ ìš”ì²­ ê¸ˆì§€
  const safeId = Number(examId);
  const enabled = Number.isFinite(safeId);

  return useQuery({
    queryKey: ["my-exam-result", safeId],
    queryFn: () => fetchMyExamResult(safeId),
    enabled, // ğŸ”¥ í•„ìˆ˜: undefined/NaNì¼ ë•Œ 404/UXê¹¨ì§ ë°©ì§€
  });
}


==========================================================================================
# FILE: hooks/useQuestionStats.ts
==========================================================================================
import { useEffect, useState } from "react";
import { ApiClient } from "../api/client";
import { resultsEndpoints } from "../api/endpoints";
import { QuestionStat, TopWrongQuestion } from "../types/results.types";

/**
 * âœ… pagination ëŒ€ì‘ ë²„ì „
 */
type QuestionStatsResponse = {
  count: number;
  next: number | null;
  previous: number | null;
  results: QuestionStat[];
};

export function useQuestionStats(api: ApiClient, examId?: number) {
  const [stats, setStats] = useState<QuestionStat[]>([]);
  const [topWrong, setTopWrong] = useState<TopWrongQuestion[]>([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    if (!examId) return;
    let cancelled = false;

    setLoading(true);
    setError(null);

    Promise.all([
      api.get<QuestionStatsResponse>(
        resultsEndpoints.questionStats(examId)
      ),
      api.get<TopWrongQuestion[]>(
        resultsEndpoints.topWrongQuestions(examId, 5)
      ),
    ])
      .then(([statsRes, topWrongRes]) => {
        if (cancelled) return;

        // âœ… í•µì‹¬ FIX
        setStats(
          Array.isArray(statsRes?.results)
            ? statsRes.results
            : []
        );

        setTopWrong(Array.isArray(topWrongRes) ? topWrongRes : []);
      })
      .catch((e) => {
        if (!cancelled) {
          setError(String(e?.message || e));
        }
      })
      .finally(() => {
        if (!cancelled) setLoading(false);
      });

    return () => {
      cancelled = true;
    };
  }, [api, examId]);

  return { stats, topWrong, loading, error };
}


==========================================================================================
# FILE: hooks/useSessionScoreSummary.ts
==========================================================================================
import { useEffect, useState } from "react";
import { ApiClient } from "../api/client";
import { resultsEndpoints } from "../api/endpoints";
import { SessionScoreSummary } from "../types/results.types";

export function useSessionScoreSummary(api: ApiClient, sessionId?: number) {
  const [data, setData] = useState<SessionScoreSummary | null>(null);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    if (!sessionId) return;
    let cancelled = false;

    setLoading(true);
    setError(null);

    api.get<SessionScoreSummary>(resultsEndpoints.sessionScoreSummary(sessionId))
      .then((res) => !cancelled && setData(res))
      .catch((e) => !cancelled && setError(String(e?.message || e)))
      .finally(() => !cancelled && setLoading(false));

    return () => { cancelled = true; };
  }, [api, sessionId]);

  return { data, loading, error };
}


==========================================================================================
# FILE: hooks/useWrongNotePDF.ts
==========================================================================================
import { useCallback, useEffect, useRef, useState } from "react";
import { ApiClient } from "../api/client";
import { resultsEndpoints } from "../api/endpoints";
import {
  WrongNotePdfCreateResponse,
  WrongNotePdfStatusResponse,
} from "../types/results.types";

export type CreatePdfPayload = {
  enrollment_id: number;
  lecture_id?: number;
  exam_id?: number;
  from_session_order?: number;
};

export function useWrongNotePDF(api: ApiClient) {
  const [job, setJob] = useState<WrongNotePdfStatusResponse | null>(null);
  const [creating, setCreating] = useState(false);
  const [polling, setPolling] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const timerRef = useRef<number | null>(null);

  const stopPolling = useCallback(() => {
    if (timerRef.current) window.clearInterval(timerRef.current);
    timerRef.current = null;
    setPolling(false);
  }, []);

  const pollStatus = useCallback((jobId: number) => {
    stopPolling();
    setPolling(true);

    timerRef.current = window.setInterval(async () => {
      try {
        const res = await api.get<WrongNotePdfStatusResponse>(
          resultsEndpoints.wrongNotePdfStatus(jobId)
        );
        setJob(res);

        if (res.status === "DONE" || res.status === "FAILED") {
          stopPolling();
        }
      } catch (e: any) {
        setError(String(e?.message || e));
        stopPolling();
      }
    }, 2000);
  }, [api, stopPolling]);

  const create = useCallback(async (payload: CreatePdfPayload) => {
    setCreating(true);
    setError(null);
    setJob(null);

    try {
      const created = await api.post<WrongNotePdfCreateResponse>(
        resultsEndpoints.wrongNotePdfCreate,
        payload
      );

      const jobId = created.job_id;
      // ì¦‰ì‹œ 1íšŒ fetch í›„ polling
      const first = await api.get<WrongNotePdfStatusResponse>(
        resultsEndpoints.wrongNotePdfStatus(jobId)
      );
      setJob(first);

      if (first.status !== "DONE" && first.status !== "FAILED") {
        pollStatus(jobId);
      }
    } catch (e: any) {
      setError(String(e?.message || e));
    } finally {
      setCreating(false);
    }
  }, [api, pollStatus]);

  useEffect(() => {
    return () => stopPolling();
  }, [stopPolling]);

  return {
    job,
    creating,
    polling,
    error,
    create,
    stopPolling,
  };
}


==========================================================================================
# FILE: hooks/useWrongNotes.ts
==========================================================================================
import { useEffect, useMemo, useState } from "react";
import { ApiClient } from "../api/client";
import { resultsEndpoints } from "../api/endpoints";
import { WrongNoteListResponse } from "../types/results.types";

export type WrongNoteQuery = {
  enrollmentId: number;
  examId?: number;
  lectureId?: number;
  fromSessionOrder?: number;
  offset?: number;
  limit?: number;
};

export function useWrongNotes(api: ApiClient, q?: WrongNoteQuery) {
  const [data, setData] = useState<WrongNoteListResponse | null>(null);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const key = useMemo(() => {
    if (!q) return "";
    return JSON.stringify(q);
  }, [q]);

  useEffect(() => {
    if (!q?.enrollmentId) return;
    let cancelled = false;

    setLoading(true);
    setError(null);

    api.get<WrongNoteListResponse>(
      resultsEndpoints.wrongNotes({
        enrollment_id: q.enrollmentId,
        exam_id: q.examId,
        lecture_id: q.lectureId,
        from_session_order: q.fromSessionOrder,
        offset: q.offset,
        limit: q.limit,
      })
    )
      .then((res) => !cancelled && setData(res))
      .catch((e) => !cancelled && setError(String(e?.message || e)))
      .finally(() => !cancelled && setLoading(false));

    return () => { cancelled = true; };
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [api, key]);

  return { data, loading, error };
}


==========================================================================================
# FILE: pages/ResultsAdminPage.tsx
==========================================================================================
/**
 * ì„±ì  (ì‚¬ì´ë“œë°”) â€” ê°•ì˜ë³„ ì„±ì  ì§„ì…ì  Â· ì°¨ì‹œ ë‚´ ì„±ì ì€ ê° ê°•ì˜ > ì°¨ì‹œì—ì„œ ìš´ì˜
 * Design SSOT: students ë„ë©”ì¸ (DomainLayout, DomainListToolbar, DomainTable ds-table--flat)
 */

import { useState, useMemo } from "react";
import { useNavigate } from "react-router-dom";
import { useQuery } from "@tanstack/react-query";
import { fetchLectures } from "@/features/lectures/api/sessions";
import { DomainLayout } from "@/shared/ui/layout";
import { DomainListToolbar, DomainTable, TABLE_COL, STATUS_ACTIVE_COLOR, STATUS_INACTIVE_COLOR } from "@/shared/ui/domain";
import { Button, EmptyState } from "@/shared/ui/ds";

export default function ResultsAdminPage() {
  const navigate = useNavigate();
  const [searchInput, setSearchInput] = useState("");
  const [search, setSearch] = useState("");

  const { data: lectures = [], isLoading } = useQuery({
    queryKey: ["admin-results-lectures"],
    queryFn: () => fetchLectures({ is_active: undefined }),
  });

  const filtered = useMemo(() => {
    if (!search.trim()) return lectures;
    const k = search.trim().toLowerCase();
    return lectures.filter(
      (l) =>
        (l.title && l.title.toLowerCase().includes(k)) ||
        (l.name && l.name.toLowerCase().includes(k)) ||
        (l.subject && l.subject.toLowerCase().includes(k))
    );
  }, [lectures, search]);

  const totalWidth = TABLE_COL.title + TABLE_COL.subject + TABLE_COL.medium + TABLE_COL.status + TABLE_COL.actions;

  return (
    <DomainLayout
      title="ì„±ì "
      description="ê°•ì˜Â·ì‹œí—˜ ë‹¨ìœ„ ì„±ì ì„ í†µí•© ì¡°íšŒí•©ë‹ˆë‹¤. ì°¨ì‹œë³„ ì±„ì Â·ì„±ì ì€ ê° ê°•ì˜ > ì°¨ì‹œì—ì„œ í™•ì¸í•˜ì„¸ìš”."
    >
      <div className="flex flex-col gap-4">
        <DomainListToolbar
          totalLabel={isLoading ? "â€¦" : `ì´ ${filtered.length}ê°œ ê°•ì˜`}
          searchSlot={
            <input
              className="ds-input"
              placeholder="ê°•ì˜ëª… Â· ê³¼ëª© ê²€ìƒ‰"
              value={searchInput}
              onChange={(e) => setSearchInput(e.target.value)}
              onBlur={() => setSearch(searchInput)}
              onKeyDown={(e) => e.key === "Enter" && setSearch(searchInput)}
              style={{ maxWidth: 280 }}
            />
          }
          primaryAction={
            <Button intent="primary" onClick={() => navigate("/admin/lectures")}>
              ê°•ì˜ ëª©ë¡
            </Button>
          }
        />

        {isLoading ? (
          <EmptyState scope="panel" tone="loading" title="ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦" />
        ) : !filtered.length ? (
          <EmptyState
            scope="panel"
            tone="empty"
            title="ê°•ì˜ê°€ ì—†ìŠµë‹ˆë‹¤"
            description="ê°•ì˜ë¥¼ ì¶”ê°€í•œ ë’¤, ê° ê°•ì˜ > ì°¨ì‹œ > ì„±ì  íƒ­ì—ì„œ ì‹œí—˜Â·ê³¼ì œ ì„±ì ì„ ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."
            actions={
              <Button intent="primary" onClick={() => navigate("/admin/lectures")}>
                ê°•ì˜ ëª©ë¡
              </Button>
            }
          />
        ) : (
          <DomainTable tableClassName="ds-table--flat" tableStyle={{ tableLayout: "fixed", width: totalWidth }}>
            <colgroup>
              <col style={{ width: TABLE_COL.title }} />
              <col style={{ width: TABLE_COL.subject }} />
              <col style={{ width: TABLE_COL.medium }} />
              <col style={{ width: TABLE_COL.status }} />
              <col style={{ width: TABLE_COL.actions }} />
            </colgroup>
            <thead>
              <tr>
                <th scope="col">ê°•ì˜ëª…</th>
                <th scope="col">ê³¼ëª©</th>
                <th scope="col">ê¸°ê°„</th>
                <th scope="col">ìƒíƒœ</th>
                <th scope="col" />
              </tr>
            </thead>
            <tbody>
              {filtered.map((l) => (
                <tr
                  key={l.id}
                  className="cursor-pointer hover:bg-[var(--color-bg-surface-hover)]"
                  onClick={() => navigate(`/admin/lectures/${l.id}`)}
                >
                  <td className="font-semibold text-[var(--color-text-primary)] truncate" title={l.title || l.name}>
                    {l.title || l.name || "â€”"}
                  </td>
                  <td className="text-[var(--color-text-secondary)] truncate">{l.subject || "â€”"}</td>
                  <td className="text-[var(--color-text-muted)]">
                    {l.start_date && l.end_date
                      ? `${l.start_date} ~ ${l.end_date}`
                      : l.start_date || "â€”"}
                  </td>
                  <td>
                    <span
                      style={{
                        fontSize: 12,
                        fontWeight: 700,
                        color: l.is_active ? STATUS_ACTIVE_COLOR : STATUS_INACTIVE_COLOR,
                      }}
                    >
                      {l.is_active ? "í™œì„±" : "ë¹„í™œì„±"}
                    </span>
                  </td>
                  <td onClick={(ev) => ev.stopPropagation()}>
                    <Button
                      intent="primary"
                      size="sm"
                      onClick={() => navigate(`/admin/lectures/${l.id}`)}
                    >
                      ì„±ì  ë³´ê¸°
                    </Button>
                  </td>
                </tr>
              ))}
            </tbody>
          </DomainTable>
        )}
      </div>
    </DomainLayout>
  );
}


==========================================================================================
# FILE: pages/ResultsExplorerPage.tsx
==========================================================================================
/**
 * ì„±ì  (ì‚¬ì´ë“œë°” ì²« í˜ì´ì§€) â€” ì €ì¥ì†Œ/ë©”ì‹œì§€/ì‹œí—˜ê³¼ ë™ì¼í•œ í´ë”íŠ¸ë¦¬í˜• SSOT
 * ê°•ì˜ëª… > 1~nì°¨ì‹œ íŠ¸ë¦¬, ìš°ì¸¡ì— í•´ë‹¹ ì°¨ì‹œì˜ ì„±ì  ë§í¬ ê·¸ë¦¬ë“œ
 */

import { useState, useMemo } from "react";
import { useNavigate } from "react-router-dom";
import { useQuery, useQueries } from "@tanstack/react-query";
import { BarChart2 } from "lucide-react";
import { Button } from "@/shared/ui/ds";
import { DomainLayout } from "@/shared/ui/layout";
import Breadcrumb from "@/features/storage/components/Breadcrumb";
import LectureSessionTree from "@/features/exams/components/LectureSessionTree";
import {
  fetchLectures,
  fetchSessions,
  sortSessionsByDateDesc,
  type Lecture,
  type Session,
} from "@/features/lectures/api/sessions";
import styles from "../components/ResultsExplorer.module.css";

type LectureWithSessions = Lecture & { sessions: Session[] };

export default function ResultsExplorerPage() {
  const navigate = useNavigate();
  const [selectedSessionId, setSelectedSessionId] = useState<number | null>(null);

  const { data: lectures = [], isLoading: lecturesLoading } = useQuery({
    queryKey: ["admin-results-lectures"],
    queryFn: () => fetchLectures({ is_active: undefined }),
  });

  const sessionQueries = useQueries({
    queries: lectures.map((lec) => ({
      queryKey: ["lecture-sessions-results", lec.id],
      queryFn: () => fetchSessions(lec.id),
      enabled: lectures.length > 0,
    })),
  });

  const lecturesWithSessions: LectureWithSessions[] = useMemo(() => {
    return lectures.map((lec, i) => {
      const sessions = (sessionQueries[i]?.data as Session[] | undefined) ?? [];
      return { ...lec, sessions: sortSessionsByDateDesc(sessions) };
    });
  }, [lectures, sessionQueries]);

  const selectedSession = useMemo(() => {
    if (!selectedSessionId) return null;
    for (const lec of lecturesWithSessions) {
      const s = lec.sessions.find((x) => x.id === selectedSessionId);
      if (s) return { lecture: lec, session: s };
    }
    return null;
  }, [lecturesWithSessions, selectedSessionId]);

  const breadcrumbPath = useMemo(() => {
    const path: { id: string | null; name: string }[] = [{ id: null, name: "ì„±ì " }];
    if (selectedSession) {
      path.push({
        id: String(selectedSession.lecture.id),
        name: selectedSession.lecture.title || selectedSession.lecture.name || "ê°•ì˜",
      });
      path.push({ id: String(selectedSession.session.id), name: `${selectedSession.session.order}ì°¨ì‹œ` });
    }
    return path;
  }, [selectedSession]);

  const handleBreadcrumbSelect = (id: string | null) => {
    if (!id) {
      setSelectedSessionId(null);
      return;
    }
    const num = Number(id);
    const asSession = lecturesWithSessions.some((l) => l.sessions.some((s) => s.id === num));
    if (asSession) {
      setSelectedSessionId(num);
    } else {
      const lec = lecturesWithSessions.find((l) => l.id === num);
      const firstSession = lec?.sessions?.[0];
      setSelectedSessionId(firstSession ? firstSession.id : null);
    }
  };

  const sessionsLoading = sessionQueries.some((q) => q.isLoading);
  const isLoading = lecturesLoading || sessionsLoading;

  return (
    <DomainLayout
      title="ì„±ì "
      description="ê°•ì˜Â·ì°¨ì‹œ ë‹¨ìœ„ ì„±ì ì„ í†µí•© ì¡°íšŒí•©ë‹ˆë‹¤. ì°¨ì‹œë³„ ì‹œí—˜Â·ê³¼ì œ ì„±ì ì€ ê° ê°•ì˜ > ì°¨ì‹œì—ì„œ í™•ì¸í•˜ì„¸ìš”."
    >
      <div className={styles.root}>
        <div className={styles.toolbar}>
          <Breadcrumb
            path={breadcrumbPath.length > 1 ? breadcrumbPath : [{ id: null, name: "ì„±ì " }]}
            onSelect={(id) => handleBreadcrumbSelect(id)}
          />
          <div className={styles.actions}>
            <Button intent="primary" size="sm" onClick={() => navigate("/admin/lectures")}>
              ê°•ì˜ ëª©ë¡
            </Button>
          </div>
        </div>

        <div className={styles.body}>
          <aside className={styles.tree}>
            <LectureSessionTree
              lectures={lecturesWithSessions}
              currentSessionId={selectedSessionId}
              onSelectSession={setSelectedSessionId}
            />
          </aside>

          <div className={styles.gridWrap}>
            {isLoading ? (
              <div className={styles.placeholder}>ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div>
            ) : !selectedSessionId ? (
              <div className={styles.placeholder}>ì¢Œì¸¡ì—ì„œ ì°¨ì‹œë¥¼ ì„ íƒí•˜ì„¸ìš”</div>
            ) : !selectedSession ? (
              <div className={styles.placeholder}>ì°¨ì‹œë¥¼ ì„ íƒí•˜ì„¸ìš”</div>
            ) : (
              <div className={styles.grid}>
                <div
                  className={styles.item}
                  onClick={() =>
                    navigate(
                      `/admin/lectures/${selectedSession.lecture.id}/sessions/${selectedSession.session.id}/scores`
                    )
                  }
                  title="ì´ ì°¨ì‹œ ì„±ì  ê´€ë¦¬"
                >
                  <BarChart2 size={32} style={{ color: "var(--color-primary)" }} aria-hidden />
                  <span className={styles.itemLabel}>ì„±ì  ë³´ê¸°</span>
                  <span className={styles.itemMeta}>
                    {selectedSession.lecture.title || selectedSession.lecture.name} Â· {selectedSession.session.order}ì°¨ì‹œ
                  </span>
                </div>
              </div>
            )}
          </div>
        </div>
      </div>
    </DomainLayout>
  );
}


==========================================================================================
# FILE: panels/AdminExamAnalyticsPanel.tsx
==========================================================================================
// src/features/results/panels/AdminExamAnalyticsPanel.tsx

import { useQuery } from "@tanstack/react-query";
import api from "@/shared/api/axios";
import type { SessionScoreSummary, QuestionStat, TopWrongQuestion } from "../types/results.types";

type Props = {
  sessionId: number;
  examId: number;
};

type QuestionStatsResponse = {
  count: number;
  next: number | null;
  previous: number | null;
  results: QuestionStat[];
};

async function fetchSessionScoreSummary(sessionId: number): Promise<SessionScoreSummary> {
  const res = await api.get(`/results/admin/sessions/${sessionId}/score-summary/`);
  return res.data as SessionScoreSummary;
}

async function fetchQuestionStats(examId: number): Promise<QuestionStat[]> {
  const res = await api.get(`/results/admin/exams/${examId}/questions/`);
  const data = res.data;
  if (Array.isArray(data)) return data;
  if (Array.isArray(data?.results)) return data.results;
  return [];
}

async function fetchTopWrong(examId: number, n = 5): Promise<TopWrongQuestion[]> {
  const res = await api.get(`/results/admin/exams/${examId}/questions/top-wrong/?n=${n}`);
  return Array.isArray(res.data) ? (res.data as TopWrongQuestion[]) : [];
}

export default function AdminExamAnalyticsPanel({ sessionId, examId }: Props) {
  const sessionQ = useQuery({
    queryKey: ["session-score-summary-results", sessionId],
    queryFn: () => fetchSessionScoreSummary(sessionId),
    enabled: Number.isFinite(sessionId),
  });

  const qsQ = useQuery({
    queryKey: ["exam-question-stats", examId], // âœ… exams/ExamSetupPanel invalidateë‘ í‚¤ ë§ì¶¤
    queryFn: () => fetchQuestionStats(examId),
    enabled: Number.isFinite(examId),
  });

  const topWrongQ = useQuery({
    queryKey: ["exam-top-wrong", examId],
    queryFn: () => fetchTopWrong(examId, 5),
    enabled: Number.isFinite(examId),
  });

  if (sessionQ.isLoading || qsQ.isLoading) return <div>ë¡œë”©ì¤‘...</div>;
  if (sessionQ.isError || qsQ.isError) return <div className="text-red-600">í†µê³„ ì¡°íšŒ ì‹¤íŒ¨</div>;

  const attemptStats = sessionQ.data?.attempt_stats;

  return (
    <div className="space-y-4 text-sm">
      {sessionQ.data && (
        <div className="rounded border p-3">
          <div>ì„¸ì…˜ í‰ê· : {sessionQ.data.avg_score ?? "-"}</div>
          <div>
            ì¬ì‹œí—˜ ë¹„ìœ¨:{" "}
            {typeof attemptStats?.retake_ratio === "number"
              ? `${(attemptStats.retake_ratio * 100).toFixed(1)}%`
              : "-"}
          </div>
        </div>
      )}

      <div>
        <div className="mb-1 font-semibold">ë¬¸í•­ë³„ í†µê³„</div>
        <ul>
          {(qsQ.data ?? []).map((q) => (
            <li key={q.question_id}>
              Q{q.question_id} â€” ì •ë‹µë¥  {(q.accuracy * 100).toFixed(1)}%
            </li>
          ))}
        </ul>
      </div>

      <div>
        <div className="mb-1 font-semibold">Top Wrong</div>
        <ul>
          {(topWrongQ.data ?? []).map((t) => (
            <li key={t.question_id}>
              Q{t.question_id}: {t.wrong_count}
            </li>
          ))}
        </ul>
      </div>
    </div>
  );
}


==========================================================================================
# FILE: panels/AdminExamDetail.tsx
==========================================================================================
/**
 * PATH: src/features/exams/panels/AdminExam
 *
 * âœ… STEP 1 ë³´ì¡° UX
 *
 * ì„¤ê³„ ê³„ì•½:
 * - Session â†’ Exam ì§„ì… ì‹œ Results íƒ­ ìë™ í™œì„±í™”
 * - exams ë„ë©”ì¸ì€ results ë‚´ë¶€ ë¡œì§ì„ ì¹¨ë²”í•˜ì§€ ì•ŠëŠ”ë‹¤
 */

import { useEffect } from "react";
import { useSearchParams } from "react-router-dom";

export default function AdminExamDetail() {
  const [searchParams] = useSearchParams();

  /**
   * Session ê²½ë¡œì—ì„œ ì§„ì…í•œ ê²½ìš°
   * Results íƒ­ ìë™ ì„ íƒ
   */
  useEffect(() => {
    if (searchParams.get("from") === "session") {
      setActiveTab("results"); // ê¸°ì¡´ íƒ­ ìƒíƒœ setter ìœ ì§€
    }
  }, [searchParams]);

  // ... ê¸°ì¡´ ì½”ë“œ ì „ì²´ ìœ ì§€
}


==========================================================================================
# FILE: panels/AdminExamWrongNotePanel.tsx
==========================================================================================
import { ApiClient } from "../api/client";
import WrongNotePanel from "../components/WrongNotePanel";

export default function AdminExamWrongNotePanel({
  api,
  enrollmentId,
  examId,
}: {
  api: ApiClient;
  enrollmentId: number;
  examId: number;
}) {
  return (
    <WrongNotePanel
      enrollmentId={enrollmentId}
      examId={examId}
    />
  );
}


==========================================================================================
# FILE: panels/ExamResultsPanel.tsx
==========================================================================================
/**
 * PATH: src/features/results/panels/ExamResultsPanel.tsx
 *
 * âœ… STEP 1 â€” Results ìë™ ì§„ì… & ìë™ ì„ íƒ ì²˜ë¦¬
 *
 * ì„¤ê³„ ê³„ì•½:
 * - Session â†’ Exam ì§„ì… ì‹œ ìë™ ì„ íƒì€ Results ë„ë©”ì¸ ì±…ì„
 * - query param ê¸°ë°˜ "ìµœì´ˆ 1íšŒ" ìë™ ì„ íƒ
 * - ì´í›„ ìƒíƒœ ë³€ê²½ì€ ì‚¬ìš©ì í´ë¦­ë§Œ ë°˜ì˜
 *
 * âŒ ê¸ˆì§€:
 * - session API ì§ì ‘ í˜¸ì¶œ
 * - enrollment ê³„ì‚°
 * - ì „ì—­ ìƒíƒœ / store ì‚¬ìš©
 */

import { useState } from "react";
import { useQuery } from "@tanstack/react-query";
import { useSearchParams } from "react-router-dom";

import AdminExamResultsTable from "../components/AdminExamResultsTable";
import StudentResultPanel from "./StudentResultPanel";

import api from "@/shared/api/axios";
import type { AdminExamResultRow } from "../types/results.types";

type Props = {
  examId: number;
};

/**
 * ê¸°ì¡´ API í˜¸ì¶œ ë¡œì§ ìœ ì§€
 */
async function fetchAdminExamResults(examId: number) {
  const res = await api.get(
    `/results/admin/exams/${examId}/results/`
  );

  return Array.isArray(res.data?.results)
    ? res.data.results
    : Array.isArray(res.data)
    ? res.data
    : [];
}

export default function ExamResultsPanel({ examId }: Props) {
  const [searchParams] = useSearchParams();

  /**
   * ğŸ”¥ STEP 1 í•µì‹¬
   * - Sessionì—ì„œ ë„˜ì–´ì˜¨ enrollmentIdë¥¼ ìµœì´ˆ ì„ íƒê°’ìœ¼ë¡œ ì‚¬ìš©
   * - useState ì´ˆê¸°ê°’ìœ¼ë¡œë§Œ ì‚¬ìš© (ì´í›„ ìë™ ë³€ê²½ âŒ)
   */
  const initialEnrollmentId = Number(
    searchParams.get("enrollmentId")
  );

  const [selectedEnrollmentId, setSelectedEnrollmentId] =
    useState<number | null>(
      Number.isFinite(initialEnrollmentId)
        ? initialEnrollmentId
        : null
    );

  const { data, isLoading, isError } = useQuery({
    queryKey: ["admin-exam-results", examId],
    queryFn: () => fetchAdminExamResults(examId),
    enabled: Number.isFinite(examId),
  });

  if (isLoading) {
    return (
      <div className="text-sm text-gray-500">
        ì„±ì  ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
      </div>
    );
  }

  if (isError) {
    return (
      <div className="text-sm text-red-600">
        ì„±ì  ì¡°íšŒ ì‹¤íŒ¨
      </div>
    );
  }

  const rows: AdminExamResultRow[] = data ?? [];

  if (rows.length === 0) {
    return (
      <div className="text-sm text-gray-500">
        ì œì¶œëœ ì„±ì ì´ ì—†ìŠµë‹ˆë‹¤.
      </div>
    );
  }

  return (
    <div className="flex h-[calc(100vh-260px)] gap-4">
      {/* ================= LEFT: í•™ìƒ ë¦¬ìŠ¤íŠ¸ ================= */}
      <div className="w-[420px] shrink-0 overflow-auto border-r">
        <AdminExamResultsTable
          rows={rows}
          onSelectEnrollment={setSelectedEnrollmentId}
        />
      </div>

      {/* ================= RIGHT: í•™ìƒ ìƒì„¸ ================= */}
      <div className="flex-1 overflow-auto">
        {selectedEnrollmentId ? (
          <StudentResultPanel
            examId={examId}
            enrollmentId={selectedEnrollmentId}
          />
        ) : (
          <div className="flex h-full items-center justify-center text-sm text-gray-400">
            ì¢Œì¸¡ì—ì„œ í•™ìƒì„ ì„ íƒí•˜ì„¸ìš”
          </div>
        )}
      </div>
    </div>
  );
}


==========================================================================================
# FILE: panels/SessionExamSummaryPanel.tsx
==========================================================================================
// PATH: src/features/results/panels/SessionExamSummaryPanel.tsx

import { useQuery } from "@tanstack/react-query";
import api from "@/shared/api/axios";

type Props = {
  sessionId: number;
  activeExamId?: number;
};

type SessionExamSummaryRow = {
  exam_id: number;
  title: string;

  participant_count: number;
  avg_score: number;
  min_score: number;
  max_score: number;

  pass_count: number;
  fail_count: number;
  pass_rate: number;

  clinic_count: number;
};

type SessionExamsSummaryResponse = {
  session_id: number;
  exams: SessionExamSummaryRow[];
};

async function fetchSessionExamsSummary(
  sessionId: number
): Promise<SessionExamsSummaryResponse> {
  const res = await api.get(
    `/results/admin/sessions/${sessionId}/exams/summary/`
  );
  return res.data;
}

export default function SessionExamSummaryPanel({
  sessionId,
  activeExamId,
}: Props) {
  const { data, isLoading, isError } = useQuery({
    queryKey: ["session-exams-summary", sessionId],
    queryFn: () => fetchSessionExamsSummary(sessionId),
    enabled: Number.isFinite(sessionId),
  });

  if (isLoading) {
    return (
      <div className="text-sm text-gray-500">
        ì„±ì  ìš”ì•½ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
      </div>
    );
  }

  if (isError || !data) {
    return (
      <div className="text-sm text-red-600">
        ì„±ì  ìš”ì•½ ì‹¤íŒ¨
      </div>
    );
  }

  if (!data.exams || data.exams.length === 0) {
    return (
      <div className="text-sm text-gray-500">
        ì„±ì  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.
      </div>
    );
  }

  return (
    <div className="space-y-4">
      <h3 className="text-sm font-semibold">
        ì‹œí—˜ë³„ ì„±ì  ìš”ì•½
      </h3>

      <table className="w-full border text-sm">
        <thead className="bg-gray-50">
          <tr>
            <th className="border px-2 py-1 text-left">ì‹œí—˜</th>
            <th className="border px-2 py-1">ì‘ì‹œ</th>
            <th className="border px-2 py-1">í‰ê· </th>
            <th className="border px-2 py-1">ìµœì €</th>
            <th className="border px-2 py-1">ìµœê³ </th>
            <th className="border px-2 py-1">í•©ê²©ë¥ </th>
            <th className="border px-2 py-1">í´ë¦¬ë‹‰</th>
          </tr>
        </thead>

        <tbody>
          {data.exams.map((row) => {
            const isActive = row.exam_id === activeExamId;

            return (
              <tr
                key={row.exam_id}
                className={isActive ? "bg-blue-50" : ""}
              >
                <td className="border px-2 py-1 font-medium">
                  {row.title}
                </td>

                <td className="border px-2 py-1 text-center">
                  {row.participant_count}
                </td>

                <td className="border px-2 py-1 text-center">
                  {row.avg_score.toFixed(1)}
                </td>

                <td className="border px-2 py-1 text-center">
                  {row.min_score}
                </td>

                <td className="border px-2 py-1 text-center">
                  {row.max_score}
                </td>

                <td className="border px-2 py-1 text-center">
                  {(row.pass_rate * 100).toFixed(1)}%
                </td>

                <td className="border px-2 py-1 text-center">
                  {row.clinic_count}
                </td>
              </tr>
            );
          })}
        </tbody>
      </table>
    </div>
  );
}


==========================================================================================
# FILE: panels/StudentResultPanel.tsx
==========================================================================================
/**
 * PATH: src/features/results/panels/StudentResultPanel.tsx
 *
 * âœ… FINAL (A2 + C-1 UX)
 *
 * - ìƒíƒœ íŒŒìƒ: deriveFrontResultStatusFromDetail ë‹¨ì¼ ê¸°ì¤€
 * - edit/read ëª¨ë“œ ì „ì—­ ì‹œê° ë¶„ë¦¬
 * - lock_reason í•­ìƒ ë…¸ì¶œ
 * - EditReasonInput ì—°ê²° (UI only)
 *
 * âŒ ì ìˆ˜ ê³„ì‚° âŒ
 * âŒ optimistic update âŒ
 * âŒ ìƒíƒœ íŒë‹¨ ì¸ë¼ì¸ âŒ
 */

import { useState } from "react";
import { useQuery } from "@tanstack/react-query";

import { fetchAdminExamResultDetail } from "../api/adminExamResultDetail";
import { patchExamItemScore } from "../api/adminExamItemScore";

import AttemptSelectorPanel from "../components/AttemptSelectorPanel";
import AttemptViewerPanel from "../components/attempt/AttemptViewerPanel";
import FrontResultStatusBadge from "../components/FrontResultStatusBadge";

// âœ… FIX: results ë„ë©”ì¸ ë‚´ë¶€ ì»´í¬ë„ŒíŠ¸
import EditReasonInput from "@/features/results/components/EditReasonInput";

import { deriveFrontResultStatusFromDetail } from "../utils/deriveFrontResultStatusFromDetail";

type Props = {
  examId: number;
  enrollmentId: number;
};

export default function StudentResultPanel({ examId, enrollmentId }: Props) {
  const { data, isLoading, error, refetch } = useQuery({
    queryKey: ["admin-exam-detail", examId, enrollmentId],
    queryFn: () => fetchAdminExamResultDetail(examId, enrollmentId),
    enabled: Number.isFinite(examId) && Number.isFinite(enrollmentId),
  });

  const [mode, setMode] = useState<"read" | "edit">("read");
  const [tab, setTab] = useState<"items" | "omr">("items");
  const [editReason, setEditReason] = useState("");

  if (isLoading) {
    return <div className="p-4 text-sm text-gray-500">ìƒì„¸ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>;
  }

  if (error || !data) {
    return <div className="p-4 text-sm text-red-600">ìƒì„¸ ì¡°íšŒ ì‹¤íŒ¨</div>;
  }

  const editState = data.edit_state;
  const canEdit = editState.can_edit && !editState.is_locked;

  const headerStatus = deriveFrontResultStatusFromDetail(data);

  return (
    <div className={`flex h-full flex-col ${mode === "edit" ? "bg-blue-50/20" : ""}`}>
      {/* ================= Header ================= */}
      <div className="border-b px-4 py-3">
        <div className="flex items-start justify-between">
          <div className="space-y-1">
            <div className="text-sm font-semibold">
              enrollment #{data.enrollment_id}
            </div>

            <div className="text-xs text-gray-500">
              ì´ì  {data.total_score}/{data.max_score}
            </div>

            {editState.is_locked && (
              <div className="text-xs text-red-600">
                ğŸ”’ {editState.lock_reason ?? "í¸ì§‘ ì ê¹€"}
              </div>
            )}
          </div>

          <div className="flex items-center gap-3">
            <FrontResultStatusBadge status={headerStatus} />

            {mode === "read" ? (
              <button
                className="rounded border px-3 py-1 text-xs disabled:opacity-40"
                disabled={!canEdit}
                title={
                  !canEdit
                    ? editState.is_locked
                      ? editState.lock_reason ?? "í¸ì§‘ ì ê¹€"
                      : "í¸ì§‘ ê¶Œí•œ ì—†ìŒ"
                    : "í¸ì§‘ ëª¨ë“œë¡œ ì „í™˜"
                }
                onClick={() => setMode("edit")}
              >
                í¸ì§‘
              </button>
            ) : (
              <button
                className="rounded border border-blue-600 bg-blue-50 px-3 py-1 text-xs font-semibold"
                onClick={() => setMode("read")}
              >
                í¸ì§‘ ì¢…ë£Œ
              </button>
            )}
          </div>
        </div>

        {mode === "edit" && (
          <div className="mt-2 text-xs text-blue-600">
            âœï¸ í¸ì§‘ ëª¨ë“œ Â· ë³€ê²½ ì‚¬í•­ì€ ì¦‰ì‹œ ì €ì¥ë©ë‹ˆë‹¤
          </div>
        )}
      </div>

      {/* ================= Edit Reason ================= */}
      {mode === "edit" && (
        <EditReasonInput value={editReason} onChange={setEditReason} />
      )}

      {/* ================= Attempt Selector ================= */}
      {mode === "edit" && (
        <AttemptSelectorPanel
          examId={examId}
          enrollmentId={enrollmentId}
          onChanged={refetch}
        />
      )}

      {/* ================= Tabs ================= */}
      <div className="flex gap-4 border-b px-4 text-sm">
        {[
          ["items", "ê²°ê³¼"],
          ["omr", "OMR"],
        ].map(([k, label]) => (
          <button
            key={k}
            onClick={() => setTab(k as any)}
            className={`py-2 ${
              tab === k
                ? "border-b-2 border-blue-600 font-semibold"
                : "text-gray-500"
            }`}
          >
            {label}
          </button>
        ))}
      </div>

      {/* ================= Body ================= */}
      <div className="flex-1 overflow-auto p-4">
        {tab === "items" && (
          <ul className="space-y-1 text-sm">
            {data.items.map((it) => {
              const isEditableItem = it.is_editable === true;

              return (
                <li
                  key={it.question_id}
                  className={`flex items-center justify-between rounded border p-2 ${
                    mode === "edit" && isEditableItem ? "bg-blue-50/40" : ""
                  }`}
                >
                  <div>
                    Q{it.question_id} {it.is_correct ? "âœ…" : "âŒ"}
                  </div>

                  {mode === "edit" && isEditableItem ? (
                    <input
                      type="number"
                      min={0}
                      max={it.max_score}
                      defaultValue={it.score}
                      className="w-16 rounded border px-1 py-0.5 text-xs"
                      onBlur={async (e) => {
                        const next = Number(e.target.value);

                        if (!Number.isFinite(next)) {
                          e.target.value = String(it.score);
                          return;
                        }

                        try {
                          await patchExamItemScore({
                            examId,
                            enrollmentId,
                            questionId: it.question_id,
                            score: next,
                          });
                          refetch();
                        } catch {
                          e.target.value = String(it.score);
                        }
                      }}
                    />
                  ) : (
                    <div className="text-xs text-gray-500">
                      {it.score}/{it.max_score}
                    </div>
                  )}
                </li>
              );
            })}
          </ul>
        )}

        {tab === "omr" && data.attempt_id && (
          <AttemptViewerPanel
            attemptId={data.attempt_id}
            facts={data.items}
            autoSelectFirst
          />
        )}
      </div>
    </div>
  );
}


==========================================================================================
# FILE: types/editState.ts
==========================================================================================
/**
 * PATH: src/features/results/types/editState.ts
 *
 * âœ… EditState (Phase 4 - A1)
 *
 * ì„¤ê³„ ì›ì¹™:
 * - backend ì‘ë‹µê³¼ 1:1 ê³„ì•½
 * - optional âŒ
 * - ëˆ„ë½ = ì‹œìŠ¤í…œ ì˜¤ë¥˜
 */

export type EditState = {
  can_edit: boolean;
  is_locked: boolean;
  lock_reason: string | null;

  last_updated_by: {
    id: number;
    name: string;
  } | null;

  updated_at: string | null;
};


==========================================================================================
# FILE: types/frontResultStatus.ts
==========================================================================================
/**
 * PATH: src/features/results/types/frontResultStatus.ts
 *
 * âœ… FrontResultStatus (Frontend ì „ìš© í†µí•© ìƒíƒœ)
 *
 * ëª©ì :
 * - submission / result ì •ë³´ë¥¼ í•˜ë‚˜ì˜ UX ìƒíƒœë¡œ í†µí•©
 *
 * âŒ ê¸ˆì§€:
 * - ì ìˆ˜ ê³„ì‚°
 * - í•©ë¶ˆ íŒë‹¨
 *
 * âœ… ì›ì¹™:
 * - backendê°€ ë‚´ë ¤ì¤€ ê°’ë§Œ "ì¡°í•©"í•œë‹¤
 * - results ë„ë©”ì¸ ë‚´ë¶€ì—ì„œë§Œ ì‚¬ìš©
 */

export type FrontResultStatus =
  | "waiting"        // ì œì¶œ ì—†ìŒ
  | "processing"    // ì±„ì  ì¤‘
  | "partial_done"  // ì£¼ê´€ì‹ ë¯¸ì±„ì  ë“±
  | "done"          // ì™„ë£Œ
  | "failed";       // ì‹¤íŒ¨


==========================================================================================
# FILE: types/results.types.ts
==========================================================================================
/**
 * PATH: src/features/results/types/results.types.ts
 *
 * âœ… Results Domain Types (Backend Contract Aligned)
 *
 * ì„¤ê³„ ê³„ì•½(ì¤‘ìš”):
 * - ë‹¨ì¼ ì§„ì‹¤: í•™ìƒ ì‹ë³„ì€ enrollment_id
 * - Admin Exam Results List ì‘ë‹µì€ "ëŒ€í‘œ Attempt ê¸°ì¤€ final_score"ê°€ ë‹¨ì¼ ì§„ì‹¤
 *
 * ë°±ì—”ë“œ ìŠ¤í™(ê³ ì •):
 * - GET /results/admin/exams/{exam_id}/results/
 *   [
 *     {
 *       enrollment_id,
 *       student_name,
 *       final_score,
 *       passed,
 *       clinic_required,
 *       submission_status
 *     }
 *   ]
 *
 * âš ï¸ ë ˆê±°ì‹œ í˜¸í™˜:
 * - ê¸°ì¡´ í”„ë¡ íŠ¸/ë°±ì—”ë“œ ì¼ë¶€ í™˜ê²½ì—ì„œ pagination({results:[]}) ë˜ëŠ”
 *   submission_id/submitted_at ë“±ì´ ì¶”ê°€ë¡œ ì˜¬ ìˆ˜ ìˆì–´ optionalë¡œ í—ˆìš©.
 */

// ---------- 1) Student exam result ----------
export type ResultItem = {
  question_id: number;
  answer: string;
  is_correct: boolean;
  score: number;
  max_score: number;
  source: string;
};

export type StudentExamResult = {
  target_type: "exam" | "homework";
  target_id: number;
  enrollment_id: number;

  attempt_id?: number | null;

  total_score: number;
  max_score: number;
  submitted_at: string | null;

  items: ResultItem[];

  allow_retake?: boolean;
  max_attempts?: number;
  can_retake?: boolean;

  clinic_required?: boolean;
};

// ---------- 2) Admin exam results list ----------
export type AdminExamResultRow = {
  // âœ… ë‹¨ì¼ ì§„ì‹¤ í‚¤
  enrollment_id: number;
  student_name: string;

  /**
   * âœ… ëŒ€í‘œ Attempt ê¸°ì¤€ ìµœì¢… ì ìˆ˜
   * - ëŒ€í‘œ attemptê°€ ì—†ìœ¼ë©´ null/undefinedì¼ ìˆ˜ ìˆìŒ(ìš´ì˜ ìœ„í—˜ ì¼€ì´ìŠ¤)
   */
  final_score?: number | null;

  /**
   * âœ… backend ê³„ì‚° ê²°ê³¼
   */
  passed?: boolean | null;
  clinic_required?: boolean;

  /**
   * âœ… ì œì¶œ/ì±„ì  íŒŒì´í”„ë¼ì¸ ìƒíƒœ
   * ì˜ˆ: PENDING, GRADING, DONE, FAILED ë“±
   */
  submission_status?: string | null;

  /**
   * ==========================
   * ë ˆê±°ì‹œ/í™•ì¥ í•„ë“œ (optional)
   * ==========================
   * - ì¼ë¶€ ë°±ì—”ë“œ êµ¬í˜„ì—ì„œ ë‚´ë ¤ì˜¬ ìˆ˜ ìˆìŒ
   */
  submitted_at?: string | null;
  submission_id?: number | null;

  // âŒ ë” ì´ìƒ exam_score/exam_max_scoreëŠ” list contractì— ì—†ìŒ
  // - ìƒì„¸(detail)ì—ì„œë§Œ total_score/max_score í™•ì¸
};

// ---------- 3) Exam summary ----------
export type AdminExamSummary = {
  participant_count: number;
  avg_score: number;
  min_score: number;
  max_score: number;

  pass_count: number;
  fail_count: number;
  pass_rate: number;

  clinic_count: number;
};

// ---------- 4) Session score summary ----------
export type SessionScoreSummary = {
  participant_count: number;
  avg_score: number;
  min_score: number;
  max_score: number;
  pass_rate: number;
  clinic_rate: number;
  attempt_stats: {
    avg_attempts: number;
    retake_ratio: number;
  };
};

// ---------- 5) Question stats ----------
export type QuestionStat = {
  question_id: number;
  attempts: number;
  correct: number;
  accuracy: number;
  avg_score: number;
  max_score: number;
};

export type TopWrongQuestion = {
  question_id: number;
  wrong_count: number;
};

// ---------- 6) Wrong notes ----------
export type WrongNoteItem = {
  exam_id: number;
  attempt_id: number;
  attempt_created_at: string | null;

  question_id: number;
  question_number: number | null;
  answer_type: string;

  student_answer: string;
  correct_answer: string;

  is_correct: boolean;
  score: number;
  max_score: number;

  meta?: unknown;
  extra?: unknown;
};

export type WrongNoteListResponse = {
  count: number;
  next: number | null;
  prev: number | null;
  results: WrongNoteItem[];
};

// ---------- 7) PDF job ----------
export type WrongNotePdfCreateResponse = {
  job_id: number;
  status: string;
  status_url?: string;
};

export type WrongNotePdfStatusResponse = {
  job_id: number;
  status: "PENDING" | "RUNNING" | "DONE" | "FAILED" | string;
  file_path: string;
  file_url: string | null;
  error_message: string;
  created_at: string;
  updated_at: string;
};


==========================================================================================
# FILE: utils/deriveFrontResultStatus.ts
==========================================================================================
/**
 * PATH: src/features/results/utils/deriveFrontResultStatus.ts
 *
 * âœ… FrontResultStatus (Row ê¸°ì¤€ íŒŒìƒ) - LOCKED (Backend Contract Aligned)
 *
 * ëª©ì :
 * - Admin ê²°ê³¼ ë¦¬ìŠ¤íŠ¸ Rowì—ì„œ ìš´ì˜ìê°€ ì´í•´ ê°€ëŠ¥í•œ ë‹¨ì¼ ìƒíƒœ ì œê³µ
 *
 * ğŸ”’ ì ˆëŒ€ ê·œì¹™:
 * - í”„ë¡ íŠ¸ ê³„ì‚° âŒ
 * - í”„ë¡ íŠ¸ ì¶”ì¸¡ âŒ
 * - ì ìˆ˜/ë¬¸í•­/attempt ì§ì ‘ í•´ì„ âŒ
 *
 * ì‚¬ìš© ì‹ í˜¸(backend ê³„ì•½):
 * - submission_status (í•„ìˆ˜ë¡œ ì‹ ë¢°)
 * - clinic_required (í›„ì²˜ë¦¬/ë¯¸ì±„ì /ê²€ìˆ˜ í•„ìš” ì‹ í˜¸)
 *
 * ë ˆê±°ì‹œ í˜¸í™˜:
 * - submission_idê°€ ì˜¤ëŠ” í™˜ê²½ë„ ìˆìœ¼ë‚˜, ì—†ë‹¤ê³  í•´ì„œ waiting ì²˜ë¦¬í•˜ë©´ ì•ˆ ë¨.
 */

import type { FrontResultStatus } from "../types/frontResultStatus";
import type { AdminExamResultRow } from "../types/results.types";

export function deriveFrontResultStatus(row: AdminExamResultRow): FrontResultStatus {
  const raw = String(row.submission_status ?? "").toLowerCase().trim();

  /**
   * 1) ì œì¶œ/ìƒíƒœ ì •ë³´ ìì²´ê°€ ì—†ë‹¤
   * - ì´ ê²½ìš°ë§Œ waiting (ì§„ì§œ ë¯¸ì œì¶œ/ë¯¸ìƒì„± ì¼€ì´ìŠ¤)
   */
  if (!raw) {
    // ë ˆê±°ì‹œ: submission_idê°€ ìˆìœ¼ë©´ ì œì¶œë¡œ ê°„ì£¼
    if (row.submission_id) return "processing";
    return "waiting";
  }

  /**
   * 2) ëª…í™•í•œ ì‹¤íŒ¨
   */
  if (["failed", "error"].includes(raw)) {
    return "failed";
  }

  /**
   * 3) íŒŒì´í”„ë¼ì¸ ì§„í–‰ ì¤‘
   */
  if (
    [
      "pending",
      "submitted",
      "dispatched",
      "extracting",
      "answers_ready",
      "grading",
      "running",
      "processing",
    ].includes(raw)
  ) {
    return "processing";
  }

  /**
   * 4) ê²°ê³¼ëŠ” ìˆìœ¼ë‚˜ í›„ì²˜ë¦¬/ê²€ìˆ˜ í•„ìš”
   */
  if (row.clinic_required) {
    return "partial_done";
  }

  /**
   * 5) ìµœì¢… í™•ì •
   */
  if (["done", "completed", "success"].includes(raw)) {
    return "done";
  }

  /**
   * 6) ì•Œ ìˆ˜ ì—†ëŠ” ìƒíƒœ ê°’ ë°©ì–´
   * - ìš´ì˜ UXìƒ "processing"ìœ¼ë¡œ ë‘ëŠ” ê²Œ ì•ˆì „ (ë¯¸ì œì¶œë¡œ ì˜¤íŒ ê¸ˆì§€)
   */
  return "processing";
}


==========================================================================================
# FILE: utils/deriveFrontResultStatusFromDetail.ts
==========================================================================================
/**
 * PATH: src/features/results/utils/deriveFrontResultStatusFromDetail.ts
 *
 * âœ… FrontResultStatus (Detail ê¸°ì¤€ íŒŒìƒ) - FINAL (ì˜¤íŒ ë°©ì§€)
 *
 * ëª©ì :
 * - StudentResultPanel(ìƒì„¸)ì—ì„œ ë‹¨ì¼ ìƒíƒœ ë°°ì§€ í‘œì‹œ
 *
 * ğŸ”’ ì ˆëŒ€ ê·œì¹™:
 * - ì£¼ê´€ì‹ ì—¬ë¶€(is_editable)ë¡œ "ë¯¸ì±„ì "ì„ ì¶”ì¸¡í•˜ì§€ ì•ŠëŠ”ë‹¤.
 *   (ë§Œì ì´ ì•„ë‹ˆë©´ ë¯¸ì±„ì ì´ë¼ê³  ì˜¤íŒí•˜ëŠ” ìš´ì˜ ì‚¬ê³  ë°©ì§€)
 *
 * ë°±ì—”ë“œê°€ detailì—ì„œ í™•ì •ì ìœ¼ë¡œ ì œê³µí•˜ëŠ” ì‹ í˜¸ë§Œ ì‚¬ìš©:
 * - submitted_at
 * - attempt_id (ëŒ€í‘œ attempt ì¡´ì¬ ì—¬ë¶€)
 *
 * ì°¸ê³ :
 * - "ë¯¸ì±„ì /í›„ì²˜ë¦¬"ëŠ” list(row)ì˜ clinic_required/submission_statusë¡œ í‘œí˜„í•˜ëŠ” ê²ƒì´ ì•ˆì „.
 */

import type { FrontResultStatus } from "../types/frontResultStatus";
import type { ExamResultDetail } from "../api/adminExamResultDetail";

export function deriveFrontResultStatusFromDetail(detail: ExamResultDetail): FrontResultStatus {
  // 1) ì œì¶œ ì—†ìŒ
  if (!detail.submitted_at) {
    return "waiting";
  }

  // 2) ëŒ€í‘œ attempt ì—†ìŒ â†’ ë¹„ì •ìƒ(ìš´ì˜ ì¦‰ì‹œ í™•ì¸ í•„ìš”)
  if (!detail.attempt_id) {
    return "failed";
  }

  // 3) ì œì¶œ ìˆê³  ëŒ€í‘œ attempt ìˆìœ¼ë©´ ì¼ë‹¨ "ì™„ë£Œ"
  // - ë¯¸ì±„ì  ì—¬ë¶€ëŠ” ì—¬ê¸°ì„œ ì¶”ì¸¡ ê¸ˆì§€
  return "done";
}
